function DetectBrowser(){var BO={};BO.ie=navigator.appName==="Microsoft Internet Explorer";BO.ie6=BO.ie&&document.implementation&&document.implementation.hasFeature;BO.ie10=BO.ie&&document.all&&window.atob;BO.chrome=navigator.userAgent.toLowerCase().indexOf("chrome")>-1;BO.safari=document.childNodes&&!document.all&&!navigator.taintEnabled&&!navigator.accentColorName&&!BO.chrome;BO.firefox=navigator.userAgent.indexOf("Firefox")>-1;BO.iphone=navigator.userAgent.toLowerCase().indexOf("iphone")>-1;BO.ipad=navigator.userAgent.toLowerCase().indexOf("ipad")>-1;BO.android=navigator.userAgent.toLowerCase().indexOf("android")>-1;BO.mobile=BO.iphone||BO.android||BO.iPad||window.tizen;return BO}var BrowserType=new DetectBrowser;if(!document.getElementsByClassName){document.getElementsByClassName=function(className){var elements=document.getElementsByTagName("*");var matchedElements=[];for(var i=0;i<elements.length;++i){var element=elements[i];if(element.className===className){matchedElements.push(element)}}return matchedElements}}function CC(){}CC.TextArea=document.getElementById("log");CC.DEBUGLOG=function(message,object){{}};function GetStackTrace(){var i;var callstack=[];var lines;var isCallstackPopulated=false;try{i.dont.exist+=0}catch(e){if(e.stack){lines=e.stack.split("\n");for(i=0,len=lines.length;i<len;i++){callstack.push(lines[i])}callstack.shift();isCallstackPopulated=true}else if(window.opera&&e.message){lines=e.message.split("\n");for(i=0,len=lines.length;i<len;i++){if(lines[i].match(/^\s*[A-Za-z0-9\-_\$]+\(/)){var entry=lines[i];if(lines[i+1]){entry+=" at "+lines[i+1];i++}callstack.push(entry)}}callstack.shift();isCallstackPopulated=true}}if(!isCallstackPopulated){var currentFunction=arguments.callee.caller;while(currentFunction){var fn=currentFunction.toString();var fname=fn.substring(fn.indexOf("function")+8,fn.indexOf(""))||"anonymous";callstack.push(fname);currentFunction=currentFunction.caller}}return callstack.join("\n\n")}CC.ASSERT=function(test,message){if(!test){var debug="TEST FAILED\n";debug+=GetStackTrace();alert(debug);if(message){alert(message)}}};CC.LoadScript=function(url,callback){var head=document.getElementsByTagName("head")[0];var script=document.createElement("script");script.type="text/javascript";script.src=url;script.onload=function(){callback(true,script)};script.onerror=function(){callback(false,script)};head.appendChild(script)};CC.SocketIOSocketOnOnly=function(name,fn){var listeners=this.listeners(name);if(listeners.length>0){this.removeAllListeners(name);if(window.console&&console.log){console.log("socket.on re-registering",this.sessionID)}}this.on(name,fn);return this};CC.DeepCopy=function(object){if(typeof object==="object"){var cache=[];var objectJSONString=JSON.stringify(object,function(key,value){if(typeof value==="object"&&value!==null){if(cache.indexOf(value)!==-1){return}cache.push(value)}return value});var newObject=JSON.parse(objectJSONString);return newObject}return null};CC.DeepEquals=function(o1,o2){if(o1===o2&&o2===undefined){return true}if(o1===o2&&o2===null){return true}if(o1&&!o2||!o1&&o2){return false}var k1=Object.keys(o1);var k2=Object.keys(o2);if(k1.length!==k2.length){return false}for(var i=0;i<k1.length;++i){if(k1[i]!==k2[i]){return false}var key=k1[i];var keyType=typeof o1[key];if(typeof o1[key]!==typeof o2[key]){return false}if(keyType==="object"){if(!CC.DeepEquals(o1[key],o2[key])){return false}}else if(o1[key]!==o2[key]){return false}}return true};CC.LoadData=function(key){if(window.localStorage){var data=window.localStorage.getItem(key);if(data){return data}}return undefined};CC.SaveData=function(key,data){if(window.localStorage){CC.ASSERT(key);window.localStorage.setItem(key,data)}};CC.DeleteData=function(key){if(window.localStorage){window.localStorage.removeItem(key)}};function ExtendPrototype(descendant,parent,noPrefixCopy){descendant.super=parent;if(!parent.name){parent.name=parent.toString().match(/^function\s*([^\s(]+)/)[1]}for(var m in parent.prototype){if(!noPrefixCopy){if(m.split("_").length===1){var combined=parent.name+"_"+m;descendant.prototype[combined]=parent.prototype[m]}}descendant.prototype[m]=parent.prototype[m]}}CC.HasFlag=function(source,flag){var result=source&flag;if(result!==0){return true}return false};CC.AddFlag=function(source,flag){if(!CC.HasFlag(source,flag)){source|=flag}return source};CC.RemoveFlag=function(source,flag){if(CC.HasFlag(source,flag)){source^=flag}return source};function CCTools(){this.resize();this.monthNames=new Array(12);this.monthNames[0]="January";this.monthNames[1]="February";this.monthNames[2]="March";this.monthNames[3]="April";this.monthNames[4]="May";this.monthNames[5]="June";this.monthNames[6]="July";this.monthNames[7]="August";this.monthNames[8]="September";this.monthNames[9]="October";this.monthNames[10]="November";this.monthNames[11]="December"}CCTools.prototype.resize=function(){var self=this;CCTools.GetScreenSize(function(width,height){self.screenWidth=width;self.screenHeight=height;self.screenEnd=height+CCTools.GetScreenScroll()})};CCTools.GetScreenWidth=function(){var width=720;if(document.body&&document.body.clientWidth){width=document.body.clientWidth}else if(document.width){width=parseInt(document.width,10)}else if(window.innerWidth){width=window.innerWidth}return width};CCTools.GetScreenHeight=function(){var height=480;if(window&&window.innerHeight){height=window.innerHeight}else if(document.body&&document.body.clientHeight){height=document.body.clientHeight}else if(document.height){height=parseInt(document.height,10)}return height};CCTools.GetScreenSize=function(callback){var width=CCTools.GetScreenWidth();var height=CCTools.GetScreenHeight();if(window.tizen&&window.tizen.systeminfo){function successCallback(display){callback(display.resolutionHeight,display.resolutionWidth,display.resolutionHeight/width)}function errorCallback(error){callback(800,400,1)}window.tizen.systeminfo.getPropertyValue("DISPLAY",successCallback,errorCallback)}else{callback(width,height,1)}};CCTools.GetScreenScroll=function(){return document.body.scrollTop};CCTools.GetX=function(object){var parentObject=object;var returnValue=object.offsetLeft;while(object=object.offsetParent){if(object.tagName!=="HTML"){returnValue+=object.offsetLeft}}parentObject.x=returnValue;return returnValue};CCTools.GetY=function(object){var parentObject=object;var returnValue=object.offsetTop;while(object=object.offsetParent){if(object.tagName!=="HTML"){returnValue+=object.offsetTop}}parentObject.y=returnValue;return returnValue};CC.SetOpacity=function(object,value){object.style.opacity=value};CC.SetGradient=function(style,from,to){if(to===undefined){to=from}if(from===to){style.background=to}else if(BrowserType.firefox){style.background="-moz-linear-gradient( top, "+from+", "+to+" )"}else if(BrowserType.ie10){style.background="-ms-linear-gradient( top, "+from+", "+to+" )"}else if(BrowserType.ie){style.filter="progid:DXImageTransform.Microsoft.Gradient( StartColorStr='"+from+"', EndColorStr='"+to+"', GradientType=0 )"}else{try{style.background="-webkit-gradient( linear, left top, left bottom, from( "+from+" ), to( "+to+" ) )"}catch(e){style.background=to}if(!style.background){style.background=to}}};CCTools.prototype.equalDates=function(date1,date2){if(date1.getDate()===date2.getDate()&&date1.getMonth()===date2.getMonth()&&date1.getFullYear()===date2.getFullYear()){return true}return false};CCTools.prototype.betweenDates=function(date,dateStart,dateEnd){if(this.equalDates(date,dateStart)){return true}if(this.equalDates(date,dateEnd)){return true}if(date>dateStart&&date<dateEnd){return true}return false};CCTools.prototype.daysBetween=function(date1,date2){var ONE_DAY=1e3*60*60*24;var date1_ms=date1.getTime();var date2_ms=date2.getTime();var difference_ms=CC.Distance(date1_ms,date2_ms);return Math.round(difference_ms/ONE_DAY)};CCTools.prototype.dateToString=function(date){return date.getFullYear()+this.monthNames[date.getMonth()]+date.getDate()};CC.LocalTimeFromUTC=function(utcTime){var minutesOffset=-(new Date).getTimezoneOffset();var hoursOffset=minutesOffset/60;minutesOffset=minutesOffset%60;var timeSplit=utcTime.split(":");var hours=parseInt(timeSplit[0],10);var minutes=parseInt(timeSplit[1],10);minutes+=minutesOffset;if(minutes<0){hours--;minutes+=60}else if(minutes>=60){hours++;minutes+=60}hours+=hoursOffset;if(hours<0){hours+=24}else if(hours>=24){hours-=24}if(hours<10){hours="0"+hours}if(minutes<10){minutes="0"+minutes}return""+hours+":"+minutes};CC.GetJSLocationBarData=function(key,defaultValue,url){if(!url){url=window.location.href}var urlSplit=url.split("#");if(urlSplit.length>1){var urlPackets=urlSplit[1].split("&");for(var i=0;i<urlPackets.length;++i){var urlPacket=urlPackets[i].split("=");var urlKey=urlPacket[0];var urlValue=true;if(urlPacket.length>1){urlValue=urlPacket[1]}if(urlKey===key){return urlValue}}}if(defaultValue===undefined){defaultValue=false}return defaultValue};CC.RemoveJSLocationBarData=function(key,setURL){var urlSplit=window.location.href.split("#");var url=urlSplit[0];url+="#";if(urlSplit.length>1){var urlData=urlSplit[1];var tokensArray=urlData.split("&");for(var i=0;i<tokensArray.length;++i){var tokenString=tokensArray[i];var tokenKeyValue=tokenString.split("=");var tokenKey=tokenKeyValue[0];if(tokenKey.length>0&&tokenKey!==key){url+=tokenString;url+="&"}}}if(CCEngine.NativeUpdateCommands===undefined){if(setURL===undefined||setURL){CC.SetWindowURL(url)}}return url};CC.SetJSLocationBarData=function(key,value){var url=CC.RemoveJSLocationBarData(key,false);if(value===undefined){url+=key+"&"}else{url+=key+"="+value+"&"}if(CCEngine.NativeUpdateCommands===undefined){CC.SetWindowURL(url)}};CC.SetPHPLocationBarData=function(key,value){var urlSplit=window.location.href.split("?");var url=urlSplit[0];url+="?"+key+"="+value;if(urlSplit.length>1){var hashSplit=urlSplit[1].split("#");if(hashSplit.length>1){url+="#"+hashSplit[1]}}if(url===window.location.href){window.location.reload()}else{CC.SetWindowURL(url)}};CC.SetWindowURL=function(url,resetStack){if(!CC.WindowURLUpdatesDisabled){if(CC.WindowURL!==url){if(!CC.PendingURLStack){CC.PendingURLStack=[]}if(resetStack){CC.PendingURLStack.length=0}CC.WindowURL=url;if(window.location.href!==url){CC.PendingURLStack.push(url);window.location.href=url}}}};CC.GetURLWithoutLocationBarData=function(){var urlSplit=window.location.href.split("?");if(urlSplit.length>1){return urlSplit[0]}urlSplit=window.location.href.split("#");return urlSplit[0]};CC.WindowPrompt=function(title,message){if(CCEngine.DeviceType==="Web"){return window.prompt(title,message)}return false};CCTools.prototype.isAlphabetic=function(string){return"/^[a-zA-Z]+$/".test(string)};CC.IsAlphaNumeric=function(string){return/^[a-zA-Z0-9]*$/.test(string)};String.StripEquals=function(src){if(src.contains("=")){var split=src.split("=");if(split.length>1){return split[split.length-1]}}return src};String.ReplaceChar=function(source,search,replace){var split=source.split(search);var result="";for(var i=0;i<split.length;++i){if(i>0){result+=replace}result+=split[i]}return result};String.SplitBetween=function(source,from,to){var splitFrom=source.split(from);if(splitFrom.length>1){var splitTo=splitFrom[1].split(to);return splitTo[0]}return false};String.SplitBefore=function(source,before){var split=source.split(before);return split[0]};String.SplitAfter=function(source,after){var split=source.split(after);if(split.length>1){var result=split[1];for(var i=2;i<split.length;++i){result+=after;result+=split[i]}return result}return""};String.LastWord=function(source){var split=source.split(" ");return split[split.length-1]};String.RemoveBetween=function(source,before,after){var i;var result="";var splitBefore=source.split(before);for(i=0;i<splitBefore.length-1;++i){result+=before;result+=splitBefore[i]}var splitAfter=source.split(after);for(i=1;i<splitAfter.length;++i){result+=after;result+=splitAfter[i]}return result};String.RemoveBetweenIncluding=function(source,before,after){var result="";var splitBefore=source.split(before);var i;for(i=0;i<splitBefore.length-1;++i){if(i!==0){result+=before}result+=splitBefore[i]}var splitAfter=source.split(after);for(i=1;i<splitAfter.length;++i){if(i!==1){result+=after}result+=splitAfter[i]}return result};String.prototype.getDomain=function(){var start=String.SplitBefore(this,":");var domain=String.SplitBetween(this,"//","/");return start+"://"+domain};String.prototype.getHostname=function(){return String.SplitBetween(this,"//","/")};String.prototype.getFilename=function(){var filename=this.stripDirectory();if(filename.contains("=")){filename=String.SplitAfter(filename,"=")}return filename};String.prototype.contains=function(token){if(this.indexOf(token)!==-1){return true}return false};String.prototype.containsDirectory=function(){if(this.contains("/")){return true}return false};String.prototype.isHTTP=function(){var httpString="http://";if(this.substring(0,httpString.length)===httpString){return true}return false};String.prototype.isHTTPS=function(){var httpString="https://";if(this.substring(0,httpString.length)===httpString){return true}return false};String.prototype.strip=function(token){return this.replace(token,"")};String.prototype.stripExtension=function(){var results=this.split(".");var newString="";for(var i=0;i<results.length-1;++i){if(i>0){newString+="."}newString+=results[i]}return newString};String.prototype.stripFilename=function(){return this.substring(0,this.lastIndexOf("/"))};String.prototype.stripDirectory=function(){return this.replace(/^.*[\\\/]/,"")};String.prototype.stripStart=function(token){var index=this.indexOf(token);if(index!==-1){return string.substring(index)}return this};String.prototype.formatSpacesAndTabs=function(){var string=String.ReplaceChar(this,"	"," ");while(string.length>0&&string[0]===" "){string=string.substring(1)}while(string.length>0&&string[string.length-1]===" "){string=string.substring(0,string.length-1)}return string};String.prototype.getExtension=function(){var results=this.split(".");if(results.length>1){return results[results.length-1].toLowerCase()}return""};String.prototype.resolveURL=function(){var url=this;if(!url.startsWith("http")){url=window.location.href.stripFilename()+"/"+this}var urlSplit=url.split("/..");if(urlSplit.length>1){url=urlSplit[0].stripFilename()+urlSplit[1]}return url};String.prototype.startsWith=function(needle){return this.indexOf(needle)===0};String.strncmp=function(a,b,n){return a.substring(0,n)===b.substring(0,n)};Array.prototype.safePop=function(){var result=this[0];for(var i=0;i<this.length-1;++i){this[i]=this[i+1]}this.length--;return result};Array.prototype.add=function(object){this.push(object)};Array.prototype.addOnce=function(object){if(this.find(object)===-1){this.push(object);return true}return false};Array.prototype.insert=function(object,index){var currentIndex=this.find(object);if(currentIndex!==-1){if(currentIndex===index){return false}this.remove(object)}this.add(object);var length=this.length;for(var i=length-1;i>index;--i){this[i]=this[i-1]}this[index]=object;return true};Array.prototype.remove=function(object){var length=this.length;for(var i=0;i<length;++i){if(this[i]===object){length--;for(var j=i;j<length;++j){this[j]=this[j+1]}this.length--;return true}}return false};Array.prototype.removeIndex=function(index){var length=this.length;if(index<length){for(var i=index;i<length;++i){this[i]=this[i+1]}this.length--;return true}return false};Array.prototype.find=function(object){var length=this.length;for(var i=0;i<length;++i){if(this[i]===object){return i}}return-1};Array.prototype.last=function(object){if(this.length>0){return this[this.length-1]}return null};Array.prototype.emit=function(){for(var i=0;i<this.length;++i){this[i]()}};Array.prototype.first=function(){if(this.length>0){return this[0]}return null};function DOMDimensions(object){this.object=object;this.x=0;this.y=0;this.width=1;this.height=1;this.totalWidth=1;this.totalHeight=1;this.borderSize=0}DOMDimensions.prototype.setPosition=function(x,y){var object=this.object;if(x!==this.x){object.style.left=x+"px";this.x=x}if(y!==this.y){object.style.top=y+"px";this.y=y}};DOMDimensions.prototype.refreshBorder=function(){this.borderSize=this.object.style.border?parseInt(this.object.style.border,10):0};DOMDimensions.prototype.refreshPosition=function(){var dimensions=this;dimensions.x=CCTools.GetX(this.object);dimensions.y=CCTools.GetY(this.object)};DOMDimensions.prototype.refreshSize=function(){var dimensions=this;var width=this.object.clientWidth;var height=this.object.clientHeight;if(width<1){width=1}if(height<1){height=1}dimensions.width=width;dimensions.height=height;dimensions.totalWidth=width+dimensions.borderSize*2;dimensions.totalHeight=height+dimensions.borderSize*2};DOMDimensions.prototype.refresh=function(){this.refreshBorder();this.refreshPosition();this.refreshSize()};function TableComponent(parent,selectable){this.callbacks=[];var table=this.table=document.createElement("table");table.cellPadding=0;table.cellSpacing=0;var style=this.style=table.style;style.marginLeft=0;style.marginRight=0;style.marginTop=0;style.marginBottom=0;if(!selectable){style.cursor="pointer";table.unselectable=true;style.MozUserSelect="none"}this.dimensions=new DOMDimensions(this.table);style.position="absolute";style.left="0px";style.top="0px";var tBody=this.tBody=document.createElement("tbody");table.appendChild(tBody);this.tr=[];this.addRow();this.addColumn();this.td=this.tr[0].td[0];if(parent){parent.appendChild(this.table)}}TableComponent.prototype.addRow=function(){var index=this.tr?this.tr.length:0;var tr=this.tr[index]=document.createElement("tr");tr.td=[];this.tBody.appendChild(tr);return tr};TableComponent.prototype.addColumnToRow=function(row){if(row>=this.tr.length){alert("TableComponent.prototype.addColumn() - invalid row");return}var index=this.tr[row].td?this.tr[row].td.length:0;var td=this.tr[row].td[index]=document.createElement("td");this.tr[row].appendChild(td);return td};TableComponent.prototype.addColumn=function(){return this.addColumnToRow(this.tr.length-1)};function CCVarPointer(inValue){this.value=inValue}function CCInterpolator(){this.construct()}CCInterpolator.prototype.construct=function(){this.speed=1;this.onInterpolated=[];this.updating=false};CCInterpolator.prototype.setDuration=function(duration){this.speed=1/duration};CCInterpolator.prototype.finish=function(){this.update(CC_MAXFLOAT)};function CCInterpolatorSin2Curve(){this.construct()}ExtendPrototype(CCInterpolatorSin2Curve,CCInterpolator);CCInterpolatorSin2Curve.prototype.construct=function(){this.CCInterpolator_construct();this.interpolationCurveMultiple=1/Math.sin(2);this.current=false;this.target=undefined;this.start=undefined;this.length=undefined;this.amount=1};CCInterpolatorSin2Curve.prototype.setup=function(inCurrent,inTarget){if(this.current!==inCurrent||this.target!==inTarget){this.current=inCurrent;this.target=inTarget;this.ready()}else if(this.current.value===this.target){this.amount=1}this.updating=true};CCInterpolatorSin2Curve.prototype.ready=function(){this.start=this.current.value;this.length=this.target-this.start;if(this.current.value===this.target){this.amount=1}else{this.amount=0}this.updating=true};CCInterpolatorSin2Curve.prototype.incrementAmount=function(delta){if(this.amount!==1){this.amount=CC.ToTarget(this.amount,1,delta*this.speed);return true}return false};CCInterpolatorSin2Curve.prototype.calculatePercentage=function(){var percentage=Math.sin(this.amount*2)*this.interpolationCurveMultiple;return percentage};CCInterpolatorSin2Curve.prototype.updateInterpolation=function(percentage){var movement=this.length*percentage;this.current.value=movement+this.start};CCInterpolatorSin2Curve.prototype.update=function(delta){this.updating=false;var current=this.current;if(current){if(this.incrementAmount(delta)){var percentage=this.calculatePercentage();this.updateInterpolation(percentage);this.updating=true}else if(current.value!==this.target){current.value=this.target;this.current=false;this.updating=true}else{this.current=false}}else{var onInterpolated=this.onInterpolated;var length=onInterpolated.length;if(length>0){var i;var pendingCallbacks=[];for(i=0;i<length;++i){pendingCallbacks.add(onInterpolated[i])}onInterpolated.length=0;for(i=0;i<length;++i){pendingCallbacks[i].run()}}}return this.updating};CCInterpolatorSin2Curve.prototype.equals=function(inCurrent,inTarget){if(this.current===inCurrent&&this.target===inTarget){return true}return false};function CCInterpolatorX2Curve(){this.construct()}ExtendPrototype(CCInterpolatorX2Curve,CCInterpolatorSin2Curve,true);CCInterpolatorX2Curve.prototype.calculatePercentage=function(){var percentage=this.amount*this.amount;return percentage};function CCInterpolatorX3Curve(){this.construct()}ExtendPrototype(CCInterpolatorX3Curve,CCInterpolatorSin2Curve,true);CCInterpolatorX3Curve.prototype.calculatePercentage=function(){var sudoAmount=this.amount-1;var percentage=1+sudoAmount*sudoAmount*sudoAmount;return percentage};function CCInterpolatorV3(type){this.type=type;this.construct()}ExtendPrototype(CCInterpolatorV3,CCInterpolator);CCInterpolatorV3.prototype.construct=function(){this.CCInterpolator_construct();this.xPointer=new CCVarPointer;this.yPointer=new CCVarPointer;this.zPointer=new CCVarPointer;this.x=new this.type;this.y=new this.type;this.z=new this.type;this.onInterpolated=[]};CCInterpolatorV3.prototype.setup=function(inCurrent,inTarget,inCallback){if(typeof inTarget==="number"){inTarget=vec3.clone([inTarget,inTarget,inTarget])}this.current=inCurrent;this.xPointer.value=inCurrent[0];this.yPointer.value=inCurrent[1];this.zPointer.value=inCurrent[2];inTarget=inTarget?inTarget:inCurrent;this.setTarget(inTarget,inCallback);return this};CCInterpolatorV3.prototype.setTarget=function(inTarget,inCallback){this.x.setup(this.xPointer,inTarget[0]);this.y.setup(this.yPointer,inTarget[1]);this.z.setup(this.zPointer,inTarget[2]);this.onInterpolated.length=0;if(inCallback){this.onInterpolated.push(inCallback)}this.updating=true};CCInterpolatorV3.prototype.ready=function(){this.xPointer.value=this.current[0];this.yPointer.value=this.current[1];this.zPointer.value=this.current[2];this.x.ready();this.y.ready();this.z.ready();this.updating=true};CCInterpolatorV3.prototype.update=function(delta){var deltaSpeed=delta*this.speed;this.updating=this.x.update(deltaSpeed);this.updating|=this.y.update(deltaSpeed);this.updating|=this.z.update(deltaSpeed);if(this.updating){this.current[0]=this.xPointer.value;this.current[1]=this.yPointer.value;this.current[2]=this.zPointer.value}else{var onInterpolated=this.onInterpolated;var length=onInterpolated.length;if(length>0){var i;var pendingCallbacks=[];for(i=0;i<length;++i){pendingCallbacks.push(onInterpolated[i])}onInterpolated.length=0;for(i=0;i<length;++i){pendingCallbacks[i]()}}}return this.updating};CCInterpolatorV3.prototype.equals=function(inCurrent,inTarget){if(this.x.equals(inCurrent[0],inTarget[0])&&this.y.equals(inCurrent[1],inTarget[1])&&this.z.equals(inCurrent[2],inTarget[2])){return true}return false};CCInterpolatorV3.prototype.getAmount=function(delta){return vec3.clone([this.x.amount,this.y.amount,this.z.amount])};CCInterpolatorV3.prototype.getTarget=function(delta){return vec3.clone([this.x.target,this.y.target,this.z.target])};function CCInterpolatorListV3(type){this.type=type?type:CCInterpolatorSin2Curve;this.construct();this.interpolators=[]}ExtendPrototype(CCInterpolatorListV3,CCInterpolator);CCInterpolatorListV3.prototype.clear=function(){this.interpolators.length=0};CCInterpolatorListV3.prototype.pushV3=function(inCurrent,inTarget,replace,inCallback){this.updating=true;var i,interpolator;var interpolators=this.interpolators;if(interpolators.length>0){if(replace){var found=false;for(i=0;i<interpolators.length;++i){interpolator=interpolators[i];if(interpolator.equals(inCurrent,inTarget)){found=true;interpolator.onInterpolated.push(inCallback);if(i!==0){interpolator.ready()}}else{interpolators.splice(i,1)}}if(found){return false}}else{for(i=0;i<interpolators.length;++i){interpolator=interpolators[i];if(interpolator.equals(inCurrent,inTarget)){return false}}}}if(inCurrent!==inTarget){interpolator=new CCInterpolatorV3(this.type).setup(inCurrent,inTarget,inCallback);interpolators.push(interpolator)}return true};CCInterpolatorListV3.prototype.update=function(delta){this.updating=false;var interpolators=this.interpolators;if(interpolators.length>0){var interpolator=interpolators[0];if(!interpolator.update(delta*this.speed)){interpolators.splice(0,1);if(interpolators.length>0){interpolators[0].ready()}else{return false}}this.updating=true}return this.updating};CCInterpolatorListV3.prototype.finished=function(){return this.interpolators.length===0};CCInterpolatorListV3.prototype.getTarget=function(){if(this.interpolators.length>0){return this.interpolators.last().getTarget()}return vec3.create()};function CCInterpolatorColour(type){this.type=type?type:CCInterpolatorX2Curve;this.construct()}ExtendPrototype(CCInterpolatorColour,CCInterpolator);CCInterpolatorColour.prototype.construct=function(){this.CCInterpolator_construct();this.rPointer=new CCVarPointer;this.gPointer=new CCVarPointer;this.bPointer=new CCVarPointer;this.aPointer=new CCVarPointer;this.r=new this.type;this.g=new this.type;this.b=new this.type;this.a=new this.type;this.onInterpolated=[]};CCInterpolatorColour.prototype.equals=function(inCurrent,inTarget){if(this.x.equals(inCurrent.r,inTarget.r)&&this.y.equals(inCurrent.g,inTarget.g)&&this.z.equals(inCurrent.b,inTarget.b)&&this.a.equals(inCurrent.a,inTarget.a)){return true}return false};CCInterpolatorColour.prototype.setup=function(inCurrent,inTarget,inCallback){this.current=inCurrent;this.rPointer.value=inCurrent.r;this.gPointer.value=inCurrent.g;this.bPointer.value=inCurrent.b;this.aPointer.value=inCurrent.a;inTarget=inTarget?inTarget:inCurrent;this.setTarget(inTarget,inCallback);return this};CCInterpolatorColour.prototype.setTarget=function(inTarget,inCallback){this.r.setup(this.rPointer,inTarget.r);this.g.setup(this.gPointer,inTarget.g);this.b.setup(this.bPointer,inTarget.b);this.a.setup(this.aPointer,inTarget.a);this.onInterpolated.length=0;if(inCallback){this.onInterpolated.push(inCallback)}this.updating=true};CCInterpolatorColour.prototype.setTargetAlpha=function(inTargetAlpha,inCallback){this.a.setup(this.aPointer,inTargetAlpha);this.onInterpolated.length=0;if(inCallback){this.onInterpolated.push(inCallback)}this.updating=true};CCInterpolatorColour.prototype.ready=function(){this.rPointer.value=this.current.r;this.gPointer.value=this.current.g;this.bPointer.value=this.current.b;this.aPointer.value=this.current.a;this.r.ready();this.g.ready();this.b.ready();this.a.ready();this.updating=true};CCInterpolatorColour.prototype.update=function(delta){var deltaSpeed=delta*this.speed;this.updating=this.r.update(deltaSpeed);this.updating|=this.g.update(deltaSpeed);this.updating|=this.b.update(deltaSpeed);this.updating|=this.a.update(deltaSpeed);if(this.updating){this.current.r=this.rPointer.value;this.current.g=this.gPointer.value;this.current.b=this.bPointer.value;this.current.a=this.aPointer.value}else{var onInterpolated=this.onInterpolated;var length=onInterpolated.length;if(length>0){var i;var pendingCallbacks=[];for(i=0;i<length;++i){pendingCallbacks.push(onInterpolated[i])}onInterpolated.length=0;for(i=0;i<length;++i){pendingCallbacks[i]()}}}return this.updating};CCInterpolatorColour.prototype.getTarget=function(){var target=new CCColour;target.r=this.r.target;target.g=this.g.target;target.b=this.b.target;target.a=this.a.target;return target};function CCTimer(){this.time=0;this.updating=false;this.interval=0;this.onTime=[]}CCTimer.prototype.update=function(delta){if(this.updating){var real=gEngine.timeReal;this.time-=real;if(this.time<=0){this.updating=false}return true}return false};CCTimer.prototype.finish=function(){this.onTime.emit()};CCTimer.prototype.start=function(timeout){this.interval=timeout;this.restart()};CCTimer.prototype.stop=function(){this.updating=false};CCTimer.prototype.restart=function(){this.time=this.interval;this.updating=true};function CCMovementInterpolator(inObject,updateCollisions){this.object=inObject;this.object.addUpdater(this);this.updating=false;this.movementInterpolator=new CCInterpolatorListV3(CCInterpolatorX3Curve);this.updateCollisions=updateCollisions}CCMovementInterpolator.prototype.update=function(delta){if(this.updating){if(this.movementInterpolator.updating){if(this.movementInterpolator.update(delta)){var object=this.object;if(this.updateCollisions){object.updateCollisions=true;CCOctree.RefreshObject(object)}object.dirtyModelMatrix();return true}else{this.updating=false}}else{this.updating=false}}return false};CCMovementInterpolator.prototype.clear=function(){if(this.updating){this.updating=false;this.movementInterpolator.clear()}};CCMovementInterpolator.prototype.finish=function(){if(this.updating){this.update(CC_MAXFLOAT)}};CCMovementInterpolator.prototype.setMovement=function(target,inCallback){this.updating=true;this.movementInterpolator.pushV3(this.object.position,target,true,inCallback)};CCMovementInterpolator.prototype.setMovementX=function(x){var object=this.object;this.setMovement(vec3.clone([x,object.position[1],object.position[2]]))};CCMovementInterpolator.prototype.translateMovementX=function(x){this.setMovementX(this.object.position[0]+x)};CCMovementInterpolator.prototype.translateMovementY=function(y){this.setMovementY(this.object.position[1]+y)};CCMovementInterpolator.prototype.setMovementY=function(y,inCallback){var object=this.object;this.setMovement(vec3.clone([object.position[0],y,object.position[2]]),inCallback)};CCMovementInterpolator.prototype.setMovementXY=function(x,y,inCallback){var object=this.object;this.setMovement(vec3.clone([x,y,object.position[2]]),inCallback)};CCMovementInterpolator.prototype.setMovementYZ=function(y,z,inCallback){var object=this.object;this.setMovement(vec3.clone([object.position[0],y,z]),inCallback)};CCMovementInterpolator.prototype.getMovementTarget=function(){if(this.updating&&this.movementInterpolator.interpolators.length>0){return this.movementInterpolator.getTarget()}if(!this.positionCache){this.positionCache=vec3.create()}vec3.copy(this.positionCache,this.object.position);return this.positionCache};CCMovementInterpolator.prototype.setDuration=function(duration){this.movementInterpolator.setDuration(duration)};function Path(){this.endDirection=0;this.distance=0;this.directions=[]}function PathConnection(){this.distance=undefined;this.angle=undefined;this.node=undefined}function PathNode(){this.point=vec3.create();this.connections=[]}function CCPathFinderNetwork(){this.nodes=[];this.testNodes=[];this.path=undefined;this.pathingFrom=undefined}CCPathFinderNetwork.prototype.view=function(){var nodes=this.nodes;if(nodes.length>0){var renderer=gRenderer;gEngine.textureManager.setTextureIndex(1);var nodeColour=gColour.setRGBA(1,0,0,.125);renderer.CCSetColour(nodeColour);var i,node;var start=vec3.create();var end=vec3.create();{for(i=0;i<nodes.length;++i){node=nodes[i];CCRenderer.GLPushMatrix();CCRenderer.GLTranslate(node.point);renderer.CCRenderCube(true);CCRenderer.GLPopMatrix()}for(i=0;i<nodes.length;++i){node=nodes[i];var connections=node.connections;for(var j=0;j<connections.length;++j){var connection=connections[j].node.point;vec3.copy(start,[node.point[0],2,node.point[2]]);vec3.copy(end,[connection[0],2,connection[2]]);renderer.CCRenderLine(start,end)}}}if(this.path){var pathColour=gColour.setRGBA(0,1,.25,1);{renderer.CCSetColour(pathColour);var currentNode=this.pathingFrom;var path=this.path;for(i=0;i<path.endDirection;++i){var connectionIndex=path.directions[i];if(connectionIndex<currentNode.connections.length){var toNode=currentNode.connections[connectionIndex].node;start.set([currentNode.point[0],3,currentNode.point[2]]);end.set([toNode.point[0],3,toNode.point[2]]);renderer.CCRenderLine(start,end);currentNode=toNode}}}}}};CCPathFinderNetwork.prototype.addNode=function(point,parent){var node=new PathNode;
node.point=point;if(parent){node.parent=parent}this.nodes.add(node);this.testNodes.add(node);return node};CCPathFinderNetwork.prototype.addCollideable=function(collideable,extents){var maxIncrement=150;var minIncrement=50;var startX=collideable.aabbMin[0]-minIncrement;var endX=collideable.aabbMax[0]+minIncrement;var width=endX-startX;var numberOfIncrements=Math.round(width/maxIncrement+.5);var spacingX=width/numberOfIncrements;var startZ=collideable.aabbMin[2]-minIncrement;var endZ=collideable.aabbMax[2]+minIncrement;var depth=endZ-startZ;numberOfIncrements=Math.round(depth/maxIncrement+.5);var spacingZ=depth/numberOfIncrements;var x,z;for(x=startX;x<endX+1;x+=spacingX){if(x>-extents[0]&&x<extents[0]){for(z=startZ;z<endZ+1;z+=depth){if(z>-extents[2]&&z<extents[2]){this.addNode(vec3.clone([x,0,z]),collideable)}}}}for(z=startZ+spacingZ;z<endZ+1-spacingZ;z+=depth-spacingZ){if(z>-extents[2]&&z<extents[2]){for(x=startX;x<endX+1;x+=spacingX){if(x>-extents[0]&&x<extents[0]){this.addNode(vec3.clone([x,0,z]),collideable)}}}}};CCPathFinderNetwork.prototype.removeCollideable=function(collideable){var nodes=this.nodes;var testNodes=this.testNodes;for(var i=0;i<nodes.length;++i){var node=nodes[i];if(node.parent===collideable){nodes.remove(node);testNodes.remove(node);--i}}};CCPathFinderNetwork.prototype.addFillerNodes=function(collideable){CC.UpdateCollisions(collideable);var maxIncrement=100;var minIncrement=maxIncrement;var startX=collideable.aabbMin[0]+minIncrement;var endX=collideable.aabbMax[0]-minIncrement;var width=endX-startX;var numberOfIncrements=Math.round(width/maxIncrement+.5);if(numberOfIncrements<1){numberOfIncrements=1}var spacingX=width/numberOfIncrements;var startZ=collideable.aabbMin[2]+minIncrement;var endZ=collideable.aabbMax[2]-minIncrement;var depth=endZ-startZ;numberOfIncrements=Math.round(depth/maxIncrement+.5);if(numberOfIncrements<1){numberOfIncrements=1}var spacingZ=depth/numberOfIncrements;for(var x=startX;x<endX+1;x+=spacingX){for(var z=startZ;z<endZ+1;z+=spacingZ){this.addNode(vec3.clone([x,0,z]))}}};CCPathFinderNetwork.prototype.linkDistantNodes=function(){var nodes=this.nodes;if(nodes.length>0){var BIG_FLOAT=1e4;var topLeft=this.findClosestNode([-BIG_FLOAT,0,-BIG_FLOAT]);var topRight=this.findClosestNode([BIG_FLOAT,0,-BIG_FLOAT]);var bottomLeft=this.findClosestNode([-BIG_FLOAT,0,BIG_FLOAT]);var bottomRight=this.findClosestNode([BIG_FLOAT,0,BIG_FLOAT]);if(topLeft&&topRight&&bottomLeft&&bottomRight){var startX=topLeft.point[0]<bottomLeft.point[0]?topLeft.point[0]:bottomLeft.point[0];var endX=topRight.point[0]>bottomRight.point[0]?topRight.point[0]:bottomRight.point[0];var startZ=topLeft.point[2]<topRight.point[2]?topLeft.point[2]:topRight.point[2];var endZ=bottomLeft.point[2]>bottomRight.point[2]?bottomLeft.point[2]:bottomRight.point[2];var x=startX;var z=startZ;var increment=150;while(x<endX&&z<endZ){x+=increment;if(x>=endX){x=startX+increment;z+=increment}if(z<endZ){this.addNode(vec3.clone([x,0,z]))}}}}};CCPathFinderNetwork.prototype.removeFillerNodes=function(){var nodes=this.nodes;var testNodes=this.testNodes;for(var i=0;i<nodes.length;++i){var node=nodes[i];if(!node.parent){nodes.remove(node);testNodes.remove(node);--i}}};CCPathFinderNetwork.prototype.clear=function(){this.nodes.length=0;this.pathingFrom=null};CCPathFinderNetwork.prototype.connect=function(){this.removeFillerNodes();this.linkDistantNodes();var nodes=this.nodes;var i,connections,currentNode,connection;for(i=0;i<nodes.length;++i){currentNode=nodes[i];connections=currentNode.connections;connections.length=0}var maxNodeDistance=CC.SQUARE(200);for(i=0;i<nodes.length;++i){currentNode=nodes[i];connections=currentNode.connections;for(var j=0;j<nodes.length;++j){var targetNode=nodes[j];if(currentNode!==targetNode){var distance=CC.Vector3Distance2D(currentNode.point,targetNode.point);if(distance<maxNodeDistance){var angle=CC.AngleTowardsVector(currentNode.point,targetNode.point);{var angleFoundIndex=-1;for(var k=0;k<connections.length;++k){if(angle===connections[k].angle){angleFoundIndex=k;break}}if(angleFoundIndex!==-1){if(distance>=connections[angleFoundIndex].distance){continue}else{connections.remove(connections[angleFoundIndex])}}var newConnection=new PathConnection;newConnection.distance=distance;newConnection.angle=angle;newConnection.node=targetNode;connections.add(newConnection)}}}}}};CCPathFinderNetwork.prototype.findClosestNodes=function(position,radius,vectors,length){var nodes=this.nodes;for(var i=0;i<nodes.length&&vectors.length<length;++i){var node=nodes[i];if(node.connections.length>0){var distance=CC.Vector3Distance2D(position,node.point);if(distance<radius){vectors.add(node.point)}}}return vectors.length};CCPathFinderNetwork.prototype.findClosestNodeToPathTarget=function(objectToPath,position,withConnections){var i;var nodes=this.testNodes;var nodesLength=nodes.length;for(i=0;i<nodesLength;++i){nodes[i].distance=undefined}nodes.sort(function(a,b){var distanceA=a.distance=a.distance!==undefined?a.distance:CC.Vector3Distance2D(a.point,position);var distanceB=b.distance=b.distance!==undefined?b.distance:CC.Vector3Distance2D(b.point,position);return distanceA-distanceB});var closestNode=null;var closestDistance=CC_MAXFLOAT;var MovementCollisionCheckFunction=CC.MovementCollisionCheck;for(i=0;i<nodesLength;++i){var node=nodes[i];if(!withConnections||node.connections.length>0){var distance=node.distance;if(distance<closestDistance){var hitObject=MovementCollisionCheckFunction(objectToPath,position,node.point,CC.collision_static);if(hitObject){continue}if(!hitObject){closestDistance=distance;closestNode=node}}}}if(closestNode){return closestNode}return null};CCPathFinderNetwork.prototype.findClosestNode=function(position){var nodes=this.nodes;var closestNode=null;var closestDistance=CC_MAXFLOAT;for(var i=0;i<nodes.length;++i){var node=nodes[i];var distance=CC.Vector3Distance2D(node.point,position);if(distance<closestDistance){closestDistance=distance;closestNode=node}}return closestNode};CCPathFinderNetwork.compareNode=undefined;CCPathFinderNetwork.targetNode=undefined;function followPathCompare(a,b){var pathA=CCPathFinderNetwork.compareNode.connections[a];var pathB=CCPathFinderNetwork.compareNode.connections[b];var pathADistance=CC.Vector3Distance2D(pathA.node.point,CCPathFinderNetwork.targetNode.point);var pathBDistance=CC.Vector3Distance2D(pathB.node.point,CCPathFinderNetwork.targetNode.point);return pathADistance-pathBDistance}CCPathFinderNetwork.prototype.findPath=function(objectToPath,fromNode,toNode){if(fromNode&&toNode){var previousNodes=[];previousNodes.add(fromNode);CCPathFinderNetwork.targetNode=toNode;this.path=new Path;this.followPath(objectToPath,this.path,0,0,previousNodes,fromNode,toNode);this.pathingFrom=fromNode;return this.path}return null};CCPathFinderNetwork.prototype.followPath=function(objectToPath,path,currentDirection,currentDistance,previousNodes,fromNode,toNode){var i;if(fromNode===toNode){path.endDirection=currentDirection;path.distance=currentDistance;return true}var nextDirection=currentDirection+1;if(nextDirection>=10){return false}CCPathFinderNetwork.compareNode=fromNode;var connections=fromNode.connections;var connectionsLength=connections.length;var values=new Array(connectionsLength);for(i=0;i<connectionsLength;++i){values[i]=i}values.sort(followPathCompare);var MovementCollisionCheckFunction=CC.MovementCollisionCheck;for(i=0;i<connectionsLength;++i){var nextConnection=connections[values[i]];var targetNode=nextConnection.node;if(previousNodes.find(targetNode)>=0){continue}var collidedWith=MovementCollisionCheckFunction(objectToPath,fromNode.point,targetNode.point,CC.collision_static);if(collidedWith){continue}var pathDistance=currentDistance+nextConnection.distance;previousNodes.add(targetNode);if(this.followPath(objectToPath,path,nextDirection,pathDistance,previousNodes,targetNode,toNode)){path.directions[currentDirection]=values[i];return true}}return false};function CCAudioManager(){}CCAudioManager.Enabled=CC.LoadData("AudioDisabled")?false:true;CCAudioManager.Paused=false;CCAudioManager.MP3s=[];CCAudioManager.ToggleAudio=function(){CCAudioManager.Enabled=!CCAudioManager.Enabled;if(!CCAudioManager.Enabled){CC.SaveData("AudioDisabled",true)}else{CC.DeleteData("AudioDisabled")}var MP3s=CCAudioManager.MP3s;for(var i=0;i<MP3s.length;++i){var mp3=MP3s[i];mp3.mute(CCAudioManager.Enabled?false:true)}};CCAudioManager.IsPlaying=function(id){var MP3s=CCAudioManager.MP3s;for(var i=0;i<MP3s.length;++i){var mp3=MP3s[i];if(mp3.id===id){return mp3.isPlaying()}}return false};CCAudioManager.Prepare=function(id,url,callback){var MP3s=CCAudioManager.MP3s;var mp3=CCAudioManager.Get(id);if(mp3){if(mp3.url!==url){CCAudioManager.Stop(id);mp3=null}}if(mp3){if(callback){if(mp3.onLoadedCallbacks){mp3.onLoadedCallbacks.push(callback)}else if(!mp3.error){callback(mp3)}}return}mp3=new CCMP3(id,url);mp3.id=id;mp3.url=url;mp3.onLoadedCallbacks=[];if(callback){mp3.onLoadedCallbacks.push(callback)}CCAudioManager.MP3s.push(mp3);var OnCached=function(mp3){return function(binary){CCAudioManager.Prepared(mp3.id,mp3.url,binary)}};CCAudioManager.Cache(url,new OnCached(mp3))};CCAudioManager.Cache=function(url,callback){var filename=url.getFilename();var downloadURL=MultiplayerManager.GetAssetURL(url);gURLManager.requestURL(downloadURL,null,function(status,responseBinary){if(status>=CCURLRequest.Succeeded){if(responseBinary){if(callback){callback(responseBinary)}}}},0,filename,null,null,true)};CCAudioManager.Get=function(id){var MP3s=CCAudioManager.MP3s;for(var i=0;i<MP3s.length;++i){var mp3=MP3s[i];if(mp3.id===id){return mp3}}return null};CCAudioManager.Stop=function(id){var mp3=CCAudioManager.Get(id);if(mp3){CCAudioManager.MP3s.remove(mp3);mp3.stop();return true}return false};CCAudioManager.StopAll=function(){var MP3s=CCAudioManager.MP3s;while(MP3s.length>0){var mp3=MP3s[0];CCAudioManager.MP3s.remove(mp3);mp3.stop()}};CCAudioManager.Pause=function(){CCAudioManager.Paused=true;var MP3s=CCAudioManager.MP3s;for(var i=0;i<MP3s.length;++i){var mp3=MP3s[i];mp3.pause()}};CCAudioManager.Resume=function(){CCAudioManager.Paused=false;var MP3s=CCAudioManager.MP3s;for(var i=0;i<MP3s.length;++i){var mp3=MP3s[i];mp3.resume()}};CCAudioManager.IsDetectingSpeechState=function(){};CCAudioManager.StartSpeechDetection=function(){};CCAudioManager.StopSpeechDetection=function(){};function CCCameraProjectionResults(){this.vNear=vec3.create();this.vFar=vec3.create();this.vDirection=vec3.create();this.vLookAt=vec3.create()}function CCCameraBase(){this.construct()}CCCameraBase.NextID=0;CCCameraBase.frustum_right=0*4;CCCameraBase.frustum_left=1*4;CCCameraBase.frustum_bottom=2*4;CCCameraBase.frustum_top=3*4;CCCameraBase.frustum_far=4*4;CCCameraBase.frustum_near=5*4;CCCameraBase.frustum_max=6*4;CCCameraBase.prototype.construct=function(){this.cameraID=CCCameraBase.NextID++;this.enabled=true;this.viewMatrix=mat4.create();this.projectionMatrix=mat4.create();this.currentLookAt=vec3.create();this.currentRotatedPosition=vec3.create();this.lookAt=this.currentLookAt;this.rotatedPosition=this.currentRotatedPosition;this.offset=vec3.create();this.position=vec3.create();this.rotation=vec3.create();this.viewport=vec4.create();this.frustum=new CCRenderer.Float32Array(CCCameraBase.frustum_max*4);this.frustumClip=new CCRenderer.Float32Array(16);this.perspective=60;this.cameraTouches=[];this.cameraTouches.push(new CCTouch);this.cameraTouches.push(new CCTouch);this.projectionResults=new CCCameraProjectionResults;this.visibleCollideables=[]};CCCameraBase.prototype.resize=function(){this.recalcViewport()};CCCameraBase.prototype.setupViewport=function(x,y,width,height){if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCCameraBase.setupViewport;"+this.cameraID+";"+x+";"+y+";"+width+";"+height+"\n"}this.viewportX=x;this.viewportY=y;this.viewportX2=x+width;this.viewportY2=y+height;this.viewportWidth=width;this.viewportHeight=height;this.invViewportWidth=1/this.viewportWidth;this.invViewportHeight=1/this.viewportHeight;var viewport=this.viewport;var renderer=gRenderer;{var temp;if(CCEngine.Orientation.target===270){temp=width;width=height;height=temp;temp=x;x=y;y=temp;x=1-width-x}else if(CCEngine.Orientation.target===90){temp=width;width=height;height=temp;temp=x;x=y;y=temp;y=1-height-y}}var invY=1-height-y;var frameBufferWidth=renderer.width;var frameBufferHeight=renderer.height;var definedWidth=width*frameBufferWidth;var definedHeight=height*frameBufferHeight;viewport[0]=x*frameBufferWidth;viewport[1]=invY*frameBufferHeight;viewport[2]=definedWidth;viewport[3]=definedHeight;this.orientedAspectRatio=this.actualAspectRatio=definedWidth/definedHeight;{if(!CCEngine.IsPortrait()){this.orientedAspectRatio=definedHeight/definedWidth}}this.setPerspective()};CCCameraBase.prototype.recalcViewport=function(){this.setupViewport(this.viewportX,this.viewportY,this.viewportWidth,this.viewportHeight)};CCCameraBase.prototype.setViewport=function(){var renderer=gRenderer;var viewport=this.viewport;renderer.GLViewport(viewport[0],viewport[1],viewport[2],viewport[3]);renderer.GLScissor(viewport[0],viewport[1],viewport[2],viewport[3])};CCCameraBase.prototype.setPerspective=function(perspective){if(perspective!==undefined){this.perspective=perspective}this.gluPerspective(this.perspective*this.viewportWidth,this.actualAspectRatio,1,4e4)};CCCameraBase.prototype.update=function(){CCCameraBase.currentCamera=this;var viewMatrix=this.viewMatrix;mat4.identity(this.viewMatrix);var currentRotatedPosition=this.currentRotatedPosition;var currentLookAt=this.currentLookAt;if(CCEngine.Orientation.current!==0){CC.MatrixRotateDegrees(viewMatrix,CCEngine.Orientation.current,0,0,1)}this.gluLookAt(currentRotatedPosition[0],currentRotatedPosition[1],currentRotatedPosition[2],currentLookAt[0],currentLookAt[1],currentLookAt[2],0,1,0);gRenderer.CCSetViewMatrix(this);this.ExtractFrustum();this.updateVisibleCollideables()};CCCameraBase.prototype.interpolateCamera=function(delta,speed){if(this.updating){gRenderer.pendingRender=true;this.updating=false;return true}return false};CCCameraBase.prototype.setLookAt=function(newLookAt){vec3.copy(this.lookAt,newLookAt)};CCCameraBase.prototype.setLookAtX=function(x){this.lookAt[0]=x;this.setLookAt(this.lookAt)};CCCameraBase.prototype.setLookAtY=function(y){this.lookAt[1]=y;this.setLookAt(this.lookAt)};CCCameraBase.prototype.setOffset=function(offsetTarget){this.updateOffset(offsetTarget)};CCCameraBase.prototype.updateOffset=function(offsetTarget){var lookAt=this.lookAt;var position=this.position;var rotatedPosition=this.rotatedPosition;var rotation=this.rotation;vec3.copy(this.offset,offsetTarget);vec3.copy(position,lookAt);vec3.add(position,position,this.offset);vec3.copy(rotatedPosition,position);CC.Vector3RotateAboutX(rotatedPosition,rotation[0],position,lookAt);CC.Vector3RotateAboutY(rotatedPosition,rotation[1],rotatedPosition,lookAt)};CCCameraBase.prototype.updateLookAtDirection=function(position,direction){var lookAt=this.lookAt;var rotatedPosition=this.rotatedPosition;var rotation=this.rotation;vec3.copy(rotatedPosition,position);vec3.copy(lookAt,rotatedPosition);lookAt[0]+=direction[2];CC.Vector3RotateAboutX(lookAt,rotation[0],lookAt,position);CC.Vector3RotateAboutY(lookAt,rotation[1],lookAt,position)};CCCameraBase.prototype.getRelativeTouches=function(screenTouches){var cameraTouches=this.cameraTouches;for(var i=0;i<screenTouches.length;++i){var screenTouch=screenTouches[i];var cameraTouch=cameraTouches[i];cameraTouch.state=screenTouch.state;cameraTouch.x=screenTouch.x;cameraTouch.y=screenTouch.y;cameraTouch.startX=screenTouch.startX;cameraTouch.startY=screenTouch.startY;cameraTouch.deltaX=screenTouch.deltaX;cameraTouch.deltaY=screenTouch.deltaY;cameraTouch.totalDeltaX=screenTouch.totalDeltaX;cameraTouch.totalDeltaY=screenTouch.totalDeltaY;cameraTouch.usingTouch=screenTouch.usingTouch;cameraTouch.timeHeld=screenTouch.timeHeld;cameraTouch.lastTimeReleased=screenTouch.lastTimeReleased;var viewportX=this.viewportX;var invViewportWidth=this.invViewportWidth;var viewportY=this.viewportY;var invViewportHeight=this.invViewportHeight;cameraTouch.startX-=viewportX;cameraTouch.startX*=invViewportWidth;cameraTouch.startY-=viewportY;cameraTouch.startY*=invViewportHeight;cameraTouch.x-=viewportX;cameraTouch.x*=invViewportWidth;cameraTouch.y-=viewportY;cameraTouch.y*=invViewportHeight;cameraTouch.deltaX*=invViewportWidth;cameraTouch.deltaY*=invViewportHeight;cameraTouch.totalDeltaX*=invViewportWidth;cameraTouch.totalDeltaY*=invViewportHeight;var screenLastDeltas=screenTouch.lastDeltas;var cameraLastDeltas=cameraTouch.lastDeltas;for(var deltaIndex=0;deltaIndex<screenLastDeltas.length;++deltaIndex){var screenLastDelta=screenLastDeltas[deltaIndex];var cameraLastDelta=cameraLastDeltas[deltaIndex];cameraLastDelta.time=screenLastDelta.time;cameraLastDelta.delta.x=screenLastDelta.delta.x*invViewportWidth;cameraLastDelta.delta.y=screenLastDelta.delta.y*invViewportHeight}}return cameraTouches};CCCameraBase.prototype.setRotationX=function(inRotation){this.rotation[0]=inRotation;this.updating=true};CCCameraBase.prototype.setRotationY=function(inRotation){this.rotation[1]=inRotation;this.updating=true};CCCameraBase.prototype.setRotationZ=function(inRotation){this.rotation[2]=inRotation;this.updating=true};CCCameraBase.prototype.incrementRotationX=function(increment){this.rotation[0]+=increment;this.setRotationX(this.rotation[0])};CCCameraBase.prototype.incrementRotationY=function(increment){this.rotation[1]+=increment;this.setRotationY(this.rotation[1])};CCCameraBase.prototype.incrementRotationZ=function(increment){this.rotation[2]+=increment;this.setRotationZ(this.rotation[2])};CCCameraBase.SetVisibleSortFunction=function(callback){CCCameraBase.VisibleSortFunction=callback};CCCameraBase.prototype.useSceneCollideables=function(scene){this.collideables=scene.collideables;if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCCameraBase.useSceneCollideables;"+this.cameraID+";"+scene.sceneID+"\n"}};CCCameraBase.prototype.updateVisibleCollideables=function(){if(this.collideables){CC.ScanVisibleCollideables(this.frustum,this.collideables,this.visibleCollideables)}else{CCOctree.ScanVisibleCollideables(this.frustum,this.visibleCollideables)}this.visibleCollideables.sort(CCCameraBase.VisibleSortFunction)};CCCameraBase.prototype.gluPerspective=function(fovy,aspect,zNear,zFar){var top=zNear*Math.tan(fovy*Math.PI/360);var right=top*aspect;var zNearScale=1/zNear;this.frustumWidth=right*2*zNearScale;this.frustumHeight=top*2*zNearScale;mat4.frustum(this.projectionMatrix,-right,right,-top,top,zNear,zFar);if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCCameraBase.gluPerspective;"+this.cameraID+";"+right+";"+top+";"+zNear+";"+zFar+"\n"}};CCCameraBase.prototype.project3D=function(x,y){CCEngine.ProjectOrientation(x,y,function(projectedX,projectedY){x=projectedX;y=projectedY});var viewport=this.viewport;y=1-y;x*=viewport[2];x+=viewport[0];y*=viewport[3];y+=viewport[1];var projectionResults=this.projectionResults;if(this.gluUnProject(x,y,0,projectionResults.vNear)&&this.gluUnProject(x,y,1,projectionResults.vFar)){vec3.copy(projectionResults.vDirection,projectionResults.vFar);vec3.subtract(projectionResults.vDirection,projectionResults.vDirection,projectionResults.vNear);vec3.unitize(projectionResults.vDirection);vec3.copy(projectionResults.vLookAt,projectionResults.vNear);var projectionOffset=vec3.create();vec3.scale(projectionOffset,projectionResults.vDirection,projectionResults.vNear[2]);vec3.add(projectionResults.vLookAt,projectionResults.vLookAt,projectionOffset);return true}return false};CCCameraBase.prototype.project3DY=function(result,x,y,offset){if(this.project3D(x,y)){var projectionResults=this.projectionResults;if(typeof offset!=="number"){offset=projectionResults.vNear[1]/Math.abs(projectionResults.vDirection[1])}vec3.scale(result,projectionResults.vDirection,offset);vec3.add(result,result,projectionResults.vNear)}};CCCameraBase.prototype.flagUpdate=function(){this.updating=true};CCCameraBase.prototype.gluLookAt=function(eyex,eyey,eyez,centerx,centery,centerz,upx,upy,upz){var x=vec3.create();var y=vec3.create();var z=vec3.create();z[0]=eyex-centerx;z[1]=eyey-centery;z[2]=eyez-centerz;var mag=Math.sqrt(z[0]*z[0]+z[1]*z[1]+z[2]*z[2]);if(mag){z[0]/=mag;z[1]/=mag;z[2]/=mag}y[0]=upx;y[1]=upy;y[2]=upz;x[0]=y[1]*z[2]-y[2]*z[1];x[1]=-y[0]*z[2]+y[2]*z[0];x[2]=y[0]*z[1]-y[1]*z[0];y[0]=z[1]*x[2]-z[2]*x[1];y[1]=-z[0]*x[2]+z[2]*x[0];y[2]=z[0]*x[1]-z[1]*x[0];mag=Math.sqrt(x[0]*x[0]+x[1]*x[1]+x[2]*x[2]);if(mag){x[0]/=mag;x[1]/=mag;x[2]/=mag}mag=Math.sqrt(y[0]*y[0]+y[1]*y[1]+y[2]*y[2]);if(mag){y[0]/=mag;y[1]/=mag;y[2]/=mag}var m=mat4.create();m[4*0+0]=x[0];m[4*1+0]=x[1];m[4*2+0]=x[2];m[4*3+0]=0;m[4*0+1]=y[0];m[4*1+1]=y[1];m[4*2+1]=y[2];m[4*3+1]=0;m[4*0+2]=z[0];m[4*1+2]=z[1];m[4*2+2]=z[2];m[4*3+2]=0;m[4*0+3]=0;m[4*1+3]=0;m[4*2+3]=0;m[4*3+3]=1;var viewMatrix=this.viewMatrix;CC.MatrixMultiply(viewMatrix,m,viewMatrix);var eyeVector=vec3.create();eyeVector[0]=-eyex;eyeVector[1]=-eyey;eyeVector[2]=-eyez;mat4.translate(viewMatrix,viewMatrix,eyeVector)};CCCameraBase.FinalMatrix=mat4.create();CCCameraBase.Input=vec4.create();CCCameraBase.Out=vec4.create();CCCameraBase.prototype.gluUnProject=function(winX,winY,winZ,resultVector){var finalMatrix=CCCameraBase.FinalMatrix;var input=CCCameraBase.Input;var out=CCCameraBase.Out;mat4.multiply(finalMatrix,this.projectionMatrix,this.viewMatrix);if(!mat4.invert(finalMatrix,finalMatrix)){return false}input[0]=winX;input[1]=winY;input[2]=winZ;input[3]=1;var viewport=this.viewport;input[0]=(input[0]-viewport[0])/viewport[2];input[1]=(input[1]-viewport[1])/viewport[3];input[0]=input[0]*2-1;input[1]=input[1]*2-1;input[2]=input[2]*2-1;mat4.multiplyVec4(finalMatrix,input,out);if(out[3]===0){return false}out[0]/=out[3];out[1]/=out[3];out[2]/=out[3];resultVector[0]=out[0];resultVector[1]=out[1];resultVector[2]=out[2];return true};CCCameraBase.prototype.ExtractFrustum=function(){var proj=this.projectionMatrix;var modv=this.viewMatrix;var clip=this.frustumClip;var t;var frustum=this.frustum;var frustum_right=CCCameraBase.frustum_right;var frustum_left=CCCameraBase.frustum_left;var frustum_bottom=CCCameraBase.frustum_bottom;var frustum_top=CCCameraBase.frustum_top;var frustum_far=CCCameraBase.frustum_far;var frustum_near=CCCameraBase.frustum_near;clip[0]=modv[0]*proj[0]+modv[1]*proj[4]+modv[2]*proj[8]+modv[3]*proj[12];clip[1]=modv[0]*proj[1]+modv[1]*proj[5]+modv[2]*proj[9]+modv[3]*proj[13];clip[2]=modv[0]*proj[2]+modv[1]*proj[6]+modv[2]*proj[10]+modv[3]*proj[14];clip[3]=modv[0]*proj[3]+modv[1]*proj[7]+modv[2]*proj[11]+modv[3]*proj[15];clip[4]=modv[4]*proj[0]+modv[5]*proj[4]+modv[6]*proj[8]+modv[7]*proj[12];clip[5]=modv[4]*proj[1]+modv[5]*proj[5]+modv[6]*proj[9]+modv[7]*proj[13];clip[6]=modv[4]*proj[2]+modv[5]*proj[6]+modv[6]*proj[10]+modv[7]*proj[14];clip[7]=modv[4]*proj[3]+modv[5]*proj[7]+modv[6]*proj[11]+modv[7]*proj[15];clip[8]=modv[8]*proj[0]+modv[9]*proj[4]+modv[10]*proj[8]+modv[11]*proj[12];clip[9]=modv[8]*proj[1]+modv[9]*proj[5]+modv[10]*proj[9]+modv[11]*proj[13];clip[10]=modv[8]*proj[2]+modv[9]*proj[6]+modv[10]*proj[10]+modv[11]*proj[14];clip[11]=modv[8]*proj[3]+modv[9]*proj[7]+modv[10]*proj[11]+modv[11]*proj[15];clip[12]=modv[12]*proj[0]+modv[13]*proj[4]+modv[14]*proj[8]+modv[15]*proj[12];clip[13]=modv[12]*proj[1]+modv[13]*proj[5]+modv[14]*proj[9]+modv[15]*proj[13];clip[14]=modv[12]*proj[2]+modv[13]*proj[6]+modv[14]*proj[10]+modv[15]*proj[14];clip[15]=modv[12]*proj[3]+modv[13]*proj[7]+modv[14]*proj[11]+modv[15]*proj[15];frustum[frustum_right+0]=clip[3]-clip[0];frustum[frustum_right+1]=clip[7]-clip[4];frustum[frustum_right+2]=clip[11]-clip[8];frustum[frustum_right+3]=clip[15]-clip[12];t=Math.sqrt(frustum[frustum_right+0]*frustum[frustum_right+0]+frustum[frustum_right+1]*frustum[frustum_right+1]+frustum[frustum_right+2]*frustum[frustum_right+2]);frustum[frustum_right+0]/=t;frustum[frustum_right+1]/=t;frustum[frustum_right+2]/=t;frustum[frustum_right+3]/=t;frustum[frustum_left+0]=clip[3]+clip[0];frustum[frustum_left+1]=clip[7]+clip[4];frustum[frustum_left+2]=clip[11]+clip[8];frustum[frustum_left+3]=clip[15]+clip[12];t=Math.sqrt(frustum[frustum_left+0]*frustum[frustum_left+0]+frustum[frustum_left+1]*frustum[frustum_left+1]+frustum[frustum_left+2]*frustum[frustum_left+2]);frustum[frustum_left+0]/=t;frustum[frustum_left+1]/=t;frustum[frustum_left+2]/=t;frustum[frustum_left+3]/=t;frustum[frustum_bottom+0]=clip[3]+clip[1];frustum[frustum_bottom+1]=clip[7]+clip[5];frustum[frustum_bottom+2]=clip[11]+clip[9];frustum[frustum_bottom+3]=clip[15]+clip[13];t=Math.sqrt(frustum[frustum_bottom+0]*frustum[frustum_bottom+0]+frustum[frustum_bottom+1]*frustum[frustum_bottom+1]+frustum[frustum_bottom+2]*frustum[frustum_bottom+2]);frustum[frustum_bottom+0]/=t;frustum[frustum_bottom+1]/=t;frustum[frustum_bottom+2]/=t;frustum[frustum_bottom+3]/=t;frustum[frustum_top+0]=clip[3]-clip[1];frustum[frustum_top+1]=clip[7]-clip[5];frustum[frustum_top+2]=clip[11]-clip[9];frustum[frustum_top+3]=clip[15]-clip[13];t=Math.sqrt(frustum[frustum_top+0]*frustum[frustum_top+0]+frustum[frustum_top+1]*frustum[frustum_top+1]+frustum[frustum_top+2]*frustum[frustum_top+2]);frustum[frustum_top+0]/=t;frustum[frustum_top+1]/=t;frustum[frustum_top+2]/=t;frustum[frustum_top+3]/=t;frustum[frustum_far+0]=clip[3]-clip[2];frustum[frustum_far+1]=clip[7]-clip[6];frustum[frustum_far+2]=clip[11]-clip[10];frustum[frustum_far+3]=clip[15]-clip[14];t=Math.sqrt(frustum[frustum_far+0]*frustum[frustum_far+0]+frustum[frustum_far+1]*frustum[frustum_far+1]+frustum[frustum_far+2]*frustum[frustum_far+2]);frustum[frustum_far+0]/=t;frustum[frustum_far+1]/=t;frustum[frustum_far+2]/=t;frustum[frustum_far+3]/=t;frustum[frustum_near+0]=clip[3]+clip[2];frustum[frustum_near+1]=clip[7]+clip[6];frustum[frustum_near+2]=clip[11]+clip[10];frustum[frustum_near+3]=clip[15]+clip[14];t=Math.sqrt(frustum[frustum_near+0]*frustum[frustum_near+0]+frustum[frustum_near+1]*frustum[frustum_near+1]+frustum[frustum_near+2]*frustum[frustum_near+2]);frustum[frustum_near+0]/=t;frustum[frustum_near+1]/=t;frustum[frustum_near+2]/=t;frustum[frustum_near+3]/=t};CCCameraBase.prototype.getAspectRatio=function(){return this.orientedAspectRatio};function CCCameraAppUI(){this.construct();this.targetWidth=1;this.targetHeight=1;this.targetOffset=vec3.create();this.targetLookAt=vec3.create();this.currentLookAtTarget=vec3.create();this.currentOffsetTarget=vec3.create();this.lookAtInterpolator=new CCInterpolatorV3(CCInterpolatorX3Curve).setup(this.lookAt);var offsetInterpolator=this.offsetInterpolator=new CCInterpolatorV3(CCInterpolatorSin2Curve).setup(this.offset);this.interpolating=true}ExtendPrototype(CCCameraAppUI,CCCameraBase);CCCameraAppUI.prototype.resize=function(){this.CCCameraBase_resize();if(this.targetWidth){this.setCameraWidth(this.targetWidth)}};CCCameraAppUI.prototype.setLookAt=function(newLookAt,interpolate){if(interpolate===undefined){interpolate=true}this.CCCameraBase_setLookAt(newLookAt);vec3.copy(this.currentLookAtTarget,this.lookAt);vec3.copy(this.targetLookAt,this.lookAt);this.lookAtInterpolator.setup(this.lookAt,this.currentLookAtTarget);if(!interpolate){vec3.copy(this.currentLookAtTarget,this.lookAt)}};CCCameraAppUI.prototype.setOffset=function(newOffset){this.CCCameraBase_setOffset(newOffset);vec3.copy(this.currentOffsetTarget,this.offset);vec3.copy(this.targetOffset,this.offset);this.offsetInterpolator.setup(this.offset,this.currentOffsetTarget)};CCCameraAppUI.prototype.interpolateCamera=function(delta,speed){if(this.updating){gRenderer.pendingRender=true;this.updating=false;if(this.interpolating){var offset=this.offset;{var offsetInterpolator=this.offsetInterpolator;var currentOffsetTarget=this.currentOffsetTarget;var targetOffset=this.targetOffset;if(!vec3.equals(currentOffsetTarget,targetOffset)){vec3.copy(currentOffsetTarget,targetOffset);offsetInterpolator.setup(offset,currentOffsetTarget)}if(offsetInterpolator.update(delta)){this.refreshCameraSize();this.updating=true}}{var lookAtInterpolator=this.lookAtInterpolator;var currentLookAtTarget=this.currentLookAtTarget;var targetLookAt=this.targetLookAt;var lookAt=this.lookAt;if(!vec3.equals(currentLookAtTarget,targetLookAt)){vec3.copy(currentLookAtTarget,targetLookAt);lookAtInterpolator.setup(lookAt,currentLookAtTarget)}if(lookAtInterpolator.update(delta*speed)){this.updating=true}}{this.updateOffset(offset)}}return true}return false};CCCameraAppUI.prototype.setCameraWidth=function(inWidth,interpolate){this.targetWidth=this.cameraWidth=inWidth;this.targetOffset[2]=inWidth;if(CCEngine.IsPortrait()){this.targetOffset[2]/=this.frustumWidth;this.cameraHeight=this.targetOffset[2]*this.frustumHeight}else{this.targetOffset[2]/=this.frustumHeight;this.cameraHeight=this.targetOffset[2]*this.frustumWidth}this.targetHeight=this.cameraHeight;this.cameraHWidth=this.cameraWidth*.5;this.cameraHHeight=this.cameraHeight*.5;this.flagUpdate();if(!interpolate){this.setOffset(this.targetOffset)}};CCCameraAppUI.prototype.setCameraHeight=function(inHeight,interpolate){this.targetHeight=this.cameraHeight=inHeight;this.targetOffset[2]=inHeight;if(CCEngine.IsPortrait()){this.targetOffset[2]/=this.frustumHeight;this.cameraWidth=this.targetOffset[2]*this.frustumWidth}else{this.targetOffset[2]/=this.frustumWidth;this.cameraWidth=this.targetOffset[2]*this.frustumHeight}this.targetWidth=this.cameraWidth;this.cameraHWidth=this.cameraWidth*.5;this.cameraHHeight=this.cameraHeight*.5;this.flagUpdate();if(!interpolate){this.setOffset(this.targetOffset)}};CCCameraAppUI.prototype.refreshCameraSize=function(){var currentOffset=this.offset;if(CCEngine.IsPortrait()){this.cameraWidth=currentOffset[2]*this.frustumWidth;this.cameraHeight=currentOffset[2]*this.frustumHeight}else{this.cameraWidth=currentOffset[2]*this.frustumHeight;this.cameraHeight=currentOffset[2]*this.frustumWidth}this.cameraHWidth=this.cameraWidth*.5;this.cameraHHeight=this.cameraHeight*.5};CCCameraAppUI.prototype.calcCameraOffsetForWidth=function(inWidth){var offsetZ=inWidth;if(CCEngine.IsPortrait()){offsetZ/=this.frustumWidth}else{offsetZ/=this.frustumHeight}return offsetZ};CCCameraAppUI.prototype.calcCameraOffsetForHeight=function(inHeight){var offsetZ=inHeight;if(CCEngine.IsPortrait()){offsetZ/=this.frustumHeight}else{offsetZ/=this.frustumWidth}return offsetZ};CCCameraAppUI.prototype.calcCameraWidthForOffset=function(inOffset){var width=inOffset;if(CCEngine.IsPortrait()){width*=this.frustumWidth}else{width*=this.frustumHeight}return width};CCCameraAppUI.prototype.calcCameraHeightForOffset=function(inOffset){var height=inOffset;if(CCEngine.IsPortrait()){height*=this.frustumHeight}else{height*=this.frustumWidth}return height};function CCCameraFPS(){this.construct();this.targetWidth=1;this.targetHeight=1}ExtendPrototype(CCCameraFPS,CCCameraBase);CCCameraFPS.prototype.update=function(){this.CCCameraBase_update()};function CCAPIFacebook(){}CCAPIFacebook.APP_ID="138263572915502";CCAPIFacebook.API_PERMISSIONS="user_photos,publish_stream,";CCAPIFacebook.API_URL="https://graph.facebook.com/";function CCFBCallback(callback,url,cacheFile){this.callback=callback;this.url=url;this.cacheFile=cacheFile}CCFBCallback.prototype.run=function(status,responseText){function Reply(){}var reply=new Reply;reply.data=responseText;reply.state=status;reply.url=this.url;if(!responseText||responseText.length===0){reply.state=CCURLRequest.Data_Error}else if(responseText.contains("OAuthException")){reply.state=CCURLRequest.Data_Error}else if(responseText==="false"){reply.state=CCURLRequest.Data_Error}if(reply.state===CCURLRequest.Succeeded){CC.SaveData(this.cacheFile,responseText)}else{var data=CC.LoadData(this.cacheFile);if(data!==undefined){reply.state=CCURLRequest.Failed_But_Used_Cache;reply.data=data}}this.callback.reply=reply;this.callback.run()};CCAPIFacebook.SetCacheFile=function(apiCall){apiCall.replace(".","/");return"facebook."+apiCall};CCAPIFacebook.Request=function(inCallback,apiCall,priority,refresh,timeout,limit,offset){if(refresh===undefined){refresh=false
}if(timeout===undefined){timeout=0}var url=CCAPIFacebook.API_URL;url+=apiCall;var cacheFile=CCAPIFacebook.SetCacheFile(apiCall);if(!CCAPIFacebook.m_userAccessToken){if(refresh){if(inCallback){inCallback.run()}return}var data=CC.LoadData(cacheFile);if(data===undefined){if(inCallback){inCallback.run()}return}}if(CCAPIFacebook.m_userAccessToken){url+="?access_token="+CCAPIFacebook.m_userAccessToken}if(limit){url+="&limit=";url+=limit}if(offset!==undefined){url+="&offset=";url+=offset}var proxyURL=url;if(MultiplayerManager.UseURLProxy(url)){proxyURL=SERVER_ROOT+"backend/helper.php?url="+url;proxyURL=url}gURLManager.requestURL(proxyURL,null,new CCFBCallback(inCallback,url,cacheFile))};CCAPIFacebook.RequestFBURL=function(inCallback,url,priority,refresh,timeout){if(!CCAPIFacebook.m_userAccessToken){}if(!refresh){refresh=false}if(!timeout){timeout=0}var cacheFile=String.SplitAfter(url,"facebook.com/");{cacheFile=String.RemoveBetweenIncluding(cacheFile,"access_token=","&");cacheFile=String.ReplaceChar(cacheFile,"/",".");cacheFile=String.ReplaceChar(cacheFile,"?",".");cacheFile=String.ReplaceChar(cacheFile,"&",".");cacheFile=String.ReplaceChar(cacheFile,"=",".")}var escapedURL=String.RemoveBetweenIncluding(url,"access_token=","&");escapedURL+="&access_token="+CCAPIFacebook.m_userAccessToken;gURLManager.requestURL(escapedURL,null,new CCFBCallback(inCallback,url).run,0,cacheFile,refresh?0:-1,timeout)};CCAPIFacebook.RequestPhotoID=function(fbInterface,photoID,priority){var url="http://softpoetry.com/backend/facebook.php?profilethumb="+photoID;if(CCAPIFacebook.m_userAccessToken){url+="&token="+CCAPIFacebook.m_userAccessToken}gEngine.textureManager.getTextureHandle(url,function(textureHandle){fbInterface.APIDownloadedPhoto(url,photoID)})};CCAPIFacebook.SetUserAccessToken=function(token){CCAPIFacebook.m_userAccessToken=token};CCAPIFacebook.GetUserAccessToken=function(){return CCAPIFacebook.m_userAccessToken};CCAPIFacebook.ClearCache=function(){delete CCAPIFacebook.m_userAccessToken;CC.DeleteData("facebook.me")};CCAPIFacebook.GetAuthorizationURL=function(){var authorizationURL="https://www.facebook.com/dialog/oauth";authorizationURL+="?client_id=";authorizationURL+=CCAPIFacebook.APP_ID;authorizationURL+="&redirect_uri=http://softpoetry.com/backend/facebook.php?domain="+SERVER_ROOT.getDomain()+"&";authorizationURL+="type=user_agent&";authorizationURL+="display=popup&";authorizationURL+="scope=";authorizationURL+=CCAPIFacebook.API_PERMISSIONS;return authorizationURL};CCAPIFacebook.StartLogin=function(callback){if(!CCAPIFacebook.m_onLoginResult){CCEngine.WebViewOpen(CCAPIFacebook.GetAuthorizationURL(),function(webViewController,opened){if(opened){CCAPIFacebook.m_onLoginResult=callback}},CCAPIFacebook.ProcessLogin,{width:480,height:480})}};CCAPIFacebook.ProcessLogin=function(webViewController,url,open){if(open){if(url.contains("connected.php")){var splitURL=url.split("#access_token");if(splitURL.length>1){var token=String.SplitBetween(url,"#access_token=","&");CCAPIFacebook.SetUserAccessToken(token)}CCAPIFacebook.FinishLogin();return}if(window.tizen){if(!url.contains("facebook.com/recover/initiate/")&&!url.contains("facebook.com/login/identify?")){var allowedURLs=["about:blank","login.php?","dialog/oauth","facebook.php","connected.php"];for(var i=0;i<allowedURLs.length;++i){if(url.contains(allowedURLs[i])){return}}}CCAPIFacebook.FinishLogin();AlertsManager.TimeoutAlert("only login function is available",15)}}else{CCAPIFacebook.FinishLogin()}};CCAPIFacebook.FinishLogin=function(){CCEngine.WebViewClose();if(CCAPIFacebook.m_onLoginResult){if(CCAPIFacebook.m_userAccessToken){gURLManager.setDomainTimeOut("facebook.com",1);CCAPIFacebook.m_onLoginResult();delete CCAPIFacebook.m_onLoginResult}else{delete CCAPIFacebook.m_onLoginResult}}};CCAPIFacebook.IsLoggingIn=function(){return!!CCAPIFacebook.m_onLoginResult};function CCAPIGoogle(){}CCAPIGoogle.User=undefined;CCAPIGoogle.RequestPhotoID=function(photoInterface,photoID,priority){var url="http://playir.com/google+/users/";url+=photoID;url+=".jpg";if(MultiplayerManager.UseURLProxy(url)){url=SERVER_ROOT+"backend/helper.php?url="+url}gEngine.textureManager.getTextureHandle(url,function(textureHandle){photoInterface.APIDownloadedPhoto(url,photoID)})};CCAPIGoogle.ClearCache=function(){delete CCAPIGoogle.User;CC.DeleteData("google.me")};CCAPIGoogle.StartLogin=function(callback){if(!CCAPIGoogle.m_onLoginResult){var url="http://playir.com/apis/google+/?auto";if(url.getDomain()!==SERVER_ROOT.getDomain()){url+="&redirect_uri="+SERVER_ROOT+"apis/google+/"}CCEngine.WebViewOpen(url,function(webViewController,opened){if(opened){CCAPIGoogle.m_onLoginResult=callback}},CCAPIGoogle.ProcessLogin,{width:480,height:480})}};CCAPIGoogle.ProcessLogin=function(webViewController,url,open){if(open){var i;var splitURL=url.split("?");if(splitURL.length>1){var parametersString=splitURL[1];var parametersSplit=parametersString.split("&");var id;var name;for(i=0;i<parametersSplit.length;++i){var parameters=parametersSplit[i];var parameterSplit=parameters.split("=");if(parameterSplit.length>1){var key=parameterSplit[0];var value=parameterSplit[1];if(key==="id"){id=value}else if(key==="name"){name=unescape(value)}}}if(id&&name){var username=splitURL[1].split("&");CCAPIGoogle.User={};CCAPIGoogle.User.id=id;CCAPIGoogle.User.name=name;CC.SaveData("google.me",JSON.stringify(CCAPIGoogle.User));CCAPIGoogle.FinishLogin(true);return}}}else{CCAPIGoogle.FinishLogin(false)}};CCAPIGoogle.FinishLogin=function(connected){CCEngine.WebViewClose();if(CCAPIGoogle.m_onLoginResult){if(connected){CCAPIGoogle.m_onLoginResult();delete CCAPIGoogle.m_onLoginResult}else{delete CCAPIGoogle.m_onLoginResult}}};CCAPIGoogle.IsLoggingIn=function(){return!!CCAPIGoogle.m_onLoginResult};function CCAPITwitter(){}CCAPITwitter.m_user=undefined;CCAPITwitter.RequestPhotoID=function(photoInterface,photoID,priority){var url="http://playir.com/apis/twitter/users/";url+=photoID;url+=".jpg";if(MultiplayerManager.UseURLProxy(url)){url=SERVER_ROOT+"backend/helper.php?url="+url}gEngine.textureManager.getTextureHandle(url,function(textureHandle){photoInterface.APIDownloadedPhoto(url,photoID)})};CCAPITwitter.ClearCache=function(){delete CCAPITwitter.m_user;CC.DeleteData("twitter.me")};CCAPITwitter.StartLogin=function(tweetSkippable,callback){if(!CCAPITwitter.m_onLoginResult){var url="http://playir.com/apis/twitter/?auto";if(tweetSkippable){url+="&tweetSkippable"}if(url.getDomain()!==WINDOW_DOMAIN){url+="&redirect_uri="+SERVER_ROOT+"/twitter/"}CCEngine.WebViewOpen(url,function(webViewController,opened){if(opened){CCAPITwitter.m_onLoginResult=callback}},CCAPITwitter.ProcessLogin,{width:480,height:480})}};CCAPITwitter.ProcessLogin=function(webViewController,url,open){if(open){var splitURL=url.split("/twitter/index.php?connected=");if(splitURL.length>1){var username=splitURL[1].split("&");CCAPITwitter.m_user=username[0];CC.SaveData("twitter.me",username[0]);CCAPITwitter.FinishLogin(true);return}}else{CCAPITwitter.FinishLogin(false)}};CCAPITwitter.FinishLogin=function(connected){CCEngine.WebViewClose();if(CCAPITwitter.m_onLoginResult){if(connected){CCAPITwitter.m_onLoginResult();delete CCAPITwitter.m_onLoginResult}else{delete CCAPITwitter.m_onLoginResult}}};CCAPITwitter.IsLoggingIn=function(){return!!CCAPITwitter.m_onLoginResult};function CCCollisionManager(octreeSize){this.octree=new CCOctree(null,vec3.create(),octreeSize);this.pruneOctreeTimer=0;this.collideables=[];this.pathFinderNetwork=new CCPathFinderNetwork}CCCollisionManager.prototype.addCollideable=function(collideable){this.collideables.add(collideable);CCOctree.AddObject(this.octree,collideable)};CCCollisionManager.prototype.removeCollideable=function(collideable){this.collideables.remove(collideable);CCOctree.RemoveObject(collideable)};CC.collision_none=0;CC.collision_box=1;CC.collision_static=2;CC.collision_moveable=4;CC.collision_character=8;CC.collision_ui=16;CC.UpdateCollisions=function(collideable,dependantOnFlags){if(dependantOnFlags===undefined){dependantOnFlags=true}if(collideable.updateCollisions&&(!dependantOnFlags||collideable.collideableType&CC.collision_box)){var aabbMin=collideable.aabbMin;var aabbMax=collideable.aabbMax;var position=collideable.position;var collisionBounds=collideable.collisionBounds;aabbMin[0]=position[0]-collisionBounds[0];aabbMin[1]=position[1]-collisionBounds[1];aabbMin[2]=position[2]-collisionBounds[2];aabbMax[0]=position[0]+collisionBounds[0];aabbMax[1]=position[1]+collisionBounds[1];aabbMax[2]=position[2]+collisionBounds[2];collideable.updateCollisions=false;if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CC.UpdateCollisions;"+collideable.jsID+";"+position[0]+","+position[1]+","+position[2]+";"+collisionBounds[0]+","+collisionBounds[1]+","+collisionBounds[2]+"\n"}}};CC.CalculateMinMaxVectors=function(min,max){var temp;for(var i=0;i<3;++i){if(min[i]>max[i]){temp=max[i];max[i]=min[i];min[i]=temp}}if(min[1]>max[1]){temp=max[1];max[1]=min[1];min[1]=temp}};CC.BasicBoxCollisionCheck=function(sourceMin,sourceMax,targetMin,targetMax){if(sourceMax[2]>=targetMin[2]&&sourceMin[2]<=targetMax[2]){if(sourceMax[0]>=targetMin[0]&&sourceMin[0]<=targetMax[0]){if(sourceMax[1]>=targetMin[1]&&sourceMin[1]<=targetMax[1]){return true}}}return false};CC.CollideableScan=function(min,max,sourceObject,flags,excludeInvisibles){if(flags===undefined){flags=CC.collision_box}var collideables=gEngine.collisionManager.collideables;var numberOfCollideables=collideables.length;var closestCollision=null;for(var i=0;i<numberOfCollideables;++i){var checkingObject=collideables[i];if(checkingObject!==sourceObject){if(CC.HasFlag(checkingObject.collideableType,CC.collision_ui)){continue}if(!checkingObject.shouldRender&&excludeInvisibles){continue}if(CC.HasFlag(checkingObject.collideableType,CC.collision_box)){if(flags===CC.collision_box||CC.HasFlag(checkingObject.collideableType,flags)){CC.UpdateCollisions(checkingObject);var targetMin=checkingObject.aabbMin;var targetMax=checkingObject.aabbMax;if(CC.BasicBoxCollisionCheck(min,max,targetMin,targetMax)){closestCollision=checkingObject;break}}}}}return closestCollision};CC.SourceMin=vec3.create();CC.SourceMax=vec3.create();CC.CollisionCheck=function(sourceObject,targetLocation,requestCollisions,flags){var collisionBounds=sourceObject.collisionBounds;var sourceMin=CC.SourceMin;vec3.copy(sourceMin,[targetLocation[0]-collisionBounds[0],targetLocation[1]-collisionBounds[1],targetLocation[2]-collisionBounds[2]]);var sourceMax=CC.SourceMax;vec3.copy(sourceMax,[targetLocation[0]+collisionBounds[0],targetLocation[1]+collisionBounds[1],targetLocation[2]+collisionBounds[2]]);var collideables=sourceObject.inScene.collideables;var numberOfCollideables=collideables.length;var closestCollision=null;var UpdateCollisionsFunction=CC.UpdateCollisions;var BasicBoxCollisionCheckFunction=CC.BasicBoxCollisionCheck;for(var i=0;i<numberOfCollideables;++i){var checkingObject=collideables[i];if(checkingObject!==sourceObject){if(checkingObject.collideableType&flags){UpdateCollisionsFunction(checkingObject);var targetMin=checkingObject.aabbMin;var targetMax=checkingObject.aabbMax;if(BasicBoxCollisionCheckFunction(sourceMin,sourceMax,targetMin,targetMax)){if(sourceObject.shouldCollide(checkingObject,true)){closestCollision=checkingObject;if(requestCollisions){closestCollision=sourceObject.requestCollisionWith(closestCollision)}if(closestCollision){return closestCollision}}}}}}return null};CC.LineIntersectionCheck=function(v1x1,v1y1,v1x2,v1y2,v2x1,v2y1,v2x2,v2y2){var d1,d2;var a1,a2,b1,b2,c1,c2;a1=v1y2-v1y1;b1=v1x1-v1x2;c1=v1x2*v1y1-v1x1*v1y2;d1=a1*v2x1+b1*v2y1+c1;d2=a1*v2x2+b1*v2y2+c1;if(d1>0&&d2>0){return false}if(d1<0&&d2<0){return false}a2=v2y2-v2y1;b2=v2x1-v2x2;c2=v2x2*v1y1-v2x1*v2y2;d1=a2*v1x1+b2*v1y1+c2;d2=a2*v1x2+b2*v1y2+c2;if(d1>0&&d2>0){return false}if(d1<0&&d2<0){return false}return true};CC.CollisionSourceX1=new Array(4);CC.CollisionSourceY1=new Array(4);CC.CollisionSourceX2=new Array(4);CC.CollisionSourceY2=new Array(4);CC.CollisionCheckingX=new Array(4);CC.CollisionCheckingY=new Array(4);CC.MovementLinesInsidePolygonCollisionCheck=function(startMin,startMax,targetMin,targetMax,checkingMin,checkingMax){var verts=4;var sourceX1=CC.CollisionSourceX1;var sourceY1=CC.CollisionSourceY1;var sourceX2=CC.CollisionSourceX2;var sourceY2=CC.CollisionSourceY2;sourceX1[0]=startMin[0];sourceY1[0]=startMin[2];sourceX2[0]=targetMin[0];sourceY2[0]=targetMin[2];sourceX1[1]=startMin[0];sourceY1[1]=startMax[2];sourceX2[1]=targetMin[0];sourceY2[1]=targetMax[2];sourceX1[2]=startMax[0];sourceY1[2]=startMax[2];sourceX2[2]=targetMax[0];sourceY2[2]=targetMax[2];sourceX1[3]=startMax[0];sourceY1[3]=startMin[2];sourceX2[3]=targetMax[0];sourceY2[3]=targetMin[2];var checkingX=CC.CollisionCheckingX;var checkingY=CC.CollisionCheckingY;checkingX[0]=checkingMin[0];checkingY[0]=checkingMin[2];checkingX[1]=checkingMin[0];checkingY[1]=checkingMax[2];checkingX[2]=checkingMax[0];checkingY[2]=checkingMax[2];checkingX[3]=checkingMax[0];checkingY[3]=checkingMin[2];var i,j,c;var v1x1,v1y1,v1x2,v1y2;var v2x1,v2y1,v2x2,v2y2;var CollisionCheckFunction=CC.LineIntersectionCheck;for(var sourceIndex=0;sourceIndex<verts;++sourceIndex){v1x1=sourceX1[sourceIndex];v1y1=sourceY1[sourceIndex];v1x2=sourceX2[sourceIndex];v1y2=sourceY2[sourceIndex];for(var checkingIndex=0;checkingIndex<verts;++checkingIndex){if(checkingIndex>0){v2x1=checkingX[checkingIndex-1];v2y1=checkingY[checkingIndex-1]}else{v2x1=checkingX[verts-1];v2y1=checkingY[verts-1]}v2x2=checkingX[checkingIndex];v2y2=checkingY[checkingIndex];if(CollisionCheckFunction(v1x1,v1y1,v1x2,v1y2,v2x1,v2y1,v2x2,v2y2)){return true}}}return false};CC.MovementCollisionsPending=[];CC.MovementCollisionsPendingNextID=0;CC.MovementCollisionCheckAsync=function(sourceObject,startPosition,targetPosition,flags,requestCollisions,callback){if(CCEngine.NativeUpdateCommands!==undefined){var command={};command.id=CC.MovementCollisionsPendingNextID++;command.sourceObject=sourceObject;command.flags=flags;command.requestCollisions=requestCollisions;command.callback=callback;CC.MovementCollisionsPending.push(command);CCEngine.NativeUpdateCommands+="CC.MovementCollisionCheckAsync;"+command.id+";"+sourceObject.jsID+";"+startPosition[0]+","+startPosition[1]+","+startPosition[2]+";"+targetPosition[0]+","+targetPosition[1]+","+targetPosition[2]+"\n"}else{var collidedWith=CC.MovementCollisionCheck(sourceObject,startPosition,targetPosition,flags,requestCollisions);callback(collidedWith)}};CC.MovementCollisionCheckResult=function(id,collisionIDs){var MovementCollisionsPending=CC.MovementCollisionsPending;for(var i=0;i<MovementCollisionsPending.length;++i){var command=MovementCollisionsPending[i];if(command.id==id){MovementCollisionsPending.remove(command);var sourceObject=command.sourceObject;var scene=sourceObject.inScene;if(scene){var flags=command.flags;var requestCollisions=command.requestCollisions;var callback=command.callback;var collideables=scene.collideables;var collideablesLength=collideables.length;var collisionIDsLength=collisionIDs.length;for(var collisionIDsIndex=0;collisionIDsIndex<collisionIDsLength;++collisionIDsIndex){var jsID=collisionIDs[collisionIDsIndex];for(var collideableIndex=0;collideableIndex<collideablesLength;++collideableIndex){var collideable=collideables[collideableIndex];if(collideable.jsID===jsID){if(collideable.collideableType&flags){if(sourceObject.shouldCollide(collideable,true)){var collidedWith=collideable;if(requestCollisions){collidedWith=sourceObject.requestCollisionWith(collidedWith)}if(collidedWith){callback(collidedWith);return}break}}}}}callback(null)}break}}};CC.MovementAreaMin=vec3.create();CC.MovementAreaMax=vec3.create();CC.MovementStartMin=vec3.create();CC.MovementStartMax=vec3.create();CC.MovementTargetMin=vec3.create();CC.MovementTargetMax=vec3.create();CC.MovementAreaCollideables=[];CC.MovementCollisionCheck=function(sourceObject,startPosition,targetPosition,flags,requestCollisions){var areaMin=CC.MovementAreaMin;var areaMax=CC.MovementAreaMax;var startMin=CC.MovementStartMin;var startMax=CC.MovementStartMax;var targetMin=CC.MovementTargetMin;var targetMax=CC.MovementTargetMax;var collisionBounds=sourceObject.collisionBounds;startMin[0]=startPosition[0]-collisionBounds[0];startMax[0]=startPosition[0]+collisionBounds[0];startMin[1]=startPosition[1]-collisionBounds[1];startMax[1]=startPosition[1]+collisionBounds[1];startMin[2]=startPosition[2]-collisionBounds[2];startMax[2]=startPosition[2]+collisionBounds[2];targetMin[0]=targetPosition[0]-collisionBounds[0];targetMax[0]=targetPosition[0]+collisionBounds[0];targetMin[1]=targetPosition[1]-collisionBounds[1];targetMax[1]=targetPosition[1]+collisionBounds[1];targetMin[2]=targetPosition[2]-collisionBounds[2];targetMax[2]=targetPosition[2]+collisionBounds[2];areaMin[0]=startMin[0]<targetMin[0]?startMin[0]:targetMin[0];areaMin[1]=startMin[1];areaMin[2]=startMin[2]<targetMin[2]?startMin[2]:targetMin[2];areaMax[0]=startMax[0]>targetMax[0]?startMax[0]:targetMax[0];areaMax[1]=targetMax[1];areaMax[2]=startMax[2]>targetMax[2]?startMax[2]:targetMax[2];var collideables=sourceObject.inScene.collideables;var numberOfCollideables=collideables.length;var UpdateCollisionsFunction=CC.UpdateCollisions;var BoxCollisionCheckFunction=CC.BasicBoxCollisionCheck;var areaCollideables=CC.MovementAreaCollideables;areaCollideables.length=0;var i,checkingObject,checkingMin,checkingMax;for(i=0;i<numberOfCollideables;++i){checkingObject=collideables[i];if(checkingObject!==sourceObject){if(checkingObject.collideableType&flags){if(checkingObject.owner!=sourceObject&&sourceObject.owner!=checkingObject){UpdateCollisionsFunction(checkingObject);checkingMin=checkingObject.aabbMin;checkingMax=checkingObject.aabbMax;if(BoxCollisionCheckFunction(areaMin,areaMax,checkingMin,checkingMax)){areaCollideables.push(checkingObject)}}}}}numberOfCollideables=areaCollideables.length;if(numberOfCollideables>0){var sourceMin=startMin;var sourceMax=startMax;var collidedWith=null;var velocityX=targetPosition[0]-startPosition[0];var velocityZ=targetPosition[2]-startPosition[2];var inverseBounds=sourceObject.inverseCollisionSize.width+1;var velocityVsBoundingX=velocityX*inverseBounds;var velocityVsBoundingZ=velocityZ*inverseBounds;var absVelocityVsBoundingX=Math.abs(velocityVsBoundingX);var absVelocityVsBoundingZ=Math.abs(velocityVsBoundingZ);if(absVelocityVsBoundingX>1||absVelocityVsBoundingZ>1){var furthestIncrement=absVelocityVsBoundingX>absVelocityVsBoundingZ?absVelocityVsBoundingX:absVelocityVsBoundingZ;var numberOfIncrements=Math.round(furthestIncrement+.5);var inverseNumberOfIncrements=1/numberOfIncrements;var incrementsX=velocityX*inverseNumberOfIncrements;var incrementsZ=velocityZ*inverseNumberOfIncrements;var incrementIndex=0;do{sourceMin[0]+=incrementsX;sourceMin[2]+=incrementsZ;sourceMax[0]+=incrementsX;sourceMax[2]+=incrementsZ;for(i=0;i<numberOfCollideables;++i){checkingObject=areaCollideables[i];checkingMin=checkingObject.aabbMin;checkingMax=checkingObject.aabbMax;if(BoxCollisionCheckFunction(sourceMin,sourceMax,checkingMin,checkingMax)){if(sourceObject.shouldCollide(checkingObject,true)){collidedWith=checkingObject;if(requestCollisions){collidedWith=sourceObject.requestCollisionWith(collidedWith)}if(collidedWith){return collidedWith}}}}++incrementIndex}while(incrementIndex<numberOfIncrements&&!collidedWith)}else{sourceMin[0]+=velocityX;sourceMin[2]+=velocityZ;sourceMax[0]+=velocityX;sourceMax[2]+=velocityZ;for(i=0;i<numberOfCollideables;++i){checkingObject=areaCollideables[i];checkingMin=checkingObject.aabbMin;checkingMax=checkingObject.aabbMax;if(BoxCollisionCheckFunction(sourceMin,sourceMax,checkingMin,checkingMax)){if(sourceObject.shouldCollide(checkingObject,true)){collidedWith=checkingObject;if(requestCollisions){collidedWith=sourceObject.requestCollisionWith(collidedWith)}if(collidedWith){return collidedWith}}}}}}return null};CC.MovementCollisionReCheckAreaCollideables=function(sourceObject,startPosition,targetPosition,flags,requestCollisions){var areaMin=CC.MovementAreaMin;var areaMax=CC.MovementAreaMax;var startMin=CC.MovementStartMin;var startMax=CC.MovementStartMax;var targetMin=CC.MovementTargetMin;var targetMax=CC.MovementTargetMax;var collisionBounds=sourceObject.collisionBounds;startMin[0]=startPosition[0]-collisionBounds[0];startMax[0]=startPosition[0]+collisionBounds[0];startMin[1]=startPosition[1]-collisionBounds[1];startMax[1]=startPosition[1]+collisionBounds[1];startMin[2]=startPosition[2]-collisionBounds[2];startMax[2]=startPosition[2]+collisionBounds[2];var i,checkingObject,checkingMin,checkingMax;var BoxCollisionCheckFunction=CC.BasicBoxCollisionCheck;var areaCollideables=CC.MovementAreaCollideables;numberOfCollideables=areaCollideables.length;if(numberOfCollideables>0){var sourceMin=startMin;var sourceMax=startMax;var collidedWith=null;var velocityX=targetPosition[0]-startPosition[0];var velocityZ=targetPosition[2]-startPosition[2];var inverseBounds=sourceObject.inverseCollisionSize.width+1;var velocityVsBoundingX=velocityX*inverseBounds;var velocityVsBoundingZ=velocityZ*inverseBounds;var absVelocityVsBoundingX=Math.abs(velocityVsBoundingX);var absVelocityVsBoundingZ=Math.abs(velocityVsBoundingZ);if(absVelocityVsBoundingX>1||absVelocityVsBoundingZ>1){var furthestIncrement=absVelocityVsBoundingX>absVelocityVsBoundingZ?absVelocityVsBoundingX:absVelocityVsBoundingZ;var numberOfIncrements=Math.round(furthestIncrement+.5);var inverseNumberOfIncrements=1/numberOfIncrements;var incrementsX=velocityX*inverseNumberOfIncrements;var incrementsZ=velocityZ*inverseNumberOfIncrements;var incrementIndex=0;do{sourceMin[0]+=incrementsX;sourceMin[2]+=incrementsZ;sourceMax[0]+=incrementsX;sourceMax[2]+=incrementsZ;for(i=0;i<numberOfCollideables;++i){checkingObject=areaCollideables[i];checkingMin=checkingObject.aabbMin;checkingMax=checkingObject.aabbMax;if(BoxCollisionCheckFunction(sourceMin,sourceMax,checkingMin,checkingMax)){if(sourceObject.shouldCollide(checkingObject,true)){collidedWith=checkingObject;if(requestCollisions){collidedWith=sourceObject.requestCollisionWith(collidedWith)}if(collidedWith){return collidedWith}}}}++incrementIndex}while(incrementIndex<numberOfIncrements&&!collidedWith)}else{sourceMin[0]+=velocityX;sourceMin[2]+=velocityZ;sourceMax[0]+=velocityX;sourceMax[2]+=velocityZ;for(i=0;i<numberOfCollideables;++i){checkingObject=areaCollideables[i];checkingMin=checkingObject.aabbMin;checkingMax=checkingObject.aabbMax;if(BoxCollisionCheckFunction(sourceMin,sourceMax,checkingMin,checkingMax)){if(sourceObject.shouldCollide(checkingObject,true)){collidedWith=checkingObject;if(requestCollisions){collidedWith=sourceObject.requestCollisionWith(collidedWith)}if(collidedWith){return collidedWith}}}}}}return null};CC.LineCheckGetIntersection=function(dist1,dist2,vec3Point1,vec3Point2,vec3HitLocation){if(dist1*dist2>=0){return false}if(dist1===dist2){return false}vec3.copy(vec3HitLocation,vec3Point2);vec3.subtract(vec3HitLocation,vec3HitLocation,vec3Point1);vec3.scale(vec3HitLocation,vec3HitLocation,-dist1/(dist2-dist1));vec3.add(vec3HitLocation,vec3HitLocation,vec3Point1);return true};CC.LineCheckInBox=function(hit,boxMin,boxMax,axis){if(axis===1&&hit[2]>=boxMin[2]&&hit[2]<boxMax[2]&&hit[1]>=boxMin[1]&&hit[1]<boxMax[1]){return true}if(axis===2&&hit[2]>=boxMin[2]&&hit[2]<boxMax[2]&&hit[0]>boxMin[0]&&hit[0]<boxMax[0]){return true}if(axis===3&&hit[0]>=boxMin[0]&&hit[0]<boxMax[0]&&hit[1]>=boxMin[1]&&hit[1]<boxMax[1]){return true}return false};CC.LineCheckBox=function(start,end,boxMin,boxMax,hitLocation){if(end[0]<boxMin[0]&&start[0]<boxMin[0]){return false}if(end[0]>boxMax[0]&&start[0]>boxMax[0]){return false}if(end[1]<boxMin[1]&&start[1]<boxMin[1]){return false}if(end[1]>boxMax[1]&&start[1]>boxMax[1]){return false}if(end[2]<boxMin[2]&&start[2]<boxMin[2]){return false}if(end[2]>boxMax[2]&&start[2]>boxMax[2]){return false}if(start[0]>boxMin[0]&&start[0]<boxMax[0]&&start[1]>boxMin[1]&&start[1]<boxMax[1]&&start[2]>boxMin[2]&&start[2]<boxMax[2]){vec3.copy(hitLocation,start);return true}var i;var hits=new Array(6);for(i=0;i<6;++i){hits[i]=vec3.create()}var hitResult=new Array(6);var lineCheckGetIntersection=CC.LineCheckGetIntersection;var lineCheckInBox=CC.LineCheckInBox;hitResult[0]=lineCheckGetIntersection(start[0]-boxMin[0],end[0]-boxMin[0],start,end,hits[0])&&lineCheckInBox(hits[0],boxMin,boxMax,1);hitResult[1]=lineCheckGetIntersection(start[1]-boxMin[1],end[1]-boxMin[1],start,end,hits[1])&&lineCheckInBox(hits[1],boxMin,boxMax,2);hitResult[2]=lineCheckGetIntersection(start[2]-boxMin[2],end[2]-boxMin[2],start,end,hits[2])&&lineCheckInBox(hits[2],boxMin,boxMax,3);hitResult[3]=lineCheckGetIntersection(start[0]-boxMax[0],end[0]-boxMax[0],start,end,hits[3])&&lineCheckInBox(hits[3],boxMin,boxMax,1);hitResult[4]=lineCheckGetIntersection(start[1]-boxMax[1],end[1]-boxMax[1],start,end,hits[4])&&lineCheckInBox(hits[4],boxMin,boxMax,2);hitResult[5]=lineCheckGetIntersection(start[2]-boxMax[2],end[2]-boxMax[2],start,end,hits[5])&&lineCheckInBox(hits[5],boxMin,boxMax,3);var distance=vec3.create();var hitDistance=false;for(i=0;i<6;++i){if(hitResult[i]){vec3.subtract(distance,start,hits[i]);var currentHitDistance=vec3.squaredLength(distance);if(!hitDistance||currentHitDistance<hitDistance){hitDistance=currentHitDistance;vec3.copy(hitLocation,hits[i]);hit=true}}}return hitDistance};CC.BasicLineCollisionCheck=function(list,start,end,hitPosition,collideInsideObjects,flags,ignoreObjects,stopAtAnyCollision,excludeInvisibles){var hitDistance=CC_MAXFLOAT;var hitObject=null;var checkingHitPosition=vec3.create();var length=list.length;for(var i=0;i<length;++i){var checkingObject=list[i];if(ignoreObjects&&ignoreObjects.find(checkingObject)!==-1){continue}if(checkingObject.isActive()&&checkingObject.isCollideable()&&CC.HasFlag(checkingObject.collideableType,flags)){if(!checkingObject.shouldRender&&excludeInvisibles){continue}CC.UpdateCollisions(checkingObject);var targetMin=checkingObject.aabbMin;var targetMax=checkingObject.aabbMax;var checkingHitDistance=CC.LineCheckBox(start,end,targetMin,targetMax,checkingHitPosition);if(checkingHitDistance!==false){if(checkingHitDistance<hitDistance&&(collideInsideObjects||checkingHitDistance>0)){hitDistance=checkingHitDistance;hitObject=checkingObject;if(hitPosition){vec3.copy(hitPosition,checkingHitPosition)}if(stopAtAnyCollision){return hitObject}}}}}return hitObject};CC.CubeInFrustum=function(frustum,min,max){var c;var c2=0;var end=CCCameraBase.frustum_max;for(var i=0;i<end;i+=4){var minX=frustum[i+0]*min[0];var minY=frustum[i+1]*min[1];var minZ=frustum[i+2]*min[2];var maxX=frustum[i+0]*max[0];var maxY=frustum[i+1]*max[1];var maxZ=frustum[i+2]*max[2];c=0;var frustumW=frustum[i+3];if(minX+minY+minZ+frustumW>0){c++}if(maxX+minY+minZ+frustumW>0){c++}if(minX+maxY+minZ+frustumW>0){c++}if(maxX+maxY+minZ+frustumW>0){c++}if(minX+minY+maxZ+frustumW>0){c++}if(maxX+minY+maxZ+frustumW>0){c++}if(minX+maxY+maxZ+frustumW>0){c++}if(maxX+maxY+maxZ+frustumW>0){c++}if(c===0){return 0}else if(c===8){c2++}}return c2===6?2:1};var CC_SMALLFLOAT=.01;var CC_MAXFLOAT=1e9;var CC_PI=Math.PI;var CC_HPI=CC_PI*.5;CC.DEGREES_TO_RADIANS=function(angle){return CC_PI*angle/180};CC.RADIANS_TO_DEGREES=function(angle){return 180*angle/CC_PI};CC.SQUARE=function(value){return value*value};CC.Random=function(amount){if(!amount){amount=1e5}var random=Math.random();var randomInt=Math.round(random*amount);return randomInt};CC.RandomDualInt=function(){return CC.Random(1)*2-1};CC.FloatRandom=function(){var random=Math.random();return random};CC.FloatRandomDualSided=function(){return(CC.FloatRandom()-.5)*2};CC.FloatClamp=function(value,min,max){value=Math.min(max,value);value=Math.max(min,value);return value};CC.FloatLimitPrecision=function(value,precision){if(!precision){precision=2}return value.toFixed?Number(value.toFixed(precision)):value};CC.ToTarget=function(current,target,speed){if(current<target){current+=speed;if(current>target){current=target}}else{current-=speed;if(current<target){current=target}}return current};CC.ToRotation=function(current,target,amount){var incrementRotation=target-current;incrementRotation=CC.ClampRotation(incrementRotation);var decrementRotation=current-target;decrementRotation=CC.ClampRotation(decrementRotation);if(decrementRotation<incrementRotation){if(target>current){target-=360}current-=amount;current=current<target?target:current}else if(decrementRotation>incrementRotation){if(target<current){target+=360}current+=amount;current=current>target?target:current}else{if(target>current){if(target>current){target-=360}current-=amount;current=current<target?target:current}else{if(target<current){target+=360}current+=amount;current=current>target?target:current}}current=CC.ClampRotation(current);return current};CC.Distance=function(first,second){return Math.abs(first-second)};CC.DistanceBetweenAngles=function(first,second){var distance1=first-second;var distance2=second-first;distance1=CC.ClampRotation(distance1);distance2=CC.ClampRotation(distance2);return distance1<distance2?distance1:distance2};CC.ClampRotation=function(rotation){while(rotation>=360){rotation-=360}while(rotation<0){rotation+=360}return rotation};CC.Vector3RotateAboutX=function(rotatedPosition,rotation,from,about){var y=from[1]-about[1];var z=from[2]-about[2];var rotationInRadians=CC.DEGREES_TO_RADIANS(rotation);var cosAngle=Math.cos(rotationInRadians);var sinAngle=Math.sin(rotationInRadians);rotatedPosition[1]=y*cosAngle-z*sinAngle;rotatedPosition[2]=y*sinAngle+z*cosAngle;rotatedPosition[1]+=about[1];rotatedPosition[2]+=about[2]};CC.Vector3RotateY=function(rotatedPosition,rotation){var x=rotatedPosition[0];var z=rotatedPosition[2];var rotationInRadians=CC.DEGREES_TO_RADIANS(rotation);var cosAngle=Math.cos(rotationInRadians);var sinAngle=Math.sin(rotationInRadians);rotatedPosition[0]=x*cosAngle+z*sinAngle;rotatedPosition[2]=-(x*sinAngle)+z*cosAngle};CC.Vector3RotateAboutY=function(rotatedPosition,rotation,from,about){var x=from[0]-about[0];var z=from[2]-about[2];var rotationInRadians=CC.DEGREES_TO_RADIANS(rotation);var cosAngle=Math.cos(rotationInRadians);var sinAngle=Math.sin(rotationInRadians);rotatedPosition[0]=x*cosAngle+z*sinAngle;rotatedPosition[2]=-(x*sinAngle)+z*cosAngle;rotatedPosition[0]+=about[0];rotatedPosition[2]+=about[2]};CC.RotateXAboutY=function(x,z,cosAngle,sinAngle){return x*cosAngle+z*sinAngle};CC.RotateZAboutY=function(x,z,cosAngle,sinAngle){return-(x*sinAngle)+z*cosAngle};CC.RotatePoint=function(point,rotation){var x=point.x;var y=point.y;var rotationInRadians=CC.DEGREES_TO_RADIANS(rotation);var cosAngle=Math.cos(rotationInRadians);var sinAngle=Math.sin(rotationInRadians);point.x=x*cosAngle+y*sinAngle;point.y=-(x*sinAngle)+y*cosAngle};CC.AngleTowards=function(fromX,fromZ,toX,toZ){var y=fromX-toX;var x=fromZ-toZ;var angle=CC.RADIANS_TO_DEGREES(Math.atan2(y,x));angle=CC.ClampRotation(angle);return angle};CC.AngleTowardsVector=function(from,to){return CC.AngleTowards(from[0],from[2],to[0],to[2])};CC.Vector3Magnitude=function(vector,squared){if(squared===undefined){squared=true}if(squared){return vec3.squaredLength(vector)}return vec3.length(vector)};CC.Vector3Distance=function(from,to,squared){if(squared===undefined){squared=true}var difference=vec3.create(to);vec3.subtract(difference,difference,from);vec3.scale(difference,difference,.5);return CC.Vector3Magnitude(difference,squared)};CC.Vector3Distance2D=function(from,to,squared){if(squared===undefined){squared=true}var differenceX=from[0]-to[0];var differenceZ=from[2]-to[2];var result=differenceX*differenceX+differenceZ*differenceZ;return squared?result:Math.sqrt(result)};CC.Vector3Direction=function(start,end){var result=vec3.create();result[0]=end[0]-start[0];result[1]=end[1]-start[1];result[2]=end[2]-start[2];vec3.normalize(result,result);return result};CC.tmpMatrix=mat4.create();CC.MatrixMultiply=function(result,srcA,srcB){var tmp=CC.tmpMatrix;for(var i=0;i<16;i+=4){tmp[i+0]=srcA[i+0]*srcB[0]+srcA[i+1]*srcB[4+0]+srcA[i+2]*srcB[8+0]+srcA[i+3]*srcB[12+0];tmp[i+1]=srcA[i+0]*srcB[1]+srcA[i+1]*srcB[4+1]+srcA[i+2]*srcB[8+1]+srcA[i+3]*srcB[12+1];
tmp[i+2]=srcA[i+0]*srcB[2]+srcA[i+1]*srcB[4+2]+srcA[i+2]*srcB[8+2]+srcA[i+3]*srcB[12+2];tmp[i+3]=srcA[i+0]*srcB[3]+srcA[i+1]*srcB[4+3]+srcA[i+2]*srcB[8+3]+srcA[i+3]*srcB[12+3]}mat4.copy(result,tmp)};CC.MatrixRotateDegrees=function(result,angle,x,y,z){angle=-angle;var mag=Math.sqrt(x*x+y*y+z*z);var sinAngle=Math.sin(angle*CC_PI/180);var cosAngle=Math.cos(angle*CC_PI/180);if(mag>0){var xx,yy,zz,xy,yz,zx,xs,ys,zs;var rotMat=mat4.create();x/=mag;y/=mag;z/=mag;xx=x*x;yy=y*y;zz=z*z;xy=x*y;yz=y*z;zx=z*x;xs=x*sinAngle;ys=y*sinAngle;zs=z*sinAngle;var oneMinusCos=1-cosAngle;rotMat[0*4+0]=oneMinusCos*xx+cosAngle;rotMat[0*4+1]=oneMinusCos*xy-zs;rotMat[0*4+2]=oneMinusCos*zx+ys;rotMat[0*4+3]=0;rotMat[1*4+0]=oneMinusCos*xy+zs;rotMat[1*4+1]=oneMinusCos*yy+cosAngle;rotMat[1*4+2]=oneMinusCos*yz-xs;rotMat[1*4+3]=0;rotMat[2*4+0]=oneMinusCos*zx-ys;rotMat[2*4+1]=oneMinusCos*yz+xs;rotMat[2*4+2]=oneMinusCos*zz+cosAngle;rotMat[2*4+3]=0;rotMat[3*4+0]=0;rotMat[3*4+1]=0;rotMat[3*4+2]=0;rotMat[3*4+3]=1;CC.MatrixMultiply(result,rotMat,result)}};CC.CollideablesInFrustum=function(frustum,collideables,visibleCollideables){var CubeInFrustum=CC.CubeInFrustum;var length=collideables.length;for(var i=0;i<length;++i){var object=collideables[i];if(!object.deletingObjectCountdown&&object.shouldRender){if(CubeInFrustum(frustum,object.aabbMin,object.aabbMax)){visibleCollideables.push(object);object.visible=true}}}};CC.ScanVisibleCollideables=function(frustum,collideables,visibleCollideables){visibleCollideables.length=0;CC.CollideablesInFrustum(frustum,collideables,visibleCollideables)};CC.RenderVisibleObjects=function(camera,pass,alpha){var visibleCollideables=camera.visibleCollideables;var length=visibleCollideables.length;for(var i=0;i<length;++i){var object=visibleCollideables[i];if(object&&object.renderPass===pass){var scene=object.inScene;if(scene){scene.renderVisibleObject(object,camera,pass,alpha)}else{}}}};function CCOctree(){}CCOctree.MAX_TREE_OBJECTS=64;CCOctree.leaf_bottom_front_left=0;CCOctree.leaf_bottom_front_right=1;CCOctree.leaf_bottom_back_left=2;CCOctree.leaf_bottom_back_right=3;CCOctree.leaf_top_front_left=4;CCOctree.leaf_top_front_right=5;CCOctree.leaf_top_back_left=6;CCOctree.leaf_top_back_right=7;function CCOctree(inParent,position,size){this.parent=inParent;this.leafs=null;this.objects=[];this.hSize=size*.5;this.min=vec3.clone(position);this.max=vec3.clone(position);vec3.addValue(this.min,-this.hSize);vec3.addValue(this.max,this.hSize)}CCOctree.DeleteLeafs=function(tree){if(tree.leafs){for(var i=0;i<8;++i){if(tree.leafs[i]){var leaf=tree.leafs[i];CCOctree.DeleteLeafs(leaf)}}delete tree.leafs}};CCOctree.SplitTopLeafs=function(tree,index,position){position=vec3.clone(position);position[1]+=tree.hSize;var leaf=new CCOctree(tree,position,tree.hSize);tree.leafs[index+4]=leaf};CCOctree.Split=function(tree){tree.leafs=[];var index=CCOctree.leaf_bottom_front_left;var position=vec3.clone(tree.min);vec3.addValue(position,tree.hSize*.5);var leaf=new CCOctree(tree,position,tree.hSize);tree.leafs[index]=leaf;CCOctree.SplitTopLeafs(tree,index,position);index=CCOctree.leaf_bottom_front_right;position[0]+=tree.hSize;leaf=new CCOctree(tree,position,tree.hSize);tree.leafs[index]=leaf;CCOctree.SplitTopLeafs(tree,index,position);index=CCOctree.leaf_bottom_back_right;position[2]+=tree.hSize;leaf=new CCOctree(tree,position,tree.hSize);tree.leafs[index]=leaf;CCOctree.SplitTopLeafs(tree,index,position);index=CCOctree.leaf_bottom_back_left;position[0]-=tree.hSize;leaf=new CCOctree(tree,position,tree.hSize);tree.leafs[index]=leaf;CCOctree.SplitTopLeafs(tree,index,position);var objects=tree.objects;while(objects.length>0){collideable=tree.objects[0];CCOctree.RemoveObjectsOctree(tree,collideable);CC.UpdateCollisions(collideable);for(var i=0;i<8;++i){leaf=tree.leafs[i];if(CCOctree.IsInLeaf(leaf,collideable.aabbMin,collideable.aabbMax)){CCOctree.AddObject(leaf,collideable)}}}};CCOctree.AddObject=function(tree,collideable){if(!tree.parent){CC.UpdateCollisions(collideable,false);var objectMin=collideable.aabbMin;var objectMax=collideable.aabbMax;if(objectMax[0]<tree.min[0]){tree.objects.push(collideable);collideable.octrees.push(tree);return}if(objectMax[1]<tree.min[1]){tree.objects.push(collideable);collideable.octrees.push(tree);return}if(objectMax[2]<tree.min[2]){tree.objects.push(collideable);collideable.octrees.push(tree);return}if(objectMin[0]>tree.max[0]){tree.objects.push(collideable);collideable.octrees.push(tree);return}if(objectMin[1]>tree.max[1]){tree.objects.push(collideable);collideable.octrees.push(tree);return}if(objectMin[2]>tree.max[2]){tree.objects.push(collideable);collideable.octrees.push(tree);return}}if(tree.leafs){CCOctree.RemoveObjectsOctree(tree,collideable);for(var i=0;i<8;++i){var leaf=tree.leafs[i];if(CCOctree.IsInLeaf(leaf,collideable.aabbMin,collideable.aabbMax)){CCOctree.AddObject(leaf,collideable)}}}else if(tree.objects.length<CCOctree.MAX_TREE_OBJECTS){tree.objects.push(collideable);collideable.octrees.push(tree)}else if(tree.hSize<100){tree.objects.push(collideable);collideable.octrees.push(tree)}else{CCOctree.Split(tree);CCOctree.AddObject(tree,collideable)}};CCOctree.RemoveObjectsOctree=function(tree,collideable){tree.objects.remove(collideable);collideable.octrees.remove(tree)};CCOctree.RemoveObject=function(collideable){var octrees=collideable.octrees;while(octrees.length>0){var tree=octrees[0];CCOctree.RemoveObjectsOctree(tree,collideable);if(tree.objects.length===0){if(gEngine.collisionManager.pruneTreesTimer<=0){gEngine.collisionManager.pruneTreesTimer=.5}}}};CCOctree.RefreshObject=function(object){CCOctree.RemoveObject(object);if(!object.deletingObjectCountdown&&object.shouldRender){CCOctree.AddObject(gEngine.collisionManager.octree,object)}};CCOctree.PruneTree=function(tree){if(tree.leafs){var hasObjects=CCOctree.HasObjects(tree);if(!hasObjects){CCOctree.DeleteLeafs(tree)}else{for(var i=0;i<8;++i){CCOctree.PruneTree(tree.leafs[i])}}}};CCOctree.IsInLeaf=function(leaf,targetMin,targetMax){var sourceMin=leaf.min;var sourceMax=leaf.max;if(sourceMax[1]>=targetMin[1]&&sourceMin[1]<=targetMax[1]){if(sourceMax[0]>=targetMin[0]&&sourceMin[0]<=targetMax[0]){if(sourceMax[2]>=targetMin[2]&&sourceMin[2]<=targetMax[2]){return true}}}return false};CCOctree.HasObjects=function(tree){if(tree.objects.length>0){return true}if(tree.leafs){for(var i=0;i<8;++i){if(CCOctree.HasObjects(tree.leafs[i])){return true}}}return false};CCOctree.Render=function(tree){};CCOctree.ListVisibles=function(leafs,collideables){var leafsLength=leafs.length;for(var leafIndex=0;leafIndex<leafsLength;++leafIndex){var leaf=leafs[leafIndex];var leafObjects=leaf.objects;var leafObjectsLength=leaf.objects.length;for(var i=0;i<leafObjectsLength;++i){var collideable=leafObjects[i];if(!collideable.deletingObjectCountdown&&collideable.shouldRender){if(collideable.shouldRender&&collideable.octreeRender){collideables.addOnce(collideable)}}}}};CCOctree.FillLeafsInFrustum=function(frustum,tree,leafsList){var i;var leafs=tree.leafs;if(leafs){for(i=0;i<8;++i){var leaf=leafs[i];if(!tree.parent||CC.CubeInFrustum(frustum,leaf.min,leaf.max)){CCOctree.FillLeafsInFrustum(frustum,leaf,leafsList)}}}else{leafsList.push(tree)}};CCOctree.VisibleLeafs=[];CCOctree.VisibleCollideables=[];CCOctree.ScanVisibleCollideables=function(frustum,visibleCollideables){var leafs=CCOctree.VisibleLeafs;var octreeCollideables=CCOctree.VisibleCollideables;leafs.length=0;CCOctree.FillLeafsInFrustum(frustum,gEngine.collisionManager.octree,leafs);octreeCollideables.length=0;CCOctree.ListVisibles(leafs,octreeCollideables);visibleCollideables.length=0;CC.CollideablesInFrustum(frustum,octreeCollideables,visibleCollideables);return visibleCollideables};CCOctree.ListCollideables=function(collideables,leafs){var leafsLength=leafs.length;for(var leafIndex=0;leafIndex<leafsLength;++leafIndex){var leaf=leafs[leafIndex];var leafObjects=leaf.objects;var leafObjectsLength=leaf.objects.length;for(var i=0;i<leafObjectsLength;++i){var collideable=leafObjects[i];if(!collideable.deletingObjectCountdown&&collideable.shouldRender){if(!CC.HasFlag(collideable.collideableType,CC.collision_none)){collideables.addOnce(collideable)}}}}};CCOctree.ListLeafs=function(tree,targetMin,targetMax,leafsList){var i;if(tree.leafs){for(i=0;i<8;++i){CCOctree.ListLeafs(tree.leafs[i],targetMin,targetMax,leafsList)}}else if(tree.objects.length>0){var length=leafsList.length;for(i=0;i<length;++i){if(leafsList[i]==tree){return}}if(CCOctree.IsInLeaf(tree,targetMin,targetMax)){leafsList.push(tree)}}};function CCURLRequest(url,postData,callback,priority,cacheFile,cacheFileTimeoutSeconds,timeout,returnBinary){this.url=url;this.postData=postData;this.callback=callback;this.priority=priority;this.cacheFile=cacheFile;this.cacheFileTimeoutSeconds=cacheFileTimeoutSeconds;this.timeout=timeout;this.timeRequestable=window.gEngine?gEngine.lifetime+timeout:0;this.returnBinary=returnBinary}CCURLRequest.Not_Started=1;CCURLRequest.In_Flight=2;CCURLRequest.Failed=3;CCURLRequest.Timed_Out=4;CCURLRequest.Data_Error=5;CCURLRequest.Succeeded=6;CCURLRequest.Used_Cache=7;CCURLRequest.Failed_But_Used_Cache=8;function CCURLManager(){this.requests=[]}window.gURLManager=null;CCURLManager.prototype.findRequest=function(url,cacheFile){var requests=this.requests;for(var i=0;i<requests.length;++i){var request=requests[i];if(!request.checkingCache){if(request.url===url){if(request.cacheFile==cacheFile){if(request.cacheFileTimeoutSeconds===-1&&request.timeout===0){return request}}}}}return null};vec3.isZero=function(a){return a[0]===0&&a[1]===0&&a[2]===0};vec3.equals=function(a,b){return a[0]===b[0]&&a[1]===b[1]&&a[2]===b[2]};vec3.distance=function(from,to,squared){var difference=vec3.clone(to);vec3.subtract(difference,difference,from);vec3.scale(difference,difference,.5);if(squared){return vec3.squaredLength(difference)}return vec3.length(difference)};vec3.unitize=function(vec){var absX=Math.abs(vec[0]);var absY=Math.abs(vec[1]);var absZ=Math.abs(vec[2]);var dividedBy=1;if(absX>absY){if(absX>absZ){dividedBy=1/absX}else{dividedBy=1/absZ}}else if(absY>absZ){dividedBy=1/absY}else{dividedBy=1/absZ}vec[0]*=dividedBy;vec[1]*=dividedBy;vec[2]*=dividedBy;return vec};vec3.fromString=function(string){var vector=vec3.create();var split=string.split(",");if(split.length>0){vector[0]=parseFloat(split[0])}if(split.length>1){vector[1]=parseFloat(split[1])}if(split.length>2){vector[2]=parseFloat(split[2])}return vector};vec3.toString=function(vector){var string="";string+=vector[0];string+=",";string+=vector[1];string+=",";string+=vector[2];return string};vec3.addValue=function(vector,value){vec3.add(vector,vector,[value,value,value])};mat4.multiplyVec4=function(mat,vec,dest){if(!dest){dest=vec}var x=vec[0],y=vec[1],z=vec[2],w=vec[3];dest[0]=mat[0]*x+mat[4]*y+mat[8]*z+mat[12]*w;dest[1]=mat[1]*x+mat[5]*y+mat[9]*z+mat[13]*w;dest[2]=mat[2]*x+mat[6]*y+mat[10]*z+mat[14]*w;dest[3]=mat[3]*x+mat[7]*y+mat[11]*z+mat[15]*w;return dest};function CCSize(width,height){this.width=this.height=0;if(width){this.width=width}if(height){this.height=height}}function CCPoint(x,y){if(!x){x=0}if(!y){y=x}this.x=x;this.y=y}function CCMinMax(){this.reset()}CCMinMax.prototype.reset=function(){this.min=CC_MAXFLOAT;this.max=-CC_MAXFLOAT};CCMinMax.prototype.consider=function(value){this.min=Math.min(this.min,value);this.max=Math.max(this.max,value)};CCMinMax.prototype.size=function(){return this.max-this.min};function CCColour(r,g,b,a){if(r!==undefined){if(g!==undefined&&b!==undefined){this.setRGBA(r,g,b,a)}else{this.set(r,g)}}else{this.white()}}CCColour.prototype.equals=function(colour){return this.r===colour.r&&this.g===colour.g&&this.b===colour.b&this.a===colour.a};CCColour.prototype.white=function(){this.setRGBA(1,1,1,1);return this};CCColour.prototype.set=function(colour,alpha){if(typeof colour==="number"){this.setRGBA(colour,colour,colour,alpha)}else{this.setRGBA(colour.r,colour.g,colour.b,colour.a)}return this};CCColour.prototype.setRGBA=function(r,g,b,a){if(a===undefined){a=1}this.r=r;this.g=g;this.b=b;this.a=a;return this};CCColour.prototype.setInt=function(r,g,b,a){if(b===undefined){a=g;b=r;g=r}if(a===undefined){a=1}var multiple=1/255;this.setRGBA(r*multiple,g*multiple,b*multiple,a);return this};CCColour.prototype.toString=function(){var string="";string+=this.r;string+=",";string+=this.g;string+=",";string+=this.b;string+=",";string+=this.a;return string};CCColour.prototype.fromString=function(string){if(string&&string.length>0){var colourSplit=string.split(",");if(colourSplit.length>0){if(colourSplit[0].length>0){this.r=CC.FloatClamp(parseFloat(colourSplit[0]),0,1)}}if(colourSplit.length>1){if(colourSplit[1].length>0){this.g=CC.FloatClamp(parseFloat(colourSplit[1]),0,1)}}if(colourSplit.length>2){if(colourSplit[2].length>0){this.b=CC.FloatClamp(parseFloat(colourSplit[2]),0,1)}}if(colourSplit.length>3){if(colourSplit[3].length>0){this.a=CC.FloatClamp(parseFloat(colourSplit[3]),0,1)}}}return this};var gColour=new CCColour;function CCVector3Target(){this.current=vec3.create();this.target=vec3.create()}CCVector3Target.prototype.equals=function(){return vec3.equals(this.current,this.target)};function CCControls(){this.touches=[];this.touches.push(new CCTouch);this.touches.push(new CCTouch);this.keys=[];this.onKeyboardCallbacks=[];this.onDragDrop=[];this.onDragDropLoad=[]}CCControls.touch_pressed=1;CCControls.touch_movingHorizontal=2;CCControls.touch_movingVertical=3;CCControls.touch_moving=4;CCControls.touch_released=5;CCControls.touch_lost=6;CCControls.twotouch_unassigned=7;CCControls.twotouch_zooming=8;CCControls.twotouch_rotating=9;CCControls.TouchMovementThreashold=new CCPoint(.00125125);CCControls.DOUBLE_TAP_THRESHOLD=.2;CCControls.max_last_deltas=50;function CCTouch(){this.rawX=0;this.rawY=0;this.x=0;this.y=0;this.startX=0;this.startY=0;this.deltaX=0;this.deltaY=0;this.totalDeltaX=0;this.totalDeltaY=0;this.timeHeld=0;this.lastTimeReleased=0;this.state=CCControls.touch_released;this.usingTouch=false;var lastDeltas=this.lastDeltas=new Array(CCControls.max_last_deltas);for(var i=0;i<lastDeltas.length;++i){var lastDelta={};lastDelta.time=0;lastDelta.delta=new CCPoint;lastDeltas[i]=lastDelta}}CCTouch.prototype.averageLastDeltas=function(){if(!this.averageDeltas){this.averageDeltas=new CCPoint}var averageDeltas=this.averageDeltas;var numberOfDeltas=0;var lifetime=gEngine.lifetime;var lastDeltas=this.lastDeltas;for(var i=0;i<lastDeltas.length;++i){var lastDelta=lastDeltas[i];var difference=lifetime-lastDelta.time;if(difference<.25){averageDeltas.x+=lastDelta.delta.x;averageDeltas.y+=lastDelta.delta.y;numberOfDeltas++}else{break}}if(numberOfDeltas>1){averageDeltas.x/=numberOfDeltas;averageDeltas.y/=numberOfDeltas}return averageDeltas};CCControls.prototype.update=function(delta){var updatedTouchState=false;var touches=this.touches;for(var i=0;i<touches.length;++i){var touch=touches[i];if(touch.touchMovingState){updatedTouchState=true;this.updateTouch(touch,touch.touchMovingState);touch.touchMovingState=false}if(touch.state<CCControls.touch_released){touch.timeHeld+=delta;var lastDeltas=touch.lastDeltas;for(var lastDeltaIndex=lastDeltas.length-1;lastDeltaIndex>0;--lastDeltaIndex){var prev=lastDeltas[lastDeltaIndex-1];var next=lastDeltas[lastDeltaIndex];next.time=prev.time;next.delta.x=prev.delta.x;next.delta.y=prev.delta.y}lastDeltas[0].time=gEngine.lifetime;lastDeltas[0].delta.x=touch.deltaX;lastDeltas[0].delta.y=touch.deltaY}else{touch.lastTimeReleased+=delta}}if(updatedTouchState){gEngine.updateControls()}};CCControls.prototype.updateTouchXY=function(touch,state,x,y){if(touch.state<CCControls.touch_released){var deltaX=touch.deltaX=x-touch.x;var deltaY=touch.deltaY=y-touch.y;touch.x=x;touch.y=y;touch.totalDeltaX+=deltaX;if(deltaY!==0){touch.totalDeltaY+=deltaY}}else{touch.timeHeld=0;touch.x=x;touch.y=y;touch.startX=x;touch.startY=y;touch.deltaX=0;touch.deltaY=0;touch.totalDeltaX=0;touch.totalDeltaY=0;touch.lastTimeReleased=0}touch.state=state;touch.usingTouch=state<CCControls.touch_released};CCControls.TouchActionMoving=function(touchAction){if(touchAction>=CCControls.touch_movingHorizontal&&touchAction<=CCControls.touch_moving){return true}return false};CCControls.TouchSetMovementThreashold=function(x,y){CCControls.TouchMovementThreashold.x=x;CCControls.TouchMovementThreashold.y=y};CCControls.prototype.onPause=function(){for(var i=0;i<this.keys.length;++i){if(this.keys[i]){this.keys[i]=false}}};function CCRenderable(){this.construct()}CCRenderable.NextID=0;CCRenderable.prototype.construct=function(){this.jsID=CCRenderable.NextID++;this.modelMatrix=mat4.create();this.position=vec3.create();this.rotation=vec3.create();this.scale=vec3.clone([1,1,1]);this.colour=null;this.shouldRender=true;this.dirtyModelMatrix()};CCRenderable.prototype.destruct=function(){};CCRenderable.prototype.dirtyModelMatrix=function(){gRenderer.pendingRender=true;this.updateModelMatrix=true};CCRenderable.prototype.refreshModelMatrix=function(){if(this.updateModelMatrix){this.updateModelMatrix=false;CCRenderer.ModelMatrixIdentity(this);CCRenderer.ModelMatrixTranslate(this,this.position);CCRenderer.ModelMatrixScale(this,this.scale);var rotation=this.rotation;CCRenderer.ModelMatrixRotate(this,rotation[0],[1,0,0]);CCRenderer.ModelMatrixRotate(this,rotation[1],[0,1,0]);CCRenderer.ModelMatrixRotate(this,rotation[2],[0,0,1])}};CCRenderable.prototype.setPosition=function(vector){this.setPositionXYZ(vector[0],vector[1],vector[2])};CCRenderable.prototype.setPositionXYZ=function(x,y,z){var position=this.position;position[0]=x;position[1]=y;position[2]=z;this.dirtyModelMatrix();if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCRenderable.setPositionXYZ;"+this.jsID+";"+position[0]+";"+position[1]+";"+position[2]+"\n"}};CCRenderable.prototype.setPositionX=function(x){this.setPositionXYZ(x,this.position[1],this.position[2])};CCRenderable.prototype.setPositionY=function(y){this.setPositionXYZ(this.position[0],y,this.position[2])};CCRenderable.prototype.setPositionZ=function(z){this.setPositionXYZ(this.position[0],this.position[1],z)};CCRenderable.prototype.setPositionXY=function(x,y){this.setPositionXYZ(x,y,this.position[2])};CCRenderable.prototype.setPositionXZ=function(x,z){this.setPositionXYZ(x,this.position[1],z)};CCRenderable.prototype.setPositionYZ=function(y,z){this.setPositionXYZ(this.position[0],y,z)};CCRenderable.prototype.translate=function(x,y,z){if(y===undefined){y=0}if(z===undefined){z=0}var position=this.position;position[0]+=x;position[1]+=y;position[2]+=z;this.dirtyModelMatrix();if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCRenderable.setPositionXYZ;"+this.jsID+";"+position[0]+";"+position[1]+";"+position[2]+"\n"}};CCRenderable.prototype.rotationUpdated=function(){this.dirtyModelMatrix();if(CCEngine.NativeUpdateCommands!==undefined){var rotation=this.rotation;CCEngine.NativeUpdateCommands+="CCRenderable.setRotationXYZ;"+this.jsID+";"+rotation[0]+";"+rotation[1]+";"+rotation[2]+"\n"}};CCRenderable.prototype.setRotation=function(rotationVector){this.rotation[0]=rotationVector[0];this.rotation[1]=rotationVector[1];this.rotation[2]=rotationVector[2];this.rotationUpdated()};CCRenderable.prototype.setRotationX=function(x){this.rotation[0]=x;this.rotationUpdated()};CCRenderable.prototype.setRotationY=function(y){this.rotation[1]=y;this.rotationUpdated()};CCRenderable.prototype.setRotationZ=function(z){this.rotation[2]=z;this.rotationUpdated()};CCRenderable.prototype.rotateX=function(x){this.rotation[0]+=x;this.rotation[0]=CC.ClampRotation(this.rotation[0]);this.rotationUpdated()};CCRenderable.prototype.rotateY=function(y){this.rotation[1]+=y;this.rotation[1]=CC.ClampRotation(this.rotation[1]);this.rotationUpdated()};CCRenderable.prototype.rotateZ=function(z){this.rotation[2]+=z;this.rotation[2]=CC.ClampRotation(this.rotation[2]);this.rotationUpdated()};CCRenderable.prototype.setScale=function(inScale){var scale=this.scale;if(typeof inScale==="number"){vec3.copy(this.scale,[inScale,inScale,inScale])}else{vec3.copy(this.scale,inScale)}this.dirtyModelMatrix();if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCRenderable.setScale;"+this.jsID+";"+scale[0]+";"+scale[1]+";"+scale[2]+"\n"}};CCRenderable.prototype.getColour=function(){if(this.colour){return this.colour}return null};function CCObject(){this.construct()}ExtendPrototype(CCObject,CCRenderable);CCObject.prototype.construct=function(){this.CCRenderable_construct();this.deletingObjectCountdown=0;this.parent=null;this.model=null;this.renderPass=CCRenderer.render_main;this.readDepth=true;this.writeDepth=true;this.disableCulling=false;this.transparent=false;this.colourInterpolator=null;if(CCEngine.NativeUpdateCommands!==undefined){this.nativeConstruct()}};CCObject.prototype.nativeConstruct=function(){CCEngine.NativeUpdateCommands+="CCObject.construct;"+this.jsID+"\n"};CCObject.prototype.destruct=function(){if(this.inScene){this.removeFromScene()}else if(this.noScene){}else if(!this.parent){alert(false)}else{this.parent.removeChild(this)}var i;var updaters=this.updaters;if(updaters){var updatersLength=updaters.length;for(i=0;i<updatersLength;++i){var updater=updaters[i];if(updater.destruct){updater.destruct()}}updaters.length=0}var children=this.children;if(children){var childrenLength=children.length;for(i=0;i<children.length;++i){var child=children[i];child.destruct();if(childrenLength!==children.length){childrenLength=children.length;--i}}delete this.children}if(this.model){this.model.destruct()}this.CCRenderable_destruct();if(CCEngine.NativeUpdateCommands!==undefined){this.nativeDestruct()}};CCObject.prototype.nativeDestruct=function(){CCEngine.NativeUpdateCommands+="CCObject.destruct;"+this.jsID+"\n"};CCObject.prototype.deleteLater=function(){this.deletingObjectCountdown=2;this.deactivate()};CCObject.prototype.setScene=function(scene){scene.addObject(this)};CCObject.prototype.removeFromScene=function(){this.deactivate();this.inScene.removeObject(this)};CCObject.prototype.isActive=function(){return this.deletingObjectCountdown===0};CCObject.prototype.deactivate=function(){};CCObject.prototype.addChild=function(object,preRender,index){if(!this.children){this.children=[]}this.children.push(object);if(index!==undefined){this.children.insert(object,index)}object.parent=this;if(preRender){object.preRender=true}};CCObject.prototype.removeChild=function(object){if(this.children&&this.children.remove(object)){if(this.children.length===0){delete this.children}return true}return false};CCObject.prototype.addUpdater=function(updater){if(!this.updaters){this.updaters=[]}this.updaters.push(updater)};CCObject.prototype.removeUpdater=function(updater){this.updaters.remove(updater);if(this.updaters.length===0){delete this.updaters}};CCObject.prototype.shouldCollide=function(collideWith,initialCall){if(this===collideWith){return false}if(this.parent){return this.parent.shouldCollide(collideWith,initialCall)}return true};CCObject.prototype.update=function(delta){var updated=false;var i;{var updaters=this.updaters;if(updaters){var updatersLength=updaters.length;for(i=0;i<updatersLength;++i){if(updaters[i].updating){updated|=updaters[i].update(delta)}}}}{var children=this.children;if(children){var childrenLength=children.length;for(i=0;i<childrenLength;++i){updated|=children[i].update(delta)}}}if(this.colourInterpolator){if(this.colourInterpolator.updating){updated|=this.colourInterpolator.update(delta);gRenderer.pendingRender=true}else{delete this.colourInterpolator}}return updated};CCObject.prototype.renderObject=function(camera,alpha){if(this.shouldRender&&!this.loading){var children=this.children;var i;var childrenLength=0;if(children){childrenLength=children.length}if(alpha===this.transparent||childrenLength>0){CCRenderer.GLPushMatrix();{if(this.updateModelMatrix){this.refreshModelMatrix()}CCRenderer.ModelMatrixMultiply(this);for(i=0;i<childrenLength;++i){if(children[i].preRender){children[i].renderObject(camera,alpha)}}if(alpha===this.transparent){if(this.colour){gRenderer.CCSetColour(this.colour)}this.renderModel(alpha)}for(i=0;i<childrenLength;++i){if(!children[i].preRender){children[i].renderObject(camera,alpha)}}}CCRenderer.GLPopMatrix()}}};CCObject.prototype.renderModel=function(alpha){var model=this.model;if(model){var renderer=gRenderer;if(CCEngine.NativeRenderCommands!==undefined){renderer.unbindBuffers();CCEngine.NativeRenderCommands+="CCObject.renderModel;"+this.jsID+";"+alpha+"\n"}else{if(this.disableCulling){renderer.CCSetCulling(false)}if(alpha){if(this.readDepth){renderer.CCSetDepthRead(true);if(this.writeDepth){renderer.CCSetDepthWrite(true);model.render(alpha);renderer.CCSetDepthWrite(false)}else{model.render(alpha)}renderer.CCSetDepthRead(false)}else{model.render(alpha)}}else{if(this.readDepth){if(this.writeDepth){model.render(alpha)}else{renderer.CCSetDepthWrite(false);model.render(alpha);renderer.CCSetDepthWrite(true)}}else{renderer.CCSetDepthRead(false);model.render(alpha);renderer.CCSetDepthRead(true)}}if(this.disableCulling){renderer.CCSetCulling(true)}}}};CCObject.prototype.isTransparent=function(){return this.transparent};CCObject.prototype.setTransparent=function(toggle){if(toggle===undefined){toggle=true}this.transparent=toggle};CCObject.prototype.getColourInterpolator=function(){if(!this.colourInterpolator){this.colourInterpolator=new CCInterpolatorColour;if(this.colour){this.colourInterpolator.setup(this.colour,this.colour)}}return this.colourInterpolator};CCObject.prototype.setColour=function(inColour,interpolate,inCallback){if(typeof inColour==="number"){inColour=gColour.setRGBA(inColour,inColour,inColour,1)}if(!this.colour){this.colour=new CCColour}if(interpolate){this.getColourInterpolator().setup(this.colour,inColour)}else{this.colour.set(inColour);if(this.colourInterpolator){this.colourInterpolator.setup(this.colour)}}};CCObject.prototype.setColourAlpha=function(inAlpha,interpolate,inCallback){if(!this.colour){this.colour=new CCColour}if(interpolate){this.getColourInterpolator().setTargetAlpha(inAlpha,inCallback)}else{this.colour.a=inAlpha;if(this.colourInterpolator){this.colourInterpolator.finish();this.colourInterpolator.setup(this.colour)}}};CCObject.prototype.setModel=function(model){this.model=model;if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCObject.setModel;"+this.jsID+";"+model.jsID+"\n"}return model};CCObject.prototype.setReadDepth=function(toggle){this.readDepth=toggle;if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCObject.setReadDepth;"+this.jsID+";"+toggle+"\n"}};CCObject.prototype.setWriteDepth=function(toggle){this.writeDepth=toggle;if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCObject.setWriteDepth;"+this.jsID+";"+toggle+"\n"}};CCObject.prototype.setCulling=function(toggle){this.disableCulling=!toggle;if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCObject.setCulling;"+this.jsID+";"+toggle+"\n"}};function CCCollideable(objectID){this.construct(objectID)}ExtendPrototype(CCCollideable,CCObject);CCCollideable.prototype.construct=function(objectID){this.CCObject_construct();this.drawOrder=100;this.collisionsEnabled=true;this.octreeRender=true;this.aabbMin=vec3.create();this.aabbMax=vec3.create();this.collideableType=CC.collision_none;this.collisionBounds=vec3.create();this.collisionSize=new CCSize;this.inverseCollisionSize=new CCSize;this.setCollisionBounds(1,1,1);this.octrees=[];this.visible=false;this.owner=null;this.owns=[];if(objectID){this.objectID=objectID}};CCCollideable.prototype.nativeConstruct=function(){CCEngine.NativeSyncCommands+="CCCollideable.construct;"+this.jsID+"\n"};CCCollideable.prototype.nativeDestruct=function(){CCEngine.NativeUpdateCommands+="CCCollideable.destruct;"+this.jsID+"\n"};CCCollideable.prototype.setPositionXYZ=function(x,y,z){this.CCObject_setPositionXYZ(x,y,z);if(this.collideableType!==CC.collision_none){this.updateCollisions=true;CCOctree.RefreshObject(this)}};CCCollideable.prototype.translate=function(x,y,z){this.CCObject_translate(x,y,z);if(this.collideableType!==CC.collision_none){this.updateCollisions=true;CCOctree.RefreshObject(this)}};CCCollideable.prototype.setScene=function(scene){this.CCObject_setScene(scene);this.collideableType=CC.AddFlag(this.collideableType,CC.collision_box);scene.addCollideable(this)};CCCollideable.prototype.removeFromScene=function(){this.inScene.removeCollideable(this);this.CCObject_removeFromScene()};CCCollideable.prototype.deactivate=function(){this.CCObject_deactivate();this.collideableType=CC.collision_none;CCOctree.RemoveObject(this);if(this.owner){this.owner.unOwnObject(this);this.owner=null}for(var i=0;i<this.owns.length;++i){this.owns[i].removeOwner(this)}this.owns.length=0};CCCollideable.prototype.shouldCollide=function(collideWith,initialCall){if(!this.CCObject_shouldCollide(collideWith,initialCall)){return false}if(this.owner&&this.owner!==this.parent){if(!this.owner.shouldCollide(collideWith,initialCall)){return false}}if(initialCall){return collideWith.shouldCollide(this,false)}return true};CCCollideable.prototype.setDrawOrder=function(drawOrder){this.drawOrder=drawOrder;if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCCollideable.setDrawOrder;"+this.jsID+";"+drawOrder+"\n"}};CCCollideable.prototype.renderModel=function(alpha){this.CCObject_renderModel(alpha);var renderer=gRenderer;if(alpha===this.transparent&&renderer.renderFlags&CCRenderer.render_collisionBoxes&&CC.HasFlag(this.collideableType,CC.collision_box)){if(!this.transparent){renderer.CCSetBlend(true)}this.renderCollisionBox();if(!this.transparent){renderer.CCSetBlend(false)}}};CCCollideable.prototype.renderCollisionBox=function(){var renderer=gRenderer;CCRenderer.GLPushMatrix();{var scale=this.scale;var collisionBounds=this.collisionBounds;CCRenderer.GLScale([1/scale[0],1/scale[1],1/scale[2]]);CCRenderer.GLScale([collisionBounds[0]*2,collisionBounds[1]*2,collisionBounds[2]*2]);gEngine.textureManager.setTextureIndex(1);var red=gColour.setRGBA(1,0,0,.5);CCRenderer.GLRotate(-this.rotation[1],[0,1,0]);renderer.CCSetColour(red);renderer.CCRenderCube(true)}CCRenderer.GLPopMatrix()};CCCollideable.prototype.getType=function(){return null};CCCollideable.prototype.getID=function(){return this.objectID};CCCollideable.prototype.setSquareCollisionBounds=function(width,height){if(!height){height=width}this.setCollisionBounds(width,height,width)};CCCollideable.prototype.setCollisionBounds=function(width,height,depth){this.setHCollisionBounds(width*.5,height*.5,depth*.5)};CCCollideable.prototype.setHCollisionBounds=function(hWidth,hHeight,hDepth){vec3.copy(this.collisionBounds,[hWidth,hHeight,hDepth]);var collisionSize=this.collisionSize;collisionSize.width=hWidth>hDepth?hWidth:hDepth;collisionSize.width*=2;collisionSize.height=hHeight*2;this.inverseCollisionSize.width=1/(hWidth>hDepth?hWidth:hDepth);this.inverseCollisionSize.width=1/this.collisionBounds[1];this.updateCollisions=true};CCCollideable.prototype.requestCollisionWith=function(collidedWith){return collidedWith.recieveCollisionFrom(this,0,0,0)};CCCollideable.prototype.recieveCollisionFrom=function(collisionSource,x,y,z){return this};CCCollideable.prototype.reportAttack=function(attackedBy,attackType,force,damage,x,y,z){return false};CCCollideable.prototype.isCollideable=function(){return this.collisionsEnabled};CCCollideable.prototype.setCollideable=function(toggle){this.collisionsEnabled=toggle};CCCollideable.prototype.isMoveable=function(){return false};CCCollideable.prototype.ownObject=function(object){this.owns.add(object);object.setOwner(this)};CCCollideable.prototype.unOwnObject=function(object){var owns=this.owns;if(owns.remove(object)){}};CCCollideable.prototype.setOwner=function(newOwner){this.owner=newOwner};CCCollideable.prototype.removeOwner=function(currentOwner){if(currentOwner===this.owner){this.owner=null}};CCCollideable.prototype.createMovementInterpolator=function(updateCollisions){if(!this.movementInterpolator){this.movementInterpolator=new CCMovementInterpolator(this,updateCollisions)
}};CCCollideable.prototype.getMovementInterpolator=function(){return this.movementInterpolator};function CCCollideableStaticMesh(objectID){this.construct(objectID)}ExtendPrototype(CCCollideableStaticMesh,CCCollideable);CCCollideableStaticMesh.prototype.construct=function(objectID){this.CCCollideable_construct(objectID);this.createMovementInterpolator(false);this.getMovementInterpolator().setDuration(2);this.setModel(new CCModelBase);this.collideableType=CC.AddFlag(this.collideableType,CC.collision_static);this.model3d=null;this.setColour(gColour.set(1,0));this.setColourAlpha(.25,true)};CCCollideableStaticMesh.prototype.destruct=function(){this.CCCollideable_destruct()};CCCollideableStaticMesh.prototype.requestCollisionWith=function(collidedWith){return this.CCCollideable_requestCollisionWith(collidedWith)};CCCollideableStaticMesh.prototype.recieveCollisionFrom=function(collisionSource,x,y,z){return this.CCCollideable_recieveCollisionFrom(collisionSource,x,y,z)};CCCollideableStaticMesh.prototype.update=function(delta){this.CCCollideable_update(delta);if(this.model3d){this.model3d.animate(delta)}};CCCollideableStaticMesh.prototype.renderModel=function(alpha){if(this.model3d){this.CCCollideable_renderModel(alpha)}else if(alpha){if(!this.disableCulling){gRenderer.CCSetCulling(false)}if(!this.readDepth){gRenderer.CCSetDepthRead(true)}CCRenderer.GLPushMatrix();gRenderer.CCSetColour(this.colour);gEngine.textureManager.setTextureIndex(1);var size=this.collisionSize.width;CCRenderer.GLScale([size,size,size]);gRenderer.CCRenderCube(false);CCRenderer.GLPopMatrix();if(!this.readDepth){gRenderer.CCSetDepthRead(false)}if(!this.disableCulling){gRenderer.CCSetCulling(true)}}};CCCollideableStaticMesh.prototype.setupModel=function(obj,tex,width,callback){if(width){this.setCollisionBounds(width,width,width);this.setPositionY(this.collisionBounds[1])}this.obj=obj;this.tex=tex;this.loadModel(obj,tex,callback)};CCCollideableStaticMesh.prototype.loadModel=function(obj,tex,callback){if(tex){gEngine.textureManager.getTextureHandle(tex)}var self=this;CCModel3D.CacheModel(obj,true,function(model3d){if(model3d){self.model3d=model3d;self.setColourAlpha(1,true);while(self.model.models.length>0){var model=self.model.models[0];self.model.removeModel(model);model.destruct()}self.model.addModel(model3d);self.resize(self.collisionSize.width);self.setPositionY(0);self.getMovementInterpolator().setMovementY(self.collisionBounds[1]);if(tex){self.setTexture(model3d,tex)}if(callback){callback(self)}}},1)};CCCollideableStaticMesh.prototype.resize=function(size){this.setCollisionBounds(size,size,size);this.setPositionY(this.collisionBounds[1]);CC.UpdateCollisions(this);if(this.model3d){var model3d=this.model3d;var modelWidth=model3d.getWidth()>model3d.getDepth()?model3d.getWidth():model3d.getDepth();var modelHeight=model3d.getHeight();var scaleFactor=size/modelWidth;this.model.setScale(scaleFactor);model3d.setPositionY(-size*.5/scaleFactor);model3d.translate(0,modelHeight*.5,0)}};CCCollideableStaticMesh.prototype.setTexture=function(model3d,tex){if(tex){model3d.setTexture(tex)}};function CCMoveable(){this.construct()}ExtendPrototype(CCMoveable,CCCollideable);CCMoveable.gravityForce=200;CCMoveable.prototype.construct=function(){this.CCCollideable_construct();this.collideableType=CC.AddFlag(this.collideableType,CC.collision_moveable);this.moveable=true;this.movementSpeed=75;this.decelerationSpeed=this.movementSpeed*2;this.movementDirection=vec3.create();this.velocity=vec3.create();this.movementVelocity=vec3.create();this.additionalVelocity=vec3.create();this.gravity=true};CCMoveable.prototype.destruct=function(){this.CCCollideable_destruct()};CCMoveable.prototype.update=function(delta){this.CCCollideable_update(delta);this.updateMovement(delta);return true};CCMoveable.prototype.requestCollisionWith=function(collidedWith){var velocity=this.velocity;return collidedWith.recieveCollisionFrom(this,velocity[0],velocity[1],velocity[2])};CCMoveable.prototype.isMoveable=function(){return true};CCMoveable.prototype.updateMovement=function(delta){if(this.moveable){var movementMagnitude=this.applyMovementDirection(delta);var velocity=this.velocity;var additionalVelocity=this.additionalVelocity;vec3.copy(velocity,this.movementVelocity);var additionalMagnitude=vec3.squaredLength(additionalVelocity);if(additionalMagnitude>0){vec3.add(velocity,velocity,additionalVelocity);var deceleration=this.decelerationSpeed*delta;additionalVelocity[0]=CC.ToTarget(additionalVelocity[0],0,deceleration);additionalVelocity[1]=CC.ToTarget(additionalVelocity[1],0,deceleration);additionalVelocity[2]=CC.ToTarget(additionalVelocity[2],0,deceleration)}var velocityMagnitude=vec3.squaredLength(velocity);if(velocityMagnitude>0){this.applyVelocity(delta,movementMagnitude);this.dirtyModelMatrix();this.updateCollisions=true;CCOctree.RefreshObject(this)}}};CCMoveable.prototype.applyMovementDirection=function(delta){var movementDirection=this.movementDirection;var rotation=this.rotation;var movementVelocity=this.movementVelocity;var movementMagnitude=vec3.squaredLength(movementDirection);if(movementMagnitude>0){var forwardSpeed=this.movementSpeed;var zMovementSpeed=movementDirection[2]*forwardSpeed;var rotationInRadians=CC.DEGREES_TO_RADIANS(rotation[1]);var xAmount=Math.sin(rotationInRadians)*zMovementSpeed;var zAmount=Math.cos(rotationInRadians)*zMovementSpeed;if(movementDirection[0]!==0){var xMovementSpeed=movementDirection[0]*movementSpeed;rotationInRadians=CC.DEGREES_TO_RADIANS(rotation[1]+90);xAmount+=Math.sin(rotationInRadians)*xMovementSpeed;zAmount+=Math.cos(rotationInRadians)*xMovementSpeed}movementVelocity[0]=xAmount;movementVelocity[2]=zAmount}else{movementVelocity[0]=0;movementVelocity[2]=0}return movementMagnitude};CCMoveable.prototype.applyVelocity=function(delta,movementMagnitude){var velocity=this.velocity;var movementVelocity=this.movementVelocity;var velocityX=velocity[0]*delta;var velocityZ=velocity[2]*delta;if(velocityX!==0||velocityZ!==0){this.applyHorizontalVelocity(velocityX,velocityZ);if(movementMagnitude===0){var movementDeceleration=this.decelerationSpeed*delta;movementVelocity[0]=CC.ToTarget(movementVelocity[0],0,movementDeceleration);movementVelocity[2]=CC.ToTarget(movementVelocity[2],0,movementDeceleration)}}if(this.gravity){var collidedWith=null;movementVelocity[1]-=CCMoveable.gravityForce*delta;var velocityY=velocity[1]*delta;if(velocityY>0){collidedWith=this.applyVerticalVelocity(velocityY)}else{collidedWith=this.applyVerticalVelocity(velocityY)}this.reportVerticalCollision(collidedWith);if(!collidedWith&&movementVelocity[1]===0){movementVelocity[1]=CC_SMALLFLOAT}}};CCMoveable.prototype.getCollisionPosition=function(thisObjectPosition,thisObjectBounds,collidedObjectPosition,collidedObjectBounds){var collisionPosition=collidedObjectPosition;if(collisionPosition<thisObjectPosition){collisionPosition+=collidedObjectBounds;collisionPosition+=thisObjectBounds;collisionPosition+=CC_SMALLFLOAT;if(collisionPosition>thisObjectPosition){collisionPosition=thisObjectPosition}}else{collisionPosition-=collidedObjectBounds;collisionPosition-=thisObjectBounds;collisionPosition-=CC_SMALLFLOAT;if(collisionPosition<thisObjectPosition){collisionPosition=thisObjectPosition}}return collisionPosition};CCMoveable.HorizontalVelocityStartPosition=vec3.create();CCMoveable.prototype.applyHorizontalVelocity=function(velocityX,velocityZ){var position=this.position;var startPosition=CCMoveable.HorizontalVelocityStartPosition;vec3.copy(startPosition,position);position[0]+=velocityX;position[2]+=velocityZ;var self=this;var collisionFlags=CC.collision_static|CC.collision_moveable;var collidedWith=CC.MovementCollisionCheck(this,startPosition,position,collisionFlags,true);if(collidedWith){if(CC.HasFlag(self.collideableType,CC.collision_box)){var areaCollideables=CC.MovementAreaCollideables;var collisionBounds=self.collisionBounds;var additionalVelocity=self.additionalVelocity;position[0]-=velocityX;var collidedWithZ=collidedWith;if(velocityZ!==0){collidedWithZ=CC.MovementCollisionReCheckAreaCollideables(self,startPosition,position,collisionFlags,true)}if(collidedWithZ){position[2]-=velocityZ;position[0]+=velocityX;var collidedWithX=collidedWith;if(velocityX!==0){collidedWithX=CC.MovementCollisionReCheckAreaCollideables(self,startPosition,position,collisionFlags,true)}if(collidedWithX){position[0]-=velocityX;additionalVelocity[0]=0;additionalVelocity[2]=0}else{var collisionZ=self.getCollisionPosition(position[2],collisionBounds[2],collidedWith.position[2],collidedWith.collisionBounds[2]);position[2]=collisionZ;additionalVelocity[2]=0}}else{var collisionX=self.getCollisionPosition(position[0],collisionBounds[0],collidedWith.position[0],collidedWith.collisionBounds[0]);position[0]=collisionX;additionalVelocity[0]=0}}}};CCMoveable.prototype.applyVerticalVelocity=function(increment){var position=this.position;position[1]+=increment;var collidedWith=CC.CollisionCheck(this,position,true,CC.collision_box);if(collidedWith){var collisionBounds=this.collisionBounds;position[1]-=increment;var originalPosition=position[1];var currentlyCollidingWith=collidedWith;while(currentlyCollidingWith){position[1]=originalPosition;collidedWith=currentlyCollidingWith;position[1]=this.getCollisionPosition(position[1],collisionBounds[1],collidedWith.position[1],collidedWith.collisionBounds[1]);if(position[1]===originalPosition){currentlyCollidingWith=null}else{currentlyCollidingWith=CC.CollisionCheck(this,position,false,CC.collision_box)}}}return collidedWith};CCMoveable.prototype.reportVerticalCollision=function(collidedWith){if(collidedWith){this.movementVelocity[1]=0}};CCMoveable.prototype.setGravityForce=function(force){CCMoveable.gravityForce=force};CCMoveable.prototype.setVelocity=function(x,y,z){var movementVelocity=this.movementVelocity;movementVelocity[0]=x;movementVelocity[1]=y;movementVelocity[2]=z};CCMoveable.prototype.setAdditionalVelocity=function(x,y,z){var additionalVelocity=this.additionalVelocity;additionalVelocity[0]=x;additionalVelocity[1]=y;additionalVelocity[2]=z};CCMoveable.prototype.incrementAdditionalVelocity=function(x,y,z){var additionalVelocity=this.additionalVelocity;additionalVelocity[0]+=x;additionalVelocity[1]+=y;additionalVelocity[2]+=z};function CCTile3D(){this.construct()}ExtendPrototype(CCTile3D,CCCollideable);CCTile3D.prototype.construct=function(){this.CCCollideable_construct();this.touching=false;this.touchReleased=false;this.onPress=[];this.onRelease=[];this.onMove=[];this.onLoss=[]};CCTile3D.prototype.destruct=function(){this.CCCollideable_destruct()};CCTile3D.prototype.setPositionXYZ=function(x,y,z){this.CCCollideable_setPositionXYZ(x,y,z);CCOctree.RefreshObject(this);if(this.movementInterpolator){this.movementInterpolator.clear()}};CCTile3D.prototype.onTouchPress=function(touch){if(this.onPress){var onPress=this.onPress;var length=onPress.length;for(var i=0;i<length;++i){onPress[i](this,touch)}}};CCTile3D.prototype.onTouchMove=function(touchPosition){if(this.onMove){var onMove=this.onMove;var length=onMove.length;for(var i=0;i<length;++i){onMove[i](this,touchPosition)}}};CCTile3D.prototype.onTouchRelease=function(){if(this.onRelease){var onRelease=this.onRelease;var length=onRelease.length;for(var i=0;i<length;++i){onRelease[i](this)}}};CCTile3D.prototype.onTouchLoss=function(touchLost){if(this.onLoss){var onLoss=this.onLoss;var length=onLoss.length;for(var i=0;i<length;++i){onLoss[i](this,touchLost)}}};CCTile3D.prototype.positionTileBelow=function(fromTile){this.setPosition(fromTile.position);this.translate(0,-(fromTile.collisionBounds[1]+this.collisionBounds[1]),0)};CCTile3D.prototype.positionTileBelowY=function(fromTile){this.setPositionY(fromTile.position[1]);this.translate(0,-(fromTile.collisionBounds[1]+this.collisionBounds[1]),0)};CCTile3D.prototype.positionTileAbove=function(fromTile){this.setPosition(fromTile.position);this.translate(0,fromTile.collisionBounds[1]+this.collisionBounds[1],0)};CCTile3D.prototype.positionTileRight=function(fromTile){this.setPosition(fromTile.position);this.translate(fromTile.collisionBounds[0]+this.collisionBounds[0],0,0)};CCTile3D.prototype.positionTileLeft=function(fromTile){this.setPosition(fromTile.position);this.translate(-(fromTile.collisionBounds[0]+this.collisionBounds[0]),0,0)};CCTile3D.prototype.positionTileLeftX=function(fromTile){this.setPositionX(fromTile.getTileMovementTarget()[0]);this.translate(-(fromTile.collisionBounds[0]+this.collisionBounds[0]),0,0)};CCTile3D.prototype.setTileMovement=function(target){this.movementInterpolator.setMovement(target)};CCTile3D.prototype.setTileMovementX=function(x){this.movementInterpolator.setMovementX(x)};CCTile3D.prototype.setTileMovementY=function(y){this.movementInterpolator.setMovementY(y)};CCTile3D.prototype.setTileMovementXY=function(x,y){this.movementInterpolator.setMovementXY(x,y)};CCTile3D.prototype.setTileMovementYZ=function(y,z){this.movementInterpolator.setMovementYZ(y,z)};CCTile3D.prototype.translateTileMovementX=function(x){this.movementInterpolator.translateMovementX(x)};CCTile3D.prototype.translateTileMovementY=function(y){this.movementInterpolator.translateMovementY(y)};CCTile3D.prototype.getTileMovementTarget=function(){return this.movementInterpolator.getMovementTarget()};function CCTile3DButton(scene,setupTile){this.construct(scene);if(setupTile){this.setupTile(1)}}ExtendPrototype(CCTile3DButton,CCTile3D);CCTile3DButton.prototype.construct=function(scene){this.CCTile3D_construct();this.collideableType=CC.AddFlag(this.collideableType,CC.collision_ui);if(scene){this.setScene(scene)}this.setTransparent(true);this.setReadDepth(false);var model=this.setModel(new CCModelBase);var tileModel=this.tileModel=new CCModelBase;model.addModel(tileModel);this.setColour(gColour.white(),false);this.tileSquares=[];this.allowTouchRotation(false);this.touchRotationMagnitude=0;this.touchRotationSpeed=1;this.tileScaleInterpolator=new CCInterpolatorV3(CCInterpolatorSin2Curve);this.allowTouchMovement(false);this.touchDepressPosition=vec3.create();this.touchDepressInterpolator=new CCInterpolatorListV3;this.touchDepressInterpolator.speed=3;this.setTouchDepressRange(1);this.setTouchDepressDepth(3);CC.UpdateCollisions(this);this.createMovementInterpolator(true)};CCTile3DButton.prototype.destruct=function(){this.CCTile3D_destruct()};CCTile3DButton.prototype.setupTile=function(width,height,text){this.setTileSize(width,height);if(text){this.textObject.setText(text,height)}this.setTileTexture("white.png");return this};CCTile3DButton.prototype.setupTextured=function(textureSrc,callback,mipmap){this.setTileSize();this.setTileTexture(textureSrc,function(self,textureHandle){self.setTileTexturedSize();if(callback){callback(self,textureHandle)}});return this};CCTile3DButton.prototype.setupTexturedWidth=function(width,textureSrc,callback,mipmap){this.setTileSize(width);this.setTileTexture(textureSrc,function(self,textureHandle){self.setTileTexturedWidth(width);if(callback){callback(self,textureHandle)}})};CCTile3DButton.prototype.setupTexturedHeight=function(height,textureSrc,callback,mipmap){this.setTileSize();this.setTileTexture(textureSrc,function(self,textureHandle){self.setTileTexturedHeight(height);if(callback){callback(self,textureHandle)}})};CCTile3DButton.prototype.setupTexturedFit=function(width,height,crop,textureSrc,callback,mipmap){this.setTileSize(width,height);this.setTileTexture(textureSrc,function(self,textureHandle){if(textureHandle){self.setTileTexturedFit(width,height,crop,function(){if(callback){callback(self,textureHandle)}})}})};CCTile3DButton.prototype.setupTexture=function(width,textureSrc,mipmap){this.setTileTexture(textureSrc,function(self,textureHandle){if(textureHandle){var aspectRatio=textureHandle.image.width/textureHandle.image.height;var height=width/aspectRatio;self.setTileSize(width,height)}});return this};CCTile3DButton.prototype.setupText=function(text,height,centered,createBackgroundTile){if(centered===undefined){centered=true}this.setText(text);var textObject=this.textObject;textObject.setHeight(height);var width=textObject.getWidth();this.setCollisionBounds(width,height,CC_SMALLFLOAT);textObject.setCentered(centered);if(!centered){this.textObject.setPositionX(-width*.5)}if(createBackgroundTile){this.setTileSize(width,height);this.setTileTexture("white.png")}return this};CCTile3DButton.prototype.refreshModelMatrix=function(){if(this.updateModelMatrix){this.updateModelMatrix=false;CCRenderer.ModelMatrixIdentity(this);CCRenderer.ModelMatrixTranslate(this,this.position);CCRenderer.ModelMatrixTranslate(this,this.touchDepressPosition);CCRenderer.ModelMatrixScale(this,this.scale);var rotation=this.rotation;CCRenderer.ModelMatrixRotate(this,rotation[0],[1,0,0]);CCRenderer.ModelMatrixRotate(this,rotation[1],[0,1,0]);CCRenderer.ModelMatrixRotate(this,rotation[2],[0,0,1])}};CCTile3DButton.prototype.update=function(delta){if(this.visibleOnlyUpdate&&!this.visible){return false}var updated=this.CCTile3D_update(delta);if(this.scale){if(this.tileScaleInterpolator.updating){if(this.tileScaleInterpolator.update(delta)){this.tileScaleInterpolator.update(delta);this.dirtyModelMatrix();updated=true}}}if(this.touchDepressRange>0){if(this.touchDepressInterpolator.updating){if(this.touchDepressInterpolator.update(delta)){this.dirtyModelMatrix()}}}if(this.tileRotationInterpolator){if(this.tileRotationInterpolator.updating){if(this.tileRotationInterpolator.interpolators.length>0){if(this.tileRotationInterpolator.update(delta)){this.dirtyModelMatrix();updated=true}}}}if(this.touching){this.touchingTime+=delta}else if(this.touchReleased){if(this.touchDepressInterpolator.finished()){this.handleTouchRelease()}}if(this.model3dAnimationSpeed&&this.model3dAnimationSpeed>0&&this.model3dObject){if(this.model3dObject.model){this.model3dObject.model.animate(delta*this.model3dAnimationSpeed)}}return updated};CCTile3DButton.prototype.setTileSize=function(width,height,depth){gRenderer.pendingRender=true;if(!width){width=1}if(!height){height=width}if(this.tileSquares.length===0){this.tileSquares.push(new CCPrimitiveSquare);this.tileModel.addPrimitive(this.tileSquares[0])}if(depth===undefined){this.setCollisionBounds(width,height,CC_SMALLFLOAT)}else{this.setCollisionBounds(width,height,depth)}CC.UpdateCollisions(this);for(var i=0;i<this.tileSquares.length;++i){this.tileSquares[i].setScale(width,height,1)}if(this.textObject){if(!this.textObject.centered){this.textObject.setPositionX(-width*.5)}if(this.textScale!==undefined){this.textObject.setHeight(this.collisionSize.height*this.textScale)}}this.resize3DModel()};CCTile3DButton.prototype.setTileTexture=function(src,callback,mipmap){if(this.tileSquares.length===0){this.setTileSize(1)}if(!src){src=this.getTileTextureFilename()}if(src){this.tileSquares[0].setTexture(src);var self=this;this.loading=true;gEngine.textureManager.getTextureHandle(src,function(textureHandle){delete self.loading;if(callback){callback(self,textureHandle)}})}};CCTile3DButton.prototype.setTileTextureIndex=function(src,index){while(this.tileSquares.length<index+1){var newIndex=this.tileSquares.length;this.tileSquares.push(new CCPrimitiveSquare);this.tileModel.addPrimitive(this.tileSquares[newIndex])}this.tileSquares[index].setTexture(src);this.setTileSize(this.collisionSize.width,this.collisionSize.height)};CCTile3DButton.prototype.getTileTextureImage=function(){if(this.tileSquares.length>0){return this.tileSquares[0].getTextureImage()}return null};CCTile3DButton.prototype.getTileTextureHandle=function(){if(this.tileSquares.length>0){return this.tileSquares[0].getTextureHandle()}return null};CCTile3DButton.prototype.getTileTextureFilename=function(){var textureHandle=this.getTileTextureHandle();if(textureHandle){return textureHandle.filename}return null};CCTile3DButton.prototype.removeTileTexture=function(){if(this.tileSquares.length>0){this.tileSquares[0].removeTexture();return true}};CCTile3DButton.prototype.setTileTexturedSize=function(){if(this.tileSquares.length>0){var texture=this.tileSquares[0].getTextureImage();if(texture){this.setTileSize(texture.width,texture.height);return true}}};CCTile3DButton.prototype.setTileTexturedWidth=function(width){if(this.tileSquares.length>0){var texture=this.tileSquares[0].getTextureImage();if(texture){var aspectRatio=texture.width/texture.height;var height=width/aspectRatio;this.setTileSize(width,height);return true}}return false};CCTile3DButton.prototype.setTileTexturedHeight=function(height){if(this.tileSquares.length>0){var texture=this.tileSquares[0].getTextureImage();if(texture){var aspectRatio=texture.width/texture.height;var width=height*aspectRatio;this.setTileSize(width,height);return true}}return false};CCTile3DButton.prototype.setTileTexturedFit=function(width,height,crop,callback){if(crop===undefined){crop=false}if(this.tileSquares.length>0){var texture=this.tileSquares[0].getTextureImage();if(texture){var targetAspectRatio=width/height;var textureAspectRatio=texture.width/texture.height;if(crop){if(textureAspectRatio<targetAspectRatio){this.setTileTexturedWidth(width)}else{this.setTileTexturedHeight(height)}}else{if(textureAspectRatio>targetAspectRatio){this.setTileTexturedWidth(width)}else{this.setTileTexturedHeight(height)}}if(callback){callback()}}}};CCTile3DButton.prototype.set3DModelAnimationSpeed=function(speed){this.model3dAnimationSpeed=speed};CCTile3DButton.prototype.set3DModelRotation=function(rotationVector){if(this.model3dObject){if(typeof rotationVector==="string"){rotationVector=vec3.fromString(rotationVector)}this.model3dObject.setRotation(rotationVector)}};CCTile3DButton.prototype.set3DModel=function(obj,tex,priority,onLoad){var self=this;if(!this.model3dObject){this.model3dObject=new CCObject;this.addChild(this.model3dObject);this.model3dObject.setColour(gColour.set(1,1));this.model3dObject.setTransparent()}this.model3dObject.obj=obj;this.model3dObject.tex=tex;if(tex){gEngine.textureManager.getTextureHandle(tex)}if(priority===undefined){priority=0}var LoadedFunction=function(obj,tex){return function(model3d){if(model3d){if(obj===self.model3dObject.obj&&tex===self.model3dObject.tex){self.model3dObject.setModel(model3d);if(self.model3dObject.tex){model3d.setTexture(self.model3dObject.tex)}self.resize3DModel();if(onLoad){onLoad()}}}}};CCModel3D.CacheModel(obj,true,new LoadedFunction(obj,tex),priority)};CCTile3DButton.prototype.resize3DModel=function(){if(this.model3dObject){if(this.model3dObject.model){var model3d=this.model3dObject.model;var primitive=model3d.getPrimitive();if(primitive){{var size=this.collisionSize.width*.75;var scaleFactor;var modelWidth=model3d.getWidth()>model3d.getDepth()?model3d.getWidth():model3d.getDepth();var modelHeight=model3d.getHeight();if(modelWidth>modelHeight){scaleFactor=size/modelWidth}else{scaleFactor=size/modelHeight}model3d.setScale(scaleFactor)}}}}};CCTile3DButton.prototype.get3DModelFilename=function(){if(this.model3dObject){return this.model3dObject.obj}return false};CCTile3DButton.prototype.get3DModelTextureFilename=function(){if(this.model3dObject){return this.model3dObject.tex}return false};CCTile3DButton.prototype.getTileColour=function(){var colour=this.tileModel.getColour();if(colour){return colour}return gColour.set(1,1)};CCTile3DButton.prototype.setTileScale=function(inScale,interpolate,onInterpolated){if(typeof inScale==="number"){inScale=vec3.clone([inScale,inScale,inScale])}if(this.scale&&interpolate){this.tileScaleInterpolator.setup(this.scale,inScale,onInterpolated)}else{this.setScale(inScale);this.tileScaleInterpolator.setup(this.scale);this.dirtyModelMatrix()}};CCTile3DButton.prototype.getTileSquare=function(){if(this.tileSquares.length>0){return this.tileSquares[0]}return null};CCTile3DButton.prototype.setText=function(text,resizeTile,fontHeight){text=""+text;if(!this.textObject){this.textObject=new CCObjectText(this)}if(!fontHeight){if(this.textScale!==undefined){fontHeight=this.collisionSize.height*this.textScale}}var textObject=this.textObject;textObject.setText(text,fontHeight);if(resizeTile){var width=textObject.getWidth();var height=textObject.getHeight();this.setCollisionBounds(width,height,CC_SMALLFLOAT);CC.UpdateCollisions(this);for(var i=0;i<this.tileSquares.length;++i){this.tileSquares[i].setScale(width,height,1)}}};CCTile3DButton.prototype.removeText=function(){if(this.textObject){this.removeChild(this.textObject);this.textObject.destruct();delete this.textObject}};CCTile3DButton.prototype.getText=function(){if(this.textObject){return this.textObject.getText()}else{return null}};CCTile3DButton.prototype.setTextPosition=function(x,y,z){if(x!==undefined){this.textObject.setPositionX(x)}if(y!==undefined){this.textObject.setPositionY(y)}if(z!==undefined){this.textObject.setPositionZ(z)}};CCTile3DButton.prototype.setTextScale=function(scale){this.textScale=scale;if(this.textObject){this.textObject.setHeight(this.collisionSize.height*scale)}};CCTile3DButton.prototype.setTextHeight=function(height,resizeTile){if(this.textObject){this.textObject.setHeight(height);if(resizeTile){var width=this.textObject.getWidth();this.setCollisionBounds(width,height,CC_SMALLFLOAT);CC.UpdateCollisions(this);for(var i=0;i<this.tileSquares.length;++i){this.tileSquares[i].setScale(width,height,1)}}}};CCTile3DButton.prototype.setBlinking=function(toggle){if(toggle){var self=this;var AnimationFunction=function(){var currentAlpha=self.getColourInterpolator().getTarget().a;self.setColourAlpha(currentAlpha===1?.5:1,true,AnimationFunction)};this.setColourAlpha(1,true,AnimationFunction)}else{this.setColourAlpha(1,true)}};CCTile3DButton.prototype.isBlinking=function(){if(this){if(this.colourInterpolator){if(this.colourInterpolator.onInterpolated.length>0){return true}}}return false};CCTile3DButton.prototype.setTextBlinking=function(toggle){if(toggle){var self=this;var AnimationFunction=function(){var currentAlpha=self.textObject.getColourInterpolator().getTarget().a;self.setTextColourAlpha(currentAlpha===1?.5:1,true,AnimationFunction)};this.setTextColourAlpha(1,true,AnimationFunction)}else{this.setTextColourAlpha(1,true)}};CCTile3DButton.prototype.isTextBlinking=function(){if(this.textObject){if(this.textObject.colourInterpolator){if(this.textObject.colourInterpolator.onInterpolated.length>0){return true}}}return false};CCTile3DButton.prototype.setTextColour=function(colour,interpolate){if(this.textObject){if(interpolate){this.textObject.getColourInterpolator().setDuration(.5)}this.textObject.setColour(colour,interpolate)}};CCTile3DButton.prototype.setTextColourAlpha=function(inAlpha,interpolate,inCallback){if(this.textObject){if(interpolate){this.textObject.getColourInterpolator().setDuration(.5)}this.textObject.setColourAlpha(inAlpha,interpolate,inCallback)}};CCTile3DButton.prototype.resetTileUVs=function(){for(var i=0;i<this.tileSquares.length;++i){var tileSquare=this.tileSquares[i];if(tileSquare.customUVs){delete tileSquare.customUVs;tileSquare.adjustTextureUVs()}}};CCTile3DButton.prototype.flipTileX=function(){this.flippedX=!this.flippedX;for(var i=0;i<this.tileSquares.length;++i){var tileSquare=this.tileSquares[i];tileSquare.flipX()}};CCTile3DButton.prototype.flipTileY=function(){this.flippedY=!this.flippedY;for(var i=0;i<this.tileSquares.length;++i){var tileSquare=this.tileSquares[i];tileSquare.flipY()}};CCTile3DButton.prototype.handleProjectedTouch=function(cameraProjectionResults,hitObject,hitPosition,touch,touchAction){if(!this.collisionsEnabled){return false}if(hitObject===this){if(!this.touching){if(touchAction===CCControls.touch_pressed){this.touching=true;if(this.touchMovementAllowed){this.touchPosition=vec3.clone(this.position)}this.touchingTime=0;this.onTouchPress(touch)}}}if(this.touching){var maxTimeHeld=.125;if(touchAction===CCControls.touch_pressed){this.touchActionPressed(touchAction,hitPosition)}else if(this.touchMovementAllowed&&CCControls.TouchActionMoving(touchAction)){this.touchMoved=true;{this.touchActionPressed(touchAction,hitPosition)}return true}else{if(touchAction===CCControls.touch_released){if(!this.touchMovementAllowed){var absDeltaX=Math.abs(touch.totalDeltaX);var absDeltaY=Math.abs(touch.totalDeltaY);if(hitObject!==this||absDeltaX>CCControls.TouchMovementThreashold.x||absDeltaY>CCControls.TouchMovementThreashold.y){return this.handleProjectedTouch(cameraProjectionResults,hitObject,hitPosition,touch,CCControls.touch_lost)}}this.touchActionPressed(CCControls.touch_released,hitPosition)}this.touchActionRelease(touchAction);this.touching=false;if(this.touchMoved){this.touchMoved=false}if(touchAction===CCControls.touch_released){return true}}}return false};CCTile3DButton.RelativeHitPositionVector=vec3.create();CCTile3DButton.prototype.touchActionPressed=function(touchAction,hitPosition){var position=this.position;var collisionBounds=this.collisionBounds;if(this.touchDepressRange>0){this.touchDepressInterpolator.pushV3(this.touchDepressPosition,vec3.clone([0,0,-this.touchDepressDepth]),true)}if(touchAction>CCControls.touch_pressed&&touchAction<CCControls.touch_released){this.onTouchMove(hitPosition)}};CCTile3DButton.prototype.touchActionRelease=function(touchAction){if(touchAction===CCControls.touch_released){this.onTouchLoss(false);if(!this.touchMoved){this.touchReleased=true}else{this.handleTouchRelease()}}else{this.onTouchLoss(true);this.handleTouchRelease()}};CCTile3DButton.prototype.handleTouchRelease=function(){if(this.touchReleased){this.touchReleased=false;this.onTouchRelease()}if(this.touchDepressRange>0){this.touchDepressInterpolator.pushV3(this.touchDepressPosition,vec3.create(),true)}};CCTile3DButton.prototype.allowTouchRotation=function(allow){this.touchRotationAllowed=allow};CCTile3DButton.prototype.allowTouchMovement=function(allow){this.touchMovementAllowed=allow};CCTile3DButton.prototype.setTouchRotationSpeed=function(speed){this.touchRotationSpeed=speed};CCTile3DButton.prototype.setTouchDepressRange=function(range){this.touchDepressRange=range};CCTile3DButton.prototype.setTouchDepressDepth=function(depth){this.touchDepressDepth=depth};CCTile3DButton.prototype.getTileScaleInterpolator=function(){return this.tileScaleInterpolator};CCTile3DButton.prototype.getColourInterpolator=function(){if(!this.colourInterpolator){this.colourInterpolator=new CCInterpolatorColour;this.colourInterpolator.setDuration(.5);if(this.colour){this.colourInterpolator.setup(this.colour,this.colour)}}return this.colourInterpolator};function CCObjectSkybox(scene){this.construct();this.interpolating=false;this.renderPass=CCRenderer.render_background;this.setScene(scene)}ExtendPrototype(CCObjectSkybox,CCObject);CCObjectSkybox.prototype.setup=function(size,north,east,south,west,top,bottom){this.setModel(new CCModelBase);this.setColour(gColour.white());var hSize=size*.5;this.size=size;var squarePrimitive;if(north){squarePrimitive=new CCPrimitiveSquare;squarePrimitive.setupPoints(-hSize,hSize,-hSize,hSize,-hSize,hSize,-hSize,-hSize);this.model.addPrimitive(squarePrimitive);squarePrimitive.setTexture(north,true,true)}if(east){squarePrimitive=new CCPrimitiveSquare;squarePrimitive.setupSideFacing(hSize,size,size);this.model.addPrimitive(squarePrimitive);squarePrimitive.setTexture(east,true,true);squarePrimitive.flipY()}if(south){squarePrimitive=new CCPrimitiveSquare;squarePrimitive.setupPoints(-hSize,hSize,-hSize,hSize,-hSize,hSize,hSize,hSize);this.model.addPrimitive(squarePrimitive);squarePrimitive.setTexture(south,true,true)}if(west){squarePrimitive=new CCPrimitiveSquare;squarePrimitive.setupSideFacing(-hSize,size,size);this.model.addPrimitive(squarePrimitive);squarePrimitive.setTexture(west,true,true);squarePrimitive.flipY()}if(top){squarePrimitive=new CCPrimitiveSquare;squarePrimitive.setupUpFacing(size,size,hSize,true,-1);this.model.addPrimitive(squarePrimitive);squarePrimitive.setTexture(top,true,true)}if(bottom){squarePrimitive=new CCPrimitiveSquare;squarePrimitive.setupUpFacing(size,size,-hSize,true,1);this.model.addPrimitive(squarePrimitive);squarePrimitive.setTexture(bottom,true,true)}};CCObjectSkybox.prototype.update=function(delta){var updated=false;
if(this.scaleInterpolator){var speed=delta*.5;if(this.scaleInterpolator.update(speed)){this.dirtyModelMatrix();updated=true}if(!updated){delete this.scaleInterpolator}}return this.CCObject_update(delta)||updated};CCObjectSkybox.prototype.renderModel=function(alpha){if(alpha===this.transparent){var renderer=gRenderer;renderer.CCSetCulling(false);renderer.CCSetDepthRead(false);this.CCObject_renderModel(alpha);renderer.CCSetDepthRead(true);renderer.CCSetCulling(true)}};CCObjectSkybox.prototype.animateToScale=function(startScale){this.interpolating=true;this.setScale(startScale);if(!this.scaleInterpolator){this.scaleInterpolator=new CCInterpolatorV3(CCInterpolatorSin2Curve)}this.scaleInterpolator.setup(this.scale,1)};function CCObjectText(inParent){this.jsID=CCObjectText.NextID++;this.construct();this.height=1;this.setColour(gColour.set(0));this.setTransparent(true);this.setReadDepth(false);this.shader="alphacolour";this.centered=true;if(inParent){inParent.addChild(this)}}ExtendPrototype(CCObjectText,CCObject);CCObjectText.NextID=0;CCObjectText.prototype.renderObject=function(camera,alpha){if(this.shouldRender&&alpha){var renderer=gRenderer;CCRenderer.GLPushMatrix();{if(this.updateModelMatrix){this.refreshModelMatrix()}CCRenderer.GLMultMatrix(this.modelMatrix);if(this.colour){renderer.CCSetColour(this.colour)}if(!alpha||renderer.colour.a>0){var text=this.text;var height=this.height;var fontPage=this.fontPage;fontPage.renderText(text,text.length,height,this.centered);if(this.endMarker){gEngine.textureManager.setTextureIndex(1);var x=(fontPage.getWidth(text,text.length,height)+fontPage.getCharacterWidth(" ",height))*.5;var y=height*.45;var start=vec3.clone([x,-y,0]);var end=vec3.clone([x,y,0]);renderer.CCRenderLine(start,end)}}}CCRenderer.GLPopMatrix()}};CCObjectText.prototype.getText=function(){return this.text};CCObjectText.prototype.setText=function(text,height,font){if(!text){text=""}this.text=text;gRenderer.pendingRender=true;if(height){this.setHeight(height)}if(font){this.setFont(font)}else{this.setFont("HelveticaNeueLight")}};CCObjectText.prototype.getWidth=function(){var text=this.text;return this.fontPage.getWidth(text,text.length,this.height)};CCObjectText.prototype.getHeight=function(){var text=this.text;return this.fontPage.getHeight(text,text.length,this.height)};CCObjectText.prototype.setHeight=function(height){if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCObjectText.setHeight;"+this.jsID+";"+height+"\n"}this.height=height};CCObjectText.prototype.setCentered=function(centered){if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCObjectText.setCentered;"+this.jsID+";"+centered+"\n"}if(centered){this.setPositionX(0)}else if(this.parent){this.setPositionX(-this.parent.collisionBounds[0])}this.centered=centered};CCObjectText.prototype.setFont=function(font){if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCObjectText.setFont;"+this.jsID+";"+font+"\n"}var fontPages=gEngine.textureManager.fontPages;var length=fontPages.length;for(var i=0;i<length;++i){var page=fontPages[i];if(font===page.name){this.fontPage=page;return}}};CCObjectText.prototype.setEndMarker=function(toggle){if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCObjectText.setEndMarker;"+this.jsID+";"+toggle+"\n"}this.endMarker=toggle};CCObjectText.prototype.getEndMarker=function(){return!!this.endMarker};function CCTextureFontPageFile(inName){function Letter(){this.start=new CCPoint;this.end=new CCPoint;this.size=new CCSize}var letters=this.letters=[];var i;for(i=0;i<256;++i){letters.push(new Letter)}this.name=inName;var MAX_TEXT_LINES=this.MAX_TEXT_LINES=8;var MAX_TEXT_LENGTH=512;var lineSize=this.lineSize=[];for(i=0;i<MAX_TEXT_LINES;++i){lineSize.push(new CCPoint)}var charSize=this.charSize=[];var startPositions=this.startPositions=[];for(i=0;i<MAX_TEXT_LINES;++i){charSize[i]=[];startPositions[i]=new CCPoint;for(var j=0;j<MAX_TEXT_LENGTH;++j){charSize[i][j]=new CCPoint}}this.currentStart=vec3.create();this.currentEnd=vec3.create();this.cachedMeshes=[];this.loaded=false}CCTextureFontPageFile.prototype.load=function(){var self=this;var textureURL=this.name+".png";this.texturePageIndex=gEngine.textureManager.assignTextureIndex(textureURL,true);var csvFile=this.name+".csv";var dataURL=MultiplayerManager.GetAssetURL(csvFile);gURLManager.requestURL(dataURL,null,function(status,responseText){if(status>=CCURLRequest.Succeeded){var letters=self.letters;var lettersSplit=responseText.split("\n");for(var i=0;i<lettersSplit.length;++i){var rawLetterData=lettersSplit[i];var letterDataSplit=rawLetterData.split(",");var letter=letters[i];letter.start.x=parseFloat(letterDataSplit[0]);letter.start.y=parseFloat(letterDataSplit[1]);letter.end.x=parseFloat(letterDataSplit[2]);letter.end.y=parseFloat(letterDataSplit[3]);letter.size.width=(letter.end.x-letter.start.x)*16;letter.size.height=(letter.end.y-letter.start.y)*16;letter.start.y=letter.start.y;letter.end.y=letter.end.y}self.loaded=true;gEngine.resize()}},1,csvFile);return true};CCTextureFontPageFile.prototype.bindTexturePage=function(){gEngine.textureManager.setTextureIndex(this.texturePageIndex)};CCTextureFontPageFile.prototype.getLetter=function(character){var asciiCharacter=character.charCodeAt(0);if(asciiCharacter>=0){return this.letters[asciiCharacter]}else if(asciiCharacter===-62){return this.letters[128]}return false};CCTextureFontPageFile.prototype.getCharacterWidth=function(character,size){if(character==="\n"){}else{var letter=this.getLetter(character);if(letter){return letter.size.width*size}}return 0};CCTextureFontPageFile.prototype.getWidth=function(text,length,size){var totalWidth=0;for(var i=0;i<length;++i){var character=text[i];if(character==="\n"){break}else{var letter=this.getLetter(character);if(letter){totalWidth+=letter.size.width*size}}}return totalWidth};CCTextureFontPageFile.prototype.getHeight=function(text,length,size){var maxHeight=0;for(var i=0;i<length;++i){var letter=this.getLetter(text[i]);if(letter){maxHeight=Math.max(maxHeight,letter.size.height*size)}}return maxHeight};CCTextureFontPageFile.prototype.renderText=function(text,length,height,centeredX){if(!this.loaded){return}if(length<1){return}var mesh=this.getTextMesh(text,length,height,centeredX);var renderer=gRenderer;CCRenderer.GLPushMatrix();{CCRenderer.GLTranslate([0,mesh.totalLineHeight*.5,0]);this.bindTexturePage();renderer.CCBindVertexTextureBuffer(mesh.vertexTextureBuffer);renderer.CCBindVertexPositionBuffer(mesh.vertexPositionBuffer);renderer.CCSetRenderStates();renderer.GLDrawArrays("TRIANGLES",0,mesh.vertexCount)}CCRenderer.GLPopMatrix()};CCTextureFontPageFile.prototype.getTextMesh=function(text,length,height,centeredX){var cachedMeshes=this.cachedMeshes;var i,mesh;for(i=0;i<cachedMeshes.length;++i){mesh=cachedMeshes[i];if(mesh.textHeight===height){if(mesh.centeredX===centeredX){if(mesh.text.length===length){if(mesh.text===text){mesh.lastDrawTime=gEngine.lifetime;return mesh}}}}}if(cachedMeshes.length>100){var oldestRenderTime=CC_MAXFLOAT;var oldestRender=null;for(i=0;i<cachedMeshes.length;++i){mesh=cachedMeshes[i];if(mesh.lastDrawTime<oldestRenderTime){oldestRenderTime=mesh.lastDrawTime;oldestRender=mesh}}if(oldestRender){cachedMeshes.remove(oldestRender);gRenderer.CCDeleteVertexBuffer(oldestRender.vertexPositionBuffer);gRenderer.CCDeleteVertexBuffer(oldestRender.vertexTextureBuffer)}}mesh=this.buildTextMesh(text,length,height,centeredX);cachedMeshes.add(mesh);mesh.lastDrawTime=gEngine.lifetime;return mesh};CCTextureFontPageFile.prototype.buildTextMesh=function(text,length,height,centeredX){var i,character,letter,size,start;var totalLineHeight=0;var lineSize=this.lineSize;lineSize[0].x=lineSize[0].y=0;var charSize=this.charSize;var lineIndex=0;var characterIndex=0;for(i=0;i<length;++i){character=text[i];{letter=this.getLetter(character);if(letter){size=charSize[lineIndex][characterIndex];size.x=letter.size.width*height;size.y=letter.size.height*height;lineSize[lineIndex].x+=size.x;lineSize[lineIndex].y=Math.max(lineSize[lineIndex].y,size.y);characterIndex++}}if(character==="\n"){totalLineHeight+=lineSize[lineIndex].y;lineIndex++;lineSize[lineIndex].x=lineSize[lineIndex].y=0;characterIndex=0}}totalLineHeight+=lineSize[lineIndex].y;var startPositions=this.startPositions;for(i=0;i<lineIndex+1;++i){start=startPositions[i];start.x=0;start.y=0;if(centeredX){start.x-=lineSize[i].x*.5}for(var j=0;j<i;++j){start.y-=lineSize[j].y}}var currentStart=this.currentStart;var currentEnd=this.currentEnd;currentStart[0]=startPositions[0].x;currentStart[1]=startPositions[0].y;var vertices=new CCRenderer.Float32Array(3*6*length);var uvs=new CCRenderer.Float32Array(2*6*length);var vertexIndex=0;var texCoordIndex=0;lineIndex=0;characterIndex=0;for(i=0;i<length;++i){character=text[i];{letter=this.getLetter(character);if(letter){size=charSize[lineIndex][characterIndex];currentEnd[0]=currentStart[0]+size.x;currentEnd[1]=currentStart[1]-size.y;{vertices[vertexIndex++]=currentStart[0];vertices[vertexIndex++]=currentEnd[1];vertices[vertexIndex++]=0;uvs[texCoordIndex++]=letter.start.x;uvs[texCoordIndex++]=letter.end.y;vertices[vertexIndex++]=currentEnd[0];vertices[vertexIndex++]=currentEnd[1];vertices[vertexIndex++]=0;uvs[texCoordIndex++]=letter.end.x;uvs[texCoordIndex++]=letter.end.y;vertices[vertexIndex++]=currentStart[0];vertices[vertexIndex++]=currentStart[1];vertices[vertexIndex++]=0;uvs[texCoordIndex++]=letter.start.x;uvs[texCoordIndex++]=letter.start.y}{vertices[vertexIndex++]=currentEnd[0];vertices[vertexIndex++]=currentEnd[1];vertices[vertexIndex++]=0;uvs[texCoordIndex++]=letter.end.x;uvs[texCoordIndex++]=letter.end.y;vertices[vertexIndex++]=currentEnd[0];vertices[vertexIndex++]=currentStart[1];vertices[vertexIndex++]=0;uvs[texCoordIndex++]=letter.end.x;uvs[texCoordIndex++]=letter.start.y;vertices[vertexIndex++]=currentStart[0];vertices[vertexIndex++]=currentStart[1];vertices[vertexIndex++]=0;uvs[texCoordIndex++]=letter.start.x;uvs[texCoordIndex++]=letter.start.y}currentStart[0]+=size.x;characterIndex++}}if(character==="\n"){lineIndex++;start=startPositions[lineIndex];currentStart[0]=start.x;currentStart[1]=start.y;characterIndex=0}}var vertexPositionBuffer=gRenderer.CCCreateVertexBuffer(vertices);var vertexTextureBuffer=gRenderer.CCCreateVertexBuffer(uvs,2);var mesh={};mesh.text=text;mesh.textHeight=height;mesh.centeredX=centeredX;mesh.totalLineHeight=totalLineHeight;mesh.vertexPositionBuffer=vertexPositionBuffer;mesh.vertexTextureBuffer=vertexTextureBuffer;mesh.vertexCount=vertexIndex/3;return mesh};function CCPrimitiveBase(){}CCPrimitiveBase.NextID=0;CCPrimitiveBase.prototype.construct=function(){this.primitiveID=CCPrimitiveBase.NextID++;this.textureIndex=-1;this.customUVs=null;this.adjustedUVs=null};CCPrimitiveBase.prototype.destruct=function(){};CCPrimitiveBase.prototype.setTextureIndex=function(index){this.textureIndex=index;if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCPrimitiveBase.setTexture;"+this.primitiveID+";"+this.textureIndex+"\n"}};CCPrimitiveBase.prototype.setTexture=function(src,mipmap,load,alwaysResident,callback){this.tex=src;this.textureIndex=gEngine.textureManager.assignTextureIndex(src);if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCPrimitiveBase.setTexture;"+this.primitiveID+";"+this.textureIndex+"\n"}var self=this;gEngine.textureManager.getTextureHandleIndexAsync(this.textureIndex,function(textureHandle){if(textureHandle&&textureHandle.image){if(self.adjustTextureUVs){self.adjustTextureUVs()}if(callback){callback()}}})};CCPrimitiveBase.prototype.getTextureHandle=function(){if(this.textureIndex>=0){var textureHandle=gEngine.textureManager.getTextureHandleIndex(this.textureIndex);if(textureHandle){return textureHandle}}return null};CCPrimitiveBase.prototype.getTextureImage=function(){var handle=this.getTextureHandle();if(handle&&handle.downloaded&&handle.image){return handle.image}return null};CCPrimitiveBase.prototype.removeTexture=function(){this.textureIndex=-1};CCPrimitiveBase.prototype.render=function(){if(this.textureIndex!==-1){gEngine.textureManager.setTextureIndex(this.textureIndex)}else{gEngine.textureManager.setTextureIndex(1)}this.renderVertices(gRenderer)};CCPrimitiveBase.prototype.renderOutline=function(){};function CCPrimitiveSquare(){this.construct();this.scale=vec3.clone([1,1,1]);if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCPrimitiveSquare.construct;"+this.primitiveID+"\n"}}ExtendPrototype(CCPrimitiveSquare,CCPrimitiveBase);CCPrimitiveSquare.prototype.destruct=function(){if(this.vertexPositionBuffer){gRenderer.CCDeleteVertexBuffer(this.vertexPositionBuffer)}if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCPrimitiveSquare.destruct;"+this.primitiveID+"\n"}this.CCPrimitiveBase_destruct()};CCPrimitiveSquare.prototype.setScale=function(width,height,depth){if(!height){height=width}if(!depth){depth=1}if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCPrimitiveSquare.setScale;"+this.primitiveID+";"+width+";"+height+";"+depth+"\n"}var scale=this.scale;scale[0]=width;scale[1]=height;scale[2]=depth;return this};CCPrimitiveSquare.prototype.render=function(){var renderer=gRenderer;if(this.textureIndex!==-1){gEngine.textureManager.setTextureIndex(this.textureIndex)}else{gEngine.textureManager.setTextureIndex(0)}if(this.adjustedUVs){renderer.CCSetTexCoords(this.adjustedUVs)}else if(this.customUVs){renderer.CCSetTexCoords(this.customUVs)}else{renderer.CCDefaultTexCoords()}this.renderVertices(renderer)};CCPrimitiveSquare.prototype.renderVertices=function(renderer){CCRenderer.GLPushMatrix();CCRenderer.GLScale(this.scale);if(this.vertexPositionBuffer){renderer.CCBindVertexPositionBuffer(this.vertexPositionBuffer)}else{renderer.CCDefaultSquareVertexPointer()}renderer.CCSetRenderStates();renderer.GLDrawArrays("TRIANGLE_STRIP",0,4);CCRenderer.GLPopMatrix()};CCPrimitiveSquare.prototype.renderOutline=function(){CCRenderer.GLPushMatrix();CCRenderer.GLScale(this.scale);gRenderer.CCSetRenderStates();gRenderer.GLDrawElements("LINE_STRIP",4,0);CCRenderer.GLPopMatrix()};CCPrimitiveSquare.prototype.setupPoints=function(tL,tR,bL,bR,bY,tY,bZ,tZ){var vertices=new CCRenderer.Float32Array(3*4);var i=0;vertices[i++]=tR;vertices[i++]=tY;vertices[i++]=tZ;vertices[i++]=tL;vertices[i++]=tY;vertices[i++]=tZ;vertices[i++]=bR;vertices[i++]=bY;vertices[i++]=bZ;vertices[i++]=bL;vertices[i++]=bY;vertices[i++]=bZ;this.vertexPositionBuffer=gRenderer.CCCreateVertexBuffer(vertices);if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCPrimitiveSquare.setVertexBufferID;"+this.primitiveID+";"+this.vertexPositionBuffer+"\n"}};CCPrimitiveSquare.prototype.setupSideFacing=function(x,height,depth){var hHeight=height*.5;var hDepth=depth*.5;var vertices=new CCRenderer.Float32Array(3*4);var i=0;vertices[i++]=x;vertices[i++]=hHeight;vertices[i++]=-hDepth;vertices[i++]=x;vertices[i++]=hHeight;vertices[i++]=hDepth;vertices[i++]=x;vertices[i++]=-hHeight;vertices[i++]=-hDepth;vertices[i++]=x;vertices[i++]=-hHeight;vertices[i++]=hDepth;this.vertexPositionBuffer=gRenderer.CCCreateVertexBuffer(vertices);if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCPrimitiveSquare.setVertexBufferID;"+this.primitiveID+";"+this.vertexPositionBuffer+"\n"}};CCPrimitiveSquare.prototype.setupUpFacing=function(width,depth,yPosition,useNormals,direction){var hWidth=width*.5;var hDepth=depth*.5;var vertices=new CCRenderer.Float32Array(3*4);vertices[0]=hWidth;vertices[1]=yPosition;vertices[2]=-hDepth;vertices[3]=-hWidth;vertices[4]=yPosition;vertices[5]=-hDepth;vertices[6]=hWidth;vertices[7]=yPosition;vertices[8]=hDepth;vertices[9]=-hWidth;vertices[10]=yPosition;vertices[11]=hDepth;this.vertexPositionBuffer=gRenderer.CCCreateVertexBuffer(vertices);if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCPrimitiveSquare.setVertexBufferID;"+this.primitiveID+";"+this.vertexPositionBuffer+"\n"}if(useNormals){}};CCPrimitiveSquare.prototype.adjustTextureUVs=function(){if(this.textureIndex>=0){var textureHandle=gEngine.textureManager.getTextureHandleIndex(this.textureIndex);var textureImage=textureHandle.image;if(textureImage){if(textureImage.allocatedWidth&&textureImage.allocatedHeight){var width=textureImage.width;var height=textureImage.height;var allocatedWidth=textureImage.allocatedWidth;var allocatedHeight=textureImage.allocatedHeight;if(width===allocatedWidth&&height===allocatedHeight){if(this.adjustedUVs){delete this.adjustedUVs}}else{if(this.customUVs){var uvs=this.customUVs;var x2=uvs[0];var y1=uvs[1];var x1=uvs[2];var y2=uvs[5];var widthScale=width/allocatedWidth;var heightScale=height/allocatedHeight;this.setAdjustedUVs(x1*widthScale,y1*heightScale,x2*widthScale,y2*heightScale)}else{this.setAdjustedUVs(0,0,width/allocatedWidth,height/allocatedHeight)}}}else{if(this.adjustedUVs){delete this.adjustedUVs}}}}};CCPrimitiveSquare.prototype.setAdjustedUVs=function(x1,y1,x2,y2){if(!this.adjustedUVs){this.adjustedUVs=new CCRenderer.Float32Array(8)}var uvs=this.adjustedUVs;uvs[0]=x2;uvs[1]=y1;uvs[2]=x1;uvs[3]=y1;uvs[4]=x2;uvs[5]=y2;uvs[6]=x1;uvs[7]=y2};CCPrimitiveSquare.prototype.setTextureUVs=function(x1,y1,x2,y2){if(!this.customUVs){this.customUVs=new CCRenderer.Float32Array(8)}var uvs=this.customUVs;uvs[0]=x2;uvs[1]=y1;uvs[2]=x1;uvs[3]=y1;uvs[4]=x2;uvs[5]=y2;uvs[6]=x1;uvs[7]=y2;this.adjustTextureUVs()};CCPrimitiveSquare.prototype.flipX=function(){if(!this.customUVs){this.setTextureUVs(0,0,1,1)}var uvs=this.customUVs;var y1=uvs[1];var y2=uvs[5];uvs[1]=y2;uvs[3]=y2;uvs[5]=y1;uvs[7]=y1;this.adjustTextureUVs()};CCPrimitiveSquare.prototype.flipY=function(){if(!this.customUVs){this.setTextureUVs(0,0,1,1)}var uvs=this.customUVs;var x1=uvs[0];var x2=uvs[2];uvs[0]=x2;uvs[4]=x2;uvs[2]=x1;uvs[6]=x1;this.adjustTextureUVs()};window.gRenderer=null;function CCRenderer(){}CCRenderer.render_all=1;CCRenderer.render_collisionBoxes=2;CCRenderer.render_collisionTrees=4;CCRenderer.render_pathFinder=8;CCRenderer.render_background=0;CCRenderer.render_main=1;CCRenderer.render_post=2;CCRenderer.render_finished=3;CCRenderer.NewArrayType=function(array,ArrayType){var newArray=new ArrayType(array.length);for(var i=0;i<array.length;++i){newArray[i]=array[i]}return newArray};CCRenderer.prototype.CCDefaultSquareVertexPointer=function(){this.CCBindVertexPositionBuffer(this.defaultSquareVertexBuffer)};CCRenderer.prototype.CCRenderLine=function(start,end){this.CCSetRenderStates();this.CCDefaultTexCoords();if(!this.linePositionBuffer){this.linePositionBuffer=this.CCCreateVertexBuffer()}var vertices=[start[0],start[1],start[2],end[0],end[1],end[2]];this.CCUpdateVertexBuffer(this.linePositionBuffer,CCRenderer.NewArrayType(vertices,CCRenderer.Float32Array));this.CCBindVertexPositionBuffer(this.linePositionBuffer);this.GLDrawArrays("LINES",0,2)};CCRenderer.prototype.CCRenderCube=function(outline){this.CCSetRenderStates();if(!this.cubeTextureBuffer){var textureCoords=[1,1,0,1,1,0,0,0,1,1,0,1,1,0,0,0];this.cubeTextureBuffer=this.CCCreateVertexBuffer(CCRenderer.NewArrayType(textureCoords,CCRenderer.Float32Array),2)}this.CCBindVertexTextureBuffer(this.cubeTextureBuffer);if(!this.cubePositionBuffer){var vertices=[-.5,-.5,-.5,.5,-.5,-.5,-.5,.5,-.5,.5,.5,-.5,-.5,-.5,.5,.5,-.5,.5,-.5,.5,.5,.5,.5,.5];this.cubePositionBuffer=this.CCCreateVertexBuffer(CCRenderer.NewArrayType(vertices,CCRenderer.Float32Array))}this.CCBindVertexPositionBuffer(this.cubePositionBuffer);var faces;if(outline){faces=[0,1,3,2,0,4,5,1,5,7,3,7,6,2,6,4];if(!this.cubeOutlineIndexBuffer){this.cubeOutlineIndexBuffer=this.CCCreateVertexIndexBuffer(CCRenderer.NewArrayType(faces,CCRenderer.Uint16Array))}this.CCBindVertexIndexBuffer(this.cubeOutlineIndexBuffer);this.GLDrawElements("LINE_STRIP",faces.length,0)}else{faces=[0,1,2,3,7,1,5,4,7,6,2,4,0,1];if(!this.cubeIndexBuffer){this.cubeIndexBuffer=this.CCCreateVertexIndexBuffer(CCRenderer.NewArrayType(faces,CCRenderer.Uint16Array))}this.CCBindVertexIndexBuffer(this.cubeIndexBuffer);this.GLDrawElements("TRIANGLE_STRIP",faces.length,0)}};function CCModelBase(){this.construct()}ExtendPrototype(CCModelBase,CCRenderable);CCModelBase.prototype.construct=function(){this.CCRenderable_construct();this.primitives=[];this.models=[];if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCModelBase.construct;"+this.jsID+"\n"}};CCModelBase.prototype.destruct=function(){var i;{var models=this.models;for(i=0;i<models.length;++i){models[i].destruct()}models.length=0}{var primitives=this.primitives;for(i=0;i<primitives.length;++i){primitives[i].destruct()}primitives.length=0}this.CCRenderable_destruct();if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCModelBase.destruct;"+this.jsID+"\n"}};CCModelBase.prototype.render=function(alpha){if(this.shouldRender){var renderer=gRenderer;if(CCEngine.NativeRenderCommands!==undefined){renderer.unbindBuffers();CCEngine.NativeRenderCommands+="CCModelBase.render;"+this.jsID+";"+alpha+"\n";return}CCRenderer.GLPushMatrix();{if(this.updateModelMatrix){this.refreshModelMatrix()}CCRenderer.GLMultMatrix(this.modelMatrix);var primitives=this.primitives;var primitivesLength=primitives.length;if(this.colour){renderer.CCSetColour(this.colour)}if(!alpha||renderer.colour.a>0){for(var primitiveIndex=0;primitiveIndex<primitivesLength;++primitiveIndex){primitives[primitiveIndex].render()}}var models=this.models;var length=models.length;for(var modelIndex=0;modelIndex<length;++modelIndex){models[modelIndex].render(alpha);if(this.colour){renderer.CCSetColour(this.colour)}}}CCRenderer.GLPopMatrix()}};CCModelBase.prototype.addModel=function(model){this.models.push(model);if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCModelBase.addModel;"+this.jsID+";"+model.jsID+"\n"}};CCModelBase.prototype.removeModel=function(model){this.models.remove(model);if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCModelBase.removeModel;"+this.jsID+";"+model.jsID+"\n"}};CCModelBase.prototype.addPrimitive=function(primitive){this.primitives.push(primitive);if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCModelBase.addPrimitive;"+this.jsID+";"+primitive.primitiveID+"\n"}};function CCModel3D(){this.construct()}ExtendPrototype(CCModel3D,CCModelBase);CCModel3D.prototype.construct=function(){this.CCModelBase_construct();this.primitive=null};CCModel3D.prototype.getPrimitive=function(){return this.primitive};CCModel3D.prototype.getWidth=function(){return this.primitive.getWidth()};CCModel3D.prototype.getHeight=function(){return this.primitive.getHeight()};CCModel3D.prototype.getDepth=function(){return this.primitive.getDepth()};CCModel3D.prototype.getOrigin=function(){return this.primitive.getOrigin()};CCModel3D.prototype.moveVerticesToOrigin=function(callback){this.primitive.moveVerticesToOrigin(callback)};CCModel3D.prototype.setTexture=function(file,mipmap,load){if(file){this.primitive.setTexture(file,mipmap,true,load)}};CCModel3D.prototype.removeTexture=function(){this.primitive.removeTexture()};CCModel3D.prototype.getAnimations=function(){if(this.primitive.animations){return this.primitive.animations}return null};CCModel3D.prototype.getAnimation=function(){if(this.primitive.getAnimation){return this.primitive.getAnimation()}return 0};CCModel3D.prototype.getAnimationFrame=function(){if(this.primitive.getAnimationFrame){return this.primitive.getAnimationFrame()}return-1};CCModel3D.prototype.getAnimationFPSCompression=function(){if(this.primitive.getAnimationFPSCompression){return this.primitive.getAnimationFPSCompression()}return 0};CCModel3D.prototype.setAnimation=function(index){if(this.primitive.setNextAnimation){this.primitive.setNextAnimation(index)}};CCModel3D.prototype.setAnimationFrame=function(index){if(this.primitive.setNextAnimationFrame){this.primitive.setNextAnimationFrame(index)}};CCModel3D.prototype.toggleAnimationFrame=function(index){if(this.primitive.toggleAnimationFrame){this.primitive.toggleAnimationFrame(index)}};CCModel3D.prototype.animate=function(delta,repeat,duration){if(this.primitive.animate){if(repeat===undefined){repeat=true}if(duration!==undefined){this.primitive.animateForDuration(delta,repeat,duration)}else{this.primitive.animate(delta,repeat)}gRenderer.pendingRender=true;return true}return false};function PrimitiveCache(){this.filename=undefined;this.primitive=undefined}CCModel3D.ModelCache=[];function ModelLoaderPacket(){this.callbacks=[]}CCModel3D.LoadingQueue=[];CCModel3D.CurrentLoad=null;CCModel3D.CreatePrimitive=function(filename){var extension=filename.getExtension();if(extension==="obj"){return new CCPrimitiveOBJ}else if(extension==="fbxi"){return new CCPrimitiveFBX}return null};CCModel3D.CacheModel=function(url,moveVerticesToOrigin,callback,priority){url=MultiplayerManager.GetAssetURL(url);var i;var filename=url.stripDirectory();filename=String.StripEquals(filename);var cachedModel=null;var ModelCache=CCModel3D.ModelCache;var length=ModelCache.length;for(i=0;i<length;++i){var cache=ModelCache[i];if(moveVerticesToOrigin===cache.primitive.hasMovedToOrigin()){if(cache.filename===filename){cachedModel=cache;break}}}if(!cachedModel){var loaderPacket;if(CCModel3D.CurrentLoad){loaderPacket=CCModel3D.CurrentLoad;if(loaderPacket.moveVerticesToOrigin===moveVerticesToOrigin){if(loaderPacket.url===url){if(callback){loaderPacket.callbacks.add(callback);if(priority>0){gURLManager.updateRequestPriority(url,filename,priority)}}return}}}var LoadingQueue=CCModel3D.LoadingQueue;for(i=0;i<LoadingQueue.length;++i){loaderPacket=LoadingQueue[i];if(loaderPacket.moveVerticesToOrigin===moveVerticesToOrigin){if(loaderPacket.url===url){if(callback){loaderPacket.callbacks.add(callback)}if(priority>0){CCModel3D.ResortQueue(loaderPacket,priority)}return}}}if(window.DEBUG_IsLocalClient){console.log("CCModel3D.CacheModel queue",filename,priority)}{loaderPacket=new ModelLoaderPacket;loaderPacket.filename=filename;loaderPacket.url=url;loaderPacket.priority=priority?priority:0;loaderPacket.moveVerticesToOrigin=moveVerticesToOrigin;if(callback){loaderPacket.callbacks.add(callback)}var primitive=CCModel3D.CreatePrimitive(filename);if(primitive){loaderPacket.primitive=primitive;LoadingQueue.add(loaderPacket);if(priority>0){CCModel3D.ResortQueue(loaderPacket,priority)}CCModel3D.LoadFromQueue()}}}else if(callback){CCModel3D.CacheModelResultProcess(cachedModel,[callback],false)}};CCModel3D.ResortQueue=function(packet,priority){var LoadingQueue=CCModel3D.LoadingQueue;for(var i=0;i<LoadingQueue.length;++i){var itr=LoadingQueue[i];if(itr===packet){break}else if(itr.priority<priority){LoadingQueue.insert(packet,i);break}}};CCModel3D.LoadFromQueue=function(){if(!CCModel3D.CurrentLoad&&CCModel3D.LoadingQueue.length>0){CCModel3D.CurrentLoad=CCModel3D.LoadingQueue.safePop();var loaderPacket=CCModel3D.CurrentLoad;var filename=loaderPacket.filename;var url=loaderPacket.url;var priority=loaderPacket.priority;var moveVerticesToOrigin=loaderPacket.moveVerticesToOrigin;var primitive=loaderPacket.primitive;primitive.load(filename,url,priority,function(succeeded){if(succeeded){var cachedModel=new PrimitiveCache;cachedModel.filename=filename;cachedModel.primitive=primitive;CCModel3D.ModelCache.add(cachedModel);if(moveVerticesToOrigin){primitive.moveVerticesToOriginAsync(function(){CCModel3D.CurrentLoad=null;CCModel3D.CacheModelResult(cachedModel,loaderPacket.callbacks)})}else{CCModel3D.CurrentLoad=null;CCModel3D.CacheModelResult(cachedModel,loaderPacket.callbacks)}}else{CCModel3D.CurrentLoad=null;primitive.destruct();CCModel3D.CacheModelResult(null,loaderPacket.callbacks)}})}};CCModel3D.CacheModelResult=function(cachedModel,callbacks){if(!CCModel3D.ResultQueue){CCModel3D.ResultQueue=[]}var result={};result.cachedModel=cachedModel;result.callbacks=callbacks;CCModel3D.ResultQueue.push(result);if(CCModel3D.ResultQueue.length===1){CCModel3D.CacheModelResultQueue()}CCModel3D.LoadFromQueue()};CCModel3D.CacheModelResultQueue=function(){CCEngine.RunNextUpdate(function(){if(CCModel3D.ResultQueue.length>0){var result=CCModel3D.ResultQueue.safePop();CCModel3D.CacheModelResultProcess(result.cachedModel,result.callbacks);if(CCModel3D.ResultQueue.length>0){CCModel3D.CacheModelResultQueue()}}})};CCModel3D.CacheModelResultProcess=function(cachedModel,callbacks){if(cachedModel){cachedModel.lastCacheTime=gEngine.lifetime}var i;var ModelCache=CCModel3D.ModelCache;var length=ModelCache.length;if(length>100){var oldestCacheTime=CC_MAXFLOAT;var oldestModel=null;for(i=0;i<length;++i){var cache=ModelCache[i];if(cache.lastCacheTime<oldestCacheTime){oldestModel=cache}}if(oldestModel){ModelCache.remove(oldestModel);oldestModel.primitive.destruct()}}for(i=0;i<callbacks.length;++i){var model=null;if(cachedModel){model=new CCModel3D;var primitive=CCModel3D.CreatePrimitive(cachedModel.filename);primitive.copy(cachedModel.primitive);model.primitive=primitive;model.addPrimitive(primitive)}callbacks[i](model)}CCModel3D.LoadFromQueue()};function CCPrimitive3D(){this.construct()}ExtendPrototype(CCPrimitive3D,CCPrimitiveBase);CCPrimitive3D.prototype.construct=function(){if(CCPrimitive3D.Objects){CCPrimitive3D.Objects.add(this)}this.CCPrimitiveBase_construct();this.vertexCount=0;this.width=this.height=this.depth=0;this.mmX=new CCMinMax;this.mmY=new CCMinMax;this.mmZ=new CCMinMax;this.cached=false;this.movedToOrigin=false;this.origin=vec3.create()};CCPrimitive3D.prototype.destruct=function(){if(CCPrimitive3D.Objects){CCPrimitive3D.Objects.remove(this)}if(!this.cached){if(this.vertexPositionBuffer){gRenderer.CCDeleteVertexBuffer(this.vertexPositionBuffer)}}if(this.vertexTextureBuffer){gRenderer.CCDeleteVertexBuffer(this.vertexTextureBuffer)}this.CCPrimitiveBase_destruct()};CCPrimitive3D.prototype.load=function(filename,url,priority,callback){this.filename=filename;var self=this;gURLManager.requestURL(url,null,function(status,responseText){if(status>=CCURLRequest.Succeeded){self.loadData(responseText,callback)}else{callback(false)}},priority,filename)};CCPrimitive3D.prototype.loadData=function(fileData,callback){if(callback){callback(false)}};CCPrimitive3D.prototype.getWidth=function(){return this.width};CCPrimitive3D.prototype.getHeight=function(){return this.height};CCPrimitive3D.prototype.getDepth=function(){return this.depth};CCPrimitive3D.prototype.getYMinMax=function(){return this.mmY};CCPrimitive3D.prototype.getYMinMaxAtZ=function(atZ,callback){var mmYAtZ=new CCMinMax;var vertices=this.vertices;var vertexCount=this.vertexCount;for(var i=0;i<vertexCount;++i){var index=i*3;var y=vertices[index+1];var z=vertices[index+2];if(z>=atZ){mmYAtZ.consider(y)}}callback(mmYAtZ)};CCPrimitive3D.prototype.getZMinMax=function(){return this.mmZ};CCPrimitive3D.prototype.getOrigin=function(){if(!this.movedToOrigin){var origin=this.origin;origin[0]=this.mmX.min+this.width*.5;origin[1]=this.mmY.min+this.height*.5;origin[2]=this.mmZ.min+this.depth*.5}return this.origin};CCPrimitive3D.prototype.moveVerticesToOriginAsync=function(callback){var self=this;CCEngine.RunNextUpdate(function(){self.moveVerticesToOrigin();if(callback){callback()}})};CCPrimitive3D.prototype.moveVerticesToOrigin=function(callback){if(!this.movedToOrigin){var origin=this.getOrigin();var mmX=this.mmX;var mmY=this.mmY;var mmZ=this.mmZ;mmX.reset();mmY.reset();mmZ.reset();var vertices=this.vertices;var vertexCount=this.vertexCount;for(var i=0;i<vertexCount;++i){var index=i*3;var x=index+0;var y=index+1;var z=index+2;vertices[x]-=origin[0];vertices[y]-=origin[1];vertices[z]-=origin[2];mmX.consider(vertices[x]);mmY.consider(vertices[y]);mmZ.consider(vertices[z])}gRenderer.CCUpdateVertexBuffer(this.vertexPositionBuffer,vertices);this.movedToOrigin=true}if(callback){callback()}};CCPrimitive3D.prototype.hasMovedToOrigin=function(){return this.movedToOrigin};function CCPrimitiveOBJ(){this.construct()}ExtendPrototype(CCPrimitiveOBJ,CCPrimitive3D);
CCPrimitiveOBJ.prototype.loadData=function(fileData,callback){var objMesh=ObjMesh.LoadOBJ(fileData);if(objMesh){this.fileSize=fileData.length;var mmX=this.mmX;var mmY=this.mmY;var mmZ=this.mmZ;var i,pf,j,index,texCoord,vertex;for(i=0;i<objMesh.m_iNumberOfFaces;++i){pf=objMesh.m_aFaces[i];if(pf.m_iVertexCount>=3){var faceVertexCount=pf.m_iVertexCount;do{this.vertexCount+=3;faceVertexCount--}while(faceVertexCount>=3)}}var modelUVs=this.modelUVs=new CCRenderer.Float32Array(this.vertexCount*2);var modelVertices=this.vertices=new CCRenderer.Float32Array(this.vertexCount*3);var modelNormals=this.normals=new CCRenderer.Float32Array(this.vertexCount*3);var uvIndex=0;var vertexIndex=0;for(i=0;i<objMesh.m_iNumberOfFaces;++i){pf=objMesh.m_aFaces[i];if(pf.m_iVertexCount<3){continue}var vertexStartIterator=1;var vertexEndIterator=2;do{{j=0;if(objMesh.m_aTexCoordArray){index=pf.m_aTexCoordIndicies[j];if(index>=0&&index<objMesh.m_iNumberOfTexCoords){texCoord=objMesh.m_aTexCoordArray[index];modelUVs[uvIndex+0]=texCoord.u;modelUVs[uvIndex+1]=1-texCoord.v}}{index=pf.m_aVertexIndices[j];vertex=objMesh.m_aVertexArray[index];modelVertices[vertexIndex+0]=vertex.x;modelVertices[vertexIndex+1]=vertex.y;modelVertices[vertexIndex+2]=vertex.z;mmX.consider(vertex.x);mmY.consider(vertex.y);mmZ.consider(vertex.z)}if(objMesh.m_aNormalArray){index=pf.m_aNormalIndices[j];if(index>=0&&index<objMesh.m_iNumberOfNormals){var normal=objMesh.m_aNormalArray[index];modelNormals[vertexIndex+0]=normal.x;modelNormals[vertexIndex+1]=normal.y;modelNormals[vertexIndex+2]=normal.z}}uvIndex+=2;vertexIndex+=3}for(j=vertexStartIterator;j<=vertexEndIterator;++j){if(objMesh.m_aTexCoordArray){index=pf.m_aTexCoordIndicies[j];if(index>=0&&index<objMesh.m_iNumberOfTexCoords){texCoord=objMesh.m_aTexCoordArray[index];modelUVs[uvIndex+0]=texCoord.u;modelUVs[uvIndex+1]=1-texCoord.v}}{index=pf.m_aVertexIndices[j];vertex=objMesh.m_aVertexArray[index];modelVertices[vertexIndex+0]=vertex.x;modelVertices[vertexIndex+1]=vertex.y;modelVertices[vertexIndex+2]=vertex.z;mmX.consider(vertex.x);mmY.consider(vertex.y);mmZ.consider(vertex.z)}uvIndex+=2;vertexIndex+=3}vertexStartIterator++;vertexEndIterator++}while(vertexEndIterator<pf.m_iVertexCount)}this.width=mmX.size();this.height=mmY.size();this.depth=mmZ.size();this.vertexPositionBuffer=gRenderer.CCCreateVertexBuffer(modelVertices);this.vertexTextureBuffer=gRenderer.CCCreateVertexBuffer(modelUVs,2)}callback(this.vertexCount>0)};CCPrimitiveOBJ.prototype.render=function(){if(this.textureIndex!==-1){gEngine.textureManager.setTextureIndex(this.textureIndex)}else{gEngine.textureManager.setTextureIndex(1)}this.renderVertices(gRenderer)};CCPrimitiveOBJ.prototype.renderVertices=function(renderer){if(this.vertexCount>0){renderer.CCSetRenderStates();renderer.CCBindVertexTextureBuffer(this.vertexTextureBuffer);renderer.CCBindVertexPositionBuffer(this.vertexPositionBuffer);renderer.GLDrawArrays("TRIANGLES",0,this.vertexCount)}};CCPrimitiveOBJ.prototype.copy=function(sourcePrimitive){this.filename=sourcePrimitive.filename;this.fileSize=sourcePrimitive.fileSize;this.sourcePrimitiveID=sourcePrimitive.primitiveID;this.vertexPositionBuffer=sourcePrimitive.vertexPositionBuffer;this.vertexTextureBuffer=sourcePrimitive.vertexTextureBuffer;this.vertexCount=sourcePrimitive.vertexCount;this.modelUVs=sourcePrimitive.modelUVs;this.vertices=sourcePrimitive.vertices;this.normals=sourcePrimitive.normals;this.width=sourcePrimitive.width;this.height=sourcePrimitive.height;this.depth=sourcePrimitive.depth;this.mmX=sourcePrimitive.mmX;this.mmY=sourcePrimitive.mmY;this.mmZ=sourcePrimitive.mmZ;this.cached=true;this.movedToOrigin=sourcePrimitive.movedToOrigin;this.origin=sourcePrimitive.origin;if(CCEngine.NativeUpdateCommands!==undefined){this.vertexTextureBuffer=gRenderer.CCCreateVertexBuffer();CCEngine.NativeUpdateCommands+="CCPrimitiveOBJ.copy;"+this.primitiveID+";"+sourcePrimitive.primitiveID+";"+this.vertexTextureBuffer+"\n"}};function CCFBXSubModel(parent){this.parent=parent}CCFBXSubModel.prototype.loadJSON=function(json){var i;this.name=json.name;var submeshes=json.submeshes;this.submeshes=[];for(i=0;i<submeshes.length;++i){this.submeshes.push(submeshes[i])}var vertices=json.vertices;if(vertices.length<3){return 0}var vertexCount=this.vertexCount=vertices.length/3;this.vertices=CCRenderer.NewArrayType(vertices,CCRenderer.Float32Array);this.skinnedVertices=CCRenderer.NewArrayType(vertices,CCRenderer.Float32Array);this.vertexPositionBuffer=gRenderer.CCCreateVertexBuffer(this.skinnedVertices);this.normals=json.normals;var indices=json.indices;this.indices=CCRenderer.NewArrayType(indices,CCRenderer.Uint16Array);this.vertexIndexBuffer=gRenderer.CCCreateVertexIndexBuffer(this.indices);var uvs=json.uvs;if(!uvs){uvs=new Array(vertexCount*2);for(i=0;i<vertexCount*2;++i){uvs[i]=0}}this.modelUVs=CCRenderer.NewArrayType(uvs,CCRenderer.Float32Array);this.vertexTextureBuffer=gRenderer.CCCreateVertexBuffer(this.modelUVs,2);return vertexCount};function CCPrimitiveFBX(){this.construct();this.animationFPS=30;this.animationFPSCompression=5;this.setAnimation(0)}ExtendPrototype(CCPrimitiveFBX,CCPrimitive3D);CCPrimitiveFBX.prototype.construct=function(){this.CCPrimitive3D_construct();if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCPrimitiveFBX.construct;"+this.primitiveID+"\n"}};CCPrimitiveFBX.prototype.destruct=function(){if(!this.cached){if(this.submodels){var submodels=this.submodels;for(var submodelIndex=0;submodelIndex<submodels.length;++submodelIndex){var submodel=submodels[submodelIndex];if(submodel.vertexIndexBuffer){gRenderer.CCDeleteVertexBuffer(submodel.vertexIndexBuffer)}if(submodel.vertexPositionBuffer){gRenderer.CCDeleteVertexBuffer(submodel.vertexPositionBuffer)}if(submodel.vertexTextureBuffer){gRenderer.CCDeleteVertexBuffer(submodel.vertexTextureBuffer)}}}}this.CCPrimitive3D_destruct();if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCPrimitiveFBX.destruct;"+this.primitiveID+"\n"}};CCPrimitiveFBX.prototype.loadData=function(fileData,callback){if(fileData){this.fileSize=fileData.length;var windowURL=window.URL||window.webkitURL;if(window.Worker&&windowURL&&windowURL.createObjectURL){var self=this;if(!CCPrimitiveFBX.workerJSONParse){var blob=new Blob(["self.addEventListener( 'message', function (e) {       var data = e.data;      if( data.loadData )     {           var json = JSON.parse( data.loadData );         self.postMessage( json );       }       else if( data.close )     {           self.close();       }   }, false );"],{type:"text/javascript"});var blobURL=windowURL.createObjectURL(blob);CCPrimitiveFBX.workerJSONParse=new Worker(blobURL)}if(window.DEBUG_IsLocalClient){}var worker=CCPrimitiveFBX.workerJSONParse;worker.onmessage=function(e){if(window.DEBUG_IsLocalClient){}var json=e.data;CCEngine.RunNextUpdate(function(){self.loadJSON(json,callback)})};worker.postMessage({loadData:fileData});return}else{var json=JSON.parse(fileData);this.loadJSON(json,callback)}}else{this.loaded(callback)}};CCPrimitiveFBX.prototype.loadJSON=function(json,callback){if(json){var i;if(json.materials){this.materials=json.materials}if(json.models&&json.models.length>0){this.submodels=[];for(i=0;i<json.models.length;++i){var model=json.models[i];if(model.submeshes&&model.vertices){var submodel=new CCFBXSubModel(this);var vertexCount=submodel.loadJSON(model);if(vertexCount>0){this.vertexCount+=vertexCount;this.submodels.push(submodel)}}}}if(json.animations){this.animations=json.animations;if(json.animationFPS){this.animationFPS=json.animationFPS}if(json.animationFPSCompression){this.animationFPSCompression=json.animationFPSCompression}this.setAnimation(0);this.nextFrame()}var self=this;this.calculateMinMaxAsync(function(){self.width=self.mmX.size();self.height=self.mmY.size();self.depth=self.mmZ.size();self.loaded(callback)});return}this.loaded(callback)};CCPrimitiveFBX.prototype.loaded=function(callback){callback(this.vertexCount>0)};CCPrimitiveFBX.prototype.render=function(){if(CCEngine.NativeUpdateCommands!==undefined){gRenderer.unbindBuffers();CCEngine.NativeRenderCommands+="CCPrimitiveFBX.render;"+this.primitiveID+"\n"}else{if(this.textureIndex!==-1){gEngine.textureManager.setTextureIndex(this.textureIndex)}else{gEngine.textureManager.setTextureIndex(1)}this.renderVertices(gRenderer)}};CCPrimitiveFBX.prototype.renderVertices=function(renderer){renderer.CCSetRenderStates();var submodels=this.submodels;for(var submodelIndex=0;submodelIndex<submodels.length;++submodelIndex){var submodel=submodels[submodelIndex];if(submodel.disabled){continue}if(submodel.vertexTextureBuffer){renderer.CCBindVertexTextureBuffer(submodel.vertexTextureBuffer)}renderer.CCBindVertexPositionBuffer(submodel.vertexPositionBuffer);renderer.CCBindVertexIndexBuffer(submodel.vertexIndexBuffer);var submeshes=submodel.submeshes;for(var i=0;i<submeshes.length;++i){var submesh=submeshes[i];renderer.GLDrawElements("TRIANGLES",submesh.count,submesh.offset)}}};CCPrimitiveFBX.prototype.getYMinMaxAtZ=function(atZ,callback){var mmYAtZ=new CCMinMax;callback(mmYAtZ)};CCPrimitiveFBX.prototype.calculateMinMaxAsync=function(callback){var self=this;CCEngine.RunNextUpdate(function(){self.calculateMinMax();if(callback){callback()}})};CCPrimitiveFBX.prototype.calculateMinMaxWorker=function(callback){var windowURL=window.URL||window.webkitURL;if(window.Worker&&windowURL&&windowURL.createObjectURL){var self=this;if(!CCPrimitiveFBX.workerCalculateMinMax){var blob=new Blob(["function calculateMinMax(mmX, mmY, mmZ, submodels, animations) {      var submodelsLength;     var submodelIndex;     var submodel;      var MathMin = Math.min;     var MathMax = Math.max;     var x, y, z;      if( animations && animations.length > 0 )     {         var animation = animations[0];         var frames = animation.frames;         if( frames && frames.length > 0 )         {             var animationFrameSubmodels = frames[0];             var animationFrameSubmodelsLength = animationFrameSubmodels.length;             if( animationFrameSubmodels && animationFrameSubmodelsLength > 0 )             {                 for( var iSubmodel=0; iSubmodel<animationFrameSubmodelsLength; ++iSubmodel )                 {                     var animationSubmodel = animationFrameSubmodels[iSubmodel];                     var v = animationSubmodel.v;                     if( !v )                     {                         submodelsLength = submodels.length;                         for( submodelIndex=0; submodelIndex<submodelsLength; ++submodelIndex )                         {                             submodel = submodels[submodelIndex];                             if( submodel.name === animationSubmodel.n )                             {                                 v = submodel.vertices;                                 break;                             }                         }                     }                     if( v )                     {                         var vLength = v.length;                         for( var vertexIndex=0; vertexIndex<vLength; vertexIndex+=3 )                         {                             x = v[vertexIndex+0];                             y = v[vertexIndex+1];                             z = v[vertexIndex+2];                              mmX.min = MathMin( mmX.min, x );                             mmX.max = MathMax( mmX.max, x );                              mmY.min = MathMin( mmY.min, y );                             mmY.max = MathMax( mmY.max, y );                              mmZ.min = MathMin( mmZ.min, z );                             mmZ.max = MathMax( mmZ.max, z );                         }                     }                 }                 return;             }         }     }      if( submodels )     {         submodelsLength = submodels.length;         for( submodelIndex=0; submodelIndex<submodelsLength; ++submodelIndex )         {             submodel = submodels[submodelIndex];             var vertices = submodel.vertices;             var vertexCount = submodel.vertexCount;             for( var i=0; i<vertexCount; ++i )             {                 var index = i*3;                  x = vertices[index+0];                 y = vertices[index+1];                 z = vertices[index+2];                  mmX.min = MathMin( mmX.min, x );                 mmX.max = MathMax( mmX.max, x );                  mmY.min = MathMin( mmY.min, y );                 mmY.max = MathMax( mmY.max, y );                  mmZ.min = MathMin( mmZ.min, z );                 mmZ.max = MathMax( mmZ.max, z );             }         }     } };  self.addEventListener( 'message', function (e) {     var data = e.data.data;       var mmX = data.mmX;     var mmY = data.mmY;     var mmZ = data.mmZ;     var submodels = data.submodels;     var animations = data.animations;      calculateMinMax( mmX, mmY, mmZ, submodels, animations );     var result = {};     result.mmX = mmX;     result.mmY = mmY;     result.mmZ = mmZ;     self.postMessage( result ); }, false );"],{type:"text/javascript"});var blobURL=windowURL.createObjectURL(blob);CCPrimitiveFBX.workerCalculateMinMax=new Worker(blobURL)}if(window.DEBUG_IsLocalClient){}var worker=CCPrimitiveFBX.workerCalculateMinMax;var self=this;worker.onmessage=function(e){if(window.DEBUG_IsLocalClient){}var result=e.data;self.mmX.min=result.mmX.min;self.mmX.max=result.mmX.max;self.mmY.min=result.mmY.min;self.mmY.max=result.mmY.max;self.mmZ.min=result.mmZ.min;self.mmZ.max=result.mmZ.max;if(callback){callback()}};this.mmX.reset();this.mmY.reset();this.mmZ.reset();var data={};data.mmX=this.mmX;data.mmY=this.mmY;data.mmZ=this.mmZ;data.submodels=this.animations;data.animations=this.animations;worker.postMessage({data:data});return}else{this.calculateMinMax()}};CCPrimitiveFBX.prototype.calculateMinMax=function(){var mmX=this.mmX;var mmY=this.mmY;var mmZ=this.mmZ;mmX.reset();mmY.reset();mmZ.reset();var submodels=this.submodels;var submodelsLength;var submodelIndex;var submodel;var MathMin=Math.min;var MathMax=Math.max;var x,y,z;var animations=this.animations;if(animations&&animations.length>0){var animation=animations[0];var frames=animation.frames;if(frames&&frames.length>0){var animationFrameSubmodels=frames[0];var animationFrameSubmodelsLength=animationFrameSubmodels.length;if(animationFrameSubmodels&&animationFrameSubmodelsLength>0){for(var iSubmodel=0;iSubmodel<animationFrameSubmodelsLength;++iSubmodel){var animationSubmodel=animationFrameSubmodels[iSubmodel];var v=animationSubmodel.v;if(!v){submodelsLength=submodels.length;for(submodelIndex=0;submodelIndex<submodelsLength;++submodelIndex){submodel=submodels[submodelIndex];if(submodel.name===animationSubmodel.n){v=submodel.vertices;break}}}if(v){var vLength=v.length;for(var vertexIndex=0;vertexIndex<vLength;vertexIndex+=3){x=v[vertexIndex+0];y=v[vertexIndex+1];z=v[vertexIndex+2];mmX.min=MathMin(mmX.min,x);mmX.max=MathMax(mmX.max,x);mmY.min=MathMin(mmY.min,y);mmY.max=MathMax(mmY.max,y);mmZ.min=MathMin(mmZ.min,z);mmZ.max=MathMax(mmZ.max,z)}}}return}}}if(submodels){submodelsLength=submodels.length;for(submodelIndex=0;submodelIndex<submodelsLength;++submodelIndex){submodel=submodels[submodelIndex];var vertices=submodel.vertices;var vertexCount=submodel.vertexCount;for(var i=0;i<vertexCount;++i){var index=i*3;x=vertices[index+0];y=vertices[index+1];z=vertices[index+2];mmX.min=MathMin(mmX.min,x);mmX.max=MathMax(mmX.max,x);mmY.min=MathMin(mmY.min,y);mmY.max=MathMax(mmY.max,y);mmZ.min=MathMin(mmZ.min,z);mmZ.max=MathMax(mmZ.max,z)}}}};CCPrimitiveFBX.prototype.moveVerticesToOrigin=function(callback){if(!this.movedToOrigin){var origin=this.getOrigin();var animations=this.animations;if(animations){var animationsLength=animations.length;for(var animationIndex=0;animationIndex<animationsLength;++animationIndex){var animation=animations[animationIndex];var frames=animation.frames;if(frames){var framesLength=frames.length;for(var frameIndex=0;frameIndex<framesLength;++frameIndex){var animationFrameSubmodels=animation.frames[frameIndex];for(var iSubmodel=0;iSubmodel<animationFrameSubmodels.length;++iSubmodel){var animationSubmodel=animationFrameSubmodels[iSubmodel];var v=animationSubmodel.v;if(v){var vLength=v.length;for(var vertexIndex=0;vertexIndex<vLength;vertexIndex+=3){v[vertexIndex+0]-=origin[0];v[vertexIndex+1]-=origin[1];v[vertexIndex+2]-=origin[2]}}}}}}}var submodels=this.submodels;var submodelsLength;for(var submodelIndex=0;submodelIndex<submodelsLength;++submodelIndex){var submodel=submodels[submodelIndex];var vertices=submodel.vertices;var skinnedVertices=submodel.skinnedVertices;var vertexCount=submodel.vertexCount;for(var i=0;i<vertexCount;++i){var index=i*3;var x=index+0;var y=index+1;var z=index+2;vertices[x]-=origin[0];vertices[y]-=origin[1];vertices[z]-=origin[2];skinnedVertices[x]-=origin[0];skinnedVertices[y]-=origin[1];skinnedVertices[z]-=origin[2]}gRenderer.CCUpdateVertexBuffer(submodel.vertexPositionBuffer,skinnedVertices)}var self=this;this.calculateMinMaxAsync(function(){self.movedToOrigin=true;if(callback){callback()}});return}if(callback){callback()}};CCPrimitiveFBX.prototype.copy=function(sourcePrimitive){this.filename=sourcePrimitive.filename;this.fileSize=sourcePrimitive.fileSize;if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCPrimitiveFBX.copy;"+this.primitiveID+";"+sourcePrimitive.primitiveID+"\n"}else{var submodels=this.submodels=[];var sourceSubmodels=sourcePrimitive.submodels;var sourceSubmodelsLength=sourcePrimitive.submodels.length;for(var submodelIndex=0;submodelIndex<sourceSubmodelsLength;++submodelIndex){var sourceSubmodel=sourcePrimitive.submodels[submodelIndex];var submodel={};submodels.push(submodel);submodel.name=sourceSubmodel.name;submodel.submeshes=[];for(i=0;i<sourceSubmodel.submeshes.length;++i){submodel.submeshes.push(sourceSubmodel.submeshes[i])}submodel.vertexCount=sourceSubmodel.vertexCount;submodel.vertices=sourceSubmodel.vertices;submodel.normals=sourceSubmodel.normals;submodel.skinnedVertices=CCRenderer.NewArrayType(submodel.vertices,CCRenderer.Float32Array);submodel.vertexPositionBuffer=gRenderer.CCCreateVertexBuffer(submodel.skinnedVertices);submodel.indices=sourceSubmodel.indices;submodel.vertexIndexBuffer=sourceSubmodel.vertexIndexBuffer;submodel.modelUVs=sourceSubmodel.modelUVs;submodel.vertexTextureBuffer=sourceSubmodel.vertexTextureBuffer}this.sourcePrimitive=sourcePrimitive}this.sourcePrimitiveID=sourcePrimitive.primitiveID;this.materials=sourcePrimitive.materials;this.animations=sourcePrimitive.animations;this.animationFPS=sourcePrimitive.animationFPS;this.animationFPSCompression=sourcePrimitive.animationFPSCompression;this.setAnimation(0);this.nextFrame();this.vertexCount=sourcePrimitive.vertexCount;this.width=sourcePrimitive.width;this.height=sourcePrimitive.height;this.depth=sourcePrimitive.depth;this.mmX=sourcePrimitive.mmX;this.mmY=sourcePrimitive.mmY;this.mmZ=sourcePrimitive.mmZ;this.cached=true;this.movedToOrigin=sourcePrimitive.movedToOrigin;this.origin=sourcePrimitive.origin};CCPrimitiveFBX.prototype.getAnimation=function(){if(this.nextNextAnimationIndex!==undefined){return this.nextNextAnimationIndex}return this.nextAnimationIndex};CCPrimitiveFBX.prototype.getAnimationFrame=function(){if(this.lockedAnimationFrameIndex!==undefined){return this.lockedAnimationFrameIndex}return-1};CCPrimitiveFBX.prototype.getAnimationNumberOfFrames=function(){return this.numberOfFrames};CCPrimitiveFBX.prototype.getAnimationFPSCompression=function(){return this.animationFPSCompression};CCPrimitiveFBX.prototype.setAnimation=function(index){this.currentAnimationIndex=index;this.currentFrameIndex=0;this.nextAnimationIndex=index;this.nextFrameIndex=0;this.frameDelta=0;this.frameSpeed=this.animationFPS/this.animationFPSCompression;this.numberOfFrames=0;if(this.animations&&this.animations.length>0&&this.nextAnimationIndex<this.animations.length){var animations=this.animations;var nextAnimation=animations[this.nextAnimationIndex];if(nextAnimation){var frames=nextAnimation.frames;this.numberOfFrames=frames.length}}if(this.lockedAnimationFrameIndex!==undefined){delete this.lockedAnimationFrameIndex}this.setAnimationFrame(0)};CCPrimitiveFBX.prototype.setAnimationFrame=function(index){if(this.animations&&this.animations.length>0){var currentAnimationIndex;if(this.nextNextAnimationIndex!==undefined){currentAnimationIndex=this.nextNextAnimationIndex}else{currentAnimationIndex=this.nextAnimationIndex}if(currentAnimationIndex>=this.animations.length){currentAnimationIndex=0}this.interpolateFrames(currentAnimationIndex,index,currentAnimationIndex,index,0)}};CCPrimitiveFBX.prototype.setNextAnimationFrame=function(index){this.nextFrameIndex=index};CCPrimitiveFBX.prototype.toggleAnimationFrame=function(index){if(index<0){index=0}if(index>this.numberOfFrames-1){index=this.numberOfFrames-1}if(this.lockedAnimationFrameIndex!==undefined){if(this.lockedAnimationFrameIndex===index){this.setAnimationFrame(index);this.setNextAnimationFrame(index);delete this.lockedAnimationFrameIndex;return}}this.lockedAnimationFrameIndex=index;this.setAnimationFrame(index)};CCPrimitiveFBX.prototype.setNextAnimation=function(index){this.nextNextAnimationIndex=index;if(this.lockedAnimationFrameIndex!==undefined){delete this.lockedAnimationFrameIndex}};CCPrimitiveFBX.prototype.nextFrame=function(repeat){if(this.animations&&this.animations.length>0&&this.nextAnimationIndex<this.animations.length){this.currentFrameIndex=this.nextFrameIndex;this.currentAnimationIndex=this.nextAnimationIndex;this.nextFrameIndex++;if(this.nextNextAnimationIndex!==undefined&&this.nextAnimationIndex!=this.nextNextAnimationIndex){this.nextAnimationIndex=this.nextNextAnimationIndex;this.nextFrameIndex=0}var animations=this.animations;var nextAnimation=animations[this.nextAnimationIndex];if(nextAnimation){var frames=nextAnimation.frames;if(frames&&frames.length>0){if(this.nextFrameIndex>=frames.length){if(repeat){this.nextFrameIndex=0}else{this.nextFrameIndex=frames.length-1}}}}}};CCPrimitiveFBX.prototype.animateForDuration=function(delta,repeat,duration){if(this.lockedAnimationFrameIndex!==undefined){return}if(this.animations&&this.animations.length>0&&this.currentAnimationIndex<this.animations.length){this.frameDelta+=delta*this.numberOfFrames*duration;if(this.frameDelta>=1){this.frameDelta=0;this.nextFrame(repeat)}this.interpolateFrames(this.currentAnimationIndex,this.currentFrameIndex,this.nextAnimationIndex,this.nextFrameIndex,this.frameDelta)}};CCPrimitiveFBX.prototype.animate=function(delta,repeat){if(this.lockedAnimationFrameIndex!==undefined){return}if(this.animations&&this.animations.length>0&&this.currentAnimationIndex<this.animations.length){this.frameDelta+=delta*this.frameSpeed;if(this.frameDelta>=1){this.frameDelta=0;this.nextFrame(repeat)}this.interpolateFrames(this.currentAnimationIndex,this.currentFrameIndex,this.nextAnimationIndex,this.nextFrameIndex,this.frameDelta)}};CCPrimitiveFBX.prototype.interpolateFrames=function(currentAnimationIndex,currentFrameIndex,nextAnimationIndex,nextFrameIndex,frameDelta){if(this.submodels){var submodels=this.submodels;var submodelsLength=this.submodels.length;var currentAnimation=this.animations[currentAnimationIndex];var nextAnimation=this.animations[nextAnimationIndex];if(currentAnimation&&nextAnimation){if(currentAnimation.frames&&nextAnimation.frames){var currentFrame=currentAnimation.frames[currentFrameIndex];var nextFrame=nextAnimation.frames[nextFrameIndex];for(var submodelIndex=0;submodelIndex<submodelsLength;++submodelIndex){var submodel=submodels[submodelIndex];var currentFrameVertices=this.getAnimationFrameSubmodelVertices(submodel.name,currentFrame);var nextFrameVertices=this.getAnimationFrameSubmodelVertices(submodel.name,nextFrame);if(currentFrameVertices&&nextFrameVertices){var inverseDelta=1-frameDelta;var skinnedVertices=submodel.skinnedVertices;var skinnedVerticesLength=skinnedVertices.length;for(var vertIndex=0;vertIndex<skinnedVerticesLength;++vertIndex){var interpolatedVert=currentFrameVertices[vertIndex]*inverseDelta+nextFrameVertices[vertIndex]*frameDelta;skinnedVertices[vertIndex]=interpolatedVert}gRenderer.CCUpdateVertexBuffer(submodel.vertexPositionBuffer,skinnedVertices)}}}}}};CCPrimitiveFBX.prototype.getAnimationFrameSubmodelVertices=function(submodelName,frame){if(frame){var frameLength=frame.length;for(var iSubmodel=0;iSubmodel<frameLength;++iSubmodel){if(frame[iSubmodel].n===submodelName){return frame[iSubmodel].v}}}return null};CCPrimitiveFBX.prototype.unlockAnimationsData=function(){if(this.sourcePrimitive&&this.sourcePrimitive.animations===this.animations){this.animations=CC.DeepCopy(this.animations)}};CCPrimitiveFBX.prototype.deleteAnimation=function(animationName){this.unlockAnimationsData();var animations=this.animations;for(var i=0;i<animations.length;++i){if(animations[i].name===animationName){animations.remove(animations[i]);this.setAnimation(0);return true}}return false};CCPrimitiveFBX.prototype.moveAnimationFrame=function(oldIndex,newIndex){this.unlockAnimationsData();if(this.lockedAnimationFrameIndex!==undefined){delete this.lockedAnimationFrameIndex}var currentAnimation=this.animations[this.currentAnimationIndex];var frames=currentAnimation.frames;if(oldIndex>=0&&oldIndex<frames.length&&newIndex>=0&&newIndex<frames.length){var frame=frames[oldIndex];frames.insert(frame,newIndex);return true}return false};CCPrimitiveFBX.prototype.deleteAnimationFrame=function(index){if(this.lockedAnimationFrameIndex!==undefined){delete this.lockedAnimationFrameIndex}var currentAnimation=this.animations[this.currentAnimationIndex];var frames=currentAnimation.frames;if(index>=0&&index<frames.length){frames.remove(frames[index]);return true}return false};CCPrimitiveFBX.prototype.toggleSubmodel=function(submodelName){var submodels=this.submodels;var i,submodel;for(i=0;i<submodels.length;++i){if(submodels[i].name===submodelName){submodel=submodels[i]}}if(submodel){if(submodel.disabled){delete submodel.disabled}else{submodel.disabled=true}}};CCPrimitiveFBX.prototype.deleteSubmodel=function(submodelName){var submodels=this.submodels;var i,submodel;for(i=0;i<submodels.length;++i){if(submodels[i].name===submodelName){submodel=submodels[i]}}if(submodel){submodels.remove(submodel);var animations=this.animations;for(i=0;i<animations.length;++i){var animation=animations[i];var frames=animation.frames;for(var iFrame=0;iFrame<frames.length;++iFrame){var animationFrameSubmodels=frames[iFrame];for(var iSubmodel=0;iSubmodel<animationFrameSubmodels.length;++iSubmodel){var animationSubmodel=animationFrameSubmodels[iSubmodel];var animationSubmodelName=animationSubmodel.n;if(animationSubmodelName===submodelName){animationFrameSubmodels.remove(animationSubmodel);--iSubmodel}}}}return true}return false};CCPrimitiveFBX.prototype.exportJSONString=function(callback){var i;var json={};json.animationFPS=this.animationFPS;json.animationFPSCompression=this.animationFPSCompression;json.materials=this.materials;json.models=[];var submodels=this.submodels;for(i=0;i<submodels.length;++i){var submodel=submodels[i];var model={};model.name=submodel.name;model.submeshes=submodel.submeshes;var iVert;model.vertices=[];for(iVert=0;iVert<submodel.vertices.length;++iVert){model.vertices.push(submodel.vertices[iVert])}model.normals=submodel.normals;model.uvs=[];for(iVert=0;iVert<submodel.modelUVs.length;++iVert){model.uvs.push(submodel.modelUVs[iVert])}model.indices=[];for(iVert=0;iVert<submodel.indices.length;++iVert){model.indices.push(submodel.indices[iVert])}json.models.push(model)}json.animations=this.animations;CCFileManager.Stringify(json,function(string){callback(string)})};function CCTextureManager(){this.fontPages=[];this.currentTextureIndex=-1;this.textureHandles=[];this.assignTextureIndex("transparent.png");this.assignTextureIndex("white.png");this.setTextureIndex(1)}CCTextureManager.prototype.loadFont=function(font){var fontPage=new CCTextureFontPageFile(font);fontPage.load();this.fontPages.push(fontPage);if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCTextureManager.loadFont;"+font+"\n"}};CCTextureManager.prototype.getTextureHandleIndex=function(index){var textureHandles=this.textureHandles;if(index>=0&&index<textureHandles.length){var texture=textureHandles[index];return texture}return null};CCTextureManager.prototype.getTextureHandleIndexAsync=function(index,onDownloadedCallback){var handle=this.textureHandles[index];if(handle.downloaded){if(onDownloadedCallback){onDownloadedCallback(handle)}}else if(onDownloadedCallback){if(!handle.onDownload){handle.onDownload=[]}handle.onDownload.push(onDownloadedCallback)}};CCTextureManager.prototype.getTextureHandle=function(src,onDownloadedCallback){var textureHandleIndex=this.assignTextureIndex(src);this.getTextureHandleIndexAsync(textureHandleIndex,onDownloadedCallback)};CCTextureManager.ValidateImageResolution=function(base64Data,targetEncoding,maxResolution,callback){AlertsManager.ModalAlert("processing...");var image=new Image;image.onload=function(){var validatedData=base64Data;if(image.width>maxResolution||image.height>maxResolution){var canvas=document.createElement("canvas");if(image.width>maxResolution){canvas.width=maxResolution;canvas.height=image.height/image.width*maxResolution}else if(image.height>maxResolution){canvas.width=image.width/image.height*maxResolution;canvas.height=maxResolution}var ctx=canvas.getContext("2d");ctx.drawImage(image,0,0,canvas.width,canvas.height);validatedData=canvas.toDataURL(targetEncoding)}AlertsManager.Hide("processing...");callback(validatedData)};image.onabort=function(){AlertsManager.Hide("processing...");callback()};image.onerror=function(){AlertsManager.Hide("processing...");callback()};image.src=base64Data};CCTextureManager.ConvertBase64Image=function(base64Data,callback){var image=new Image;image.onload=function(){var canvas=document.createElement("canvas");canvas.width=image.width;canvas.height=image.height;var ctx=canvas.getContext("2d");ctx.drawImage(image,0,0);var dataURL=canvas.toDataURL("image/jpeg");callback(dataURL)};image.onabort=function(){callback()};image.onerror=function(){callback()};image.src=base64Data};CCTextureManager.ConvertImage=function(image,format,tiling,callback){var canvas=document.createElement("canvas");canvas.width=image.width;canvas.height=image.height;if(tiling>0){var newWidth=image.width/tiling;var newHeight=image.height/tiling;var ctx=canvas.getContext("2d");var y=0;while(y<canvas.height){var x=0;while(x<canvas.width){ctx.drawImage(image,x,y,newWidth,newHeight);x+=newWidth}y+=newHeight}}if(format==="jpg"){callback(canvas.toDataURL("image/jpeg"))}else if(format==="png"){callback(canvas.toDataURL("image/png"))}else{callback(false)}};function CCSceneBase(){this.construct()}CCSceneBase.NextSceneID=0;CCSceneBase.prototype.construct=function(){this.sceneID=CCSceneBase.NextSceneID++;CCEngine.NewScene(this);this.enabled=true;this.deletingScene=false;this.objects=[];this.collideables=[];if(!this.parentScene){this.parentScene=null}this.linkedScenes=[];this.lifetime=0};CCSceneBase.prototype.destruct=function(){this.deleteLater();var objects=this.objects;while(objects.length>0){objects[0].destruct()}this.enabled=false};CCSceneBase.prototype.deleteLater=function(){MultiplayerManager.UpdateCallbacks.remove(this);CCEngine.DisableBackButton(this);var collideables=this.collideables;for(var i=0;i<collideables.length;++i){var collideable=collideables[i];collideable.collideableType=CC.collision_none}this.deletingScene=true;this.deleteLinkedScenesLater();if(this.parentScene){this.parentScene.deletingChild(this);this.parentScene=null}};CCSceneBase.prototype.setup=function(){};CCSceneBase.prototype.resize=function(){};CCSceneBase.prototype.resized=function(){};CCSceneBase.prototype.deleteLaterFromParent=function(){this.deleteLater()};CCSceneBase.prototype.deleteLinkedScenesLater=function(){var linkedScenes=this.linkedScenes;while(linkedScenes.length>0){var linkedScene=linkedScenes[0];linkedScene.unlinkScene(this);
linkedScenes.remove(linkedScene);linkedScene.deleteLaterFromParent()}};CCSceneBase.prototype.shouldDelete=function(){return this.deletingScene};CCSceneBase.prototype.updateControls=function(controls){return false};CCSceneBase.prototype.update=function(delta){this.lifetime+=delta;if(this.enabled){var updated=this.updateScene(delta);updated|=this.updateCamera(delta);return updated}return false};CCSceneBase.prototype.updateScene=function(delta){var objects=this.objects;for(var i=0;i<objects.length;++i){var object=objects[i];if(object.deletingObjectCountdown===0){object.update(delta)}else if(object.deletingObjectCountdown>0){if(--object.deletingObjectCountdown===0){object.destruct();--i}}}};CCSceneBase.prototype.updateCamera=function(delta){};CCSceneBase.prototype.render=function(camera,pass,alpha){var objects=this.objects;var length=objects.length;for(var i=0;i<length;++i){var object=objects[i];if(object.renderPass===pass){if(!object.octreeRender&&object.deletingObjectCountdown===0){object.renderObject(camera,alpha)}}}};CCSceneBase.prototype.renderVisibleObject=function(object,camera,pass,alpha){if(camera===gEngine.cameras[0]){object.renderObject(camera,alpha)}};CCSceneBase.prototype.addObject=function(object){object.inScene=this;this.objects.push(object)};CCSceneBase.prototype.removeObject=function(object){object.inScene=null;this.objects.remove(object)};CCSceneBase.prototype.addCollideable=function(collideable){this.collideables.add(collideable);gEngine.collisionManager.addCollideable(collideable);if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCSceneBase.addCollideable;"+this.sceneID+";"+collideable.jsID+"\n"}};CCSceneBase.prototype.removeCollideable=function(collideable){this.collideables.remove(collideable);gEngine.collisionManager.removeCollideable(collideable);if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCSceneBase.removeCollideable;"+this.sceneID+";"+collideable.jsID+"\n"}};CCSceneBase.prototype.setParent=function(inParent){this.parentScene=inParent};CCSceneBase.prototype.deletingChild=function(inScene){var keys=Object.keys(this);for(var i=0;i<keys.length;++i){var key=keys[i];if(this[key]===inScene){this[key]=null}}};CCSceneBase.prototype.linkScene=function(inScene){this.linkedScenes.add(inScene)};CCSceneBase.prototype.unlinkScene=function(inScene){this.linkedScenes.remove(inScene);if(inScene===this.parentScene){this.parentScene.deletingChild(this);this.parentScene=null}};function CCSceneAppUI(){this.construct()}ExtendPrototype(CCSceneAppUI,CCSceneBase);CCSceneAppUI.tile_touchNone=0;CCSceneAppUI.tile_touchCollision=1;CCSceneAppUI.tile_touchAction=2;CCSceneAppUI.prototype.construct=function(){this.CCSceneBase_construct();this.tiles=[];this.cameraStickyTiles=[];this.touchDelta=new CCPoint;this.camera=null;this.cameraCentered=false;this.cameraReletivePositions=false;this.cameraScrolling=false;this.controlsEnabled=true;this.controlsFirstTouchedInThisScene=false;this.controlsMoving=false;this.controlsSwipeMomentum=false;this.minZoomOffset=1;this.maxZoomOffset=1e3;this.resizing=false;this.resizeCallbacks=[];this.scrollBar=null;this.timers=[]};CCSceneAppUI.prototype.destruct=function(){this.resizeCallbacks.length=0;if(this.camera){gEngine.removeCamera(this.camera);delete this.camera}this.CCSceneBase_destruct()};CCSceneAppUI.prototype.setup=function(){if(!this.camera){var camera=gEngine.newSceneCamera(this);camera.setupViewport(0,0,1,1)}this.camera.setCameraWidth(640);this.refreshCameraView();this.lockCameraView()};CCSceneAppUI.prototype.requestResize=function(){if(this.camera){this.resize()}};CCSceneAppUI.prototype.resize=function(){var camera=this.camera;CC.ASSERT(camera);var previousCameraHeight=camera.targetHeight;camera.recalcViewport();camera.setCameraWidth(camera.targetWidth);if(this.cameraCentered){if(this.cameraReletivePositions){var objects=this.objects;for(i=0;i<objects.length;++i){var object=objects[i];var y=this.getReletiveY(object,previousCameraHeight);this.setReletiveY(object,y)}}}else{var newCameraHeight=camera.targetHeight;var heightDifference=previousCameraHeight-newCameraHeight;camera.targetLookAt[1]+=heightDifference*.5}var resizeCallbacks=this.resizeCallbacks;resizeCallbacks.emit();this.resizing=true};CCSceneAppUI.prototype.resized=function(){if(!this.cameraCentered){this.refreshCameraView();this.lockCameraView();var camera=this.camera;camera.setLookAt(camera.targetLookAt,false);camera.flagUpdate()}};CCSceneAppUI.prototype.updateControls=function(controls){if(this.resizing){return false}var cameraRelativeTouches=this.camera.getRelativeTouches(controls.touches);var usingControls=this.handleTouches(cameraRelativeTouches[0],cameraRelativeTouches[1]);if(!usingControls){return this.CCSceneBase_updateControls(controls)}return usingControls};CCSceneAppUI.prototype.handleTouches=function(touch1,touch2){var usingControls=false;if(touch1.usingTouch&&touch2.usingTouch){if(this.touchAllowed(touch1)){if(this.controlsTouching===touch1){this.touchReleased(touch1,CCControls.touch_lost)}if(this.controlsTouching!==touch2){this.twoTouchesRegistered(touch1,touch2)}usingControls=this.handleTwoTouches(touch1,touch2)}}else{if(touch2.lastTimeReleased>0&&this.touchAllowed(touch1)){if(this.controlsTouching!==touch1){this.controlsFirstTouchedInThisScene=touch1.state===CCControls.touch_pressed;this.oneTouchRegistered(touch1)}usingControls=this.handleOneTouch(touch1)}else if(this.controlsTouching){if(this.controlsFirstTouchedInThisScene){if(this.controlsTouching===touch1&&touch1.state===CCControls.touch_released){usingControls=this.touchReleased(touch1,CCControls.touch_released)}else{this.touchReleased(touch1,CCControls.touch_lost)}}else{this.touchReleased(touch1,CCControls.touch_lost)}this.lockCameraView();if(this.controlsMoving){this.controlsMoving=false}this.controlsTouching=false}}return usingControls};CCSceneAppUI.prototype.updateScene=function(delta){var updated=this.CCSceneBase_updateScene(delta);{var timers=this.timers;var length=timers.length;for(var i=0;i<length;++i){var timer=timers[i];if(!timer.update(delta)){timers.remove(timer);timer.finish();length=timers.length;--i}}}return updated};CCSceneAppUI.prototype.updateCamera=function(delta){var updated=false;var lookAtSpeed=this.controlsMoving&&!this.cameraScrolling?20:1.5;if(this.camera.interpolateCamera(delta,lookAtSpeed)){if(this.scrollBar){}var cameraStickyTiles=this.cameraStickyTiles;for(var i=0;i<cameraStickyTiles.length;++i){var tile=cameraStickyTiles[i];tile.setPosition(this.camera.currentLookAt)}updated=true}else{if(this.cameraScrolling){this.cameraScrolling=false;this.lockCameraView();updated=true}if(this.resizing){this.resizing=false;this.refreshCameraView();this.lockCameraView();updated=true}}return updated};CCSceneAppUI.prototype.render=function(camera,pass,alpha){if(this.camera===camera){this.CCSceneBase_render(camera,pass,alpha)}};CCSceneAppUI.prototype.renderVisibleObject=function(object,camera,pass,alpha){if(this.camera===camera){object.renderObject(camera,alpha)}};CCSceneAppUI.prototype.refreshCameraView=function(){this.sceneLeft=0;this.sceneRight=0;this.sceneTop=0;this.sceneBottom=0};CCSceneAppUI.prototype.lockCameraView=function(){if(this.cameraScrolling){return}this.camera.flagUpdate();gRenderer.pendingRender=true;this.camera.targetLookAt[0]=0;this.camera.targetLookAt[1]=0};CCSceneAppUI.prototype.scrollCameraToTop=function(){this.camera.targetLookAt[1]=this.sceneTop;this.camera.flagUpdate()};CCSceneAppUI.prototype.addTile=function(inTile,index){this.tiles.push(inTile);if(index!==undefined){this.tiles.insert(inTile,index)}};CCSceneAppUI.prototype.touchAllowed=function(touch){if(this.enabled&&this.controlsEnabled){if(touch.state<CCControls.touch_released){return touch.x>0&&touch.x<1&&touch.y>0&&touch.y<1&&touch.startX>0&&touch.startX<1&&touch.startY>0&&touch.startY<1}}return false};CCSceneAppUI.prototype.handleOneTouch=function(touch1){var usingControls=false;this.touchDelta.x=touch1.deltaX;this.touchDelta.y=touch1.deltaY;if(!this.controlsMoving){if(this.touchMovementAllowed(touch1,this.touchDelta)){}else{usingControls=this.touchPressed(touch1)}}if(this.controlsMoving){usingControls=this.touchMoving(touch1,this.touchDelta)}return usingControls};CCSceneAppUI.prototype.handleTwoTouches=function(touch1,touch2){return false};CCSceneAppUI.prototype.oneTouchRegistered=function(touch){this.controlsTwoTouchAction=CCControls.twotouch_unassigned;this.controlsTouching=touch};CCSceneAppUI.prototype.twoTouchesRegistered=function(touch1,touch2){this.controlsTwoTouchAction=CCControls.twotouch_unassigned;this.controlsTouching=touch2};CCSceneAppUI.prototype.touchPressed=function(touch){return this.handleTilesTouch(touch,CCControls.touch_pressed)>=CCSceneAppUI.tile_touchCollision};CCSceneAppUI.prototype.touchMovementAllowed=function(touch,touchDelta){var absDeltaX=Math.abs(touch.totalDeltaX);var absDeltaY=Math.abs(touch.totalDeltaY);if(absDeltaX>CCControls.TouchMovementThreashold.x||absDeltaY>CCControls.TouchMovementThreashold.y){this.controlsMoving=true;touchDelta.x+=touch.totalDeltaX;touchDelta.y+=touch.totalDeltaY;this.controlsMovingVertical=absDeltaY>absDeltaX;return true}return false};CCSceneAppUI.prototype.touchMoving=function(touch,touchDelta){var result=this.handleTilesTouch(touch,this.controlsMovingVertical?CCControls.touch_movingVertical:CCControls.touch_movingHorizontal);if(result===CCSceneAppUI.tile_touchAction){return true}else{return this.touchCameraMoving(touchDelta.x,touchDelta.y)}};CCSceneAppUI.prototype.touchCameraMoving=function(x,y){var camera=this.camera;var delta;if(this.controlsMovingVertical){if(y!==0){delta=y*camera.cameraHeight;if(camera.targetLookAt[1]>this.sceneTop||camera.targetLookAt[1]<this.sceneBottom){delta*=.5}camera.targetLookAt[1]+=delta;var cameraHeightStretch=camera.targetHeight*.1;camera.targetLookAt[1]=CC.FloatClamp(camera.targetLookAt[1],this.sceneBottom-cameraHeightStretch,this.sceneTop+cameraHeightStretch);camera.flagUpdate();return true}}else{if(x!==0){delta=x*camera.cameraWidth;if(camera.targetLookAt[0]>this.sceneRight||camera.targetLookAt[0]<this.sceneLeft){delta*=.5}camera.targetLookAt[0]-=delta;var cameraWidthStretch=camera.targetWidth*.1;camera.targetLookAt[0]=CC.FloatClamp(camera.targetLookAt[0],this.sceneLeft-cameraWidthStretch,this.sceneRight+cameraWidthStretch);camera.flagUpdate();return true}}return true};CCSceneAppUI.prototype.touchCameraZooming=function(amount){var camera=this.camera;camera.targetOffset[2]-=amount*2*camera.offset[2];camera.targetOffset[2]=CC.FloatClamp(camera.targetOffset[2],this.minZoomOffset,this.maxZoomOffset);camera.flagUpdate();return false};CCSceneAppUI.prototype.touchCameraRotating=function(x,y){var camera=this.camera;var rotation=camera.rotation;rotation[1]+=-x*180;rotation[1]=CC.FloatClamp(rotation[1],-45,45);camera.setRotationY(rotation[1]);rotation[0]+=-y*180;rotation[0]=CC.FloatClamp(rotation[0],-45,45);camera.setRotationX(rotation[0]);camera.flagUpdate();return true};CCSceneAppUI.prototype.touchReleased=function(touch,touchAction){var result=this.handleTilesTouch(touch,touchAction);var usingControls=result===CCSceneAppUI.tile_touchAction;if(!usingControls&&touchAction===CCControls.touch_released){usingControls=this.touchReleaseSwipe(touch)}return usingControls};CCSceneAppUI.prototype.handleTilesTouch=function(touch,touchAction){var camera=this.camera;if(camera.project3D(touch.x,touch.y)){var tiles=this.tiles;var projectionResults=camera.projectionResults;var hitPosition=vec3.create();var hitObject=CC.BasicLineCollisionCheck(tiles,projectionResults.vNear,projectionResults.vFar,hitPosition,true,CC.collision_ui);if(!hitObject){hitPosition=projectionResults.vLookAt}var actioned=false;var length=tiles.length;for(var i=0;i<length;++i){var tile=tiles[i];if(tile.handleProjectedTouch(projectionResults,hitObject,hitPosition,touch,touchAction)){actioned|=true;if(touchAction<CCControls.touch_released){break}}}if(actioned){return CCSceneAppUI.tile_touchAction}if(hitObject){return CCSceneAppUI.tile_touchCollision}}return CCSceneAppUI.tile_touchNone};CCSceneAppUI.prototype.touchReleaseSwipe=function(touch){if(this.controlsSwipeMomentum){var maxTimeHeld=.5;if(touch.timeHeld<maxTimeHeld){var camera=this.camera;var minMovementThreashold=.1;if(this.controlsMovingVertical){if(touch.totalDeltaY<-minMovementThreashold){camera.targetLookAt[1]-=camera.cameraHHeight*.5;camera.flagUpdate();this.lockCameraView();return true}else if(touch.totalDeltaY>minMovementThreashold){camera.targetLookAt[1]+=camera.cameraHHeight*.5;camera.flagUpdate();this.lockCameraView();return true}}else{if(touch.totalDeltaX<-minMovementThreashold){camera.targetLookAt[0]+=camera.cameraHWidth;camera.flagUpdate();this.lockCameraView();return true}else if(touch.totalDeltaX>minMovementThreashold){camera.targetLookAt[0]-=camera.cameraHWidth;camera.flagUpdate();this.lockCameraView();return true}}}}return false};CCSceneAppUI.prototype.getReletiveWidth=function(object){return object.collisionSize.width/this.camera.targetWidth};CCSceneAppUI.prototype.getReletiveHeight=function(object){return object.collisionSize.height/this.camera.targetHeight};CCSceneAppUI.prototype.getReletiveX=function(object){var x=object.position[0];return x/(this.camera.targetWidth*.5)};CCSceneAppUI.prototype.getReletiveY=function(object,screenHeight){if(screenHeight===undefined){screenHeight=this.camera.targetHeight}var y=object.position[1];return y/(screenHeight*.5)};CCSceneAppUI.prototype.setReletiveWidth=function(object,value){value*=this.camera.targetWidth;var aspectRatio=object.collisionSize.height/object.collisionSize.width;if(object.aspectRatioLocked){object.setTileSize(value,value*aspectRatio)}else{object.setTileSize(value,object.collisionSize.height)}};CCSceneAppUI.prototype.setReletiveHeight=function(object,value){value*=this.camera.targetHeight;var aspectRatio=object.collisionSize.height/object.collisionSize.width;if(object.aspectRatioLocked){object.setTileSize(value/aspectRatio,value)}else{object.setTileSize(object.collisionSize.width,value)}};CCSceneAppUI.prototype.setReletiveX=function(object,value){var hCameraWidth=this.camera.targetWidth*.5;value*=hCameraWidth;var hWidth=object.collisionBounds[0];object.setPositionX(value)};CCSceneAppUI.prototype.setReletiveY=function(object,value){var hCameraHeight=this.camera.targetHeight*.5;value*=hCameraHeight;var hHeight=object.collisionBounds[1];object.setPositionY(value)};function CCMP3(){this.stop=function(){if(this.audio){if(this.onEndLoopFunction){this.audio.removeEventListener("end",this.onEndLoopFunction);delete this.onEndLoopFunction}this.audio.pause()}};this.pause=function(){if(this.audio&&!this.audio.paused){this.audio.pause()}};this.resume=function(){if(this.loaded&&this.audio&&!this.audio.ended){this.audio.play()}};this.mute=function(toggle){if(this.audio){this.audio.muted=toggle}};this.isPlaying=function(){if(this.audio){return!this.audio.paused}}}CCAudioManager.Play=function(id,url,restart,loop,callback){CCAudioManager.Prepare(id,url,function(mp3){if(restart&&mp3.audio.currentTime>0){mp3.audio.currentTime=0}if(mp3.audio.paused){mp3.audio.play()}if(loop){if(!mp3.onEndLoopFunction){mp3.onEndLoopFunction=function(){mp3.audio.currentTime=0;mp3.audio.play()};mp3.audio.addEventListener("ended",mp3.onEndLoopFunction)}}else{if(mp3.onEndLoopFunction){mp3.audio.removeEventListener("ended",mp3.onEndLoopFunction);delete mp3.onEndLoopFunction}}mp3.mute(CCAudioManager.Enabled?false:true);if(CCAudioManager.Paused){CCAudioManager.Pause()}if(callback){callback()}})};CCAudioManager.Prepared=function(id,url,binary){var mp3=CCAudioManager.Get(id);if(mp3){if(mp3.url===url){var downloadedURL;if(CCEngine.NativeUpdateCommands!==undefined){downloadedURL=binary}else if(window.tizen){downloadedURL=MultiplayerManager.GetAssetURL(url)}else{var windowURL=window.URL||window.webkitURL;if(windowURL&&windowURL.createObjectURL){var blob=new Blob([binary]);var blobURL=windowURL.createObjectURL(blob);downloadedURL=blobURL}}if(downloadedURL){var audio=new Audio;audio.controls=true;audio.preload="auto";audio.addEventListener("error",function(e){mp3.error=true;delete mp3.onLoadedCallbacks},false);audio.src=downloadedURL;mp3.audio=audio;mp3.loaded=false;mp3.onReadyingToPlayFunction=function(){mp3.loaded=true;audio.pause();audio.removeEventListener("playing",mp3.onReadyingToPlayFunction);delete mp3.onReadyingToPlayFunction;if(mp3.onLoadedCallbacks){for(var i=0;i<mp3.onLoadedCallbacks.length;++i){mp3.onLoadedCallbacks[i](mp3)}delete mp3.onLoadedCallbacks}};audio.addEventListener("playing",mp3.onReadyingToPlayFunction);audio.play()}}}};function CCFileManager(){}CCFileManager.SingletonConstructor=function(){this.DBName="cache";this.Loading=null;this.LoadQueue=[];this.LoadingQueue=[];var self=this;var indexedDB=window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.msIndexedDB;if(indexedDB){var dbVersion=8;var request=indexedDB.open(CCFileManager.DBName,dbVersion);var SetVersion=function(db){if(db.objectStoreNames.contains(CCFileManager.DBName)){db.deleteObjectStore(CCFileManager.DBName)}var objectStore=db.createObjectStore(CCFileManager.DBName,{keyPath:"key"})};request.onupgradeneeded=function(event){var db=event.currentTarget.result;SetVersion(db)};request.onsuccess=function(event){if(window.localStorage){if(window.localStorage.getItem(CCFileManager.DBName)){window.localStorage.removeItem(CCFileManager.DBName)}}var db=request.result;if(db.setVersion){var cacheFound=false;if(db.objectStoreNames.contains(CCFileManager.DBName)){cacheFound=true}if(!cacheFound||db.version!==dbVersion){var req=db.setVersion(dbVersion);req.onsuccess=function(){SetVersion(db);self.db=db};req.onerror=function(){self.db=false};return}}self.db=db;self.LoadedDB()};request.onerror=function(event){self.db=false;self.LoadedDB()}}else{self.db=false;self.LoadedDB()}};CCFileManager.LoadedDB=function(){for(var i=0;i<this.LoadingQueue.length;++i){var action=this.LoadingQueue[i];if(action.action==="save"){this.Save(action.key,save.data)}else if(action.action==="delete"){this.Delete(action.key)}}delete this.LoadingQueue;this.Loaded()};CCFileManager.Loaded=function(){if(CCFileManager.LoadQueue.length>0){var self=this;var packet=CCFileManager.LoadQueue.safePop();CCFileManager.Loading=packet.key;this.ProcessLoad(packet.key,function(data){packet.onLoad(data);self.Loaded()})}else{CCFileManager.Loading=null}};CCFileManager.Load=function(key,onLoad,priority){if(onLoad){var self=this;if(!CCFileManager.Loading&&this.db!==undefined){CCFileManager.Loading=key;this.ProcessLoad(key,function(data){onLoad(data);self.Loaded()})}else{var packet={};packet.key=key;packet.onLoad=onLoad;CCFileManager.LoadQueue.push(packet);if(priority>0){CCFileManager.LoadQueue.insert(packet,0)}}}};CCFileManager.ProcessLoad=function(key,onLoad){var db=this.db;if(db){var self=this;var transaction=db.transaction(CCFileManager.DBName,"readwrite");var objectStore=transaction.objectStore(CCFileManager.DBName);var request=objectStore.get(key);request.onerror=function(event){onLoad(undefined)};request.onsuccess=function(event){var item=event.target.result;if(item){var data=item.data;if(data&&data.length>0){item.timestamp=Date.now();self.UpdateTimestamp(item,item.key);onLoad(data);return}}onLoad(undefined)}}else{var data=CC.LoadLocalStorageCache(key);onLoad(data)}};CCFileManager.Stringify=function(json,callback){var windowURL=window.URL||window.webkitURL;if(window.Worker&&windowURL&&windowURL.createObjectURL){var self=this;if(!CCFileManager.workerJSONStringify){var blob=new Blob(["self.addEventListener( 'message', function (e) {   var data = e.data;  if( data.json ) {       self.postMessage( JSON.stringify( data.json ) );   }   else if( data.close ) {       self.close();   }   }, false );"],{type:"text/javascript"});var blobURL=windowURL.createObjectURL(blob);CCFileManager.workerJSONStringify=new Worker(blobURL)}if(window.DEBUG_IsLocalClient){}var worker=CCFileManager.workerJSONStringify;worker.onmessage=function(e){if(window.DEBUG_IsLocalClient){}CCEngine.RunNextUpdate(function(){callback(e.data)})};worker.postMessage({json:json});return}else{callback(JSON.stringify(json))}};CCFileManager.Save=function(key,data){if(typeof data==="object"){CCFileManager.Stringify(data,function(string){CCFileManager.Save(key,string)});return}if(data){if(data.length===0||data==="[]"){CCFileManager.Delete(key)}else{if(this.db===undefined){this.LoadingQueue.push({action:"save",key:key,data:data});return}var db=this.db;if(db){var item={};item.key=key;item.timestamp=Date.now();item.data=data;var self=this;var transaction=db.transaction(CCFileManager.DBName,"readwrite");var objectStore=transaction.objectStore(CCFileManager.DBName);var request=objectStore.put(item);request.onerror=function(event){self.Trim(function(){self.Save(key,data)})};request.onsuccess=function(event){if(window.DEBUG_IsLocalClient){console.log("CCFileManager.Saved",event.target.result)}}}else{CC.SaveLocalStorageCache(key,data)}}}};CCFileManager.UpdateTimestamp=function(item,index){var db=this.db;if(db){var transaction=db.transaction(CCFileManager.DBName,"readwrite");var objectStore=transaction.objectStore(CCFileManager.DBName);var request=objectStore.put(item);request.onerror=function(event){};request.onsuccess=function(event){}}};CCFileManager.Delete=function(key,onDelete){var db=this.db;if(this.db===undefined){this.LoadingQueue.push({action:"delete",key:key,data:data});return}if(db){var self=this;var transaction=db.transaction(CCFileManager.DBName,"readwrite");var objectStore=transaction.objectStore(CCFileManager.DBName);var request=objectStore.delete(key);request.onerror=function(event){self.DeleteAll(onDelete)};request.onsuccess=function(event){if(window.DEBUG_IsLocalClient){console.log("CCFileManager.Deleted",key)}if(onDelete){onDelete()}}}else{CC.DeleteLocalStorageCache(key)}};CCFileManager.DeleteAll=function(onDelete){if(window.DEBUG_IsLocalClient){console.log("CCFileManager.DeleteAll")}var db=this.db;if(db){var transaction=db.transaction(CCFileManager.DBName,"readwrite");var objectStore=transaction.objectStore(CCFileManager.DBName);var request=objectStore.clear();request.onerror=function(event){if(window.console&&console.log){console.log(event)}};request.onsuccess=function(event){if(onDelete){onDelete()}}}};CCFileManager.Trim=function(onTrimmed){if(onTrimmed){var db=this.db;if(db){var self=this;var transaction=db.transaction(CCFileManager.DBName,"readwrite");var objectStore=transaction.objectStore(CCFileManager.DBName);var request=objectStore.openCursor();request.onerror=function(event){self.DeleteAll(onTrimmed)};var oldestItem;var oldestTime=Date.now();request.onsuccess=function(event){var cursor=event.target.result;if(cursor){var item=cursor.value;if(item.timestamp<oldestTime){oldestItem=item;oldestTime=item.timestamp;console.log("CCFileManager.Trim consider",item)}cursor.continue();return}if(oldestItem){if(window.DEBUG_IsLocalClient){console.log("CCFileManager.Trim delete",oldestItem)}self.Delete(oldestItem.key,onTrimmed)}else{if(window.DEBUG_IsLocalClient){console.log("CCFileManager.Trim delete all")}self.DeleteAll(onTrimmed)}}}}};CCFileManager.SingletonConstructor();CCURLManager.prototype.create=function(){this.domainTimeOuts=[];this.finish();this.xhr=new XMLHttpRequest;return this};CCURLManager.prototype.ready=function(){if(!this.request){if(this.xhr.readyState===4||this.xhr.readyState===0){return true}}return false};CCURLManager.prototype.open=function(){var xhr=this.xhr;var request=this.request;if(request.postData){xhr.open("POST",request.url,true)}else{xhr.open("GET",request.url,true)}if(request.returnBinary){xhr.responseType="arraybuffer"}else{xhr.responseType=""}var self=this;xhr.onreadystatechange=function(){self.receiveData()}};CCURLManager.prototype.start=function(){this.xhr.send(this.request.postData)};CCURLManager.prototype.finish=function(){this.request=false};CCURLManager.prototype.requestURL=function(url,postData,callback,priority,cacheFile,cacheFileTimeoutSeconds,timeout,returnBinary){if(postData){var formData=new FormData;for(var key in postData){formData.append(key,postData[key])}postData=formData}if(!priority){priority=0}if(!cacheFile){cacheFile=null}if(cacheFileTimeoutSeconds===undefined||cacheFileTimeoutSeconds===null){cacheFileTimeoutSeconds=-1}if(timeout===undefined||timeout===null){timeout=0}var request=new CCURLRequest(url,postData,callback,priority,cacheFile,cacheFileTimeoutSeconds,timeout,returnBinary);this.requests.push(request);if(priority>0){this.requests.insert(request,0)}CCURLManager.RequestUpdate()};CCURLManager.RequestUpdate=function(){if(!CCURLManager.RequestingUpdate){CCURLManager.RequestingUpdate=true;setTimeout(function(){CCURLManager.Update()},window.DEBUG_SlowNetwork?2e3:10)}};CCURLManager.prototype.updateRequestPriority=function(url,filename,priority){if(priority>0){var request=this.findRequest(url,filename);if(request){this.requests.insert(request,0)}}};CCURLManager.Update=function(){CCURLManager.RequestingUpdate=false;var self=gURLManager;var CheckCacheFunction=function(request){return function(data){delete request.checkingCache;if(data!==undefined){if(request.callback){requests.remove(request);if(request.callback.run){request.callback.run(CCURLRequest.Used_Cache,data,null)}else{request.callback(CCURLRequest.Used_Cache,data,null)}}}CCURLManager.RequestUpdate()}};var requests=self.requests;for(var i=0;i<requests.length;++i){var request=requests[i];if(window.gEngine&&request.timeRequestable>gEngine.lifetime){continue}if(request.checkingCache){continue}if(!request.postData&&!request.checkedCache&&request.cacheFileTimeoutSeconds!==0){request.checkedCache=true;var cacheFile=request.cacheFile;if(cacheFile){request.checkingCache=true;CCFileManager.Load(cacheFile,new CheckCacheFunction(request),request.priority);continue}}if(self.ready()){var domainTimeOuts=self.domainTimeOuts;var length=domainTimeOuts.length;for(var domainIndex=0;domainIndex<domainTimeOuts.length;++domainIndex){var domainTimeOut=domainTimeOuts[domainIndex];if(request.url.split(domainTimeOut.name).length>1){var nextRequestTime=domainTimeOut.lastRequested+domainTimeOut.timeout;if(gEngine.lifetime<nextRequestTime){break}domainTimeOut.lastRequested=gEngine.lifetime;break}}requests.remove(request);self.download(request);break}}if(requests.length>0){CCURLManager.RequestUpdate()}};CCURLManager.prototype.receiveData=function(){var xhr=this.xhr;if(xhr.readyState===4){var request=this.request;var state=xhr.status===200||xhr.status===0?CCURLRequest.Succeeded:CCURLRequest.Failed;var response;if(request.returnBinary){response=xhr.response?new Uint8Array(xhr.response):null}else{response=xhr.responseText}var runCallback=true;if(request.cacheFile){if(state===CCURLRequest.Succeeded){CCFileManager.Save(request.cacheFile,response)}else{var CheckCacheFunction=function(request){return function(data){if(data!==undefined){if(request.callback.run){request.callback.run(CCURLRequest.Used_Cache,data,null)}else{request.callback(CCURLRequest.Used_Cache,data,null)}}else{request.callback(CCURLRequest.Failed,null,null)}CCURLManager.RequestUpdate()}};if(request.callback){CCFileManager.Load(request.cacheFile,new CheckCacheFunction(request),request.priority)}runCallback=false}}if(runCallback&&request.callback){if(request.callback.run){request.callback.run(state,response,xhr)}else{request.callback(state,response,xhr)}}this.finish();if(this.requests.length>0){CCURLManager.RequestUpdate()}}};CCURLManager.prototype.download=function(request){this.request=request;this.open();this.start()};CCURLManager.prototype.setDomainTimeOut=function(domain,timeout){var domainTimeOuts=this.domainTimeOuts;var length=domainTimeOuts.length;for(var i=0;i<length;++i){if(domainTimeOuts[i].name===domain){return}}var domainTimeOut={};domainTimeOut.name=domain;domainTimeOut.timeout=timeout;domainTimeOut.lastRequested=0;domainTimeOuts.push(domainTimeOut)};var RootWindow=window;while(RootWindow.parent){if(RootWindow.parent===RootWindow){break}try{if(RootWindow.parent.document){RootWindow=RootWindow.parent}else{break}}catch(e){break}}function CCWheel(){this.delta=0}CCControls.prototype.create=function(table){this.table=table;this.wheel=new CCWheel;this.documentScroller=document.documentElement.scrollTop?document.documentElement:document.body;this.tolerance=0;if(BrowserType["mobile"]){this.tolerance=20}var self=this;{document.addEventListener("touchstart",function(event){self.touchStart(event)},false);document.addEventListener("touchmove",function(event){self.touchMove(event)},false);document.addEventListener("touchend",function(event){self.touchEnd(event)},false);document.addEventListener("touchcancel",function(event){},false);document.addEventListener("gesturestart",function(event){},true);document.addEventListener("gesturechange",function(event){},true);document.addEventListener("gestureend",function(event){},true);if(!BrowserType["mobile"]){document.onmousedown=function(event){return self.mouseDown(event)};document.onmousemove=function(event){self.mouseMove(event)};document.onmouseup=function(event){self.mouseUp(event)};RootWindow.onmousewheel=document.onmousewheel=function(event){self.mouseWheel(event)};if(RootWindow.addEventListener){RootWindow.addEventListener("DOMMouseScroll",function(event){self.mouseWheel(event)},true)}RootWindow.onkeydown=function(event){return self.keyDown(event)};RootWindow.onkeyup=function(event){return self.keyUp(event)};RootWindow.addEventListener("paste",function(e){e.preventDefault();var text=e.clipboardData.getData("text/plain");self.textInput(text)});RootWindow.addEventListener("dragenter",function(event){self.dragEnter(event)},false);RootWindow.addEventListener("dragexit",function(event){self.dragExit(event)},false);RootWindow.addEventListener("dragover",function(event){self.dragOver(event)},false);RootWindow.addEventListener("drop",function(event){self.dragDrop(event)},false);window.onhashchange=function(event){var newURL=event.newURL;if(CC.PendingURLStack&&CC.PendingURLStack.length>0){var firstPendingURL=CC.PendingURLStack[0];if(newURL===firstPendingURL){CC.PendingURLStack.safePop();return}}if(CC.WindowURL!==event.newURL&&!CC.WindowURLUpdatesDisabled){CC.WindowURLUpdatesDisabled=true;while(gEngine.scenes.length>0){gEngine.removeScene(gEngine.scenes.last())}delete CC.WindowURLUpdatesDisabled;CC.SetWindowURL(event.newURL,true);window.APP_ID=CC.GetJSLocationBarData("id");if(!window.APP_ID){window.APP_ID="multi"}gEngine.start()}}}}return this};CCControls.prototype.handleControls=function(touch,state){var table=this.table;var touchOverTable=this.isOverObject(touch,table);if(!touchOverTable){state=CCControls.touch_lost}else{if(state===CCControls.touch_moving){if(touch.state>=CCControls.touch_released){state=CCControls.touch_lost}}}if(touch.touchMovingState){if(touch.touchMovingState!==state){this.updateTouch(touch,touch.touchMovingState);touch.touchMovingState=false;gEngine.updateControls()}}if(state===CCControls.touch_pressed){this.updateTouch(touch,state);CCEngine.RunNextUpdate(function(){gEngine.updateControls()})}else if(state>=CCControls.touch_released){this.updateTouch(touch,state);CCEngine.RunNextUpdate(function(){gEngine.updateControls()})}else{touch.touchMovingState=state}return touchOverTable};CCControls.prototype.updateTouch=function(touch,state){var table=this.table;var tableDimensions=table.dimensions;var x=(touch.rawX-tableDimensions.x)/tableDimensions.totalWidth;var y=(touch.rawY-tableDimensions.y)/tableDimensions.totalHeight;this.updateTouchXY(touch,state,x,y)};CCControls.prototype.leftClick=function(event){var leftClick=false;if(!event){event=RootWindow.event}if(!event){return false}if(event.which){leftClick=event.which===1}else if(event.button){leftClick=event.button===1||event.button===0}return leftClick};CCControls.prototype.mouseUpdate=function(event){if(!event){event=RootWindow.event}var x,y;if(event.pageX){x=event.pageX}else{x=event.clientX;x+=this.documentScroller.scrollLeft}if(event.mouseY){y=event.pageY}else{y=event.clientY;y+=this.documentScroller.scrollTop}var touch=this.touches[0];
touch.rawX=x;touch.rawY=y};CCControls.prototype.touchUpdate=function(event){var touches=this.touches;for(var i=0;i<event.touches.length&&i<touches.length;++i){var touchEvent=event.touches[i];if(touchEvent){var touch=touches[i];touch.rawX=touchEvent.clientX;touch.rawY=touchEvent.clientY}}};CCControls.prototype.isOverObject=function(touch,target){return this.isOverObjectTolerated(touch,target,this.tolerance,this.tolerance)};CCControls.prototype.isOverObjectTolerated=function(touch,target,xTolerance,yTolerance){var dimensions=target.dimensions;var table=target.table;var x=touch.rawX;var y=touch.rawY;var x1=dimensions.x;var y1=dimensions.y;var x2=x1+dimensions.totalWidth;var y2=y1+dimensions.totalHeight;x1-=xTolerance;y1-=yTolerance;x2+=xTolerance;y2+=yTolerance;if(x>x1&&x<x2&&y>y1&&y<y2){this.overObject=target;return true}return false};CCControls.prototype.mouseDown=function(event){if(!event){event=RootWindow.event}if(!this.leftClick(event)){return true}this.clicking=true;this.mouseUpdate(event);var touch=this.touches[0];if(this.handleControls(touch,CCControls.touch_pressed)){if(event){if(event.preventDefault){event.preventDefault()}else{event.returnValue=false}}return false}return true};CCControls.prototype.touchStart=function(event){this.touchUpdate(event);var touches=this.touches;for(var i=0;i<event.touches.length&&i<touches.length;++i){var touch=touches[i];if(this.handleControls(touch,CCControls.touch_pressed)){event.preventDefault()}}};CCControls.prototype.mouseUp=function(event){if(!this.leftClick(event))return;var touch=this.touches[0];this.handleControls(touch,CCControls.touch_released);this.clicking=false};CCControls.prototype.touchEnd=function(event){var touches=this.touches;for(var i=0;i<touches.length;++i){var touch=this.touches[i];if(this.handleControls(touch,CCControls.touch_released)){event.preventDefault()}}};CCControls.prototype.mouseMove=function(event){if(!this.clicking)return;this.mouseUpdate(event);var touch=this.touches[0];this.handleControls(touch,CCControls.touch_moving)};CCControls.prototype.touchMove=function(event){this.touchUpdate(event);var touches=this.touches;for(var i=0;i<event.touches.length&&i<touches.length;++i){var touch=touches[i];if(this.handleControls(touch,CCControls.touch_moving)){event.preventDefault()}}};CCControls.prototype.dragEnter=function(event){event.stopPropagation();event.preventDefault()};CCControls.prototype.dragExit=function(event){event.stopPropagation();event.preventDefault()};CCControls.prototype.dragOver=function(event){event.stopPropagation();event.preventDefault()};CCControls.prototype.dragDrop=function(event){event.stopPropagation();event.preventDefault();var onDragDropLoad=this.onDragDropLoad;var OnLoadFunction=function(file){return function(event){if(onDragDropLoad){for(i=0;i<onDragDropLoad.length;++i){if(onDragDropLoad[i](file,event)){break}}}}};var OnErrorFunction=function(file){return function(event){if(onDragDropLoad){for(i=0;i<onDragDropLoad.length;++i){onDragDropLoad[i](file,event)}}}};var OnAbortFunction=function(file){return function(event){if(onDragDropLoad){for(i=0;i<onDragDropLoad.length;++i){onDragDropLoad[i](file,event)}}}};var files=event.dataTransfer.files;if(this.onDragDrop){for(i=0;i<this.onDragDrop.length;++i){this.onDragDrop[i](files,event)}}for(var fileIndex=0;fileIndex<files.length;++fileIndex){var file=files[fileIndex];var reader=new FileReader;reader.onload=new OnLoadFunction(file);reader.onerror=new OnErrorFunction(file);reader.onabort=new OnAbortFunction(file);var fileExtension=file.name.getExtension();if(fileExtension==="png"||fileExtension==="jpg"||fileExtension==="jpeg"||fileExtension==="bmp"){reader.readAsDataURL(file)}else if(fileExtension==="fbx"||fileExtension==="mp3"||fileExtension==="zip"){reader.readAsArrayBuffer(file)}else{reader.readAsText(file)}}};CCControls.prototype.mouseWheel=function(event){var delta=0;if(!event){event=RootWindow.event}if(event.wheelDelta){if(BrowserType["chrome"]){delta=event.wheelDelta/360}else{delta=event.wheelDelta/120}}else if(event.detail){delta=-event.detail/3}this.mouseUpdate(event);var touchOverTable=this.isOverObject(this.touches[0],this.table);if(touchOverTable){this.wheel.delta=delta;gEngine.updateControls();this.wheel.delta=0;if(event.preventDefault){event.preventDefault()}else{event.returnValue=false}this.mouseUpdate(event);var touch=this.touches[0];this.handleControls(touch,CCControls.touch_released);return false}return true};CCControls.prototype.keyDown=function(event,pressed){var keyCode=event.which;this.keys[keyCode]=true;return this.keyboardInput(event,true)};CCControls.prototype.keyUp=function(event,pressed){var keyCode=event.which;this.keys[keyCode]=false;return this.keyboardInput(event,false)};CCControls.prototype.keyboardInput=function(event,pressed){if(!event){event=RootWindow.event}var keyCode=event.which;var key;if(keyCode===38){key="up"}else if(keyCode===40){key="down"}else if(keyCode===37){key="left"}else if(keyCode===39){key="right"}else if(keyCode===8){key="backspace"}else if(keyCode===27){key="escape"}else if(keyCode===13){key="return"}else if(keyCode===190){key="."}else if(keyCode===188){key=","}else if(keyCode===186){if(event.shiftKey){key=":"}}else if(keyCode===189){key="-"}else if(keyCode===57&&event.shiftKey){key="("}else if(keyCode===48&&event.shiftKey){key=")"}else if(keyCode===49&&event.shiftKey){key="!"}else if(keyCode===222){if(event.shiftKey){key='"'}else{key="'"}}else{key=String.fromCharCode(keyCode);if(!event.shiftKey){key=key.toLowerCase()}}var callbacks=this.onKeyboardCallbacks;var override=false;for(var i=callbacks.length-1;i>=0;--i){override=callbacks[i](event,key,pressed);if(override){break}}if(override||key==="backspace"){if(event&&event.preventDefault){event.preventDefault()}return false}else{if(key==="escape"){if(!pressed){gEngine.handleBackButton()}}}return true};CCControls.prototype.textInput=function(text){var callbacks=this.onKeyboardCallbacks;for(var iText=0;iText<text.length;++iText){var key=text[iText];var event={};for(var i=0;i<callbacks.length;++i){callbacks[i](event,key,true)}}};CCControls.prototype.requestKeyboard=function(callback,popupKeyboard){this.onKeyboardCallbacks.addOnce(callback)};CCControls.prototype.removeKeyboard=function(callback){this.onKeyboardCallbacks.remove(callback)};CCTextureManager.prototype.assignTextureIndex=function(url){url=MultiplayerManager.GetAssetURL(url);var textureHandles=this.textureHandles;var length=textureHandles.length;var textureHandle;var filename=url.getFilename();for(var i=0;i<length;++i){textureHandle=textureHandles[i];if(filename===textureHandle.filename){return i}}var self=this;var OnDowloadFunction=function(textureHandle){return function(){self.downloadedImage(textureHandle)}};var OnErrorFunction=function(textureHandle){return function(){self.downloadError(textureHandle)}};textureHandle=gRenderer.gl.createTexture();textureHandle.filename=filename;textureHandle.src=url;textureHandle.image=new Image;textureHandle.image.crossOrigin="Anonymous";textureHandle.image.textureHandle=textureHandle;textureHandle.downloaded=false;textureHandle.openGL=false;textureHandle.image.onload=new OnDowloadFunction(textureHandle);textureHandle.image.onerror=new OnErrorFunction(textureHandle);textureHandles.push(textureHandle);if(DEBUG_SlowNetwork){var DownloadImageFunction=function(textureHandle,url){return function(){textureHandle.image.src=url}};setTimeout(new DownloadImageFunction(textureHandle,url),2e3)}else{textureHandle.image.src=url}return length};CCTextureManager.prototype.downloadedImage=function(textureHandle){textureHandle.downloaded=true;if(textureHandle.onDownload){gRenderer.pendingRender=true;for(var i=0;i<textureHandle.onDownload.length;++i){textureHandle.onDownload[i](textureHandle)}delete textureHandle.onDownload}};CCTextureManager.prototype.downloadError=function(textureHandle){if(!textureHandle.downloaded){if(!textureHandle.downloadRetries){textureHandle.downloadRetries=0}if(textureHandle.downloadRetries<3){textureHandle.downloadRetries++;textureHandle.image.src="";textureHandle.image.src=textureHandle.src;return}console.log("textureHandle.image.onerror",textureHandle.src);if(textureHandle.onDownload){for(i=0;i<textureHandle.onDownload.length;++i){textureHandle.onDownload[i](null)}delete textureHandle.onDownload}}};CCTextureManager.prototype.setupOpenGLTexture=function(textureHandle){var gl=gRenderer.gl;gl.activeTexture(gl.TEXTURE0);gl.bindTexture(gl.TEXTURE_2D,textureHandle);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,textureHandle.image);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);var width=textureHandle.image.width;if(width===textureHandle.image.height&&width>1&&(width&width-1)===0){gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR_MIPMAP_LINEAR);gl.generateMipmap(gl.TEXTURE_2D)}gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);gl.bindTexture(gl.TEXTURE_2D,null);textureHandle.openGL=true};CCTextureManager.prototype.setTextureIndex=function(index){if(index!==this.currentTextureIndex){var textureHandle=this.textureHandles[index];if(!textureHandle.openGL){if(textureHandle.downloaded){this.setupOpenGLTexture(textureHandle)}else{if(index!==0){this.setTextureIndex(0)}return}}this.currentTextureIndex=index;var gl=gRenderer.gl;gl.bindTexture(gl.TEXTURE_2D,textureHandle)}};CCTextureManager.GetBase64Image=function(img){var canvas=document.createElement("canvas");canvas.width=img.width;canvas.height=img.height;var ctx=canvas.getContext("2d");ctx.drawImage(img,0,0);var dataURL=canvas.toDataURL("image/png");return dataURL.replace(/^data:image\/(png|jpg);base64,/,"")};CCTextureManager.UnlockTextureData=function(textureHandle){var imageData=CCTextureManager.GetBase64Image(textureHandle.image);textureHandle.image=new Image;textureHandle.image.textureHandle=textureHandle;textureHandle.image.onload=function(){var textureHandle=this.textureHandle;if(textureHandle.onDownload){textureHandle.onDownload.callback(textureHandle);textureHandle.onDownload=false}textureHandle.downloaded=true};textureHandle.image.src="data:image/gif;base64,"+imageData};var shaderVS="                                                                                \nattribute vec3 vs_position;                                                                     \nattribute vec2 vs_texCoord;                                                                     \n                                                                                                \nuniform mat4 u_projectionMatrix;                                                                \nuniform mat4 u_viewMatrix;                                                                      \nuniform mat4 u_modelMatrix;                                                                     \nuniform vec4 u_modelColour;                                                                     \n                                                                                                \nvarying vec4 vColor;                                                                            \nvarying vec2 vTextureCoord;                                                                     \n                                                                                                \nvoid main(void)                                                                                 \n{                                                                                               \n    gl_Position = u_projectionMatrix * u_viewMatrix * u_modelMatrix * vec4( vs_position, 1.0 ); \n    vColor = u_modelColour;                                                                     \n    vTextureCoord = vs_texCoord;                                                                \n}";var shaderFS="                                                                            \n#ifdef GL_ES                                                                                \n    precision mediump float;                                                                  \n#endif                                                                                      \nvarying vec4 vColor;                                                                        \nvarying vec2 vTextureCoord;                                                                 \nuniform sampler2D uSampler;                                                                 \nvoid main(void)                                                                             \n{                                                                                           \n    vec4 texColor = texture2D( uSampler, vec2( vTextureCoord.s, vTextureCoord.t ) );        \n    gl_FragColor = texColor * vColor;                                                       \n}                                                                                           \n";function initGL(canvas){var names=["webgl","experimental-webgl","webkit-3d","moz-webgl"];var context=null;for(var i=0;i<names.length;++i){try{context=canvas.getContext(names[i],{antialias:true})}catch(e){}if(context){break}}if(!context){}return context}function getShader(gl,source,shaderType){var shader=gl.createShader(shaderType);gl.shaderSource(shader,source);gl.compileShader(shader);if(!gl.getShaderParameter(shader,gl.COMPILE_STATUS)){alert(gl.getShaderInfoLog(shader));return null}return shader}CCRenderer.prototype.create=function(parent){this.parent=parent;this.canvas=document.createElement("canvas");this.canvas.ondragstart=function(){return false};this.renderFlags=CCRenderer.render_all;this.activeRenderState={};this.pendingRenderState={};if(this.setup()){this.parent.appendChild(this.canvas);this.pendingRender=true;gRenderer=this}return this};CCRenderer.Float32Array=Float32Array;CCRenderer.Uint16Array=Uint16Array;CCRenderer.prototype.setSize=function(width,height,scale){this.width=width;this.height=height;if(scale===undefined){scale=1}if(navigator.platform==="Win32"){scale=2}this.scale=scale;this.canvas.width=this.width*this.scale;this.canvas.height=this.height*this.scale;this.resize()};CCRenderer.prototype.zero=function(){this.canvas.style.width=1;this.canvas.style.height=1};CCRenderer.prototype.resize=function(){this.canvas.style.width=this.width;this.canvas.style.height=this.height;this.pendingRender=true};CCRenderer.prototype.setup=function(){var gl=this.gl=initGL(this.canvas);if(gl){this.initShaders();this.initBuffers();gl.clearColor(0,0,0,0);this.CCSetColour(gColour.white());this.CCSetDepthRead(true);this.CCSetDepthWrite(true);gl.depthFunc(gl.LEQUAL);gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);gl.enable(gl.SCISSOR_TEST);gl.lineWidth(2);this.CCSetCulling(true);this.CCSetBackCulling()}return gl};CCRenderer.prototype.initShaders=function(){var gl=this.gl;var fragmentShader=getShader(gl,shaderFS,gl.FRAGMENT_SHADER);var vertexShader=getShader(gl,shaderVS,gl.VERTEX_SHADER);var shaderProgram=this.shaderProgram=gl.createProgram();gl.attachShader(shaderProgram,vertexShader);gl.attachShader(shaderProgram,fragmentShader);gl.linkProgram(shaderProgram);if(!gl.getProgramParameter(shaderProgram,gl.LINK_STATUS)){alert("Could not initialise shaders")}gl.useProgram(shaderProgram);shaderProgram.ATTRIB_VERTEX=gl.getAttribLocation(shaderProgram,"vs_position");gl.enableVertexAttribArray(shaderProgram.ATTRIB_VERTEX);shaderProgram.ATTRIB_TEXCOORD=gl.getAttribLocation(shaderProgram,"vs_texCoord");gl.enableVertexAttribArray(shaderProgram.ATTRIB_TEXCOORD);shaderProgram.UNIFORM_PROJECTIONMATRIX=gl.getUniformLocation(shaderProgram,"u_projectionMatrix");shaderProgram.UNIFORM_VIEWMATRIX=gl.getUniformLocation(shaderProgram,"u_viewMatrix");shaderProgram.UNIFORM_MODELMATRIX=gl.getUniformLocation(shaderProgram,"u_modelMatrix");shaderProgram.UNIFORM_MODELCOLOUR=gl.getUniformLocation(shaderProgram,"u_modelColour");shaderProgram.samplerUniform=gl.getUniformLocation(shaderProgram,"uSampler")};CCRenderer.prototype.initBuffers=function(){var gl=this.gl;{var squareTextureBuffer=this.squareTextureBuffer=gl.createBuffer();squareTextureBuffer.itemSize=2;{var textureCoords=[1,0,0,0,1,1,0,1];this.defaultTextureCoords=new Float32Array(textureCoords)}this.CCDefaultTexCoords()}{this.vertexIndexBuffer=gl.createBuffer()}{var vertexPositionBuffer=this.vertexPositionBuffer=gl.createBuffer();vertexPositionBuffer.itemSize=3}{this.vertexColorData=new Float32Array(4)}{{var vertices=[.5,.5,0,-.5,.5,0,.5,-.5,0,-.5,-.5,0];this.defaultSquareVertexBuffer=this.CCCreateVertexBuffer(new Float32Array(vertices))}this.CCDefaultSquareVertexPointer()}};CCRenderer.prototype.clear=function(colour){var gl=this.gl;if(colour){gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT)}else{var depthWriteEnabled=this.pendingRenderState.depthWriteEnabled;if(!depthWriteEnabled){this.CCSetDepthWrite(true);this.CCSetRenderStates()}gl.clear(gl.DEPTH_BUFFER_BIT);if(!depthWriteEnabled){this.CCSetDepthWrite(depthWriteEnabled);this.CCSetRenderStates()}}};CCRenderer.prototype.beginRender=function(){if(this.pendingRender){this.pendingRender=false;var gl=this.gl;this.CCSetDepthWrite(true);gl.depthMask(true);this.clear(true);return true}return false};CCRenderer.prototype.CCSetViewMatrix=function(camera){var gl=this.gl;var shaderProgram=this.shaderProgram;gl.uniformMatrix4fv(shaderProgram.UNIFORM_PROJECTIONMATRIX,false,camera.projectionMatrix);gl.uniformMatrix4fv(shaderProgram.UNIFORM_VIEWMATRIX,false,camera.viewMatrix)};CCRenderer.prototype.CCSetRenderStates=function(){var gl=this.gl;var activeRenderState=this.activeRenderState;var pendingRenderState=this.pendingRenderState;if(activeRenderState.blendEnabled!==pendingRenderState.blendEnabled){activeRenderState.blendEnabled=pendingRenderState.blendEnabled;if(activeRenderState.blendEnabled){gl.enable(gl.BLEND)}else{gl.disable(gl.BLEND)}}if(activeRenderState.depthReadEnabled!==pendingRenderState.depthReadEnabled){activeRenderState.depthReadEnabled=pendingRenderState.depthReadEnabled;if(activeRenderState.depthReadEnabled){gl.enable(gl.DEPTH_TEST)}else{gl.disable(gl.DEPTH_TEST)}}if(activeRenderState.depthWriteEnabled!==pendingRenderState.depthWriteEnabled){activeRenderState.depthWriteEnabled=pendingRenderState.depthWriteEnabled;gl.depthMask(activeRenderState.depthWriteEnabled)}if(activeRenderState.cullingEnabled!==pendingRenderState.cullingEnabled){activeRenderState.cullingEnabled=pendingRenderState.cullingEnabled;if(activeRenderState.cullingEnabled){gl.enable(gl.CULL_FACE)}else{gl.disable(gl.CULL_FACE)}}if(activeRenderState.cullingType!==pendingRenderState.cullingType){activeRenderState.cullingType=pendingRenderState.cullingType;if(activeRenderState.cullingType===gl.FRONT){gl.cullFace(gl.FRONT)}else if(activeRenderState.cullingType===gl.BACK){gl.cullFace(gl.BACK)}}var shaderProgram=this.shaderProgram;gl.uniformMatrix4fv(shaderProgram.UNIFORM_MODELMATRIX,false,MODEL_MATRIX)};CCRenderer.prototype.CCSetColour=function(colour){var r=colour.r;var g=colour.g;var b=colour.b;var a=colour.a;var gl=this.gl;var data=this.vertexColorData;if(data[0]!==r||data[1]!==g||data[2]!==b||data[3]!==a){data[0]=r;data[1]=g;data[2]=b;data[3]=a;var shaderProgram=this.shaderProgram;gl.uniform4fv(shaderProgram.UNIFORM_MODELCOLOUR,data)}this.colour=colour};CCRenderer.prototype.CCSetTexCoords=function(textureCoords){this.textureCoords=textureCoords;if(this.vertexTextureBuffer!==this.squareTextureBuffer){this.vertexTextureBuffer=this.squareTextureBuffer}var gl=this.gl;gl.bindBuffer(gl.ARRAY_BUFFER,this.vertexTextureBuffer);gl.bufferData(gl.ARRAY_BUFFER,textureCoords,gl.STATIC_DRAW);gl.vertexAttribPointer(this.shaderProgram.ATTRIB_TEXCOORD,this.vertexTextureBuffer.itemSize,gl.FLOAT,false,0,0)};CCRenderer.prototype.CCDefaultTexCoords=function(){if(this.textureCoords!==this.defaultTextureCoords){this.CCSetTexCoords(this.defaultTextureCoords)}else{this.CCBindVertexTextureBuffer(this.squareTextureBuffer)}};CCRenderer.prototype.CCCreateVertexBuffer=function(vertices,itemSize){var gl=this.gl;var vertexBuffer=gl.createBuffer();if(vertexBuffer){vertexBuffer.itemSize=itemSize?itemSize:3;if(vertices){this.CCUpdateVertexBuffer(vertexBuffer,vertices)}}return vertexBuffer};CCRenderer.prototype.CCCreateVertexIndexBuffer=function(indices){var gl=this.gl;var vertexBuffer=gl.createBuffer();vertexBuffer.numItems=indices.length;gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,vertexBuffer);gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,indices,gl.STATIC_DRAW);return vertexBuffer};CCRenderer.prototype.CCUpdateVertexBuffer=function(vertexBuffer,vertices){var gl=this.gl;gl.bindBuffer(gl.ARRAY_BUFFER,vertexBuffer);gl.bufferData(gl.ARRAY_BUFFER,vertices,gl.STATIC_DRAW)};CCRenderer.prototype.CCDeleteVertexBuffer=function(vertexBuffer){};CCRenderer.prototype.CCBindVertexTextureBuffer=function(vertexTextureBuffer){if(this.vertexTextureBuffer!==vertexTextureBuffer){this.vertexIndexBuffer=-1;this.vertexTextureBuffer=vertexTextureBuffer;var gl=this.gl;gl.bindBuffer(gl.ARRAY_BUFFER,vertexTextureBuffer);gl.vertexAttribPointer(this.shaderProgram.ATTRIB_TEXCOORD,vertexTextureBuffer.itemSize,gl.FLOAT,false,0,0)}};CCRenderer.prototype.CCBindVertexPositionBuffer=function(vertexPositionBuffer){if(this.vertexPositionBuffer!==vertexPositionBuffer){this.vertexIndexBuffer=-1;this.vertexPositionBuffer=vertexPositionBuffer;var gl=this.gl;gl.bindBuffer(gl.ARRAY_BUFFER,vertexPositionBuffer);gl.vertexAttribPointer(this.shaderProgram.ATTRIB_VERTEX,vertexPositionBuffer.itemSize,gl.FLOAT,false,0,0)}};CCRenderer.prototype.CCBindVertexIndexBuffer=function(vertexIndexBuffer){if(this.vertexIndexBuffer!==vertexIndexBuffer){this.vertexIndexBuffer=vertexIndexBuffer;var gl=this.gl;gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,vertexIndexBuffer)}};CCRenderer.prototype.GLDrawArrays=function(mode,first,count){var gl=this.gl;if(mode==="TRIANGLE_STRIP"){gl.drawArrays(gl.TRIANGLE_STRIP,first,count)}else if(mode==="TRIANGLES"){gl.drawArrays(gl.TRIANGLES,first,count)}else if(mode==="LINES"){gl.drawArrays(gl.LINES,first,count)}else{CC.ASSERT(false)}};CCRenderer.prototype.GLDrawElements=function(mode,count,offsetInBytes){var gl=this.gl;if(mode==="LINE_STRIP"){gl.drawElements(gl.LINE_STRIP,count,gl.UNSIGNED_SHORT,offsetInBytes)}else if(mode==="TRIANGLE_STRIP"){gl.drawElements(gl.TRIANGLE_STRIP,count,gl.UNSIGNED_SHORT,offsetInBytes)}else if(mode==="TRIANGLES"){gl.drawElements(gl.TRIANGLES,count,gl.UNSIGNED_SHORT,offsetInBytes)}else{CC.ASSERT(false)}};CCRenderer.prototype.GLVertexPointer=function(vertices){var gl=this.gl;gl.bindBuffer(gl.ARRAY_BUFFER,this.vertexPositionBuffer);if(this.vertices!==vertices){this.vertices=vertices;gl.bufferData(gl.ARRAY_BUFFER,vertices,gl.STATIC_DRAW)}gl.vertexAttribPointer(this.shaderProgram.ATTRIB_VERTEX,this.vertexPositionBuffer.itemSize,gl.FLOAT,false,0,0)};CCRenderer.prototype.CCRenderSquare=function(start,end){if(!this.renderSquareVertices){this.renderSquareVertices=new Float32Array(3*4)}var vertices=[start[0],end[1],end[2],end[0],end[1],end[2],start[0],start[1],start[2],end[0],start[1],start[2]];var renderSquareVertices=this.renderSquareVertices;var length=renderSquareVertices.length;for(var i=0;i<length;++i){renderSquareVertices[i]=vertices[i]}this.GLVertexPointer(renderSquareVertices);var gl=this.gl;gl.drawArrays(gl.TRIANGLE_STRIP,0,4)};CCRenderer.prototype.CCSetBlend=function(toggle){if(this.pendingRenderState.blendEnabled!==toggle){this.pendingRenderState.blendEnabled=toggle}};CCRenderer.prototype.CCSetDepthRead=function(toggle){if(this.pendingRenderState.depthReadEnabled!==toggle){this.pendingRenderState.depthReadEnabled=toggle}};CCRenderer.prototype.CCSetDepthWrite=function(toggle){if(this.pendingRenderState.depthWriteEnabled!==toggle){this.pendingRenderState.depthWriteEnabled=toggle}};CCRenderer.prototype.CCSetCulling=function(toggle){if(this.pendingRenderState.cullingEnabled!==toggle){this.pendingRenderState.cullingEnabled=toggle}};CCRenderer.prototype.CCSetFrontCulling=function(){if(this.pendingRenderState.cullingType!==this.gl.FRONT){this.pendingRenderState.cullingType=this.gl.FRONT}};CCRenderer.prototype.CCSetBackCulling=function(){if(this.pendingRenderState.cullingType!==this.gl.BACK){this.pendingRenderState.cullingType=this.gl.BACK}};CCRenderer.prototype.GLViewport=function(x,y,width,height){var gl=this.gl;x*=this.scale;y*=this.scale;width*=this.scale;height*=this.scale;if(this.viewportX!==x||this.viewportY!==y||this.viewportWidth!==width||this.viewportHeight!==height){this.viewportX=x;this.viewportY=y;this.viewportWidth=width;this.viewportHeight=height;gl.viewport(x,y,width,height)}};CCRenderer.prototype.GLScissor=function(x,y,width,height){var gl=this.gl;x*=this.scale;y*=this.scale;width*=this.scale;height*=this.scale;if(this.scissorX!==x||this.scissorY!==y||this.scissorWidth!==width||this.scissorHeight!==height){this.scissorX=x;this.scissorY=y;this.scissorWidth=width;this.scissorHeight=height;gl.scissor(x,y,width,height)}};var MAX_PUSHES=15;var CURRENT_PUSH=0;var MODEL_MATRIX_STACK=new Array(MAX_PUSHES);for(var i=0;i<MODEL_MATRIX_STACK.length;++i){MODEL_MATRIX_STACK[i]=mat4.create()}var MODEL_MATRIX=MODEL_MATRIX_STACK[0];CCRenderer.GLPushMatrix=function(){CURRENT_PUSH++;CC.ASSERT(CURRENT_PUSH<MAX_PUSHES);mat4.copy(MODEL_MATRIX_STACK[CURRENT_PUSH],MODEL_MATRIX);MODEL_MATRIX=MODEL_MATRIX_STACK[CURRENT_PUSH]};CCRenderer.GLPopMatrix=function(){CURRENT_PUSH--;CC.ASSERT(CURRENT_PUSH>=0);MODEL_MATRIX=MODEL_MATRIX_STACK[CURRENT_PUSH]};CCRenderer.GLLoadIdentity=function(){mat4.identity(MODEL_MATRIX)};CCRenderer.GLMultMatrix=function(inMatrix){mat4.multiply(MODEL_MATRIX,MODEL_MATRIX,inMatrix)};CCRenderer.GLTranslate=function(vector){mat4.translate(MODEL_MATRIX,MODEL_MATRIX,vector)};CCRenderer.GLScale=function(vector){mat4.scale(MODEL_MATRIX,MODEL_MATRIX,vector)};CCRenderer.GLRotate=function(angle,vector){CC.MatrixRotateDegrees(MODEL_MATRIX,angle,vector[0],vector[1],vector[2])};CCRenderer.ModelMatrixMultiply=function(object){CCRenderer.GLMultMatrix(object.modelMatrix)};CCRenderer.ModelMatrixIdentity=function(object){mat4.identity(object.modelMatrix)};CCRenderer.ModelMatrixTranslate=function(object,vector){var modelMatrix=object.modelMatrix;mat4.translate(modelMatrix,modelMatrix,vector)};CCRenderer.ModelMatrixScale=function(object,vector){var modelMatrix=object.modelMatrix;mat4.scale(modelMatrix,modelMatrix,vector)};CCRenderer.ModelMatrixRotate=function(object,angle,axis){var modelMatrix=object.modelMatrix;mat4.rotate(modelMatrix,modelMatrix,angle*CC_PI/180,axis)};function CCEngine(){this.nextUpdateCallbacks=[];this.scenes=[];this.cameras=[];this.timeReal=0;this.lifetime=0;this.lastUpdate=0;this.fpsTimer=0;this.fpsTicks=0;this.collisionManager=new CCCollisionManager(1e4);CCCameraBase.SetVisibleSortFunction(CCEngine.ZCompare);this.setup()}window.gEngine=null;CCEngine.BackButtonStack=[];CCEngine.DeviceType="Web";CCEngine.Orientation={current:0,target:0};CCEngine.IsMobile=function(){if(window.DEBUG_IsLocalClient){return true}return CCEngine.DeviceType==="iOS"||CCEngine.DeviceType==="Android"||CCEngine.DeviceType==="WindowsPhone"||window.tizen};CCEngine.IsPortrait=function(){return CCEngine.Orientation.target===0||CCEngine.Orientation.target===180};CCEngine.SetOrientation=function(current,target){CCEngine.Orientation.current=current;CCEngine.Orientation.target=target};CCEngine.ProjectOrientation=function(x,y,result){var temp;if(CCEngine.Orientation.target===270){temp=x;x=y;y=temp;x=1-x}else if(CCEngine.Orientation.target===90){temp=x;x=y;y=temp;y=1-y}else if(CCEngine.Orientation.target===180){x=1-x}else{}result(x,y)};CCEngine.ZCompare=function(a,b){var objectA=a;var objectB=b;var drawOrderA=objectA.drawOrder;var drawOrderB=objectB.drawOrder;if(drawOrderA===200||drawOrderB===200){if(drawOrderA===200&&drawOrderB===200){var cameraPosition=CCCameraBase.currentCamera.currentRotatedPosition;var positionA=objectA.position;var positionB=objectB.position;var distanceA=vec3.distance(positionA,cameraPosition,true);var distanceB=vec3.distance(positionB,cameraPosition,true);return distanceB-distanceA}return drawOrderA-drawOrderB}return drawOrderA-drawOrderB};CCEngine.prototype.updateTime=function(){var currentTime=Date.now();var delta=(currentTime-this.lastUpdate)*.001;this.timeReal=delta;delta=delta>.05?.05:delta;this.lastUpdate=currentTime;return delta};CCEngine.RunNextUpdate=function(callback){if(gEngine){if(callback){gEngine.nextUpdateCallbacks.push(callback)}}};CCEngine.prototype.update=function(delta){if(this.nextUpdateCallbacks.length>0){var callback=this.nextUpdateCallbacks.safePop();callback()}if(this.collisionManager.pruneOctreeTimer>0){this.collisionManager.pruneOctreeTimer-=delta;if(this.collisionManager.pruneOctreeTimer<=0){CCOctree.PruneTree(this.collisionManager.octree)}}this.lifetime+=delta;var i,scene;var scenes=this.scenes;var scenesLength=scenes.length;for(i=0;i<scenesLength;++i){scene=scenes[i];if(scene.shouldDelete()){this.removeScene(scene);i--;scenesLength=scenes.length;gRenderer.pendingRender=true}}this.controls.update(delta);for(i=0;i<scenesLength;++i){scenes[i].update(delta)}};CCEngine.prototype.updateControls=function(){var controls=this.controls;var cameras=this.cameras;var camerasLength=cameras.length;var scenes=this.scenes;var scenesLength=scenes.length;for(var cameraIndex=camerasLength-1;cameraIndex>=0;--cameraIndex){var camera=cameras[cameraIndex];if(!camera.enabled){continue}var scene;if(camera.scene){scene=camera.scene;if(scene.updateControls(controls)){return true}}else{for(var i=scenesLength-1;i>=0;--i){scene=scenes[i];if(scene.camera===camera){if(scene.updateControls(controls)){return true}}}}}return false};CCEngine.prototype.newSceneCamera=function(scene,index,CameraType,alwaysOnTop){if(!CameraType){CameraType=CCCameraAppUI}var camera=scene.camera=new CameraType;camera.scene=scene;var cameras=this.cameras;if(index===undefined||index===null){index=cameras.length}if(index>cameras.length){index=cameras.length}if(alwaysOnTop){camera.alwaysOnTop=true}else{for(var i=index-1;i>0;--i){if(cameras[i].alwaysOnTop){index=i}}}cameras.insert(camera,index);if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeSyncCommands+="CCEngine.newSceneCamera;"+scene.sceneID+";"+camera.cameraID+"\n"}return camera};CCEngine.prototype.removeCamera=function(camera){var cameras=this.cameras;if(cameras.remove(camera)){return true}return false};CCEngine.prototype.findCameraIndex=function(camera){return this.cameras.find(camera)};CCEngine.NewScene=function(scene){if(CCEngine.NativeSyncCommands!==undefined){CCEngine.NativeSyncCommands+="CCEngine.NewScene;"+scene.sceneID+"\n"}};CCEngine.prototype.addScene=function(scene){this.scenes.push(scene);scene.setup()};CCEngine.prototype.removeScene=function(scene){var scenes=this.scenes;if(scenes.remove(scene)){if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCEngine.removeScene;"+scene.sceneID+"\n"}scene.destruct();return true}alert("CCEngine.prototype.removeScene failed");return false};CCEngine.EnableBackButton=function(scene){if(CCEngine.BackButtonStack.addOnce(scene)){if(CCEngine.BackButtonStack.length===1){if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCEngine.EnableBackButton;true\n"}}}};CCEngine.DisableBackButton=function(scene){if(CCEngine.BackButtonStack.remove(scene)){if(CCEngine.BackButtonStack.length===0){if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCEngine.EnableBackButton;false\n"}}}};CCEngine.prototype.handleBackButton=function(){if(CCAPIFacebook.IsLoggingIn()){CCAPIFacebook.FinishLogin();return true}else if(CCAPITwitter.IsLoggingIn()){CCAPITwitter.FinishLogin();return true}else if(CCAPIGoogle.IsLoggingIn()){CCAPIGoogle.FinishLogin();return true}else{var scenes=this.scenes;for(var i=scenes.length-1;i>=0;--i){var scene=scenes[i];if(scene.handleBackButton){if(scene.handleBackButton()){return true}}}}if(CCEngine.BackButtonStack.find(gEngine)!==-1){CCEngine.DisableBackButton(gEngine);if(!this.sceneMultiLauncher){if(SceneMultiUILauncher.Instance){this.sceneMultiLauncher=SceneMultiUILauncher.Instance
}else{this.sceneMultiLauncher=new SceneMultiUILauncher}this.sceneMultiLauncher.show();var self=this;this.sceneMultiLauncher.launch(true,function(){delete self.sceneMultiLauncher});return true}}return false};CCEngine.Pause=function(){CCEngine.paused=true;if(window.gEngine){var scenes=gEngine.scenes;for(var i=scenes.length-1;i>=0;--i){var scene=scenes[i];if(scene.onPause){if(scene.onPause()){return true}}}}if(CCEngine.DeviceType!=="Web"){MultiplayerManager.Disconnect()}CCAudioManager.Pause();gEngine.controls.onPause()};CCEngine.Resume=function(){CCEngine.paused=false;MultiplayerManager.Connect();CCAudioManager.Resume();if(gRenderer){gRenderer.pendingRender=true}};CCEngine.LoadAppInfo=function(appInfo){if(appInfo){window.LAUNCH_APP_ID=appInfo.id;if(appInfo.PURCHASE_ID){window.DEFAULT_PURCHASE_ID=appInfo.PURCHASE_ID}DBApps.AddAppInfo(appInfo);if(appInfo.dbInfos){DBAssets.LoadDBInfos(appInfo.dbInfos)}}};window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(callback,element){window.setTimeout(callback,1e3/60)}}();CCEngine.Update=function(){if(CCEngine.paused){var currentTime=Date.now();var delta=(currentTime-gEngine.lastUpdate)*.001;if(delta>.05){gEngine.updateWeb();gEngine.render()}}else{gEngine.updateWeb();gEngine.render()}requestAnimFrame(CCEngine.Update)};CCEngine.prototype.setup=function(){gEngine=this;gURLManager=(new CCURLManager).create();CC.SetGradient(document.body.style,"#000000","#000000");this.table=new TableComponent(document.body,false);this.table.table.width=1;this.table.td.height=1;this.controls=(new CCControls).create(this.table);window.onresize=function(){gEngine.queueResize()};if(!BrowserType["mobile"]){window.onscroll=function(){gEngine.scroll()}}else{document.addEventListener("orientationchange",function(){gEngine.queueResize()},true);document.addEventListener("scroll",function(){gEngine.scroll()},true)}if(this.setupRenderer()){this.resize(function(){gEngine.start();setTimeout(CCEngine.Update,10)})}else{window.location=SERVER_ROOT+"nowebgl/"}window.onblur=function(e){if(window.CCEngine){CCEngine.Pause()}};window.onfocus=function(e){if(window.CCEngine){CCEngine.Resume()}};if(window.document.hasFocus){if(!window.document.hasFocus()){if(window.CCEngine){CCEngine.Pause()}}}if(window.tizen){document.addEventListener("tizenhwkey",function(e){if(e.keyName=="back"){if(gEngine.handleBackButton()){}else{tizen.application.getCurrentApplication().exit()}}else if(e.KeyName==="menu"){}})}};CCEngine.prototype.setupRenderer=function(){this.fullScreen=true;(new CCRenderer).create(this.table.td);if(gRenderer){this.textureManager=new CCTextureManager;return true}return false};CCEngine.prototype.updateWeb=function(){var delta=this.updateTime();if(CC.LocalStorageCacheDirty){CC.SerializeLocalStorageCache()}if(this.resizeTimer>0){this.resizeTimer-=delta;if(this.resizeTimer<=0){this.resize()}}else{this.update(delta)}if(window.DEBUG_IsLocalClient){if(!this.timerFPS){this.timerFPS=0}this.timerFPS+=delta;if(this.timerFPS>5){this.timerFPS-=5;console.log("FPS",1/delta)}}};CCEngine.prototype.render=function(){var renderer=gRenderer;if(renderer.beginRender()){var render_background=CCRenderer.render_background;var render_finished=CCRenderer.render_finished;var i,scene;var scenes=this.scenes;var scenesLength=scenes.length;var collideables=gEngine.collisionManager.collideables;var collideablesLength=collideables.length;for(i=0;i<collideablesLength;++i){var collideable=collideables[i];collideable.visible=false}var cameras=this.cameras;var camerasLength=cameras.length;for(var cameraIndex=0;cameraIndex<camerasLength;++cameraIndex){var camera=cameras[cameraIndex];if(!camera.enabled){continue}camera.setViewport();camera.update();for(var pass=render_background;pass<render_finished;++pass){renderer.CCSetBlend(false);renderer.CCSetDepthWrite(true);renderer.CCSetDepthRead(true);if(camera.scene){camera.scene.render(camera,pass,false)}else{for(i=0;i<scenesLength;++i){scene=scenes[i];scene.render(camera,pass,false)}}CC.RenderVisibleObjects(camera,pass,false);renderer.CCSetBlend(true);renderer.CCSetDepthWrite(false);renderer.CCSetDepthRead(false);if(camera.scene){camera.scene.render(camera,pass,true)}else{for(i=0;i<scenesLength;++i){scene=scenes[i];scene.render(camera,pass,true)}}CC.RenderVisibleObjects(camera,pass,true);if(camera.scene){if(camera.scene.postRender){camera.scene.postRender(camera,pass,true)}}else{for(i=0;i<scenesLength;++i){scene=scenes[i];if(scene.postRender){scene.postRender(camera,pass,true)}}}}}}};CCEngine.prototype.queueResize=function(){this.zero();this.resizeTimer=.25};CCEngine.prototype.zero=function(){this.table.table.width=1;this.table.td.height=1;this.table.style.border="";if(gRenderer){gRenderer.zero()}};CCEngine.prototype.resize=function(callback){if(BrowserType["iphone"]){window.scrollTo(0,0)}this.zero();var self=this;CCTools.GetScreenSize(function(screenWidth,screenHeight){var aspect=720/480;var tableWidth=screenWidth;var tableHeight=screenHeight;if(self.fullScreen){if(gRenderer){gRenderer.setSize(screenWidth,screenHeight)}}else{tableHeight=screenWidth/aspect;if(tableHeight>screenHeight){var difference=screenHeight/tableHeight;tableWidth=screenWidth*difference;tableHeight=screenHeight}if(gRenderer){gRenderer.setSize(tableWidth,tableHeight)}}tableWidth=parseInt(tableWidth,10);tableHeight=parseInt(tableHeight,10);self.table.table.width=tableWidth+"px";self.table.td.height=tableHeight+"px";self.table.dimensions.refresh();var x=Math.floor((tableWidth-self.table.dimensions.totalWidth)*.5);var y=Math.floor((tableHeight-self.table.dimensions.totalHeight)*.5);self.table.dimensions.setPosition(x,y);{var scenes=self.scenes;var length=scenes.length;for(var i=0;i<length;++i){var scene=scenes[i];scene.resize();scene.resized()}}if(callback){callback()}})};CCEngine.prototype.scroll=function(){if(gRenderer){gRenderer.resize()}};CCEngine.WebViews=[];CCEngine.WebViewOpen=function(url,onOpenCallback,onUpdateCallback,params){if(window.tizen){if(!onOpenCallback&&!onUpdateCallback){var appControl=new tizen.ApplicationControl("http://tizen.org/appcontrol/operation/view",url);tizen.application.launchAppControl(appControl,null,function(){},function(e){});return}}var title="PLAYIR";var specs="";if(params){if(params.title){title=params.title}if(params.width){var width=parseInt(params.width,10);specs+="width="+width+",";var screenWidth=CCTools.GetScreenWidth();var left=(screenWidth-width)/2;specs+="left="+left+","}if(params.height){var height=parseInt(params.height,10);specs+="height="+height+",";var screenHeight=CCTools.GetScreenHeight();var top=(screenHeight-height)/2;specs+="top="+top+","}}var webViewController=CCEngine.GetWebView(title);if(!webViewController){webViewController={};webViewController.title=title;CCEngine.WebViews.add(webViewController)}webViewController.onUpdateCallback=onUpdateCallback;webViewController.webView=window.open(url,title,specs);var webView=webViewController.webView;CCEngine.WebViewLastOpened=webViewController;var webViewOpenedTimer=0;var webViewOpenedTimeout=100;var WaitForWebViewToOpen=function(){webViewOpenedTimer+=webViewOpenedTimeout;setTimeout(function(){if(!webView||webView.innerHeight===0){if(webViewOpenedTimer<5e3){WaitForWebViewToOpen()}else{alert("A popup window is required to continue.\nPlease enable popups and try again.");if(onOpenCallback){onOpenCallback(webViewController,false)}CCEngine.WebViewClose(webViewController)}}else{webView.focus();if(onUpdateCallback){setTimeout(function(){CCEngine.WebViewProcessURL(webViewController)},33)}if(onOpenCallback){onOpenCallback(webViewController,true)}}},webViewOpenedTimeout)};if(onOpenCallback||onUpdateCallback){WaitForWebViewToOpen()}return webViewController};CCEngine.WebViewProcessURL=function(webViewController){var webView=webViewController.webView;if(webView){if(webView.closed||!webViewController.onUpdateCallback){if(webViewController.onUpdateCallback){webViewController.onUpdateCallback(webViewController,false,false)}CCEngine.WebViewClose(webViewController)}else{var url=false;try{url=webView.location.href}catch(e){url=false}if(url){if(url!==webViewController.url){webViewController.url=url;webViewController.onUpdateCallback(webViewController,url,true)}}setTimeout(function(){CCEngine.WebViewProcessURL(webViewController)},33)}}};CCEngine.WebViewClose=function(webViewController){if(!webViewController){webViewController=CCEngine.WebViewLastOpened}CCEngine.WebViews.remove(webViewController);if(webViewController){var webView=webViewController.webView;if(webView&&!webView.closed){webView.close()}if(webViewController===CCEngine.WebViewLastOpened){delete CCEngine.WebViewLastOpened}}};CCEngine.IsWebViewOpen=function(webViewController){if(CCEngine.WebViews.find(webViewController)!==-1){var webView=webViewController.webView;return!webView.closed}return false};CCEngine.GetWebView=function(title){var WebViews=CCEngine.WebViews;for(var i=0;i<WebViews.length;++i){var webViewItr=WebViews[i];if(webViewItr.title===title){return webViewItr}}return null};CC.LocalStorageCache=null;CC.LocalStorageCacheDirty=false;CC.LoadLocalStorageCache=function(key){if(window.localStorage){if(!CC.LocalStorageCache){var cacheString=window.localStorage.getItem("cache");if(cacheString){CC.LocalStorageCache=JSON.parse(cacheString)}if(!CC.LocalStorageCache){CC.LocalStorageCache={}}}var cache=CC.LocalStorageCache;if(cache){var item=cache[key];if(item){item.time=Date.now();CC.LocalStorageCacheDirty=true;return item.data}}}return undefined};CC.SaveLocalStorageCache=function(key,data){if(window.localStorage){CC.ASSERT(key);if(!CC.LocalStorageCache){var cacheString=window.localStorage.getItem("cache");if(cacheString){CC.LocalStorageCache=JSON.parse(cacheString)}if(!CC.LocalStorageCache){CC.LocalStorageCache={}}}var cache=CC.LocalStorageCache;var item={};item.time=Date.now();item.data=data;cache[key]=item;CC.LocalStorageCacheDirty=true}};CC.DeleteLocalStorageCache=function(key,data){if(window.localStorage){CC.ASSERT(key);if(!CC.LocalStorageCache){var cacheString=window.localStorage.getItem("cache");if(cacheString){CC.LocalStorageCache=JSON.parse(cacheString)}if(!CC.LocalStorageCache){CC.LocalStorageCache={}}}var cache=CC.LocalStorageCache;if(cache[key]){delete cache[key];CC.LocalStorageCacheDirty=true}}};CC.SerializeLocalStorageCache=function(){CC.LocalStorageCacheDirty=false;var saveString;try{saveString=JSON.stringify(CC.LocalStorageCache)}catch(error){CC.ASSERT(false,error);window.localStorage.removeItem("cache");CC.LocalStorageCache=null}if(saveString){try{window.localStorage.setItem("cache",saveString)}catch(error){if(CC.TrimLocalStorageCache()){CC.SerializeLocalStorageCache()}else{window.localStorage.removeItem("cache");CC.LocalStorageCache=null}}}};CC.TrimLocalStorageCache=function(){var cache=CC.LocalStorageCache;var oldestKey=null;var oldestTime=Date.now();for(var key in cache){var item=cache[key];if(item.time<oldestTime){oldestKey=key;oldestTime=item.time}}if(oldestKey){delete cache[oldestKey];return true}return false};