function CharacterControllerPlayer(pathFinderNetwork){this.construct(pathFinderNetwork)}CharacterControllerPlayer.state_shooting=0;CharacterControllerPlayer.state_stopping=1;CharacterControllerPlayer.state_stopped=2;CharacterControllerPlayer.prototype.construct=function(pathFinderNetwork){this.updating=true;if(!pathFinderNetwork){pathFinderNetwork=gEngine.collisionManager.pathFinderNetwork}this.pathFinderNetwork=pathFinderNetwork;this.player=null;this.setHealth(100,true);this.damageResistance=0;this.moving=false;this.locationTarget=vec3.create();this.distanceToLocationTarget=CC_MAXFLOAT;this.movementMagnitude=1;this.stopOnCollisions=false;this.receivedLastCollisionTime=0;this.shootingState=CharacterControllerPlayer.state_stopped;this.shootingLocation=vec3.create();this.shootingTarget=null;this.shootingAimHelper=true;this.resetPathNodes();this.enabled=true};CharacterControllerPlayer.prototype.destruct=function(){if(this.shootingState!==CharacterControllerPlayer.state_stopped){this.stopShooting()}};CharacterControllerPlayer.prototype.resetPathNodes=function(){this.anchorNode=null;this.path=null;this.pathAnchorNode=null;this.currentPath=-1;if(this.moving){this.goToScan(this.locationTarget,true)}};CharacterControllerPlayer.prototype.update=function(delta){this.movePlayer(delta);if(this.shootingState!==CharacterControllerPlayer.state_stopped){if(this.shootingState===CharacterControllerPlayer.state_shooting){if(this.shootingTarget){if(!this.shootingTarget.isActive()){this.shootingTarget=null}else{vec3.copy(this.shootingLocation,this.shootingTarget.position)}}var shoot=true;if(this.shootingAimHelper){shoot=false;this.player.aimWeapon(this.shootingLocation);var angleToTarget=this.player.getWeaponAimAngleToTarget(this.shootingLocation);if(angleToTarget<10){shoot=true}}if(shoot){if(!this.player.shootWeapon(delta)){this.shootingState=CharacterControllerPlayer.state_stopping;this.shootingTarget=null}}}else{this.stopShooting()}}return true};CharacterControllerPlayer.prototype.isPerformingAction=function(){return this.shootingState!==CharacterControllerPlayer.state_stopped};CharacterControllerPlayer.prototype.enable=function(toggle){this.enabled=toggle};CharacterControllerPlayer.prototype.setPlayer=function(inPlayer){this.player=inPlayer};CharacterControllerPlayer.prototype.isAI=function(){return false};CharacterControllerPlayer.prototype.getHealth=function(){return this.health};CharacterControllerPlayer.prototype.getHealthRatio=function(){return this.health/this.maxHealth};CharacterControllerPlayer.prototype.setHealth=function(inHealth,initialize){this.health=inHealth;if(initialize){this.maxHealth=inHealth}};CharacterControllerPlayer.prototype.resetHealth=function(){this.health=this.maxHealth};CharacterControllerPlayer.prototype.setMovementMagnitude=function(magnitude){this.movementMagnitude=magnitude};CharacterControllerPlayer.prototype.goToScan=function(target,force){if(force||!vec3.equals(this.locationTarget,target)){var hitObject=CC.MovementCollisionCheck(this.player,this.player.position,target,CC.collision_static);if(hitObject){this.goToUsingPath(target)}else{this.path=null;this.goTo(target)}}return this.locationTarget};CharacterControllerPlayer.prototype.goToUsingPath=function(target){var player=this.player;var targetNode=this.pathFinderNetwork.findClosestNodeToPathTarget(player,target,false);if(!targetNode){this.path=null;this.goTo(target);return}this.anchorNode=null;this.validateAnchorNode();this.pathAnchorNode=this.anchorNode;if(this.pathAnchorNode){var path=this.path=this.pathFinderNetwork.findPath(this.player,this.pathAnchorNode,targetNode);var hitObject;if(path.directions.length===0){this.path=null}else{if(path.endDirection===0){hitObject=CC.MovementCollisionCheck(player,player.position,target,CC.collision_static);if(!hitObject){this.path=null}}else{var pathAnchorNode=this.pathAnchorNode;var pathDirection=path.directions[0];if(pathAnchorNode&&pathDirection<pathAnchorNode.connections.length){var usingConnection=pathAnchorNode.connections[pathDirection];var pathTarget=usingConnection.node.point;hitObject=CC.MovementCollisionCheck(player,player.position,pathTarget,CC.collision_static);if(hitObject){this.currentPath=-1}else{this.currentPath=0}}else{this.currentPath=0}}}}else{this.path=null}this.goTo(target)};CharacterControllerPlayer.prototype.goTo=function(target){var player=this.player;this.distanceToLocationTarget=CC_MAXFLOAT;this.setLocationTarget(target);this.player.movementDirection[2]=this.movementMagnitude;this.moveAction()};CharacterControllerPlayer.prototype.setLocationTarget=function(target){var locationTarget=this.locationTarget;vec3.copy(locationTarget,target);locationTarget[1]+=this.player.collisionBounds[1];if(locationTarget[1]!==this.player.collisionBounds[1]){locationTarget[1]=this.player.collisionBounds[1]}};CharacterControllerPlayer.prototype.validateAnchorNode=function(){if(!this.anchorNode){this.anchorNode=this.pathFinderNetwork.findClosestNodeToPathTarget(this.player,this.player.position,true)}};CharacterControllerPlayer.prototype.shootAt=function(enemy){if(enemy){this.shoot(enemy.position,enemy)}};CharacterControllerPlayer.prototype.shoot=function(target,enemy,actionID){if(this.shootingState!==CharacterControllerPlayer.state_shooting){this.shootingState=CharacterControllerPlayer.state_shooting}if(target){vec3.copy(this.shootingLocation,target);this.shootingLocation[1]+=this.player.collisionBounds[1]}if(enemy){this.shootingTarget=enemy}this.player.readyWeapon(actionID)};CharacterControllerPlayer.prototype.scanForEnemy=function(target){var hScanArea=this.player.collisionSize.width*2;var min=vec3.clone(target);min[0]-=hScanArea;min[2]-=hScanArea;var max=vec3.clone(target);max[0]+=hScanArea;max[2]+=hScanArea;return CC.CollideableScan(min,max,this.player,CC.collision_character)};CharacterControllerPlayer.prototype.stopShooting=function(){this.shootingState=CharacterControllerPlayer.state_stopped;this.player.unReadyWeapon();if(this.player.setActionID){this.player.setCurrentActionPriority(0);if(this.moving){this.player.setMovementAnimation()}else{this.player.setIdleAnimation()}}};CharacterControllerPlayer.prototype.recieveCollisionFrom=function(collisionSource){if(this.moving){if(this.stopOnCollisions){this.player.movementDirection[2]=0;this.stopAction()}else if(!this.collidedWhileMoving){this.collidedWhileMoving=true;this.collidedWhileMovingTime=gEngine.lifetime;if(!this.collidedWhileMovingPosition){this.collidedWhileMovingPosition=vec3.clone(this.player.position)}else{vec3.copy(this.collidedWhileMovingPosition,this.player.position)}}}};CharacterControllerPlayer.prototype.reportAttack=function(attackedBy,attackType,force,damage,x,y,z){};CharacterControllerPlayer.prototype.movePlayer=function(delta){if(this.moving){var player=this.player;var path=this.path;var pathAnchorNode=this.pathAnchorNode;var distance,target,hitObject;if(this.collidedWhileMoving){var difference=gEngine.lifetime-this.collidedWhileMovingTime;if(difference>.25){var movementLength=vec3.distance(this.collidedWhileMovingPosition,this.player.position);if(movementLength>.5){this.collidedWhileMoving=false}else{this.player.movementDirection[2]=0;this.stopAction()}}}if(path){if(!pathAnchorNode){this.path=null}else if(this.currentPath===-1){target=pathAnchorNode.point;player.turnPlayer(target,delta);distance=CC.Vector3Distance2D(player.position,target,true);if(distance<1*1){this.currentPath=0}}else{var validPath=false;if(this.currentPath<path.endDirection){var pathDirection=path.directions[this.currentPath];if(pathDirection<pathAnchorNode.connections.length){var usingConnection=pathAnchorNode.connections[pathDirection];target=usingConnection.node.point;if(target){validPath=true;player.turnPlayer(target,delta);distance=CC.Vector3Distance2D(player.position,target,true);if(distance<100*100){var goToNext=distance<.1+player.collisionBounds[1];if(!goToNext){var testTarget=this.locationTarget;{hitObject=CC.MovementCollisionCheck(player,player.position,testTarget,CC.collision_static);goToNext=!hitObject}if(this.currentPath+1<path.endDirection){if(goToNext){goToNext=false;this.path=null}else{var nextConnection=usingConnection.node.connections[path.directions[this.currentPath+1]];testTarget=nextConnection.node.point;if(!testTarget){testTarget=locationTarget}hitObject=CC.MovementCollisionCheck(player,player.position,testTarget,CC.collision_static);goToNext=!hitObject}}}if(goToNext){this.pathAnchorNode=usingConnection.node;this.anchorNode=pathAnchorNode;this.currentPath++;if(this.currentPath>=path.endDirection){this.path=null}}}}}}if(!validPath){this.goTo(this.locationTarget)}}}else{distance=CC.Vector3Distance2D(player.position,this.locationTarget,true);if(distance>5*5){player.turnPlayer(this.locationTarget,delta)}else{this.landPlayerOnTarget(distance,delta)}}this.player.dirtyModelMatrix()}};CharacterControllerPlayer.prototype.landPlayerOnTarget=function(distance,delta){var player=this.player;var locationTarget=this.locationTarget;if(this.distanceToLocationTarget===CC_MAXFLOAT){var angleTowardsTarget=CC.AngleTowardsVector(locationTarget,player.position);var angleDistance=CC.DistanceBetweenAngles(player.rotation[1],angleTowardsTarget);if(angleDistance>15){player.turnPlayer(locationTarget,delta);player.movementDirection[2]=0;return false}else{this.distanceToLocationTarget=distance}}if(distance<=this.distanceToLocationTarget){this.distanceToLocationTarget=distance;player.movementDirection[2]=.5}else{var collidedWith=CC.CollisionCheck(player,locationTarget,true,CC.collision_box);if(!collidedWith){player.setPosition(locationTarget)}player.movementDirection[2]=0;this.stopAction();return true}return false};CharacterControllerPlayer.prototype.moveAction=function(){if(this.player.setMovementAnimation){this.player.setMovementAnimation()}this.moving=true;if(this.collidedWhileMoving){this.collidedWhileMoving=false}};CharacterControllerPlayer.prototype.stopAction=function(){this.setLocationTarget(this.player.position);if(this.player.setIdleAnimation){this.player.setIdleAnimation()}this.moving=false};function CharacterControllerAI(pathFinderNetwork){this.construct(pathFinderNetwork)}ExtendPrototype(CharacterControllerAI,CharacterControllerPlayer);CharacterControllerAI.cycle_off=0;CharacterControllerAI.cycle_inOrder=1;CharacterControllerAI.cycle_randomNodes=2;CharacterControllerAI.cycle_randomConnections=3;CharacterControllerAI.cycle_towardsEnemy=4;CharacterControllerAI.max_waypoints=50;CharacterControllerAI.prototype.construct=function(pathFinderNetwork){this.CharacterControllerPlayer_construct(pathFinderNetwork);this.waypoints=[];this.waypointCurrent=0;this.waypointCycle=CharacterControllerAI.cycle_off;this.targetConnection=null;this.nodesPerMovementCycle=0;this.waitTime=0;this.enemy=null;this.scanForEnemyTimer=0;this.scanForEnemyTime=2;this.shouldFollowEnemy=true;this.followingEnemy=false;this.distanceToEnemy=CC_MAXFLOAT;this.shouldShootAtEnemy=true;this.shootingTimer=0;this.shootingBurstTime=CC_MAXFLOAT;this.lastShotTime=0;this.shootingWaitTime=0};CharacterControllerAI.prototype.destruct=function(){this.CharacterControllerPlayer_destruct()};CharacterControllerAI.prototype.update=function(delta){if(this.enabled){var enemy=this.enemy;if(enemy){if(!enemy.isActive()){this.enemy=null}else{this.scanForEnemyTimer+=delta;if(this.scanForEnemyTimer>this.scanForEnemyTime){this.scanForEnemyTimer-=this.scanForEnemyTime;this.distanceToEnemy=CC.Vector3Distance2D(this.player.position,this.enemy.position,true);if(this.shouldFollowEnemy&&this.distanceToEnemy<CC.SQUARE(150)){this.followEnemy()}else if(!this.moving){if(this.followingEnemy){this.followingEnemy=false}this.nextWaypoint()}}}}if(this.shootingState===CharacterControllerPlayer.state_stopped){this.lastShotTime+=delta;if(this.lastShotTime>this.shootingWaitTime){if(this.followingEnemy){if(!enemy){this.followingEnemy=false}else if(this.shouldShootAtEnemy){if(this.distanceToEnemy<CC.SQUARE(100)){this.shoot(enemy.position,enemy);this.lastShotTime=0}}}}}else{this.shootingTimer+=delta;if(this.shootingTimer>this.shootingBurstTime){this.stopShooting()}}}return this.CharacterControllerPlayer_update(delta)};CharacterControllerAI.prototype.isAI=function(){return true};CharacterControllerAI.prototype.movePlayer=function(delta){var player=this.player;if(this.waitTime>0){player.movementDirection[2]=0;this.waitTime-=delta;if(this.waitTime<=0){this.nextWaypoint()}}else if(this.moving){if(this.path){this.CharacterControllerPlayer_movePlayer(delta)}else{var distance=CC.Vector3Distance2D(player.position,this.locationTarget,true);if(distance>5*5){player.turnPlayer(this.locationTarget,delta)}else{if(this.landPlayerOnTarget(distance,delta)){if(!this.followingEnemy&&this.enabled){if(this.waypointCycle===CharacterControllerAI.cycle_randomConnections||this.waypointCycle===CharacterControllerAI.cycle_towardsEnemy){this.waitTime=CC.Random()%5+1}else{this.nextWaypoint()}}}}}}};CharacterControllerAI.prototype.recieveCollisionFrom=function(collidedWith){if(this.followingEnemy){this.followingEnemy=false;this.validateAnchorNode()}if(this.waypointCycle===CharacterControllerAI.cycle_randomConnections){this.waitTime=0;this.pickRandomConnection()}else{this.nextWaypoint()}};CharacterControllerAI.prototype.reportAttack=function(attackedBy,attackType,force,damage,x,y,z){return this.CharacterControllerPlayer_reportAttack(attackedBy,attackType,force,damage,x,y,z)};CharacterControllerAI.prototype.setEnemy=function(inEnemy){this.enemy=inEnemy};CharacterControllerAI.prototype.followEnemy=function(){this.goToUsingPath(this.enemy.position);this.followingEnemy=true};CharacterControllerAI.prototype.setWaypointCycle=function(inCycleType){this.waypointCycle=inCycleType;if(this.enabled){if(this.waypointCycle===CharacterControllerAI.cycle_randomNodes){this.waypointCurrent=CC.Random()%this.waypoints.length;this.goTo(waypoints[this.waypointCurrent])}else if(this.waypointCycle===CharacterControllerAI.cycle_randomConnections){this.validateAnchorNode();this.pickRandomConnection()}}};CharacterControllerAI.prototype.addWaypoint=function(target){this.waypoints.add(target);if(this.enabled&&!this.moving){this.waypointCurrent=this.waypoints.length-1;this.goToUsingPath(target)}};CharacterControllerAI.prototype.scanWaypoints=function(radius,amount){if(amount===undefined){amount=CharacterControllerAI.max_waypoints}var points=[];var found=this.pathFinderNetwork.findClosestNodes(this.player.position,radius,points,amount);for(var i=0;i<found;++i){this.addWaypoint(points[i])}};CharacterControllerAI.prototype.nextWaypoint=function(){if(this.waypointCycle===CharacterControllerAI.cycle_randomConnections){if(this.targetConnection&&this.targetConnection.node){this.anchorNode=this.targetConnection.node;this.pickClosestAngledConnection()}else{this.pickRandomConnection()}}else if(this.waypointCycle===CharacterControllerAI.cycle_towardsEnemy){if(this.enemy){var player=this.player;var enemy=this.enemy;var distance=CC.Vector3Distance2D(player.position,enemy.position,true);if(distance>CC.SQUARE(player.collisionSize.width*3)){var direction=CC.Vector3Direction(player.position,enemy.position);var target=direction;vec3.scale(target,direction,player.collisionSize.width);vec3.add(direction,player.position,direction);this.goTo(target)}}}else{if(this.waypointCycle===CharacterControllerAI.cycle_off){if(this.waypoints.length>0){for(var i=0;i<this.waypoints.length-1;++i){this.waypoints[i]=this.waypoints[i+1]}this.waypoints.length--;if(this.waypoints.length>0){goToUsingPath(waypoints[0])}}}else if(this.waypointCycle===CharacterControllerAI.cycle_inOrder){this.waypointCurrent++;if(this.waypointCurrent>=this.waypoints.length){this.waypointCurrent=0}}else if(this.waypointCycle===CharacterControllerAI.cycle_randomNodes){this.waypointCurrent=CC.Random()%this.waypoints.length}if(this.waypointCurrent<this.waypoints.length){this.goToUsingPath(this.waypoints[this.waypointCurrent])}}};CharacterControllerAI.prototype.pickClosestAngledConnection=function(){if(this.enabled){if(this.anchorNode&&this.anchorNode.connections.length>0){var player=this.player;var closestConnection=0;var closestAngle=CC_MAXFLOAT;var anchorNode=this.anchorNode;var anchorNodeConnections=anchorNode.connections;for(i=0;i<anchorNodeConnections.length;++i){var angleDistance=CC.DistanceBetweenAngles(player.rotation[1],anchorNodeConnections[i].angle);if(angleDistance<closestAngle){closestConnection=i;closestAngle=angleDistance}}this.targetConnection=anchorNodeConnections[closestConnection];this.goTo(this.targetConnection.node.point)}else{this.anchorNode=null;this.validateAnchorNode();this.pickRandomConnection()}}};CharacterControllerAI.prototype.pickRandomConnection=function(){if(this.enabled){this.validateAnchorNode();if(this.anchorNode&&this.anchorNode.connections.length>0){var randomPath=CC.Random()%this.anchorNode.connections.length;this.targetConnection=this.anchorNode.connections[randomPath];this.goTo(this.targetConnection.node.point)}}};function CharacterPlayer(inMovementSpeed,inCharacterSize){this.construct(inMovementSpeed,inCharacterSize)}ExtendPrototype(CharacterPlayer,CCMoveable);CharacterPlayer.Spawn=function(type,obj,tex,speed,size,onLoadedCallback){var character=new CharacterPlayer(speed,size);character.type=type;character.setupBody(obj,tex,function(){character.finalizeModel();{character.finalizeModel();character.setupWeapon(character.modelBody);if(onLoadedCallback){onLoadedCallback(character)}}});return character};CharacterPlayer.prototype.construct=function(inMovementSpeed,inCharacterSize){this.CCMoveable_construct();this.collisionBoxMultiple=1.25;if(!inMovementSpeed){inMovementSpeed=50}this.movementSpeed=inMovementSpeed;this.turningSpeed=720;this.instantTurns=false;if(!inCharacterSize){inCharacterSize=15}this.characterSize=inCharacterSize;this.collideableType=CC.AddFlag(this.collideableType,CC.collision_character);this.controller=null;this.gravity=false;this.sceneMap=null;this.playerID="";this.userID="";this.type="";this.modelBody=this.modelHead=null;this.setModel(new CCModelBase);this.model3DBase=new CCModelBase;this.model.addModel(this.model3DBase);this.modelWeaponBase=this.model3DBase;this.modelRotationTargetActive=false;this.modelRotationTarget=0;this.modelHeadAnimationActive=false;this.modelHeadAnimationState=0;this.characterIndicator=null;this.shootingIndicator=null;this.shootingScaleInterpolator=new CCInterpolatorV3(CCInterpolatorSin2Curve);this.lastTimeAttacked=0;this.deathFadeOut=false;this.weapons=[];this.shootingBurstTimer=0;this.setTransparent(true);this.setColourAlpha(0,false);this.setColourAlpha(.25,true);this.setupWeapon(this.model3DBase);this.finalizeModel()};CharacterPlayer.prototype.setSize=function(size){this.characterSize=size;this.finalizeModel()};CharacterPlayer.prototype.deleteLater=function(){if(this.sceneMap){this.sceneMap.deletingCharacter(this)}this.CCMoveable_deleteLater()};CharacterPlayer.prototype.dirtyModelMatrix=function(){this.CCMoveable_dirtyModelMatrix();var position=this.position;if(this.characterIndicator){this.characterIndicator.setPositionXZ(position[0],position[2])}if(this.shootingIndicator){this.shootingIndicator.setPositionXZ(position[0],position[2])}};CharacterPlayer.prototype.setupMap=function(sceneMap,playerID,userID){this.setScene(sceneMap);this.sceneMap=sceneMap;this.setPlayerIDs(playerID,userID)};CharacterPlayer.prototype.getMap=function(){return this.sceneMap};CharacterPlayer.prototype.getType=function(){return this.type};CharacterPlayer.prototype.setupAI=function(controller){if(this.controller){this.removeUpdater(this.controller);this.controller.destruct()}this.controller=controller;this.controller.setPlayer(this);this.addUpdater(controller)};CharacterPlayer.prototype.setupBody=function(modelFile,textureFile,callback){var self=this;var LoadedModelFunction=function(modelFile,textureFile){self.loadingBodyModel=modelFile;self.loadingBodyTexture=textureFile;return function(model3d){if(self.loadingBodyModel===modelFile&&self.loadingBodyTexture===textureFile){delete self.loadingBodyModel;delete self.loadingBodyTexture;if(model3d){if(self.modelBody){self.model3DBase.removeModel(self.modelBody);self.modelBody.destruct();self.modelBody=null}self.setColourAlpha(1,true,function(){if(!self.forceTransparent){self.setTransparent(false)}});self.modelBody=model3d}callback(model3d)}else if(model3d){self.model3DBase.removeModel(model3d)}}};this.setupModel(modelFile,textureFile,new LoadedModelFunction(modelFile,textureFile))};CharacterPlayer.prototype.setupHead=function(modelFile,textureFile,callback){var self=this;this.setupModel(modelFile,textureFile,function(model3d){self.modelHead=model3d;callback()})};CharacterPlayer.prototype.finalizeModel=function(){var characterSize=this.characterSize;var modelWidth=characterSize;var modelDepth=characterSize;var bodyHeight=characterSize;var modelBody=this.modelBody;var modelHead=this.modelHead;if(modelBody){modelWidth=modelBody.getWidth();modelDepth=modelBody.getDepth();bodyHeight=modelBody.getHeight()}var modelHeight=bodyHeight;this.finalizeSize(modelWidth,modelDepth,modelHeight)};CharacterPlayer.prototype.finalizeSize=function(modelWidth,modelDepth,modelHeight){var characterSize=this.characterSize;var modelSize=modelHeight>modelWidth?modelHeight:modelWidth;if(modelSize<modelDepth){modelSize=modelDepth}var scaleFactor=characterSize/modelSize;this.model3DBase.setScale(scaleFactor);modelWidth*=scaleFactor;modelDepth*=scaleFactor;modelHeight*=scaleFactor;this.setSquareCollisionBounds(characterSize*this.collisionBoxMultiple,modelHeight)};CharacterPlayer.prototype.setupWeapon=function(modelObj,index){if(modelObj){if(index===undefined){index=0}var weapon;var weapons=this.weapons;if(weapons.length>index){weapon=weapons[index];weapons.remove(weapon);weapon.destruct()}weapon=new WeaponBase(this);weapon.setup(modelObj);weapons.insert(weapon,index)}};CharacterPlayer.prototype.useableWeapon=function(weaponName){return false};CharacterPlayer.prototype.setWeaponSettings=function(timeToReady,bulletDamage,bulletTax,fireChargeRate){var weapons=this.weapons;for(var i=0;i<weapons.length;++i){var weapon=weapons[i];if(timeToReady){weapon.setTimeToReady(timeToReady)}if(bulletDamage){weapon.setBulletDamage(bulletDamage)}if(bulletTax){weapon.setBulletTax(bulletTax)}if(fireChargeRate){weapon.setChargeRate(fireChargeRate)}}};CharacterPlayer.prototype.setWeaponBulletSpeed=function(bulletSpeed){var weapons=this.weapons;for(var i=0;i<weapons.length;++i){var weapon=weapons[i];weapon.setupBullet(null,bulletSpeed)}};CharacterPlayer.prototype.rechargeWeapon=function(){var weapons=this.weapons;for(var i=0;i<weapons.length;++i){weapons[i].addAmmo(1)}};CharacterPlayer.prototype.setupModel=function(modelFile,tex,callback){var self=this;if(tex){gEngine.textureManager.getTextureHandle(tex)}CCModel3D.CacheModel(modelFile,true,function(model3d){if(model3d){if(tex){model3d.setTexture(tex)}self.model3DBase.addModel(model3d);callback(model3d)}else{callback(model3d)}},2)};CharacterPlayer.prototype.setupCharacterIndicator=function(textureFile,colour){this.characterIndicator=new CollideableIndicator(this,textureFile);this.characterIndicator.setDrawOrder(97);this.characterIndicator.setScale(2);this.characterIndicator.setColour(colour)};CharacterPlayer.prototype.setupShootingIndicator=function(textureFile,colour){this.shootingIndicator=new CollideableIndicator(this,textureFile);this.shootingIndicator.setScale(0);this.shootingIndicator.setColour(colour)};CharacterPlayer.prototype.scaleShootingIndicator=function(target){if(this.shootingIndicator){if(this.shootingIndicator.scale){if(target>0){this.shootingScaleInterpolator.setDuration(.5)}else{this.shootingScaleInterpolator.setDuration(2)}this.shootingScaleInterpolator.setup(this.shootingIndicator.scale,target)}}};CharacterPlayer.prototype.update=function(delta){if(this.deathFadeOut){this.deleteLater()}if(this.modelHeadAnimationActive&&this.modelHead){var modelHead=this.modelHead;var angle=5;var speed=delta*30;if(this.modelHeadAnimationState===0){if(modelHead.rotation[2]!==angle){modelHead.rotation[2]=CC.ToRotation(modelHead.rotation[2],angle,speed);modelHead.rotationUpdated()}else{modelHeadAnimationState=1}}else if(modelHeadAnimationState===1){if(modelHead.rotation[2]!==360-angle){modelHead.rotation[2]=CC.ToRotation(modelHead.rotation[2],360-angle,speed);modelHead.rotationUpdated()}else{this.modelHeadAnimationState=0}}}if(this.updateModelMatrix){var position=this.position;if(this.characterIndicator){this.characterIndicator.setPositionXZ(position[0],position[2])}if(this.shootingIndicator){this.shootingIndicator.setPositionXZ(position[0],position[2])}}if(this.characterIndicator){this.characterIndicator.rotateY(delta*-180)}if(this.shootingIndicator){this.shootingScaleInterpolator.update(delta);if(this.shootingIndicator.scale[0]>0){this.shootingIndicator.rotateY(delta*720)}}{var weapons=this.weapons;var updatedAmmo=false;for(var i=0;i<weapons.length;++i){var weapon=weapons[i];if(weapon.updateCharge(delta)){updatedAmmo=true}}if(updatedAmmo){if(this.sceneMap){this.sceneMap.registerAmmoUpdate(this)}}}var updated=this.CCMoveable_update(delta);this.updateWeaponAim(delta);return updated};CharacterPlayer.prototype.renderModel=function(alpha){if(this.modelBody){this.CCMoveable_renderModel(alpha)}else if(alpha){if(!this.disableCulling){gRenderer.CCSetCulling(false)}if(!this.readDepth){gRenderer.CCSetDepthRead(true)}CCRenderer.GLPushMatrix();gRenderer.CCSetColour(this.colour);gEngine.textureManager.setTextureIndex(1);var size=this.collisionSize.width;CCRenderer.GLScale([size,size,size]);gRenderer.CCRenderCube(false);CCRenderer.GLPopMatrix();if(!this.readDepth){gRenderer.CCSetDepthRead(false)}if(!this.disableCulling){gRenderer.CCSetCulling(true)}}};CharacterPlayer.prototype.requestCollisionWith=function(collisionTarget){var collidedWith=this.CCMoveable_requestCollisionWith(collisionTarget);if(collidedWith){if(collidedWith.getType()==="health"){var pickup=collidedWith;if(pickup){if(this.sceneMap){if(this.sceneMap.handlePickup(this,pickup)){collidedWith=null}}}}if(collidedWith){if(this.controller){this.controller.recieveCollisionFrom(collisionTarget)}}return collidedWith}return null};CharacterPlayer.prototype.recieveCollisionFrom=function(collisionSource,x,y,z){if(this.controller){this.controller.recieveCollisionFrom(collisionSource)}return this.CCMoveable_recieveCollisionFrom(collisionSource,x,y,z)};CharacterPlayer.prototype.reportAttack=function(attackedBy,attackType,force,damage,x,y,z){if(this.isActive()&&this.controller){var sinceLastAttack=gEngine.lifetime-this.lastTimeAttacked;if(sinceLastAttack>.25){this.lastTimeAttacked=gEngine.lifetime;{var particle=new CollideableParticle(3);particle.setModel(new CCModelBase);particle.setColour(new CCColour);var primitive=new CCPrimitiveSquare;particle.model.addPrimitive(primitive);particle.model.setScale(30);primitive.setTexture("fx_impact_texture.png",true,true);particle.setScene(this.inScene);this.ownObject(particle);particle.setPosition(this.position);particle.setRotationY(this.sceneMap.camera.rotation[1])}}this.controller.reportAttack(attackedBy,attackType,force,damage,x,y,z);return this.handleAttack(attackedBy,attackType,force,damage,x,y,z)}return false};CharacterPlayer.prototype.handleAttack=function(attackedBy,attackType,force,damage,x,y,z){var killed=false;var map=this.sceneMap;var health=this.controller.getHealth();if(health>0){health-=damage;this.controller.setHealth(health);if(health<=0){this.handleDeath(attackedBy);killed=true}}var attackVelocity=vec3.clone([x,y,z]);vec3.unitize(attackVelocity);vec3.scale(attackVelocity,attackVelocity,force*.1);this.incrementAdditionalVelocity(attackVelocity[0],attackVelocity[1],attackVelocity[2]);map.registerDamage(attackedBy,this,damage);return killed};CharacterPlayer.prototype.handleDeath=function(killer){this.sceneMap.registerDeath(this.playerID,killer,false)};CharacterPlayer.prototype.setPlayerIDs=function(playerID,userID){this.playerID=playerID;this.userID=userID};CharacterPlayer.prototype.getPlayerID=function(){return this.playerID};CharacterPlayer.prototype.getUserID=function(){return this.userID};CharacterPlayer.prototype.activateHeadAnimation=function(){this.modelHeadAnimationActive=true};CharacterPlayer.prototype.readyWeapon=function(actionID){this.shootingBurstTimer=1};CharacterPlayer.prototype.unReadyWeapon=function(){this.unAimWeapon()};CharacterPlayer.prototype.shotFired=function(weapon){if(this.sceneMap){this.sceneMap.registerAttacking(this)}};CharacterPlayer.prototype.shootWeapon=function(delta){var showShootingIndicator=false;var weapons=this.weapons;for(var i=0;i<weapons.length;++i){var previousWeapon=i>0?weapons[i-1]:null;if(previousWeapon){if(previousWeapon.getTimeSinceLastShot()<.05){showShootingIndicator=true;break}}var weapon=weapons[i];if(weapon.hasEnoughAmmo()){showShootingIndicator=true;if(weapon.isReady()){weapon.shootWeapon(this.modelRotationTarget);this.shotFired(weapon)}}}if(showShootingIndicator){this.scaleShootingIndicator(2)}else{this.scaleShootingIndicator(0)}this.shootingBurstTimer-=delta;if(this.shootingBurstTimer<=0){this.shootingBurstTimer=0;return false}return true};CharacterPlayer.prototype.getWeaponAimAngleToTarget=function(target){var baseRotation=0-this.rotation[1];var combinedRotation=baseRotation+this.modelRotationTarget;var targetRotation=combinedRotation;targetRotation=CC.ClampRotation(targetRotation);var distance=CC.DistanceBetweenAngles(this.modelWeaponBase.rotation[1],targetRotation);return distance};CharacterPlayer.prototype.getModelRotation=function(){return this.rotation[1]+this.modelWeaponBase.rotation[1]};CharacterPlayer.prototype.aimWeapon=function(target){this.modelRotationTargetActive=true;this.modelRotationTarget=CC.AngleTowardsVector(target,this.position)};CharacterPlayer.prototype.unAimWeapon=function(){this.scaleShootingIndicator(0);this.modelRotationTargetActive=false;this.modelRotationTarget=0};CharacterPlayer.prototype.updateWeaponAim=function(timeDelta){var i;var weapons=this.weapons;var modelWeaponBase=this.modelWeaponBase;if(this.modelRotationTargetActive){var baseRotation=0-this.rotation[1];var combinedRotation=baseRotation+this.modelRotationTarget;var targetRotation=combinedRotation;targetRotation=CC.ClampRotation(targetRotation);if(modelWeaponBase.rotation[1]!==targetRotation){if(this.instantTurns){modelWeaponBase.setRotationY(targetRotation)}else{modelWeaponBase.setRotationY(CC.ToRotation(modelWeaponBase.rotation[1],targetRotation,timeDelta*this.turningSpeed))}for(i=0;i<weapons.length;++i){weapons[i].updateParentRotation(modelWeaponBase.rotation[1])}}}else{if(modelWeaponBase.rotation[1]!==0){if(this.instantTurns){modelWeaponBase.setRotationY(0)}else{modelWeaponBase.setRotationY(CC.ToRotation(modelWeaponBase.rotation[1],0,timeDelta*this.turningSpeed*.5))}for(i=0;i<weapons.length;++i){weapons[i].updateParentRotation(modelWeaponBase.rotation[1])}}}};CharacterPlayer.prototype.getWeaponAmmo=function(){var weapons=this.weapons;if(weapons.length===0){return 1}var ammo=0;for(var i=0;i<weapons.length;++i){ammo+=weapons[i].getAmmo()}return ammo};CharacterPlayer.prototype.triggerDeath=function(attackedBy,force,x,y,z){this.collideableType=CC.collision_none;vec3.scale(this.movementDirection,this.movementDirection,0);this.removeUpdater(this.controller);this.controller.destruct();this.deleteLater()};CharacterPlayer.prototype.animatedDeath=function(){this.deathFadeOut=true;if(this.owner){this.owner.unOwnObject(this);this.owner=null}};CharacterPlayer.prototype.turnPlayer=function(target,delta){var angleTowardsTarget=CC.AngleTowardsVector(target,this.position);if(this.instantTurns){this.setRotationY(angleTowardsTarget);return 0}this.setRotationY(CC.ToRotation(this.rotation[1],angleTowardsTarget,delta*this.turningSpeed));return angleTowardsTarget};function CharacterPlayerModel(){this.construct()}ExtendPrototype(CharacterPlayerModel,CharacterPlayer);CharacterPlayerModel.Spawn=function(type,onLoadedCallback){var character=new CharacterPlayerModel;character.type=type;DBAssets.LoadModelID(type,function(modelInfo){var obj=modelInfo.obj;
var tex=modelInfo.tex;character.setupBody(obj,tex,function(){character.finalizeModel();if(onLoadedCallback){onLoadedCallback(character)}})});return character};CharacterPlayerModel.prototype.finalizeModel=function(){var characterSize=this.characterSize;var modelWidth=characterSize;var modelDepth=characterSize;var bodyHeight=characterSize;var modelBody=this.modelBody;if(modelBody){modelWidth=modelBody.getWidth();modelDepth=modelBody.getDepth();bodyHeight=modelBody.getHeight()}var modelHeight=bodyHeight;this.finalizeSize(modelWidth,modelDepth,modelHeight)};CharacterPlayerModel.prototype.update=function(delta){this.CharacterPlayer_update(delta);if(this.modelBody){this.modelBody.animate(delta*this.movementDirection[2])}};function CharacterPlayerPrefab(){this.construct()}ExtendPrototype(CharacterPlayerPrefab,CharacterPlayer);CharacterPlayerPrefab.Spawn=function(type,onLoadedCallback){var character=new CharacterPlayerPrefab;character.type=type;character.collisionBoxMultiple=.5;character.finalizeModel();character.onLoadedCallback=onLoadedCallback;var LoadedCharacterID=function(character){return function(characterInfo){if(characterInfo){var actions=characterInfo.actions;if(actions){for(var i=0;i<actions.length;++i){character.actions[i]=actions[i];character.loadAction(i,i===0?1:0)}}}}};DBAssets.LoadCharacterID(type,new LoadedCharacterID(character),character);return character};CharacterPlayerPrefab.prototype.loadAction=function(i,priority){var actions=this.actions;if(i<actions.length){var self=this;var action=actions[i];var LoadedModelID=function(i){return function(modelInfo){actions[i].modelInfo=modelInfo;if(i===0){if(modelInfo){self.setupBody(modelInfo.obj,modelInfo.tex,function(model3d){self.finalizeModel();if(self.onLoadedCallback){self.onLoadedCallback(self);delete self.onLoadedCallback}})}}if(self.currentActionIndex===i){self.setActionIndex(i)}}};DBAssets.LoadModelID(action.modelID,new LoadedModelID(i),priority,this);if(action.sfxID){DBAssets.LoadAudioID(action.sfxID,function(sfxInfo){if(sfxInfo){action.sfxInfo=sfxInfo}})}}};CharacterPlayerPrefab.prototype.construct=function(){this.CharacterPlayer_construct();this.actions=[];this.setActionIndex(0);this.animationSpeed=1};CharacterPlayerPrefab.prototype.destruct=function(){this.CharacterPlayer_destruct()};CharacterPlayerPrefab.prototype.deleteLater=function(){DBAssets.RemoveUpdateCallbacks(this)};CharacterPlayerPrefab.prototype.finalizeModel=function(){var characterSize=this.characterSize;var modelWidth=characterSize;var modelDepth=characterSize;var bodyHeight=characterSize;var modelBody=this.modelBody;if(modelBody){modelWidth=modelBody.getWidth();modelDepth=modelBody.getDepth();bodyHeight=modelBody.getHeight()}var modelHeight=bodyHeight;this.finalizeSize(modelWidth,modelDepth,modelHeight)};CharacterPlayerPrefab.prototype.update=function(delta){this.CharacterPlayer_update(delta);if(this.modelBody&&!this.animationPaused){this.modelBody.animate(delta*this.animationSpeed,this.currentActionPriority===0)}var sinceLastAttack;if(this.currentActionID==="hit"){sinceLastAttack=gEngine.lifetime-this.lastTimeAttacked;if(sinceLastAttack>.5){this.setCurrentActionPriority(0);this.setIdleAnimation()}}else if(this.currentActionID==="ko"){sinceLastAttack=gEngine.lifetime-this.lastTimeAttacked;if(sinceLastAttack>2){this.setCurrentActionPriority(0);this.setIdleAnimation()}}};CharacterPlayerPrefab.prototype.setCurrentActionPriority=function(priority){this.currentActionPriority=priority};CharacterPlayerPrefab.prototype.setActionID=function(actionID,priority){if(this.currentActionID!==actionID){var actions=this.actions;for(var i=0;i<actions.length;++i){if(actions[i].actionID===actionID){this.setActionIndex(i,priority);return true}}}return false};CharacterPlayerPrefab.prototype.setActionIndex=function(actionIndex,priority){if(priority===undefined){priority=0}if(this.currentActionPriority===undefined){this.currentActionPriority=0}if(priority>=this.currentActionPriority){this.currentActionLoaded=false;this.currentActionPriority=priority;this.currentActionIndex=actionIndex;if(this.modelBody){var action=this.actions[actionIndex];if(action){this.currentActionID=action.actionID;if(actionIndex<this.actions.length){var modelInfo=action.modelInfo;if(modelInfo){this.currentActionLoaded=true;var obj=modelInfo.obj;var tex=modelInfo.tex;if(this.modelBody.primitive.filename!==obj){var self=this;self.setupBody(obj,tex,function(model3d){self.finalizeModel();if(model3d){var modelHeight=model3d.getHeight()*self.model3DBase.scale[1];var modelShouldBeAtY=modelHeight*.5;var characterY=self.collisionBounds[1];model3d.setPositionY(-(characterY-modelShouldBeAtY)*.5)}})}else if(this.modelBody.primitive.tex!==tex){if(tex){this.modelBody.setTexture(tex)}}}if(action.sfxInfo){CCAudioManager.Play("sfx",action.sfxInfo.mp3,true)}}}}}return false};CharacterPlayerPrefab.prototype.setupAI=function(controller){this.CharacterPlayer_setupAI(controller)};CharacterPlayerPrefab.prototype.setupWeapon=function(modelObj,index){if(modelObj){if(index===undefined){index=0}var weapon;var weapons=this.weapons;if(weapons.length>index){weapon=weapons[index];weapons.remove(weapon);weapon.destruct()}weapon=new WeaponBase(this);weapon.setup(modelObj,false,false);weapon.setFireRate(1);weapon.setupBullet(.5,10,false);weapons.insert(weapon,index)}};CharacterPlayerPrefab.prototype.readyWeapon=function(actionID){this.CharacterPlayer_readyWeapon(actionID);this.setActionID(actionID,1);if(this.modelBody){this.modelBody.setAnimationFrame(0)}this.animationPaused=true};CharacterPlayerPrefab.prototype.unReadyWeapon=function(){if(this.animationPaused){this.animationPaused=false}this.CharacterPlayer_unReadyWeapon()};CharacterPlayerPrefab.prototype.shootWeapon=function(delta){if(this.animationPaused){var weapons=this.weapons;for(var i=0;i<weapons.length;++i){var weapon=weapons[i];if(weapon.timeToReady<.25){this.shootingBurstTimer=1;this.animationPaused=false;break}}}return this.CharacterPlayer_shootWeapon(delta)};CharacterPlayerPrefab.prototype.reportAttack=function(attackedBy,attackType,force,damage,x,y,z){if(this.isActive()&&this.controller){var sinceLastAttack=gEngine.lifetime-this.lastTimeAttacked;this.lastTimeAttacked=gEngine.lifetime;this.setActionID("hit",2);if(sinceLastAttack>.5){this.lastTimeAttacked=gEngine.lifetime;{var particle=new CollideableParticle(1,2);particle.setModel(new CCModelBase);particle.setColour(new CCColour);var primitive=new CCPrimitiveSquare;particle.model.addPrimitive(primitive);particle.model.setScale(10);primitive.setTexture("fx_impact_texture.png",true,true);particle.setScene(this.inScene);this.ownObject(particle);particle.setPosition(this.position);particle.translate(0,this.collisionBounds[1],0);particle.setRotationY(this.sceneMap.camera.rotation[1])}}this.controller.reportAttack(attackedBy,attackType,force,damage,x,y,z);return this.handleAttack(attackedBy,attackType,force,damage,x,y,z)}return false};CharacterPlayerPrefab.prototype.handleAttack=function(attackedBy,attackType,force,damage,x,y,z){damge=damage*(1-this.controller.damageResistance);return this.CharacterPlayer_handleAttack(attackedBy,attackType,force,damage,x,y,z)};CharacterPlayerPrefab.prototype.handleDeath=function(killer){this.lastTimeAttacked=gEngine.lifetime;this.setActionID("ko",2);this.CharacterPlayer_handleDeath(killer)};CharacterPlayerPrefab.prototype.setIdleAnimation=function(actionID){if(actionID||!this.idleAnimationID){if(!actionID){actionID="idle"}if(this.idleAnimationID!==actionID){this.idleAnimationID=actionID}}this.setActionID(this.idleAnimationID)};CharacterPlayerPrefab.prototype.setMovementAnimation=function(actionID){if(actionID||!this.moveAnimationID){if(!actionID){actionID="move"}if(this.moveAnimationID!==actionID){this.moveAnimationID=actionID}}this.setActionID(this.moveAnimationID)};function CharacterPlayerAndroid(){this.construct()}ExtendPrototype(CharacterPlayerAndroid,CharacterPlayer);CharacterPlayerAndroid.Spawn=function(type,onLoadedCallback){var character=new CharacterPlayerAndroid;character.type=type;var path=type;path+="_";{var objPath=path;objPath+="body.obj";var texPath=path;texPath+="diffuse.jpg";character.setupBody(objPath,texPath,function(){character.finalizeModel();if(type==="androBot"){objPath=path;objPath+="screen.obj";texPath=path;texPath+="screen_diffuse.jpg";character.setupScreen(objPath,texPath,function(){character.finalizeModel()})}if(type==="androBot"||type==="iBot"){objPath=path;objPath+="head.obj";texPath=path;texPath+="diffuse.jpg";character.setupHead(objPath,texPath,function(){character.finalizeModel();if(onLoadedCallback){onLoadedCallback(character)}})}else{if(onLoadedCallback){onLoadedCallback(character)}}{objPath=path;objPath+="rightarm.obj";texPath=path;texPath+="diffuse.jpg";character.setupRightArm(objPath,texPath,function(){character.finalizeModel();character.setupWeapon(character.modelRightArm,0);if(type==="iBot"){objPath=path;objPath+="leftarm.obj";character.setupLeftArm(objPath,texPath,function(){if(character.modelLeftArm){character.finalizeModel();character.setupWeapon(character.modelLeftArm,1);character.weapons[0].setFireRate(.2);character.weapons[0].setMaxAmmo(.5);character.weapons[1].setFireRate(.2);character.weapons[1].setMaxAmmo(.5)}})}})}})}return character};CharacterPlayerAndroid.prototype.construct=function(){this.CharacterPlayer_construct();this.modelScreen=null;this.modelLeftArm=this.modelRightArm=null};CharacterPlayerAndroid.prototype.destruct=function(){this.CharacterPlayer_destruct()};CharacterPlayerAndroid.prototype.setupScreen=function(modelFile,textureFile,callback){var self=this;this.setupModel(modelFile,textureFile,function(model3d){self.modelScreen=model3d;callback()})};CharacterPlayerAndroid.prototype.setupLeftArm=function(modelFile,textureFile,callback){var self=this;this.setupModel(modelFile,textureFile,function(model3d){self.modelLeftArm=model3d;callback()})};CharacterPlayerAndroid.prototype.setupRightArm=function(modelFile,textureFile,callback){var self=this;this.setupModel(modelFile,textureFile,function(model3d){if(model3d){self.modelRightArm=model3d;callback()}})};CharacterPlayerAndroid.prototype.finalizeModel=function(){var characterSize=this.characterSize;var modelWidth=characterSize;var modelDepth=characterSize;var bodyHeight=characterSize;var modelBody=this.modelBody;var modelHead=this.modelHead;if(modelBody){modelWidth=modelBody.getWidth();modelDepth=modelBody.getDepth();bodyHeight=modelBody.getHeight()}var modelHeight=bodyHeight;if(modelHead){modelHeight+=modelHead.getHeight();if(modelBody){modelBody.setPositionXYZ(0,-modelHead.getHeight()*.5,0);modelHead.setPositionXYZ(0,modelBody.getHeight()*.5,modelBody.getDepth()*.25+modelHead.getDepth()*.25)}}this.finalizeSize(modelWidth,modelDepth,modelHeight);if(this.modelScreen){this.modelScreen.setPositionXYZ(0,modelBody.position[1],modelBody.getDepth()*.5)}var combinedWidth,y;var modelLeftArm=this.modelLeftArm;if(modelLeftArm){combinedWidth=modelBody.getWidth()*.5+modelLeftArm.getWidth()*.5;y=bodyHeight*.25-modelLeftArm.getHeight()*.5;modelLeftArm.setPositionXYZ(-combinedWidth,y,modelLeftArm.getDepth()*.25)}var modelRightArm=this.modelRightArm;if(modelRightArm){combinedWidth=modelBody.getWidth()*.5+modelRightArm.getWidth()*.5;y=bodyHeight*.25-modelRightArm.getHeight()*.5;modelRightArm.setPositionXYZ(combinedWidth,y,modelRightArm.getDepth()*.25)}};function CharacterPlayerWeb(){this.construct()}ExtendPrototype(CharacterPlayerWeb,CharacterPlayer);CharacterPlayerWeb.Spawn=function(type,onLoadedCallback){var character=new CharacterPlayerWeb;character.type=type;var path=type;path+="_";var texPath=path;texPath+="diffuse.jpg";{var objPath=path;objPath+="body.obj";character.setupBody(objPath,texPath,function(){{objPath=path;objPath+="head.obj";character.setupHead(objPath,texPath,function(){character.finalizeModel();if(onLoadedCallback){onLoadedCallback(character)}})}{objPath=path;objPath+="bazooka.obj";character.setupRightArm(objPath,texPath,function(){character.finalizeModel();character.setupWeapon(character.modelRightArm,0)})}})}return character};CharacterPlayerWeb.prototype.construct=function(){this.CharacterPlayer_construct()};CharacterPlayerWeb.prototype.destruct=function(){this.CharacterPlayer_destruct()};CharacterPlayerWeb.prototype.setupLeftArm=function(modelFile,textureFile,callback){var self=this;this.setupModel(modelFile,textureFile,function(model3d){self.modelLeftArm=model3d;callback()})};CharacterPlayerWeb.prototype.setupRightArm=function(modelFile,textureFile,callback){var self=this;this.setupModel(modelFile,textureFile,function(model3d){if(model3d){self.modelRightArm=model3d;callback()}})};CharacterPlayerWeb.prototype.finalizeModel=function(){var characterSize=this.characterSize;var modelWidth=characterSize;var modelDepth=characterSize;var bodyHeight=characterSize;var modelBody=this.modelBody;var modelHead=this.modelHead;if(modelBody){modelWidth=modelBody.getWidth();modelDepth=modelBody.getDepth();bodyHeight=modelBody.getHeight()}var modelHeight=bodyHeight;if(modelHead){modelHeight+=modelHead.getHeight();modelBody.setPositionXYZ(0,-modelHead.getHeight()*.5,0);modelHead.setPositionXYZ(0,modelBody.getHeight()*.5,-modelBody.getDepth()*.5)}this.finalizeSize(modelWidth,modelDepth,modelHeight);var combinedWidth,y;var modelLeftArm=this.modelLeftArm;if(modelLeftArm){combinedWidth=modelBody.getWidth()*.25;y=bodyHeight*.25-modelLeftArm.getHeight()*.5;modelLeftArm.setPositionXYZ(combinedWidth,y,modelLeftArm.getDepth()*.25)}var modelRightArm=this.modelRightArm;if(modelRightArm){combinedWidth=modelBody.getWidth()*.25;y=-(modelRightArm.getHeight()*.75);modelRightArm.setPositionXYZ(-combinedWidth,y,modelRightArm.getDepth()*.3)}};function CharacterPlayerBurger(){this.construct()}ExtendPrototype(CharacterPlayerBurger,CharacterPlayer);CharacterPlayerBurger.Spawn=function(type,onLoadedCallback){var character=new CharacterPlayerBurger;character.type=type;var classPath="";if(type.contains("burger")){classPath+="burger"}else{classPath+="fries"}{var objPath="";if(type==="doublefries"){objPath+="fries"}else{objPath+=type}objPath+=".obj";var texPath=classPath;texPath+="_diffuse.jpg";character.setupBody(objPath,texPath,function(){character.finalizeModel();if(onLoadedCallback){onLoadedCallback(character)}{objPath="bazooka.obj";texPath="bazooka_diffuse.jpg";character.setupRightArm(objPath,texPath,function(){character.finalizeModel();character.setupWeapon(character.modelRightArm,0);if(type.contains("double")){character.setupLeftArm(objPath,texPath,function(){character.finalizeModel();character.setupWeapon(character.modelLeftArm,1);character.weapons[0].setFireRate(.2);character.weapons[0].setMaxAmmo(.5);character.weapons[1].setFireRate(.2);character.weapons[1].setMaxAmmo(.5)})}})}})}return character};CharacterPlayerBurger.prototype.construct=function(){this.CharacterPlayer_construct();this.modelLeftArm=this.modelRightArm=null};CharacterPlayerBurger.prototype.destruct=function(){this.CharacterPlayer_destruct()};CharacterPlayerBurger.prototype.setupLeftArm=function(modelFile,textureFile,callback){var self=this;this.setupModel(modelFile,textureFile,function(model3d){self.modelLeftArm=model3d;callback()})};CharacterPlayerBurger.prototype.setupRightArm=function(modelFile,textureFile,callback){var self=this;this.setupModel(modelFile,textureFile,function(model3d){self.modelRightArm=model3d;callback()})};CharacterPlayerBurger.prototype.finalizeModel=function(){var characterSize=this.characterSize;var modelWidth=characterSize;var modelDepth=characterSize;var bodyHeight=characterSize;var modelBody=this.modelBody;if(modelBody){modelWidth=modelBody.getWidth();modelDepth=modelBody.getDepth();bodyHeight=modelBody.getHeight()}var modelHeight=bodyHeight;this.finalizeSize(modelWidth,modelDepth,modelHeight);var combinedWidth,y;var modelLeftArm=this.modelLeftArm;if(modelLeftArm){combinedWidth=modelBody.getWidth()*.7;y=bodyHeight*.35-modelLeftArm.getHeight()*.5;modelLeftArm.setPositionXYZ(-combinedWidth,y,modelLeftArm.getDepth()*.25)}var modelRightArm=this.modelRightArm;if(modelRightArm){combinedWidth=modelBody.getWidth()*.7;y=bodyHeight*.35-modelRightArm.getHeight()*.5;modelRightArm.setPositionXYZ(combinedWidth,y,modelRightArm.getDepth()*.25)}};function CharacterPlayerTank(){this.construct(undefined,20)}ExtendPrototype(CharacterPlayerTank,CharacterPlayer);CharacterPlayerTank.Spawn=function(type,onLoadedCallback){var character=new CharacterPlayerTank;character.type=type;var path="tank_";var texPath=path;texPath+="diffuse.jpg";{var objPath=path;objPath+="body.obj";character.setupBody(objPath,texPath,function(){character.finalizeModel();{objPath=path;objPath+="head.obj";character.setupHead(objPath,texPath,function(){character.finalizeModel();character.setupWeapon(character.modelHead);if(onLoadedCallback){onLoadedCallback(character)}})}})}return character};CharacterPlayerTank.prototype.construct=function(){this.CharacterPlayer_construct()};CharacterPlayerTank.prototype.destruct=function(){this.CharacterPlayer_destruct()};CharacterPlayerTank.prototype.setupHead=function(modelFile,textureFile,callback){var self=this;this.setupModel(modelFile,textureFile,function(model3d){self.model3DBase.removeModel(model3d);self.modelHead=model3d;var currentWeaponRotation=0;if(self.modelWeaponBase===self.model3DBase){currentWeaponRotation=self.modelWeaponBase.rotation[1];self.modelWeaponBase.rotation[1]=0;self.modelWeaponBase.dirtyModelMatrix()}self.modelWeaponBase=new CCModelBase;self.modelWeaponBase.rotation[1]=currentWeaponRotation;self.modelWeaponBase.addModel(model3d);self.model3DBase.addModel(self.modelWeaponBase);if(callback){callback()}})};CharacterPlayerTank.prototype.finalizeModel=function(){var characterSize=this.characterSize;var modelWidth=characterSize;var modelDepth=characterSize;var bodyHeight=characterSize;var modelBody=this.modelBody;var modelHead=this.modelHead;if(modelBody){modelWidth=modelBody.getWidth();modelDepth=modelBody.getDepth();bodyHeight=modelBody.getHeight()}var modelHeight=bodyHeight;if(modelHead){var headHeight=modelHead.getHeight();{var origin=modelHead.getOrigin();modelHead.setPositionXYZ(origin[0],headHeight*.5,origin[2])}}this.finalizeSize(modelWidth,modelDepth,modelHeight)};function CharacterPlayerSoldier(){this.construct()}ExtendPrototype(CharacterPlayerSoldier,CharacterPlayer);CharacterPlayerSoldier.Spawn=function(type,onLoadedCallback){var character=new CharacterPlayerSoldier;character.type=type;var typePath=type;typePath+="_";var classPath="soldier_";{var objPath=classPath;objPath+="body.obj";var texPath=typePath;texPath+="body_diffuse.jpg";character.setupBody(objPath,texPath,function(){character.finalizeModel();{objPath=typePath;objPath+="head.obj";texPath=typePath;texPath+="head_diffuse.jpg";character.setupHead(objPath,texPath,function(){character.finalizeModel();if(onLoadedCallback){onLoadedCallback(character)}objPath=classPath;objPath+="weapon_bazooka.obj";texPath=classPath;texPath+="weapon_bazooka_diffuse.jpg";character.setupArms(objPath,texPath)})}})}return character};CharacterPlayerSoldier.prototype.construct=function(){this.CharacterPlayer_construct()};CharacterPlayerSoldier.prototype.destruct=function(){this.CharacterPlayer_destruct()};CharacterPlayerSoldier.prototype.setupArms=function(modelFile,textureFile,callback){var self=this;this.setupModel(modelFile,textureFile,function(model3d){self.modelArms=model3d;{var origin=model3d.getOrigin();model3d.translate(origin[0],-origin[1],origin[2])}self.setupWeapon(self.modelArms,0);if(callback){callback()}})};CharacterPlayerSoldier.prototype.finalizeModel=function(){var characterSize=this.characterSize;var modelWidth=characterSize;var modelDepth=characterSize;var bodyHeight=characterSize;var modelBody=this.modelBody;var modelHead=this.modelHead;if(modelBody){modelWidth=modelBody.getWidth();modelDepth=modelBody.getDepth();bodyHeight=modelBody.getHeight()}var modelHeight=bodyHeight;if(modelHead){var headHeight=modelHead.getHeight();modelHeight+=headHeight;modelBody.setPositionXYZ(0,-modelHeight*.5+bodyHeight*.5,0);modelHead.setPositionXYZ(0,modelBody.position[1]+bodyHeight*.5+headHeight*.5,0);if(modelHead.getWidth()>modelWidth){modelWidth=modelHead.getWidth()}}this.finalizeSize(modelWidth,modelDepth,modelHeight)};function CollideableFloor(scene,objectID){this.construct(scene,objectID)}ExtendPrototype(CollideableFloor,CCCollideable);CollideableFloor.prototype.construct=function(scene,objectID){this.CCCollideable_construct(objectID);this.primitive=new CCPrimitiveSquare;this.setModel(new CCModelBase);this.model.addPrimitive(this.primitive);this.setColour(new CCColour);if(scene){this.setScene(scene)}};CollideableFloor.prototype.update=function(delta){return this.CCObject_update(delta)};CollideableFloor.prototype.renderObject=function(camera,alpha){this.CCCollideable_renderObject(camera,alpha)};CollideableFloor.prototype.renderModel=function(alpha){this.CCCollideable_renderModel(alpha)};CollideableFloor.prototype.shouldCollide=function(collideWith,initialCall){return this.CCCollideable_shouldCollide(collideWith,initialCall)};CollideableFloor.prototype.recieveCollisionFrom=function(collisionSource,x,y,z){if(collisionSource.position[1]!==collisionSource.collisionBounds[1]){collisionSource.setPositionY(collisionSource.collisionBounds[1])}return null};CollideableFloor.prototype.setup=function(width,length,y){if(!y){y=0}this.setCollisionBounds(width,CC_SMALLFLOAT,length);var collisionBounds=this.collisionBounds;this.setPositionY(y-collisionBounds[1]);this.primitive.setupUpFacing(width,length,-CC_SMALLFLOAT,true,1);CC.UpdateCollisions(this,false)};function CollideableParticle(life,speed){this.construct(life,speed)}ExtendPrototype(CollideableParticle,CCCollideable);CollideableParticle.prototype.construct=function(life,speed){if(!life){life=1}if(!speed){speed=50}this.CCCollideable_construct();this.life=life;this.speed=speed;this.setTransparent();this.setReadDepth(false);this.setWriteDepth(false);this.setDrawOrder(201)};CollideableParticle.prototype.update=function(delta){if(this.life<=0){this.deleteLater()}else{if(this.life<1){this.setColourAlpha(0,true)}this.life-=delta;this.CCCollideable_update(delta);this.translate(0,delta*this.speed,0)}return true};CollideableParticle.prototype.renderModel=function(alpha){if(alpha){this.CCCollideable_renderModel(alpha)}else{this.CCCollideable_renderModel(alpha)}};function CollideableWall(scene){this.construct(scene);this.collideableType=CC.AddFlag(this.collideableType,CC.collision_static)}ExtendPrototype(CollideableWall,CCCollideable);CollideableWall.prototype.setPositionXYZ=function(x,y,z){this.CCCollideable_setPositionXYZ(x,y,z);this.translate(this.offsetX,0,this.offsetZ)};CollideableWall.prototype.update=function(delta){return false};CollideableWall.prototype.renderObject=function(camera,alpha){this.CCCollideable_renderObject(camera,alpha)};CollideableWall.prototype.shouldCollide=function(collideWith,initialCall){return this.CCCollideable_shouldCollide(collideWith,initialCall)};CollideableWall.prototype.setup=function(scene,x,z,size,height){this.shouldRender=false;this.offsetX=x;this.offsetZ=z;var collisionSize=CC_SMALLFLOAT;if(x!==0){this.setCollisionBounds(collisionSize,height,size)}else{this.setCollisionBounds(size,height,collisionSize)}this.translate(x,this.collisionBounds[1],z);if(scene){this.setScene(scene)}};function MoveableBullet(inLife,inMovementSpeed,inDamage){this.construct(inLife,inMovementSpeed,inDamage)}ExtendPrototype(MoveableBullet,CCMoveable);MoveableBullet.prototype.construct=function(inLife,inMovementSpeed,inDamage){this.CCMoveable_construct();if(!inLife){inLife=1}if(!inMovementSpeed){inMovementSpeed=200}if(!inDamage){inDamage=5}this.gravity=false;this.life=inLife;this.movementSpeed=inMovementSpeed;this.damage=inDamage};MoveableBullet.prototype.destruct=function(){this.CCMoveable_destruct()};MoveableBullet.prototype.update=function(delta){if(this.life<=0){if(this.onEndLife){this.onEndLife()}else{this.deleteLater()}}else{this.life-=delta;this.CCMoveable_update(delta)}return true};MoveableBullet.prototype.applyVelocity=function(delta,movementMagnitude){var velocity=this.velocity;var velocityX=velocity[0]*delta;var velocityZ=velocity[2]*delta;var position=this.position;var startPosition=CCMoveable.HorizontalVelocityStartPosition;vec3.copy(startPosition,position);position[0]+=velocityX;position[2]+=velocityZ;var self=this;var collisionFlags=CC.collision_static|CC.collision_moveable;CC.MovementCollisionCheckAsync(this,startPosition,position,collisionFlags,true,function(collidedWidth){})};MoveableBullet.prototype.renderModel=function(alpha){if(alpha){this.CCMoveable_renderModel(alpha)}else{this.CCMoveable_renderModel(alpha)}};MoveableBullet.prototype.requestCollisionWith=function(collidedWith){if(this.attack(collidedWith)){return this.CCMoveable_requestCollisionWith(collidedWith)}return null};MoveableBullet.prototype.recieveCollisionFrom=function(collisionSource,x,y,z){if(this.life>0){if(this.attack(collisionSource)){return this.CCMoveable_recieveCollisionFrom(collisionSource,x,y,z)}}return null};MoveableBullet.prototype.reportAttack=function(attackedBy,attackType,force,damage,x,y,z){return false};MoveableBullet.prototype.attack=function(victim){if(victim.shouldRender){var velocity=this.velocity;if(victim.reportAttack(this.owner,"default",this.movementSpeed,this.damage,velocity[0],velocity[1],velocity[2])){}this.life=0;this.deactivate();return true}return false};function ObjectIndicator(parentObject,textureFile){this.construct(parentObject,textureFile)}ExtendPrototype(ObjectIndicator,CCObject);ObjectIndicator.prototype.construct=function(parentObject,textureFile){this.CCObject_construct();var model=this.setModel(new CCModelBase);var primitive=this.primitive=new CCPrimitiveSquare;primitive.setupUpFacing(1,1,0,true,1);model.addPrimitive(primitive);parentObject.addChild(this);this.setTransparent();this.setWriteDepth(false);this.setColourAlpha(.5);if(textureFile){primitive.setTexture(textureFile,true,false,false)}this.setWidth(parentObject.collisionSize.width)};ObjectIndicator.prototype.destruct=function(){this.CCObject_destruct()};ObjectIndicator.prototype.renderModel=function(alpha){if(this.colour.a>0){this.CCObject_renderModel(alpha)}};ObjectIndicator.prototype.setWidth=function(width){this.model.setScale(width)};function CollideableIndicator(parent,textureFile){if(parent.inScene){this.construct(parent.inScene,textureFile);parent.ownObject(this);this.setWidth(parent.collisionSize.width)}else{this.construct(parent,textureFile)}}ExtendPrototype(CollideableIndicator,CCCollideable);CollideableIndicator.prototype.construct=function(parentScene,textureFile){this.CCCollideable_construct();var model=this.setModel(new CCModelBase);var primitive=this.primitive=new CCPrimitiveSquare;primitive.setupUpFacing(1,1,0,true,1);model.addPrimitive(primitive);this.setScene(parentScene);this.collideableType=CC.collision_none;this.setReadDepth(false);this.setWriteDepth(false);this.setDrawOrder(98);this.setColourAlpha(.5);if(textureFile){primitive.setTexture(textureFile,true,false,false)}};CollideableIndicator.prototype.destruct=function(){this.CCCollideable_destruct()};CollideableIndicator.prototype.setPositionXYZ=function(x,y,z){this.CCCollideable_setPositionXYZ(x,1,z);this.updateCollisions=true;CC.UpdateCollisions(this,false)};CollideableIndicator.prototype.translate=function(x,y,z){this.CCCollideable_translate(x,y,z);this.updateCollisions=true;CC.UpdateCollisions(this,false)};CollideableIndicator.prototype.renderModel=function(alpha){if(!alpha&&this.colour.a>0){gRenderer.CCSetBlend(true);this.CCCollideable_renderModel(alpha);gRenderer.CCSetBlend(false)}};CollideableIndicator.prototype.removeOwner=function(currentOwner){this.CCCollideable_removeOwner(currentOwner);this.deleteLater()};CollideableIndicator.prototype.setWidth=function(width){this.setSquareCollisionBounds(width);CC.UpdateCollisions(this,false);this.model.setScale(width)};function PickupBase(name,type,pickupID){this.construct(name,type,pickupID)}ExtendPrototype(PickupBase,CCCollideable);PickupBase.prototype.construct=function(name,type,pickupID){this.CCCollideable_construct(pickupID);this.collideableType=CC.AddFlag(this.collideableType,CC.collision_static);this.name=name;this.type=type;this.model3d=null;this.setColour(gColour.white())};PickupBase.prototype.update=function(delta){if(this.model){this.model.rotateY(delta*-90)}return false};PickupBase.prototype.renderModel=function(alpha){this.CCCollideable_renderModel(alpha)};PickupBase.prototype.shouldCollide=function(collideWith,initialCall){return this.CCCollideable_shouldCollide(collideWith,initialCall)};PickupBase.prototype.recieveCollisionFrom=function(collisionSource,x,y,z){return this.CCCollideable_recieveCollisionFrom(collisionSource,x,y,z)};PickupBase.prototype.setup=function(modelFile,textureFile){var self=this;CCModel3D.CacheModel(modelFile,true,function(model3d){if(model3d){var model=self.setModel(new CCModelBase);self.model3d=model3d;model3d.setTexture(textureFile);model.addModel(model3d);var modelWidth=Math.max(model3d.getWidth(),model3d.getDepth());var modelHeight=model3d.getHeight();{var modelSize=modelHeight>modelWidth?modelHeight:modelWidth;var scaleFactor=10/modelSize;model.setScale(scaleFactor);modelWidth*=scaleFactor;modelHeight*=scaleFactor}self.setSquareCollisionBounds(modelWidth,modelHeight);self.setPositionY(self.collisionBounds[1]);self.setRotationY(180)}})};PickupBase.prototype.getName=function(){return this.name};PickupBase.prototype.getType=function(){return this.type};function WeaponBase(character){this.construct(character)}ExtendPrototype(WeaponBase,CCObject);WeaponBase.prototype.construct=function(character){this.CCObject_construct();this.spawnPoint=vec3.create();this.character=character;this.bulletLife=5;this.bulletSpeed=200;this.fireRate=.1;this.shootingTimer=0;this.timeSinceLastShot=0;this.timeToReady=0;this.maxAmmo=1;this.ammo=1;this.bulletTax=.05;this.chargeRate=.1};WeaponBase.prototype.destruct=function(){this.CCObject_destruct()};WeaponBase.prototype.setup=function(weaponObj,recoil,muzzleFlash){if(weaponObj){if(recoil===undefined){recoil=true}if(muzzleFlash===undefined){muzzleFlash=true}this.setupSpawnPoint(weaponObj);if(recoil){this.setModel(new CCModelBase);this.setColour(new CCColour);this.modelWeaponHomePosition=vec3.create();vec3.copy(this.modelWeaponHomePosition,weaponObj.position);this.modelWeaponMovementInterpolator=new CCInterpolatorV3(CCInterpolatorSin2Curve);this.modelWeaponMovementInterpolator.setup(weaponObj.position,this.modelWeaponHomePosition);this.modelWeaponMovementInterpolator.setDuration(.05125)}if(muzzleFlash){var objFile="fx_weapon_muzzleflash.obj";var texFile="fx_weapon_muzzleflash_texture.png";var objectMuzzleFlash=this.objectMuzzleFlash=new CCObject;objectMuzzleFlash.setModel(new CCModelBase);objectMuzzleFlash.setColour(new CCColour);objectMuzzleFlash.setTransparent();objectMuzzleFlash.setWriteDepth(false);objectMuzzleFlash.setCulling(false);this.addChild(objectMuzzleFlash);var self=this;CCModel3D.CacheModel(objFile,true,function(model3d){if(model3d){self.modelMuzzleFlash=model3d;model3d.setTexture(texFile);model3d.setPosition(self.spawnPoint);model3d.translate(0,0,model3d.getDepth()*.5);objectMuzzleFlash.model.addModel(model3d)}})}}this.character.addChild(this)};WeaponBase.prototype.setupSpawnPoint=function(weaponObj){if(weaponObj&&this.modelWeapon!==weaponObj){this.modelWeapon=weaponObj;if(weaponObj.getDepth){var x=weaponObj.position[0];var y=weaponObj.position[1];var z=weaponObj.position[2];var scale=this.character.model3DBase.scale;var weaponDepth=weaponObj.getDepth();var weaponDepthMinMax=weaponObj.getPrimitive().getZMinMax();var self=this;weaponObj.getPrimitive().getYMinMaxAtZ(weaponDepthMinMax.max*.9,function(weaponHeightMinMaxAtPoint){var centerPointY=weaponHeightMinMaxAtPoint.min+weaponHeightMinMaxAtPoint.size()*.5;y+=centerPointY;if(scale){x*=scale[0];y*=scale[1];z*=scale[2];weaponDepth*=scale[2]}z+=weaponDepth*.5;self.spawnPoint=vec3.copy(self.spawnPoint,[x,y,z]);if(self.modelMuzzleFlash){self.modelMuzzleFlash.setPosition(self.spawnPoint)
}})}}};WeaponBase.prototype.setTimeToReady=function(time){this.timeToReady=time};WeaponBase.prototype.isReady=function(){if(this.timeToReady<=0){if(this.timeSinceLastShot>this.fireRate){return true}}return false};WeaponBase.BulletsCache=[];WeaponBase.NewBullet=function(life,speed,damage,visible){var BulletsCache=WeaponBase.BulletsCache;if(visible===undefined){visible=true}var bullet;if(BulletsCache.length>0){bullet=BulletsCache.safePop();bullet.life=life;if(speed){bullet.movementSpeed=speed}if(damage){bullet.damage=damage}bullet.shouldRender=visible}else{bullet=new MoveableBullet(life,speed,damage);bullet.setSquareCollisionBounds(5);bullet.setTransparent();var path="fx_weapon_bullet";var texPath;{var objPath=path;objPath+=".obj";texPath=path;texPath+="_diffuse.jpg";CCModel3D.CacheModel(objPath,true,function(model3d){model3d.setTexture(texPath);bullet.setModel(model3d)});bullet.movementDirection[2]=1}{texPath=path;texPath+="_glow_texture.png";var objectIndicator=new ObjectIndicator(bullet,texPath);objectIndicator.setScale([5,1,5]);objectIndicator.translate(0,1,0)}bullet.onEndLife=function(){BulletsCache.add(bullet);bullet.removeFromScene()};bullet.shouldRender=visible}return bullet};WeaponBase.prototype.shootWeapon=function(characterRotation){if(!this.hasEnoughAmmo()){return false}if(!this.isReady()){return false}this.ammo-=this.bulletTax;var modelWeaponMovementInterpolator=this.modelWeaponMovementInterpolator;if(modelWeaponMovementInterpolator){if(!modelWeaponMovementInterpolator.updating){var modelWeaponHomePosition=this.modelWeaponHomePosition;var modelWeapon=this.modelWeapon;modelWeaponMovementInterpolator.setup(modelWeapon.position,vec3.clone([modelWeaponHomePosition[0],modelWeaponHomePosition[1],modelWeaponHomePosition[2]+1]),function(){modelWeaponMovementInterpolator.setup(modelWeapon.position,modelWeaponHomePosition)})}}var bullet=WeaponBase.NewBullet(this.bulletLife,this.bulletSpeed,this.bulletDamage,this.bulletVisible);bullet.setScene(this.character.inScene);this.character.ownObject(bullet);this.setBulletSpawnPoint(bullet,characterRotation);this.shoot();this.timeSinceLastShot=0;return true};WeaponBase.prototype.setBulletSpawnPoint=function(projectile,characterRotation){var spawnPointXZ=new CCPoint(this.spawnPoint[0],this.spawnPoint[2]);CC.RotatePoint(spawnPointXZ,characterRotation);var spawnPoint=vec3.create();vec3.copy(spawnPoint,this.parent.position);spawnPoint[0]+=spawnPointXZ.x;spawnPoint[1]+=this.spawnPoint[1];spawnPoint[2]+=spawnPointXZ.y;if(spawnPoint[1]<projectile.collisionBounds[1]){spawnPoint[1]=projectile.collisionBounds[1]+.1}projectile.setPosition(spawnPoint);projectile.rotation[1]=characterRotation};WeaponBase.prototype.updateParentRotation=function(rotation){if(this.model){this.model.setRotationY(rotation);if(this.objectMuzzleFlash){this.objectMuzzleFlash.setRotationY(rotation)}}};WeaponBase.prototype.update=function(delta){var updated=this.CCObject_update(delta);var modelWeaponMovementInterpolator=this.modelWeaponMovementInterpolator;if(modelWeaponMovementInterpolator){if(modelWeaponMovementInterpolator.updating){if(modelWeaponMovementInterpolator.update(delta)){this.modelWeapon.dirtyModelMatrix();updated=true}}}var objectMuzzleFlash=this.objectMuzzleFlash;if(objectMuzzleFlash){if(objectMuzzleFlash.shouldRender){if(this.shootingTimer!==0){this.shootingTimer=CC.ToTarget(this.shootingTimer,0,delta);if(objectMuzzleFlash){if(this.modelMuzzleFlash){this.modelMuzzleFlash.rotateZ(delta*360)}}}else{objectMuzzleFlash.shouldRender=false}}}this.timeSinceLastShot+=delta;if(this.timeToReady>0){this.timeToReady-=delta}return updated};WeaponBase.prototype.updateCharge=function(delta){if(this.ammo<this.maxAmmo){this.addAmmo(delta*this.chargeRate);return true}return false};WeaponBase.prototype.renderObject=function(camera,alpha){this.CCObject_renderObject(camera,alpha)};WeaponBase.prototype.renderModel=function(alpha){this.CCObject_renderModel(alpha)};WeaponBase.prototype.shoot=function(){this.shootingTimer=.025;if(this.objectMuzzleFlash){this.objectMuzzleFlash.shouldRender=true}};WeaponBase.prototype.getTimeSinceLastShot=function(){return this.timeSinceLastShot};WeaponBase.prototype.setFireRate=function(rate){this.fireRate=rate};WeaponBase.prototype.setupBullet=function(life,speed,visible){if(life){this.bulletLife=life}if(speed){this.bulletSpeed=speed}if(visible!==undefined){this.bulletVisible=visible}};WeaponBase.prototype.setMaxAmmo=function(amount){this.maxAmmo=amount;this.ammo=amount};WeaponBase.prototype.addAmmo=function(amount){this.ammo+=amount;this.ammo=CC.FloatClamp(this.ammo,0,this.maxAmmo)};WeaponBase.prototype.hasEnoughAmmo=function(){return this.ammo>this.bulletTax};WeaponBase.prototype.getAmmo=function(){return this.ammo};WeaponBase.prototype.getMaxAmmo=function(){return this.maxAmmo};WeaponBase.prototype.setBulletTax=function(tax){this.bulletTax=tax};WeaponBase.prototype.setBulletDamage=function(damage){this.bulletDamage=damage};WeaponBase.prototype.setChargeRate=function(rate){this.chargeRate=rate};function SceneManagerPlay(){this.construct()}ExtendPrototype(SceneManagerPlay,CCSceneAppUI);var sceneManagerPlay;SceneManagerPlay.prototype.construct=function(){sceneManagerPlay=this;MultiplayerManager.UpdateCallbacks.addOnce(this);this.CCSceneAppUI_construct();this.cameraCentered=true;this.map=null;this.tileNotifications=undefined};SceneManagerPlay.prototype.destruct=function(){if(sceneManagerPlay===this){sceneManagerPlay=null}if(this.map){this.map.destruct()}this.CCSceneAppUI_destruct()};SceneManagerPlay.prototype.setup=function(){var self=this;if(!this.camera){var camera=gEngine.newSceneCamera(this);camera.setupViewport(0,0,1,1);camera.useSceneCollideables(this)}this.CCSceneAppUI_setup();if(MultiplayerManager.LoggedIn){this.syncLoggedIn()}};SceneManagerPlay.prototype.touchPressed=function(touch){return this.CCSceneAppUI_touchPressed(touch)};SceneManagerPlay.prototype.touchMoving=function(touch,touchDelta){return false};SceneManagerPlay.prototype.touchReleased=function(touch,touchAction){return this.CCSceneAppUI_touchReleased(touch,touchAction)};SceneManagerPlay.prototype.syncDisconnected=function(){};SceneManagerPlay.prototype.syncLoggedIn=function(){this.setupPushNotifications()};SceneManagerPlay.prototype.syncUpdate=function(jsonData){if(jsonData.js){eval(jsonData.js)}else{var map=this.map;if(map){if(jsonData.addPlayer){if(map.getMapType()==="1vs1"){if(map.getNumberOfPlayers()>=2){if(this.tileNotifications){this.tileNotifications.setText("")}}}else if(map.getMapType()==="BattleRoyale"){players=map.getNumberOfHumanPlayers();text="- ";text+=players;text+=" -";if(this.tileNotifications){this.tileNotifications.setText(text)}}}else if(jsonData.removePlayer){if(map.getMapType()==="BattleRoyale"){var players=map.getNumberOfHumanPlayers();text="- ";text+=players;text+=" -";if(this.tileNotifications){this.tileNotifications.setText(text)}}}}}};SceneManagerPlay.prototype.setupPushNotifications=function(){};SceneManagerPlay.prototype.getPlayerTypeInfo=function(playerType){var playerTypes=this.playerTypes;for(var i=0;i<playerTypes.length;++i){var playerTypeInfo=playerTypes[i];if(playerTypeInfo.type===playerType){return playerTypeInfo}}return this.playerTypes[0]};SceneManagerPlay.prototype.spawnCharacter=function(type,onLoadedCallback){var playerTypes=this.playerTypes;if(playerTypes){for(var i=0;i<playerTypes.length;++i){var playerType=playerTypes[i];if(type===playerType.type){return CharacterPlayer.Spawn(type,playerType.obj,playerType.tex,playerType.speed,playerType.size,onLoadedCallback)}}}return CharacterPlayerAndroid.Spawn("iBot",onLoadedCallback)};SceneManagerPlay.SpawnCharacter=function(type,onLoadedCallback){if(type.startsWith("model.")){return CharacterPlayerModel.Spawn(type,onLoadedCallback)}if(type.startsWith("character.")){return CharacterPlayerPrefab.Spawn(type,onLoadedCallback)}if(type.contains("burger")||type.contains("fries")){return CharacterPlayerBurger.Spawn(type,onLoadedCallback)}else if(type.contains("androBot")||type.contains("iBot")||type.contains("winBot")){return CharacterPlayerAndroid.Spawn(type,onLoadedCallback)}else if(type.contains("webBot")){return CharacterPlayerWeb.Spawn(type,onLoadedCallback)}else if(type.contains("soldier")||type.contains("miniche")){return CharacterPlayerSoldier.Spawn(type,onLoadedCallback)}else if(type.contains("tank")){return CharacterPlayerTank.Spawn(type,onLoadedCallback)}return sceneManagerPlay.spawnCharacter(type,onLoadedCallback)};function SceneManagerGame(){this.construct()}ExtendPrototype(SceneManagerGame,SceneManagerPlay);var sceneManagerGame;SceneManagerGame.DefaultPlayerTypes=[{type:"iBot",icon:"iBot_icon.png",obj:"iBot_body.obj",tex:"iBot_diffuse.jpg"},{type:"winBot",icon:"androBot_icon.png",obj:"winBot_body.obj",tex:"winBot_diffuse.jpg"}];SceneManagerGame.HelpImage="phonewars_helpscreen.jpg";SceneManagerGame.prototype.construct=function(){sceneManagerGame=this;this.SceneManagerPlay_construct();var appInfoString=CC.LoadData("appInfos");if(appInfoString){var appInfos=JSON.parse(appInfoString);if(appInfos){for(var i=0;i<appInfos.length;++i){var appInfo=appInfos[i];if(appInfo.id===APP_ID){this.updateAppInfo(appInfo);break}}}}if(!this.playerTypes||this.playerTypes.length===0){this.playerTypes=SceneManagerGame.DefaultPlayerTypes}if(this.playerTypes.length<2){this.playerTypes.push(SceneManagerGame.DefaultPlayerTypes[1])}if(!this.playerType){this.playerType=this.playerTypes[0].type}SceneManagerPlay.SpawnCharacter(this.playerType,function(player){player.noScene=true;player.destruct()});{this.sceneBackground=new SceneBackground;gEngine.addScene(this.sceneBackground);this.sceneSplashScreen=new SceneSplashScreen;gEngine.addScene(this.sceneSplashScreen);this.scenePlayScreen=new ScenePlayScreen;gEngine.addScene(this.scenePlayScreen);this.sceneLeaderboards=new SceneLeaderboards;gEngine.addScene(this.sceneLeaderboards);this.sceneMultiLauncher=new SceneMultiUILauncher(this)}this.waitingForOpponent=false;this.waitingForOpponentStartedTimer=false;this.registeredPushNotification=false;this.tileFlag=null;gEngine.textureManager.getTextureHandle(SceneManagerGame.HelpImage);gEngine.textureManager.getTextureHandle(SceneGameMap.DefaultMapImage)};SceneManagerGame.GameState_SplashScreen=0;SceneManagerGame.GameState_CharacterSelectScreen=1;SceneManagerGame.GameState_ReadyToPlay1vs1=2;SceneManagerGame.GameState_ReadyToPlayBattleRoyale=3;SceneManagerGame.GameState_Playing1vs1=4;SceneManagerGame.GameState_PlayingBattleRoyale=5;SceneManagerGame.GameState_Leaderboards=6;SceneManagerGame.prototype.destruct=function(){if(sceneManagerGame===this){sceneManagerGame=null}{if(this.sceneLeaderboards){this.sceneLeaderboards.destruct()}if(this.scenePlayScreen){this.scenePlayScreen.destruct()}if(this.sceneSplashScreen){this.sceneSplashScreen.destruct()}if(this.sceneBackground){this.sceneBackground.destruct()}}this.SceneManagerPlay_destruct()};SceneManagerGame.prototype.setup=function(){var self=this;this.SceneManagerPlay_setup();var camera=this.camera;camera.setCameraWidth(SceneBackground.SceneWidth);var tile;{tile=new CCTile3DButton(this);tile.setupText(" ",camera.targetHeight*.0725,true,false);tile.setDrawOrder(205);tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setTextBlinking(true);this.tileNotifications=tile;this.tileNotifications.setText("tap to start")}this.tileTitleMessages=[];{tile=new CCTile3DButton(this);tile.setupText("",camera.targetHeight*.06,true,false);tile.setDrawOrder(205);tile.setTextColour(1);this.tileTitleMessages.add(tile)}{tile=new CCTile3DButton(this);tile.setupText("",camera.targetHeight*.05,true,false);tile.setDrawOrder(205);tile.setTextColour(1);this.tileTitleMessages.add(tile)}{tile=new CCTile3DButton(this);tile.setupText("",camera.targetHeight*.05,true,false);tile.setDrawOrder(205);tile.setTextColour(1);this.tilePlayerStatus=tile}{tile=new CCTile3DButton(this);tile.setupTexturedWidth(camera.targetWidth*.085,"ui_back.png");tile.setColourAlpha(0);tile.setDrawOrder(205);this.tileBack=tile;this.addTile(tile);tile.onRelease.push(function(){self.handleBackButton()});this.resizeCallbacks.push(function(){tile=self.tileBack;tile.setPositionXYZ(camera.targetWidth*.5-tile.collisionBounds[0],camera.targetHeight*.5-tile.collisionBounds[1],0)});this.hideBack()}this.createFlag();this.gotoSplashScreenGameState()};SceneManagerGame.prototype.resize=function(){this.SceneManagerPlay_resize();var camera=this.camera;if(this.tileNotifications){var idealAspectRatio=1.5;var aspectRatioAdjutment=camera.getAspectRatio()<1.25?camera.getAspectRatio()/idealAspectRatio:1;var tile;{this.tileNotifications.setTextHeight(camera.targetHeight*.08*aspectRatioAdjutment,true);{tile=this.tileTitleMessages[0];tile.setTextHeight(camera.targetHeight*.06*aspectRatioAdjutment,true);tile.setPositionXYZ(-(camera.targetWidth*.5)+tile.collisionBounds[0],+(camera.targetHeight*.5)-tile.collisionBounds[1],0)}{tile=this.tileTitleMessages[1];tile.setTextHeight(camera.targetHeight*.06*aspectRatioAdjutment,true);tile.positionTileBelow(this.tileTitleMessages[0]);tile.setPositionX(-(camera.targetWidth*.5)+tile.collisionBounds[0])}{tile=this.tilePlayerStatus;tile.setTextHeight(camera.targetHeight*.05*aspectRatioAdjutment,true);tile.positionTileBelow(this.tileTitleMessages[1]);tile.setPositionX(-(camera.targetWidth*.5)+tile.collisionBounds[0])}}{tile=this.tileNotifications;var gameState=this.gameState;if(gameState===SceneManagerGame.GameState_CharacterSelectScreen||gameState===SceneManagerGame.GameState_ReadyToPlay1vs1||gameState===SceneManagerGame.GameState_ReadyToPlayBattleRoyale){tile.setPositionX(-camera.targetWidth*.2*.5)}else{tile.setPositionX(0)}tile.setPositionY(-camera.cameraHHeight+tile.collisionBounds[1])}if(this.tileFlag){tile=this.tileFlag;if(tile.getTileTextureImage()){tile.setTileTexturedHeight(camera.cameraHeight*.05*aspectRatioAdjutment)}tile.setPositionXYZ(camera.targetWidth*.5-tile.collisionBounds[0],camera.targetHeight*.5-tile.collisionBounds[1],0)}}};SceneManagerGame.prototype.handleBackButton=function(){if(this.gameState===SceneManagerGame.GameState_CharacterSelectScreen||this.gameState===SceneManagerGame.GameState_ReadyToPlay1vs1||this.gameState===SceneManagerGame.GameState_ReadyToPlayBattleRoyale){this.gotoSplashScreenGameState();return true}if(this.gameState===SceneManagerGame.GameState_Leaderboards){this.exitLeaderboardsState();return true}return false};SceneManagerGame.prototype.render=function(camera,pass,alpha){};SceneManagerGame.prototype.touchPressed=function(touch){return this.SceneManagerPlay_touchPressed(touch)};SceneManagerGame.prototype.touchMoving=function(touch,touchDelta){return false};SceneManagerGame.prototype.touchReleased=function(touch,touchAction){return this.SceneManagerPlay_touchReleased(touch,touchAction)};SceneManagerGame.prototype.updateAppInfo=function(appInfo){var facebookID=appInfo.facebookID;if(facebookID){CCAPIFacebook.APP_ID=facebookID}var backgroundImage=appInfo.backgroundImage;if(backgroundImage){SceneBackground.BackgroundImage=backgroundImage;if(this.sceneBackground){this.sceneBackground.refreshBackgroundImage()}}if(appInfo.helpImage){SceneManagerGame.HelpImage=appInfo.helpImage;gEngine.textureManager.getTextureHandle(SceneManagerGame.HelpImage)}if(appInfo.defaultMapImage){SceneGameMap.DefaultMapImage=appInfo.defaultMapImage;gEngine.textureManager.getTextureHandle(SceneGameMap.DefaultMapImage)}var i;var playerTypes=appInfo.playerTypes;if(playerTypes&&playerTypes.length>=2){this.playerTypes=playerTypes;{var playerTypeFound=false;if(this.playerType){for(i=0;i<playerTypes.length;++i){var playerTypeInfo=playerTypes[i];if(playerTypeInfo.type===this.playerType){playerTypeFound=true;break}}}if(!playerTypeFound){this.playerType=this.playerTypes[0].type;if(!this.map){if(this.gameState===SceneManagerGame.GameState_CharacterSelectScreen){this.scenePlayScreen.showPlayerView(this.playerType)}}}}}if(this.gameState===SceneManagerGame.GameState_SplashScreen){this.showSplashScreen()}};SceneManagerGame.prototype.showSplashScreen=function(){this.scenePlayScreen.hide();this.sceneBackground.show();var playerTypes=this.playerTypes;this.sceneSplashScreen.show(playerTypes[0].type,null,playerTypes[1].type,null)};SceneManagerGame.prototype.hideSplashScreen=function(){this.sceneSplashScreen.hide()};SceneManagerGame.prototype.showPlayer1=function(character){var sceneSplashScreen=this.sceneSplashScreen;var sceneLeaderboards=this.sceneLeaderboards;if(sceneSplashScreen.isShowingPlayer2()){this.hideSplashScreen()}if(!sceneSplashScreen.isShowingPlayer1()){var countryCode=sceneLeaderboards.getPlayerCountryCode(character.getUserID());sceneSplashScreen.showPlayer1(character.getType(),countryCode,.5);var tileStripe=sceneSplashScreen.getPlayer1Stripe();tileStripe.setColourAlpha(.25,true);var tileScore=sceneSplashScreen.getPlayer1Score();var userInfo=sceneLeaderboards.getUserIDData(SceneLeaderboards.Leaderboard_AllTime,character.getUserID());if(userInfo){var winRatio="";winRatio+=userInfo.wins;winRatio+=" / ";winRatio+=userInfo.losses;tileScore.setText(winRatio,false);tileScore.setTextColourAlpha(1,true)}}};SceneManagerGame.prototype.showPlayer2=function(character){var sceneSplashScreen=this.sceneSplashScreen;var sceneLeaderboards=this.sceneLeaderboards;if(sceneSplashScreen.isShowingPlayer1()){this.hideSplashScreen()}if(!sceneSplashScreen.isShowingPlayer2()){var countryCode=sceneLeaderboards.getPlayerCountryCode(character.getUserID());sceneSplashScreen.showPlayer2(character.getType(),countryCode,.5);var tileStripe=sceneSplashScreen.getPlayer2Stripe();tileStripe.setColourAlpha(.25,true);var tileScore=sceneSplashScreen.getPlayer2Score();var userInfo=sceneLeaderboards.getUserIDData(SceneLeaderboards.Leaderboard_AllTime,character.getUserID());if(userInfo){var winRatio="";winRatio+=userInfo.wins;winRatio+=" / ";winRatio+=userInfo.losses;tileScore.setText(winRatio,false);tileScore.setTextColourAlpha(1,true)}}};SceneManagerGame.prototype.backgroundTilePressed=function(){if(this.gameState===SceneManagerGame.GameState_SplashScreen){this.gotoCharacterSelectScreenState()}else if(this.gameState===SceneManagerGame.GameState_Leaderboards){this.gameState=SceneManagerGame.GameState_Leaderboards}};SceneManagerGame.prototype.exitLeaderboardsState=function(){if(this.gameState===SceneManagerGame.GameState_Leaderboards){this.hideBack();this.sceneLeaderboards.hide();this.gotoCharacterSelectScreenState()}};SceneManagerGame.prototype.gotoSplashScreenGameState=function(){CCEngine.DisableBackButton(this);this.setGameState(SceneManagerGame.GameState_SplashScreen);if(!this.waitingForOpponent){this.tileNotifications.setText("tap to start")}this.showSplashScreen();this.showFlag();if(this.sceneMultiLauncher){this.sceneMultiLauncher.show()}};SceneManagerGame.prototype.gotoCharacterSelectScreenState=function(){if(this.gameState!==SceneManagerGame.GameState_CharacterSelectScreen){CCEngine.EnableBackButton(this);this.sceneBackground.show();this.timers.length=0;this.showFlag();this.tileNotifications.setText("connecting");this.setGameState(SceneManagerGame.GameState_CharacterSelectScreen);this.updatedGameState();if(MultiplayerManager.LoggedIn){if(this.waitingForOpponent){this.readyToPlay1vs1()}}this.hideSplashScreen();this.scenePlayScreen.show(this.playerType);if(this.sceneMultiLauncher){this.sceneMultiLauncher.show()}}};SceneManagerGame.prototype.start1vs1=function(){if(this.gameState===SceneManagerGame.GameState_ReadyToPlayBattleRoyale){this.toggleWaitingForOpponent(false);this.timers.length=0;this.tileNotifications.setText("connecting");this.setGameState(SceneManagerGame.GameState_CharacterSelectScreen);this.updatedGameState()}if(this.gameState===SceneManagerGame.GameState_CharacterSelectScreen){if(this.isUsablePlayer()){this.tileNotifications.setText("connecting");if(MultiplayerManager.LoggedIn){this.readyToPlay1vs1();return true}}}else if(this.gameState===SceneManagerGame.GameState_ReadyToPlay1vs1||this.gameState===SceneManagerGame.GameState_ReadyToPlayBattleRoyale){this.toggleWaitingForOpponent(false);this.timers.length=0;this.tileNotifications.setText("connecting");this.setGameState(SceneManagerGame.GameState_CharacterSelectScreen);this.updatedGameState()}return false};SceneManagerGame.prototype.startBattleRoyale=function(mapID){if(this.gameState===SceneManagerGame.GameState_ReadyToPlay1vs1){this.toggleWaitingForOpponent(false);this.timers.length=0;this.tileNotifications.setText("connecting");this.setGameState(SceneManagerGame.GameState_CharacterSelectScreen);this.updatedGameState()}if(this.gameState===SceneManagerGame.GameState_CharacterSelectScreen){if(this.isUsablePlayer()){this.tileNotifications.setText("connecting");if(MultiplayerManager.LoggedIn){this.readyToPlayBattleRoyale(mapID);return true}}}else if(this.gameState===SceneManagerGame.GameState_ReadyToPlay1vs1||this.gameState===SceneManagerGame.GameState_ReadyToPlayBattleRoyale){this.toggleWaitingForOpponent(false);this.timers.length=0;this.tileNotifications.setText("connecting");this.setGameState(SceneManagerGame.GameState_CharacterSelectScreen);this.updatedGameState()}return false};SceneManagerGame.prototype.setGameState=function(state){if(this.gameState!==state){this.gameState=state;this.requestResize()}};SceneManagerGame.prototype.toggleWaitingForOpponent=function(toggle){if(this.waitingForOpponent!==toggle){this.waitingForOpponent=toggle;if(!this.waitingForOpponent){if(MultiplayerManager.LoggedIn){BurgersClient.unregisterPlayer()}if(this.gameState===SceneManagerGame.GameState_ReadyToPlay1vs1){this.tileNotifications.setText("connecting");this.setGameState(SceneManagerGame.GameState_CharacterSelectScreen);this.updatedGameState()}}}if(this.waitingForOpponentStartedTimer){this.waitingForOpponentStartedTimer=false}};SceneManagerGame.prototype.syncDisconnected=function(){if(this.gameState>=SceneManagerGame.GameState_CharacterSelectScreen&&this.gameState<=SceneManagerGame.GameState_PlayingBattleRoyale){this.tileNotifications.setText("connecting")}this.SceneManagerPlay_syncDisconnected()};SceneManagerGame.prototype.syncLoggedIn=function(){this.SceneManagerPlay_syncLoggedIn();var guestName="Guest ";guestName+=MultiplayerManager.UserID;guestName=guestName.strip(".");this.scenePlayScreen.setPlayerID(guestName);var leaderboard=this.sceneLeaderboards.leaderboardsData[this.sceneLeaderboards.currentLeaderboardType];if(leaderboard.length===0){this.sceneLeaderboards.requestLeaderboard()}this.updatedGameState()};SceneManagerGame.prototype.updatedGameState=function(){if(MultiplayerManager.LoggedIn){var map=this.map;if(map){if(map.isOnlineGame()){map.deleteLater();this.map=null;this.hideSplashScreen();this.gotoSplashScreenGameState()}else{this.tileNotifications.setText("")}}else{if(this.gameState===SceneManagerGame.GameState_SplashScreen){}else{if(this.gameState===SceneManagerGame.GameState_ReadyToPlay1vs1||this.gameState===SceneManagerGame.GameState_ReadyToPlayBattleRoyale){this.setGameState(SceneManagerGame.GameState_CharacterSelectScreen)}if(this.gameState===SceneManagerGame.GameState_CharacterSelectScreen){this.tileNotifications.setText("select game mode")}}}}};SceneManagerGame.prototype.readyToPlay1vs1=function(){this.toggleWaitingForOpponent(true);if(!this.map){this.setGameState(SceneManagerGame.GameState_ReadyToPlay1vs1)}BurgersClient.registerPlayer(this.playerType,"1vs1")};SceneManagerGame.prototype.readyToPlayBattleRoyale=function(mapID){if(!this.map){this.setGameState(SceneManagerGame.GameState_ReadyToPlayBattleRoyale)}if(mapID){MultiplayerManager.RequestJoinMap(mapID,this.playerType)}else{BurgersClient.registerPlayer(this.playerType,"BattleRoyale")}};SceneManagerGame.prototype.displayGameTileMessages=function(broadcast){var messages=broadcast.messages;for(var i=0;i<messages.length;++i){var tile=this.tileTitleMessages[i];tile.setText(messages[i],true)}this.requestResize();if(this.waitingForOpponent){if(broadcast.queuePosition!==undefined){var broadcastQueuePosition=broadcast.queuePosition;var text="queueing to play ";text+=broadcastQueuePosition;this.tileNotifications.setText(text,true)}else{this.tileNotifications.setText("waiting for opponent",true)}}};SceneManagerGame.prototype.syncUpdate=function(jsonData){var map=this.map;var i,length,jsonPlayer;if(jsonData.appInfo){this.updateAppInfo(jsonData.appInfo)}else if(jsonData.gameTitleMessages){this.displayGameTileMessages(jsonData.gameTitleMessages)}else if(jsonData.status){this.tilePlayerStatus.setText(jsonData.status,true);this.requestResize()}else if(jsonData.loadGame){var mapType=jsonData.type;var newChallenger=this.gameState===SceneManagerGame.GameState_Playing1vs1;if(map){this.matchEnd(false)}var mapID=jsonData.loadGame;this.loadGame(mapID,mapType,jsonData);if(newChallenger){this.tileNotifications.setText("here comes a new challenger")}var jsonPlayers=jsonData.players;if(jsonPlayers){if(Array.isArray(jsonPlayers)){var playerIDs=new Array(2);var playerTypes=new Array(2);length=jsonPlayers.length;for(i=0;i<length;++i){jsonPlayer=jsonPlayers[i];if(jsonPlayer){playerIDs[i]=jsonPlayer.userID;playerTypes[i]=jsonPlayer.playerType;this.sceneLeaderboards.updateLeaderboardData(SceneLeaderboards.Leaderboard_AllTime,jsonPlayer)}}if(playerTypes[0]&&playerTypes[1]){this.sceneSplashScreen.hide();this.sceneSplashScreen.show(playerTypes[0],this.sceneLeaderboards.getPlayerCountryCode(playerIDs[0]),playerTypes[1],this.sceneLeaderboards.getPlayerCountryCode(playerIDs[1]))}}}}else if(jsonData.GameWon!==undefined){var result=jsonData.GameWon;if(result==="abandoned"){if(map){map.setOffline();this.spawnOfflineGame()}else{this.gotoSplashScreenGameState();this.gotoCharacterSelectScreenState()}this.readyToPlay1vs1()}else if(result==="draw"){this.matchResult(false)}else if(result){if(jsonData.disconnected){var playerDisconnectedID=jsonData.disconnected;if(map){var player=map.getPlayerFromID(MultiplayerManager.SessionID);var disconnectedPlayer=map.getPlayerFromID(playerDisconnectedID);if(player&&disconnectedPlayer&&player!==disconnectedPlayer){var aiController=new CharacterControllerAI(map.getPathFinderNetwork());disconnectedPlayer.setupAI(aiController);if(!map.gameStarted()){aiController.enable(false)}aiController.setWaypointCycle(CharacterControllerAI.cycle_randomConnections);aiController.setMovementMagnitude(.75);aiController.setEnemy(player);map.setMapID("");this.readyToPlay1vs1()}else{this.matchResult(true)}}}else{this.matchResult(true)}}else{this.matchResult(false)}}else if(jsonData.leaderboards){var leaderboardType=this.sceneLeaderboards.parseLeaderboardType(jsonData);var leaderboardsData=jsonData.leaderboards;if(Array.isArray(leaderboardsData)){length=leaderboardsData.length;for(i=0;i<length;++i){jsonPlayer=leaderboardsData[i];if(jsonPlayer){this.sceneLeaderboards.updateLeaderboardData(leaderboardType,jsonPlayer)}}if(this.gameState===SceneManagerGame.GameState_Leaderboards){this.sceneLeaderboards.show()}}}else if(jsonData.userInfo){jsonPlayer=jsonData.userInfo;if(jsonPlayer){this.sceneLeaderboards.updateLeaderboardData(SceneLeaderboards.Leaderboard_AllTime,jsonPlayer)}}this.SceneManagerPlay_syncUpdate(jsonData)};SceneManagerGame.prototype.loadGame=function(mapID,mapType,jsonData){var self=this;if(this.sceneMultiLauncher){this.sceneMultiLauncher.hide()}if(mapID){if(this.waitingForOpponent){this.toggleWaitingForOpponent(false)}}if(!this.waitingForOpponent){this.tileNotifications.setText("loading")}var timers=this.timers;timers.length=0;this.showSplashScreen();this.setGameState(SceneManagerGame.GameState_Playing1vs1);this.hideFlag();var timer=new CCTimer;timer.onTime.add(function(){self.hideSplashScreen();self.sceneBackground.hide();if(mapType==="1vs1"){self.loadedGame(new SceneGame1vs1(mapID))}else if(mapType==="BattleRoyale"){self.loadedGame(new SceneGameBattleRoyale(mapID))}if(jsonData){self.map.syncUpdate(jsonData)}});timer.start(2);timers.add(timer)};SceneManagerGame.prototype.loadedGame=function(map){var self=this;map.onBack=function(){self.toggleWaitingForOpponent(false);self.matchEnd(false)};this.map=map;map.setParent(this);if(!map.isOnlineGame()){this.spawnOfflineGame()}};SceneManagerGame.prototype.spawnOfflineGame=function(){var map=this.map;var i;{var sandbagLocations=[];sandbagLocations.add([0,0,0]);sandbagLocations.add([-50,0,-100]);sandbagLocations.add([50,0,-100]);sandbagLocations.add([-50,0,100]);sandbagLocations.add([50,0,100]);var objFile="barbedwire.obj";var texFile="barbedwire_diffuse.png";var sandbagWidth=30;for(i=0;i<sandbagLocations.length;++i){map.spawnStaticObject("sandbag"+i,objFile,texFile,null,sandbagWidth,90,sandbagLocations[i])}}this.spawnOfflinePlayers();var player1=map.getPlayerFromID(MultiplayerManager.SessionID);var player2=map.getPlayerFromID("player2");map.syncPlayerSetLocation(player1.getPlayerID(),vec3.clone([-50,player1.position[1],0]));map.syncPlayerSetLocation(player2.getPlayerID(),vec3.clone([50,player2.position[1],0]));for(i=0;i<4;++i){var pickup=map.spawnPickup("healthpack","health",null);var mapBounds=map.getMapBounds();var location=vec3.create();location[0]=mapBounds.width*.9*CC.FloatRandomDualSided();location[2]=mapBounds.height*.9*CC.FloatRandomDualSided();pickup.setPositionXZ(location[0],location[2]);map.adjustCollisionPlacement(pickup)}{var aiController=new CharacterControllerAI(map.getPathFinderNetwork());player2.setupAI(aiController);aiController.enable(false);aiController.setWaypointCycle(CharacterControllerAI.cycle_randomConnections);aiController.setMovementMagnitude(.5);aiController.setEnemy(player1)}map.syncPlayerHealth(player1.getPlayerID(),100,true);map.syncPlayerHealth(player2.getPlayerID(),100,true);if(map.getNumberOfPlayers()>=2){if(!this.waitingForOpponent){this.tileNotifications.setText("")}map.startIntro()}};SceneManagerGame.prototype.spawnOfflinePlayers=function(){var map=this.map;var player1=map.spawnCharacter(this.playerType,MultiplayerManager.SessionID,MultiplayerManager.UserID);map.assignPlayerCharacter(player1);var player2;if(this.playerType.contains(this.playerTypes[0].type)){player2=map.spawnCharacter(this.playerTypes[1].type,"player2")}else{player2=map.spawnCharacter(this.playerTypes[0].type,"player2")}map.addEnemy(player2)};SceneManagerGame.prototype.matchResult=function(won){if(this.map){if(won){this.map.startWinning()}else{this.map.startLosing()}}else{this.matchEnd(true)}};SceneManagerGame.prototype.matchEnd=function(showLeaderboards){this.hideSplashScreen();if(this.map){if(this.map.isOnlineGame()){this.sceneLeaderboards.dirtyLeaderboards()}this.map.deleteLater();this.map=null}if(showLeaderboards){this.showLeaderboards();if(this.waitingForOpponent){this.exitLeaderboardsState()}}else{this.gotoCharacterSelectScreenState()}};SceneManagerGame.prototype.startOfflineGame=function(){if(!this.map){this.loadGame(null,"1vs1",500);return true}return false};SceneManagerGame.prototype.isUsablePlayer=function(launchShop){if(launchShop===undefined){launchShop=true}var playerTypeInfo=this.getPlayerTypeInfo(this.playerType);if(playerTypeInfo){var playerItemCode;if(playerTypeInfo.type==="doubleburger"||playerTypeInfo.type==="doublefries"){playerItemCode="burgers_doubleweapons"}else if(playerTypeInfo.type==="miniche"||playerTypeInfo.type==="soldier"){playerItemCode="tanks_switchTeams"}if(playerItemCode){if(!SceneItemShop.HasPurchasedNonConsumable(playerItemCode)){if(launchShop){var self=this;new SceneItemShop("Get coins to unlock\nall game characters",playerItemCode,true,"unlock","unlock","unlock",function(type,itemCode,value){CC.SaveData("shop."+playerItemCode+".item");self.scenePlayScreen.showPlayerView(self.playerType)})}return false}}}return true};SceneManagerGame.prototype.switchTeams=function(direction){var playerTypeIndex=0;var playerTypes=this.playerTypes;for(var i=0;i<playerTypes.length;++i){if(this.playerType===playerTypes[i].type){playerTypeIndex=i;break}}if(direction>0){playerTypeIndex++;if(playerTypeIndex>=playerTypes.length){playerTypeIndex=0}}else if(direction<0){playerTypeIndex--;if(playerTypeIndex<0){playerTypeIndex=playerTypes.length-1}}this.playerType=playerTypes[playerTypeIndex].type;if(!this.map){this.setGameState(SceneManagerGame.GameState_CharacterSelectScreen);
if(MultiplayerManager.LoggedIn){if(this.waitingForOpponent){this.toggleWaitingForOpponent(false)}}this.updatedGameState();this.scenePlayScreen.showPlayerView(this.playerType)}};SceneManagerGame.prototype.showLeaderboards=function(){if(MultiplayerManager.LoggedIn){if(this.sceneMultiLauncher){this.sceneMultiLauncher.hide()}this.showBack();this.setGameState(SceneManagerGame.GameState_Leaderboards);this.hideFlag();this.scenePlayScreen.hide();this.sceneBackground.show();this.sceneLeaderboards.show();if(!this.waitingForOpponent){this.tileNotifications.setText("")}return true}return false};SceneManagerGame.prototype.showBack=function(){this.tileBack.setColourAlpha(1,true);this.tileBack.setCollideable(true)};SceneManagerGame.prototype.hideBack=function(){this.tileBack.setColourAlpha(0,true);this.tileBack.setCollideable(false)};SceneManagerGame.prototype.createFlag=function(){if(MultiplayerManager.geoLocationCountryCode){var file="flag_";file+=MultiplayerManager.geoLocationCountryCode;file+=".png";if(!this.tileFlag){var self=this;var camera=this.camera;var tile=new CCTile3DButton(this);tile.setupTextured(file,function(){self.requestResize();self.showFlag()});tile.tileScaleInterpolator.setDuration(.25);this.tileFlag=tile;return}}this.hideFlag()};SceneManagerGame.prototype.showFlag=function(){if(this.gameState!==SceneManagerGame.GameState_Playing1vs1&&this.gameState!==SceneManagerGame.GameState_PlayingBattleRoyale){if(this.tileFlag){this.tileFlag.setTileScale(0,false);this.tileFlag.setTileScale(1,true);this.tileFlag.setColourAlpha(1,true)}}};SceneManagerGame.prototype.hideFlag=function(){if(this.tileFlag){this.tileFlag.setTileScale(0,true);this.tileFlag.setColourAlpha(0,true)}};SceneManagerGame.prototype.syncLoggedIntoSocialNetwork=function(network){if(network==="facebook"){this.scenePlayScreen.loggedIntoFacebook()}else if(network==="twitter"){this.scenePlayScreen.loggedIntoTwitter()}else if(network==="google"){this.scenePlayScreen.loggedIntoGoogle()}};SceneManagerGame.prototype.getConstUserIDData=function(userID){if(this.sceneLeaderboards){return this.sceneLeaderboards.getConstUserIDData(SceneLeaderboards.Leaderboard_AllTime,userID)}};SceneManagerGame.prototype.getStatusPositionY=function(){return this.tilePlayerStatus.aabbMin[1]};function SceneGameMap(mapID,mapType){this.construct(mapID,mapType)}ExtendPrototype(SceneGameMap,CCSceneAppUI);SceneGameMap.DefaultMapImage="level_map_diffuse.jpg";SceneGameMap.prototype.construct=function(mapID,mapType){MultiplayerManager.UpdateCallbacks.insert(this,0);this.CCSceneAppUI_construct();this.cameraCentered=true;this.oneTouchDoubleTapped=this.oneTouchDoubleTappedLastPress=false;this.controlsRotationVelocity=0;this.cameraRotationTargetSpeed=180;this.setMapID(mapID);this.mapType=mapType;this.mapBounds=new CCSize;this.ground=null;this.walls=[];this.players=[];this.enemies=[];this.particles=[];this.staticObjects=[];this.pickups=[];this.createCamera();{this.pathFinderNetwork=new CCPathFinderNetwork;this.ground=new CollideableFloor(this,"ground");this.ground.setWriteDepth(false);this.ground.setDrawOrder(50);this.ground.setTransparent();this.ground.setColourAlpha(0,false);this.setMapSize(500)}if(MultiplayerManager.LoggedIn){this.syncLoggedIn()}gEngine.addScene(this)};SceneGameMap.prototype.createCamera=function(){var camera=gEngine.newSceneCamera(this,0);camera.setupViewport(0,0,1,1);camera.useSceneCollideables(this)};SceneGameMap.prototype.setup=function(){this.setMapTexture(SceneGameMap.DefaultMapImage);this.createParticles();this.lockCameraView();this.refreshCameraView()};SceneGameMap.prototype.setMapTexture=function(filename){if(this.ground){var self=this;this.ground.setTransparent();this.ground.setColourAlpha(0,true);this.ground.primitive.setTexture(filename,undefined,undefined,undefined,function(){self.ground.setColourAlpha(1,true,function(){self.ground.setTransparent(false)})})}};SceneGameMap.prototype.setMapTextureIndex=function(index){if(this.ground){this.ground.primitive.setTextureIndex(index);this.setTransparent();var self=this;this.ground.setColourAlpha(1,true,function(){self.ground.setTransparent(false)})}};SceneGameMap.prototype.setMapSize=function(size){this.mapSize=size;var mapBounds=this.mapBounds;mapBounds.width=this.mapSize*.5*.8;mapBounds.height=this.mapSize*.5*.8;this.ground.setup(this.mapSize,this.mapSize);{var walls=this.walls;if(walls.length>0){for(var i=0;i<walls.length;++i){walls[i].deleteLater()}walls.length=0}{var x=this.mapSize*.5;var z=this.mapSize*.5;var width=this.mapSize;var depth=this.mapSize;var height=20;var wall=new CollideableWall;wall.setup(this,-x,0,depth,height);wall.translate(-wall.collisionBounds[0],0,0);walls.add(wall);wall=new CollideableWall;wall.setup(this,x,0,depth,height);wall.translate(wall.collisionBounds[0],0,0);walls.add(wall);wall=new CollideableWall;wall.setup(this,0,-z,width,height);wall.translate(0,0,-wall.collisionBounds[2]);walls.add(wall);wall=new CollideableWall;wall.setup(this,0,z,width,height);wall.translate(0,0,wall.collisionBounds[2]);walls.add(wall)}}this.refreshCameraView()};SceneGameMap.prototype.updateScene=function(delta){{var particles=this.particles;var positive=1;for(var i=0;i<particles.length;++i){var particle=particles[i];particle.rotateY(delta*positive)}}if(this.controlsRotationVelocity){this.controlsRotationVelocity=CC.ToTarget(this.controlsRotationVelocity,0,delta*.1);this.camera.incrementRotationY(-this.controlsRotationVelocity*20)}if(this.cameraRotationTarget){var camera=this.camera;camera.setRotationX(CC.ToRotation(camera.rotation[0],this.cameraRotationTarget[0],delta*this.cameraRotationTargetSpeed));camera.setRotationY(CC.ToRotation(camera.rotation[1],this.cameraRotationTarget[1],delta*this.cameraRotationTargetSpeed));camera.setRotationZ(CC.ToRotation(camera.rotation[2],this.cameraRotationTarget[2],delta*this.cameraRotationTargetSpeed));if(vec3.equals(camera.rotation,this.cameraRotationTarget)){delete this.cameraRotationTarget}}return this.CCSceneAppUI_updateScene(delta)};SceneGameMap.prototype.render=function(camera,pass,alpha){if(this.camera===camera){this.CCSceneAppUI_render(camera,pass,alpha)}};SceneGameMap.prototype.postRender=function(camera,pass,alpha){if(this.camera===camera){if(pass===CCRenderer.render_main&&alpha){if(CC.HasFlag(gRenderer.renderFlags,CCRenderer.render_pathFinder)){this.pathFinderNetwork.view()}}}};SceneGameMap.prototype.resize=function(){var camera=this.camera;CC.ASSERT(camera);camera.recalcViewport();camera.flagUpdate()};SceneGameMap.prototype.handleOneTouch=function(touch1){var usingControls=false;if(this.oneTouchDoubleTapped){if(touch1.timeHeld>=CCControls.DOUBLE_TAP_THRESHOLD){}}else{this.touchDelta.x=touch1.deltaX;this.touchDelta.y=touch1.deltaY;if(!this.controlsMoving&&this.controlsFirstTouchedInThisScene){if(this.touchMovementAllowed(touch1,this.touchDelta)){}else{usingControls=this.touchPressed(touch1)}}if(this.controlsMoving){usingControls=this.touchMoving(touch1,this.touchDelta)}}return usingControls};SceneGameMap.prototype.touchPressed=function(touch){};SceneGameMap.prototype.touchMovementAllowed=function(touch,touchDelta){var absDeltaX=Math.abs(touch.totalDeltaX);var absDeltaY=Math.abs(touch.totalDeltaY);if(absDeltaX>CCControls.TouchMovementThreashold.x||absDeltaY>CCControls.TouchMovementThreashold.y){this.controlsMoving=true;touchDelta.x+=touch.totalDeltaX;touchDelta.y+=touch.totalDeltaY;this.controlsMovingVertical=absDeltaY>absDeltaX;var camera=this.camera;var plane=vec3.create();camera.project3DY(plane,touch.x,touch.y);vec3.subtract(plane,plane,camera.currentLookAt);this.cameraPanningFrom=plane;return true}return false};SceneGameMap.prototype.touchMoving=function(touch,touchDelta){var result=this.handleTilesTouch(touch,this.controlsMovingVertical?CCControls.touch_movingVertical:CCControls.touch_movingHorizontal);if(result===CCSceneAppUI.tile_touchAction){return true}else{return this.touchCameraMoving(touchDelta.x,touchDelta.y)}};SceneGameMap.prototype.touchReleased=function(touch,touchAction){var result=this.handleTilesTouch(touch,touchAction);var usingControls=result===CCSceneAppUI.tile_touchAction;if(!usingControls&&touchAction===CCControls.touch_released){var camera=this.camera;if(this.oneTouchDoubleTapped){}else if(this.controlsMoving){usingControls=this.touchReleaseSwipe(touch)}}if(this.oneTouchDoubleTappedLastPress){this.oneTouchDoubleTappedLastPress=false}if(this.oneTouchDoubleTapped){this.oneTouchDoubleTappedLastPress=true;this.oneTouchDoubleTapped=false}return usingControls};SceneGameMap.prototype.touchCameraMoving=function(x,y){var camera=this.camera;var updated=false;var delta;if(y!==0){delta=y*camera.cameraHeight;if(camera.targetLookAt[1]>this.sceneTop||camera.targetLookAt[1]<this.sceneBottom){delta*=.5}camera.targetLookAt[2]-=delta;camera.flagUpdate();updated=true}if(x!==0){delta=x*camera.cameraWidth;if(camera.targetLookAt[0]<this.sceneLeft||camera.targetLookAt[0]>this.sceneRight){delta*=.5}camera.targetLookAt[0]-=delta;camera.flagUpdate();updated=true}return updated};SceneGameMap.prototype.touchCameraRotating=function(x,y){var camera=this.camera;camera.incrementRotationY(-x*90);return true};SceneGameMap.prototype.touchReleaseSwipe=function(touch){var camera=this.camera;var timeHeldMultiplyer=(touch.timeHeld-.5)*-1*2*2;if(timeHeldMultiplyer<1){timeHeldMultiplyer=1}{var averageDeltas=touch.averageLastDeltas();if(touch.totalDeltaX<0){if(this.controlsRotationVelocity>0){this.controlsRotationVelocity=0}this.controlsRotationVelocity+=averageDeltas.x*timeHeldMultiplyer;if(this.controlsRotationVelocity<-.1){this.controlsRotationVelocity=-.1}return true}else if(touch.totalDeltaX>0){if(this.controlsRotationVelocity<0){this.controlsRotationVelocity=0}this.controlsRotationVelocity+=averageDeltas.x*timeHeldMultiplyer;if(this.controlsRotationVelocity>.1){this.controlsRotationVelocity=.1}return true}}return false};SceneGameMap.prototype.refreshCameraView=function(){var mapBounds=this.mapBounds;this.sceneLeft=-mapBounds.width;this.sceneRight=mapBounds.width;this.sceneTop=mapBounds.height;this.sceneBottom=-mapBounds.height};SceneGameMap.prototype.lockCameraView=function(){if(this.cameraScrolling){return}var camera=this.camera;if(camera.targetLookAt[0]>this.sceneRight){camera.targetLookAt[0]=this.sceneRight;camera.flagUpdate()}else if(camera.targetLookAt[0]<this.sceneLeft){camera.targetLookAt[0]=this.sceneLeft;camera.flagUpdate()}if(camera.targetLookAt[2]>this.sceneTop){camera.targetLookAt[2]=this.sceneTop;camera.flagUpdate()}else if(camera.targetLookAt[2]<this.sceneBottom){camera.targetLookAt[2]=this.sceneBottom;camera.flagUpdate()}};SceneGameMap.prototype.setMapID=function(mapID){this.mapID=mapID};SceneGameMap.prototype.getMapID=function(){return this.mapID};SceneGameMap.prototype.setOffline=function(){this.setMapID("")};SceneGameMap.prototype.isOnlineGame=function(){if(this.mapID&&this.mapID.length>0){return true}return false};SceneGameMap.prototype.getMapType=function(){return this.mapType};SceneGameMap.prototype.createParticles=function(){var self=this;var commonLevelsPath="level_";var objFile=commonLevelsPath;objFile+="particles.obj";var texFile=commonLevelsPath;texFile+="particles_diffuse.png";var object;{object=new CCObject;object.setScene(this);object.setColour(gColour.set(1,.5));CCModel3D.CacheModel(objFile,false,function(model3d){model3d.setTexture(texFile);var model=new CCModelBase;model.addModel(model3d);object.setModel(model);object.setTransparent();object.setReadDepth(false);var modelWidth=model3d.getWidth();var scaleFactor=self.ground.collisionSize.width/modelWidth;model.setScale(scaleFactor);self.particles.add(object)})}{object=new CCObject;object.setScene(this);object.setColour(gColour.set(1,.5));object.rotateY(90);CCModel3D.CacheModel(objFile,false,function(model3d){model3d.setTexture(texFile);var model=new CCModelBase;model.addModel(model3d);object.setModel(model);object.setTransparent();object.setReadDepth(false);var modelWidth=model3d.getWidth();var scaleFactor=self.ground.collisionSize.width/modelWidth;model.setScale(scaleFactor);self.particles.add(object)})}};SceneGameMap.prototype.updatePathFinder=function(){this.pathFinderNetwork.connect();var i;var players=this.players;for(i=0;i<players.length;++i){this.adjustCollisionPlacement(players[i])}for(i=0;i<players.length;++i){var player=players[i];var controller=player.controller;if(controller){controller.resetPathNodes()}}};SceneGameMap.prototype.adjustCollisionPlacement=function(source){if(source.position[1]<source.collisionBounds[1]){source.setPositionY(source.collisionBounds[1])}var collisionFlags=CC.collision_static|CC.collision_character;var collision=null;do{CC.UpdateCollisions(source,false);collision=CC.CollideableScan(source.aabbMin,source.aabbMax,source,collisionFlags);if(collision){source.translate(0,0,10)}}while(collision)};SceneGameMap.prototype.spawnStaticObject=function(objectID,obj,tex,options,width,rotation,location){var object;for(var i=0;i<this.staticObjects.length;++i){if(objectID===this.staticObjects[i].objectID){object=this.staticObjects[i];this.pathFinderNetwork.removeCollideable(object);break}}if(!object){object=new CCCollideableStaticMesh(objectID);object.setScene(this);object.setTransparent();object.setDrawOrder(99);this.staticObjects.add(object)}object.setPositionXZ(location[0],location[2]);object.setupModel(obj,tex,width);if(options){if(options.modelID){object.modelID=options.modelID}if(options.noCulling!==undefined){object.setCulling(!options.noCulling)}}object.model.rotateY(rotation);this.pathFinderNetwork.addCollideable(object,this.ground.collisionBounds);this.updatePathFinder();return object};SceneGameMap.prototype.getStaticObject=function(objectID){var staticObjects=this.staticObjects;for(var i=0;i<staticObjects.length;++i){var object=staticObjects[i];if(object.getID()===objectID){return object}}return null};SceneGameMap.prototype.spawnPickup=function(name,type,pickupID){var pickup=new PickupBase(name,type,pickupID);var objPath=name;objPath+=".obj";var texPath=name;texPath+="_diffuse.jpg";pickup.setup(objPath,texPath);pickup.setScene(this);this.adjustCollisionPlacement(pickup);this.pickups.add(pickup);return pickup};SceneGameMap.prototype.handlePickup=function(player,pickup){pickup.deleteLater();this.pickups.remove(pickup);return true};SceneGameMap.prototype.spawnCharacter=function(type,playerID,userID){if(playerID===undefined){playerID="0"}if(userID===undefined){userID=playerID}var character=SceneManagerPlay.SpawnCharacter(type);character.setupMap(this,playerID,userID);this.adjustCollisionPlacement(character);character.setupAI(new CharacterControllerPlayer(this.pathFinderNetwork));this.players.add(character);return character};SceneGameMap.prototype.spawnedCharacter=function(character){};SceneGameMap.prototype.deletingCharacter=function(character){this.players.remove(character);this.enemies.remove(character)};SceneGameMap.prototype.assignPlayerCharacter=function(character){this.registerAmmoUpdate(character);this.spawnedCharacter(character)};SceneGameMap.prototype.addEnemy=function(character){character.setupShootingIndicator("fx_character_shooting_texture.png",gColour.setRGBA(1,.5,0,.9));character.setupCharacterIndicator("fx_character_highlight_texture.png",gColour.setRGBA(1,.25,.25,.5));this.enemies.add(character);this.registerAmmoUpdate(character);this.spawnedCharacter(character)};SceneGameMap.prototype.removeEnemy=function(enemy){this.removeEnemyID(enemy.getPlayerID())};SceneGameMap.prototype.removeEnemyID=function(playerID){var enemies=this.enemies;for(var i=0;i<enemies.length;++i){var enemy=enemies[i];if(playerID===enemy.getPlayerID()){enemy.deleteLater();enemies.remove(enemy);break}}};SceneGameMap.prototype.getPlayer=function(object){var players=this.players;var length=players.length;for(var i=0;i<length;++i){var player=players[i];if(player===object){return player}}return null};SceneGameMap.prototype.getPlayerFromID=function(playerID){var players=this.players;var length=players.length;for(var i=0;i<length;++i){var player=players[i];if(player.getPlayerID()===playerID){return player}}return null};SceneGameMap.prototype.getEnemy=function(object){var enemies=this.enemies;var length=enemies.length;for(var i=0;i<length;++i){var enemy=enemies[i];if(enemy===object){return enemy}}return null};SceneGameMap.prototype.getEnemyFromID=function(playerID){var enemies=this.enemies;var length=enemies.length;for(var i=0;i<length;++i){var character=enemies[i];if(character.getPlayerID()===playerID){return character}}return null};SceneGameMap.prototype.registerAttacking=function(attacker){};SceneGameMap.prototype.registerAmmoUpdate=function(player){};SceneGameMap.prototype.handleAttack=function(attackedBy,attackType,force,damage,x,y,z){return false};SceneGameMap.prototype.registerDamage=function(from,to,damage){};SceneGameMap.prototype.registerDeath=function(playerID,killerID,synced){};SceneGameMap.prototype.syncLoggedIn=function(){};SceneGameMap.prototype.syncUpdate=function(jsonData){var i;if(jsonData.mapTexture){var filename=jsonData.mapTexture;this.setMapTexture(filename)}if(jsonData.mapSize){var size=jsonData.mapSize;this.setMapSize(size)}if(jsonData.staticObjects){var staticObjects=jsonData.staticObjects;for(i=0;i<staticObjects.length;++i){this.syncUpdate(staticObjects[i])}}var playerID,mapBounds,players,locationString,location,health,objectID;if(jsonData.addPlayer){playerID=jsonData.addPlayer;locationString=jsonData.location;location=vec3.fromString(locationString);mapBounds=this.getMapBounds();location[0]*=mapBounds.width;location[2]*=mapBounds.height;this.syncAddPlayer(playerID,jsonData.userID,jsonData.playerType,location,jsonData.health,jsonData);var bulletDamage=jsonData.bulletDamage;var bulletTax=jsonData.bulletTax;var fireChargeRate=jsonData.fireChargeRate;var timeToReady=jsonData.timeToReady;if(bulletDamage!==undefined||bulletTax!==undefined||fireChargeRate!==undefined||timeToReady!==undefined){this.syncWeaponSettings(playerID,timeToReady,bulletDamage,bulletTax,fireChargeRate)}}else if(jsonData.removePlayer){playerID=jsonData.removePlayer;var removedPlayer=this.getPlayerFromID(playerID);if(removedPlayer){this.removeEnemyID(playerID)}}else if(jsonData.gotoLocation){playerID=jsonData.gotoLocation;locationString=jsonData.location;location=vec3.fromString(locationString);mapBounds=this.getMapBounds();location[0]*=mapBounds.width;location[2]*=mapBounds.height;this.syncPlayerGotoLocation(playerID,location)}else if(jsonData.shootAt){playerID=jsonData.shootAt;var targetID=jsonData.target;this.syncPlayerShootAt(playerID,targetID)}else if(jsonData.SyncShootAtTarget){playerID=jsonData.SyncShootAtTarget;this.SyncShootAtTarget(playerID,jsonData.targetLocation)}else if(jsonData.syncPlayerAction){playerID=jsonData.syncPlayerAction;var actionID=jsonData.actionID;this.syncPlayerAction(playerID,actionID)}else if(jsonData.setHealth){playerID=jsonData.setHealth;health=jsonData.health;this.syncPlayerHealth(playerID,health,false)}else if(jsonData.registerDeath!==undefined){playerID=jsonData.registerDeath;this.registerDeath(playerID,jsonData.killerID,true)}else if(jsonData.spawnStaticObject){objectID=jsonData.spawnStaticObject;var obj=jsonData.obj;var tex=jsonData.tex;var options=jsonData.options;var width=jsonData.width;locationString=jsonData.location;location=vec3.fromString(locationString);var rotation=jsonData.rotation?jsonData.rotation:0;mapBounds=this.getMapBounds();location[0]*=mapBounds.width;location[2]*=mapBounds.height;this.spawnStaticObject(objectID,obj,tex,options,width,rotation,location)}else if(jsonData.removeStaticObject){objectID=jsonData.removeStaticObject;this.syncRemoveStaticObject(objectID)}if(jsonData.spawnPickup){objectID=jsonData.spawnPickup;var type=jsonData.type;locationString=jsonData.location;location=vec3.fromString(locationString);var pickup=this.spawnPickup("healthpack",type,objectID);if(pickup){mapBounds=this.getMapBounds();location[0]*=mapBounds.width;location[2]*=mapBounds.height;pickup.setPositionXZ(location[0],location[2]);this.adjustCollisionPlacement(pickup)}}if(jsonData.removePickup){objectID=jsonData.removePickup;this.syncRemovePickup(objectID)}};SceneGameMap.prototype.syncAddPlayer=function(playerID,userID,playerType,location,health,jsonData){var player=this.getPlayerFromID(playerID);if(!player){player=this.spawnCharacter(playerType,playerID,userID);if(MultiplayerManager.SessionID===playerID){this.assignPlayerCharacter(player)}else{this.addEnemy(player)}}{this.syncPlayerSetLocation(playerID,location)}{this.syncPlayerHealth(playerID,health,true)}};SceneGameMap.prototype.syncPlayerHealth=function(playerID,health,initialize){var character=this.getPlayerFromID(playerID);if(character){character.controller.setHealth(health,initialize);if(this.updateHealthUI){var healthRatio=character.controller.getHealthRatio();this.updateHealthUI(character,healthRatio)}}};SceneGameMap.prototype.syncWeaponSettings=function(playerID,timeToReady,bulletDamage,bulletTax,fireChargeRate){var character=this.getPlayerFromID(playerID);if(character){character.setWeaponSettings(timeToReady,bulletDamage,bulletTax,fireChargeRate)}};SceneGameMap.prototype.syncPlayerSetLocation=function(playerID,location){var character=this.getPlayerFromID(playerID);if(character){character.setPosition(location);this.adjustCollisionPlacement(character);character.controller.stopAction()}};SceneGameMap.prototype.syncPlayerGotoLocation=function(playerID,location){var character=this.getPlayerFromID(playerID);if(character){character.controller.goToScan(location)}};SceneGameMap.prototype.syncPlayerShootAt=function(playerID,targetID){var player=this.getPlayerFromID(playerID);var target=this.getPlayerFromID(targetID);if(player&&target&&player!==target){player.controller.shootAt(target)}};SceneGameMap.prototype.SyncShootAtTarget=function(playerID,targetLocation){var player=this.getPlayerFromID(playerID);if(player){player.controller.shoot(targetLocation)}};SceneGameMap.prototype.syncPlayerAction=function(playerID,actionID){var player=this.getPlayerFromID(playerID);player.controller.shoot(null,null,actionID)};SceneGameMap.prototype.syncRemoveStaticObject=function(objectID){var staticObjects=this.staticObjects;for(var i=0;i<staticObjects.length;++i){var object=staticObjects[i];if(object.getID()===objectID){object.deleteLater();staticObjects.remove(object);this.pathFinderNetwork.removeCollideable(object)}}this.updatePathFinder()};SceneGameMap.prototype.syncRemovePickup=function(pickupID){var pickups=this.pickups;for(var i=0;i<pickups.length;++i){var pickup=pickups[i];if(pickup.getID()===pickupID){pickup.deleteLater();pickups.remove(pickup);break}}};SceneGameMap.prototype.getNumberOfPlayers=function(){return this.players.length};SceneGameMap.prototype.getNumberOfHumanPlayers=function(){var count=0;var players=this.players;for(var i=0;i<players.length;++i){var player=players[i];if(!player.controller.isAI()){count++}}return count};SceneGameMap.prototype.getPathFinderNetwork=function(){return this.pathFinderNetwork};SceneGameMap.prototype.getMapBounds=function(){return this.mapBounds};function SceneGameSyndicate(mapID,mapType){this.construct(mapID,mapType)}ExtendPrototype(SceneGameSyndicate,SceneGameMap);SceneGameSyndicate.prototype.construct=function(mapID,mapType){this.playerCharacter=null;this.playerDestinationPending=null;this.playerDestinationIndicator=null;this.SceneGameMap_construct(mapID,mapType);var self=this;this.onKeyboardFunction=function(event,key,pressed){return self.onKeyboard(event,key,pressed)};gEngine.controls.requestKeyboard(this.onKeyboardFunction,false);this.keyPressedTimer=0;this.keySyncTimer=0};SceneGameSyndicate.KeySyncTime=.25;SceneGameSyndicate.prototype.destruct=function(){if(this.playerCharacter){this.playerCharacter.deleteLater();this.playerCharacter=null}if(this.onKeyboardFunction){gEngine.controls.removeKeyboard(this.onKeyboardFunction);delete this.onKeyboardFunction}this.SceneGameMap_destruct()};SceneGameSyndicate.prototype.deleteLater=function(){if(this.isOnlineGame()&&!this.exitedGame){if(MultiplayerManager.LoggedIn){BurgersClient.exitedGame();this.exitedGame=true}}this.SceneGameMap_deleteLater()};SceneGameSyndicate.prototype.setup=function(){this.SceneGameMap_setup();var camera=this.camera;camera.targetOffset[2]=75;camera.setRotationX(-30);this.setupPlayerDestinationIndicator("fx_character_highlight_texture.png",gColour.setRGBA(.75,.75,1,1));this.setupUI();if(this.isOnlineGame()){this.setupOnlineGame()}};SceneGameSyndicate.prototype.setupUI=function(){this.sceneUI=new SceneGameUI(this)};SceneGameSyndicate.prototype.setupOnlineGame=function(){MultiplayerManager.SyncLoadedMap()};SceneGameSyndicate.prototype.updateScene=function(delta){if(this.playerDestinationPending){var touch=gEngine.controls.touches[0];if(touch.lastTimeReleased>CCControls.DOUBLE_TAP_THRESHOLD){if(!this.controlsMoving){this.onGotoLocation(this.playerDestinationPending);this.playerDestinationPending=null}}}if(this.playerDestinationIndicator){var alpha=this.playerDestinationIndicator.colour.a;if(alpha>0){this.playerDestinationIndicator.rotateY(delta*720);alpha=CC.ToTarget(alpha,0,delta*.5);this.playerDestinationIndicator.setColourAlpha(alpha)}}if(this.keyPressed){this.keyPressedTimer+=delta;this.keySyncTimer+=delta}return this.SceneGameMap_updateScene(delta)};SceneGameSyndicate.prototype.updateCameraLookAt=function(delta){var camera=this.camera;var playerCharacter=this.playerCharacter;if(this.playerCharacter&&(camera.targetLookAt[0]!==playerCharacter.position[0]||camera.targetLookAt[2]!==playerCharacter.position[2])){camera.targetLookAt[0]=playerCharacter.position[0];camera.targetLookAt[2]=playerCharacter.position[2];camera.flagUpdate()}};SceneGameSyndicate.prototype.updateCamera=function(delta){this.updateCameraLookAt(delta);var updated=false;var camera=this.camera;var lookAtSpeed=1.5;if(camera.interpolateCamera(delta,lookAtSpeed)){updated=true}else{if(this.cameraScrolling){this.cameraScrolling=false;this.lockCameraView();updated=true}if(this.resizing){this.resizing=false;this.refreshCameraView();this.lockCameraView();updated=true}}return updated};SceneGameSyndicate.prototype.handleBackButton=function(){if(this.onBack){this.onBack();return true}return false};SceneGameSyndicate.prototype.updateControls=function(controls){var usingControls=this.CCSceneAppUI_updateControls(controls);var cameraTouches=this.camera.cameraTouches;var touch=cameraTouches[0];if(touch.x>0&&touch.x<1&&touch.y>0&&touch.y<1&&touch.startX>0&&touch.startX<1&&touch.startY>0&&touch.startY<1){if(controls.wheel&&controls.wheel.delta!==0){var delta=controls.wheel.delta;this.touchCameraRotating(delta*.1,0);return true}}return usingControls};SceneGameSyndicate.prototype.handleOneTouch=function(touch1){var usingControls=false;if(this.oneTouchDoubleTapped){if(touch1.timeHeld>=CCControls.DOUBLE_TAP_THRESHOLD){}}else{this.touchDelta.x=touch1.deltaX;this.touchDelta.y=touch1.deltaY;if(!this.controlsMoving){if(this.touchMovementAllowed(touch1,this.touchDelta)){}else{usingControls=this.touchPressed(touch1)}}if(this.controlsMoving){usingControls=this.touchMoving(touch1,this.touchDelta)}}return usingControls};SceneGameSyndicate.prototype.touchPressed=function(touch){};SceneGameSyndicate.prototype.touchMoving=function(touch,touchDelta){var result=this.handleTilesTouch(touch,this.controlsMovingVertical?CCControls.touch_movingVertical:CCControls.touch_movingHorizontal);if(result===CCSceneAppUI.tile_touchAction){return true}else{return this.touchCameraRotating(touchDelta.x,touchDelta.y)}};SceneGameSyndicate.ProjectionLocation=vec3.create();SceneGameSyndicate.HitPosition=vec3.create();SceneGameSyndicate.prototype.touchReleased=function(touch,touchAction){var result=this.handleTilesTouch(touch,touchAction);var usingControls=result===CCSceneAppUI.tile_touchAction;if(!usingControls&&touchAction===CCControls.touch_released){var camera=this.camera;if(this.oneTouchDoubleTapped){}else if(this.controlsMoving){usingControls=this.touchReleaseSwipe(touch)}else if(this.playerCharacter){var playerCharacter=this.playerCharacter;if(camera.project3D(touch.x,touch.y)){var projectionResults=camera.projectionResults;var projectionLocation=SceneGameSyndicate.ProjectionLocation;var offset=projectionResults.vNear[1]/Math.abs(projectionResults.vDirection[1]);vec3.scale(projectionLocation,projectionResults.vDirection,offset);vec3.add(projectionLocation,projectionLocation,projectionResults.vNear);var hitObject=null;var collideables=this.collideables;var hitPosition=SceneGameSyndicate.HitPosition;hitObject=CC.BasicLineCollisionCheck(collideables,projectionResults.vNear,projectionResults.vFar,hitPosition,true,CC.collision_character,[playerCharacter],false);if(hitObject){if(hitObject===playerCharacter){hitObject=null}}else{hitObject=playerCharacter.controller.scanForEnemy(projectionLocation)}if(hitObject){this.onSelectObject(hitObject,projectionLocation)}else{this.onSelectLocation(projectionLocation)}}}}if(this.oneTouchDoubleTappedLastPress){this.oneTouchDoubleTappedLastPress=false}if(this.oneTouchDoubleTapped){this.oneTouchDoubleTappedLastPress=true;this.oneTouchDoubleTapped=false}return usingControls};SceneGameSyndicate.prototype.setupPlayerDestinationIndicator=function(textureFile,colour){if(this.playerDestinationIndicator){this.playerDestinationIndicator.deleteLater()}this.playerDestinationIndicator=new CollideableIndicator(this,textureFile);this.playerDestinationIndicator.setWidth(this.mapBounds.width*.1);this.playerDestinationIndicator.setColour(colour)};SceneGameSyndicate.prototype.handlePickup=function(player,pickup){if(this.isOnlineGame()){if(player===this.playerCharacter){MultiplayerManager.SyncServerRegisterPickup(player.getPlayerID(),pickup.getType(),pickup.getID())}}else{player.controller.resetHealth();var healthRatio=player.controller.getHealthRatio();this.updateHealthUI(player,healthRatio)}return this.SceneGameMap_handlePickup(player,pickup)};SceneGameSyndicate.prototype.assignPlayerCharacter=function(character){character.setupShootingIndicator("fx_character_shooting_texture.png",gColour.setRGBA(1,.5,0,.9));character.setupCharacterIndicator("fx_character_highlight_texture.png",gColour.setRGBA(.5,.75,1,.5));this.playerCharacter=character;this.SceneGameMap_assignPlayerCharacter(character)};SceneGameSyndicate.prototype.registerAttacking=function(attacker){if(this.sceneUI.setFire){if(attacker===this.playerCharacter){this.sceneUI.setFire(0)}else{var enemy=this.getEnemy(attacker);if(enemy){if(this.sceneUI.getProfilePlayerID){if(this.sceneUI.getProfilePlayerID(1)===enemy.getPlayerID()){this.sceneUI.setFire(1)}}}}}};SceneGameSyndicate.prototype.registerAmmoUpdate=function(player){var ammo;if(this.sceneUI.setAmmo){if(this.sceneUI.getProfilePlayerID(0)===player.getPlayerID()){ammo=player.getWeaponAmmo();this.sceneUI.setAmmo(0,ammo)}else if(this.sceneUI.getProfilePlayerID(1)===player.getPlayerID()){ammo=player.getWeaponAmmo();this.sceneUI.setAmmo(1,ammo)}}};SceneGameSyndicate.prototype.playerShootAt=function(object,sync){this.playerCharacter.controller.shootAt(object);if(sync){if(this.isOnlineGame()){var enemy=this.getEnemy(object);if(enemy){MultiplayerManager.SyncServerPlayerShootAt(this,object.getPlayerID())}}}};SceneGameSyndicate.prototype.playerShootAtTarget=function(target,sync){this.playerCharacter.controller.shoot(target);if(sync){if(this.isOnlineGame()){MultiplayerManager.SyncShootAtTarget(this,target)}}};SceneGameSyndicate.prototype.playerAction=function(actionID,sync){this.playerCharacter.controller.shoot(null,null,actionID);if(sync===undefined){sync=true}if(sync){if(this.isOnlineGame()){MultiplayerManager.SyncPlayerAction(this,actionID)}}};SceneGameSyndicate.prototype.onSelectObject=function(hitObject,hitPosition){this.playerShootAt(hitObject,true)};SceneGameSyndicate.PlayerDestinationPending=vec3.create();SceneGameSyndicate.prototype.onSelectLocation=function(location){if(!this.playerDestinationPending){this.playerDestinationPending=SceneGameSyndicate.PlayerDestinationPending}var playerDestinationPending=this.playerDestinationPending;vec3.copy(playerDestinationPending,location);
var mapBounds=this.mapBounds;playerDestinationPending[0]=CC.FloatClamp(playerDestinationPending[0],-mapBounds.width,mapBounds.width);playerDestinationPending[2]=CC.FloatClamp(playerDestinationPending[2],-mapBounds.height,mapBounds.height);if(this.playerDestinationIndicator){this.playerDestinationIndicator.setPositionXZ(playerDestinationPending[0],playerDestinationPending[2]);this.playerDestinationIndicator.setColourAlpha(1)}};SceneGameSyndicate.prototype.onKeyboard=function(event,key,pressed){if(event.metaKey){return false}if(event.ctrlKey){return false}if(!pressed){this.keyPressed=false}else{if(!this.keyPressed){this.keyPressed=true;this.keyPressedTimer=0}if(key==="up"||key==="down"||key===" "){var direction=[0,0,-1];if(key==="up"||key===" "){CC.Vector3RotateY(direction,this.camera.rotation[1])}else if(key==="down"){CC.Vector3RotateY(direction,this.camera.rotation[1]+180)}vec3.scale(direction,direction,this.keyPressedTimer>.25?30:15);var player=this.playerCharacter;vec3.add(direction,player.position,direction);if(key===" "){this.playerShootAtTarget(direction,true)}else{if(this.keySyncTimer>=SceneGameSyndicate.KeySyncTime){this.keySyncTimer-=SceneGameSyndicate.KeySyncTime;this.onGotoLocation(direction,true)}else{this.onGotoLocation(direction,false)}}}else if(key==="left"||key==="right"){if(!this.cameraRotationTarget){this.cameraRotationTarget=vec3.clone(this.camera.rotation)}var rotationAmount=this.keyPressedTimer>.25?14:7;if(key==="left"){this.cameraRotationTarget[1]+=rotationAmount}else if(key==="right"){this.cameraRotationTarget[1]-=rotationAmount}CC.ClampRotation(this.cameraRotationTarget[1])}}};SceneGameSyndicate.prototype.onGotoLocation=function(location,sync){var locationTarget=this.playerCharacter.controller.goToScan(location);if(sync===undefined){sync=true}if(sync){if(this.isOnlineGame()){MultiplayerManager.SyncServerPlayerGotoLocation(this,locationTarget)}}};SceneGameSyndicate.prototype.updateHealthUI=function(player,health){if(player===this.playerCharacter){if(this.sceneUI.setHealth){this.sceneUI.setHealth(0,health)}}else{if(this.sceneUI.setHealth){if(this.sceneUI.getProfilePlayerID){if(this.sceneUI.getProfilePlayerID(1)===player.getPlayerID()){this.sceneUI.setHealth(1,health)}}}}};function SceneManagerAndroids(){this.construct()}ExtendPrototype(SceneManagerAndroids,SceneManagerGame);SceneManagerAndroids.prototype.construct=function(){this.SceneManagerGame_construct();if(CCEngine.DeviceType==="iOS"){this.playerType="iBot"}else if(CCEngine.DeviceType==="Android"){this.playerType="androBot"}else if(CCEngine.DeviceType.contains("Windows")){this.playerType="winBot"}else{this.playerType="webBot"}gEngine.addScene(this)};SceneManagerAndroids.prototype.isUsablePlayer=function(launchShop){if(launchShop===undefined){launchShop=true}var allowedPlayerType="webBot";if(CCEngine.DeviceType==="iOS"){allowedPlayerType="iBot"}else if(CCEngine.DeviceType==="Android"){allowedPlayerType="androBot"}else if(CCEngine.DeviceType.contains("Windows")){allowedPlayerType="winBot"}if(!this.playerType.contains(allowedPlayerType)){var playerItemCode="androids_switchTeams";var self=this;if(!SceneItemShop.HasPurchasedNonConsumable(playerItemCode)){if(launchShop){new SceneItemShop("Get coins to unlock\n all Phone Wars characters",playerItemCode,true,"unlock","unlock","unlock",function(type,itemCode,value){CC.SaveData("shop."+playerItemCode+".item",true);self.scenePlayScreen.showPlayerView(self.playerType)})}return false}}return true};function SceneManagerJoinMap(mapID,playerType,mapClassName,onBack){this.mapID=mapID;if(!playerType){playerType="iBot"}if(!mapClassName){mapClassName="SceneGameBattleRoyale"}this.playerType=playerType;this.mapClassName=mapClassName;this.onBack=onBack;this.autoConnect=true;this.construct();gEngine.addScene(this)}ExtendPrototype(SceneManagerJoinMap,SceneManagerPlay);SceneManagerJoinMap.prototype.construct=function(){this.SceneManagerPlay_construct();this.syncDisconnected()};SceneManagerJoinMap.prototype.syncDisconnected=function(){if(!MultiplayerManager.ForceDisconnected){var self=this;AlertsManager.Alert("connecting...",function(){if(self.onBack){self.onBack()}})}};SceneManagerJoinMap.prototype.syncLoggedIn=function(){this.SceneManagerPlay_syncLoggedIn();if(this.autoConnect){this.requestJoinMap(this.mapID,this.playerType)}else{this.requestJoinMapRequired=true}};SceneManagerJoinMap.prototype.requestJoinMap=function(mapID,playerType){this.requestJoinMapRequired=false;if(this.map){this.map.deleteLater();this.map=null}MultiplayerManager.RequestJoinMap(this.mapID,this.playerType)};SceneManagerJoinMap.prototype.createMap=function(mapID){return new window[this.mapClassName](mapID)};SceneManagerJoinMap.prototype.syncUpdate=function(jsonData){if(jsonData.loadGame){AlertsManager.Hide("connecting...");if(this.map){this.map.setOffline();this.map.deleteLater();this.map=null}var mapType=jsonData.type;var mapID=jsonData.loadGame;this.map=this.createMap(mapID);this.map.setParent(this);if(this.onBack){var self=this;this.map.onBack=function(){self.deleteLater();self.onBack()}}this.map.syncUpdate(jsonData)}else if(jsonData.userInfo){if(this.sceneLeaderboards){this.sceneLeaderboards.updateLeaderboardData(SceneLeaderboards.Leaderboard_AllTime,jsonData.userInfo)}}this.SceneManagerPlay_syncUpdate(jsonData)};SceneManagerJoinMap.prototype.pauseConnection=function(){this.autoConnect=false};SceneManagerJoinMap.prototype.resumeConnection=function(){this.autoConnect=true;if(this.requestJoinMapRequired){this.requestToJoinMap(this.mapID,this.playerType)}};SceneManagerJoinMap.prototype.playerAction=function(actionID){if(this.map){this.map.playerAction(actionID,true)}};function SceneMapsList(parentScene){MultiplayerManager.UpdateCallbacks.addOnce(this);this.construct();this.controlsSwipeMomentum=true;if(parentScene){this.setParent(parentScene);parentScene.linkScene(this)}{var camera=gEngine.newSceneCamera(this);camera.setupViewport(0,0,1,1)}gEngine.addScene(this);if(parentScene){var self=this;this.sceneUIBack=new SceneUIBack(this,function(){self.close()})}this.sceneMultiLauncher=new SceneMultiUILauncher(this);this.sceneMultiLauncher.show();this.open=true}ExtendPrototype(SceneMapsList,CCSceneAppUI);SceneMapsList.prototype.deleteLater=function(){if(this.syncingUpdates){MultiplayerManager.Emit("BSUnregisterMapsListUpdates");this.syncingUpdates=false}this.CCSceneAppUI_deleteLater()};SceneMapsList.prototype.setup=function(){this.maps=[];this.mapTiles=[];var camera=this.camera;camera.setCameraWidth(640,false);camera.useSceneCollideables(this);var tile;{tile=new CCTile3DButton(this);tile.setupTile(camera.targetWidth,camera.targetHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColour(gColour.set(.25,0));tile.setColourAlpha(.95,true);tile.setDrawOrder(203);this.cameraStickyTiles.add(tile);this.tileBackground=tile;this.tileBackground.shouldRender=false}if(MultiplayerManager.Emit("BSRequestMapsList")){this.syncingUpdates=true}{var idealAspectRatio=1.5;var aspectRatioAdjutment=camera.getAspectRatio()<1.25?camera.getAspectRatio()/idealAspectRatio:1;tile=new CCTile3DButton(this);tile.setupText("More Maps",camera.targetHeight*.1*aspectRatioAdjutment,true,false);tile.setTextColour(gColour.set(.75,1));tile.setDrawOrder(204);this.tileMapsList=tile;this.addTile(tile)}this.requestResize()};SceneMapsList.prototype.render=function(camera,pass,alpha){};SceneMapsList.prototype.resize=function(){this.CCSceneAppUI_resize();var camera=this.camera;var tile;{tile=this.tileBackground;tile.setTileSize(camera.targetWidth,camera.targetHeight)}if(this.tileMapsList){tile=this.tileMapsList;var y=tile.getTileMovementTarget()[1]-tile.collisionBounds[1];this.listMapTiles(this.maps,y)}};SceneMapsList.prototype.listMapTiles=function(maps,y){var camera=this.camera;var columns=3;var sideSpacing=camera.targetWidth*.1;var tileSpacing=camera.targetWidth*.025;var tileWidth=(camera.targetWidth-tileSpacing*(columns-1)-sideSpacing*2)/columns;var tileHeight=tileWidth*.5;var hTileWidth=tileWidth*.5;var x=-(camera.targetWidth*.5)+sideSpacing+hTileWidth;y-=(tileHeight+tileSpacing)*.5;var columnIndex=0;for(i=0;i<maps.length;++i){var tile=maps[i].tile;tile.setTileSize(tileWidth,tileHeight);tile.setTextHeight(tileHeight*.25);tile.setPositionXYZ(x,y,0);x+=tileWidth+tileSpacing;columnIndex++;if(columnIndex>=columns){columnIndex=0;x=-(camera.targetWidth*.5)+sideSpacing+hTileWidth;y-=tileHeight+tileSpacing}}};SceneMapsList.prototype.updateControls=function(controls){var usingControls=this.CCSceneAppUI_updateControls(controls);var cameraTouches=this.camera.cameraTouches;var touch=cameraTouches[0];if(touch.x>0&&touch.x<1&&touch.y>0&&touch.y<1&&touch.startX>0&&touch.startX<1&&touch.startY>0&&touch.startY<1){if(controls.wheel&&controls.wheel.delta!==0){var delta=controls.wheel.delta;this.cameraScrolling=true;this.controlsMovingVertical=true;this.touchCameraMoving(0,delta*.1);return true}}return usingControls};SceneMapsList.prototype.touchPressed=function(touch){if(this.CCSceneAppUI_touchPressed(touch)){return true}return true};SceneMapsList.prototype.touchMovementAllowed=function(touch,touchDelta){var absDeltaX=Math.abs(touch.totalDeltaX);var absDeltaY=Math.abs(touch.totalDeltaY);if(absDeltaX>CCControls.TouchMovementThreashold.x||absDeltaY>CCControls.TouchMovementThreashold.y){this.controlsMoving=true;touchDelta.x+=touch.totalDeltaX;touchDelta.y+=touch.totalDeltaY;this.controlsMovingVertical=true;return true}return false};SceneMapsList.prototype.touchMoving=function(touch,touchDelta){return this.CCSceneAppUI_touchMoving(touch,touchDelta)};SceneMapsList.prototype.touchReleased=function(touch,touchAction){return this.CCSceneAppUI_touchReleased(touch,touchAction)};SceneMapsList.prototype.refreshCameraView=function(){this.sceneLeft=0;this.sceneRight=0;this.sceneTop=0;this.sceneBottom=0;var tiles=this.tiles;var tile=tiles.first();if(tile){this.sceneTop=tile.getTileMovementTarget()[1]+tile.collisionBounds[1];if(this.sceneTop<this.sceneBottom){this.sceneTop=this.sceneBottom}this.sceneTop+=tile.collisionSize.height;this.sceneTop-=this.camera.targetHeight*.5}tile=tiles.last();if(tile){this.sceneBottom=tile.getTileMovementTarget()[1]-tile.collisionBounds[1];if(this.sceneBottom>this.sceneTop){this.sceneBottom=this.sceneTop}}};SceneMapsList.prototype.lockCameraView=function(){if(this.cameraScrolling){return}var camera=this.camera;camera.flagUpdate();camera.targetLookAt[0]=0;if(camera.targetLookAt[1]>this.sceneTop){camera.targetLookAt[1]=this.sceneTop}else if(camera.targetLookAt[1]<this.sceneBottom){camera.targetLookAt[1]=this.sceneBottom}};SceneMapsList.prototype.syncUpdate=function(jsonData){var self=this;var maps,i,map,mapID,tileText;if(jsonData.mapListUpdated){map=jsonData.mapListUpdated;mapID=map.mapID;maps=this.maps;for(i=0;i<maps.length;++i){var mapItr=maps[i];if(mapID===mapItr.mapID){map.tile=mapItr.tile;maps[i]=map;break}}if(map.tile){tileText=map.name;tileText+="\n Players:";tileText+=map.players;tileText+=" Objects:";tileText+=map.objects;map.tile.setText(tileText)}}else if(jsonData.mapsList){var LoadMapFunction=function(mapID){return function(){self.close();new SceneManagerJoinMap(mapID,null,null,function(){new SceneMapsList})}};maps=this.maps;while(maps.length>0){map=maps[i];maps.remove(map);map.tile.deleteLater()}for(i=0;i<jsonData.mapsList.length;++i){maps.add(jsonData.mapsList[i])}maps.sort(function(a,b){if(b.players!==a.players){return b.players-a.players}return b.objects-a.objects});var tile;for(i=0;i<maps.length;++i){map=maps[i];mapID=map.mapID;var mapName=map.name;tileText=mapName;tileText+="\n Players:";tileText+=map.players;tileText+=" Objects:";tileText+=map.objects;tile=new CCTile3DButton(this);tile.setupText(tileText,1,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.set(.85,.9),true);tile.setTextColour(gColour.set(.125,1));tile.setDrawOrder(205);tile.onRelease.push(new LoadMapFunction(mapID));this.addTile(tile);map.tile=tile}this.requestResize();this.refreshCameraView()}};SceneMapsList.prototype.close=function(){if(this.open){this.open=false;if(this.sceneUIBack){this.sceneUIBack.close()}var self=this;this.tileBackground.setColourAlpha(0,true,function(){self.deleteLater()});var camera=this.camera;camera.targetLookAt[1]=camera.targetHeight;camera.flagUpdate()}};function PlayerTile(){this.userID=undefined;this.tileFlag=null;this.tileProfile=null;this.tileHealthIcon=null;this.tileHealthBar=null;this.tileFireIcon=null;this.tileFireCharge=[]}function SceneGameUI(sceneMap){this.construct();this.cameraCentered=true;{this.sceneMap=sceneMap;sceneMap.linkScene(this);this.linkScene(sceneMap)}{var parentCameraIndex=gEngine.findCameraIndex(sceneMap.camera);var camera=gEngine.newSceneCamera(this,parentCameraIndex+1);camera.setupViewport(0,0,1,1)}this.playerTiles=new Array(2);for(var i=0;i<this.playerTiles.length;++i){this.playerTiles[i]=new PlayerTile}gEngine.addScene(this)}ExtendPrototype(SceneGameUI,CCSceneAppUI);SceneGameUI.prototype.setup=function(){var self=this;var camera=this.camera;camera.setCameraWidth(640,false);camera.useSceneCollideables(this);var tile;var playerTiles=this.playerTiles;var LoadPlayerTileImages=function(playerTile){return function(){var height=playerTile.tileHealthIcon.collisionSize.height;playerTile.tileHealthBar.setupTexturedHeight(height,null,function(){self.requestResize()});for(i=0;i<playerTile.tileFireCharge.length;++i){playerTile.tileFireCharge[i].setupTexturedHeight(height,"ui_fire_charge.png",function(){self.requestResize()})}}};for(var playerIndex=0;playerIndex<playerTiles.length;++playerIndex){var playerTile=playerTiles[playerIndex];{{tile=new CCTile3DButton(this);tile.getTileScaleInterpolator().setDuration(.25);tile.shouldRender=false;tile.setDrawOrder(202);playerTile.tileHealthIcon=tile;if(playerIndex===1){tile.flipTileY()}}{tile=new TileOverlay(this);if(playerIndex===1){tile.flipTileY()}tile.shouldRender=false;playerTile.tileHealthBar=tile}{}}{{tile=new CCTile3DButton(this);tile.setupTexturedWidth(camera.cameraWidth*.05,"ui_fire_icon.png",function(){self.requestResize()});tile.getTileScaleInterpolator().setDuration(.25);tile.shouldRender=false;tile.setDrawOrder(203);playerTile.tileFireIcon=tile;if(playerIndex===1){tile.flipTileY()}}for(var i=0;i<5;++i){tile=new CCTile3DButton(this);tile.getTileScaleInterpolator().setDuration(.25);tile.shouldRender=false;playerTile.tileFireCharge.add(tile)}}{tile=new CCTile3DButton(this);tile.shouldRender=false;playerTile.tileFlag=tile}{tile=new TileSocialProfile(this,true);tile.setTileSize(camera.cameraWidth*.1);tile.shouldRender=false;playerTile.tileProfile=tile}playerTile.tileHealthIcon.setupTexturedWidth(camera.cameraWidth*.05,"ui_health_icon.png",new LoadPlayerTileImages(playerTile))}{tile=new CCTile3DButton(this);tile.setupTexturedWidth(camera.cameraWidth*.085,"ui_back.png",function(){self.requestResize()});tile.setDrawOrder(204);this.tileBack=tile;tile.onRelease.push(function(){self.backPressed()});this.addTile(tile,0)}{tile=new CCTile3DButton(this);this.tileNotification=tile}{var idealAspectRatio=1.5;var aspectRatioAdjutment=camera.getAspectRatio()<1.25?camera.getAspectRatio()/idealAspectRatio:1;tile=new CCTile3DButton(this);tile.setupText("",camera.targetHeight*.1*aspectRatioAdjutment,true,false);tile.setDrawOrder(204);tile.setTextColour(1);this.tileTimer=tile;this.time=0}this.requestResize()};SceneGameUI.prototype.render=function(camera,pass,alpha){};SceneGameUI.prototype.resize=function(){this.CCSceneAppUI_resize();var camera=this.camera;var tile,i;if(this.tileBack){tile=this.tileBack;tile.setPositionXYZ(camera.cameraHWidth-tile.collisionBounds[0],camera.cameraHHeight-tile.collisionBounds[1],0)}var playerTile,tileProfile,tileFlag,tileHealthIcon,tileHealthBar,tileFireIcon,tileFireCharge;{playerTile=this.playerTiles[0];tileProfile=playerTile.tileProfile;tileFlag=playerTile.tileFlag;tileHealthIcon=playerTile.tileHealthIcon;tileHealthBar=playerTile.tileHealthBar;tileFireIcon=playerTile.tileFireIcon;tileFireCharge=playerTile.tileFireCharge;if(tileProfile&&tileFlag&&tileHealthIcon&&tileHealthBar&&tileFireIcon&&tileFireCharge.length>0){tile=tileProfile;tile.setPositionXYZ(-camera.cameraHWidth+tile.collisionBounds[0],-camera.cameraHHeight+tile.collisionBounds[1],0);tileFlag.positionTileAbove(tile);tileFireIcon.positionTileRight(tile);tileFireIcon.setPositionY(-camera.cameraHHeight+tileFireIcon.collisionBounds[1]);for(i=0;i<tileFireCharge.length;++i){if(i===0){tileFireCharge[i].positionTileRight(tileFireIcon)}else{tileFireCharge[i].positionTileRight(tileFireCharge[i-1])}}tileHealthIcon.positionTileAbove(tileFireIcon);tileHealthBar.positionTileRight(tileHealthIcon)}}{playerTile=this.playerTiles[1];tileProfile=playerTile.tileProfile;tileFlag=playerTile.tileFlag;tileHealthIcon=playerTile.tileHealthIcon;tileHealthBar=playerTile.tileHealthBar;tileFireIcon=playerTile.tileFireIcon;tileFireCharge=playerTile.tileFireCharge;if(tileProfile&&tileFlag&&tileHealthIcon&&tileHealthBar&&tileFireIcon&&tileFireCharge.length>0){tile=tileProfile;tile.setPositionXYZ(camera.cameraHWidth-tile.collisionBounds[0],-camera.cameraHHeight+tile.collisionBounds[1],0);tileFlag.positionTileAbove(tile);tileFireIcon.positionTileLeft(tile);tileFireIcon.setPositionY(-camera.cameraHHeight+tileFireIcon.collisionBounds[1]);for(i=0;i<tileFireCharge.length;++i){if(i===0){tileFireCharge[i].positionTileLeft(tileFireIcon)}else{tileFireCharge[i].positionTileLeft(tileFireCharge[i-1])}}tileHealthIcon.positionTileAbove(tileFireIcon);tileHealthBar.positionTileLeft(tileHealthIcon)}}};SceneGameUI.prototype.touchPressed=function(touch){return this.CCSceneAppUI_touchPressed(touch)};SceneGameUI.prototype.touchMoving=function(touch,touchDelta){return false};SceneGameUI.prototype.touchReleased=function(touch,touchAction){return this.CCSceneAppUI_touchReleased(touch,touchAction)};SceneGameUI.prototype.getProfilePlayerID=function(index){var playerTile=this.playerTiles[index];return playerTile.playerID};SceneGameUI.prototype.setProfile=function(index,playerID,userID){var playerTile=this.playerTiles[index];playerTile.playerID=playerID;playerTile.userID=userID;var tileProfile=playerTile.tileProfile;var tileFlag=playerTile.tileFlag;var tileHealthIcon=playerTile.tileHealthIcon;var tileHealthBar=playerTile.tileHealthBar;tileProfile.shouldRender=true;tileHealthIcon.shouldRender=true;tileHealthBar.shouldRender=true;playerTile.tileFireIcon.shouldRender=true;if(sceneManagerGame){var userInfo=sceneManagerGame.getConstUserIDData(userID);if(userInfo){if(userInfo.facebook&&userInfo.facebook.facebookID.length>0){tileProfile.setFacebookID(userInfo.facebook.facebookID);tileProfile.bufferFBProfilePhoto(2)}else if(userInfo.twitter&&userInfo.twitter.username){tileProfile.setTwitterID(userInfo.twitter.username);tileProfile.bufferTwitterProfilePhoto(2)}else if(userInfo.google&&userInfo.google.id){tileProfile.setGoogleID(userInfo.google.id);tileProfile.bufferGoogleProfilePhoto(2)}var self=this;MultiplayerManager.LoadCountry(tileFlag,userInfo.countryCode,function(tile,textureHandle){var scale=tile.collisionSize.width/tile.collisionSize.height;var camera=self.camera;tileFlag.setTileSize(camera.targetWidth*.1,camera.targetWidth*.1/scale);self.requestResize()})}else if(userID===MultiplayerManager.UserID){tileProfile.setFacebookID();tileProfile.setTwitterID();tileProfile.bufferInfo(2)}}this.requestResize()};SceneGameUI.prototype.removeProfile=function(index){var playerTile=this.playerTiles[index];var tileProfile=playerTile.tileProfile;var tileFlag=playerTile.tileFlag;var tileHealthIcon=playerTile.tileHealthIcon;var tileHealthBar=playerTile.tileHealthBar;tileProfile.shouldRender=false;tileFlag.shouldRender=false;tileHealthIcon.shouldRender=false;tileHealthBar.shouldRender=false;playerTile.tileFireIcon.shouldRender=false;for(var i=0;i<playerTile.tileFireCharge.length;++i){playerTile.tileFireCharge[i].shouldRender=false}};SceneGameUI.prototype.setHealth=function(index,alpha){var playerTile=this.playerTiles[index];var tileHealthIcon=playerTile.tileHealthIcon;var tileHealthBar=playerTile.tileHealthBar;if(alpha>=0){alpha=CC.FloatClamp(alpha,0,1);tileHealthBar.setAmount(alpha)}if(!tileHealthIcon.getTileScaleInterpolator().updating){tileHealthIcon.setTileScale(1.5,true,function(){tileHealthIcon.setTileScale(1,true)})}};SceneGameUI.prototype.setFire=function(index){var playerTile=this.playerTiles[index];var tile=playerTile.tileFireIcon;if(!tile.getTileScaleInterpolator().updating){tile.setTileScale(1.5,true,function(){tile.setTileScale(1,true)})}};SceneGameUI.prototype.setAmmo=function(index,ammo){var playerTile=this.playerTiles[index];if(ammo>=0){var tile,bulletIndex;for(bulletIndex=0;bulletIndex<playerTile.tileFireCharge.length;++bulletIndex){tile=playerTile.tileFireCharge[bulletIndex];tile.shouldRender=false}ammo=CC.FloatClamp(ammo,0,1);ammo*=5;bulletIndex=0;while(ammo>0){tile=playerTile.tileFireCharge[bulletIndex++];tile.shouldRender=true;if(ammo<1){tile.setColourAlpha(ammo)}else{tile.setColourAlpha(1)}ammo-=1}}};SceneGameUI.prototype.fight=function(){var camera=this.camera;var tile=this.tileNotification;tile.setupTexturedWidth(camera.cameraWidth*.2,"ui_fight.png");tile.setColourAlpha(0);tile.setTileScale(0);tile.setTileScale(2,true);tile.getColourInterpolator().setDuration(.25);tile.setColourAlpha(1,true,function(){tile.getColourInterpolator().setDuration(2);tile.setColourAlpha(0,true)})};SceneGameUI.prototype.win=function(){var camera=this.camera;var tile=this.tileNotification;tile.setupTexturedWidth(camera.cameraWidth*.2,"ui_win.png");tile.setColourAlpha(0);tile.setTileScale(0);tile.setTileScale(2,true);tile.getColourInterpolator().setDuration(.25);tile.setColourAlpha(1,true,function(){tile.getColourInterpolator().setDuration(5);tile.setColourAlpha(0,true)})};SceneGameUI.prototype.lose=function(){var camera=this.camera;var tile=this.tileNotification;tile.setupTexturedWidth(camera.cameraWidth*.2,"ui_lose.png");tile.setColourAlpha(0);tile.setTileScale(0);tile.setTileScale(2,true);tile.getColourInterpolator().setDuration(.25);tile.setColourAlpha(1,true,function(){tile.getColourInterpolator().setDuration(5);tile.setColourAlpha(0,true)})};SceneGameUI.prototype.setTime=function(time){var intTime=Math.round(time+.5);if(intTime!==this.time){var tile=this.tileTimer;var value=""+intTime+" ";tile.setText(value,true);if(this.tileBack){tile.positionTileLeft(this.tileBack)}else{var camera=this.camera;tile.setPositionXYZ(camera.cameraHWidth-tile.collisionBounds[0],camera.cameraHHeight-tile.collisionBounds[1],0)}this.time=intTime}};SceneGameUI.prototype.backPressed=function(){if(this.sceneMap){this.sceneMap.handleBackButton()}};function SceneGameBattleRoyale(mapID){this.construct(mapID)}ExtendPrototype(SceneGameBattleRoyale,SceneGameSyndicate);SceneGameBattleRoyale.prototype.construct=function(mapID){this.SceneGameSyndicate_construct(mapID,"BattleRoyale")};SceneGameBattleRoyale.prototype.destruct=function(){this.SceneGameSyndicate_destruct()};SceneGameBattleRoyale.prototype.deleteLater=function(){this.SceneGameSyndicate_deleteLater()};SceneGameBattleRoyale.prototype.setup=function(){this.SceneGameSyndicate_setup();this.camera.targetOffset[2]=200};SceneGameBattleRoyale.prototype.updateScene=function(delta){return this.SceneGameSyndicate_updateScene(delta)};SceneGameBattleRoyale.prototype.updateCameraLookAt=function(delta){var camera=this.camera;var playerCharacter=this.playerCharacter;if(playerCharacter&&(camera.targetLookAt[0]!==playerCharacter.position[0]||camera.targetLookAt[2]!==playerCharacter.position[2])){camera.targetLookAt[0]=playerCharacter.position[0];camera.targetLookAt[2]=playerCharacter.position[2];camera.flagUpdate()}};SceneGameBattleRoyale.prototype.assignPlayerCharacter=function(character){if(this.sceneUI.setProfile){this.sceneUI.setProfile(0,character.getPlayerID(),character.getUserID())}this.SceneGameSyndicate_assignPlayerCharacter(character)};SceneGameBattleRoyale.prototype.registerDamage=function(from,to,damage){var healthRatio;var playerCharacter=this.playerCharacter;if(to===playerCharacter){healthRatio=playerCharacter.controller.getHealthRatio();this.updateHealthUI(to,healthRatio);var attackerCharacter=this.getEnemy(from);if(attackerCharacter){if(this.sceneUI.setProfile){this.sceneUI.setProfile(1,attackerCharacter.getPlayerID(),attackerCharacter.getUserID())}this.registerAmmoUpdate(attackerCharacter);if(!attackerCharacter.controller.isAI()){MultiplayerManager.SyncRegisterDamage(playerCharacter.getPlayerID(),attackerCharacter.getPlayerID(),damage)}}}else if(from===playerCharacter){var attackedCharacter=this.getEnemy(to);if(attackedCharacter){if(this.sceneUI.setProfile){this.sceneUI.setProfile(1,attackedCharacter.getPlayerID(),attackedCharacter.getUserID())}this.registerAmmoUpdate(attackedCharacter);if(!attackedCharacter.controller.isAI()){if(this.sceneUI.setHealth){this.sceneUI.setHealth(1)}}else{MultiplayerManager.SyncRegisterDamage("ai",playerCharacter.getPlayerID(),damage);healthRatio=attackedCharacter.controller.getHealthRatio();this.updateHealthUI(attackedCharacter,healthRatio);if(healthRatio<=0){if(this.sceneUI.removeProfile){this.sceneUI.removeProfile(1)}this.removeEnemy(attackedCharacter)}}}}};function SceneGame1vs1(mapID){this.construct(mapID,"1vs1")}ExtendPrototype(SceneGame1vs1,SceneGameSyndicate);SceneGame1vs1.GameState_Loading=0;SceneGame1vs1.GameState_Intro=1;SceneGame1vs1.GameState_Playing=2;SceneGame1vs1.GameState_Win=3;SceneGame1vs1.GameState_Lose=4;SceneGame1vs1.prototype.construct=function(mapID,mapType){this.SceneGameSyndicate_construct(mapID,mapType);this.setGameState(SceneGame1vs1.GameState_Loading);this.playTime=60};SceneGame1vs1.prototype.destruct=function(){this.SceneGameSyndicate_destruct()};SceneGame1vs1.prototype.deleteLater=function(){this.SceneGameSyndicate_deleteLater()};SceneGame1vs1.prototype.setup=function(){this.SceneGameSyndicate_setup()};SceneGame1vs1.prototype.updateScene=function(delta){this.gameStateTime+=delta;this.updateGameState(delta);return this.SceneGameSyndicate_updateScene(delta)};SceneGame1vs1.prototype.updateCameraLookAt=function(delta){var camera=this.camera;var enemies=this.enemies;var enemy=enemies.first();var playerCharacter=this.playerCharacter;var distance,offset;if(this.gameState===SceneGame1vs1.GameState_Intro){if(this.gameStateTime<1){vec3.copy(camera.targetLookAt,[0,0,0]);distance=CC.Vector3Distance2D(playerCharacter.position,enemy.position,false);offset=camera.calcCameraOffsetForWidth(distance*2);camera.targetOffset[2]=offset;camera.flagUpdate();camera.interpolateCamera(CC_MAXFLOAT,CC_MAXFLOAT)}else if(this.gameStateTime<3){if(enemy){if(sceneManagerGame){sceneManagerGame.showPlayer2(enemy)}vec3.copy(camera.targetLookAt,enemy.position)}camera.flagUpdate();camera.targetOffset[2]=60;camera.interpolateCamera(CC_MAXFLOAT,CC_MAXFLOAT);camera.incrementRotationY(delta*90)}else if(this.gameStateTime<5){if(sceneManagerGame){sceneManagerGame.showPlayer1(playerCharacter)}vec3.copy(camera.targetLookAt,playerCharacter.position);camera.flagUpdate();camera.interpolateCamera(CC_MAXFLOAT,CC_MAXFLOAT);camera.incrementRotationY(delta*90)}else{if(sceneManagerGame){sceneManagerGame.hideSplashScreen()}vec3.copy(camera.targetLookAt,[0,0,0]);distance=CC.Vector3Distance2D(playerCharacter.position,enemy.position,false);offset=camera.calcCameraOffsetForWidth(distance*2);camera.targetOffset[2]=offset;camera.flagUpdate();camera.interpolateCamera(CC_MAXFLOAT,CC_MAXFLOAT);camera.setRotationY(0)}}else if(this.gameState===SceneGame1vs1.GameState_Playing){if(playerCharacter){if(enemies.length>0){distance=CC.Vector3Distance2D(playerCharacter.position,enemy.position,false);var hDistance=distance*.5;var direction=CC.Vector3Direction(playerCharacter.position,enemy.position);vec3.scale(direction,direction,hDistance);vec3.copy(camera.targetLookAt,playerCharacter.position);vec3.add(camera.targetLookAt,camera.targetLookAt,direction);camera.flagUpdate();camera.targetOffset[2]=camera.calcCameraOffsetForWidth(distance*1.75);camera.targetOffset[2]=CC.FloatClamp(camera.targetOffset[2],100,300)}else{if(camera.targetLookAt[0]!==playerCharacter.position[0]||camera.targetLookAt[2]!==playerCharacter.position[2]){camera.targetLookAt[0]=playerCharacter.position[0];camera.targetLookAt[2]=playerCharacter.position[2];camera.flagUpdate()}if(camera.targetOffset[2]!==120){camera.targetOffset[2]=120}}}}};SceneGame1vs1.prototype.touchReleased=function(touch,touchAction){if(this.gameState!==SceneGame1vs1.GameState_Playing){return false}return this.SceneGameSyndicate_touchReleased(touch,touchAction)};SceneGame1vs1.prototype.syncAddPlayer=function(playerID,userID,playerType,location,health,jsonData){this.SceneGameMap_syncAddPlayer(playerID,userID,playerType,location,health);if(this.getNumberOfPlayers()>=2){this.startIntro();var timer=jsonData.timer;this.setTimer(timer)}};SceneGame1vs1.prototype.assignPlayerCharacter=function(character){this.sceneUI.setProfile(0,character.getPlayerID(),character.getUserID());this.SceneGameSyndicate_assignPlayerCharacter(character)};SceneGame1vs1.prototype.addEnemy=function(character){this.sceneUI.setProfile(1,character.getPlayerID(),character.getUserID());this.SceneGameSyndicate_addEnemy(character)};SceneGame1vs1.prototype.registerDamage=function(from,to,damage){if(this.gameState===SceneGame1vs1.GameState_Playing){var playerCharacter=this.playerCharacter;var enemy,healthRatio;if(this.isOnlineGame()){if(to===playerCharacter){healthRatio=playerCharacter.controller.getHealthRatio();this.sceneUI.setHealth(0,healthRatio);var attackerCharacter=this.getEnemy(from);if(attackerCharacter){MultiplayerManager.SyncRegisterDamage(playerCharacter.getPlayerID(),attackerCharacter.getPlayerID(),damage)}}else{enemy=this.getEnemy(to);if(enemy){this.sceneUI.setHealth(1)}}}else{enemy=this.getEnemy(to);if(enemy){MultiplayerManager.SyncRegisterDamage("ai",playerCharacter.getPlayerID(),damage);healthRatio=enemy.controller.getHealthRatio();this.sceneUI.setHealth(1,healthRatio);if(healthRatio<=0){if(sceneManagerGame){sceneManagerGame.matchResult(true)}}}}}};SceneGame1vs1.prototype.gameStarted=function(){return this.gameState===SceneGame1vs1.GameState_Playing};SceneGame1vs1.prototype.startIntro=function(){if(this.gameState!==SceneGame1vs1.GameState_Intro){this.setGameState(SceneGame1vs1.GameState_Intro)}};SceneGame1vs1.prototype.startPlaying=function(){if(this.gameState!==SceneGame1vs1.GameState_Playing){this.setGameState(SceneGame1vs1.GameState_Playing)}};SceneGame1vs1.prototype.startWinning=function(){if(this.gameState!==SceneGame1vs1.GameState_Win){this.setGameState(SceneGame1vs1.GameState_Win);this.sceneUI.win()}};SceneGame1vs1.prototype.startLosing=function(){if(this.gameState!==SceneGame1vs1.GameState_Lose){this.setGameState(SceneGame1vs1.GameState_Lose);this.sceneUI.lose()}};SceneGame1vs1.prototype.updateGameState=function(timeDelta){if(this.gameState<SceneGame1vs1.GameState_Win){if(this.playTime>0){this.playTime-=timeDelta;this.sceneUI.setTime(this.playTime)}}var camera=this.camera;var enemies=this.enemies;var enemy=enemies.first();var playerCharacter=this.playerCharacter;var location;if(this.gameState===SceneGame1vs1.GameState_Intro){if(this.gameStateTime>5){if(this.gameStateTime<7){if(this.gameStateFlag===0){this.gameStateFlag=1;{location=vec3.clone(playerCharacter.position);if(location[0]<0){location[0]+=CC_SMALLFLOAT}else{location[0]-=CC_SMALLFLOAT}location[2]+=CC_SMALLFLOAT;location[1]=0;playerCharacter.controller.goToScan(location)}if(enemy){location=vec3.clone(enemy.position);if(location[0]<0){location[0]+=CC_SMALLFLOAT}else{location[0]-=CC_SMALLFLOAT}location[2]+=CC_SMALLFLOAT;location[1]=0;enemy.controller.goToScan(location)}}else{{location=vec3.clone(playerCharacter.position);location[2]+=CC_SMALLFLOAT;location[1]=0;playerCharacter.controller.shoot(location);playerCharacter.rechargeWeapon()}if(enemy){location=vec3.clone(enemy.position);location[1]=0;location[2]+=CC_SMALLFLOAT;enemy.controller.shoot(location);enemy.rechargeWeapon()}}}else{this.sceneUI.fight();this.startPlaying();var players=this.players;
for(var i=0;i<players.length;++i){var player=players[i];player.controller.enable(true);player.rechargeWeapon()}}}}else if(this.gameState===SceneGame1vs1.GameState_Playing){}else if(this.gameState===SceneGame1vs1.GameState_Win){camera.incrementRotationY(timeDelta*90);camera.flagUpdate();camera.targetOffset[2]=60;this.playerShootAt(enemy,false);if(this.gameStateTime<2){if(playerCharacter){vec3.copy(camera.targetLookAt,playerCharacter.position)}}else if(this.gameStateTime<3.5){if(enemy){vec3.copy(camera.targetLookAt,enemy.position)}}else if(this.gameStateTime<5){if(playerCharacter){vec3.copy(camera.targetLookAt,playerCharacter.position)}}else{if(sceneManagerGame){sceneManagerGame.matchEnd()}}}else if(this.gameState===SceneGame1vs1.GameState_Lose){camera.incrementRotationY(timeDelta*90);camera.flagUpdate();camera.targetOffset[2]=60;if(enemy){enemy.controller.shootAt(playerCharacter)}if(this.gameStateTime<2){if(playerCharacter){vec3.copy(camera.targetLookAt,playerCharacter.position)}}else if(this.gameStateTime<3.5){if(enemy){vec3.copy(camera.targetLookAt,enemy.position)}}else if(this.gameStateTime<5){if(playerCharacter){vec3.copy(camera.targetLookAt,playerCharacter.position)}}else{if(sceneManagerGame){sceneManagerGame.matchEnd()}}}};SceneGame1vs1.prototype.setTimer=function(time){this.playTime=time;this.sceneUI.setTime(this.playTime)};SceneGame1vs1.prototype.setGameState=function(state){this.gameState=state;this.gameStateTime=0;this.gameStateFlag=0};function SceneGameSideScroller(mapID){this.construct(mapID)}ExtendPrototype(SceneGameSideScroller,SceneGameBattleRoyale);SceneGameSideScroller.prototype.setup=function(){this.SceneGameBattleRoyale_setup();this.camera.targetOffset[2]=65;this.camera.setRotationX(-5)};SceneGameSideScroller.prototype.assignPlayerCharacter=function(character){this.sceneUI.setProfile(0,character.getPlayerID(),character.getUserID());this.SceneGameSyndicate_assignPlayerCharacter(character)};function SceneBackground(){this.construct()}ExtendPrototype(SceneBackground,CCSceneAppUI);SceneBackground.SceneWidth=960;SceneBackground.BackgroundImage="phonewars_background.jpg";SceneBackground.prototype.construct=function(){this.CCSceneAppUI_construct()};SceneBackground.prototype.setup=function(){this.CCSceneAppUI_setup();var camera=this.camera;camera.setCameraWidth(SceneBackground.SceneWidth);camera.useSceneCollideables(this);{var tile=new CCTile3DButton(this);tile.setTouchDepressDepth(0);tile.setColourAlpha(0);tile.setTileSize(camera.targetWidth,camera.targetHeight);tile.onRelease.push(function(){sceneManagerGame.backgroundTilePressed()});this.addTile(tile);this.tileBackground=tile;this.refreshBackgroundImage()}this.refreshCameraView();this.lockCameraView()};SceneBackground.prototype.render=function(camera,pass,alpha){};SceneBackground.prototype.resize=function(){this.CCSceneAppUI_resize();var camera=this.camera;if(this.tileBackground.getTileTextureImage()){this.tileBackground.setTileTexturedFit(camera.targetWidth,camera.targetHeight,true)}};SceneBackground.prototype.touchPressed=function(touch){return this.CCSceneAppUI_touchPressed(touch)};SceneBackground.prototype.touchMoving=function(touch,touchDelta){return false};SceneBackground.prototype.touchReleased=function(touch,touchAction){return this.CCSceneAppUI_touchReleased(touch,touchAction)};SceneBackground.prototype.show=function(){this.enabled=true;this.camera.enabled=true;this.showing=true;var tile=this.tileBackground;if(tile.getTileTextureImage()){tile.setColourAlpha(1,true)}tile.setCollideable(true)};SceneBackground.prototype.hide=function(){var self=this;this.showing=false;var tile=this.tileBackground;tile.setColourAlpha(0,true,function(){self.enabled=false;self.camera.enabled=false});tile.setCollideable(false)};SceneBackground.prototype.refreshBackgroundImage=function(){if(this.tileBackground){var self=this;var tile=this.tileBackground;tile.setColourAlpha(0,true);tile.setupTextured(SceneBackground.BackgroundImage,function(tile,textureHandle){if(self.showing){tile.setColourAlpha(1,true)}if(textureHandle){self.requestResize()}})}};function UserData(){this.userID=undefined;this.countryCode=undefined;this.country=undefined;this.facebook=undefined;this.twitter=undefined;this.google=undefined;this.wins=0;this.losses=0;this.won=undefined;this.lost=undefined;this.textRank=undefined;this.imageFlag=undefined;this.tileProfile=undefined;this.textName=undefined;this.imagePlatform=undefined;this.textWinRatio=undefined}function SceneLeaderboards(){this.construct()}ExtendPrototype(SceneLeaderboards,CCSceneAppUI);SceneLeaderboards.Leaderboard_Daily=0;SceneLeaderboards.Leaderboard_Weekly=1;SceneLeaderboards.Leaderboard_AllTime=2;SceneLeaderboards.Leaderboard_MaxTypes=3;SceneLeaderboards.prototype.construct=function(){this.CCSceneAppUI_construct();this.cameraCentered=true;this.controlsSwipeMomentum=true;{var camera=gEngine.newSceneCamera(this);camera.setupViewport(0,.075,1,.85)}this.currentLeaderboardType=SceneLeaderboards.Leaderboard_Daily;this.leaderboardsData=[];for(var i=0;i<SceneLeaderboards.Leaderboard_MaxTypes;++i){this.leaderboardsData.push([])}this.tileLeaderboardDaily=undefined;this.tileLeaderboardWeekly=undefined;this.tileLeaderboardAllTime=undefined;this.uiTiles=[];this.dirtyLeaderboards()};SceneLeaderboards.prototype.destruct=function(){for(var i=0;i<SceneLeaderboards.Leaderboard_MaxTypes;++i){this.leaderboardsData[i].length=0}this.CCSceneAppUI_destruct()};SceneLeaderboards.prototype.setup=function(){var self=this;var camera=this.camera;camera.setCameraWidth(300);camera.useSceneCollideables(this);var uiTiles=this.uiTiles;var tile;var tileWidth=camera.targetWidth*.3;{tile=new CCTile3DButton(this);tile.setupTexturedWidth(tileWidth,"ui_leaderboards_daily.png");tile.onRelease.push(function(){self.switchLeaderboard(SceneLeaderboards.Leaderboard_Daily)});this.addTile(tile,0);this.tileLeaderboardDaily=tile;this.uiTiles.add(tile)}{tile=new CCTile3DButton(this);tile.setupTexturedWidth(tileWidth,"ui_leaderboards_weekly.png");tile.onRelease.push(function(){self.switchLeaderboard(SceneLeaderboards.Leaderboard_Weekly)});this.addTile(tile,0);this.tileLeaderboardWeekly=tile;this.uiTiles.add(tile)}{tile=new CCTile3DButton(this);tile.setupTexturedWidth(tileWidth,"ui_leaderboards_alltime.png");tile.onRelease.push(function(){self.switchLeaderboard(SceneLeaderboards.Leaderboard_AllTime)});this.addTile(tile,0);this.tileLeaderboardAllTime=tile;this.uiTiles.add(tile)}for(var i=0;i<uiTiles.length;++i){tile=uiTiles[i];tile.setDrawOrder(205);tile.setColourAlpha(0);tile.setCollideable(false)}this.lockCameraView();this.refreshCameraView();this.hide()};SceneLeaderboards.prototype.resize=function(){this.CCSceneAppUI_resize();if(this.controlsEnabled){this.hide();this.show()}};SceneLeaderboards.prototype.render=function(camera,pass,alpha){};SceneLeaderboards.prototype.updateControls=function(controls){var usingControls=this.CCSceneAppUI_updateControls(controls);var cameraTouches=this.camera.cameraTouches;var touch=cameraTouches[0];if(touch.x>0&&touch.x<1&&touch.y>0&&touch.y<1&&touch.startX>0&&touch.startX<1&&touch.startY>0&&touch.startY<1){if(controls.wheel&&controls.wheel.delta!==0){var delta=controls.wheel.delta;this.cameraScrolling=true;this.controlsMovingVertical=true;this.touchCameraMoving(0,delta*.1);return true}}return usingControls};SceneLeaderboards.prototype.touchPressed=function(touch){return this.CCSceneAppUI_touchPressed(touch)};SceneLeaderboards.prototype.touchMovementAllowed=function(touch,touchDelta){var absDeltaY=Math.abs(touch.totalDeltaY);if(absDeltaY>CCControls.TouchMovementThreashold.y){this.controlsMoving=true;touchDelta.x+=touch.totalDeltaX;touchDelta.y+=touch.totalDeltaY;this.controlsMovingVertical=true;return true}return false};SceneLeaderboards.prototype.touchMoving=function(touch,touchDelta){return this.CCSceneAppUI_touchMoving(touch,touchDelta)};SceneLeaderboards.prototype.touchReleased=function(touch,touchAction){return this.CCSceneAppUI_touchReleased(touch,touchAction)};SceneLeaderboards.prototype.refreshCameraView=function(){this.sceneLeft=0;this.sceneRight=0;this.sceneTop=0;this.sceneBottom=0;var leaderboard=this.leaderboardsData[this.currentLeaderboardType];if(leaderboard.length>0){var bottomTile=null;for(var i=leaderboard.length-1;i>=0;--i){if(leaderboard[i].tileProfile){bottomTile=leaderboard[i].tileProfile;break}}if(bottomTile){this.sceneBottom=bottomTile.getTileMovementTarget()[1]-bottomTile.collisionBounds[1];if(this.sceneBottom>this.sceneTop){this.sceneBottom=this.sceneTop}}}};SceneLeaderboards.prototype.lockCameraView=function(){if(this.cameraScrolling){return}var camera=this.camera;camera.flagUpdate();camera.targetLookAt[0]=0;if(camera.targetLookAt[1]>this.sceneTop){camera.targetLookAt[1]=this.sceneTop}else if(camera.targetLookAt[1]<this.sceneBottom){camera.targetLookAt[1]=this.sceneBottom}};SceneLeaderboards.prototype.show=function(){this.controlsEnabled=true;var self=this;var camera=this.camera;this.enabled=true;camera.enabled=true;var uiTiles=this.uiTiles;var green=gColour.setRGBA(0,.75,0,1);var red=gColour.setRGBA(.75,0,0,1);var leaderboard=this.leaderboardsData[this.currentLeaderboardType];if(leaderboard.length===0||leaderboard.dirty){this.requestLeaderboard();return}var tile,i,text,x;{var totalWidth=0;for(i=0;i<uiTiles.length;++i){tile=uiTiles[i];tile.setColourAlpha(.5,true);tile.setCollideable(true);totalWidth+=tile.collisionSize.width}var difference=camera.targetWidth-totalWidth;x=difference*.5-camera.targetWidth*.5;for(i=0;i<uiTiles.length;++i){tile=uiTiles[i];x+=tile.collisionBounds[0];tile.setPositionX(x);tile.setTileMovementY(tile.collisionSize.height);x+=tile.collisionBounds[0]}if(this.currentLeaderboardType===SceneLeaderboards.Leaderboard_Daily){this.tileLeaderboardDaily.setColourAlpha(1,true)}else if(this.currentLeaderboardType===SceneLeaderboards.Leaderboard_Weekly){this.tileLeaderboardWeekly.setColourAlpha(1,true)}else if(this.currentLeaderboardType===SceneLeaderboards.Leaderboard_AllTime){this.tileLeaderboardAllTime.setColourAlpha(1,true)}}var userID=MultiplayerManager.UserID;var idealAspectRatio=1.5;var aspectRatioAdjutment=camera.getAspectRatio()<1.25?camera.getAspectRatio()/idealAspectRatio:1;var textHeight=camera.targetHeight*.06*aspectRatioAdjutment;var flagHeight=camera.targetHeight*.075*aspectRatioAdjutment;var platformHeight=camera.targetHeight*.1*aspectRatioAdjutment;var profileHeight=camera.targetHeight*.075*aspectRatioAdjutment;var OnLoadedImage=function(imageModel,url,height){return function(textureHandle){if(textureHandle){var primitiveSquare=imageModel.primitives[0];primitiveSquare.setTexture(url);var aspectRatio=textureHandle.image.width/textureHandle.image.height;var width=height*aspectRatio;primitiveSquare.setScale(width,height,1)}}};x=-camera.cameraHWidth*.4;var y=-camera.cameraHeight;var z=0;var previousEntryIndex=-1;var leaderboardLength=leaderboard.length;for(i=0;i<leaderboardLength;++i){var userData=leaderboard[i];if(!userData.tileProfile){continue}var textRank=userData.textRank;var imageFlag=userData.imageFlag;var tileProfile=userData.tileProfile;var textName=userData.textName;var imagePlatform=userData.imagePlatform;var textWinRatio=userData.textWinRatio;var url;{this.tiles.addOnce(tileProfile);tileProfile.shouldRender=true;tileProfile.setCollideable(true);textRank.setHeight(textHeight);textName.setHeight(textHeight);textWinRatio.setHeight(textHeight);tileProfile.setTileSize(profileHeight);if(userData.deviceType){var allowed=true;if(CCEngine.DeviceType==="iOS"){if(userData.deviceType!==CCEngine.DeviceType){allowed=false}}if(allowed){url="icon_platform_";if(userData.deviceType.contains("Windows")){url+="windows"}else{url+=userData.deviceType}url+=".png";url=url.toLowerCase();gEngine.textureManager.getTextureHandle(url,new OnLoadedImage(imagePlatform,url,platformHeight))}}tileProfile.setPositionXYZ(x,y,z);textRank.setPositionX(-camera.cameraHWidth*.8+-x);imageFlag.setPositionX(-camera.cameraHWidth*.6+-x);textName.setPositionX(camera.cameraHWidth*.1+-x);imagePlatform.setPositionX(camera.cameraHWidth*.55+-x);textWinRatio.setPositionX(camera.cameraHWidth*.75+-x)}var isUser=userID===userData.userID;{if(userData.won){tileProfile.setTextColour(green,true)}else if(userData.lost){tileProfile.setTextColour(red,true)}if(isUser){tileProfile.setTextBlinking(true)}{var rank=i+1;text="";text+=rank;if(rank>10&&rank<20){text+="th"}else{rank=rank%10;if(rank===1){text+="st"}else if(rank===2){text+="nd"}else if(rank===3){text+="rd"}else if(rank<=20){text+="th"}}if(rank>25){text=""}textRank.setText(text)}if(userData.countryCode){var geoLocationCountryCode=userData.countryCode;if(geoLocationCountryCode.length===2){geoLocationCountryCode=geoLocationCountryCode.toLowerCase();url="flag_";url+=geoLocationCountryCode;url+=".png";gEngine.textureManager.getTextureHandle(url,new OnLoadedImage(imageFlag,url,flagHeight))}}{text="";if(userData.facebook&&userData.facebook.name&&userData.facebook.name.length>0){text=userData.facebook.name}else{text="Guest ";userID=userID.strip(".");text+=userID}if(text.length>17){text=text.substring(0,17)}textName.setText(text)}{text="";text+=userData.wins;text+="/";text+=userData.losses;textWinRatio.setText(text)}}{if(previousEntryIndex===-1){tileProfile.setTileMovementYZ(0,0)}else{var previousUserData=leaderboard[previousEntryIndex];var target=previousUserData.tileProfile.getTileMovementTarget();target[1]-=previousUserData.tileProfile.collisionBounds[1];target[1]-=tileProfile.collisionBounds[1]*2;if(target[1]>-camera.cameraHHeight){tileProfile.setTileMovement(target)}else{tileProfile.setPosition(target)}}previousEntryIndex=i}}this.refreshCameraView()};SceneLeaderboards.prototype.hide=function(){var self=this;this.controlsEnabled=false;var i;var uiTiles=this.uiTiles;for(i=0;i<uiTiles.length;++i){var tile=uiTiles[i];tile.setColourAlpha(0,true);tile.setCollideable(false)}var camera=this.camera;camera.targetLookAt[1]=this.sceneTop;uiTiles[0].setColourAlpha(0,true,function(){self.enabled=false;camera.enabled=false});var leaderboard=this.leaderboardsData[this.currentLeaderboardType];var leaderboardLength=leaderboard.length;for(i=0;i<leaderboardLength;++i){var userData=leaderboard[i];if(userData.tileProfile.shouldRender){this.tiles.remove(userData.tileProfile);userData.tileProfile.shouldRender=false;userData.tileProfile.setCollideable(false)}}this.refreshCameraView();this.lockCameraView()};SceneLeaderboards.prototype.switchLeaderboard=function(leaderboardType){if(leaderboardType!==this.currentLeaderboardType){this.hide();this.currentLeaderboardType=leaderboardType;this.show()}};SceneLeaderboards.prototype.dirtyLeaderboards=function(){for(var i=0;i<SceneLeaderboards.Leaderboard_MaxTypes;++i){this.leaderboardsData[i].dirty=true}};SceneLeaderboards.prototype.requestLeaderboard=function(){if(MultiplayerManager.LoggedIn){var leaderboard=this.leaderboardsData[this.currentLeaderboardType];leaderboard.dirty=false;var type="all";if(this.currentLeaderboardType===SceneLeaderboards.Leaderboard_Daily){type="daily"}else if(this.currentLeaderboardType===SceneLeaderboards.Leaderboard_Weekly){type="weekly"}if(BurgersClient){BurgersClient.getLeaderboards(type)}}};SceneLeaderboards.prototype.parseLeaderboardType=function(jsonData){var text=jsonData.type;if(text==="daily"){return SceneLeaderboards.Leaderboard_Daily}else if(text==="weekly"){return SceneLeaderboards.Leaderboard_Weekly}return SceneLeaderboards.Leaderboard_AllTime};SceneLeaderboards.prototype.getUserIDData=function(leaderboardType,userID){var leaderboard=this.leaderboardsData[leaderboardType];for(var i=0;i<leaderboard.length;++i){if(leaderboard[i].userID===userID){return leaderboard[i]}}return null};SceneLeaderboards.prototype.getConstUserIDData=function(leaderboardType,userID){return this.getUserIDData(leaderboardType,userID)};SceneLeaderboards.prototype.getPlayerCountryCode=function(userID){var countryCode;var userData=this.getConstUserIDData(SceneLeaderboards.Leaderboard_AllTime,userID);if(userData){countryCode=userData.countryCode}return countryCode};SceneLeaderboards.prototype.updateLeaderboardData=function(leaderboardType,jsonData){var userID=jsonData.userID;var wins=jsonData.wins;var losses=jsonData.losses;var deviceType=jsonData.deviceType;var countryCode=jsonData.countryCode;var country=jsonData.country;var facebook=jsonData.facebook;var twitter=jsonData.twitter;var google=jsonData.google;this.updateLeaderboard(leaderboardType,userID,countryCode,country,facebook,twitter,google,wins,losses,deviceType)};SceneLeaderboards.prototype.updateLeaderboard=function(leaderboardType,userID,countryCode,country,facebook,twitter,google,wins,losses,deviceType){var userData=this.getUserIDData(leaderboardType,userID);if(!userData){userData=new UserData;userData.userID=userID;userData.deviceType=deviceType;var leaderboard=this.leaderboardsData[leaderboardType];leaderboard.add(userData)}else{userData.won=false;userData.lost=false;if(wins>userData.wins){userData.won=true}else if(losses>userData.losses){userData.lost=true}}if(countryCode){userData.countryCode=countryCode}if(country){userData.country=country}userData.facebook=facebook;userData.twitter=twitter;userData.google=google;userData.wins=wins;userData.losses=losses;if(!userData.tileProfile){var tile,tileProfile,imageModel;{tile=new TileSocialProfile(this,true);tile.setDrawOrder(205);if(facebook&&facebook.facebookID.length>0){tile.setFacebookID(facebook.facebookID);tile.bufferFBProfilePhoto(2)}if(twitter&&twitter.username){tile.setTwitterID(twitter.username);tile.bufferTwitterProfilePhoto(2)}if(google&&google.id){tile.setGoogleID(google.id);tile.bufferGoogleProfilePhoto(2)}var self=this;tile.onRelease.push(function(tile){self.profileSelected(tile)});userData.tileProfile=tile;tile.shouldRender=false;tile.setCollideable(false);tileProfile=tile}{userData.textRank=new CCObjectText(tileProfile);userData.textRank.setColour(gColour.set(1))}{imageModel=new CCModelBase;imageModel.addPrimitive(new CCPrimitiveSquare);tileProfile.tileModel.addModel(imageModel);userData.imageFlag=imageModel}{userData.textName=new CCObjectText(tileProfile);userData.textName.setColour(gColour.set(1))}{imageModel=new CCModelBase;imageModel.addPrimitive(new CCPrimitiveSquare);tileProfile.tileModel.addModel(imageModel);userData.imagePlatform=imageModel}{userData.textWinRatio=new CCObjectText(tileProfile);userData.textWinRatio.setColour(gColour.set(1))}}this.sortLeaderboard(leaderboardType)};SceneLeaderboards.prototype.sortLeaderboard=function(leaderboardType){var leaderboard=this.leaderboardsData[leaderboardType];leaderboard.sort(function(a,b){var playerA=a;var playerB=b;var result;if(playerB.wins===playerA.wins){result=playerA.losses-playerB.losses;return result}result=playerB.wins-playerA.wins;return result})};SceneLeaderboards.prototype.profileSelected=function(profile){var url;var facebookID=profile.getFacebookID();if(facebookID){url="http://facebook.com/";url+=facebookID;CCEngine.WebViewOpen(url)}var twitterID=profile.getTwitterID();if(twitterID){url="http://twitter.com/";url+=twitterID;CCEngine.WebViewOpen(url)}var googleID=profile.getGoogleID();if(googleID){url="http://plus.google.com/";url+=googleID;CCEngine.WebViewOpen(url)}};function ScenePlayScreen(){this.construct()}ExtendPrototype(ScenePlayScreen,CCSceneAppUI);ScenePlayScreen.prototype.construct=function(){this.CCSceneAppUI_construct();this.cameraCentered=true;{var camera=gEngine.newSceneCamera(this);camera.setupViewport(0,0,1,1)}this.scenePlayerView=null;this.sceneProfileLogin=null;this.uiTiles=[];this.sideMenuTiles=[];this.mapMenuTiles=[]};ScenePlayScreen.prototype.destruct=function(){this.deletePlayerView();this.closeProfileLogin();if(this.sceneMultiLauncher){this.sceneMultiLauncher.hide()}this.CCSceneAppUI_destruct()};ScenePlayScreen.prototype.setup=function(){var self=this;var camera=this.camera;camera.setCameraWidth(640);camera.useSceneCollideables(this);this.BORDERWIDTH_RATIO=.2;var borderWidth=camera.targetWidth*this.BORDERWIDTH_RATIO;var uiTiles=this.uiTiles;var sideMenuTiles=this.sideMenuTiles;var tile;{tile=new CCTile3DButton(this);tile.setColourAlpha(0);this.tileSideBackground=tile;tile.setupTexturedWidth(borderWidth,"ui_sidebackground.png",function(){self.imageLoaded()});tile.setDrawOrder(199);tile.setCollideable(false);this.addTile(tile);tile.setTouchDepressDepth(0)}{tile=new TileSocialProfile(this);tile.setTileSize(borderWidth*.75);tile.setPositionX(camera.targetWidth+tile.collisionBounds[0]);tile.setText(" ",false,tile.collisionSize.height*.2);tile.setTextPosition(0,tile.collisionBounds[1]*-.45);tile.setTextColour(gColour.set(.5,0));this.tileProfile=tile;tile.bufferInfo(2,function(tile,success){if(success){self.setPlayerID(tile.getName())}});tile.onRelease.push(function(){self.showProfileLogin()});this.addTile(tile,0);sideMenuTiles.add(tile);uiTiles.add(tile)}{tile=new CCTile3DButton(this);tile.setupTexturedWidth(borderWidth,"ui_practice.png",function(){self.imageLoaded()});tile.onRelease.push(function(){self.startOfflineGame()});this.addTile(tile,0);this.tilePractice=tile;sideMenuTiles.add(tile);uiTiles.add(tile)}{tile=new CCTile3DButton(this);tile.setupTexturedWidth(borderWidth,"ui_leaderboards.png",function(){self.imageLoaded()});tile.onRelease.push(function(){self.showLeaderboards()});this.addTile(tile,0);this.tileLeaderboards=tile;sideMenuTiles.add(tile);uiTiles.add(tile)}{tile=new CCTile3DButton(this);tile.setupTexturedWidth(borderWidth,"ui_help.png",function(){self.imageLoaded()});tile.onRelease.push(function(){self.showHelp()});this.addTile(tile,0);this.tileHelp=tile;sideMenuTiles.add(tile);uiTiles.add(tile)}this.tilePushNotifications=null;{{tile=new CCTile3DButton(this);tile.setupTexturedWidth(borderWidth*.5,"ui_arrow.png",function(){self.imageLoaded()});tile.onRelease.push(function(){self.switchTeams(-1)});this.addTile(tile,0);this.tileSwitchTeamsLeft=tile;uiTiles.add(tile)}var OnImageDownloaded=function(tile){return function(){tile.flipTileY();self.imageLoaded()}};{tile=new CCTile3DButton(this);tile.setupTexturedWidth(borderWidth*.5,"ui_arrow.png",new OnImageDownloaded(tile));tile.onRelease.push(function(){self.switchTeams(1)});this.addTile(tile,0);this.tileSwitchTeamsRight=tile;uiTiles.add(tile)}}{var mapMenuTiles=this.mapMenuTiles;{tile=new CCTile3DButton(this);tile.setupTexturedWidth(borderWidth*1.25,"ui_button_1vs1.png",function(){self.imageLoaded()});tile.onRelease.push(function(){self.start1vs1Game()});this.addTile(tile,0);uiTiles.add(tile);mapMenuTiles.add(tile)}{tile=new CCTile3DButton(this);tile.setupTexturedWidth(borderWidth*1.25,"ui_button_battleroyale.png",function(){self.imageLoaded()});tile.onRelease.push(function(){self.startBattleRoyaleGame()});this.addTile(tile,0);uiTiles.add(tile);mapMenuTiles.add(tile)}}for(var i=0;i<uiTiles.length;++i){tile=uiTiles[i];tile.setDrawOrder(205);tile.setColourAlpha(0);tile.setCollideable(false)}this.lockCameraView();this.refreshCameraView()};ScenePlayScreen.prototype.imageLoaded=function(){if(this.showing){this.showMainView()}else{this.hideMainView()}};ScenePlayScreen.prototype.resize=function(){this.CCSceneAppUI_resize();if(this.showing){this.showMainView()}};ScenePlayScreen.prototype.render=function(camera,pass,alpha){};ScenePlayScreen.prototype.deletingChild=function(inScene){if(inScene===this.sceneProfileLogin){this.sceneProfileLogin=null;this.showMainView();if(this.scenePlayerView){this.scenePlayerView.enabled=true;this.scenePlayerView.camera.enabled=true}if(sceneManagerGame){sceneManagerGame.camera.enabled=true}}this.CCSceneAppUI_deletingChild(inScene)};ScenePlayScreen.prototype.touchPressed=function(touch){return this.CCSceneAppUI_touchPressed(touch)};ScenePlayScreen.prototype.touchMoving=function(touch,touchDelta){return false};ScenePlayScreen.prototype.touchReleased=function(touch,touchAction){return this.CCSceneAppUI_touchReleased(touch,touchAction)};ScenePlayScreen.prototype.show=function(playerType){this.showMainView();this.showPlayerView(playerType)};ScenePlayScreen.prototype.showMainView=function(){this.showing=true;this.controlsEnabled=true;var camera=this.camera;this.enabled=true;camera.enabled=true;var uiTiles=this.uiTiles;var sideMenuTiles=this.sideMenuTiles;var tile;var i;{tile=this.tileSideBackground;tile.setColourAlpha(1,true);tile.setCollideable(true);tile.setPositionYZ(0,0);tile.setTileMovementX(camera.targetWidth*.5+tile.collisionBounds[0]-tile.collisionSize.width)}{var yOffset=0;{var menuHeight=0;for(i=0;i<sideMenuTiles.length;++i){tile=sideMenuTiles[i];menuHeight+=tile.collisionSize.height}yOffset=-menuHeight*.6}var quarterHeight=camera.targetHeight*.075125;if(yOffset>quarterHeight){yOffset=quarterHeight}if(this.tileSideBackground.getTileTextureImage()){tile=this.tileProfile;tile.setPositionY(-tile.collisionBounds[1]-yOffset);tile.setTileMovementX(this.tileSideBackground.getTileMovementTarget()[0]);tile.setTextColourAlpha(.85,true)}}{tile=this.tilePractice;tile.positionTileBelowY(this.tileProfile)}{tile=this.tileLeaderboards;tile.positionTileBelowY(this.tilePractice)}{tile=this.tileHelp;tile.positionTileBelowY(this.tileLeaderboards)}if(this.tilePushNotifications){tile=this.tilePushNotifications;tile.positionTileBelow(this.tileHelp);tile.translateTileMovementX(-tile.collisionSize.width)}{var borderWidth=camera.targetWidth*this.BORDERWIDTH_RATIO;{tile=this.tileSwitchTeamsLeft;tile.setPositionX(-camera.targetWidth*.5+tile.collisionBounds[0]);tile.setPositionY(0)}{tile=this.tileSwitchTeamsRight;tile.setPositionX(camera.targetWidth*.5-tile.collisionBounds[0]-borderWidth);tile.setPositionY(0)}}{var borderOffset=camera.targetWidth*this.BORDERWIDTH_RATIO*.5;var y=camera.targetHeight*.5*.666;var mapMenuTiles=this.mapMenuTiles;var totalWidth=mapMenuTiles[0].collisionSize.width*mapMenuTiles.length;var x=-borderOffset-totalWidth*.5;for(i=0;i<mapMenuTiles.length;++i){tile=mapMenuTiles[i];x+=tile.collisionBounds[0];tile.setPositionX(x);x+=tile.collisionBounds[0];tile.setPositionY(-y)}}for(i=0;i<sideMenuTiles.length;++i){tile=sideMenuTiles[i];if(tile!==this.tileProfile){tile.setTileMovementX(camera.targetWidth*.5+tile.collisionBounds[0]-tile.collisionSize.width)}}for(i=0;i<uiTiles.length;++i){tile=uiTiles[i];tile.setColourAlpha(1,true);tile.setCollideable(true)}};ScenePlayScreen.prototype.hide=function(){this.deletePlayerView();this.hideMainView()};ScenePlayScreen.prototype.hideMainView=function(){var self=this;this.showing=false;this.controlsEnabled=false;var camera=this.camera;var uiTiles=this.uiTiles;var sideMenuTiles=this.sideMenuTiles;var tile;if(this.tileSideBackground){tile=this.tileSideBackground;tile.setColourAlpha(0,true,function(){self.enabled=false;camera.enabled=false});tile.setCollideable(false);tile.setTileMovementX(camera.targetWidth*.5+tile.collisionBounds[0])}if(this.tileProfile){tile=this.tileProfile;tile.setTileMovementX(camera.targetWidth*.5+tile.collisionBounds[0]);tile.setTextColourAlpha(0,true)}var i;for(i=0;i<sideMenuTiles.length;++i){tile=sideMenuTiles[i];if(tile!==this.tileProfile){tile.translateTileMovementX(tile.collisionSize.width)}}for(i=0;i<uiTiles.length;++i){tile=uiTiles[i];tile.setColourAlpha(0,true);tile.setCollideable(false)}this.closeProfileLogin()};ScenePlayScreen.prototype.showPlayerView=function(playerType){this.deletePlayerView();var borderWidth=this.BORDERWIDTH_RATIO;var sceneWidth=1-borderWidth;this.scenePlayerView=new ScenePlayerView(this,sceneWidth,playerType);gEngine.addScene(this.scenePlayerView)};ScenePlayScreen.prototype.deletePlayerView=function(){if(this.scenePlayerView){this.scenePlayerView.deleteLater();this.scenePlayerView=null}};ScenePlayScreen.prototype.showProfileLogin=function(){if(this.controlsEnabled){if(!this.sceneProfileLogin){this.hideMainView();if(this.scenePlayerView){this.scenePlayerView.enabled=false;this.scenePlayerView.camera.enabled=false}if(sceneManagerGame){sceneManagerGame.camera.enabled=false}this.controlsEnabled=false;this.sceneProfileLogin=new SceneProfileLogin(this)}sceneManagerGame.toggleWaitingForOpponent(false)}};ScenePlayScreen.prototype.closeProfileLogin=function(){if(this.sceneProfileLogin){this.sceneProfileLogin.close()}};ScenePlayScreen.prototype.loggedIntoFacebook=function(){var self=this;this.tileProfile.setFacebookID("me");this.tileProfile.bufferFBInfo(2,false,function(tile,success){if(success){self.setPlayerID(tile.getName())}})};ScenePlayScreen.prototype.loggedIntoTwitter=function(){var self=this;this.tileProfile.bufferTwitterInfo(2,function(tile,success){if(success){self.setPlayerID(tile.getName())}})};ScenePlayScreen.prototype.loggedIntoGoogle=function(){var self=this;this.tileProfile.bufferGoogleInfo(2,function(tile,success){if(success){self.setPlayerID(tile.getName())}})};ScenePlayScreen.prototype.setPlayerID=function(playerID){var newPlayerID=playerID;newPlayerID=newPlayerID.replace(" ","\n");var currentPlayerID=this.tileProfile.textObject.getText();if(currentPlayerID!==newPlayerID){if(this.tileProfile.isCollideable()){this.tileProfile.setTextColourAlpha(0);this.tileProfile.setTextColourAlpha(.85,true)}this.tileProfile.setText(newPlayerID)}};ScenePlayScreen.prototype.enablePushNotifications=function(){};ScenePlayScreen.prototype.disablePushNotifications=function(){};ScenePlayScreen.prototype.startOfflineGame=function(){if(sceneManagerGame){if(sceneManagerGame.startOfflineGame()){this.controlsEnabled=false}}};ScenePlayScreen.prototype.start1vs1Game=function(){if(MultiplayerManager.LoggedIn){if(sceneManagerGame){sceneManagerGame.start1vs1()}}};ScenePlayScreen.prototype.startBattleRoyaleGame=function(){if(MultiplayerManager.LoggedIn){if(sceneManagerGame){if(sceneManagerGame.startBattleRoyale()){this.controlsEnabled=false}}}};ScenePlayScreen.prototype.switchTeams=function(direction){sceneManagerGame.switchTeams(direction)};ScenePlayScreen.prototype.showLeaderboards=function(){if(this.controlsEnabled){if(sceneManagerGame.showLeaderboards()){this.controlsEnabled=false}}};ScenePlayScreen.prototype.showHelp=function(){if(this.controlsEnabled){new SceneUIImage(this)}};function ScenePlayerView(parentScene,sceneWidth,playerType){this.construct();this.cameraCentered=true;{parentScene.linkScene(this);this.setParent(parentScene)}{var cameraIndex=gEngine.findCameraIndex(parentScene.camera)-1;if(cameraIndex<0){cameraIndex=0}var camera=gEngine.newSceneCamera(this,cameraIndex);camera.setupViewport(0,0,sceneWidth,1)}this.playerType=playerType}ExtendPrototype(ScenePlayerView,CCSceneAppUI);ScenePlayerView.prototype.construct=function(){this.CCSceneAppUI_construct();this.cameraCentered=true};ScenePlayerView.prototype.destruct=function(){this.CCSceneAppUI_destruct()};ScenePlayerView.prototype.setup=function(){var self=this;var camera=this.camera;camera.useSceneCollideables(this);camera.setRotationX(-15);camera.setLookAt([0,-30,0]);camera.setOffset([0,0,50]);camera.offsetInterpolator.setDuration(1);if(!sceneManagerGame.isUsablePlayer(false)){var tile=new CCTile3DButton(this,true);tile.setText("LOCKED");tile.setColour(gColour.set(0,.5));tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(210);tile.setRotationX(-10);tile.setTouchDepressDepth(1);tile.onRelease.push(function(){sceneManagerGame.isUsablePlayer()});this.addTile(tile,0);this.text=tile}this.player=SceneManagerPlay.SpawnCharacter(this.playerType,function(player){vec3.copy(camera.targetLookAt,player.position);camera.flagUpdate();self.playerLoaded=true;self.requestResize()});this.player.setScene(this);this.refreshCameraView();this.lockCameraView()};ScenePlayerView.prototype.updateCamera=function(delta){if(!this.resizing&&!this.cameraScrolling){this.player.rotateY(delta*-15)}return this.CCSceneAppUI_updateCamera(delta)};ScenePlayerView.prototype.resize=function(){var camera=this.camera;CC.ASSERT(camera);camera.recalcViewport();camera.flagUpdate();var idealAspectRatio=1.5;var aspectRatioAdjutment=camera.getAspectRatio()<1.25?camera.getAspectRatio()/idealAspectRatio:1;if(this.playerLoaded){camera.setCameraHeight(30/aspectRatioAdjutment,true)}if(this.text){var tile=this.text;tile.setTextHeight(camera.targetHeight*.2*aspectRatioAdjutment,true);tile.setTextScale(.75);
tile.setPositionY(-camera.targetHeight*.125)}};ScenePlayerView.prototype.render=function(camera,pass,alpha){this.CCSceneAppUI_render(camera,pass,alpha)};ScenePlayerView.prototype.touchPressed=function(touch){return this.CCSceneAppUI_touchPressed(touch)};ScenePlayerView.prototype.touchMoving=function(touch,touchDelta){var result=this.handleTilesTouch(touch,this.controlsMovingVertical?CCControls.touch_movingVertical:CCControls.touch_movingHorizontal);if(result===CCSceneAppUI.tile_touchAction){return true}else{return this.touchCameraRotating(touchDelta.x,touchDelta.y)}};ScenePlayerView.prototype.touchReleased=function(touch,touchAction){return this.CCSceneAppUI_touchReleased(touch,touchAction)};ScenePlayerView.prototype.touchCameraRotating=function(x,y){this.player.rotateY(x*180);this.player.rotateX(y*180);return true};ScenePlayerView.prototype.refreshCameraView=function(){this.CCSceneAppUI_refreshCameraView()};ScenePlayerView.prototype.lockCameraView=function(){};function SceneProfileLogin(parentScene){this.construct();if(parentScene){this.setParent(parentScene);parentScene.linkScene(this)}var camera=gEngine.newSceneCamera(this);camera.setupViewport(0,0,1,1);this.open=true;gEngine.addScene(this);CCEngine.EnableBackButton(this)}ExtendPrototype(SceneProfileLogin,CCSceneAppUI);SceneProfileLogin.prototype.setup=function(){var self=this;var camera=this.camera;camera.setCameraWidth(200,false);var tile;{tile=new CCTile3DButton(this);tile.setupTile(camera.targetWidth,camera.targetHeight);tile.setColour(gColour.set(0,0));tile.setColourAlpha(.75,true);tile.setDrawOrder(99);this.tileBackground=tile;tile.onRelease.push(function(){self.close()});this.addTile(tile)}{tile=new TileSocialProfile(this);tile.setTileSize(camera.cameraWidth*.25);this.tileProfile=tile;this.addTile(tile)}this.tileSocialLogins=[];{tile=new CCTile3DButton(this);this.tileFacebookLogin=tile;tile.setupTexturedWidth(50,"icon_facebook.png",function(){self.requestResize()});tile.onRelease.push(function(){self.facebookLogin()});this.addTile(tile,0);this.tileSocialLogins.push(tile)}if(!window.tizen){tile=new CCTile3DButton(this);this.tileTwitterLogin=tile;tile.setupTexturedWidth(50,"icon_twitter.png",function(){self.requestResize()});tile.onRelease.push(function(){self.twitterLogin()});this.addTile(tile,0);this.tileSocialLogins.push(tile)}if(!window.tizen){tile=new CCTile3DButton(this);this.tileGoogleLogin=tile;tile.setupTexturedWidth(50,"icon_googleplus.png",function(){self.requestResize()});tile.onRelease.push(function(){self.googleLogin()});this.addTile(tile,0);this.tileSocialLogins.push(tile)}camera.setLookAtY(camera.targetHeight);this.refreshCameraView();camera.targetLookAt[1]=0;this.requestResize()};SceneProfileLogin.prototype.handleBackButton=function(){if(this.open){this.close();return true}};SceneProfileLogin.prototype.resize=function(){this.CCSceneAppUI_resize();var camera=this.camera;this.tileBackground.setTileSize(camera.targetWidth,camera.targetHeight);if(this.tileProfile){this.tileProfile.setPositionY(this.tileProfile.collisionBounds[1]);var tileSocialLoginsWidth=0;var i;for(i=0;i<this.tileSocialLogins.length;++i){tileSocialLoginsWidth+=this.tileSocialLogins[i].collisionSize.width}var x=-tileSocialLoginsWidth*.5;for(i=0;i<this.tileSocialLogins.length;++i){var tile=this.tileSocialLogins[i];x+=tile.collisionBounds[0];tile.positionTileBelow(this.tileProfile);tile.translate(0,-2,0);tile.setPositionX(x);x+=tile.collisionBounds[0]}}};SceneProfileLogin.prototype.updateScene=function(delta){var updated=this.CCSceneAppUI_updateScene(delta);return updated};SceneProfileLogin.prototype.updateCamera=function(delta){var camera=this.camera;var updated=false;var lookAtSpeed=1.5;if(camera.interpolateCamera(delta,lookAtSpeed)){if(this.scrollBar){this.scrollBar.reposition(camera.currentLookAt[1],camera.cameraWidth,camera.cameraHeight)}updated=true}else{if(this.cameraScrolling){this.cameraScrolling=false;this.lockCameraView();updated=true}if(this.resizing){this.resizing=false;this.refreshCameraView();this.lockCameraView();updated=true}}return updated};SceneProfileLogin.prototype.renderVisibleObject=function(object,inCamera,pass,alpha){if(this.camera===inCamera){object.renderObject(inCamera,alpha)}};SceneProfileLogin.prototype.updateControls=function(controls){this.CCSceneAppUI_updateControls(controls);return this.open};SceneProfileLogin.prototype.touchMovementAllowed=function(touch,touchDelta){return false};SceneProfileLogin.prototype.lockCameraView=function(){};SceneProfileLogin.prototype.facebookLogin=function(){var self=this;CCAPIFacebook.ClearCache();CCAPIFacebook.StartLogin(function(){self.facebookLoggedIn()})};SceneProfileLogin.prototype.facebookLoggedIn=function(){if(CCAPIFacebook.GetUserAccessToken()){MultiplayerManager.RegisterFacebook();this.tileProfile.setFacebookID("me");this.tileProfile.bufferFBInfo(2,true);this.close()}};SceneProfileLogin.prototype.twitterLogin=function(){var self=this;CCAPITwitter.ClearCache();CCAPITwitter.StartLogin(true,function(){self.twitterLoggedIn()})};SceneProfileLogin.prototype.twitterLoggedIn=function(){if(CCAPITwitter.m_user){var self=this;if(this.tileProfile.bufferTwitterInfo(2)){MultiplayerManager.RegisterTwitter();self.close()}}};SceneProfileLogin.prototype.googleLogin=function(){var self=this;CCAPIGoogle.ClearCache();CCAPIGoogle.StartLogin(function(){self.googleLoggedIn()})};SceneProfileLogin.prototype.googleLoggedIn=function(){if(CCAPIGoogle.User){var self=this;if(this.tileProfile.bufferGoogleInfo(2)){MultiplayerManager.RegisterGoogle();self.close()}}};SceneProfileLogin.prototype.close=function(){if(this.open){if(this.parentScene){this.parentScene.deletingChild(this)}this.open=false;var self=this;this.tileBackground.setColourAlpha(0,true);this.tileProfile.setColourAlpha(0,true);if(this.tileFacebookLogin){this.tileFacebookLogin.setColourAlpha(0,true)}if(this.tileTwitterLogin){this.tileTwitterLogin.setColourAlpha(0,true)}if(this.tileGoogleLogin){this.tileGoogleLogin.setColourAlpha(0,true)}this.tileProfile.setTileScale(1);this.tileProfile.setTileScale(0,true,function(){self.deleteLater()});var camera=this.camera;camera.flagUpdate();camera.targetLookAt[1]=camera.targetHeight}};function SceneItemShop(title,itemCode,consumable,inAppPurhcaseValue,facebookValue,twitterValue,callback){if(SceneItemShop.scene){return}SceneItemShop.scene=this;this.construct();if(!title){title="Get more coins"}if(!itemCode){itemCode="topup_1"}if(inAppPurhcaseValue===undefined){inAppPurhcaseValue=1e3}if(facebookValue===undefined){facebookValue=10}if(twitterValue===undefined){twitterValue=10}if(!callback){inAppPurhcaseValue=0}if(window.LAUNCH_APP_ID!==window.APP_ID){itemCode=window.DEFAULT_PURCHASE_ID}if(window.tizen){inAppPurhcaseValue=false;twitterValue=false}this.title=title;SceneItemShop.itemCode=itemCode;SceneItemShop.consumable=consumable;SceneItemShop.inAppPurhcaseValue=inAppPurhcaseValue;SceneItemShop.facebookValue=facebookValue;SceneItemShop.twitterValue=twitterValue;SceneItemShop.onPurchasedCallback=callback;var camera=gEngine.newSceneCamera(this);camera.setupViewport(0,0,1,1);this.open=true;gEngine.addScene(this);CCEngine.EnableBackButton(this);if(!inAppPurhcaseValue&&!facebookValue&&!twitterValue){this.close()}}ExtendPrototype(SceneItemShop,CCSceneAppUI);SceneItemShop.prototype.setup=function(){var self=this;var camera=this.camera;camera.setCameraWidth(200,false);var tile;{tile=new CCTile3DButton(this);tile.setupTile(camera.targetWidth,camera.targetHeight);tile.setColour(gColour.set(0,0));tile.setColourAlpha(.75,true);tile.setDrawOrder(99);this.tileBackground=tile;tile.onRelease.push(function(){self.close()});this.addTile(tile)}{tile=new CCTile3DButton(this);this.tileTitle=tile;tile.setupText(this.title,camera.targetHeight*.1);tile.setTextColour(new CCColour);this.addTile(tile)}if(!!SceneItemShop.facebookValue){tile=new CCTile3DButton(this);this.tileFacebookLogin=tile;tile.setupTexturedWidth(25,"icon_facebook.png",function(){self.requestResize()});tile.onRelease.push(function(){self.facebookLogin()});this.addTile(tile,0);{tile=new CCTile3DButton;tile.setupText("Mention us +"+SceneItemShop.facebookValue,camera.targetHeight*.05);tile.setTextColour(new CCColour);this.tileFacebookLogin.addChild(tile);tile.translate(0,-this.tileFacebookLogin.collisionBounds[1]-tile.collisionBounds[1])}}if(!!SceneItemShop.twitterValue){tile=new CCTile3DButton(this);this.tileTwitterLogin=tile;tile.setupTexturedWidth(25,"icon_twitter.png",function(){self.requestResize()});tile.onRelease.push(function(){self.twitterLogin()});this.addTile(tile,0);{tile=new CCTile3DButton;tile.setupText("Tweet us +"+SceneItemShop.twitterValue,camera.targetHeight*.05);tile.setTextColour(new CCColour);this.tileTwitterLogin.addChild(tile);tile.translate(0,-this.tileTwitterLogin.collisionBounds[1]-tile.collisionBounds[1])}}if(!!SceneItemShop.inAppPurhcaseValue){if((CCEngine.DeviceType==="iOS"||CCEngine.DeviceType==="Android"||CCEngine.DeviceType==="WindowsPhone")&&!window.amazon&&!window.samsung){tile=new CCTile3DButton(this);this.tileInAppPurchase=tile;var iconURL="icon_store";if(CCEngine.DeviceType==="Android"){iconURL+="_googleplay"}else if(CCEngine.DeviceType.contains("Windows")){iconURL+="_windows"}iconURL+=".png";tile.setupTexturedWidth(50,iconURL,function(){self.requestResize()});tile.onRelease.push(function(){self.inAppPurchase()});this.addTile(tile,0);{tile=new CCTile3DButton;tile.setupText("In-app purchase +"+SceneItemShop.inAppPurhcaseValue,camera.targetHeight*.05);tile.setTextColour(new CCColour);this.tileInAppPurchase.addChild(tile);tile.translate(0,-this.tileInAppPurchase.collisionBounds[1]-tile.collisionBounds[1])}}}camera.setLookAtY(camera.targetHeight);this.refreshCameraView();camera.targetLookAt[1]=0;this.requestResize()};SceneItemShop.prototype.handleBackButton=function(){if(this.open){this.close();return true}};SceneItemShop.prototype.resize=function(){this.CCSceneAppUI_resize();var camera=this.camera;this.tileBackground.setTileSize(camera.targetWidth,camera.targetHeight);if(this.tileTitle){this.tileTitle.setPositionY(camera.targetHeight*.25);if(this.tileInAppPurchase){this.tileInAppPurchase.positionTileBelow(this.tileTitle);this.tileInAppPurchase.translate(0,-5,0);if(this.tileFacebookLogin){this.tileFacebookLogin.positionTileLeft(this.tileInAppPurchase);this.tileFacebookLogin.translate(-this.tileFacebookLogin.collisionBounds[0])}if(this.tileTwitterLogin){this.tileTwitterLogin.positionTileRight(this.tileInAppPurchase);this.tileTwitterLogin.translate(this.tileTwitterLogin.collisionBounds[0])}}else{if(this.tileFacebookLogin&&this.tileTwitterLogin){this.tileFacebookLogin.setPositionX(-this.tileFacebookLogin.collisionSize.width);this.tileTwitterLogin.setPositionX(this.tileTwitterLogin.collisionSize.width)}}}};SceneItemShop.prototype.updateScene=function(delta){var updated=this.CCSceneAppUI_updateScene(delta);return updated};SceneItemShop.prototype.updateCamera=function(delta){var camera=this.camera;var updated=false;var lookAtSpeed=1.5;if(camera.interpolateCamera(delta,lookAtSpeed)){if(this.scrollBar){this.scrollBar.reposition(camera.currentLookAt[1],camera.cameraWidth,camera.cameraHeight)}updated=true}else{if(this.cameraScrolling){this.cameraScrolling=false;this.lockCameraView();updated=true}if(this.resizing){this.resizing=false;this.refreshCameraView();this.lockCameraView();updated=true}}return updated};SceneItemShop.prototype.renderVisibleObject=function(object,inCamera,pass,alpha){if(this.camera===inCamera){object.renderObject(inCamera,alpha)}};SceneItemShop.prototype.updateControls=function(controls){this.CCSceneAppUI_updateControls(controls);return this.open};SceneItemShop.prototype.touchMovementAllowed=function(touch,touchDelta){return false};SceneItemShop.prototype.lockCameraView=function(){};SceneItemShop.prototype.facebookLogin=function(){var self=this;CCAPIFacebook.ClearCache();CCAPIFacebook.StartLogin(function(){self.facebookLoggedIn()})};SceneItemShop.prototype.facebookLoggedIn=function(){if(CCAPIFacebook.GetUserAccessToken()){MultiplayerManager.RegisterFacebook();var url=SERVER_ROOT+"backend/helper.php?url=http://softpoetry.com/backend/facebook.php?post&client=";url+=APP_ID;url+="&token="+CCAPIFacebook.GetUserAccessToken();gURLManager.requestURL(url);if(SceneItemShop.onPurchasedCallback){if(!SceneItemShop.consumable){CC.SaveData("shop."+SceneItemShop.itemCode+".item",true)}SceneItemShop.onPurchasedCallback("facebook",SceneItemShop.itemCode,SceneItemShop.facebookValue);SceneItemShop.onPurchasedCallback=undefined}this.close()}};SceneItemShop.prototype.twitterLogin=function(){var self=this;CCAPITwitter.ClearCache();CCAPITwitter.StartLogin(false,function(){self.twitterLoggedIn()})};SceneItemShop.prototype.twitterLoggedIn=function(){if(CCAPITwitter.m_user){MultiplayerManager.RegisterTwitter();if(SceneItemShop.onPurchasedCallback){if(!SceneItemShop.consumable){CC.SaveData("shop."+SceneItemShop.itemCode+".item",true)}SceneItemShop.onPurchasedCallback("twitter",SceneItemShop.itemCode,SceneItemShop.twitterValue);SceneItemShop.onPurchasedCallback=undefined}this.close()}};SceneItemShop.prototype.inAppPurchase=function(){if(!MultiplayerManager.LoggedIn){AlertsManager.TimeoutAlert("unable to connect\ncheck your internet connection\nand try again",5);return}if(SceneItemShop.onPurchasedCallback){if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCEngine.InAppPurchase;"+SceneItemShop.itemCode+";"+(SceneItemShop.consumable?"true":"false")+"\n"}}};SceneItemShop.InAppPurchased=function(){if(SceneItemShop.onPurchasedCallback){if(!SceneItemShop.consumable){CC.SaveData("shop."+SceneItemShop.itemCode+".item",true)}SceneItemShop.onPurchasedCallback("in-app",SceneItemShop.itemCode,SceneItemShop.inAppPurhcaseValue);SceneItemShop.onPurchasedCallback=undefined;if(SceneItemShop.scene){SceneItemShop.scene.close()}}};SceneItemShop.HasPurchasedNonConsumable=function(itemCode,callback){if(CC.LoadData(itemCode)){CC.DeleteData(itemCode);CC.SaveData("shop."+itemCode+".item",true)}if(!CC.LoadData("shop."+itemCode+".item")){return false}return true};SceneItemShop.prototype.close=function(){SceneItemShop.scene=undefined;this.open=false;for(var i=0;i<this.tiles.length;++i){this.tiles[i].setColourAlpha(0,true)}var self=this;this.tileBackground.setColourAlpha(0,true,function(){self.deleteLater()});var camera=this.camera;camera.flagUpdate();camera.targetLookAt[1]=camera.targetHeight};function SceneSplashScreen(){this.construct();gEngine.textureManager.getTextureHandle("ui_vs.png");gEngine.textureManager.getTextureHandle("ui_vs_whitestripe.png");gEngine.textureManager.getTextureHandle("ui_vs_bluestripe.png");gEngine.textureManager.getTextureHandle("ui_vs_redstripe.png")}ExtendPrototype(SceneSplashScreen,CCSceneAppUI);SceneSplashScreen.prototype.setup=function(){var self=this;var camera=gEngine.newSceneCamera(this);camera.setupViewport(0,0,1,1);camera.setCameraWidth(SceneBackground.SceneWidth);camera.useSceneCollideables(this);var tile;{tile=new CCTile3DButton(this);this.tileWhiteStripe=tile;tile.shouldRender=false}{{tile=new CCTile3DButton(this);tile.setDrawOrder(201);this.tileBlueStripe=tile;tile.translate(camera.targetWidth,0,0)}}{{tile=new CCTile3DButton(this);tile.setDrawOrder(201);this.tileRedStripe=tile;tile.translate(-camera.targetWidth,0,0)}}{tile=new CCTile3DButton(this);tile.setDrawOrder(204);this.tilePlayer1=tile;tile=new CCTile3DButton(this);tile.setDrawOrder(204);this.tilePlayerCountry1=tile;tile=new CCTile3DButton(this);tile.setupText("",1,true,false);tile.setDrawOrder(205);tile.setTextColour(gColour.set(1,0));this.tilePlayer1Score=tile}{tile=new CCTile3DButton(this);tile.setDrawOrder(204);this.tilePlayer2=tile;tile=new CCTile3DButton(this);tile.setDrawOrder(204);this.tilePlayerCountry2=tile;tile=new CCTile3DButton(this);tile.setupText("",1,true,false);tile.setDrawOrder(205);tile.setTextColour(gColour.set(1,0));this.tilePlayer2Score=tile}{tile=new CCTile3DButton(this);tile.setupTextured("ui_vs.png");tile.setDrawOrder(205);this.tileVS=tile}this.tileWhiteStripe.setupTextured("ui_vs_whitestripe.png",function(){self.tileBlueStripe.setupTextured("ui_vs_bluestripe.png",function(){self.tileRedStripe.setupTextured("ui_vs_redstripe.png",function(){self.tileBlueStripe.positionTileAbove(self.tileWhiteStripe);{tile=new CCTile3DButton(self);tile.setupTextured("ui_vs_whitestripe.png");tile.setColour(gColour.set(0,.5));tile.setDrawOrder(202);tile.translate(0,self.tileBlueStripe.collisionBounds[1]+tile.collisionBounds[1],0);tile.removeFromScene();self.tileBlueStripe.addChild(tile)}{tile=new CCTile3DButton(self);tile.setupTextured("ui_vs_whitestripe.png");tile.setColour(gColour.set(0,.5));tile.setDrawOrder(203);tile.translate(0,-(self.tileBlueStripe.collisionBounds[1]+tile.collisionBounds[1]),0);tile.removeFromScene();self.tileBlueStripe.addChild(tile)}self.tileRedStripe.positionTileBelow(self.tileWhiteStripe);{tile=new CCTile3DButton(self);tile.setupTextured("ui_vs_whitestripe.png");tile.setColour(gColour.set(0,.5));tile.setDrawOrder(203);tile.translate(0,self.tileRedStripe.collisionBounds[1]+tile.collisionBounds[1],0);tile.removeFromScene();self.tileRedStripe.addChild(tile)}{tile=new CCTile3DButton(self);tile.setupTextured("ui_vs_whitestripe.png");tile.setColour(gColour.set(0,.5));tile.setDrawOrder(202);tile.translate(0,-(self.tileRedStripe.collisionBounds[1]+tile.collisionBounds[1]),0);tile.removeFromScene();self.tileRedStripe.addChild(tile)}self.loaded=true;self.hide(true);if(self.onLoaded){self.onLoaded();delete self.onLoaded}})})});{this.hide(true)}this.requestResize()};SceneSplashScreen.prototype.resize=function(){this.CCSceneAppUI_resize();var camera=this.camera;var idealAspectRatio=1.5;var aspectRatioAdjutment=camera.getAspectRatio()<1.25?camera.getAspectRatio()/idealAspectRatio:1;var textHeight=camera.targetHeight*.15*aspectRatioAdjutment;this.tilePlayer1Score.setTextHeight(textHeight,false);this.tilePlayer2Score.setTextHeight(textHeight,false)};SceneSplashScreen.prototype.render=function(camera,pass,alpha){};SceneSplashScreen.prototype.touchPressed=function(touch){return this.CCSceneAppUI_touchPressed(touch)};SceneSplashScreen.prototype.touchMoving=function(touch,touchDelta){return false};SceneSplashScreen.prototype.touchReleased=function(touch,touchAction){return this.CCSceneAppUI_touchReleased(touch,touchAction)};SceneSplashScreen.prototype.show=function(player1,country1,player2,country2){if(this.loaded){this.showPlayer1(player1,country1);this.showPlayer2(player2,country2);this.tileVS.setTileMovement(vec3.create());this.tileVS.setColourAlpha(1,true)}else{var self=this;this.onLoaded=function(){self.show(player1,country1,player2,country2)}}};SceneSplashScreen.prototype.hide=function(instantly){var self=this;if(!instantly){if(this.onLoaded){delete this.onLoaded}}this.timers.length=0;var camera=this.camera;this.tileBlueStripe.setColourAlpha(0,!instantly,function(){self.enabled=false;camera.enabled=false});this.tileBlueStripe.setTextColourAlpha(0,!instantly);this.tileRedStripe.setColourAlpha(0,!instantly);this.tileRedStripe.setTextColourAlpha(0,!instantly);this.tileVS.setColourAlpha(0,!instantly);this.tilePlayer1Score.setTextColourAlpha(0,!instantly);this.tilePlayer2Score.setTextColourAlpha(0,!instantly);if(instantly){this.tileBlueStripe.setPositionX(-camera.targetWidth);this.tilePlayer1.setPositionX(camera.targetWidth);this.tilePlayerCountry1.setPositionX(-camera.targetWidth);this.tileRedStripe.setPositionX(camera.targetWidth);this.tilePlayer2.setPositionX(-camera.targetWidth);this.tilePlayerCountry2.setPositionX(camera.targetWidth);this.tileVS.setPositionZ(camera.targetOffset[2])}else{this.tileBlueStripe.setTileMovementX(-camera.targetWidth);this.tilePlayer1.setTileMovementX(camera.targetWidth);this.tilePlayerCountry1.setTileMovementX(-camera.targetWidth);this.tileRedStripe.setTileMovementX(camera.targetWidth);this.tilePlayer2.setTileMovementX(-camera.targetWidth);this.tilePlayerCountry2.setTileMovementX(camera.targetWidth);this.tileVS.setTileMovement(vec3.clone([0,0,camera.targetOffset[2]*1]))}this.showingPlayer1=this.showingPlayer2=false};SceneSplashScreen.prototype.showPlayer1=function(playerType,countryCode,time){if(!time){time=1}if(this.showingPlayer1!==playerType){this.showingPlayer1=playerType;var self=this;var camera=this.camera;this.enabled=true;camera.enabled=true;var tilePlayer1=this.tilePlayer1;var tilePlayerCountry1=this.tilePlayerCountry1;var tileBlueStripe=this.tileBlueStripe;var timer=new CCTimer;timer.onTime.push(function(){{SceneSplashScreen.LoadPlayerType(tilePlayer1,playerType,function(tile){if(self.showingPlayer1){tile.positionTileAbove(self.tileWhiteStripe);tile.setPositionX(-camera.targetWidth*.75);tile.setTileMovementX(-camera.targetWidth*.5+tile.collisionBounds[0]);self.tilePlayer1Score.setPositionXY(.5,tileBlueStripe.position[1])}})}{MultiplayerManager.LoadCountry(tilePlayerCountry1,countryCode,function(tile,textureHandle){if(self.showingPlayer1){tile.setPosition(tileBlueStripe.position);tile.setPositionX(camera.targetWidth*.75);tile.setTileMovementX(camera.targetWidth*.5-tile.collisionBounds[0])}})}});timer.start(time);this.timers.push(timer);tileBlueStripe.setColourAlpha(.9,true);tileBlueStripe.setTileMovementX(0)}};SceneSplashScreen.prototype.showPlayer2=function(playerType,countryCode,time){if(!time){time=1.25}if(this.showingPlayer2!==playerType){this.showingPlayer2=playerType;var self=this;var camera=this.camera;this.enabled=true;camera.enabled=true;var tilePlayer2=this.tilePlayer2;var tilePlayerCountry2=this.tilePlayerCountry2;var tileRedStripe=this.tileRedStripe;var timer=new CCTimer;timer.onTime.push(function(){{tilePlayer2.resetTileUVs();SceneSplashScreen.LoadPlayerType(tilePlayer2,playerType,function(tile){if(self.showingPlayer2){tile.flipTileY();tile.positionTileAbove(tileRedStripe);tile.translate(0,-tileRedStripe.collisionSize.height,0);tile.setPositionX(camera.targetWidth*.75);tile.setTileMovementX(camera.targetWidth*.5-tile.collisionBounds[0]);self.tilePlayer2Score.setPositionXY(.5,tileRedStripe.position[1])}})}{MultiplayerManager.LoadCountry(tilePlayerCountry2,countryCode,function(tile,textureHandle){if(self.showingPlayer2){tile.setPosition(tileRedStripe.position);tile.setPositionX(-camera.targetWidth*.75);tile.setTileMovementX(-camera.targetWidth*.5+tile.collisionBounds[0])}})}});timer.start(time);this.timers.push(timer);tileRedStripe.setColourAlpha(.9,true);tileRedStripe.setTileMovementX(0)}};SceneSplashScreen.LoadPlayerType=function(tile,playerType,callback){var playerTypeInfo=sceneManagerGame.getPlayerTypeInfo(playerType);if(playerTypeInfo.icon){tile.setupTextured(playerTypeInfo.icon,callback)}else{callback(tile)}};SceneSplashScreen.prototype.isShowingPlayer1=function(){return this.showingPlayer1};SceneSplashScreen.prototype.isShowingPlayer2=function(){return this.showingPlayer2};SceneSplashScreen.prototype.getPlayer1Stripe=function(){return this.tileBlueStripe};SceneSplashScreen.prototype.getPlayer2Stripe=function(){return this.tileRedStripe};SceneSplashScreen.prototype.getPlayer1Score=function(){return this.tilePlayer1Score};SceneSplashScreen.prototype.getPlayer2Score=function(){return this.tilePlayer2Score};function TileOverlay(scene,frameSrc,overlaySrc,margin){this.construct(scene);this.aspectRatioLocked=true;if(!frameSrc){frameSrc="ui_health_bar.png"}if(!overlaySrc){overlaySrc="ui_health_bar_energy.png"}{this.getTileScaleInterpolator().setDuration(.25);this.setDrawOrder(201);this.setTileSize();this.setTileTexture(frameSrc)}{tile=new CCTile3DButton;tile.getTileScaleInterpolator().setDuration(.25);tile.setTileSize();tile.setTileTexture(overlaySrc);this.tileOverlay=tile;this.addChild(tile,true)}this.amount=1;if(margin===undefined){margin=.1}this.margin=margin}ExtendPrototype(TileOverlay,CCTile3DButton);TileOverlay.prototype.setAmount=function(amount){amount=CC.FloatClamp(amount,0,1);this.amount=amount;if(this.tileOverlay){amount*=1-this.margin;amount+=this.margin*.5;this.tileOverlay.setTileSize(this.collisionSize.width*amount,this.collisionSize.height);if(this.flipped){this.tileOverlay.getTileSquare().setTextureUVs(amount,0,0,1);this.tileOverlay.setPositionX(this.collisionBounds[0]-this.tileOverlay.collisionBounds[0])}else{this.tileOverlay.getTileSquare().setTextureUVs(0,0,amount,1);this.tileOverlay.setPositionX(-this.collisionBounds[0]+this.tileOverlay.collisionBounds[0])}this.tileOverlay.setColourAlpha(.5+amount*.5,true)}};TileOverlay.prototype.setTileSize=function(width,height,depth){this.CCTile3DButton_setTileSize(width,height,depth);if(this.tileOverlay){this.tileOverlay.setTileSize(width,height,depth)}};TileOverlay.prototype.flipTileY=function(){this.CCTile3DButton_flipTileY();if(this.tileOverlay){this.tileOverlay.flipTileY()}this.flipped=!this.flipped};function TileProfileBase(scene){this.construct(scene)}ExtendPrototype(TileProfileBase,CCTile3DButton);TileProfileBase.prototype.construct=function(scene){this.CCTile3DButton_construct(scene)};TileProfileBase.prototype.setupTile=function(width,height,text){if(!this.backgroundSquare){this.setDrawOrder(200);this.photoWidth=.9;this.backgroundSquare=new CCPrimitiveSquare;this.backgroundSquare.setTexture("ui_border.png");var model=this.model;model.addPrimitive(this.backgroundSquare);this.setColour(gColour.set(1));var tileRotationInterpolator=this.tileRotationInterpolator=new CCInterpolatorListV3(CCInterpolatorX2Curve);tileRotationInterpolator.setDuration(.5)}return this.CCTile3DButton_setupTile(width,height,text)};TileProfileBase.prototype.setTileSize=function(width,height){if(!height){height=width}if(this.tileSquares.length===0){this.tileSquares.push(new CCPrimitiveSquare);var tileSquare=this.tileSquares[0];this.tileModel.addPrimitive(tileSquare)}var hWidth=width*.5;var hHeight=height*.5;this.setHCollisionBounds(hWidth,hHeight,CC_SMALLFLOAT);this.backgroundSquare.setScale(width,height,1);this.tileSquares[0].setScale(width*this.photoWidth,height*this.photoWidth,1);CC.UpdateCollisions(this)};TileProfileBase.prototype.rotationFadeOut=function(){this.setCollideable(false);if(this.tileRotationInterpolator){var self=this;this.setColourAlpha(0,true);this.tileRotationInterpolator.pushV3(this.rotation,vec3.clone([0,CC.RandomDualInt()*90,0]),true,function(){self.shouldRender=false})}};TileProfileBase.prototype.rotationFadeIn=function(){this.setCollideable(true);if(this.tileRotationInterpolator){this.setColourAlpha(1,true);this.tileRotationInterpolator.pushV3(this.rotation,vec3.create(),true);this.shouldRender=true}};function GetDefaultProfilePhoto(){var photos=["profile_derp.png","profile_f7u12.png","profile_girl.png","profile_grandma.png","profile_happy.png","profile_poker.png","profile_rich.png","profile_troll.png"];var random=CC.Random(7);return photos[random]}function TileSocialProfile(scene,doNotBuffer){this.construct(scene);if(!this.f7u12Photo){this.f7u12Object=new CCObject;this.f7u12Object.setModel(new CCModelBase);this.f7u12Object.setColour(gColour.set(1));this.f7u12Object.getColourInterpolator().setDuration(.25);this.f7u12Photo=new CCPrimitiveSquare;this.f7u12Photo.setTexture(GetDefaultProfilePhoto());this.f7u12Object.model.addPrimitive(this.f7u12Photo);this.f7u12Object.setTransparent();this.f7u12Object.setReadDepth(false);this.f7u12Object.setWriteDepth(false);this.addChild(this.f7u12Object,0)}this.setupTile(1);if(!doNotBuffer){this.bufferInfo(2)}}ExtendPrototype(TileSocialProfile,TileProfileBase);TileSocialProfile.prototype.renderObject=function(camera,alpha){this.TileProfileBase_renderObject(camera,alpha)};TileSocialProfile.prototype.renderModel=function(alpha){if(alpha){this.TileProfileBase_renderModel(alpha)}else{this.TileProfileBase_renderModel(alpha)}};TileSocialProfile.prototype.APIDownloadedPhoto=function(url,photoID){if(photoID===this.facebookID||photoID===this.twitterID||photoID===this.googleID){if(this.f7u12Object){this.f7u12Object.setColourAlpha(0,true)}if(this.tileSquares.length>0){this.tileSquares[0].setTexture(url)}}};TileSocialProfile.prototype.removePhoto=function(){this.f7u12Object.setColourAlpha(1,true);this.profilePhotoRequestedPriority=-1;this.tileSquares[0].removeTexture()};TileSocialProfile.prototype.setTileSize=function(width,height){if(height===undefined){height=width}this.TileProfileBase_setTileSize(width,height);this.f7u12Photo.setScale(width*this.photoWidth,height*this.photoWidth,1)};TileSocialProfile.prototype.setFacebookID=function(inUserID){this.facebookID=inUserID;this.profilePhotoRequestedPriority=-1};TileSocialProfile.prototype.getFacebookID=function(){return this.facebookID};TileSocialProfile.prototype.setTwitterID=function(inUserID){this.twitterID=inUserID;this.profilePhotoRequestedPriority=-1};TileSocialProfile.prototype.getTwitterID=function(){return this.twitterID};TileSocialProfile.prototype.setGoogleID=function(inUserID){this.googleID=inUserID;this.profilePhotoRequestedPriority=-1};TileSocialProfile.prototype.getGoogleID=function(){return this.googleID};TileSocialProfile.prototype.setName=function(inUserName){this.userName=inUserName;this.userSurname=String.LastWord(inUserName)};TileSocialProfile.prototype.getName=function(){return this.userName};TileSocialProfile.prototype.bufferInfo=function(priority,callback){if(!this.facebookID){if(this.bufferTwitterInfo(2,callback)){return}if(this.bufferGoogleInfo(2,callback)){return}}this.bufferFBInfo(priority,false,callback)};TileSocialProfile.prototype.reset=function(){this.userName="";this.userSurname="";this.googleID="";this.twitterID="";this.facebookID="";this.removePhoto()};TileSocialProfile.GetFBInfo=function(priority,callback,noCache){var self=this;function FBInfoCallback(){}FBInfoCallback.prototype.run=function(){var reply=this.reply;if(reply&&reply.state>=CCURLRequest.Succeeded){var root;try{root=JSON.parse(reply.data)}catch(error){if(reply.state===CCURLRequest.Used_Cache){self.GetFBInfo(priority,callback,true)}}if(root){if(callback){callback(root.id,root.name)}}}else{if(callback){callback()}}};CCAPIFacebook.Request(new FBInfoCallback,this.facebookID?this.facebookID:"me",priority,noCache)};TileSocialProfile.prototype.bufferFBInfo=function(priority,noCache,callback){var self=this;TileSocialProfile.GetFBInfo(priority,function(id,name){if(id&&name){self.parseFBInfoJSON(id,name,priority,callback)}},noCache)};TileSocialProfile.prototype.parseFBInfoJSON=function(id,name,priority,callback){var jsonStringID=id;var jsonStringName=name;this.setFacebookID(jsonStringID);this.setName(jsonStringName);this.bufferFBProfilePhoto(priority);if(callback){callback(this,true)}};TileSocialProfile.GetTwitterInfo=function(callback){return CC.LoadData("twitter.me")};TileSocialProfile.prototype.bufferTwitterInfo=function(priority,callback){var username=TileSocialProfile.GetTwitterInfo();if(username!==undefined){this.setTwitterID(username);this.setName("@"+username);this.bufferTwitterProfilePhoto(priority);if(callback){callback(this,true)}return true}if(callback){callback(this,false)}return false};TileSocialProfile.GetGoogleInfo=function(callback){var user=CC.LoadData("google.me");if(user!==undefined){if(callback){var json=JSON.parse(user);callback(json.id,json.name)}}else if(callback){callback()}return user};TileSocialProfile.prototype.bufferGoogleInfo=function(priority,callback){var self=this;var user=TileSocialProfile.GetGoogleInfo(function(id,name){if(id&&name){self.setGoogleID(id);self.setName(name);self.bufferGoogleProfilePhoto(priority);if(callback){callback(self,true)}}});if(user===undefined){if(callback){callback(this,false)}return false}return true};TileSocialProfile.prototype.bufferFBProfilePhoto=function(priority){if(this.profilePhotoRequestedPriority>=-1){if(this.profilePhotoRequestedPriority!==priority){this.profilePhotoRequestedPriority=priority;CCAPIFacebook.RequestPhotoID(this,this.facebookID,priority)}}};TileSocialProfile.prototype.bufferTwitterProfilePhoto=function(priority){if(this.profilePhotoRequestedPriority>=-1){if(this.profilePhotoRequestedPriority!==priority){this.profilePhotoRequestedPriority=priority;CCAPITwitter.RequestPhotoID(this,this.twitterID,priority)
}}};TileSocialProfile.prototype.bufferGoogleProfilePhoto=function(priority){if(this.profilePhotoRequestedPriority>=-1){if(this.profilePhotoRequestedPriority!==priority){this.profilePhotoRequestedPriority=priority;CCAPIGoogle.RequestPhotoID(this,this.googleID,priority)}}};function FBPhotosCallback(scene,priority,refresh,previousPhotoID){this.scene=scene;this.priority=priority;this.refreshing=refresh;this.previousPhotoID=previousPhotoID}FBPhotosCallback.prototype.run=function(){this.scene.parseFBPhotos(this.reply.state,this.reply.url,this.reply.data,this.priority,this.refreshing,this.previousPhotoID)};TileSocialProfile.prototype.bufferTaggedPhotos=function(priority,refresh){if(refresh){this.taggedPhotosRefreshing=true}var fbRequest=this.facebookID;fbRequest+="/photos";var fbCallback=new FBPhotosCallback(this,1,refresh,false);CCAPIFacebook.Request(fbCallback,fbRequest,1,refresh,.5,12)};TileSocialProfile.prototype.parseFBPhotos=function(state,requestURL,response,priority,refreshing,previousPhotoID){var taggedPhotos=this.taggedPhotos;if(this.taggedPhotosRefreshing){if(!refreshing){return}if(previousPhotoID){return}this.taggedPhotosRefreshing=false;taggedPhotos.clear()}if(state<CCURLRequest.Succeeded){if(this.photosDownloadedCallback){this.photosDownloadedCallback.run()}return}function PhotoData(inPhotoID,inThumbnailURL,inPhotoURL){this.photoID=inPhotoID;this.thumbnailURL=String.RemoveBetween(inThumbnailURL,"http","://");this.photoURL=String.RemoveBetween(inPhotoURL,"http","://")}var downloadedPhotoData=[];var root=JSON.parse(response);if(root){var i,jsonObject;{var jsonData=root.data;if(jsonData){var length=jsonData.length;for(i=0;i<length;++i){jsonObject=jsonData[i];var jsonPhotoID=jsonObject.id;var jsonThumbnailURL=jsonObject.picture;var jsonPhotoURL=jsonObject.source;if(!jsonPhotoID||!jsonThumbnailURL||!jsonPhotoURL){continue}downloadedPhotoData.add(new PhotoData(jsonPhotoID,jsonThumbnailURL,jsonPhotoURL))}}}var photoIndex=0;if(previousPhotoID){for(i=0;i<taggedPhotos.length;++i){var taggedPhoto=taggedPhotos.list[i];var photoID=taggedPhoto.photoID;if(photoID===previousPhotoID){photoIndex=i+1;break}}}for(i=0;i<downloadedPhotoData.length;++i){var downloadedData=downloadedPhotoData[i];var found=false;if(photoIndex<taggedPhotos.length){var downloadedPhotoID=downloadedData.photoID;var currentPhotoID=taggedPhotos.list[photoIndex].photoID;if(currentPhotoID===downloadedPhotoID){found=true}}if(!found){var newPhoto=new PhotoData(downloadedData.photoID,downloadedData.thumbnailURL,downloadedData.photoURL);taggedPhotos.insert(newPhoto,photoIndex)}photoIndex++}if(this.photosDownloadedCallback){this.photosDownloadedCallback.run()}{jsonObject=root.paging;if(jsonObject){var url=jsonObject.next;if(url&&url.length>0){var currentURL=String.SplitBetween(requestURL,"until=","&");var nextURL=String.SplitBetween(url,"until=","&");if(currentURL!==nextURL){var fbCallback=new FBPhotosCallback(this,1,refreshing,downloadedPhotoData.last().photoID);CCAPIFacebook.RequestFBURL(fbCallback,url,priority,refreshing,1)}else{}}}}}};function SceneUIBack(parentScene,callback,editorButton){this.construct();this.callback=callback;this.editorButton=editorButton;{this.setParent(parentScene);parentScene.linkScene(this)}{var parentCameraIndex=gEngine.findCameraIndex(parentScene.camera);var camera=gEngine.newSceneCamera(this,parentCameraIndex+1);this.camera.setupViewport(0,0,1,1)}gEngine.addScene(this);CCEngine.EnableBackButton(this)}ExtendPrototype(SceneUIBack,CCSceneAppUI);SceneUIBack.prototype.deleteLater=function(){if(!this.disabledBackButton){this.disabledBackButton=true}this.CCSceneAppUI_deleteLater()};CCSceneBase.prototype.deleteLaterFromParent=function(){this.close()};SceneUIBack.prototype.handleBackButton=function(){if(!this.disabledBackButton){this.disabledBackButton=true;this.close();this.callback();return true}return false};SceneUIBack.prototype.setup=function(){var self=this;var camera=this.camera;camera.setCameraWidth(640,false);camera.useSceneCollideables(this);var tile;{tile=new CCTile3DButton(this);this.tileBack=tile;if(this.editorButton){tile.setupTexturedWidth(camera.cameraWidth*.1,"editor_tile_back.jpg",function(){tile.setPositionX(camera.cameraHWidth+tile.collisionBounds[0]);self.requestResize()})}else{tile.setupTexturedWidth(camera.cameraWidth*.085,"ui_back.png",function(){self.requestResize()})}tile.setColour(gColour.set(1,0));tile.setColourAlpha(1,true);tile.setDrawOrder(204);tile.onRelease.push(function(){self.close();self.callback()});this.addTile(tile,0)}};SceneUIBack.prototype.render=function(camera,pass,alpha){};SceneUIBack.prototype.resize=function(){this.CCSceneAppUI_resize();var camera=this.camera;if(this.tileBack){var tile=this.tileBack;tile.setPositionY(camera.cameraHHeight-tile.collisionBounds[1]);if(this.editorButton){tile.setTileMovementX(camera.targetWidth*.5-tile.collisionBounds[0])}else{tile.setPositionX(camera.cameraHWidth-tile.collisionBounds[0])}}};SceneUIBack.prototype.touchPressed=function(touch){return this.CCSceneAppUI_touchPressed(touch)};SceneUIBack.prototype.touchMoving=function(touch,touchDelta){return false};SceneUIBack.prototype.touchReleased=function(touch,touchAction){return this.CCSceneAppUI_touchReleased(touch,touchAction)};SceneUIBack.prototype.close=function(){var self=this;var tile=this.tileBack;tile.setColourAlpha(0,true,function(){self.deleteLater()});if(this.editorButton){var camera=this.camera;if(camera){tile.setTileMovementX(camera.targetWidth*.5+tile.collisionBounds[0])}}};function SceneUIImage(parentScene){this.construct();{parentScene.linkScene(this)}{var camera=gEngine.newSceneCamera(this);this.camera.setupViewport(0,0,1,1)}gEngine.addScene(this);this.open=true}ExtendPrototype(SceneUIImage,CCSceneAppUI);SceneUIImage.prototype.setup=function(){var self=this;var camera=this.camera;camera.setCameraWidth(640,false);camera.useSceneCollideables(this);var tile;{tile=new CCTile3DButton(self);tile.setupTile(camera.targetWidth,camera.targetHeight);tile.setColour(gColour.set(.25,0));tile.setColourAlpha(.95,true);tile.setDrawOrder(203);this.cameraStickyTiles.add(tile);this.tileBackground=tile}{tile=new CCTile3DButton(this);this.tileHelp=tile;tile.setupTexturedFit(camera.targetWidth,camera.targetHeight,false,SceneManagerGame.HelpImage);tile.setTileScale(0);tile.setTileScale(1,true);tile.setColour(gColour.set(1,0));tile.setColourAlpha(1,true);tile.setDrawOrder(206);tile.onRelease.push(function(){self.close()});this.addTile(tile,0)}};SceneUIImage.prototype.handleBackButton=function(){if(this.open){this.close();return true}return false};SceneUIImage.prototype.render=function(camera,pass,alpha){this.CCSceneAppUI_render(camera,pass,alpha)};SceneUIImage.prototype.resize=function(){this.CCSceneAppUI_resize();var camera=this.camera;this.tileBackground.setTileSize(camera.targetWidth,camera.targetHeight);this.tileHelp.setTileTextureFit(camera.targetWidth,camera.targetHeight)};SceneUIImage.prototype.updateControls=function(controls){this.CCSceneAppUI_updateControls(controls);return true};SceneUIImage.prototype.touchMovementAllowed=function(touch,touchDelta){return false};SceneUIImage.prototype.close=function(){if(this.open){this.open=false;var self=this;var tile=this.tileHelp;tile.setColourAlpha(0,true,function(){self.deleteLater()});tile.setTileScale(4,true);this.tileBackground.setColourAlpha(0,true)}};function AlertsManager(){}AlertsManager.AlertsList=[];AlertsManager.RemovingAlert=function(inScene){var AlertsList=AlertsManager.AlertsList;AlertsList.remove(inScene)};AlertsManager.Hide=function(id){var AlertsList=AlertsManager.AlertsList;var found=false;for(var i=0;i<AlertsList.length;++i){var alert=AlertsList[i];if(alert.title===id||alert.message===id){alert.close();AlertsList.remove(alert);break}}};AlertsManager.ModalAlert=function(message,priority){var AlertsList=AlertsManager.AlertsList;if(!priority){priority=1}var found=false;var i,alert;for(i=0;i<AlertsList.length;++i){alert=AlertsList[i];if(alert.message===message){found=true;break}}if(!found){alert=new SceneUIAlert(message);alert.modal=priority;alert.open();AlertsList.add(alert)}for(i=0;i<AlertsList.length;++i){alert=AlertsList[i];if(!alert.modal||alert.modal<priority){AlertsManager.Hide(alert.message);--i}}};AlertsManager.ConfirmationAlert=function(message,callback){var AlertsList=AlertsManager.AlertsList;var found=false;var i,alert;for(i=0;i<AlertsList.length;++i){alert=AlertsList[i];if(alert.message===message){found=true;break}}if(!found){alert=new SceneUIAlert(message,true);alert.closeCallback=callback;alert.open();AlertsList.add(alert)}};AlertsManager.InputAlert=function(message,callback,inputOptions){var AlertsList=AlertsManager.AlertsList;var found=false;var i,alert;for(i=0;i<AlertsList.length;++i){alert=AlertsList[i];if(alert.message===message){found=true;break}}if(!found){alert=new SceneUIAlert(message,true,true);alert.closeCallback=callback;if(!inputOptions){inputOptions={}}alert.inputOptions=inputOptions;alert.open();AlertsList.add(alert)}};AlertsManager.TimeoutAlert=function(message,timeout){var AlertsList=AlertsManager.AlertsList;var found=false;var i,alert;for(i=0;i<AlertsList.length;++i){alert=AlertsList[i];if(alert.message===message){found=true;break}}if(!found){alert=new SceneUIAlert(message);if(timeout){alert.setTimeout(timeout)}alert.open();AlertsList.add(alert)}};AlertsManager.Alert=function(message,callback,options){var AlertsList=AlertsManager.AlertsList;var found=false;var i,alert;for(i=0;i<AlertsList.length;++i){alert=AlertsList[i];if(alert.message===message){found=true;break}}if(!found){alert=new SceneUIAlert(message,false,false,options);if(callback){alert.closeCallback=callback}alert.open();AlertsList.add(alert)}};AlertsManager.Notification=function(title,message,callback,timeout,colour,scale){var AlertsList=AlertsManager.AlertsList;var i,alert;for(i=0;i<AlertsList.length;++i){alert=AlertsList[i];if(alert.title===title){alert.close();AlertsList.remove(alert);continue}}if(!scale){scale=1}if(CCEngine.IsMobile()){scale*=2}var height=24*scale;var alertY=480*.5*.75-height*.5;for(i=0;i<AlertsList.length;++i){alert=AlertsList[i];if(alert.isNotification){var y=alert.tileAlert.position[1];if(y>=alertY){alertY=y-alert.tileAlert.collisionBounds[1]-height*.5}}}{alert=new SceneUINotification(title,message,height);if(callback){alert.closeCallback=callback}if(timeout){alert.setTimeout(timeout)}alert.setY(alertY);if(scale){alert.scale=scale;alert.requestResize()}if(colour){alert.setColour(colour)}alert.open();AlertsList.add(alert)}};AlertsManager.UserMessage=function(userID,message,callback,timeout,colour){var AlertsList=AlertsManager.AlertsList;var i,alert;for(i=0;i<AlertsList.length;++i){alert=AlertsList[i];if(alert.title===userID){alert.close();AlertsList.remove(alert);continue}}{alert=new SceneUINotification(userID,message,24,userID);if(callback){alert.closeCallback=callback}if(timeout){alert.setTimeout(timeout)}if(colour){alert.setColour(colour)}alert.open();AlertsList.add(alert)}};function SceneUIAlert(message,confirmationRequired,inputRequired,confirmationOptions){this.construct();this.cameraCentered=true;gEngine.addScene(this);this.message=message;var self=this;this.onKeyboardFunction=function(event,key,pressed){return self.onKeyboard(event,key,pressed)};gEngine.controls.requestKeyboard(this.onKeyboardFunction,inputRequired);if(inputRequired){this.inputRequired=true;this.inputBlinkTimer=0}else if(confirmationRequired){this.confirmationRequired=true}if(confirmationOptions){this.confirmationOptions=confirmationOptions;this.confirmationTiles=[]}}ExtendPrototype(SceneUIAlert,CCSceneAppUI);SceneUIAlert.prototype.deleteLater=function(){AlertsManager.RemovingAlert(this);if(this.onKeyboardFunction){gEngine.controls.removeKeyboard(this.onKeyboardFunction);delete this.onKeyboardFunction}this.CCSceneAppUI_deleteLater()};SceneUIAlert.prototype.setup=function(){var self=this;var camera=gEngine.newSceneCamera(this,null,null,true);camera.setupViewport(0,0,1,1);camera.setCameraWidth(640,false);camera.useSceneCollideables(this);var tile;{tile=new CCTile3DButton(this);tile.setupTile(camera.targetWidth,camera.targetHeight);tile.setColour(gColour.set(.1,0));tile.setColourAlpha(.9,true);tile.setDrawOrder(204);this.cameraStickyTiles.add(tile);this.tileBackground=tile}{tile=new CCTile3DButton(this);tile.setupText(" ",1,true,true);tile.setColour(gColour.setRGBA(.05,.05,.05,0));tile.setTextColour(gColour.set(1,0));tile.setDrawOrder(205);this.tileAlert=tile}this.menuTiles=[];this.requestResize()};SceneUIAlert.prototype.updateScene=function(delta){var updated=this.CCSceneAppUI_updateScene(delta);if(this.inputRequired){this.inputBlinkTimer+=delta;var rate=.5;if(this.inputBlinkTimer>rate){this.inputBlinkTimer-=rate;this.tileAlert.textObject.setEndMarker(!this.tileAlert.textObject.getEndMarker())}}return updated};SceneUIAlert.prototype.render=function(camera,pass,alpha){this.CCSceneAppUI_render(camera,pass,alpha)};SceneUIAlert.prototype.resize=function(){this.CCSceneAppUI_resize();var camera=this.camera;var tile,i;{var textHeight;if(this.inputOptions&&this.inputOptions.height!==undefined){textHeight=this.inputOptions.height}else{textHeight=.5}tile=this.tileAlert;tile.setTileSize(camera.targetWidth,camera.targetHeight*.3);tile.setTextHeight(tile.collisionBounds[1]*textHeight)}if(this.tileBackground){this.tileBackground.setTileSize(camera.targetWidth,camera.targetHeight)}if(this.confirmationTiles){var confirmationOptionsWidth=camera.targetWidth*.5;var confirmationOptionsHeight=confirmationOptionsWidth*.1;this.tileAlert.setTextPosition(undefined,confirmationOptionsHeight*.75);var confirmationOptionsTileWidth=confirmationOptionsWidth/this.confirmationOptions.length;for(i=0;i<this.confirmationTiles.length;++i){tile=this.confirmationTiles[i];tile.setTileSize(confirmationOptionsTileWidth,confirmationOptionsHeight);tile.setTextHeight(tile.collisionSize.height*.66)}var x=-confirmationOptionsWidth*.5;for(i=0;i<this.confirmationTiles.length;++i){tile=this.confirmationTiles[i];x+=tile.collisionBounds[0];tile.setPositionX(x);tile.setPositionY(-tile.collisionBounds[1]);x+=tile.collisionBounds[0]}}var menuTiles=this.menuTiles;for(i=0;i<menuTiles.length;++i){tile=menuTiles[i];if(i===0){tile.setPositionXYZ(camera.cameraHWidth-tile.collisionBounds[0],camera.cameraHHeight-tile.collisionBounds[1],0)}else{tile.positionTileBelow(menuTiles[i-1])}}};SceneUIAlert.prototype.updateControls=function(controls){this.CCSceneAppUI_updateControls(controls);return true};SceneUIAlert.prototype.touchMovementAllowed=function(touch,touchDelta){return false};SceneUIAlert.prototype.setTimeout=function(timeout){var self=this;var timer=new CCTimer;timer.onTime.push(function(){self.close()});timer.start(timeout);this.timers.push(timer)};SceneUIAlert.prototype.open=function(){var self=this;var i;var tile=this.tileAlert;tile.setTextColourAlpha(1,true);tile.setColourAlpha(.95,true);tile.setText(this.message);tile.setTextBlinking(true);var camera=this.camera;tile.setPositionX(camera.targetWidth*.5+tile.collisionSize.width);if(CCEngine.DeviceType!=="Web"){if(this.inputRequired){tile.setPositionY(camera.targetHeight*.25)}}tile.setTileMovementX(0);if(this.confirmationOptions){var OptionFunction=function(index){return function(){self.closeCallback(index);self.close()}};var TimerFunction=function(tile,i){return function(){tile.setTextColourAlpha(1,true);tile.setColourAlpha(.95,true)}};for(i=0;i<this.confirmationOptions.length;++i){tile=new CCTile3DButton(this);tile.setTileTexture("editor_tile_background.jpg");tile.setText(this.confirmationOptions[i]);tile.setColour(gColour.set(1,0));tile.setTextColour(gColour.set(0,0));var timer=new CCTimer;timer.onTime.push(new TimerFunction(tile,i));timer.start(.5+i*.5);this.timers.push(timer);tile.setDrawOrder(205);tile.onRelease.push(new OptionFunction(i+1));this.addTile(tile,0);this.confirmationTiles.push(tile)}}var menuTiles=this.menuTiles;for(i=0;i<menuTiles.length;++i){menuTiles[i].deleteLater()}menuTiles.length=0;if(this.modal){}else{CCEngine.EnableBackButton(this);if(this.inputRequired||this.confirmationRequired){{tile=new CCTile3DButton(this);tile.setupTexturedWidth(camera.cameraWidth*.1,"editor_tile_cross.jpg",function(){self.showMenu()});tile.setColour(gColour.setRGBA(1,1,1,0));tile.setDrawOrder(220);tile.onRelease.push(function(){if(self.closeCallback){self.closeCallback(false)}self.close()});this.addTile(tile,0);menuTiles.add(tile)}{tile=new CCTile3DButton(this);tile.setupTexturedWidth(camera.cameraWidth*.1,"editor_tile_tick.jpg",function(){self.showMenu()});tile.setColour(gColour.setRGBA(1,1,1,0));tile.setDrawOrder(220);tile.onRelease.push(function(){if(self.closeCallback){if(self.inputRequired){var text=self.tileAlert.getText();text=text.formatSpacesAndTabs();self.closeCallback(text)}else if(self.confirmationRequired){self.closeCallback(true)}}self.close()});this.addTile(tile,0);menuTiles.add(tile)}}else{tile=new CCTile3DButton(this);tile.setupTexturedWidth(camera.cameraWidth*.1,"editor_tile_back.jpg",function(){self.showMenu()});tile.setColour(gColour.setRGBA(1,1,1,0));tile.setDrawOrder(205);tile.onRelease.push(function(){if(self.closeCallback){self.closeCallback()}self.close()});this.addTile(tile,0);menuTiles.add(tile)}}this.showMenu()};SceneUIAlert.prototype.showMenu=function(){if(this.enabled){var camera=this.camera;var menuTiles=this.menuTiles;this.requestResize();var i;for(i=0;i<menuTiles.length;++i){tile=menuTiles[i];tile.setPositionX(camera.targetWidth*.5+tile.collisionSize.width);tile.translateTileMovementX(-tile.collisionSize.width*1.5);tile.setColourAlpha(1,true);tile.setCollideable(true)}}};SceneUIAlert.prototype.close=function(){var i;var self=this;if(this.tileBackground){this.tileBackground.setColourAlpha(0,true)}var tile=this.tileAlert;tile.setTextColourAlpha(0,true);tile.setColourAlpha(0,true,function(){self.deleteLater()});var camera=this.camera;tile.translateTileMovementX(-(camera.targetWidth*.5)-tile.collisionSize.width);if(this.confirmationTiles){for(i=0;i<this.confirmationTiles.length;++i){tile=this.confirmationTiles[i];tile.setColourAlpha(0,true);tile.setTextColourAlpha(0,true);tile.setCollideable(false);tile.translateTileMovementX(-(camera.targetWidth*.5)-tile.collisionSize.width)}}var menuTiles=this.menuTiles;for(i=0;i<menuTiles.length;++i){tile=menuTiles[i];tile.translateTileMovementX(camera.targetWidth*.5+tile.collisionSize.width);tile.setColour(gColour.setRGBA(1,1,1,0),true);tile.setCollideable(false)}};SceneUIAlert.prototype.handleBackButton=function(){if(!this.modal){if(!this.disabledBackButton){if(this.closeCallback){this.closeCallback(false)}this.close();return true}}return false};SceneUIAlert.prototype.onKeyboard=function(event,key,pressed){if(event.metaKey){return false}if(event.ctrlKey){return false}if(pressed){var text=this.tileAlert.getText();if(key==="return"){if(this.closeCallback){text=text.formatSpacesAndTabs();this.closeCallback(text)}this.close();return true}else if(key==="backspace"){if(text.length>0){text=text.substring(0,text.length-1);this.tileAlert.setText(text)}return true}else if(key.length===1){var allowed=false;if(key>="a"&&key<="z"||key>="A"&&key<="Z"){if(this.inputOptions.letter||this.inputOptions.letter===undefined){allowed=true}}else if(key>="0"&&key<="9"){if(this.inputOptions.number||this.inputOptions.number===undefined){allowed=true}}else if(key===" "){if(this.inputOptions.space){allowed=true}}else if(key==="."){if(this.inputOptions.dot){allowed=true}}else if(key===","){if(this.inputOptions.comma){allowed=true}}else if(key==="-"){if(this.inputOptions.minus){allowed=true}}else if(key==="!"||key==="("||key===")"||key==='"'||key==="'"||key===":"){if(this.inputOptions.functional){allowed=true}}if(allowed){if(this.inputOptions.length!==undefined){if(text.length<this.inputOptions.length){text+=key;this.tileAlert.setText(text)}}else if(text.length<24){text+=key;this.tileAlert.setText(text)}}return true}}return false};function SceneUINotification(title,message,height,userID){this.construct();this.cameraCentered=true;this.title=title;this.message=message;if(!height){height=32}this.height=height;this.userID=userID;this.isNotification=true;gEngine.addScene(this);CCEngine.EnableBackButton(this)}ExtendPrototype(SceneUINotification,SceneUIAlert);SceneUINotification.prototype.setup=function(){var self=this;var camera=gEngine.newSceneCamera(this,null,null,true);camera.setupViewport(0,0,1,1);camera.setCameraHeight(480,false);camera.useSceneCollideables(this);var tile;if(this.userID){tile=new TileSocialProfile(this,true);tile.setTileSize(camera.targetHeight*.25);tile.setColourAlpha(0);tile.setDrawOrder(205);var userInfo=MultiplayerManager.GetUserInfo(this.userID);if(userInfo){if(userInfo.twitter&&userInfo.twitter.username){tile.setTwitterID(userInfo.twitter.username);tile.bufferTwitterProfilePhoto(2);this.nickname="@"+userInfo.twitter.username.split(" ")[0]}else if(userInfo.facebook&&userInfo.facebook.facebookID.length>0){tile.setFacebookID(userInfo.facebook.facebookID);tile.bufferFBProfilePhoto(2);this.nickname=userInfo.facebook.name.split(" ")[0]}else if(userInfo.google&&userInfo.google.id){tile.setGoogleID(userInfo.google.id);tile.bufferGoogleProfilePhoto(2);this.nickname=userInfo.google.name.split(" ")[0]}}else if(this.userID==="iBot"){tile.setTwitterID("iBot");tile.nickname="@iBot";tile.APIDownloadedPhoto("profile_ibot.jpg","iBot")}this.tileProfile=tile}{tile=new CCTile3DButton(this);tile.setupText(" ",1,true,true);tile.setTileTexture("editor_tile_background.jpg",function(){self.requestResize()});tile.setColour(gColour.setRGBA(.25,.25,.25,0));tile.setTextColour(gColour.set(1,0));tile.setDrawOrder(205);tile.onRelease.push(function(){self.close();if(self.closeCallback){self.closeCallback()}});this.addTile(tile,0);this.tileAlert=tile}this.menuTiles=[];this.requestResize()};SceneUINotification.prototype.setY=function(y){this.yPosition=y;this.requestResize()};SceneUINotification.prototype.setColour=function(colour){this.colour=colour;this.tileAlert.setColour(colour);this.tileAlert.setColourAlpha(0)};SceneUINotification.prototype.updateControls=function(controls){return this.CCSceneAppUI_updateControls(controls)};SceneUINotification.prototype.resize=function(){this.CCSceneAppUI_resize();if(this.tileAlert){var camera=this.camera;var tile=this.tileAlert;if(this.nickname){tile.setText(this.nickname+": "+this.message)}else{tile.setText(this.message)}tile.setTextHeight(this.height,true);tile.setTileSize(tile.collisionSize.width*1.1,tile.collisionSize.height*1.5);if(this.opened){this.open()}}};SceneUINotification.prototype.open=function(){this.opened=true;var tile;if(this.tileAlert.getTileTextureImage()){var camera=this.camera;var y=camera.targetHeight*.5;if(this.yPosition){y=this.yPosition}if(this.tileProfile){tile=this.tileProfile;tile.setColourAlpha(1,true);tile.setPositionY(y-tile.collisionBounds[1]);tile.setPositionX(-(camera.targetWidth*.5)-tile.collisionSize.width);tile.setTileMovementX(-camera.targetWidth*.5+tile.collisionBounds[0]);tile=this.tileAlert;tile.positionTileBelowY(this.tileProfile)}else{tile=this.tileAlert;tile.setPositionY(y)}tile.setTextColourAlpha(1,true);if(this.colour){tile.setColour(this.colour,true)}else{tile.setColourAlpha(.85,true)}tile.setTextBlinking(true);tile.setPositionX(-(camera.targetWidth*.5)-tile.collisionSize.width);tile.setTileMovementX(-camera.targetWidth*.5+tile.collisionBounds[0])}};SceneUINotification.prototype.close=function(){this.opened=false;var self=this;var tile=this.tileAlert;tile.setTextColourAlpha(0,true);tile.setColourAlpha(0,true,function(){self.deleteLater()});var camera=this.camera;if(camera){tile.translateTileMovementX(-(camera.targetWidth*.5)-tile.collisionSize.width);if(this.tileProfile){tile=this.tileProfile;tile.setTextColourAlpha(0,true);tile.translateTileMovementX(-(camera.targetWidth*.5)-tile.collisionSize.width)}}};function SceneVisualJSEditor(parentScene){this.construct();{this.setParent(parentScene)}gEngine.addScene(this);var self=this;this.sceneUIBack=new SceneUIBack(this,function(){self.close()},true)}ExtendPrototype(SceneVisualJSEditor,CCSceneAppUI);SceneVisualJSEditor.prototype.setup=function(){var self=this;var camera=gEngine.newSceneCamera(this);camera.setupViewport(0,0,1,1);camera.setCameraWidth(640,false);{var tile=new CCTile3DButton(self);tile.setupTile();tile.setTileTexture("editor_tile_background.jpg");tile.setColour(gColour.set(.5,0));tile.setColourAlpha(.95,true);tile.setDrawOrder(200);this.cameraStickyTiles.add(tile);this.tileBackground=tile}this.jsClasses=[];self.requestResize()};SceneVisualJSEditor.prototype.updateScene=function(delta){var updated=this.CCSceneAppUI_updateScene(delta);return updated};SceneVisualJSEditor.prototype.render=function(camera,pass,alpha){this.CCSceneAppUI_render(camera,pass,alpha)};SceneVisualJSEditor.prototype.resize=function(){this.CCSceneAppUI_resize();var camera=this.camera;var tile;{tile=this.tileBackground;tile.setTileSize(camera.targetWidth,camera.targetHeight)}var y=0;var jsClasses=this.jsClasses;for(var classIndex=0;classIndex<jsClasses.length;++classIndex){var jsClass=jsClasses[classIndex];tile=jsClass.tile;if(classIndex>0){y-=tile.collisionBounds[1]}tile.setPositionY(y);y-=tile.collisionBounds[1];y-=5;var prototypes=jsClass.prototypes;for(var prototypeIndex=0;prototypeIndex<prototypes.length;++prototypeIndex){var jsPrototype=prototypes[prototypeIndex];tile=jsPrototype.tile;y-=tile.collisionBounds[1];tile.setPositionY(y);var x=tile.collisionBounds[0];var parameters=jsPrototype.parameters;for(var parameterIndex=0;parameterIndex<parameters.length;++parameterIndex){x+=5;var jsParameter=parameters[parameterIndex];tile=jsParameter.tile;x+=tile.collisionBounds[0];tile.setPositionXY(x,y);x+=tile.collisionBounds[0]}y-=tile.collisionBounds[1];var lines=jsPrototype.lines;for(var lineIndex=0;lineIndex<lines.length;++lineIndex){var jsLine=lines[lineIndex];x=0;y-=15;var tokens=jsLine.tokens;for(var tokenIndex=0;tokenIndex<tokens.length;++tokenIndex){var jsToken=tokens[tokenIndex];tile=jsToken.tile;x+=tile.collisionBounds[0];tile.setPositionXY(x,y);x+=tile.collisionBounds[0];x+=5}}y-=15}y-=30}};SceneVisualJSEditor.prototype.touchPressed=function(touch){if(this.CCSceneAppUI_touchPressed(touch)){return true}return true};SceneVisualJSEditor.prototype.touchMoving=function(touch,touchDelta){return this.CCSceneAppUI_touchMoving(touch,touchDelta)};SceneVisualJSEditor.prototype.touchReleased=function(touch,touchAction){return this.CCSceneAppUI_touchReleased(touch,touchAction)};SceneVisualJSEditor.prototype.refreshCameraView=function(){var left=CC_MAXFLOAT;var right=-CC_MAXFLOAT;var top=-CC_MAXFLOAT;var bottom=CC_MAXFLOAT;var tiles=this.tiles;for(var i=0;i<tiles.length;++i){var tile=tiles[i];var leftX=tile.getTileMovementTarget()[0]-tile.collisionBounds[0];var rightX=tile.getTileMovementTarget()[0]+tile.collisionBounds[0];var topY=tile.getTileMovementTarget()[1]+tile.collisionBounds[1];var bottomY=tile.getTileMovementTarget()[1]-tile.collisionBounds[1];if(leftX<left){left=leftX}if(rightX>right){right=rightX}if(topY>top){top=topY}if(bottomY<bottom){bottom=bottomY}}var camera=this.camera;this.sceneLeft=left+camera.targetWidth*.4;this.sceneRight=right;this.sceneTop=top-camera.targetHeight*.4;this.sceneBottom=bottom;if(this.sceneBottom>this.sceneTop){this.sceneBottom=this.sceneTop}};SceneVisualJSEditor.prototype.lockCameraView=function(){if(this.cameraScrolling){return}var camera=this.camera;if(camera.targetLookAt[0]<this.sceneLeft){camera.targetLookAt[0]=this.sceneLeft;camera.flagUpdate()}if(camera.targetLookAt[0]>this.sceneRight){camera.targetLookAt[0]=this.sceneRight;camera.flagUpdate()}if(camera.targetLookAt[1]>this.sceneTop){camera.targetLookAt[1]=this.sceneTop;camera.flagUpdate()}if(camera.targetLookAt[1]<this.sceneBottom){camera.targetLookAt[1]=this.sceneBottom;camera.flagUpdate()}};SceneVisualJSEditor.prototype.open=function(filename,onClose){this.onClose=onClose;var self=this;var camera=this.camera;AlertsManager.ModalAlert("loading...");var url=MultiplayerManager.GetAssetURL(filename);gURLManager.requestURL(url,null,function(status,responseText){if(status>=CCURLRequest.Succeeded&&responseText&&responseText.length>0){self.parseJS(responseText)}else{AlertsManager.Hide("loading...");AlertsManager.TimeoutAlert("failed to load :(",2);self.close()}},0,filename,-1,0)};SceneVisualJSEditor.prototype.parseJS=function(jsData){var jsClasses=this.jsClasses;var startIndex,j,character;var jsPrototypes=jsData.split(".prototype.");for(var prototypeIndex=1;prototypeIndex<jsPrototypes.length;++prototypeIndex){var jsClassName=jsPrototypes[prototypeIndex-1];{startIndex=0;for(j=jsClassName.length-1;j>=0;--j){character=jsClassName[j];if(/[^a-zA-Z0-9]/.test(character)){startIndex=j+1;break}}jsClassName=jsClassName.substr(startIndex,jsClassName.length)}var jsClass=this.findJSClass(jsClassName);if(!jsClass){jsClass={};jsClass.name=jsClassName;jsClass.prototypes=[];jsClasses.push(jsClass)}var jsPrototypeName=jsPrototypes[prototypeIndex];jsPrototypeName=String.SplitBefore(jsPrototypeName," ");jsPrototypeName=String.SplitBefore(jsPrototypeName,"=");jsPrototypeName=String.SplitBefore(jsPrototypeName,"\n");jsPrototype={};jsPrototype.name=jsPrototypeName;jsClass.prototypes.add(jsPrototype);jsPrototype.parameters=[];var jsParameters=jsPrototypes[prototypeIndex];jsParameters=String.SplitAfter(jsParameters,"(");jsParameters=String.SplitBefore(jsParameters,")");if(jsParameters.length>0){var parametersSplit=jsParameters.split(",");for(parameterIndex=0;parameterIndex<parametersSplit.length;++parameterIndex){var jsParmaterName=parametersSplit[parameterIndex];jsParmaterName.replace(" ","");if(jsParmaterName.length===0){jsParmaterName=" "}jsParameter={};jsParameter.name=jsParmaterName;jsPrototype.parameters.push(jsParameter)}}jsPrototype.lines=[];var code=jsPrototypes[prototypeIndex];code=String.SplitAfter(code,"{");code=String.SplitBefore(code,"}");var lines=code.split(";");for(var lineIndex=0;lineIndex<lines.length;++lineIndex){var line=lines[lineIndex];startIndex=-1;for(j=0;j<line.length;++j){character=line[j];if(/^[a-zA-Z0-9]/.test(character)){startIndex=j;break}}if(startIndex>=0){line=line.substr(startIndex);var jsLine={};jsLine.line=line;jsLine.tokens=[];jsPrototype.lines.push(jsLine);var parsingToken=false;var tokenType=null;for(j=0;j<line.length;++j){character=line[j];if(/^[a-zA-Z0-9]/.test(character)){if(!parsingToken){parsingToken=true;startIndex=j}}else{if(!parsingToken){if(character==="*"||character==="/"||character==="%"||character==="="){parsingToken=true;startIndex=j}}else{if(character==="["){tokenType="array"}if(character==="."||character==="_"){}else{parsingToken=false;this.packageToken(jsLine.tokens,line,startIndex,j,tokenType)}}}}if(parsingToken){parsingToken=false;this.packageToken(jsLine.tokens,line,startIndex,line.length,tokenType)}}}}this.createJSTiles();this.requestResize();AlertsManager.Hide("loading...")};SceneVisualJSEditor.prototype.packageToken=function(tokensArray,codeLine,startIndex,endIndex,tokenType){var tokenName=codeLine.substr(startIndex,endIndex-startIndex);var jsToken={};jsToken.name=tokenName;tokensArray.push(jsToken);if(tokenType){jsToken.type=tokenType}};SceneVisualJSEditor.prototype.createJSTiles=function(){var jsClasses=this.jsClasses;var tile;for(var classIndex=0;classIndex<jsClasses.length;++classIndex){var jsClass=jsClasses[classIndex];tile=new CCTile3DButton(this);tile.setupText(jsClass.name,20,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.setColour(gColour.setRGBA(.5,.65,1,1));tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(210);this.addTile(tile);jsClass.tile=tile;var prototypes=jsClass.prototypes;for(var prototypeIndex=0;prototypeIndex<prototypes.length;++prototypeIndex){var jsPrototype=prototypes[prototypeIndex];tile=new CCTile3DButton(this);tile.setupText(jsPrototype.name,15,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.setColour(EditorManager.LightGreen);tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(210);this.addTile(tile);
jsPrototype.tile=tile;var parameters=jsPrototype.parameters;for(var parameterIndex=0;parameterIndex<parameters.length;++parameterIndex){var jsParameter=parameters[parameterIndex];tile=new CCTile3DButton(this);tile.setupText(jsParameter.name,15,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.setColour(gColour.setRGBA(.75,.75,.15,1));tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(210);this.addTile(tile);jsParameter.tile=tile}var lines=jsPrototype.lines;for(var lineIndex=0;lineIndex<lines.length;++lineIndex){var jsLine=lines[lineIndex];var tokens=jsLine.tokens;for(var tokenIndex=0;tokenIndex<tokens.length;++tokenIndex){var jsToken=tokens[tokenIndex];tile=new CCTile3DButton(this);tile.setupText(jsToken.name,15,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.setColour(gColour.setRGBA(.65,.75,1,1));tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(210);this.addTile(tile);jsToken.tile=tile}}}}this.requestResize()};SceneVisualJSEditor.prototype.findJSClass=function(className){var jsClasses=this.jsClasses;for(var i=0;i<jsClasses.length;++i){var jsClass=jsClasses[i];if(jsClass.name===className){return jsClass}}return null};SceneVisualJSEditor.prototype.close=function(){var self=this;this.tileBackground.setColourAlpha(0,true);var camera=this.camera;var tile=this.tileBackground;tile.setColourAlpha(0,true,function(){self.deleteLater()});self.sceneUIBack.close();if(this.onClose){this.onClose()}};function SceneJSMapEditor(parentScene){this.construct();this.setParent(parentScene);this.cameraCentered=true;gEngine.addScene(this);var self=this;this.onDragDropLoadFunction=function(file,event){self.onDragDropLoad(file,event)};gEngine.controls.onDragDropLoad.add(this.onDragDropLoadFunction);this.jsData="";this.jsClassPrototypes=[];this.map=new SceneGameBattleRoyale(null)}ExtendPrototype(SceneJSMapEditor,CCSceneAppUI);SceneJSMapEditor.prototype.deleteLater=function(){if(this.onDragDropLoadFunction){gEngine.controls.onDragDropLoad.remove(this.onDragDropLoadFunction);this.onDragDropLoadFunction=null}this.CCSceneAppUI_deleteLater()};SceneJSMapEditor.prototype.setup=function(){var self=this;var camera=gEngine.newSceneCamera(this);camera.setupViewport(0,0,1,1);camera.setCameraWidth(640,false);var tile;{tile=new CCTile3DButton(this);tile.setupTile(camera.targetWidth,camera.targetHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColour(gColour.set(.25,0));tile.setColourAlpha(.5,true);tile.setDrawOrder(204);this.cameraStickyTiles.add(tile);this.tileBackground=tile}{tile=new CCTile3DButton(this);tile.setupText(" ",1,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.setColour(gColour.setRGBA(.5,.65,1,0));tile.setTextColour(gColour.setRGBA(1,1,1,0));tile.setDrawOrder(210);this.tileAlert=tile}{tile=new CCTile3DButton(this);tile.setupTile(1);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setDrawOrder(210);this.tileModel=tile}this.menuTiles=[];this.requestResize()};SceneJSMapEditor.prototype.updateScene=function(delta){var updated=this.CCSceneAppUI_updateScene(delta);return updated};SceneJSMapEditor.prototype.render=function(camera,pass,alpha){this.CCSceneAppUI_render(camera,pass,alpha)};SceneJSMapEditor.prototype.resize=function(){this.CCSceneAppUI_resize();var camera=this.camera;var tile;{tile=this.tileModel;tile.setTileSize(camera.targetHeight*.65,camera.targetHeight*.65);if(!this.supportObj){if(tile.getTileTextureImage()){tile.setTileTexturedHeight(tile.collisionSize.height)}}}{tile=this.tileAlert;tile.setTileSize(camera.targetWidth,camera.targetHeight*.15);tile.setTextHeight(tile.collisionBounds[1]);tile.positionTileAbove(this.tileModel)}{this.tileBackground.setTileSize(camera.targetWidth,camera.targetHeight)}var menuTiles=this.menuTiles;for(var i=0;i<menuTiles.length;++i){tile=menuTiles[i];if(i===0){tile.setPositionXYZ(camera.cameraHWidth-tile.collisionBounds[0],camera.cameraHHeight-tile.collisionBounds[1],0)}else{tile.positionTileBelow(menuTiles[i-1])}}};SceneJSMapEditor.prototype.touchPressed=function(touch){var result=this.CCSceneAppUI_touchPressed(touch);return true};SceneJSMapEditor.prototype.touchMoving=function(touch,touchDelta){var result=this.handleTilesTouch(touch,this.controlsMovingVertical?CCControls.touch_movingVertical:CCControls.touch_movingHorizontal);if(result===CCSceneAppUI.tile_touchAction){return true}return true};SceneJSMapEditor.prototype.touchReleased=function(touch,touchAction){var result=this.CCSceneAppUI_touchReleased(touch,touchAction);return true};SceneJSMapEditor.prototype.open=function(){this.message=".js Map Editor";var self=this;var camera=this.camera;var i;var menuTiles=this.menuTiles;for(i=0;i<menuTiles.length;++i){menuTiles[i].deleteLater()}menuTiles.length=0;{{tile=new CCTile3DButton(this);tile.setupTexturedWidth(camera.cameraWidth*.1,"editor_tile_cross.jpg",function(){self.showMenu()});tile.setColour(gColour.setRGBA(1,1,1,0));tile.setDrawOrder(220);tile.onRelease.push(function(){if(self.closeCallback){self.closeCallback(false)}self.close()});this.addTile(tile,0);menuTiles.add(tile)}{tile=new CCTile3DButton(this);tile.setupTexturedWidth(camera.cameraWidth*.1,"editor_tile_tick.jpg",function(){self.showMenu()});tile.setColour(gColour.setRGBA(1,1,1,0));tile.setDrawOrder(220);tile.onRelease.push(function(){if(self.closeCallback){self.closeCallback(true,self.jsData)}self.close()});this.addTile(tile,0);menuTiles.add(tile)}}this.showMenu()};SceneJSMapEditor.prototype.showMenu=function(){if(this.enabled){var camera=this.camera;var menuTiles=this.menuTiles;this.requestResize();var tile;{tile=this.tileModel;tile.setColourAlpha(0,true);tile.setPositionX(camera.targetWidth*.5+tile.collisionSize.width);tile.setTileMovementX(0)}{tile=this.tileAlert;tile.setTextColourAlpha(1,true);tile.setColourAlpha(.85,true);tile.setText(this.message);tile.setPositionX(camera.targetWidth*.5+tile.collisionSize.width);tile.setTileMovementX(0)}for(var i=0;i<menuTiles.length;++i){tile=menuTiles[i];tile.setPositionX(camera.targetWidth*.5+tile.collisionSize.width);tile.translateTileMovementX(-tile.collisionSize.width*1.5);tile.setColourAlpha(1,true);tile.enabled=true}}};SceneJSMapEditor.prototype.close=function(){var self=this;var i;{var head=document.getElementsByTagName("head")[0];var script=document.getElementById("customjs");if(script){head.removeChild(script)}var jsClassPrototypes=this.jsClassPrototypes;for(i=0;i<jsClassPrototypes.length;++i){var classPrototype=jsClassPrototypes[i];var targetClass=window[classPrototype.name];for(var m in classPrototype.prototypes){targetClass.prototype[m]=classPrototype.prototypes[m]}}}this.tileBackground.setColourAlpha(0,true);var tile;{tile=this.tileModel;tile.setColourAlpha(0,true)}{tile=this.tileAlert;tile.setTextColourAlpha(0,true);tile.setColourAlpha(0,true,function(){self.deleteLater()})}var camera=this.camera;tile.translateTileMovementX(-(camera.targetWidth*.5)-tile.collisionSize.width);var menuTiles=this.menuTiles;for(i=0;i<menuTiles.length;++i){tile=menuTiles[i];tile.translateTileMovementX(camera.targetWidth*.5+tile.collisionSize.width);tile.setColour(gColour.setRGBA(1,1,1,0),true);tile.enabled=false}if(this.map){this.map.deleteLater()}};SceneJSMapEditor.prototype.setCallback=function(callback){this.closeCallback=callback};SceneJSMapEditor.prototype.onDragDropLoad=function(file,event){if(event&&event.target&&event.target.result){if(MultiplayerManager.LoggedIn){if(file.size>1024*1024){AlertsManager.TimeoutAlert("file size too large",2)}else{var filename=file.name;var data=event.target.result;this.prepareUpload(filename,data)}}}};SceneJSMapEditor.prototype.prepareUpload=function(filename,data){var self=this;var fileExtension=filename.getExtension();if(fileExtension==="js"){this.jsData+=data+"\n";var jsClassPrototypes=this.jsClassPrototypes;var prototypes=data.split(".prototype.");for(var i=1;i<prototypes.length;++i){var className=prototypes[i-1];var classNameStartIndex=0;for(var j=className.length-1;j>=0;--j){var character=className[j];if(/[^a-zA-Z0-9]/.test(character)){classNameStartIndex=j+1;break}}className=className.substr(classNameStartIndex,className.length);var found=false;var classPrototype;for(var classIndex=0;i<jsClassPrototypes.length;++i){classPrototype=jsClassPrototypes[classIndex];if(className===classPrototype.name){found=true;break}}if(!found){classPrototype={};classPrototype.name=className;classPrototype.prototypes=[];var sourceClass=window[className];for(var m in sourceClass.prototype){classPrototype.prototypes[m]=sourceClass.prototype[m]}jsClassPrototypes.push(classPrototype)}}var script=document.getElementById("customjs");if(!script){var head=document.getElementsByTagName("head")[0];script=document.createElement("script");script.id="customjs";head.appendChild(script)}script.type="text/javascript";script.text=data}else{AlertsManager.TimeoutAlert("only .js supported",2)}};SceneJSMapEditor.prototype.upload=function(filename,data){var self=this;EditorManager.EditorUploadJS(filename,data,function(fileID,filename){var uploaded=false;if(filename){if(MultiplayerManager.LoggedIn){}}if(!uploaded){AlertsManager.TimeoutAlert("failed to upload "+fileID+" :(",2)}})};function SceneAssetEditor(parentScene,supportObj,showLists,noSelect){MultiplayerManager.UpdateCallbacks.addOnce(this);this.construct();this.supportObj=supportObj;this.noSelect=noSelect;if(parentScene){this.setParent(parentScene);parentScene.linkScene(this)}this.cameraCentered=true;gEngine.addScene(this);var self=this;this.onDragDropLoadFunction=function(file,event){self.onDragDropLoad(file,event)};gEngine.controls.onDragDropLoad.add(this.onDragDropLoadFunction);if(showLists){if(supportObj){this.sceneUIListDBModels=new SceneUIListDBModels(this,function(){if(CCEngine.IsMobile()){AlertsManager.TimeoutAlert("Please visit playir.com to upload assets",10)}else{self.creatingNewModel=true;AlertsManager.Alert("drop in .fbx or .obj model",function(){self.creatingNewModel=false})}});this.sceneUIListDBModels.onSelected=function(info){if(info){self.setModel(info)}}}else{this.sceneUIListDBImages=new SceneUIListDBImages(this);this.sceneUIListDBImages.onSelected=function(imageInfo){if(self.onSelected){self.onSelected(imageInfo)}else{self.setImage(imageInfo)}}}}this.info={};this.sceneSettings=new SceneAssetEditorSettings(this);CCEngine.EnableBackButton(this);SceneAssetEditor.self=this}ExtendPrototype(SceneAssetEditor,CCSceneAppUI);SceneAssetEditor.prototype.deleteLater=function(){SceneAssetEditor.self=null;if(this.onDragDropLoadFunction){gEngine.controls.onDragDropLoad.remove(this.onDragDropLoadFunction);this.onDragDropLoadFunction=null}if(this.sceneUIListDBModels){this.sceneUIListDBModels.close();this.sceneUIListDBModels=null}if(this.sceneUIListDBImages){this.sceneUIListDBImages.close();this.sceneUIListDBImages=null}if(this.sceneSettings){this.sceneSettings.deleteLater();this.sceneSettings=null}this.CCSceneAppUI_deleteLater()};SceneAssetEditor.prototype.setup=function(){var self=this;var camera=gEngine.newSceneCamera(this);camera.setupViewport(0,0,1,1);camera.setCameraWidth(640,false);var tile;{tile=new CCTile3DButton(this);tile.setupTile(camera.targetWidth,camera.targetHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColour(gColour.set(.25,0));tile.setColourAlpha(.95,true);tile.setDrawOrder(204);this.cameraStickyTiles.add(tile);this.tileBackground=tile}{tile=new CCTile3DButton(this);tile.setupText(" ",1,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.setColour(gColour.setRGBA(.5,.65,1,0));tile.setTextColour(gColour.setRGBA(1,1,1,0));tile.setPositionX(camera.targetWidth*.5+tile.collisionSize.width);tile.setDrawOrder(210);this.tileAlert=tile}{tile=new CCTile3DButton(this);tile.setupTile(1);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setPositionY(-(camera.targetHeight*.5)-tile.collisionSize.height);tile.setDrawOrder(210);this.tileModel=tile}this.menuTiles=[];this.bottomTiles=[];this.requestResize()};SceneAssetEditor.prototype.syncUpdate=function(jsonData){if(jsonData.EditorModelCreated){if(this.onClose){var id=jsonData.EditorModelCreated;DBAssets.RemoveDBID(id);this.info.objectID=id;if(!this.onClose(this.info)){this.close()}}}};SceneAssetEditor.prototype.updateScene=function(delta){var updated=this.CCSceneAppUI_updateScene(delta);var tile=this.tileModel;if(tile.modelObject){tile.modelObject.model.animate(delta)}return updated};SceneAssetEditor.prototype.resize=function(){this.CCSceneAppUI_resize();var camera=this.camera;var i,tile;var idealAspectRatio=1.5;var aspectRatioAdjutment=camera.getAspectRatio()<1.25?camera.getAspectRatio()/idealAspectRatio:1;{tile=this.tileModel;var modelSize=camera.targetHeight*.65*aspectRatioAdjutment;tile.setTileSize(modelSize);if(!this.supportObj){if(tile.getTileTextureImage()){tile.setTileTexturedFit(tile.collisionSize.height,tile.collisionSize.height)}}}{tile=this.tileAlert;tile.setTileSize(camera.targetWidth,camera.targetHeight*.15);tile.setTextHeight(tile.collisionBounds[1]);var targetPosition=tile.getTileMovementTarget();targetPosition[1]=camera.targetHeight*.5-tile.collisionBounds[1];tile.setPosition(targetPosition)}{this.tileBackground.setTileSize(camera.targetWidth,camera.targetHeight)}var y=camera.cameraHHeight;var menuTiles=this.menuTiles;for(i=0;i<menuTiles.length;++i){tile=menuTiles[i];var x=tile.getTileMovementTarget()[0];y-=tile.collisionBounds[1];tile.setPositionY(y);y-=tile.collisionBounds[1];tile.setTileMovementX(x)}var bottomTiles=this.bottomTiles;var tileHeight=camera.targetHeight*.075;for(i=0;i<bottomTiles.length;++i){tile=bottomTiles[i];tile.setTileSize(tileHeight);if(i===0){tile.setPositionX(camera.cameraHWidth-tile.collisionBounds[0])}else{tile.positionTileLeftX(bottomTiles[i-1])}}this.showControls(false)};SceneAssetEditor.prototype.touchPressed=function(touch){var result=this.CCSceneAppUI_touchPressed(touch);return true};SceneAssetEditor.prototype.touchMoving=function(touch,touchDelta){var result=this.handleTilesTouch(touch,this.controlsMovingVertical?CCControls.touch_movingVertical:CCControls.touch_movingHorizontal);if(result===CCSceneAppUI.tile_touchAction){return true}else{var tile=this.tileModel;if(tile.modelObject){var x=touch.deltaX;var y=touch.deltaY;var camera=this.camera;var rotation=tile.modelObject.rotation;rotation[1]+=x*180;tile.modelObject.setRotationY(rotation[1]);rotation[0]+=y*180;tile.modelObject.setRotationX(rotation[0]);return true}}return true};SceneAssetEditor.prototype.touchReleased=function(touch,touchAction){var result=this.CCSceneAppUI_touchReleased(touch,touchAction);return true};SceneAssetEditor.prototype.open=function(message){this.message=message;var self=this;var camera=this.camera;var i,tile;var menuTiles=this.menuTiles;for(i=0;i<menuTiles.length;++i){menuTiles[i].deleteLater()}menuTiles.length=0;{{tile=new CCTile3DButton(this);tile.setupTexturedWidth(camera.cameraWidth*.1,"editor_tile_back.jpg",function(tile){tile.setPositionX(camera.targetWidth*.5+tile.collisionBounds[0]);self.showMenu()});tile.setColour(gColour.setRGBA(1,1,1,0));tile.setDrawOrder(220);tile.onRelease.push(function(){self.handleBackButton()});this.addTile(tile,0);menuTiles.add(tile)}{tile=new CCTile3DButton(this);tile.setupTexturedWidth(camera.cameraWidth*.1,"editor_tile_tick.jpg",function(tile){tile.setPositionX(camera.targetWidth*.5+tile.collisionBounds[0]);self.showMenu()});tile.setColour(gColour.setRGBA(1,1,1,0));tile.setDrawOrder(220);tile.onRelease.push(function(){if(self.reExportFBXModel()){}else{self.onTick()}});this.addTile(tile,0);this.tileTick=tile;menuTiles.add(tile)}}this.showMenu()};SceneAssetEditor.prototype.showMenu=function(){if(this.enabled){this.requestResize();var camera=this.camera;var menuTiles=this.menuTiles;var i,tile;if(this.info.tex||this.info.obj){{tile=this.tileAlert;tile.setTextColourAlpha(1,true);tile.setColourAlpha(.5,true);tile.setText(this.message);tile.setTileMovementX(0)}{tile=this.tileModel;if(tile.modelObject){tile.setColourAlpha(.5,true)}else{tile.setColourAlpha(1,true)}tile.setTileMovementY(0)}}for(i=0;i<menuTiles.length;++i){tile=menuTiles[i];var show=true;if(tile===this.tileTick){if(this.assetDirty){}else if(this.reExportModel){}else if(this.noSelect){show=false}}if(show){tile.setTileMovementX(camera.targetWidth*.5-tile.collisionBounds[0]);tile.setColourAlpha(1,true);tile.enabled=true}else{tile.setTileMovementX(camera.targetWidth*.5+tile.collisionBounds[0]);tile.setColourAlpha(0,true);tile.enabled=false}}this.showControls()}};SceneAssetEditor.prototype.openControls=function(){var i;var bottomTiles=this.bottomTiles;for(i=0;i<bottomTiles.length;++i){bottomTiles[i].deleteLater()}bottomTiles.length=0;if(this.info.objectID){var self=this;var camera=this.camera;var LoadedImageFunction=function(tile){return function(){tile.setPositionY(-camera.cameraHHeight-tile.collisionBounds[1]);self.showControls()}};var tile;if(MultiplayerManager.IsOwner(this.info.owners)){tile=new CCTile3DButton(this);tile.setupTextured("editor_icon_delete.jpg",new LoadedImageFunction(tile));tile.setColour(EditorManager.Red);tile.setDrawOrder(220);tile.onRelease.push(function(){if(MultiplayerManager.LoggedIn){if(self.supportObj){AlertsManager.ConfirmationAlert("Delete model?",function(result){if(result){if(MultiplayerManager.LoggedIn){EditorManager.EditorDeleteModel(self.info)}self.info={};var tile=self.tileModel;tile.deleteLater();{tile=new CCTile3DButton(self);tile.setupTile(1);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setDrawOrder(210);self.tileModel=tile}self.openControls();if(self.sceneSettings){self.sceneSettings.close()}if(self.onDeleted){self.onDeleted()}else{self.close()}}})}else{AlertsManager.ConfirmationAlert("Delete image?",function(result){if(result){if(MultiplayerManager.LoggedIn){EditorManager.EditorDeleteImage(self.info)}self.info={};var tile=self.tileModel;tile.deleteLater();{tile=new CCTile3DButton(self);tile.setupTile(1);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setDrawOrder(210);self.tileModel=tile}self.openControls();if(self.sceneSettings){self.sceneSettings.close()}}})}}});this.addTile(tile,0);bottomTiles.add(tile)}this.showControls()}};SceneAssetEditor.prototype.showControls=function(resizeRequired){if(this.enabled){if(resizeRequired===undefined){resizeRequired=true}if(resizeRequired){this.requestResize()}var camera=this.camera;var bottomTiles=this.bottomTiles;var i,tile;for(i=0;i<bottomTiles.length;++i){tile=bottomTiles[i];var targetY=-camera.targetHeight*.5+tile.collisionBounds[1];if(tile.position[1]>targetY){tile.setPositionY(targetY)}else{tile.setTileMovementY(targetY)}tile.setColourAlpha(1,true);tile.enabled=true}}};SceneAssetEditor.prototype.openModelSettings=function(){if(this.sceneSettings){var tile=this.tileModel;if(tile.modelObject){var model=tile.modelObject.model;if(model){this.sceneSettings.openModelSettings(model)}}}};SceneAssetEditor.prototype.openImageSettings=function(filename){if(this.sceneSettings){this.sceneSettings.openImageSettings(filename)}};SceneAssetEditor.prototype.close=function(){if(this.sceneUIListDBModels){this.sceneUIListDBModels.close();this.sceneUIListDBModels=null}var self=this;var camera=this.camera;this.tileBackground.setColourAlpha(0,true);var tile;{tile=this.tileAlert;tile.setTextColourAlpha(0,true);tile.setColourAlpha(0,true,function(){self.deleteLater()});tile.translateTileMovementX(-(camera.targetWidth*.5)-tile.collisionSize.width)}{tile=this.tileModel;tile.setColourAlpha(0,true);tile.setTileMovementY(-(camera.targetHeight*.5)-tile.collisionSize.height)}var menuTiles=this.menuTiles;for(i=0;i<menuTiles.length;++i){tile=menuTiles[i];tile.translateTileMovementX(camera.targetWidth*.5+tile.collisionSize.width);tile.setColour(gColour.setRGBA(1,1,1,0),true);tile.enabled=false}var bottomTiles=this.bottomTiles;for(i=0;i<bottomTiles.length;++i){tile=bottomTiles[i];tile.translateTileMovementY(-tile.collisionSize.height);tile.setColourAlpha(0,true)}if(this.sceneSettings){this.sceneSettings.close()}};SceneAssetEditor.prototype.setCulling=function(noCulling){var tile=this.tileModel;if(tile.modelObject){tile.modelObject.setCulling(!noCulling)}this.sceneSettings.setCulling(noCulling);if(this.info.noCulling!==noCulling){this.info.noCulling=noCulling;this.updatedInfo()}};SceneAssetEditor.prototype.setAnimationFPSCompression=function(ratio){if(ratio>0&&ratio<10){var tile=this.tileModel;if(tile.modelObject){var model=tile.modelObject.model;if(model){var info=this.info;if(info.sourceObj){var currentRatio=model.getAnimationFPSCompression();if(ratio!==currentRatio){var sourceFBX=info.sourceObj;var filenameSplit=sourceFBX.split("_");var filename=filenameSplit[0];filename+=".";filename+=filenameSplit[filenameSplit.length-1];this.convertFBX(filename,sourceFBX,ratio)}}}}}else{AlertsManager.TimeoutAlert("please select value between 1 - 9",2)}};SceneAssetEditor.prototype.setModelReExport=function(toggle){var tile=this.tileTick;if(toggle){if(!this.reExportModel){this.reExportModel=true;tile.setTileTexture("editor_tile_refresh.jpg");this.showMenu()}}else{if(this.reExportModel){this.reExportModel=false;tile.setTileTexture("editor_tile_tick.jpg");this.showMenu()}}};SceneAssetEditor.prototype.setAnimation=function(index){var tile=this.tileModel;if(tile.modelObject){var model=tile.modelObject.model;if(model){if(model.getAnimation()!==index){model.setAnimation(index);this.openModelSettings()}}}};SceneAssetEditor.prototype.deleteAnimation=function(animationName){var tile=this.tileModel;if(tile.modelObject){var model=tile.modelObject.model;if(model){var primitive=model.primitive;if(primitive){if(primitive.deleteAnimation(animationName)){this.setModelReExport(true);AlertsManager.Notification("editor","deleted "+animationName,null,2,EditorManager.LightRed);this.openModelSettings()}}}}};SceneAssetEditor.prototype.toggleAnimationFrame=function(index){var tile=this.tileModel;if(tile.modelObject){var model=tile.modelObject.model;if(model){model.toggleAnimationFrame(index);this.openModelSettings()}}};SceneAssetEditor.prototype.moveAnimationFrame=function(oldIndex,newIndex){var tile=this.tileModel;if(tile.modelObject){var model=tile.modelObject.model;if(model){var primitive=model.primitive;if(primitive){if(primitive.moveAnimationFrame(oldIndex,newIndex)){this.setModelReExport(true);AlertsManager.Notification("editor","moved frame "+(oldIndex+1),null,2,EditorManager.LightRed);primitive.toggleAnimationFrame(newIndex);this.openModelSettings()}}}}};SceneAssetEditor.prototype.deleteAnimationFrame=function(index){var tile=this.tileModel;if(tile.modelObject){var model=tile.modelObject.model;if(model){var primitive=model.primitive;if(primitive){if(primitive.deleteAnimationFrame(index)){this.setModelReExport(true);AlertsManager.Notification("editor","deleted frame "+(index+1),null,2,EditorManager.LightRed);primitive.toggleAnimationFrame(index);this.openModelSettings()}}}}};SceneAssetEditor.prototype.toggleSubmodel=function(submodelName){if(this.tileModel){if(this.tileModel.modelObject){var model=this.tileModel.modelObject.model;if(model){var primitive=model.primitive;if(primitive){primitive.toggleSubmodel(submodelName);this.openModelSettings()}}}}};SceneAssetEditor.prototype.deleteSubmodel=function(submodelName){if(this.tileModel){if(this.tileModel.modelObject){var model=this.tileModel.modelObject.model;if(model){var primitive=model.primitive;if(primitive){if(primitive.deleteSubmodel(submodelName)){this.setModelReExport(true);this.reExportFBXModel()}}}}}};SceneAssetEditor.prototype.setModel=function(sourceInfo){this.info.objectID=sourceInfo.objectID;this.info.owners=sourceInfo.owners;this.info.obj=sourceInfo.obj;this.info.sourceObj=sourceInfo.sourceObj;this.info.tex=sourceInfo.tex;this.info.noCulling=sourceInfo.noCulling;this.info.tags=sourceInfo.tags;if(this.info.obj){this.setAsset(this.info.obj,true)}if(this.info.tex){this.setAsset(this.info.tex,true)}if(this.info.noCulling!==undefined){this.setCulling(this.info.noCulling)}if(MultiplayerManager.IsOwner(this.info.owners)){this.updatedInfo(true);this.tileTick.setTileTexture("editor_tile_tick.jpg")}else{this.updatedInfo(false);this.tileTick.setTileTexture("editor_tile_copy.jpg")}this.openControls()};SceneAssetEditor.prototype.setImage=function(sourceInfo){this.info=CC.DeepCopy(sourceInfo);if(this.info.tex){this.setAsset(this.info.tex,true)}this.openControls()};SceneAssetEditor.prototype.removeTexture=function(){var info=this.info;var tile=this.tileModel;info.tex=null;tile.removeTileTexture();if(tile.modelObject){var model3d=tile.modelObject.model;model3d.removeTexture()}if(this.sceneSettings){this.sceneSettings.close()}};SceneAssetEditor.prototype.setAsset=function(filename,calledFromList){if(filename){var self=this;var info=this.info;var tile=this.tileModel;var fileExtension=filename.getExtension();if(fileExtension==="png"||fileExtension==="jpg"){info.tex=filename;this.updatedInfo(calledFromList);if(tile.modelObject){var model3d=tile.modelObject.model;model3d.setTexture(info.tex)}gEngine.textureManager.getTextureHandle(info.tex,function(textureHandle){if(textureHandle&&textureHandle.image){if(!self.supportObj){self.openImageSettings(info.tex);tile.setTileTexture(info.tex)}self.showMenu()}});if(!calledFromList){if(this.sceneUIListDBModels){this.sceneUIListDBModels.findAndSelect(info)}else if(this.sceneUIListDBImages){this.sceneUIListDBImages.findAndSelect(info.tex)}}return true}else if(this.supportObj){if(fileExtension==="fbx"){info.sourceObj=filename}else if(fileExtension==="obj"){if(info.sourceObj){delete info.sourceObj}}if(fileExtension==="obj"||fileExtension==="fbxi"){this.setModelReExport(false);info.obj=filename;this.updatedInfo(calledFromList);if(!calledFromList){if(info.tex&&this.sceneUIListDBModels){this.sceneUIListDBModels.findAndSelect(info)}}AlertsManager.Alert("updating...");CCModel3D.CacheModel(info.obj,true,function(model3d){AlertsManager.Hide("updating...");if(model3d){if(!tile.modelObject){var modelObject=new CCObject;tile.addChild(modelObject);modelObject.setColour(gColour.set(1,1));modelObject.setTransparent();tile.modelObject=modelObject;self.showMenu()}tile.modelObject.setModel(model3d);self.openModelSettings();tile.modelObject.setRotationX(0);tile.modelObject.setRotationY(0);{var size=tile.collisionSize.width*.75;var scaleFactor;var modelWidth=model3d.getWidth()>model3d.getDepth()?model3d.getWidth():model3d.getDepth();var modelHeight=model3d.getHeight();if(modelWidth>modelHeight){scaleFactor=size/modelWidth}else{scaleFactor=size/modelHeight}model3d.setScale(scaleFactor);if(info.tex){model3d.setTexture(info.tex)}}}},2);return true}}}return false};SceneAssetEditor.prototype.updatedInfo=function(reset){if(reset){if(this.assetDirty){this.assetDirty=false}}else{if(!this.assetDirty){this.assetDirty=true}}this.showMenu()};SceneAssetEditor.prototype.onDragDropLoad=function(file,event){if(event&&event.target&&event.target.result){if(MultiplayerManager.LoggedIn){if(this.creatingNewModel){this.setModel({})}var data=event.target.result;this.prepareUpload(file,data)}}};SceneAssetEditor.prototype.prepareUpload=function(file,data){var self=this;var filename=file.name;filename=filename.toLowerCase();var fileExtension=filename.getExtension();if(fileExtension==="jpeg"){var newFilename=filename.stripExtension();newFilename+=".jpg";self.upload(newFilename,data,true)}else if(fileExtension==="bmp"){AlertsManager.ModalAlert("converting bmp...");CCTextureManager.ConvertBase64Image(data,function(newData){AlertsManager.Hide("converting bmp...");if(newData){var newFilename=filename.stripExtension();newFilename+=".jpg";self.upload(newFilename,newData,true)}else{AlertsManager.TimeoutAlert("failed to convert bmp :(",2)}})}else if(fileExtension==="png"){this.removeTexture();CCTextureManager.ValidateImageResolution(data,"image/png",1024,function(validatedData){self.upload(filename,validatedData,true)})}else if(fileExtension==="jpg"){this.removeTexture();CCTextureManager.ValidateImageResolution(data,"image/jpeg",1024,function(validatedData){self.upload(filename,validatedData,true)})}else if(this.supportObj){if(fileExtension==="obj"){if(file.size>1024*1024*2){AlertsManager.TimeoutAlert("file size too large",2)}else{this.upload(filename,data)}}else if(fileExtension==="fbx"){var dataBuffer=new Uint8Array(data);this.uploadFBX(filename,dataBuffer)}else if(fileExtension==="fbxi"){this.uploadFBXiJSON(filename,data)}else{AlertsManager.TimeoutAlert("only .png .jpg .obj .fbx supported",2)}}else{AlertsManager.TimeoutAlert("only .png .jpg supported",2)}};SceneAssetEditor.prototype.convertImage=function(format,tiling){var filename=this.info.sourceTex?this.info.sourceTex:this.info.tex;var filenameExtension=filename.getExtension();if(!format){format=this.info.tex.getExtension()}if(!tiling){tiling=1}var changedFormat=format!==filenameExtension;var changedTiling=tiling!==1;if(!changedFormat&&!changedTiling){delete this.info.tiling;this.setAsset(filename)}else{var self=this;AlertsManager.ModalAlert("converting...");gEngine.textureManager.getTextureHandle(filename,function(textureHandle){if(textureHandle.image){CCTextureManager.ConvertImage(textureHandle.image,format,tiling,function(newData){AlertsManager.Hide("converting...");if(newData){self.info.tiling=tiling;if(!self.info.sourceTex){self.info.sourceTex=filename}var newFilename=filename.stripExtension()+tiling;newFilename+="."+format;self.upload(newFilename,newData,true)}else{AlertsManager.TimeoutAlert("failed to convert :(",2)}})}else{AlertsManager.TimeoutAlert("failed to convert :(",2)}})}};SceneAssetEditor.prototype.upload=function(filename,data,base64){var self=this;AlertsManager.ModalAlert("uploading...");var url=SERVER_ASSETS_URL+"assets/upload.php";var postData={filename:filename};postData.file=new Blob([data],{type:"text/plain"});if(base64){postData.base64=true}if(MultiplayerManager.UseURLProxy(url)){postData.url=url;url=SERVER_ROOT+"backend/helper.php?uploadfile"}gURLManager.requestURL(url,postData,function(status,responseText){var uploaded=false;if(status>=CCURLRequest.Succeeded){if(responseText){var filename=responseText;if(MultiplayerManager.LoggedIn){uploaded=self.setAsset(filename)}}}AlertsManager.Hide("uploading...");if(!uploaded){AlertsManager.TimeoutAlert("failed to upload :(",2)}},1)};SceneAssetEditor.prototype.uploadFBX=function(filename,data,animationFPSCompression){AlertsManager.ModalAlert("uploading...");var url=SERVER_ASSETS_URL+"assets/upload.php";var postData={filename:filename};postData.file=new Blob([data],{type:"text/plain"});if(MultiplayerManager.UseURLProxy(url)){postData.url=url;url=SERVER_ROOT+"backend/helper.php?uploadfile"}var self=this;gURLManager.requestURL(url,postData,function(status,responseText){AlertsManager.Hide("uploading...");var uploaded=false;if(status>=CCURLRequest.Succeeded){if(responseText){var sourceFBX=responseText;if(MultiplayerManager.LoggedIn){uploaded=true;self.convertFBX(filename,sourceFBX,animationFPSCompression)}}}if(!uploaded){AlertsManager.TimeoutAlert("failed to upload fbx :(",2)}},1)};SceneAssetEditor.prototype.convertFBX=function(filename,sourceFBX,animationFPSCompression){var self=this;AlertsManager.ModalAlert("processing...");var sourceURL=MultiplayerManager.GetAssetURL(sourceFBX);if(sourceURL.contains("backend/helper.php?url=")){sourceURL=String.SplitAfter(sourceURL,"backend/helper.php?url=")}var postData={};postData.url=SocketManager.httpServerURL+"/fbx2json";postData.sourceURL=sourceURL;if(animationFPSCompression){postData.animationFPSCompression=animationFPSCompression}var url=SERVER_ROOT+"backend/helper.php?post";gURLManager.requestURL(url,postData,function(status,responseText){AlertsManager.Hide("processing...");var uploaded=false;if(status>=CCURLRequest.Succeeded){if(responseText){uploaded=true;self.uploadFBXiJSON(filename+"i",responseText,sourceFBX)}}if(!uploaded){AlertsManager.TimeoutAlert("failed to process fbx :(",2)}},1)};SceneAssetEditor.prototype.uploadFBXiJSON=function(filename,data,sourceFBX){var self=this;AlertsManager.ModalAlert("uploading...");
var json=JSON.parse(data);data=JSON.stringify(json,function(key,val){return val.toFixed?Number(val.toFixed(4)):val});var url=SERVER_ASSETS_URL+"assets/upload.php";var postData={filename:filename};postData.file=new Blob([data],{type:"text/plain"});if(MultiplayerManager.UseURLProxy(url)){postData.url=url;url=SERVER_ROOT+"backend/helper.php?uploadfile"}gURLManager.requestURL(url,postData,function(status,responseText){AlertsManager.Hide("uploading...");var uploaded=false;if(status>=CCURLRequest.Succeeded){if(responseText){var filename=responseText;if(MultiplayerManager.LoggedIn){uploaded=self.setAsset(filename);if(sourceFBX){self.setAsset(sourceFBX)}}}}if(!uploaded){AlertsManager.TimeoutAlert("failed to upload processed fbx :(",2)}},1)};SceneAssetEditor.prototype.reExportFBXModel=function(){if(this.reExportModel){var tile=this.tileModel;if(tile.modelObject){var model=tile.modelObject.model;if(model){var primitive=model.primitive;if(primitive){var self=this;AlertsManager.ModalAlert("updating...");primitive.exportJSONString(function(jsonString){AlertsManager.Hide("updating...");var obj=self.info.obj;var filenameSplit=obj.split("_");var filename=filenameSplit[0];filename+=".";filename+=obj.getExtension();self.uploadFBXiJSON(filename,jsonString)});return true}}}}return false};SceneAssetEditor.prototype.handleBackButton=function(){if(!this.disabledBackButton){this.disabledBackButton=true;if(this.onClose){this.onClose(false)}this.close();return true}return false};SceneAssetEditor.prototype.onTick=function(){if(MultiplayerManager.LoggedIn){if(this.assetDirty){if(this.info.obj){if(MultiplayerManager.IsOwner(this.info.owners)&&this.info.objectID){var self=this;AlertsManager.Alert("replace current or create new model?",function(result){if(result){if(result===2){delete self.info.objectID}MultiplayerManager.Emit("EditorModelCreate",self.info)}},["replace","create new"])}else{MultiplayerManager.Emit("EditorModelCreate",this.info)}}else if(this.info.tex){MultiplayerManager.Emit("EditorImageCreate",this.info);if(this.onClose){this.onClose(this.info.tex);this.close()}}}else{if(this.onClose){if(this.supportObj){this.onClose(this.info)}else{this.onClose(this.info.tex)}this.close()}}}};SceneAssetEditor.prototype.addTag=function(){this.sceneUIListTags=new SceneUIListTags(this);var self=this;this.sceneUIListTags.onSelected=function(tag){if(tag){if(!self.info.tags){self.info.tags=[]}if(self.info.tags.addOnce(tag)){self.openModelSettings();self.updatedInfo();self.sceneUIListTags.close()}}}};function SceneAssetEditorSettings(editor){this.construct();gEngine.addScene(this);this.editor=editor;this.controlsSwipeMomentum=true}ExtendPrototype(SceneAssetEditorSettings,CCSceneAppUI);SceneAssetEditorSettings.prototype.setup=function(){var self=this;var camera=gEngine.newSceneCamera(this);camera.setupViewport(.8,.2,.2,.7);camera.setCameraWidth(640*.1,false);this.settingTiles=[];this.requestResize()};SceneAssetEditorSettings.prototype.resize=function(){this.CCSceneAppUI_resize();var camera=this.camera;var i,tile;var tileMovementTarget;var idealAspectRatio=1.5;var aspectRatioAdjutment=camera.getAspectRatio()<1.25?camera.getAspectRatio()/idealAspectRatio:1;var y=camera.cameraHHeight;var settingTiles=this.settingTiles;for(i=0;i<settingTiles.length;++i){tile=settingTiles[i];tileMovementTarget=tile.getTileMovementTarget();y-=tile.collisionBounds[1];tile.setPositionY(y);tile.setTileMovementX(tileMovementTarget[0]);if(tile.tileDelete){var tileDelete=tile.tileDelete;tileMovementTarget=tileDelete.getTileMovementTarget();tileDelete.setPositionY(y);tileDelete.setTileMovementX(tileMovementTarget[0])}y-=tile.collisionBounds[1]}};SceneAssetEditorSettings.prototype.updateControls=function(controls){var usingControls=this.CCSceneAppUI_updateControls(controls);var cameraTouches=this.camera.cameraTouches;var touch=cameraTouches[0];if(touch.x>0&&touch.x<1&&touch.y>0&&touch.y<1&&touch.startX>0&&touch.startX<1&&touch.startY>0&&touch.startY<1){if(controls.wheel&&controls.wheel.delta!==0){var delta=controls.wheel.delta;this.cameraScrolling=true;this.controlsMovingVertical=true;this.touchCameraMoving(0,delta*.1);return true}}return usingControls};SceneAssetEditorSettings.prototype.touchMovementAllowed=function(touch,touchDelta){var absDeltaX=Math.abs(touch.totalDeltaX);var absDeltaY=Math.abs(touch.totalDeltaY);if(absDeltaX>CCControls.TouchMovementThreashold.x||absDeltaY>CCControls.TouchMovementThreashold.y){this.controlsMoving=true;touchDelta.x+=touch.totalDeltaX;touchDelta.y+=touch.totalDeltaY;this.controlsMovingVertical=true;return true}return false};SceneAssetEditorSettings.prototype.refreshCameraView=function(){var tiles=this.tiles;if(tiles.length>0){var top=-CC_MAXFLOAT;var bottom=CC_MAXFLOAT;for(var i=0;i<tiles.length;++i){var tile=tiles[i];var topY=tile.getTileMovementTarget()[1]+tile.collisionBounds[1];var bottomY=tile.getTileMovementTarget()[1]-tile.collisionBounds[1];if(topY>top){top=topY}if(bottomY<bottom){bottom=bottomY}}var camera=this.camera;this.sceneLeft=0;this.sceneRight=0;this.sceneTop=top-camera.targetHeight*.5;this.sceneBottom=bottom+camera.targetHeight*.5;if(this.sceneBottom>this.sceneTop){this.sceneBottom=this.sceneTop}}};SceneAssetEditorSettings.prototype.lockCameraView=function(){if(this.cameraScrolling){return}var camera=this.camera;if(camera.targetLookAt[0]<this.sceneLeft){camera.targetLookAt[0]=this.sceneLeft;camera.flagUpdate()}if(camera.targetLookAt[0]>this.sceneRight){camera.targetLookAt[0]=this.sceneRight;camera.flagUpdate()}if(camera.targetLookAt[1]>this.sceneTop){camera.targetLookAt[1]=this.sceneTop;camera.flagUpdate()}else if(camera.targetLookAt[1]<this.sceneBottom){camera.targetLookAt[1]=this.sceneBottom;camera.flagUpdate()}};SceneAssetEditorSettings.prototype.openModelSettings=function(model){var self=this;var camera=this.camera;var tileWidth=camera.targetWidth;var tileHeight=camera.targetWidth*.125;var textHeight=tileHeight*.9;var optionTileWidth=tileWidth-tileHeight;var i,tile,tileDelete;var settingTiles=this.settingTiles;var animate=settingTiles.length===0;for(i=0;i<settingTiles.length;++i){tile=settingTiles[i];if(tile.tileDelete){tile.tileDelete.deleteLater()}tile.deleteLater()}settingTiles.length=0;{{tile=new CCTile3DButton(this);tile.setupText("Settings",textHeight,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTextColour(gColour.set(1,1),true);tile.setColour(gColour.set(.25,0));tile.setDrawOrder(220);this.addTile(tile,0);settingTiles.add(tile)}{var tags=this.editor.info.tags;if(!tags||tags.length<1){tile=new CCTile3DButton(this);tile.setupText("Add Tag",textHeight,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTextColour(gColour.set(1,1),true);tile.setColour(EditorManager.LightGreen);tile.setDrawOrder(220);tile.onRelease.push(function(){self.editor.addTag()});this.addTile(tile,0);settingTiles.add(tile)}var DeleteTag=function(tag){return function(){tags.remove(tag);self.openModelSettings(model)}};if(tags){for(i=0;i<tags.length;++i){var tag=tags[i];tile=new CCTile3DButton(this);tile.setupText(tag,textHeight,true,true);tile.setTileSize(optionTileWidth,tileHeight);tile.setTextColour(gColour.set(0,1),true);tile.setColour(gColour.set(.85,0));tile.setDrawOrder(220);this.addTile(tile,0);settingTiles.add(tile);{tileDelete=new CCTile3DButton(this);tileDelete.setupTile(tileHeight);tileDelete.setTileTexture("editor_icon_delete.jpg");tileDelete.setColour(EditorManager.Red);tileDelete.setDrawOrder(221);tileDelete.onRelease.push(new DeleteTag(tag));this.addTile(tileDelete,0);tile.tileDelete=tileDelete}}}}if(this.editor.info.tex){tile=new CCTile3DButton(this);tile.setupTexturedWidth(tileWidth,this.editor.info.tex);tile.setColour(gColour.set(1,1),true);tile.setDrawOrder(220);this.addTile(tile,0);settingTiles.add(tile)}if(model){var primitive=model.primitive;if(primitive){if(this.editor.info.obj){tile=new CCTile3DButton(this);tile.setupText("Filesize : ...",textHeight,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTextColour(gColour.set(1,1),true);tile.setColour(gColour.set(.25,0));tile.setDrawOrder(220);settingTiles.add(tile);var url=MultiplayerManager.GetAssetURL(this.editor.info.obj);var filename=url.stripDirectory();filename=String.StripEquals(filename);if(primitive){if(primitive.fileSize&&!this.editor.reExportModel){var fileSize=primitive.fileSize;tile.setText("Filesize: "+(fileSize/1024/1024).toFixed(2)+" mb")}}}if(this.editor.info.obj){tile=new CCTile3DButton(this);tile.setupText(" ",textHeight,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTextColour(gColour.set(0,1),true);tile.setColour(gColour.set(.85,0));tile.setDrawOrder(220);this.tileCulling=tile;tile.onRelease.push(function(){self.editor.setCulling(!self.editor.info.noCulling)});this.addTile(tile,0);this.editor.setCulling(this.editor.info.noCulling);settingTiles.add(tile)}var animations=primitive.animations;if(animations&&animations.length>0){{tile=new CCTile3DButton(this);tile.setupText("Animations",textHeight,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTextColour(gColour.set(1,1),true);tile.setColour(gColour.set(.25,0));tile.setDrawOrder(220);settingTiles.add(tile)}var SetAnimationFPSCompression=function(index){return function(){AlertsManager.InputAlert("",function(result){if(result){var ratio=parseInt(result,10);self.editor.setAnimationFPSCompression(ratio)}},{letter:false})}};{var animationFPSCompression=model.getAnimationFPSCompression();tile=new CCTile3DButton(this);tile.setupText("1/"+animationFPSCompression+" fps compression",textHeight,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setColour(gColour.set(1,0));tile.setDrawOrder(220);tile.onRelease.push(new SetAnimationFPSCompression(animationFPSCompression));this.addTile(tile,0);settingTiles.add(tile)}var SetAnimation=function(index){return function(){self.editor.setAnimation(index)}};var DeleteAnimation=function(animationName){return function(){self.editor.deleteAnimation(animationName)}};var currentAnimationIndex=model.getAnimation();var animation;for(i=0;i<animations.length;++i){animation=animations[i];tile=new CCTile3DButton(this);tile.setupText(animation.name,textHeight,true,true);tile.setTileSize(optionTileWidth,tileHeight);tile.setTextColour(gColour.set(0,1),true);tile.setColour(gColour.set(.85,0));if(currentAnimationIndex===i){tile.setColour(EditorManager.LightGreen)}tile.setDrawOrder(220);tile.onRelease.push(new SetAnimation(i));this.addTile(tile,0);settingTiles.add(tile);{tileDelete=new CCTile3DButton(this);tileDelete.setupTile(tileHeight);tileDelete.setTileTexture("editor_icon_delete.jpg");tileDelete.setColour(EditorManager.Red);tileDelete.setDrawOrder(221);tileDelete.onRelease.push(new DeleteAnimation(animation.name));this.addTile(tileDelete,0);tile.tileDelete=tileDelete}}{tile=new CCTile3DButton(this);tile.setupText("Frames",textHeight,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTextColour(gColour.set(1,1),true);tile.setColour(gColour.set(.25,0));tile.setDrawOrder(220);settingTiles.add(tile)}var ToggleAnimationFrame=function(index){return function(){self.editor.toggleAnimationFrame(index)}};var DeleteAnimationFrame=function(index){return function(){self.editor.deleteAnimationFrame(index)}};var currentAnimationFrameIndex=model.getAnimationFrame();animation=animations[currentAnimationIndex];var frames=animation.frames;this.tileAnimationFrames=[];for(i=0;i<frames.length;++i){tile=new CCTile3DButton(this);tile.setupText("Frame "+(i+1),textHeight,true,true);tile.setTileSize(optionTileWidth,tileHeight);tile.setTextColour(gColour.set(0,1),true);tile.setColour(gColour.set(.85,0));if(i===currentAnimationFrameIndex){tile.setColour(EditorManager.LightBlue)}tile.setDrawOrder(220);tile.onRelease.push(new ToggleAnimationFrame(i));tile.touchMovementAllowed=true;if(i===currentAnimationFrameIndex){tile.onPress.push(function(tile){tile.setDrawOrder(221)});tile.onMove.push(function(tile,touchPosition){self.movingAnimationFrame(tile,touchPosition)});tile.onLoss.push(function(tile,touchLost){var newY=tile.position[1];tile.setPositionY(tile.touchPosition[1]);if(!touchLost&&tile.touchMoved){self.movedAnimationFrame(tile,newY)}tile.setDrawOrder(220)})}this.addTile(tile,0);this.tileAnimationFrames.push(tile);settingTiles.add(tile);{tileDelete=new CCTile3DButton(this);tileDelete.setupTile(tileHeight);tileDelete.setTileTexture("editor_icon_delete.jpg");tileDelete.setColour(EditorManager.Red);tileDelete.setDrawOrder(221);tileDelete.onRelease.push(new DeleteAnimationFrame(i));this.addTile(tileDelete,0);tile.tileDelete=tileDelete}}}var submodels=primitive.submodels;if(submodels){{tile=new CCTile3DButton(this);tile.setupText("Submodels",textHeight,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTextColour(gColour.set(1,1),true);tile.setColour(gColour.set(.25,0));tile.setDrawOrder(220);settingTiles.add(tile)}var ToggleSubmodel=function(submodelName){return function(){self.editor.toggleSubmodel(submodelName)}};var DeleteSubmodel=function(submodelName){return function(){self.editor.deleteSubmodel(submodelName)}};for(i=0;i<submodels.length;++i){var submodel=submodels[i];tile=new CCTile3DButton(this);tile.setupText(submodel.name,textHeight,true,true);tile.setTileSize(optionTileWidth,tileHeight);tile.setTextColour(gColour.set(0,1),true);if(submodel.disabled){tile.setColour(EditorManager.Red)}else{tile.setColour(gColour.set(.85,0))}tile.setDrawOrder(220);tile.onRelease.push(new ToggleSubmodel(submodel.name));this.addTile(tile,0);settingTiles.add(tile);{tileDelete=new CCTile3DButton(this);tileDelete.setupTile(tileHeight);tileDelete.setTileTexture("editor_icon_delete.jpg");tileDelete.setColour(EditorManager.Red);tileDelete.setDrawOrder(221);tileDelete.onRelease.push(new DeleteSubmodel(submodel.name));this.addTile(tileDelete,0);tile.tileDelete=tileDelete}}}}}}for(i=0;i<settingTiles.length;++i){tile=settingTiles[i];if(animate){tile.setPositionX(camera.cameraHWidth+tile.collisionSize.width)}else{tile.setPositionX(camera.cameraHWidth-tile.collisionBounds[0]);tile.setColourAlpha(1,false);tile.setTextColourAlpha(1,false)}if(tile.tileDelete){tileDelete=tile.tileDelete;tileDelete.setPositionX(tile.position[0]-tile.collisionBounds[0]-tileDelete.collisionBounds[0]);if(!animate){tileDelete.setColourAlpha(1,false)}}}this.showSettings(false)};SceneAssetEditorSettings.prototype.openImageSettings=function(filename){var self=this;var camera=this.camera;var tileWidth=camera.targetWidth;var tileHeight=camera.targetWidth*.125;var textHeight=tileHeight*.9;var optionTileWidth=tileWidth-tileHeight;var i,tile,tileDelete;var settingTiles=this.settingTiles;for(i=0;i<settingTiles.length;++i){tile=settingTiles[i];if(tile.tileDelete){tile.tileDelete.deleteLater()}tile.deleteLater()}settingTiles.length=0;{{tile=new CCTile3DButton(this);var friendlyName=filename;if(friendlyName.length>17){friendlyName=friendlyName.substring(0,17);friendlyName+="..."}tile.setupText(friendlyName,textHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setColour(gColour.set(1,0));tile.setDrawOrder(220);tile.onRelease.push(function(){CC.WindowPrompt("Filename",filename)});this.addTile(tile,0);settingTiles.add(tile)}{tile=new CCTile3DButton(this);tile.setupText("Settings",textHeight,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTextColour(gColour.set(1,1),true);tile.setColour(gColour.set(.25,0));tile.setDrawOrder(220);this.addTile(tile,0);settingTiles.add(tile)}{var fileExtension=filename.getExtension();tile=new CCTile3DButton(this);tile.setupText("Format: "+fileExtension,textHeight,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setColour(gColour.set(1,0));tile.setDrawOrder(220);tile.onRelease.push(function(){if(fileExtension==="png"){self.editor.convertImage("jpg")}else if(self.editor.info.sourceTex){var sourceFilenameExtension=self.editor.info.sourceTex.getExtension();if(sourceFilenameExtension==="png"){self.editor.setAsset(self.editor.info.sourceTex)}}});this.addTile(tile,0);settingTiles.add(tile)}{tile=new CCTile3DButton(this);tile.setupText("Tiling: 1.0",textHeight,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setColour(gColour.set(1,0));tile.setDrawOrder(220);tile.onRelease.push(function(){var current="1.0";if(self.editor.info.tiling){current=self.editor.info.tiling}AlertsManager.InputAlert(current,function(result){if(result){if(current!==result){var newFloat=parseFloat(result);self.editor.convertImage(null,newFloat)}}},{dot:true})});this.addTile(tile,0);settingTiles.add(tile)}}for(i=0;i<settingTiles.length;++i){tile=settingTiles[i];tile.setPositionX(camera.cameraHWidth+tile.collisionBounds[0]);if(tile.tileDelete){tileDelete=tile.tileDelete;tileDelete.setPositionX(camera.cameraHWidth+tileDelete.collisionBounds[0])}}this.showSettings(false)};SceneAssetEditorSettings.prototype.show=function(resize){if(resize===undefined){resize=true}this.showSettings(resize)};SceneAssetEditorSettings.prototype.showSettings=function(resize){if(this.enabled){this.requestResize();var camera=this.camera;var settingTiles=this.settingTiles;var i,tile;for(i=0;i<settingTiles.length;++i){tile=settingTiles[i];tile.setTileMovementX(camera.targetWidth*.5-tile.collisionBounds[0]);tile.setColourAlpha(1,true);tile.enabled=true;if(tile.tileDelete){var tileDelete=tile.tileDelete;tileDelete.setTileMovementX(camera.targetWidth*.5-tile.collisionSize.width-tileDelete.collisionBounds[0]);tileDelete.setColourAlpha(1,true);tileDelete.enabled=true}}}};SceneAssetEditorSettings.prototype.setCulling=function(noCulling){if(this.tileCulling){if(noCulling){this.tileCulling.setText("No Culling")}else{this.tileCulling.setText("Backface Culling")}}this.showSettings()};SceneAssetEditorSettings.prototype.close=function(){var self=this;var camera=this.camera;var i,tile;var OnAnimatedFunction=function(tile){tile.enabled=false};var settingTiles=this.settingTiles;for(i=0;i<settingTiles.length;++i){tile=settingTiles[i];tile.setTileMovementX(camera.targetWidth*.5+tile.collisionBounds[0]);tile.setColour(gColour.setRGBA(1,1,1,0),true,new OnAnimatedFunction(tile));if(tile.tileDelete){var tileDelete=tile.tileDelete;tileDelete.setTileMovementX(camera.targetWidth*.5+tileDelete.collisionBounds[0]);tileDelete.setColour(gColour.setRGBA(1,1,1,0),true,new OnAnimatedFunction(tileDelete))}}};SceneAssetEditorSettings.prototype.movingAnimationFrame=function(movingTile,position){var top=-CC_MAXFLOAT;var bottom=CC_MAXFLOAT;for(var i=0;i<this.tileAnimationFrames.length;++i){var tile=this.tileAnimationFrames[i];var tilePosition=tile.position;if(tile===movingTile){tilePosition=tile.touchPosition}var tileTop=tilePosition[1]+tile.collisionBounds[1];if(tileTop>top){top=tileTop}var tileBottom=tilePosition[1]-tile.collisionBounds[1];if(tileBottom<bottom){bottom=tileBottom}}var newY=CC.FloatClamp(position[1],bottom,top);movingTile.setPositionY(newY)};SceneAssetEditorSettings.prototype.movedAnimationFrame=function(tile,newY){var currentIndex=this.tileAnimationFrames.find(tile);if(currentIndex!==-1){var i,tileAnimationFrame;var newIndex=this.tileAnimationFrames.length-1;for(i=0;i<this.tileAnimationFrames.length;++i){tileAnimationFrame=this.tileAnimationFrames[i];if(newY>tileAnimationFrame.position[1]){newIndex=i;break}}if(currentIndex!==newIndex){this.editor.moveAnimationFrame(currentIndex,newIndex)}}};function SceneAudioEditor(parentScene,showLists){MultiplayerManager.UpdateCallbacks.addOnce(this);this.construct();if(parentScene){this.setParent(parentScene)}this.cameraCentered=true;gEngine.addScene(this);var self=this;this.onDragDropLoadFunction=function(file,event){self.onDragDropLoad(file,event)};gEngine.controls.onDragDropLoad.add(this.onDragDropLoadFunction);if(showLists){this.sceneUIListDBImages=new SceneUIListDBImages(this);this.sceneUIListDBImages.onSelected=function(imageInfo){self.setAsset(imageInfo.tex)};this.sceneUIListDBImages.onDeleted=function(imageInfo){EditorManager.EditorDeleteImage(imageInfo)}}this.info={};CCEngine.EnableBackButton(this)}ExtendPrototype(SceneAudioEditor,CCSceneAppUI);SceneAudioEditor.prototype.deleteLater=function(){if(this.onDragDropLoadFunction){gEngine.controls.onDragDropLoad.remove(this.onDragDropLoadFunction);this.onDragDropLoadFunction=null}if(this.sceneUIListDBImages){this.sceneUIListDBImages.close();this.sceneUIListDBImages=null}this.CCSceneAppUI_deleteLater()};SceneAudioEditor.prototype.setup=function(){var self=this;var camera=gEngine.newSceneCamera(this);camera.setupViewport(0,0,1,1);camera.setCameraWidth(640,false);var tile;{tile=new CCTile3DButton(this);tile.setupTile(camera.targetWidth,camera.targetHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColour(gColour.set(.25,0));tile.setColourAlpha(.95,true);tile.setDrawOrder(204);this.cameraStickyTiles.add(tile);this.tileBackground=tile}{tile=new CCTile3DButton(this);tile.setupText(" ",1,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.setColour(gColour.setRGBA(.5,.65,1,0));tile.setTextColour(gColour.setRGBA(1,1,1,0));tile.setPositionX(camera.targetWidth*.5+tile.collisionSize.width);tile.setDrawOrder(210);this.tileAlert=tile}{tile=new CCTile3DButton(this);tile.setupTile(1);tile.setText("");tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setPositionY(-(camera.targetHeight*.5)-tile.collisionSize.height);tile.setDrawOrder(210);tile.onRelease.push(function(tile){self.togglePlay()});this.addTile(tile);this.tileModel=tile}this.menuTiles=[];this.bottomTiles=[];this.requestResize()};SceneAudioEditor.prototype.syncUpdate=function(jsonData){if(jsonData.EditorAudioCreated){if(this.onClose){this.info.id=jsonData.EditorAudioCreated;this.onClose(this.info);this.close()}}};SceneAudioEditor.prototype.updateScene=function(delta){var updated=this.CCSceneAppUI_updateScene(delta);var tile=this.tileModel;if(tile.modelObject){tile.modelObject.rotateY(delta*15);tile.modelObject.model.animate(delta)}return updated};SceneAudioEditor.prototype.resize=function(){this.CCSceneAppUI_resize();var camera=this.camera;var i,tile;var idealAspectRatio=1.5;var aspectRatioAdjutment=camera.getAspectRatio()<1.25?camera.getAspectRatio()/idealAspectRatio:1;{tile=this.tileModel;tile.setTextHeight(camera.targetHeight*.065*aspectRatioAdjutment,true);tile.setTileSize(tile.collisionSize.width*1.1,tile.collisionSize.height*1.5)}{tile=this.tileAlert;tile.setTileSize(camera.targetWidth,camera.targetHeight*.15);tile.setTextHeight(tile.collisionBounds[1]);var targetPosition=tile.getTileMovementTarget();targetPosition[1]=camera.targetHeight*.5-tile.collisionBounds[1];tile.setPosition(targetPosition)}{this.tileBackground.setTileSize(camera.targetWidth,camera.targetHeight)}var y=camera.cameraHHeight;var menuTiles=this.menuTiles;for(i=0;i<menuTiles.length;++i){tile=menuTiles[i];var x=tile.getTileMovementTarget()[0];y-=tile.collisionBounds[1];tile.setPositionY(y);y-=tile.collisionBounds[1];tile.setTileMovementX(x)}var bottomTiles=this.bottomTiles;var tileHeight=camera.targetHeight*.075;for(i=0;i<bottomTiles.length;++i){tile=bottomTiles[i];tile.setTileSize(tileHeight);if(i===0){tile.setPositionX(camera.cameraHWidth-tile.collisionBounds[0])}else{tile.positionTileLeftX(bottomTiles[i-1])}}this.showControls(false)};SceneAudioEditor.prototype.touchPressed=function(touch){var result=this.CCSceneAppUI_touchPressed(touch);return true};SceneAudioEditor.prototype.touchMoving=function(touch,touchDelta){var result=this.handleTilesTouch(touch,this.controlsMovingVertical?CCControls.touch_movingVertical:CCControls.touch_movingHorizontal);if(result===CCSceneAppUI.tile_touchAction){return true}return true};SceneAudioEditor.prototype.touchReleased=function(touch,touchAction){var result=this.CCSceneAppUI_touchReleased(touch,touchAction);return true};SceneAudioEditor.prototype.open=function(message){this.message=message;var self=this;var camera=this.camera;var i,tile;var menuTiles=this.menuTiles;for(i=0;i<menuTiles.length;++i){menuTiles[i].deleteLater()}menuTiles.length=0;{{tile=new CCTile3DButton(this);tile.setupTexturedWidth(camera.cameraWidth*.1,"editor_tile_back.jpg",function(tile){tile.setPositionX(camera.targetWidth*.5+tile.collisionBounds[0]);self.showMenu()});tile.setColour(gColour.setRGBA(1,1,1,0));tile.setDrawOrder(220);tile.onRelease.push(function(){self.handleBackButton()});this.addTile(tile,0);menuTiles.add(tile)}{tile=new CCTile3DButton(this);tile.setupTexturedWidth(camera.cameraWidth*.1,"editor_tile_tick.jpg",function(tile){tile.setPositionX(camera.targetWidth*.5+tile.collisionBounds[0]);self.showMenu()});tile.setColour(gColour.setRGBA(1,1,1,0));tile.setDrawOrder(220);tile.onRelease.push(function(){if(MultiplayerManager.Emit("EditorAudioCreate",self.info.mp3)){if(self.onClose){}else{self.close()}}});this.addTile(tile,0);menuTiles.add(tile)}}this.showMenu()};SceneAudioEditor.prototype.showMenu=function(){if(this.enabled){this.requestResize();var camera=this.camera;var menuTiles=this.menuTiles;var i,tile;{tile=this.tileAlert;tile.setTextColourAlpha(1,true);tile.setColourAlpha(.5,true);tile.setText(this.message);tile.setTileMovementX(0)}{tile=this.tileModel;if(tile.modelObject){tile.setColourAlpha(.5,true)}else{tile.setColourAlpha(1,true)}tile.setTileMovementY(0)}for(i=0;i<menuTiles.length;++i){tile=menuTiles[i];tile.setTileMovementX(camera.targetWidth*.5-tile.collisionBounds[0]);tile.setColourAlpha(1,true);tile.enabled=true}this.showControls()}};SceneAudioEditor.prototype.openControls=function(){if(this.info.id){var self=this;var camera=this.camera;var LoadedImageFunction=function(tile){return function(){tile.setPositionY(-camera.cameraHHeight-tile.collisionBounds[1]);self.showControls()}};var i,tile;var bottomTiles=this.bottomTiles;for(i=0;i<bottomTiles.length;++i){bottomTiles[i].deleteLater()}bottomTiles.length=0;if(MultiplayerManager.IsOwner(this.info.owners)){{tile=new CCTile3DButton(this);tile.setupTextured("editor_icon_delete.jpg",new LoadedImageFunction(tile));tile.setColour(EditorManager.Red);tile.setDrawOrder(220);tile.onRelease.push(function(){if(MultiplayerManager.LoggedIn){AlertsManager.ConfirmationAlert("Delete audio?",function(result){if(result){if(self.onClose){self.onClose(false)}if(MultiplayerManager.LoggedIn){EditorManager.EditorDeleteAudio(self.info)}self.close()}})}});this.addTile(tile,0);bottomTiles.add(tile)}}this.showControls()}};SceneAudioEditor.prototype.showControls=function(resizeRequired){if(this.enabled){if(resizeRequired===undefined){resizeRequired=true}if(resizeRequired){this.requestResize()}var camera=this.camera;var bottomTiles=this.bottomTiles;var i,tile;for(i=0;i<bottomTiles.length;++i){tile=bottomTiles[i];var targetY=-camera.targetHeight*.5+tile.collisionBounds[1];if(tile.position[1]>targetY){tile.setPositionY(targetY)}else{tile.setTileMovementY(targetY)}tile.setColourAlpha(1,true);tile.enabled=true}}};SceneAudioEditor.prototype.close=function(){var self=this;var camera=this.camera;this.stop();this.tileBackground.setColourAlpha(0,true);var tile;{tile=this.tileAlert;tile.setTextColourAlpha(0,true);tile.setColourAlpha(0,true,function(){self.deleteLater()});tile.translateTileMovementX(-(camera.targetWidth*.5)-tile.collisionSize.width)}{tile=this.tileModel;tile.setColourAlpha(0,true);tile.setTileMovementY(-(camera.targetHeight*.5)-tile.collisionSize.height)}var menuTiles=this.menuTiles;for(i=0;i<menuTiles.length;++i){tile=menuTiles[i];tile.translateTileMovementX(camera.targetWidth*.5+tile.collisionSize.width);tile.setColour(gColour.setRGBA(1,1,1,0),true);tile.enabled=false}var bottomTiles=this.bottomTiles;for(i=0;i<bottomTiles.length;++i){tile=bottomTiles[i];tile.translateTileMovementY(-tile.collisionSize.height);tile.setColourAlpha(0,true)}};SceneAudioEditor.prototype.setInfo=function(info){this.info=info;if(info.mp3){this.setAsset(info.mp3)}this.openControls()};SceneAudioEditor.prototype.setAsset=function(filename){if(filename){var self=this;var info=this.info;var tile=this.tileModel;var fileExtension=filename.getExtension();if(fileExtension==="mp3"){info.mp3=filename;var friendlyName=String.SplitBefore(filename,"_");friendlyName+=".mp3";tile.setText(friendlyName,true);this.requestResize();this.play();return true}}return false};SceneAudioEditor.prototype.onDragDropLoad=function(file,event){if(event&&event.target&&event.target.result){if(MultiplayerManager.LoggedIn){var data=event.target.result;this.prepareUpload(file,data)}}};SceneAudioEditor.prototype.prepareUpload=function(file,data){var self=this;var filename=file.name;filename=filename.toLowerCase();var fileExtension=filename.getExtension();if(fileExtension==="mp3"){var dataBuffer=new Uint8Array(data);this.uploadMP3(filename,dataBuffer)}else{AlertsManager.TimeoutAlert("only .mp3 is supported",2)}};SceneAudioEditor.prototype.uploadMP3=function(filename,data){var self=this;AlertsManager.ModalAlert("uploading...");var url=SERVER_ASSETS_URL+"assets/upload.php";var postData={filename:filename};postData.file=new Blob([data],{type:"text/plain"});if(MultiplayerManager.UseURLProxy(url)){postData.url=url;url=SERVER_ROOT+"backend/helper.php?uploadfile"}gURLManager.requestURL(url,postData,function(status,responseText){AlertsManager.Hide("uploading...");var uploaded=false;if(status>=CCURLRequest.Succeeded){if(responseText){var filename=responseText;if(MultiplayerManager.LoggedIn){uploaded=self.setAsset(filename)}}}if(!uploaded){AlertsManager.TimeoutAlert("failed to upload mp3 :(",2)}},1)};SceneAudioEditor.prototype.togglePlay=function(){var id="audioeditor";if(CCAudioManager.IsPlaying(id)){this.stop()}else{this.play()}};SceneAudioEditor.prototype.play=function(){var tile=this.tileModel;var id="audioeditor";if(this.info){if(this.info.mp3){tile.setColour(EditorManager.LightYellow,true);var self=this;CCAudioManager.Play(id,this.info.mp3,true,false,function(){if(self.enabled){tile.setColour(EditorManager.LightGreen,true)}else{CCAudioManager.Stop(id)}})}}};SceneAudioEditor.prototype.stop=function(){var tile=this.tileModel;var id="audioeditor";if(CCAudioManager.IsPlaying(id)){tile.setColour(EditorManager.LightRed,true);CCAudioManager.Stop(id)}};SceneAudioEditor.prototype.handleBackButton=function(){if(!this.disabledBackButton){this.disabledBackButton=true;if(this.onClose){this.onClose(false)}this.close();return true}return false};function SceneCharacterEditor(parentScene){MultiplayerManager.UpdateCallbacks.addOnce(this);this.construct();if(parentScene){this.setParent(parentScene)}this.cameraCentered=true;this.modelTiles=[];this.actions=[];this.info={};gEngine.addScene(this);this.open()}ExtendPrototype(SceneCharacterEditor,CCSceneAppUI);SceneCharacterEditor.prototype.deleteLater=function(){if(!this.disabledBackButton){this.disabledBackButton=true}if(this.sceneAssetEditor){this.sceneAssetEditor.close();this.sceneAssetEditor=null}this.CCSceneAppUI_deleteLater()};SceneCharacterEditor.prototype.handleBackButton=function(){if(!this.disabledBackButton){this.disabledBackButton=true;if(this.onClose){this.onClose(false)}this.close();return true}return false};SceneCharacterEditor.prototype.setup=function(){var self=this;var camera=gEngine.newSceneCamera(this);camera.setupViewport(0,0,1,1);camera.setCameraWidth(640,false);var tile;{tile=new CCTile3DButton(this);tile.setupTile(camera.targetWidth,camera.targetHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColour(gColour.set(.25,0));tile.setColourAlpha(.95,true);tile.setDrawOrder(204);this.cameraStickyTiles.add(tile);this.tileBackground=tile}this.menuTiles=[];this.bottomTiles=[];this.requestResize()};SceneCharacterEditor.prototype.syncUpdate=function(jsonData){if(jsonData.EditorCharacterCreated){AlertsManager.Hide("creating...");if(this.onClose){this.info.objectID=jsonData.EditorCharacterCreated;this.onClose(this.info);this.close()}}};SceneCharacterEditor.prototype.updateScene=function(delta){var updated=this.CCSceneAppUI_updateScene(delta);if(!CCEngine.IsMobile()){if(!this.sceneAssetEditor){var modelTiles=this.modelTiles;for(var i=0;i<modelTiles.length;++i){var tile=modelTiles[i];if(tile.modelObject){tile.modelObject.model.animate(delta)}}}}return updated};SceneCharacterEditor.prototype.resize=function(){this.CCSceneAppUI_resize();
var camera=this.camera;var i,tile;this.refreshListPositions();{this.tileBackground.setTileSize(camera.targetWidth,camera.targetHeight)}var y=camera.cameraHHeight;var menuTiles=this.menuTiles;for(i=0;i<menuTiles.length;++i){tile=menuTiles[i];tile.setPositionX(camera.cameraHWidth-tile.collisionBounds[0]);y-=tile.collisionBounds[1];tile.setPositionY(y);y-=tile.collisionBounds[1]}var bottomTiles=this.bottomTiles;var tileHeight=camera.targetHeight*.075;for(i=0;i<bottomTiles.length;++i){tile=bottomTiles[i];tile.setTileSize(tileHeight);if(i===0){tile.setPositionX(camera.cameraHWidth-tile.collisionBounds[0])}else{tile.positionTileLeftX(bottomTiles[i-1])}}this.showControls(false)};SceneCharacterEditor.prototype.touchPressed=function(touch){var result=this.CCSceneAppUI_touchPressed(touch);return true};SceneCharacterEditor.prototype.touchMoving=function(touch,touchDelta){var result=this.handleTilesTouch(touch,this.controlsMovingVertical?CCControls.touch_movingVertical:CCControls.touch_movingHorizontal);if(result===CCSceneAppUI.tile_touchAction){return true}else{var modelTiles=this.modelTiles;for(var i=0;i<modelTiles.length;++i){var tile=modelTiles[i];if(tile.modelObject){var x=touch.deltaX;var y=touch.deltaY;var camera=this.camera;var rotation=tile.modelObject.rotation;rotation[1]+=x*180;tile.modelObject.setRotationY(rotation[1]);rotation[0]+=y*180;tile.modelObject.setRotationX(rotation[0])}}return true}return true};SceneCharacterEditor.prototype.touchReleased=function(touch,touchAction){var result=this.CCSceneAppUI_touchReleased(touch,touchAction);return true};SceneCharacterEditor.prototype.open=function(message){this.message=message;var self=this;var camera=this.camera;var i,tile;var menuTiles=this.menuTiles;for(i=0;i<menuTiles.length;++i){menuTiles[i].deleteLater()}menuTiles.length=0;{{tile=new CCTile3DButton(this);tile.setupTexturedWidth(camera.cameraWidth*.1,"editor_tile_back.jpg",function(){self.showMenu()});tile.setColour(gColour.setRGBA(1,1,1,0));tile.setDrawOrder(220);tile.onRelease.push(function(){if(self.onClose){self.onClose(false)}self.close()});this.addTile(tile,0);menuTiles.add(tile)}{tile=new CCTile3DButton(this);tile.setupTexturedWidth(camera.cameraWidth*.1,"editor_tile_tick.jpg",function(){self.showMenu()});tile.setColour(gColour.setRGBA(1,1,1,0));tile.setDrawOrder(220);tile.onRelease.push(function(){self.onTick()});this.addTile(tile,0);this.tileTick=tile;menuTiles.add(tile)}{tile=new CCTile3DButton(this);tile.setupTexturedWidth(camera.cameraWidth*.1,"editor_tile_copy.jpg",function(){self.showMenu()});tile.setColour(gColour.setRGBA(1,1,1,0));tile.setDrawOrder(220);tile.onRelease.push(function(){self.onClone()});this.addTile(tile,0);this.tileClone=tile;menuTiles.add(tile)}}this.showMenu()};SceneCharacterEditor.prototype.showMenu=function(){if(this.enabled){this.requestResize();var camera=this.camera;var menuTiles=this.menuTiles;var i,tile;for(i=0;i<menuTiles.length;++i){tile=menuTiles[i];tile.setPositionX(camera.targetWidth*.5+tile.collisionSize.width);tile.translateTileMovementX(-tile.collisionSize.width*1.5);tile.setColourAlpha(1,true);tile.enabled=true}this.showControls()}};SceneCharacterEditor.prototype.openControls=function(){if(this.info&&this.info.objectID){var self=this;var camera=this.camera;var LoadedImageFunction=function(tile){return function(){tile.setPositionY(-camera.cameraHHeight-tile.collisionBounds[1]);self.showControls()}};var i,tile;var bottomTiles=this.bottomTiles;for(i=0;i<bottomTiles.length;++i){bottomTiles[i].deleteLater()}bottomTiles.length=0;if(MultiplayerManager.IsOwner(this.info.owners)){tile=new CCTile3DButton(this);tile.setupTextured("editor_icon_delete.jpg",new LoadedImageFunction(tile));tile.setColour(gColour.setRGBA(.5,0,0,0));tile.setDrawOrder(220);tile.onRelease.push(function(){if(MultiplayerManager.LoggedIn){AlertsManager.ConfirmationAlert("Delete character?",function(result){if(result){if(MultiplayerManager.LoggedIn){EditorManager.EditorDeleteCharacter(self.info)}self.close()}})}});this.addTile(tile,0);bottomTiles.add(tile)}this.showControls()}};SceneCharacterEditor.prototype.showControls=function(resizeRequired){if(this.enabled){if(resizeRequired===undefined){resizeRequired=true}if(resizeRequired){this.requestResize()}var camera=this.camera;var bottomTiles=this.bottomTiles;var i,tile;for(i=0;i<bottomTiles.length;++i){tile=bottomTiles[i];var targetY=-camera.targetHeight*.5+tile.collisionBounds[1];if(tile.position[1]>targetY){tile.setPositionY(targetY)}else{tile.setTileMovementY(-camera.targetHeight*.5+tile.collisionBounds[1])}tile.setColourAlpha(1,true);tile.enabled=true}}};SceneCharacterEditor.prototype.close=function(){var self=this;var camera=this.camera;this.tileBackground.setColourAlpha(0,true);var tile,i;var tiles=this.tiles;for(i=0;i<tiles.length;++i){tile=tiles[i];tile.setColourAlpha(0,true);tile.setTileMovementX(-(camera.targetWidth*.5)-tile.collisionSize.width)}{tile=this.tileBackground;tile.setColourAlpha(0,true,function(){self.deleteLater()})}var modelTiles=this.modelTiles;for(i=0;i<modelTiles.length;++i){tile=modelTiles[i];if(tile.modelObject){tile.modelObject.shouldRender=false}}var menuTiles=this.menuTiles;for(i=0;i<menuTiles.length;++i){tile=menuTiles[i];tile.setTileMovementX(+(camera.targetWidth*.5)+tile.collisionSize.width);tile.setColourAlpha(0,true);tile.enabled=false}var bottomTiles=this.bottomTiles;for(i=0;i<bottomTiles.length;++i){tile=bottomTiles[i];tile.setTileMovementY(-(camera.targetHeight*.5)-tile.collisionSize.height);tile.setColourAlpha(0,true)}};SceneCharacterEditor.prototype.onTick=function(){if(!this.info.owners||MultiplayerManager.IsOwner(this.info.owners)){this.onCreateCharacter();return}this.onClone()};SceneCharacterEditor.prototype.onClone=function(){var self=this;AlertsManager.ConfirmationAlert("Create clone of character?",function(result){if(result){delete self.info.objectID;self.onCreateCharacter()}else{if(self.onClose){self.onClose(false)}self.close()}})};SceneCharacterEditor.prototype.onCreateCharacter=function(){var info=this.info;info.actions=this.actions;var self=this;MultiplayerManager.Emit("EditorCharacterCreate",info);if(this.onClose){AlertsManager.ModalAlert("creating...")}else{this.close()}};SceneCharacterEditor.prototype.setCharacter=function(characterInfo){this.info=characterInfo;if(!MultiplayerManager.IsOwner(this.info.owners)){this.menuTiles.remove(this.tileTick);this.tileTick.shouldRender=false}if(characterInfo.actions){this.actions=characterInfo.actions}this.updatedList();this.openControls()};SceneCharacterEditor.prototype.clear=function(){var tile,i;var modelTiles=this.modelTiles;for(i=0;i<modelTiles.length;++i){tile=modelTiles[i];this.tiles.remove(tile);if(tile.tileAction){this.tiles.remove(tile.tileAction);tile.tileAction.deleteLater()}if(tile.tileSFX){this.tiles.remove(tile.tileSFX);tile.tileSFX.deleteLater()}if(tile.tileDelete){this.tiles.remove(tile.tileDelete);tile.tileDelete.deleteLater()}tile.deleteLater()}modelTiles.length=0};SceneCharacterEditor.prototype.selectModel=function(index,modelInfo){var self=this;this.clear();if(!this.sceneAssetEditor){this.sceneAssetEditor=new SceneAssetEditor(self,true,true)}if(index!==undefined){this.sceneAssetEditor.sceneUIListDBModels.findAndSelectID(this.actions[index].modelID,function(modelInfo){self.sceneAssetEditor.sceneUIListDBModels.onSelected(modelInfo)})}else if(modelInfo){this.sceneAssetEditor.sceneUIListDBModels.findAndSelectID(modelInfo.objectID);self.sceneAssetEditor.sceneUIListDBModels.onSelected(modelInfo)}else{this.sceneAssetEditor.sceneUIListDBModels.unselect()}this.sceneAssetEditor.sceneUIListDBModels.onSelected=function(modelInfo){if(index!==undefined){self.sceneAssetEditor.open("Action for "+self.actions[index].actionID)}else{self.sceneAssetEditor.open("New Action")}self.sceneAssetEditor.onClose=function(newModelInfo){self.sceneAssetEditor=null;if(newModelInfo){if(index!==undefined){self.assignModel(newModelInfo,index)}else{self.addModel(newModelInfo)}}else{self.updatedList()}};self.sceneAssetEditor.setModel(modelInfo)}};SceneCharacterEditor.prototype.addModel=function(modelInfo){var modelID=modelInfo.objectID;var actionID="action."+this.actions.length;var action={};action.modelID=modelID;action.actionID=actionID;this.actions.add(action);var self=this;DBAssets.LoadModelID(modelID,function(){self.updatedList()})};SceneCharacterEditor.prototype.assignModel=function(modelInfo,index){var modelID=modelInfo.objectID;var action=this.actions[index];action.modelID=modelID;var self=this;DBAssets.LoadModelID(modelID,function(){self.updatedList()})};SceneCharacterEditor.prototype.updatedList=function(){var self=this;var camera=this.camera;this.clear();var tile,i;var modelTiles=this.modelTiles;var LoadedModelFunction=function(tile,tex){return function(model3d){if(model3d){tile.removeText();var modelObject=tile.modelObject;if(!tile.modelObject){modelObject=new CCObject;tile.addChild(modelObject);modelObject.setTransparent();tile.modelObject=modelObject}modelObject.setModel(model3d);self.refreshModelSize(tile);if(tex){model3d.setTexture(tex)}}}};var actions=this.actions;var LoadedModelInfoFunction=function(tile){return function(modelInfo){if(modelInfo&&modelInfo.obj){CCModel3D.CacheModel(modelInfo.obj,true,new LoadedModelFunction(tile,modelInfo.tex))}}};var SelectModelFunction=function(index){return function(){self.selectModel(index)}};var RenameActionFunction=function(index){return function(){var actions=self.actions;var actionID=actions[index].actionID;AlertsManager.InputAlert(actionID,function(result){if(result){var found=false;for(var i=0;i<actions.length;++i){if(result===actions[i].actionID){found=true;break}}if(!found){actions[index].actionID=result;self.updatedList()}}})}};var RenameSFXFunction=function(index){return function(){var actions=self.actions;var sfxID=actions[index].sfxID;AlertsManager.InputAlert(sfxID?sfxID:"",function(result){if(result){actions[index].sfxID=result;self.updatedList()}else{if(actions[index].sfxID){delete actions[index].sfxID;self.updatedList()}}})}};var DeleteFunction=function(index){return function(){if(self.sceneUIListDBModels){self.sceneUIListDBModels.close();self.sceneUIListDBModels=null}self.actions.removeIndex(index);self.updatedList()}};for(i=0;i<actions.length;++i){var action=actions[i];tile=new CCTile3DButton(this,true);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColourAlpha(1,true);tile.setDrawOrder(205);modelTiles.add(tile);tile.onRelease.push(new SelectModelFunction(i));this.addTile(tile,0);var modelID=action.modelID;tile.setText("loading...");DBAssets.LoadModelID(modelID,new LoadedModelInfoFunction(tile));var actionID=action.actionID;{var tileAction=new CCTile3DButton(this);tileAction.setupText(actionID,1,true,true);tileAction.setTextColour(gColour.set(1,1));tileAction.setTileTexture("editor_tile_background.jpg");tileAction.setColour(EditorManager.LightBlue);tileAction.setColourAlpha(0,false);tileAction.setColourAlpha(1,true);tileAction.setDrawOrder(221);tileAction.positionTileAbove(tile);tileAction.onRelease.push(new RenameActionFunction(i));this.addTile(tileAction,0);tile.tileAction=tileAction}var sfxID=action.sfxID;{var tileSFX=new CCTile3DButton(this);tileSFX.setupText(sfxID?sfxID:"SFX...",1,true,true);tileSFX.setTextColour(gColour.set(1,1));tileSFX.setTileTexture("editor_tile_background.jpg");tileSFX.setColour(EditorManager.LightBlue);tileSFX.setColourAlpha(0,false);tileSFX.setColourAlpha(1,true);tileSFX.setDrawOrder(221);tileSFX.positionTileBelow(tile);tileSFX.onRelease.push(new RenameSFXFunction(i));this.addTile(tileSFX,0);tile.tileSFX=tileSFX}{var tileDelete=new CCTile3DButton(this);tileDelete.setupText("delete",1,true,true);tileDelete.setTextColour(gColour.set(1,1));tileDelete.setTileTexture("editor_tile_background.jpg");tileDelete.setColour(EditorManager.Red);tileDelete.setColourAlpha(1,true);tileDelete.setDrawOrder(221);tileDelete.positionTileBelow(tile.tileSFX);tileDelete.onRelease.push(new DeleteFunction(i));this.addTile(tileDelete,0);tile.tileDelete=tileDelete}}{tile=new CCTile3DButton(this);tile.setupText("+",1,true,true);tile.setTextColour(gColour.set(1,1));tile.setTileTexture("editor_tile_background.jpg");tile.setColour(EditorManager.LightGreen);tile.setColourAlpha(0,false);tile.setColourAlpha(1,true);tile.setDrawOrder(205);modelTiles.add(tile);tile.onRelease.push(function(){self.selectModel()});this.addTile(tile)}this.refreshListPositions()};SceneCharacterEditor.prototype.refreshModelSize=function(tile){var modelObject=tile.modelObject;if(modelObject){var model3d=modelObject.model;if(model3d){var size=tile.collisionSize.width*.75;var scaleFactor;var modelWidth=model3d.getWidth()>model3d.getDepth()?model3d.getWidth():model3d.getDepth();var modelHeight=model3d.getHeight();if(modelWidth>modelHeight){scaleFactor=size/modelWidth}else{scaleFactor=size/modelHeight}model3d.setScale(scaleFactor)}}};SceneCharacterEditor.prototype.refreshListPositions=function(){var modelTiles=this.modelTiles;if(modelTiles.length>0){var self=this;var camera=this.camera;var actions=this.actions;var tileArea=camera.targetWidth*.8;if(actions.length===0){tileArea*=.25}var modelSize=tileArea/(actions.length+1);if(modelSize>camera.targetWidth*.25){modelSize=camera.targetWidth*.25}var tileSize=tileArea*.05;var x=-tileArea*.5;var tile,i;for(i=0;i<modelTiles.length-1;++i){var modelTile=modelTiles[i];tile=modelTile;x+=modelSize*.5;tile.setTileSize(modelSize);tile.setPositionX(x);tile.setTextHeight(tile.collisionSize.height*.1);this.refreshModelSize(tile);tile=modelTile.tileAction;if(tile){tile.setTextHeight(tileArea*.025,true);tile.setTileSize(modelSize,tileSize);tile.positionTileAbove(modelTile)}tile=modelTile.tileSFX;if(tile){tile.setTextHeight(tileArea*.025,true);tile.setTileSize(modelSize,tileSize);tile.positionTileBelow(modelTile)}tile=modelTile.tileDelete;if(tile){tile.setTextHeight(tileArea*.025,true);tile.setTileSize(modelSize,tileSize);tile.positionTileBelow(modelTile.tileSFX)}x+=modelSize*.5}tile=modelTiles[modelTiles.length-1];{x+=modelSize*.5;tile.setTextHeight(modelSize*.5,true);tile.setTileSize(modelSize);tile.setPositionX(x)}}};function SceneUIList(){}ExtendPrototype(SceneUIList,CCSceneAppUI);SceneUIList.prototype.updateControls=function(controls){var usingControls=this.CCSceneAppUI_updateControls(controls);var cameraTouches=this.camera.cameraTouches;var touch=cameraTouches[0];if(touch.x>0&&touch.x<1&&touch.y>0&&touch.y<1&&touch.startX>0&&touch.startX<1&&touch.startY>0&&touch.startY<1){if(controls.wheel&&controls.wheel.delta!==0){var delta=controls.wheel.delta;this.cameraScrolling=true;this.controlsMovingVertical=true;this.touchCameraMoving(0,delta*.1);return true}}return usingControls};SceneUIList.prototype.touchPressed=function(touch){if(this.CCSceneAppUI_touchPressed(touch)){return true}return true};SceneUIList.prototype.touchMovementAllowed=function(touch,touchDelta){var absDeltaX=Math.abs(touch.totalDeltaX);var absDeltaY=Math.abs(touch.totalDeltaY);if(absDeltaX>CCControls.TouchMovementThreashold.x||absDeltaY>CCControls.TouchMovementThreashold.y){this.controlsMoving=true;touchDelta.x+=touch.totalDeltaX;touchDelta.y+=touch.totalDeltaY;this.controlsMovingVertical=true;return true}return false};SceneUIList.prototype.touchMoving=function(touch,touchDelta){return this.CCSceneAppUI_touchMoving(touch,touchDelta)};SceneUIList.prototype.touchReleased=function(touch,touchAction){return this.CCSceneAppUI_touchReleased(touch,touchAction)};SceneUIList.prototype.refreshCameraView=function(){this.sceneLeft=0;this.sceneRight=0;this.sceneTop=0;this.sceneBottom=0;var tiles=this.tiles;for(var i=0;i<tiles.length;++i){var tile=tiles[i];var bottomY=tile.getTileMovementTarget()[1]-tile.collisionBounds[1];if(bottomY<this.sceneBottom){this.sceneBottom=bottomY;if(this.sceneBottom>this.sceneTop){this.sceneBottom=this.sceneTop}}}};SceneUIList.prototype.lockCameraView=function(){if(this.cameraScrolling){return}var camera=this.camera;camera.flagUpdate();camera.targetLookAt[0]=0;if(camera.targetLookAt[1]>this.sceneTop){camera.targetLookAt[1]=this.sceneTop}else if(camera.targetLookAt[1]<this.sceneBottom){camera.targetLookAt[1]=this.sceneBottom}};function SceneUIListTags(parentScene){this.maxColumns=1;this.construct();this.setParent(parentScene);parentScene.linkScene(this);gEngine.addScene(this);var self=this;this.sceneUIBack=new SceneUIBack(this,function(){self.close()},true)}ExtendPrototype(SceneUIListTags,SceneUIList);SceneUIListTags.prototype.deleteLater=function(){this.SceneUIList_deleteLater()};SceneUIListTags.prototype.setup=function(){var parentCamera=this.parentScene.camera;var parentCameraIndex=gEngine.findCameraIndex(parentCamera);var camera=gEngine.newSceneCamera(this);camera.setupViewport(0,0,1,1);camera.setCameraWidth(640*1,false);this.SceneUIList_setup();var tile;{tile=new CCTile3DButton(this);tile.setupTile();tile.setTileTexture("editor_tile_background.jpg");tile.setColour(gColour.set(.5,0));tile.setColourAlpha(.95,true);tile.setDrawOrder(200);this.cameraStickyTiles.add(tile);this.tileBackground=tile}this.list=["Buildings","Characters","Environment","Vehicles"];this.objectsList=[];this.show()};SceneUIListTags.prototype.resize=function(){this.SceneUIList_resize();var camera=this.camera;var tile;{tile=this.tileBackground;tile.setTileSize(camera.targetWidth,camera.targetHeight)}var objects=this.objectsList;var y=camera.cameraHHeight;for(var i=0;i<objects.length;++i){tile=objects[i].tiles[0];y-=tile.collisionBounds[1];tile.setPositionY(y);tile.setTileMovementX(0);y-=tile.collisionBounds[1]}};SceneUIListTags.prototype.show=function(){if(this.closing){return}var db=this.list;if(db){var objects=this.objectsList;var i,tile,j;var object;for(i=0;i<db.length;++i){info=db[i];if(objects.length>i){object=objects[objectIndex];if(info===object.info){continue}objects.remove(object);for(j=0;j<object.tiles.length;++j){tile=object.tiles[j];this.tiles.remove(tile);tile.deleteLater()}}object=this.createObject(info);objects.insert(object,i)}while(objects.length>i){object=objects[objectIndex];objects.remove(object);for(j=0;j<object.tiles.length;++j){tile=object.tiles[j];this.tiles.remove(tile);tile.deleteLater()}}}this.requestResize()};SceneUIListTags.prototype.close=function(){this.closing=true;var self=this;var tile;{tile=this.tileBackground;tile.setColourAlpha(0,true,function(){self.deleteLater()})}var camera=this.camera;var objects=this.objectsList;for(var i=0;i<objects.length;++i){object=objects[i];var tiles=object.tiles;for(var j=0;j<tiles.length;++j){tile=tiles[j];tile.setTileMovementX(camera.targetWidth*.5+tile.collisionBounds[0]);tile.setColour(gColour.setRGBA(1,1,1,0),tile.visible);tile.setCollideable(false)}}};SceneUIListTags.prototype.createObject=function(info){var self=this;var objectsList=this.objectsList;var SelectObjectFunction=function(info){return function(){if(self.onSelected){self.onSelected(info)}}};var camera=this.camera;var tileWidth=camera.targetWidth*.25/this.maxColumns;var tileHeight=tileWidth*.2;var object={};object.tiles=[];object.info=info;var tile;{tile=new CCTile3DButton(this);tile.setupText(""+info,tileHeight,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.set(.25,.9));tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(205);tile.onRelease.push(new SelectObjectFunction(info));this.addTile(tile);object.tiles.add(tile);tile.setPositionX(-camera.targetWidth*.5-tile.collisionBounds[0]);tile.setTileMovementX(0);var duration=.5+.125*objectsList.length;tile.movementInterpolator.setDuration(duration)}return object};function SceneUIListObjects(parentScene){this.construct(parentScene)}ExtendPrototype(SceneUIListObjects,SceneUIList);SceneUIListObjects.prototype.construct=function(parentScene){if(!this.maxColumns){this.maxColumns=1}this.SceneUIList_construct();{this.setParent(parentScene)}gEngine.addScene(this)};SceneUIListObjects.prototype.setup=function(){var camera;if(this.camera){camera=this.camera}else{camera=gEngine.newSceneCamera(this);camera.setupViewport(0,0,.125,1);camera.setCameraWidth(640*.125,false)}var tile;{tile=new CCTile3DButton(this);tile.setupTile();tile.setTileTexture("editor_tile_background.jpg");tile.setColour(gColour.set(.5,0));tile.setColourAlpha(.95,true);tile.setDrawOrder(200);this.cameraStickyTiles.add(tile);this.tileBackground=tile}this.selectionIndex=-1;this.currentPage=0;this.maxItemsPerPage=3;this.objectsList=[];var self=this;var tileWidth=camera.targetWidth/this.maxColumns;if(tileWidth>100){tileWidth=100}var tileHeight=tileWidth*.5;if(this.onNew){tile=new CCTile3DButton(this);tile.visibleOnlyUpdate=true;tile.setupText("+",tileHeight,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.setRGBA(.25,.75,.25,0));tile.setTextColour(gColour.setRGBA(1,1,1,0));tile.setColourAlpha(.9,true);tile.setTextColourAlpha(1,true);tile.setDrawOrder(205);tile.onRelease.push(function(){self.onNew()});this.addTile(tile);this.tileNew=tile}this.requestResize();this.show()};SceneUIListObjects.prototype.updateScene=function(delta){var updated=this.SceneUIList_updateScene(delta);if(this.selectionIndex!==-1){var object=this.getSelectedObject;if(object.modelObject){object.modelObject.rotateY(delta*30);object.modelObject.model.animate(delta)}}return updated};SceneUIListObjects.prototype.resize=function(){this.SceneUIList_resize();var camera=this.camera;var tile;{tile=this.tileBackground;tile.setTileSize(camera.targetWidth,camera.targetHeight)}this.resizeLists(camera.cameraHHeight)};SceneUIListObjects.prototype.resizeLists=function(y){var camera=this.camera;var tile;if(this.tileNew){tile=this.tileNew;y-=tile.collisionBounds[1];tile.setPositionXY(-camera.targetWidth*.5+tile.collisionBounds[0],y);y-=tile.collisionBounds[1];y-=camera.cameraHHeight*.05}y=this.resizeList(this.objectsList,y);y-=camera.cameraHHeight*.05};SceneUIListObjects.prototype.resizeList=function(list,currentY){var camera=this.camera;var maxColumns=this.maxColumns;var xIncrement=camera.targetWidth/maxColumns;var xStart=-camera.targetWidth*.5+xIncrement*.5;var i,j,object,tiles,tile;var columnIndex=0;var x=xStart;var y=currentY;var bottomY=y;for(i=0;i<list.length;++i){currentY=y;object=list[i];tiles=object.tiles;for(j=0;j<tiles.length;++j){tile=tiles[j];currentY-=tile.collisionBounds[1];tile.setPositionXYZ(x,currentY,0);if(!tile.positioned){tile.positioned=true;tile.setPositionX(-camera.targetWidth*.5-tile.collisionBounds[0])}currentY-=tile.collisionBounds[1]}if(currentY<bottomY){bottomY=currentY}x+=xIncrement;if(columnIndex===maxColumns-1){columnIndex=0;x=xStart;y=bottomY}else{columnIndex++}}return bottomY};SceneUIListObjects.prototype.refreshedObjectsList=function(){var camera=this.camera;var objectsList=this.objectsList;var tiles,i,tile,j;var duration=1;for(i=0;i<objectsList.length;++i){tiles=objectsList[i].tiles;for(j=0;j<tiles.length;++j){tile=tiles[j];tile.movementInterpolator.setDuration(duration)}}this.requestResize();this.positionObjectsList(this.objectsList);this.highlightSelectedObject()};SceneUIListObjects.prototype.positionObjectsList=function(list){var camera=this.camera;var cameraTop=camera.targetLookAt[1]-camera.targetHeight*.5;var cameraBottom=camera.targetLookAt[1]+camera.targetHeight*.5;var maxColumns=this.maxColumns;var xIncrement=camera.targetWidth/maxColumns;var xStart=-camera.targetWidth*.5+xIncrement*.5;var x=xStart;var columnIndex=0;for(var i=0;i<list.length;++i){var tiles=list[i].tiles;for(var j=0;j<tiles.length;++j){var tile=tiles[j];var visible=false;if(tile.aabbMax[1]>cameraTop){if(tile.aabbMin[1]<cameraBottom){visible=true}}{tile.setPositionX(x)}tile.setCollideable(true)}x+=xIncrement;if(columnIndex===maxColumns-1){columnIndex=0;x=xStart}else{columnIndex++}}};SceneUIListObjects.prototype.show=function(){if(this.closing){return}var list=this.list;if(list){var i,tile,tiles,j;var info;var objectsList=this.objectsList;var object;for(i=0;i<list.length;++i){info=list[i];if(objectsList.length>i){object=objectsList[i];var newInfoString=JSON.stringify(info);var currentInfoString=JSON.stringify(object.info);if(newInfoString===currentInfoString){continue}objectsList.remove(object);for(j=0;j<object.tiles.length;++j){tile=object.tiles[j];this.tiles.remove(tile);tile.deleteLater()}}object=this.createObject(info);objectsList.insert(object,i)}while(objectsList.length>list.length){object=objectsList[list.length];objectsList.remove(object);for(j=0;j<object.tiles.length;++j){tile=object.tiles[j];this.tiles.remove(tile);tile.deleteLater()}}}this.refreshedObjectsList();this.highlightSelectedObject()};SceneUIListObjects.prototype.close=function(){this.closing=true;var self=this;var camera=this.camera;var tile;{tile=this.tileBackground;tile.setColourAlpha(0,true,function(){self.deleteLater()})}if(this.tileNew){tile=this.tileNew;tile.setTileMovementX(-camera.targetWidth*.5-tile.collisionSize.width);tile.setColour(gColour.setRGBA(1,1,1,0),true);tile.setCollideable(false)}var objectsList=this.objectsList;for(var i=0;i<objectsList.length;++i){var tiles=objectsList[i].tiles;for(var j=0;j<tiles.length;++j){tile=tiles[j];{tile.setPositionX(-camera.targetWidth*.5-tile.collisionSize.width)}tile.setColour(gColour.setRGBA(1,1,1,0),tile.visible);tile.setCollideable(false)}}};SceneUIListObjects.prototype.getSelectedObject=function(){var selectedInfo=this.getSelected();if(selectedInfo){var objectsList=this.objectsList;for(var i=0;i<objectsList.length;++i){var object=objectsList[i];if(object.info===selectedInfo){return object}}}return null};SceneUIListObjects.prototype.highlightSelectedObject=function(){var camera=this.camera;var cameraTop=camera.targetLookAt[1]-camera.targetHeight*.5;var cameraBottom=camera.targetLookAt[1]+camera.targetHeight*.5;var selectionIndex=this.selectionIndex;var selectedObject=this.getSelectedObject();var objectsList=this.objectsList;for(var i=0;i<objectsList.length;++i){var object=objectsList[i];var tiles=object.tiles;for(var j=0;j<tiles.length;++j){var tile=tiles[j];var visible=false;if(tile.aabbMax[1]>cameraTop){if(tile.aabbMin[1]<cameraBottom){visible=true}}if(object===selectedObject){if(j===tiles.length-1){camera.targetLookAt[1]=tile.position[1];this.refreshCameraView();this.lockCameraView()}if(j===0){tile.setColour(gColour.setRGBA(.4,.5,.75,0),true)}tile.setColourAlpha(1,visible)}else{if(j===0){tile.setColour(gColour.set(.25,0),true)}tile.setColourAlpha(.75,visible)}}}};SceneUIListObjects.prototype.getInfoIndex=function(info){if(this.list){return this.list.find(info)}return null};SceneUIListObjects.prototype.getInfo=function(index){if(this.list&&index>=0&&index<this.list.length){return this.list[index]}return null};SceneUIListObjects.prototype.getSelected=function(){return this.getInfo(this.selectionIndex)};SceneUIListObjects.prototype.unselect=function(){this.selectionIndex=-1;this.highlightSelectedObject()};SceneUIListObjects.prototype.selectIndex=function(i,callback,findInfo){if(this.selectionIndex!==i){this.selectionIndex=i;this.highlightSelectedObject()}var selectedInfo=this.getSelected();if(this.onSelected){this.onSelected(selectedInfo)}if(callback){callback(selectedInfo)}};SceneUIListObjects.prototype.findAndSelectID=function(id,callback,findInfo){var list=this.list;if(list){for(var i=0;i<list.length;++i){var itr=list[i];var itrID=DBAssets.GetID(itr);if(itrID===id){this.selectIndex(i,callback,findInfo);return}}this.selectionIndex=-1;this.highlightSelectedObject()}if(!this.loaded){var self=this;this.onLoaded=function(){self.findAndSelectID(id,callback,findInfo)}}else{if(callback){callback(false)}}};function SceneUIListObjectsMap(parentScene,mapEditor){this.construct(parentScene);this.mapEditor=mapEditor}ExtendPrototype(SceneUIListObjectsMap,SceneUIListObjects);SceneUIListObjectsMap.prototype.setup=function(){var parentCameraIndex=gEngine.findCameraIndex(this.parentScene.camera);var camera=gEngine.newSceneCamera(this,parentCameraIndex+1);camera.setupViewport(0,0,.25,1);camera.setCameraWidth(640*.25,false);this.SceneUIListObjects_setup()};SceneUIListObjectsMap.prototype.updateScene=function(delta){var updated=this.CCSceneAppUI_updateScene(delta);var objects=this.objectsList;for(var i=0;i<objects.length;++i){var object=objects[i];if(object.modelObject){object.modelObject.rotateY(delta*30);object.modelObject.model.animate(delta)}}return updated};SceneUIListObjectsMap.prototype.render=function(camera,pass,alpha){this.CCSceneAppUI_render(camera,pass,alpha)};SceneUIListObjectsMap.prototype.resizeLists=function(y){this.resizeList(this.objectsList,y)};SceneUIListObjectsMap.prototype.clearObjects=function(){var objectsList=this.objectsList;while(objectsList.length>0){var object=objectsList[0];objectsList.remove(object);for(var j=0;j<object.tiles.length;++j){tile=object.tiles[j];this.tiles.remove(tile);tile.deleteLater()}--i}};SceneUIListObjectsMap.prototype.showObjects=function(objects){var self=this;var i,j,tile,tiles,object,newObject;var objectsList=this.objectsList;for(i=0;i<objectsList.length;++i){object=objectsList[i];if(objects.length>i){newObject=objects[i]}else{newObject=null}if(object.object!==newObject){objectsList.remove(object);for(j=0;j<object.tiles.length;++j){tile=object.tiles[j];this.tiles.remove(tile);tile.deleteLater()}--i}}var FindObjectFunction=function(object){return function(){self.mapEditor.findObject(object)}};var EditImageFunction=function(object){return function(){self.mapEditor.sceneUI.openAssetEditor("Select Map Image",false,true,function(tex){if(tex){self.mapEditor.mapsManager.handleEditMapTexture(tex)}});var currentTexture="";if(object.model&&object.model.primitives.length>0){var primitive=object.model.primitives[0];var textureHandle=primitive.getTextureHandle();if(textureHandle){self.mapEditor.sceneUI.sceneAssetEditor.sceneUIListDBImages.findAndSelect(textureHandle.filename)}}}};var EditModelFunction=function(object){return function(){self.mapEditor.sceneUI.openAssetEditor("Edit Model",true,false,function(modelInfo){if(modelInfo){var modelID=modelInfo.objectID;if(modelID!==object.modelID||modelInfo.obj!==object.obj||modelInfo.tex!==object.tex){object.obj=modelInfo.obj;object.tex=modelInfo.tex;object.modelID=modelID;MultiplayerManager.Emit("EditorObjectModel",object.getID(),modelID);self.clearObjects()}}self.mapEditor.sceneUI.objectEditorOpen(objects)});DBAssets.LoadID(object.modelID,function(modelInfo){if(modelInfo){self.mapEditor.sceneUI.sceneAssetEditor.setModel(modelInfo)}else{self.mapEditor.sceneUI.sceneAssetEditor.setAsset(object.obj);self.mapEditor.sceneUI.sceneAssetEditor.setAsset(object.tex)}})}};var DeleteObjectFunction=function(object){return function(){self.mapEditor.deleteObject(object)}};var LoadedModelFunction=function(object,tile,tex){return function(model3d){if(model3d){var modelObject=new CCObject;tile.addChild(modelObject);modelObject.setModel(model3d);modelObject.setTransparent();{var size=tile.collisionSize.width*.75;var scaleFactor;var modelWidth=model3d.getWidth()>model3d.getDepth()?model3d.getWidth():model3d.getDepth();var modelHeight=model3d.getHeight();if(modelWidth>modelHeight){scaleFactor=size/modelWidth}else{scaleFactor=size/modelHeight}model3d.setScale(scaleFactor)}if(tex){model3d.setTexture(tex)}object.modelObject=modelObject}}};var camera=this.camera;var tileWidth=camera.targetWidth;var tileHeight=camera.targetWidth*.125;var newObjects=[];for(i=0;i<objects.length;++i){newObject=objects[i];var text;if(objectsList.length>i){object=objectsList[i];if(object.object===newObject){text="size:"+CC.FloatLimitPrecision(newObject.collisionSize.width);text+=" x:"+CC.FloatLimitPrecision(newObject.position[0]);text+=" z:"+CC.FloatLimitPrecision(newObject.position[2]);tile=object.tileDescription;tile.setText(text);continue}}object={};object.object=newObject;object.tiles=[];objectsList.add(object);newObjects.add(object);{tile=new CCTile3DButton(this);tile.setupText(newObject.getID(),tileHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);
tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.set(.25,.9));tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(205);tile.onRelease.push(new FindObjectFunction(newObject));this.addTile(tile);object.tiles.add(tile)}if(newObject.obj){tile=new CCTile3DButton(this);tile.setupTile(tileWidth,tileWidth);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setDrawOrder(205);tile.onRelease.push(new FindObjectFunction(newObject));this.addTile(tile);object.tiles.add(tile);CCModel3D.CacheModel(newObject.obj,true,new LoadedModelFunction(object,tile,newObject.tex))}{tile=new CCTile3DButton(this);object.tileDescription=tile;text="Size:"+CC.FloatLimitPrecision(newObject.collisionSize.width);text+=" X:"+CC.FloatLimitPrecision(newObject.position[0]);text+=" Z:"+CC.FloatLimitPrecision(newObject.position[2]);tile.setupText(text,tileHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.set(.25,.9));tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(205);this.addTile(tile);object.tiles.add(tile)}if(newObject.objectID==="ground"){{tile=new CCTile3DButton(this);tile.setupText("Edit Image",tileHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.setRGBA(.25,.5,.75,.9),true);tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(205);tile.onRelease.push(new EditImageFunction(newObject));this.addTile(tile);object.tiles.add(tile)}}else{if(newObject.modelID){tile=new CCTile3DButton(this);tile.setupText("Settings",tileHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.setRGBA(.25,.5,.75,.9),true);tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(205);tile.onRelease.push(new EditModelFunction(newObject));this.addTile(tile);object.tiles.add(tile)}{tile=new CCTile3DButton(this);tile.setupText("Delete",tileHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.setRGBA(.75,.25,.25,.9));tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(205);tile.onRelease.push(new DeleteObjectFunction(newObject));this.addTile(tile);object.tiles.add(tile)}}}var duration=1;for(i=0;i<objectsList.length;++i){tiles=objectsList[i].tiles;for(j=0;j>tiles.length;++j){tile=tiles[j];tile.movementInterpolator.setDuration(duration);duration+=.125}}this.requestResize();for(i=0;i<newObjects.length;++i){tiles=newObjects[i].tiles;for(j=0;j<tiles.length;++j){tile=tiles[j];tile.setPositionX(-camera.targetWidth*.5-tile.collisionSize.width);tile.translateTileMovementX(tile.collisionSize.width*1.5);tile.setColourAlpha(1,true);tile.setCollideable(true)}}};function SceneUIListObjectsUI(parentScene,editor){this.construct(parentScene);this.editor=editor}ExtendPrototype(SceneUIListObjectsUI,SceneUIListObjects);SceneUIListObjectsUI.prototype.setup=function(){var parentCameraIndex=gEngine.findCameraIndex(this.parentScene.camera);var camera=gEngine.newSceneCamera(this,parentCameraIndex+1);camera.setupViewport(0,0,.25,1);camera.setCameraWidth(640*.25,false);this.SceneUIListObjects_setup()};SceneUIListObjectsUI.prototype.updateScene=function(delta){var updated=this.CCSceneAppUI_updateScene(delta);var objects=this.objectsList;for(var i=0;i<objects.length;++i){var object=objects[i];if(object.modelObject){object.modelObject.rotateY(delta*30);object.modelObject.model.animate(delta)}}return updated};SceneUIListObjectsUI.prototype.render=function(camera,pass,alpha){this.CCSceneAppUI_render(camera,pass,alpha)};SceneUIListObjectsUI.prototype.resizeLists=function(y){this.resizeList(this.objectsList,y)};SceneUIListObjectsUI.prototype.showObjects=function(objects){var self=this;var i,j,tile,tiles,object,newObject;var objectsList=this.objectsList;for(i=0;i<objectsList.length;++i){object=objectsList[i];if(objects.length>i){newObject=objects[i]}else{newObject=null}if(object.object!==newObject){objectsList.remove(object);for(j=0;j<object.tiles.length;++j){tile=object.tiles[j];this.tiles.remove(tile);tile.deleteLater()}--i}}var FindObjectFunction=function(uiObject){return function(){self.editor.findObject(uiObject)}};var DeleteObjectFunction=function(uiObject){return function(){self.editor.deleteObject(uiObject)}};var EditTypeFunction=function(uiObject){return function(){var current=uiObject.constructor.name;AlertsManager.InputAlert(current,function(result){if(result){if(current!==result){var position=uiObject.position;self.editor.deleteObject(uiObject);self.editor.createObject(position,result)}}})}};var EditNameFunction=function(uiObject){return function(){var current=uiObject.name?uiObject.name:"";AlertsManager.InputAlert(current,function(result){if(result!==false){if(current!==result){uiObject.name=result;self.editor.updatedObject(uiObject)}}})}};var EditColourFunction=function(uiObject){return function(){var colouringObject=uiObject;if(colouringObject){var current=colouringObject.colour.toString();if(uiObject.isBlinking()){var textColourSplit=current.split(",");current=textColourSplit[0]+","+textColourSplit[1]+","+textColourSplit[2]+",1"}AlertsManager.InputAlert(current,function(result){if(result){if(current!==result){gColour.set(colouringObject.colour);colouringObject.setColour(gColour.fromString(result));self.editor.updatedObject(uiObject)}}},{dot:true,comma:true,minus:true})}}};var EditBlinkingFunction=function(uiObject){return function(){var blinking=uiObject.isBlinking();uiObject.setBlinking(!blinking);self.editor.updatedObject(uiObject)}};var EditImageFunction=function(uiObject){return function(){var sceneAssetEditor=new SceneAssetEditor(self,false,true);sceneAssetEditor.open("Select Image");var currentTexture=uiObject.getTileTextureFilename();if(currentTexture){sceneAssetEditor.sceneUIListDBImages.findAndSelect(currentTexture)}sceneAssetEditor.onClose=function(tex){if(tex){if(!uiObject.getTileTextureHandle()){uiObject.aspectRatioLocked=true}uiObject.setTileTexture(tex,function(tile){if(tile.aspectRatioLocked){tile.setTileTexturedWidth(tile.collisionSize.width)}});self.editor.updatedObject(uiObject)}}}};var EditImageAspectRatioFunction=function(uiObject){return function(){uiObject.aspectRatioLocked=!uiObject.aspectRatioLocked;self.editor.updatedObject(uiObject)}};var EditFullScreenFunction=function(uiObject){return function(){uiObject.fullScreen=!uiObject.fullScreen;self.editor.updatedObject(uiObject)}};var EditFlipXFunction=function(uiObject){return function(){uiObject.flipTileX();self.editor.updatedObject(uiObject)}};var EditFlipYFunction=function(uiObject){return function(){uiObject.flipTileY();self.editor.updatedObject(uiObject)}};var EditRotateZFunction=function(uiObject){return function(){var current=""+CC.FloatLimitPrecision(uiObject.rotation[2]);AlertsManager.InputAlert(current,function(result){if(result){if(current!==result){var newFloat=parseFloat(result);uiObject.setRotationZ(newFloat);self.editor.updatedObject(uiObject)}}},{dot:true,minus:true})}};var EditWidthFunction=function(uiObject){return function(){var current=""+CC.FloatLimitPrecision(self.editor.getReletiveWidth(uiObject)*100);AlertsManager.InputAlert(current,function(result){if(result){if(current!==result){var newFloat=parseFloat(result)/100;self.editor.setReletiveWidth(uiObject,newFloat);self.editor.updatedObject(uiObject)}}},{dot:true,minus:true})}};var EditHeightFunction=function(uiObject){return function(){var current=""+CC.FloatLimitPrecision(self.editor.getReletiveHeight(uiObject)*100);AlertsManager.InputAlert(current,function(result){if(result){if(current!==result){var newFloat=parseFloat(result)/100;self.editor.setReletiveHeight(uiObject,newFloat);self.editor.updatedObject(uiObject)}}},{dot:true,minus:true})}};var EditXFunction=function(uiObject){return function(){var current=""+CC.FloatLimitPrecision(self.editor.getReletiveX(uiObject)*100);AlertsManager.InputAlert(current,function(result){if(result){if(current!==result){var newFloat=parseFloat(result)/100;self.editor.setReletiveX(uiObject,newFloat);self.editor.updatedObject(uiObject)}}},{dot:true,minus:true})}};var EditYFunction=function(uiObject){return function(){var current=""+CC.FloatLimitPrecision(self.editor.getReletiveY(uiObject)*100);AlertsManager.InputAlert(current,function(result){if(result){if(current!==result){var newFloat=parseFloat(result)/100;self.editor.setReletiveY(uiObject,newFloat);self.editor.updatedObject(uiObject)}}},{dot:true,minus:true})}};var EditDrawOrderFunction=function(uiObject){return function(){var current=""+uiObject.drawOrder;AlertsManager.InputAlert(current,function(result){if(result){if(current!==result){result=parseInt(result,10);uiObject.setDrawOrder(result);self.editor.updatedObject(uiObject)}}},{letter:false})}};var EditTextFunction=function(uiObject){return function(){var currentText=uiObject.getText();if(!currentText){currentText=""}AlertsManager.InputAlert(currentText,function(result){if(result!==false){if(currentText!==result){if(!uiObject.getText()){uiObject.setTextScale(uiObject.textScale?uiObject.textScale:.75)}uiObject.setText(result);self.editor.updatedObject(uiObject)}}},{space:true,dot:true,comma:true,minus:true,length:32})}};var EditTextColourFunction=function(uiObject){return function(){var colouringObject=uiObject.textObject;if(colouringObject){var current=colouringObject.colour.toString();if(uiObject.isTextBlinking()){var textColourSplit=current.split(",");current=textColourSplit[0]+","+textColourSplit[1]+","+textColourSplit[2]+",1"}AlertsManager.InputAlert(current,function(result){if(result){if(current!==result){gColour.set(colouringObject.colour);colouringObject.setColour(gColour.fromString(result));self.editor.updatedObject(uiObject)}}},{dot:true,comma:true,minus:true})}}};var EditTextScaleFunction=function(uiObject){return function(){var current=""+(uiObject.textScale?CC.FloatLimitPrecision(uiObject.textScale):.75);AlertsManager.InputAlert(current,function(result){if(result){if(current!==result){var newFloat=parseFloat(result);uiObject.setTextScale(newFloat);self.editor.updatedObject(uiObject)}}},{dot:true,minus:true})}};var EditTextBlinkingFunction=function(uiObject){return function(){var blinking=uiObject.isTextBlinking();uiObject.setTextBlinking(!blinking);self.editor.updatedObject(uiObject)}};var Edit3DModelFunction=function(uiObject){return function(){var sceneAssetEditor=new SceneAssetEditor(self,true,true);sceneAssetEditor.open("Select Model");if(uiObject.model3dObject){sceneAssetEditor.sceneUIListDBModels.findAndSelect({obj:uiObject.model3dObject.obj,tex:uiObject.model3dObject.tex})}var currentTexture=uiObject.getTileTextureFilename();sceneAssetEditor.onClose=function(modelInfo){if(modelInfo){uiObject.set3DModel(modelInfo.obj,modelInfo.tex,1);self.editor.updatedObject(uiObject)}}}};var Edit3DModelColourFunction=function(uiObject){return function(){var colouringObject=uiObject.model3dObject;if(colouringObject){var current=colouringObject.colour.toString();AlertsManager.InputAlert(current,function(result){if(result){if(current!==result){gColour.set(colouringObject.colour);colouringObject.setColour(gColour.fromString(result));self.editor.updatedObject(uiObject)}}},{dot:true,comma:true,minus:true})}}};var Edit3DModelRotationFunction=function(uiObject){return function(){if(uiObject.model3dObject){var current=vec3.toString(uiObject.model3dObject.rotation);AlertsManager.InputAlert(current,function(result){if(result){if(current!==result){var newVector=vec3.fromString(result);uiObject.set3DModelRotation(newVector);self.editor.updatedObject(uiObject)}}},{dot:true,comma:true,minus:true})}}};var Edit3DModelAnimationSpeedFunction=function(uiObject){return function(){if(uiObject.model3dObject){var current=""+(uiObject.model3dAnimationSpeed?CC.FloatLimitPrecision(uiObject.model3dAnimationSpeed):0);AlertsManager.InputAlert(current,function(result){if(result){if(current!==result){var newFloat=parseFloat(result);uiObject.set3DModelAnimationSpeed(newFloat);self.editor.updatedObject(uiObject)}}},{dot:true})}}};var EditOnTouchFunction=function(uiObject,onTouch){return function(){var current="";if(onTouch.length>0){current=onTouch[0]}AlertsManager.InputAlert(current,function(result){if(result!==false){if(current!==result){result=result.formatSpacesAndTabs();result=self.editor.validateJS(result);if(result){if(onTouch.length>0){onTouch[0]=result}else{onTouch.push(result)}}else{if(onTouch.length>0){onTouch.pop()}}self.editor.updatedObject(uiObject)}}},{space:true,dot:true,minus:true,functional:true,height:.35,length:64})}};var camera=this.camera;var tileWidth=camera.targetWidth;var tileHeight=camera.targetWidth*.125;var newObjects=[];for(i=0;i<objects.length;++i){newObject=objects[i];if(objectsList.length>i){object=objectsList[i];if(object.object===newObject){this.updateObject(object,newObject);continue}}object={};object.object=newObject;object.tiles=[];objectsList.add(object);newObjects.add(object);{tile=new CCTile3DButton(this);tile.setupText("Delete",tileHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.setRGBA(.75,.25,.25,.9));tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(205);tile.onRelease.push(new DeleteObjectFunction(newObject));this.addTile(tile);object.tiles.add(tile)}{tile=new CCTile3DButton(this);tile.setupText("",tileHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.set(.25,.9));tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(205);tile.onRelease.push(new EditTypeFunction(newObject));this.addTile(tile);object.tiles.add(tile);object.tileType=tile}{tile=new CCTile3DButton(this);tile.setupText("",tileHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.set(.25,.9));tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(205);tile.onRelease.push(new EditNameFunction(newObject));this.addTile(tile);object.tiles.add(tile);object.tileName=tile}{tile=new CCTile3DButton(this);tile.setupText("",tileHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.set(1,.9));tile.setDrawOrder(205);tile.onRelease.push(new EditImageFunction(newObject));this.addTile(tile);object.tiles.add(tile);object.tileImage=tile}{tile=new CCTile3DButton(this);tile.setupText("",tileHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.set(.25,.9));tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(205);tile.onRelease.push(new EditColourFunction(newObject));this.addTile(tile);object.tiles.add(tile);object.tileColour=tile}{tile=new CCTile3DButton(this);tile.setupText("",tileHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.set(.25,.9));tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(205);tile.onRelease.push(new EditBlinkingFunction(newObject,true));this.addTile(tile);object.tiles.add(tile);object.tileBlinking=tile}{tile=new CCTile3DButton(this);tile.setupText("",tileHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.set(.25,.9));tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(205);tile.onRelease.push(new EditImageAspectRatioFunction(newObject));this.addTile(tile);object.tiles.add(tile);object.tileImageAspectRatio=tile}{tile=new CCTile3DButton(this);tile.setupText("",tileHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.set(.25,.9));tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(205);tile.onRelease.push(new EditFullScreenFunction(newObject));this.addTile(tile);object.tiles.add(tile);object.tileFullScreen=tile}{tile=new CCTile3DButton(this);tile.setupText("",tileHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.set(.25,.9));tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(205);tile.onRelease.push(new EditFlipXFunction(newObject));this.addTile(tile);object.tiles.add(tile);object.tileFlippedX=tile}{tile=new CCTile3DButton(this);tile.setupText("",tileHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.set(.25,.9));tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(205);tile.onRelease.push(new EditFlipYFunction(newObject));this.addTile(tile);object.tiles.add(tile);object.tileFlippedY=tile}{tile=new CCTile3DButton(this);tile.setupText("",tileHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.set(.25,.9));tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(205);tile.onRelease.push(new EditRotateZFunction(newObject));this.addTile(tile);object.tiles.add(tile);object.tileRotate=tile}{tile=new CCTile3DButton(this);tile.setupText("",tileHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.set(.25,.9));tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(205);tile.onRelease.push(new EditDrawOrderFunction(newObject));this.addTile(tile);object.tiles.add(tile);object.tileDrawOrder=tile}{tile=new CCTile3DButton(this);tile.setupText("",tileHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.set(.25,.9));tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(205);tile.onRelease.push(new EditWidthFunction(newObject));this.addTile(tile);object.tiles.add(tile);object.tileWidth=tile}{tile=new CCTile3DButton(this);tile.setupText("",tileHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.set(.25,.9));tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(205);tile.onRelease.push(new EditHeightFunction(newObject));this.addTile(tile);object.tiles.add(tile);object.tileHeight=tile}{tile=new CCTile3DButton(this);tile.setupText("",tileHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.set(.25,.9));tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(205);tile.onRelease.push(new EditXFunction(newObject));this.addTile(tile);object.tiles.add(tile);object.tileX=tile}{tile=new CCTile3DButton(this);tile.setupText("",tileHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.set(.25,.9));tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(205);tile.onRelease.push(new EditYFunction(newObject));this.addTile(tile);object.tiles.add(tile);object.tileY=tile}{tile=new CCTile3DButton(this);tile.setupText("",tileHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.set(.25,.9));tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(205);tile.onRelease.push(new EditTextFunction(newObject));this.addTile(tile);object.tiles.add(tile);object.tileText=tile}{tile=new CCTile3DButton(this);tile.setupText("",tileHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.set(.25,.9));tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(205);tile.onRelease.push(new EditTextScaleFunction(newObject));this.addTile(tile);object.tiles.add(tile);object.tileTextScale=tile}{tile=new CCTile3DButton(this);tile.setupText("",tileHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.set(.25,.9));tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(205);tile.onRelease.push(new EditTextColourFunction(newObject,true));this.addTile(tile);object.tiles.add(tile);object.tileTextColour=tile}{tile=new CCTile3DButton(this);tile.setupText("",tileHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.set(.25,.9));tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(205);tile.onRelease.push(new EditTextBlinkingFunction(newObject,true));this.addTile(tile);object.tiles.add(tile);object.tileTextBlinking=tile}{tile=new CCTile3DButton(this);tile.setupText("",tileHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.set(1,.9));tile.setDrawOrder(205);tile.onRelease.push(new Edit3DModelFunction(newObject,true));this.addTile(tile);object.tiles.add(tile);object.tile3DModel=tile}{tile=new CCTile3DButton(this);tile.setupText("",tileHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.set(.25,.9));tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(205);tile.onRelease.push(new Edit3DModelColourFunction(newObject,true));this.addTile(tile);object.tiles.add(tile);object.tile3DModelColour=tile}{tile=new CCTile3DButton(this);tile.setupText("",tileHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.set(1,.9));tile.setDrawOrder(205);tile.onRelease.push(new Edit3DModelRotationFunction(newObject,true));this.addTile(tile);object.tiles.add(tile);object.tile3DModelRotation=tile}{tile=new CCTile3DButton(this);tile.setupText("",tileHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.set(1,.9));tile.setDrawOrder(205);tile.onRelease.push(new Edit3DModelAnimationSpeedFunction(newObject,true));this.addTile(tile);object.tiles.add(tile);object.tile3DModelAnimationSpeed=tile}{tile=new CCTile3DButton(this);tile.setupText("",tileHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColour(EditorManager.LightBlue);tile.setColourAlpha(0,false);tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(205);tile.onRelease.push(new EditOnTouchFunction(newObject,newObject.onPress));this.addTile(tile);object.tiles.add(tile);object.tileOnPress=tile}{tile=new CCTile3DButton(this);tile.setupText("",tileHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColour(EditorManager.LightBlue);tile.setColourAlpha(0,false);tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(205);tile.onRelease.push(new EditOnTouchFunction(newObject,newObject.onLoss));this.addTile(tile);object.tiles.add(tile);object.tileOnLoss=tile}{tile=new CCTile3DButton(this);tile.setupText("",tileHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColour(EditorManager.LightBlue);tile.setColourAlpha(0,false);tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(205);tile.onRelease.push(new EditOnTouchFunction(newObject,newObject.onRelease));this.addTile(tile);object.tiles.add(tile);object.tileOnRelease=tile}this.updateObject(object,newObject)}var duration=1;for(i=0;i<objectsList.length;++i){tiles=objectsList[i].tiles;for(j=0;j>tiles.length;++j){tile=tiles[j];tile.movementInterpolator.setDuration(duration);duration+=.125}}this.requestResize();for(i=0;i<newObjects.length;++i){tiles=newObjects[i].tiles;for(j=0;j<tiles.length;++j){tile=tiles[j];tile.setPositionX(-camera.targetWidth*.5-tile.collisionSize.width);tile.setTileMovementX(0);tile.setColourAlpha(1,true);tile.setCollideable(true)}}};SceneUIListObjectsUI.prototype.updateObject=function(listObject,uiObject){var self=this;listObject.tileType.setText(uiObject.constructor.name);if(uiObject.name){listObject.tileName.setText("Name: "+uiObject.name)}else{listObject.tileName.setText("Name...")}var currentTexture=uiObject.getTileTextureFilename();if(currentTexture){listObject.tileImage.setTileTexture(currentTexture,function(tile,textureHandle){if(self.camera){tile.setupTexturedFit(self.camera.targetWidth,self.camera.targetHeight*.1);self.requestResize()}});listObject.tileImage.setText("")}else{listObject.tileImage.setText("Select Image...")}var colour=uiObject.colour?uiObject.colour.toString():"1,1,1,1";if(uiObject.isBlinking()){var colourSplit=colour.split(",");colour=colourSplit[0]+","+colourSplit[1]+","+colourSplit[2]+",1"}listObject.tileColour.setText("Tile Colour: "+colour);if(uiObject.colour){listObject.tileColour.setColour(gColour.setRGBA(uiObject.colour.r*.5,uiObject.colour.g*.5,uiObject.colour.b*.5,1))}listObject.tileBlinking.setText("Blinking: "+(uiObject.isBlinking()?"true":"false"));listObject.tileImageAspectRatio.setText(uiObject.aspectRatioLocked?"Aspect Ratio Locked":"Aspect Ratio Unlocked");listObject.tileFullScreen.setText("Fullscreen: "+(uiObject.fullScreen?"true":"false"));listObject.tileFlippedX.setText("Flip X");listObject.tileFlippedY.setText("Flip Y");listObject.tileRotate.setText("Rotate: "+uiObject.rotation[2]);listObject.tileDrawOrder.setText("Draw Order: "+uiObject.drawOrder);listObject.tileWidth.setText("Width: "+CC.FloatLimitPrecision(this.editor.getReletiveWidth(uiObject)*100)+"%");listObject.tileHeight.setText("Height: "+CC.FloatLimitPrecision(this.editor.getReletiveHeight(uiObject)*100)+"%");listObject.tileX.setText("X: "+CC.FloatLimitPrecision(this.editor.getReletiveX(uiObject)*100)+"%");listObject.tileY.setText("Y: "+CC.FloatLimitPrecision(this.editor.getReletiveY(uiObject)*100)+"%");var currentText=uiObject.getText();listObject.tileText.setText("Text: "+currentText);var textColour=currentText?uiObject.textObject.colour.toString():"0,0,0,1";if(uiObject.isTextBlinking()){var textColourSplit=textColour.split(",");textColour=textColourSplit[0]+","+textColourSplit[1]+","+textColourSplit[2]+",1"}listObject.tileTextColour.setText("Text Colour: "+textColour);if(currentText){listObject.tileTextColour.setColour(gColour.setRGBA(uiObject.textObject.colour.r*.5,uiObject.textObject.colour.g*.5,uiObject.textObject.colour.b*.5,1))}listObject.tileTextBlinking.setText("Text Blinking: "+(uiObject.isTextBlinking()?"true":"false"));listObject.tileTextScale.setText("Text Scale: "+CC.FloatLimitPrecision(uiObject.textScale?uiObject.textScale:.75));if(uiObject.get3DModelFilename()){listObject.tile3DModel.set3DModel(uiObject.get3DModelFilename(),uiObject.get3DModelTextureFilename(),1);listObject.tile3DModel.setTileSize(listObject.tile3DModel.collisionSize.width);listObject.tile3DModel.setTextColourAlpha(0,true);listObject.tile3DModelColour.setText("Model Colour: "+(uiObject.model3dObject.colour?uiObject.model3dObject.colour.toString():"1,1,1,1"));listObject.tile3DModelColour.setColour(gColour.setRGBA(uiObject.model3dObject.colour.r*.5,uiObject.model3dObject.colour.g*.5,uiObject.model3dObject.colour.b*.5,1));listObject.tile3DModelRotation.setText("Rotation: "+vec3.toString(uiObject.model3dObject.rotation));listObject.tile3DModelAnimationSpeed.setText("Animation Speed: "+(uiObject.model3dAnimationSpeed!==undefined?uiObject.model3dAnimationSpeed:0))}else{listObject.tile3DModel.setText("Select 3D Model...");listObject.tile3DModel.setTextColourAlpha(1,true);listObject.tile3DModelColour.setText("");listObject.tile3DModelColour.setColour(gColour.setRGBA(1,1,1,1));listObject.tile3DModelRotation.setText("");listObject.tile3DModelAnimationSpeed.setText("")}if(uiObject.onPress.length>0){var onPress=uiObject.onPress[0];if(onPress.length>16){onPress="..."+onPress.substring(onPress.length-17)}listObject.tileOnPress.setText("On Press: "+onPress)}else{listObject.tileOnPress.setText("On Press...")}if(uiObject.onRelease.length>0){var onRelease=uiObject.onRelease[0];if(onRelease.length>16){onRelease="..."+onRelease.substring(onRelease.length-17)}listObject.tileOnRelease.setText("On Release: "+onRelease)}else{listObject.tileOnRelease.setText("On Release...")}if(uiObject.onLoss.length>0){var onLoss=uiObject.onLoss[0];if(onLoss.length>16){onLoss="..."+onLoss.substring(onLoss.length-17)}listObject.tileOnLoss.setText("On Loss: "+onLoss)}else{listObject.tileOnLoss.setText("On Loss...")}};function DBObjects(tag,scene,createHeadingTile){var camera=scene.camera;var tileWidth=camera.targetWidth/scene.maxColumns;if(tileWidth>100){tileWidth=100}var tileHeight=tileWidth*.5;this.tag=tag;this.db=[];this.objects=[];this.currentPage=0;this.tiles=[];var tile;this.open=true;var self=this;if(createHeadingTile){this.open=false;tile=new CCTile3DButton(scene);tile.visibleOnlyUpdate=true;tile.setupText(tag,tileHeight*.5,true,true);tile.setTileSize(camera.targetWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColour(EditorManager.LightBlue);tile.setColourAlpha(0,false);tile.setTextColour(gColour.setRGBA(1,1,1,0));tile.setColourAlpha(.9,true);tile.setTextColourAlpha(1,true);tile.setDrawOrder(205);tile.onRelease.push(function(){self.open=!self.open;scene.show()});scene.addTile(tile);this.tileHeading=tile;this.tiles.push(tile)}{tile=new CCTile3DButton(scene);tile.visibleOnlyUpdate=true;tile.setupText("<",tileHeight*.5,true,true);tile.setTileSize(camera.targetWidth*.5,tileHeight*.75);tile.setTileTexture("editor_tile_background.jpg");tile.setColour(EditorManager.LightGrey);tile.setColourAlpha(0,false);tile.setTextColour(gColour.set(0,0));tile.setDrawOrder(205);tile.onRelease.push(function(){self.currentPage--;scene.show()});scene.addTile(tile);this.tilePrevious=tile;this.tiles.push(tile)}{tile=new CCTile3DButton(scene);tile.visibleOnlyUpdate=true;tile.setupText(">",tileHeight*.5,true,true);tile.setTileSize(camera.targetWidth*.5,tileHeight*.75);tile.setTileTexture("editor_tile_background.jpg");tile.setColour(EditorManager.LightGrey);tile.setColourAlpha(0,false);tile.setTextColour(gColour.set(0,0));tile.setDrawOrder(205);tile.onRelease.push(function(){self.currentPage++;scene.show()});scene.addTile(tile);this.tileNext=tile;this.tiles.push(tile)}}function SceneUIListDB(parentScene){this.construct(parentScene)}ExtendPrototype(SceneUIListDB,SceneUIList);SceneUIListDB.prototype.construct=function(parentScene){if(!this.maxColumns){this.maxColumns=1}if(!this.maxRowsPerPage){this.maxRowsPerPage=4}this.SceneUIList_construct();{this.setParent(parentScene)}gEngine.addScene(this)};SceneUIListDB.prototype.setup=function(showUnsorted){var camera;if(this.camera){camera=this.camera}else{camera=gEngine.newSceneCamera(this);camera.setupViewport(0,0,.125,1);camera.setCameraWidth(640*.125,false)}var tile;{tile=new CCTile3DButton(this);tile.setupTile();tile.setTileTexture("editor_tile_background.jpg");tile.setColour(gColour.set(.5,0));tile.setColourAlpha(.95,true);tile.setDrawOrder(200);
this.cameraStickyTiles.add(tile);this.tileBackground=tile}this.selectionIndex=-1;var self=this;var tileWidth=camera.targetWidth/this.maxColumns;if(tileWidth>100){tileWidth=100}var tileHeight=tileWidth*.5;if(this.onNew){tile=new CCTile3DButton(this);tile.visibleOnlyUpdate=true;tile.setupText("+",tileHeight,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.setRGBA(.25,.75,.25,0));tile.setTextColour(gColour.setRGBA(1,1,1,0));tile.setColourAlpha(.9,true);tile.setTextColourAlpha(1,true);tile.setDrawOrder(205);tile.onRelease.push(function(){self.onNew()});this.addTile(tile);this.tileNew=tile}this.objectsLists=[];if(showUnsorted===undefined){showUnsorted=true}this.objectsLists.push(new DBObjects("Unsorted",this,!showUnsorted));if(showUnsorted){this.objectsLists[0].open=true}this.requestResize();this.show();this.loadList()};SceneUIListDB.prototype.updateScene=function(delta){var updated=this.SceneUIList_updateScene(delta);var selectedID=this.getSelectedID();if(selectedID!==-1){var objectsLists=this.objectsLists;for(var listIndex=0;listIndex<objectsLists.length;++listIndex){var objectsList=objectsLists[listIndex];var objects=objectsList.objects;for(i=0;i<objects.length;++i){var object=objects[i];var objectID=DBAssets.GetID(object.info);if(objectID===selectedID){if(object.modelObject){object.modelObject.model.animate(delta)}}}}}return updated};SceneUIListDB.prototype.resize=function(){this.SceneUIList_resize();var camera=this.camera;var tile;{tile=this.tileBackground;tile.setTileSize(camera.targetWidth,camera.targetHeight)}this.resizeLists(camera.cameraHHeight)};SceneUIListDB.prototype.resizeLists=function(y){var camera=this.camera;var tile;if(this.tileNew){tile=this.tileNew;y-=tile.collisionBounds[1];tile.setPositionXY(-camera.targetWidth*.5+tile.collisionBounds[0],y);y-=tile.collisionBounds[1];y-=camera.cameraHHeight*.05}var objectsLists=this.objectsLists;for(var listIndex=0;listIndex<objectsLists.length;++listIndex){var objectsList=objectsLists[listIndex];tile=objectsList.tileHeading;if(tile){if(objectsList.db.length>0){tile.setColourAlpha(1,false);tile.setTextColourAlpha(1,false);y-=tile.collisionBounds[1];tile.setPositionY(y);y-=tile.collisionBounds[1]}else{tile.setColourAlpha(0,false);tile.setTextColourAlpha(0,false)}}y=this.resizeList(objectsList.objects,y);tile=objectsList.tilePrevious;if(objectsList.open){y-=tile.collisionBounds[1];tile.setPositionXY(-tile.collisionBounds[0],y)}var currentPage=objectsList.currentPage;if(objectsList.open&&currentPage>0){tile.setColourAlpha(1,false);tile.setTextColourAlpha(1,false);tile.setCollideable(true)}else{tile.setColourAlpha(0,false);tile.setTextColourAlpha(0,false);tile.setCollideable(false)}tile=objectsList.tileNext;if(objectsList.open){tile.setPositionXY(tile.collisionBounds[0],y);y-=tile.collisionBounds[1]}var maxItems=this.maxColumns*this.maxRowsPerPage;var startIndex=currentPage*maxItems;var endIndex=startIndex+maxItems;if(objectsList.open&&endIndex<objectsList.db.length){tile.setColourAlpha(1,false);tile.setTextColourAlpha(1,false);tile.setCollideable(true)}else{tile.setColourAlpha(0,false);tile.setTextColourAlpha(0,false);tile.setCollideable(false)}if(objectsList.open){y-=camera.cameraHHeight*.05}}};SceneUIListDB.prototype.resizeList=function(list,currentY){var camera=this.camera;var maxColumns=this.maxColumns;var xIncrement=camera.targetWidth/maxColumns;var xStart=-camera.targetWidth*.5+xIncrement*.5;var i,j,object,tiles,tile;var columnIndex=0;var x=xStart;var y=currentY;var bottomY=y;for(i=0;i<list.length;++i){currentY=y;object=list[i];tiles=object.tiles;for(j=0;j<tiles.length;++j){tile=tiles[j];currentY-=tile.collisionBounds[1];tile.setPositionXYZ(x,currentY,0);if(!tile.positioned){tile.positioned=true;tile.setPositionX(-camera.targetWidth*.5-tile.collisionBounds[0])}currentY-=tile.collisionBounds[1]}if(currentY<bottomY){bottomY=currentY}x+=xIncrement;if(columnIndex===maxColumns-1){columnIndex=0;x=xStart;y=bottomY}else{columnIndex++}}return bottomY};SceneUIListDB.prototype.positionObjectsList=function(list){var camera=this.camera;var cameraTop=camera.targetLookAt[1]-camera.targetHeight*.5;var cameraBottom=camera.targetLookAt[1]+camera.targetHeight*.5;var maxColumns=this.maxColumns;var xIncrement=camera.targetWidth/maxColumns;var xStart=-camera.targetWidth*.5+xIncrement*.5;var x=xStart;var columnIndex=0;for(var i=0;i<list.length;++i){var tiles=list[i].tiles;for(var j=0;j<tiles.length;++j){var tile=tiles[j];var visible=false;if(tile.aabbMax[1]>cameraTop){if(tile.aabbMin[1]<cameraBottom){visible=true}}{tile.setPositionX(x)}tile.setCollideable(true)}x+=xIncrement;if(columnIndex===maxColumns-1){columnIndex=0;x=xStart}else{columnIndex++}}};SceneUIListDB.prototype.sort=function(){var db=this.list;if(db){db.sort(function(a,b){var scoreA=MultiplayerManager.IsOwner(a.owners)?100:0;var scoreB=MultiplayerManager.IsOwner(b.owners)?100:0;if(scoreA===scoreB){return b.timestamp-a.timestamp}return scoreB-scoreA});var objectsLists=this.objectsLists;var listIndex,objectsList;for(listIndex=0;listIndex<objectsLists.length;++listIndex){objectsList=objectsLists[listIndex];objectsList.db.length=0}var info;var unsortedObjectsList=objectsLists[0];for(listIndex=1;listIndex<objectsLists.length;++listIndex){objectsList=objectsLists[listIndex];if(objectsList.tag==="Unsorted"){unsortedObjectsList=objectsList;break}}for(i=0;i<db.length;++i){info=db[i];if(!info.tags||info.tags.length===0){unsortedObjectsList.db.push(info);continue}var tag=info.tags[0];var found=false;for(listIndex=0;listIndex<objectsLists.length;++listIndex){objectsList=objectsLists[listIndex];if(objectsList.tag===tag){objectsList.db.push(info);found=true;break}}if(!found){objectsList=new DBObjects(tag,this,true);objectsList.db.push(info);this.objectsLists.push(objectsList)}}objectsLists.sort(function(a,b){var scoreA=a.tag==="Unsorted"?0:100;var scoreB=b.tag==="Unsorted"?0:100;if(scoreA===scoreB){return a.tag.localeCompare(b.tag)}return scoreB-scoreA})}};SceneUIListDB.prototype.show=function(){if(this.closing){return}var db=this.list;if(db){this.sort();var objectsLists=this.objectsLists;var listIndex,objectsList;var i,tile,tiles,j;var object;for(listIndex=0;listIndex<objectsLists.length;++listIndex){objectsList=objectsLists[listIndex];db=objectsList.db;var objects=objectsList.objects;var maxItems=this.maxColumns*this.maxRowsPerPage;if(objectsList.currentPage<0){objectsList.currentPage=0}if(objectsList.currentPage*maxItems>db.length){objectsList.currentPage=parseInt(db.length/maxItems,10)}var currentPage=objectsList.currentPage;var startIndex=currentPage*maxItems;var endIndex=startIndex+maxItems;var objectIndex=0;if(objectsList.open){for(i=startIndex;i<endIndex&&i<db.length;++i,++objectIndex){info=db[i];if(objects.length>i){object=objects[objectIndex];var newInfoString=JSON.stringify(info);var currentInfoString=JSON.stringify(object.info);if(newInfoString===currentInfoString){continue}objectsList.objects.remove(object);for(j=0;j<object.tiles.length;++j){tile=object.tiles[j];this.tiles.remove(tile);tile.deleteLater()}}object=this.createObject(info);objects.insert(object,objectIndex)}}while(objects.length>objectIndex){object=objects[objectIndex];objects.remove(object);for(j=0;j<object.tiles.length;++j){tile=object.tiles[j];this.tiles.remove(tile);tile.deleteLater()}}}}this.refreshedObjectsList()};SceneUIListDB.prototype.refreshedObjectsList=function(){var camera=this.camera;var tiles,i,tile,j;this.requestResize();var objectsLists=this.objectsLists;for(var listIndex=0;listIndex<objectsLists.length;++listIndex){var objectsList=objectsLists[listIndex];this.positionObjectsList(objectsList.objects);var duration=1;for(i=0;i<objectsList.objects.length;++i){tiles=objectsList.objects[i].tiles;for(j=0;j<tiles.length;++j){tile=tiles[j];tile.movementInterpolator.setDuration(duration)}}}this.highlightSelectedObject()};SceneUIListDB.prototype.close=function(){this.closing=true;var self=this;var camera=this.camera;var tile;{tile=this.tileBackground;tile.setColourAlpha(0,true,function(){self.deleteLater()})}if(this.tileNew){tile=this.tileNew;tile.setTileMovementX(-camera.targetWidth*.5-tile.collisionSize.width);tile.setColour(gColour.setRGBA(1,1,1,0),true);tile.setCollideable(false)}var objectsLists=this.objectsLists;for(var listIndex=0;listIndex<objectsLists.length;++listIndex){var objectsList=objectsLists[listIndex];var tiles=objectsList.tiles;for(var i=0;i<tiles.length;++i){tile=tiles[i];tile.setTileMovementX(-camera.targetWidth*.5-tile.collisionSize.width);tile.setColour(gColour.setRGBA(1,1,1,0),true);tile.setCollideable(false)}var objects=objectsList.objects;for(i=0;i<objects.length;++i){object=objects[i];tiles=object.tiles;for(var j=0;j<tiles.length;++j){tile=tiles[j];tile.setPositionX(-camera.targetWidth);tile.setColour(gColour.setRGBA(1,1,1,0),tile.visible);tile.setCollideable(false)}}}};SceneUIListDB.prototype.highlightSelectedObject=function(lookAt){var camera=this.camera;var cameraTop=camera.targetLookAt[1]-camera.targetHeight*.5;var cameraBottom=camera.targetLookAt[1]+camera.targetHeight*.5;var selectedID=this.getSelectedID();var objectsLists=this.objectsLists;for(var listIndex=0;listIndex<objectsLists.length;++listIndex){var objectsList=objectsLists[listIndex];var objects=objectsList.objects;for(i=0;i<objects.length;++i){var object=objects[i];var objectID=DBAssets.GetID(object.info);var tiles=object.tiles;for(var j=0;j<tiles.length;++j){var tile=tiles[j];var visible=false;if(tile.aabbMax[1]>cameraTop){if(tile.aabbMin[1]<cameraBottom){visible=true}}if(objectID===selectedID){if(j===tiles.length-1){if(lookAt){camera.targetLookAt[1]=tile.position[1];this.refreshCameraView();this.lockCameraView()}}if(j===0){tile.setColour(gColour.setRGBA(.4,.5,.75,0),false)}tile.setColourAlpha(1,false)}else{if(j===0){tile.setColour(gColour.set(.25,0),false)}tile.setColourAlpha(.75,false)}}}}};SceneUIListDB.prototype.getInfoIndex=function(info){if(this.list){var id=DBAssets.GetID(info);var list=this.list;for(var i=0;i<list.length;++i){var itrID=DBAssets.GetID(list[i]);if(itrID===id){return i}}}return-1};SceneUIListDB.prototype.getInfo=function(index){if(this.list&&index>=0&&index<this.list.length){return this.list[index]}return null};SceneUIListDB.prototype.getSelected=function(){return this.getInfo(this.selectionIndex)};SceneUIListDB.prototype.getSelectedID=function(){var selectedInfo=this.getSelected();if(selectedInfo){return DBAssets.GetID(selectedInfo)}return-1};SceneUIListDB.prototype.unselect=function(){this.selectionIndex=-1;this.highlightSelectedObject()};SceneUIListDB.prototype.loadList=function(){var self=this;CCFileManager.Load(this.constructor.name+".db",function(data){if(data){if(!self.list){var list=JSON.parse(data);if(!self.loaded){self.list=list;self.show()}if(this.onUpdate){this.onUpdate(list)}}}})};SceneUIListDB.prototype.saveList=function(){CCFileManager.Save(this.constructor.name+".db",this.list)};SceneUIListDB.prototype.syncList=function(list){this.list=list;this.show();this.saveList();if(!this.loaded){this.loaded=true;if(this.onLoaded){this.onLoaded()}}if(this.onUpdate){this.onUpdate(list)}};SceneUIListDB.prototype.syncEdit=function(info){var camera=this.camera;var i,itr,itrID;var id=DBAssets.GetID(info);if(this.list){var found=false;for(i=0;i<this.list.length;++i){itr=this.list[i];itrID=DBAssets.GetID(itr);if(itrID===id){this.list[i]=info;found=true;break}}if(!found){this.list.push(info)}this.saveList()}var object;var objectsLists=this.objectsLists;for(var listIndex=0;listIndex<objectsLists.length;++listIndex){var objectsList=objectsLists[listIndex];var objects=objectsList.objects;for(i=0;i<objects.length;++i){object=objects[i];var objectID=DBAssets.GetID(object.info);if(objectID===id){if(this.updateObject){this.updateObject(object,info)}}}}if(!object){this.show()}};SceneUIListDB.prototype.syncDelete=function(id){var self=this;var i,itr,itrID;var selectedID=this.getSelectedID();if(selectedID===id){this.unselect()}if(this.list){for(i=0;i<this.list.length;++i){itr=this.list[i];itrID=DBAssets.GetID(itr);if(itrID===id){this.list.remove(itr);this.saveList();break}}}var objectsLists=this.objectsLists;for(var listIndex=0;listIndex<objectsLists.length;++listIndex){var objectsList=objectsLists[listIndex];var objects=objectsList.objects;for(i=0;i<objects.length;++i){object=objects[i];var objectID=DBAssets.GetID(object.info);if(objectID===id){objects.remove(object);for(j=0;j<object.tiles.length;++j){tile=object.tiles[j];this.tiles.remove(tile);tile.deleteLater()}}}}this.show()};SceneUIListDB.prototype.selectIndex=function(selectionIndex,callback,findInfo){var selectedInfo=this.getInfo(selectionIndex);var selectedID=selectedInfo?DBAssets.GetID(selectedInfo):-1;this.sort();var objectsLists=this.objectsLists;for(var listIndex=0;listIndex<objectsLists.length;++listIndex){var objectsList=objectsLists[listIndex];var db=objectsList.db;var maxItems=this.maxColumns*this.maxRowsPerPage;for(var i=0;i<db.length;++i){var info=db[i];var id=DBAssets.GetID(info);if(id===selectedID){if(!objectsList.open){objectsList.open=true}var currentPage=parseInt(i/maxItems,10);if(objectsList.currentPage!==currentPage){objectsList.currentPage=currentPage;break}}}}this.show();if(this.selectionIndex!==selectionIndex){this.selectionIndex=selectionIndex}this.highlightSelectedObject(true);if(this.onSelected){this.onSelected(selectedInfo)}if(callback){callback(selectedInfo)}};SceneUIListDB.prototype.findAndSelectID=function(id,callback,findInfo){var list=this.list;if(list){for(var i=0;i<list.length;++i){var itr=list[i];var itrID=DBAssets.GetID(itr);if(itrID===id){this.selectIndex(i,callback,findInfo);return}}this.selectionIndex=-1;this.highlightSelectedObject()}if(!this.loaded){var self=this;this.onLoaded=function(){self.findAndSelectID(id,callback,findInfo)}}else{if(callback){callback(false)}}};function SceneUIListDBAudio(parentScene,onNew){MultiplayerManager.UpdateCallbacks.addOnce(this);this.maxColumns=4;this.onNew=onNew;var self=this;this.onDragDropFunction=function(files,event){self.onDragDrop(files,event)};gEngine.controls.onDragDrop.add(this.onDragDropFunction);this.construct(parentScene)}ExtendPrototype(SceneUIListDBAudio,SceneUIListDB);SceneUIListDBAudio.prototype.deleteLater=function(){if(this.onDragDropFunction){gEngine.controls.onDragDrop.remove(this.onDragDropFunction);this.onDragDropFunction=null}if(this.syncingUpdates){MultiplayerManager.Emit("EditorAudioUnregisterListUpdates");this.syncingUpdates=false}this.SceneUIListDB_deleteLater()};SceneUIListDBAudio.prototype.setup=function(){var parentCameraIndex=gEngine.findCameraIndex(this.parentScene.camera);var camera=gEngine.newSceneCamera(this,parentCameraIndex+1);camera.setupViewport(0,0,1,1);camera.setCameraWidth(640*1,false);this.SceneUIListDB_setup();if(MultiplayerManager.Emit("EditorAudioRequestList")){this.syncingUpdates=true}this.requestResize()};SceneUIListDBAudio.prototype.syncUpdate=function(jsonData){if(jsonData.EditorAudio){this.syncList(jsonData.EditorAudio)}else if(jsonData.EditorAudioDeleted!==undefined){var id=jsonData.EditorAudioDeleted;this.syncDelete(id)}else if(jsonData.EditorAudioUpdated){var info=jsonData.EditorAudioUpdated;this.syncEdit(info);if(!this.loaded){this.loaded=true;if(this.onLoaded){this.onLoaded()}}}};SceneUIListDBAudio.prototype.createObject=function(info){var self=this;var objectsList=this.objectsList;var SelectObjectFunction=function(info){return function(){var infoIndex=self.getInfoIndex(info);if(self.selectionIndex!==infoIndex){self.selectionIndex=infoIndex;self.highlightSelectedObject()}if(self.onSelected){self.onSelected(info)}}};var EditFunction=function(object){return function(){self.onEdit(object.info)}};var camera=this.camera;var tileWidth=camera.targetWidth/this.maxColumns;var tileHeight=tileWidth*.2;var object={};object.tiles=[];object.info=info;var tile;{tile=new CCTile3DButton(this);tile.setupText(""+info.id,tileHeight,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.set(.25,.9));tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(205);tile.onRelease.push(new SelectObjectFunction(info));this.addTile(tile);object.tiles.add(tile)}{tile=new CCTile3DButton(this);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.set(1,.9));tile.setDrawOrder(205);tile.onRelease.push(new SelectObjectFunction(info));this.addTile(tile);object.tiles.add(tile);object.tileMP3=tile}this.updateObject(object,info);if(this.onEdit){tile=new CCTile3DButton(this);tile.setupText("edit",tileHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.setRGBA(.25,.5,.75,.9));tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(205);tile.onRelease.push(new EditFunction(object));this.addTile(tile);object.tiles.add(tile)}return object};SceneUIListDBAudio.prototype.updateObject=function(object,info){var tile=object.tileMP3;var camera=this.camera;var tileWidth=camera.targetWidth/this.maxColumns;var tileHeight=tileWidth*.175;var friendlyName=String.SplitBefore(info.mp3,"_");friendlyName+=".mp3";tile.setupText(friendlyName,tileHeight*.4,true,true);tile.setTileSize(tileWidth,tileHeight)};SceneUIListDBAudio.prototype.onDragDrop=function(files,event){if(event&&event.target){if(MultiplayerManager.LoggedIn){if(!this.sceneEditor){this.sceneEditor=new SceneAudioEditor(this);this.sceneEditor.open("Upload Audio")}}}};function SceneUIListDBCharacters(parentScene,onNew,onUpdate){MultiplayerManager.UpdateCallbacks.addOnce(this);this.maxColumns=5;this.maxRowsPerPage=1;this.onNew=onNew;this.onUpdate=onUpdate;this.construct(parentScene)}ExtendPrototype(SceneUIListDBCharacters,SceneUIListDB);SceneUIListDBCharacters.prototype.deleteLater=function(){if(this.syncingUpdates){MultiplayerManager.Emit("EditorCharactersUnregisterListUpdates");this.syncingUpdates=false}this.SceneUIListDB_deleteLater()};SceneUIListDBCharacters.prototype.setup=function(){var parentCameraIndex=gEngine.findCameraIndex(this.parentScene.camera);var camera=gEngine.newSceneCamera(this,parentCameraIndex+1);camera.setupViewport(0,0,1,1);camera.setCameraWidth(640*1,false);this.SceneUIListDB_setup();if(MultiplayerManager.Emit("EditorCharactersRequestList")){this.syncingUpdates=true}this.requestResize()};SceneUIListDBCharacters.prototype.syncUpdate=function(jsonData){if(jsonData.EditorCharacters){this.syncList(jsonData.EditorCharacters);DBAssets.LoadCharacters(jsonData.EditorCharacters)}else if(jsonData.EditorCharacterDeleted){var objectID=jsonData.EditorCharacterDeleted;this.syncDelete(objectID)}};SceneUIListDBCharacters.prototype.createObject=function(info){var self=this;var objectsList=this.objectsList;var SelectObjectFunction=function(info){return function(){var infoIndex=self.getInfoIndex(info);if(self.selectionIndex!==infoIndex){self.selectionIndex=infoIndex;self.highlightSelectedObject()}if(self.onSelected){self.onSelected(info)}}};var EditFunction=function(object){return function(){self.onEdit(object.info)}};var camera=this.camera;var tileWidth=camera.targetWidth/this.maxColumns;var tileHeight=tileWidth*.2;var object={};object.tiles=[];object.info=info;var tile;{tile=new CCTile3DButton(this);tile.setupText(""+info.objectID,tileHeight,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.set(.25,.9));tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(205);tile.onRelease.push(new SelectObjectFunction(info));this.addTile(tile);object.tiles.add(tile)}{tile=new CCTile3DButton(this);tile.setupTile(tileWidth,tileWidth);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setDrawOrder(205);tile.onRelease.push(new SelectObjectFunction(info));this.addTile(tile);object.tileModel=tile;object.tiles.add(tile);this.updateObject(object,info)}if(this.onEdit){tile=new CCTile3DButton(this);tile.setupText("edit",tileHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.setRGBA(.25,.5,.75,.9));tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(205);tile.onRelease.push(new EditFunction(object));this.addTile(tile);object.tiles.add(tile)}return object};SceneUIListDBCharacters.prototype.updateObject=function(object,info){var tile=object.tileModel;if(tile.character){tile.removeChild(tile.character);tile.character.deleteLater()}tile.setText("loading...",false,tile.collisionSize.height*.1);var LoadedCharacterFunction=function(tile){return function(character){tile.removeText()}};var size=tile.collisionSize.width*.75;var character=tile.character=CharacterPlayerPrefab.Spawn(info.objectID,new LoadedCharacterFunction(tile));character.setSize(size);character.forceTransparent=true;character.animationPaused=true;tile.addChild(character)};function SceneUIListDBImages(parentScene,maxColumns,cameraWidth,onNew){MultiplayerManager.UpdateCallbacks.addOnce(this);if(!maxColumns){maxColumns=2}this.maxRowsPerPage=5;if(!cameraWidth){cameraWidth=.2}this.maxColumns=maxColumns;this.cameraWidth=cameraWidth;this.onNew=onNew;this.construct(parentScene)}ExtendPrototype(SceneUIListDBImages,SceneUIListDB);SceneUIListDBImages.prototype.deleteLater=function(){if(this.syncingUpdates){MultiplayerManager.Emit("EditorImagesUnregisterListUpdates");this.syncingUpdates=false}this.SceneUIListDB_deleteLater()};SceneUIListDBImages.prototype.setup=function(){var camera=gEngine.newSceneCamera(this);camera.setupViewport(0,0,this.cameraWidth,1);camera.setCameraWidth(640*this.cameraWidth,false);this.SceneUIListDB_setup();if(MultiplayerManager.Emit("EditorImagesRequestList")){this.syncingUpdates=true}};SceneUIListDBImages.prototype.syncUpdate=function(jsonData){if(jsonData.EditorImages){this.syncList(jsonData.EditorImages)}else if(jsonData.EditorImageDeleted){var objectID=jsonData.EditorImageDeleted;this.syncDelete(objectID)}else if(jsonData.EditorImageUpdated){var imageInfo=jsonData.EditorImageUpdated;this.syncEdit(imageInfo)}};SceneUIListDBImages.prototype.render=function(camera,pass,alpha){this.SceneUIListDB_render(camera,pass,alpha)};SceneUIListDBImages.prototype.createObject=function(imageInfo){var self=this;var objectsList=this.objectsList;var SelectObjectFunction=function(info){return function(){var infoIndex=self.getInfoIndex(info);if(self.selectionIndex!==infoIndex){self.selectionIndex=infoIndex;self.highlightSelectedObject()}if(self.onSelected){self.onSelected(info)}}};var camera=this.camera;var tileWidth=camera.targetWidth/this.maxColumns;var tileHeight=tileWidth*.125;var object={};object.tiles=[];object.info=imageInfo;var tile;{tile=new CCTile3DButton(this);tile.visibleOnlyUpdate=true;tile.setupText(""+imageInfo.objectID,tileHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.set(.25,.9));tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(205);tile.onRelease.push(new SelectObjectFunction(imageInfo));this.addTile(tile);object.tiles.add(tile)}if(imageInfo.tex){tile=new CCTile3DButton(this);tile.visibleOnlyUpdate=true;tile.setupTexturedFit(tileWidth,tileWidth,false,imageInfo.tex);tile.setColourAlpha(0,false);tile.setDrawOrder(205);tile.onRelease.push(new SelectObjectFunction(imageInfo));this.addTile(tile);object.tiles.add(tile)}return object};SceneUIListDBImages.prototype.findAndSelect=function(tex,callback){var list=this.list;if(list){for(var i=0;i<list.length;++i){var itr=list[i];if(itr.tex===tex){this.selectIndex(i,callback);return}}this.selectionIndex=-1;this.highlightSelectedObject()}if(!this.loaded){var self=this;this.onLoaded=function(){self.findAndSelect(tex,callback)}}else{if(callback){callback(false)}}};function SceneUIListDBModels(parentScene,onNew){MultiplayerManager.UpdateCallbacks.addOnce(this);this.maxColumns=3;this.onNew=onNew;this.construct(parentScene)}ExtendPrototype(SceneUIListDBModels,SceneUIListDB);SceneUIListDBModels.prototype.deleteLater=function(){if(this.syncingUpdates){MultiplayerManager.Emit("EditorModelsUnregisterListUpdates");this.syncingUpdates=false}this.SceneUIListDB_deleteLater()};SceneUIListDBModels.prototype.setup=function(){var camera=gEngine.newSceneCamera(this);camera.setupViewport(0,0,.3,1);camera.setCameraWidth(640*.3,false);this.SceneUIListDB_setup(false);if(MultiplayerManager.Emit("EditorModelsRequestList")){this.syncingUpdates=true}};SceneUIListDBModels.prototype.updateScene=function(delta){var updated=this.SceneUIListDB_updateScene(delta);return updated};SceneUIListDBModels.prototype.syncUpdate=function(jsonData){if(jsonData.EditorModels){this.syncList(jsonData.EditorModels)}else if(jsonData.EditorModelDeleted){var objectID=jsonData.EditorModelDeleted;this.syncDelete(objectID)}else if(jsonData.EditorModelUpdated){var modelInfo=jsonData.EditorModelUpdated;this.syncEdit(modelInfo);if(!this.loaded){this.loaded=true;if(this.onLoaded){this.onLoaded()}}}};SceneUIListDBModels.prototype.close=function(){var objectsLists=this.objectsLists;for(var listIndex=0;listIndex<objectsLists.length;++listIndex){var objectsList=objectsLists[listIndex];var objects=objectsList.objects;for(i=0;i<objects.length;++i){var object=objects[i];if(object.tileModel){object.tileModel.removeText()}if(object.modelObject){object.modelObject.shouldRender=false}}}this.SceneUIListDB_close()};SceneUIListDBModels.prototype.createObject=function(modelInfo){var self=this;var objectsList=this.objectsList;var SelectObjectFunction=function(info){return function(){var infoIndex=self.getInfoIndex(info);if(self.selectionIndex!==infoIndex){self.selectionIndex=infoIndex;self.highlightSelectedObject()}if(self.onSelected){self.onSelected(info)}}};var EditModelFunction=function(object){return function(){self.onEdit(object.info)}};var camera=this.camera;var tileWidth=camera.targetWidth/this.maxColumns;var tileHeight=tileWidth*.2;var object={};object.tiles=[];object.info=modelInfo;var tile;{tile=new CCTile3DButton(this);tile.visibleOnlyUpdate=true;tile.setupText(""+modelInfo.objectID,tileHeight,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.set(.25,.9));tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(205);tile.onRelease.push(new SelectObjectFunction(modelInfo));this.addTile(tile);object.tiles.add(tile)}if(modelInfo.obj){tile=new CCTile3DButton(this);tile.visibleOnlyUpdate=true;tile.setupTile(tileWidth,tileWidth);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setDrawOrder(205);tile.onRelease.push(new SelectObjectFunction(modelInfo));this.addTile(tile);object.tileModel=tile;object.tiles.add(tile);this.updateObject(object,modelInfo)}if(this.onEdit){tile=new CCTile3DButton(this);tile.visibleOnlyUpdate=true;tile.setupText("Edit",tileHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColour(EditorManager.LightBlue);tile.setColourAlpha(0,false);tile.setColourAlpha(.9,true);tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(205);tile.onRelease.push(new EditModelFunction(object));this.addTile(tile);object.tiles.add(tile)}return object};SceneUIListDBModels.prototype.updateObject=function(object,modelInfo){var self=this;object.info=modelInfo;var LoadedModelFunction=function(object,tile,tex){return function(model3d){if(model3d){tile.removeText();var modelObject=object.modelObject;if(!object.modelObject){modelObject=new CCObject;tile.addChild(modelObject);modelObject.setTransparent();object.modelObject=modelObject}modelObject.setModel(model3d);{var size=tile.collisionSize.width*.75;var scaleFactor;var modelWidth=model3d.getWidth()>model3d.getDepth()?model3d.getWidth():model3d.getDepth();var modelHeight=model3d.getHeight();if(modelWidth>modelHeight){scaleFactor=size/modelWidth}else{scaleFactor=size/modelHeight}model3d.setScale(scaleFactor)}if(tex){model3d.setTexture(tex)}}}};if(modelInfo.obj){var tile=object.tileModel;tile.setText("loading...",false,tile.collisionSize.height*.1);CCModel3D.CacheModel(modelInfo.obj,true,new LoadedModelFunction(object,tile,modelInfo.tex))}};SceneUIListDBModels.prototype.selectIndex=function(i,callback,findInfo){var selectedInfo=this.getInfo(i);if(selectedInfo&&(!findInfo||selectedInfo.obj===findInfo.obj)){this.SceneUIListDB_selectIndex(i,callback,findInfo)}};SceneUIListDBModels.prototype.findAndSelect=function(findInfo,callback){if(findInfo.objectID){this.findAndSelectID(findInfo.objectID,callback,findInfo);return}var list=this.list;if(list){for(var i=0;i<list.length;++i){var itr=list[i];if(itr.obj===findInfo.obj){if(itr.tex===findInfo.tex){if(itr.noCulling===findInfo.noCulling){this.selectIndex(i,callback,findInfo);return}}}}this.selectionIndex=-1;this.highlightSelectedObject()}if(!this.loaded){var self=this;this.onLoaded=function(){self.findAndSelect(findInfo,callback)}}else{if(callback){callback(false)}}};function SceneEditorUI(){this.construct();var camera=gEngine.newSceneCamera(this);camera.setupViewport(0,0,1,1)}ExtendPrototype(SceneEditorUI,CCSceneAppUI);SceneEditorUI.prototype.deleteLater=function(){this.hideMenu();this.CCSceneAppUI_deleteLater()};SceneEditorUI.prototype.setup=function(){this.camera.setCameraWidth(640,false);var tile;var bottomMenuTiles=this.bottomMenuTiles=[];var sideMenuTiles=this.sideMenuTiles=[];if(this.setupUI){this.setupUI()}this.enableObjectResizing=true;this.createResizers();var i;for(i=0;i<bottomMenuTiles.length;++i){tile=bottomMenuTiles[i];tile.setCollideable(false)}var duration=1;for(i=0;i<sideMenuTiles.length;++i){tile=sideMenuTiles[i];tile.setCollideable(false);tile.movementInterpolator.setDuration(duration);duration+=.1}this.requestResize()};SceneEditorUI.prototype.updateScene=function(delta){this.CCSceneAppUI_updateScene(delta)};SceneEditorUI.prototype.render=function(camera,pass,alpha){this.CCSceneAppUI_render(camera,pass,alpha)};SceneEditorUI.prototype.resize=function(){this.CCSceneAppUI_resize();var camera=this.camera;var tile,i;var bottomMenuTiles=this.bottomMenuTiles;var tileHeight=camera.targetHeight*.075;for(i=0;i<bottomMenuTiles.length;++i){tile=bottomMenuTiles[i];if(tile.textObject){tile.setTextHeight(tileHeight*.9,true);tile.setTileSize(tile.collisionSize.width*1.2,tileHeight)}else{tile.setTileSize(tileHeight)}if(i===0){tile.setPositionXY(camera.cameraHWidth-tile.collisionBounds[0],-camera.cameraHHeight+tile.collisionBounds[1])}else{tile.positionTileLeft(bottomMenuTiles[i-1])}}var sideMenuTiles=this.sideMenuTiles;for(i=0;i<sideMenuTiles.length;++i){tile=sideMenuTiles[i];if(i===0){tile.setPositionXYZ(camera.cameraHWidth+tile.collisionBounds[0],camera.cameraHHeight-tile.collisionBounds[1],0)}else{tile.positionTileBelow(sideMenuTiles[i-1])}}this.showMenu()};SceneEditorUI.prototype.touchPressed=function(touch){return this.CCSceneAppUI_touchPressed(touch)};SceneEditorUI.prototype.touchMoving=function(touch,touchDelta){return false};SceneEditorUI.prototype.touchReleased=function(touch,touchAction){return this.CCSceneAppUI_touchReleased(touch,touchAction)};SceneEditorUI.prototype.showMenu=function(){var camera=this.camera;var bottomMenuTiles=this.bottomMenuTiles;var sideMenuTiles=this.sideMenuTiles;var tile,i;for(i=0;i<bottomMenuTiles.length;++i){tile=bottomMenuTiles[i];tile.setPositionY(-camera.targetHeight*.5-tile.collisionBounds[1]);tile.translateTileMovementY(tile.collisionSize.height)}for(i=0;i<sideMenuTiles.length;++i){tile=sideMenuTiles[i];if(!tile.disabled){tile.setCollideable(true);tile.setTileMovementX(camera.targetWidth*.5-tile.collisionBounds[0]);tile.setColourAlpha(1,true)}else{tile.setCollideable(false);tile.setColour(gColour.setRGBA(1,1,1,0),true);tile.setTileMovementX(camera.targetWidth*.5+tile.collisionBounds[0])
}}};SceneEditorUI.prototype.hideMenu=function(shouldDelete){var camera=this.camera;if(!camera){return}var bottomMenuTiles=this.bottomMenuTiles;var sideMenuTiles=this.sideMenuTiles;var tile,i;for(i=0;i<bottomMenuTiles.length;++i){tile=bottomMenuTiles[i];tile.setCollideable(false);tile.setColourAlpha(0,true);if(tile.textObject){tile.setTextColourAlpha(0,true)}tile.translateTileMovementY(-tile.collisionSize.height)}for(i=0;i<sideMenuTiles.length;++i){tile=sideMenuTiles[i];tile.setCollideable(false);tile.setColour(gColour.setRGBA(1,1,1,0),true);tile.setTileMovementX(camera.targetWidth*.5+tile.collisionBounds[0])}if(shouldDelete){var self=this;if(sideMenuTiles.length>0){sideMenuTiles[0].setColourAlpha(0,true,function(){self.deleteLater()})}else if(bottomMenuTiles.length>0){bottomMenuTiles[0].setColourAlpha(0,true,function(){self.deleteLater()})}else{this.deletLater()}}};SceneEditorUI.prototype.handleResizeButton=function(){this.enableObjectResizing=!this.enableObjectResizing;this.editor.objectResized();if(this.enableObjectResizing){this.tileResize.setColour(gColour.setRGBA(.25,.5,1,1),true)}else{this.tileResize.setColour(gColour.setRGBA(1,1,1,1),true)}};SceneEditorUI.prototype.objectEditorOpen=function(objects){if(!this.sceneUIListObjects){this.sceneUIListObjects=new this.ObjectsListClass(this,this.editor);if(CCEngine.IsMobile()){this.enableObjectResizing=false}else{this.enableObjectResizing=true}}this.sceneUIListObjects.showObjects(objects);var showMenu=false;for(var i=0;i<this.objectMenuTiles.length;++i){var tile=this.objectMenuTiles[i];if(tile.disabled){tile.disabled=false;showMenu=true}}if(showMenu){this.showMenu()}};SceneEditorUI.prototype.objectEditorClose=function(){if(this.sceneUIListObjects){this.sceneUIListObjects.close();this.sceneUIListObjects=null;var showMenu=false;for(var i=0;i<this.objectMenuTiles.length;++i){var tile=this.objectMenuTiles[i];if(!tile.disabled){tile.disabled=true;showMenu=true}}if(showMenu){this.showMenu()}}};SceneEditorUI.prototype.createResizers=function(useZPlane){var scene=this.editor;this.tileObjectResizer=[];function createResizer(){var tile;tile=new CCTile3DButton(scene,true);tile.setDrawOrder(300);tile.renderPass=CCRenderer.render_post;tile.setRotationX(scene.camera.rotation[0]);tile.onPress.push(function(tile,touch){scene.objectResizingBegin(tile,touch)});tile.onRelease.push(function(){scene.objectResizingEnd()});scene.addTile(tile);tile.setColour(gColour.setRGBA(1,0,0,.75));return tile}this.tileObjectResizer.push(createResizer());this.tileObjectResizer.push(createResizer());this.tileObjectResizer.push(createResizer());this.tileObjectResizer.push(createResizer());this.tileObjectResizer.push(createResizer());this.tileObjectResizer.push(createResizer());this.tileObjectResizer.push(createResizer());this.tileObjectResizer.push(createResizer())};SceneEditorUI.prototype.hideUpDownLeftRightResizrs=function(){this.tileObjectResizer[0].shouldRender=false;this.tileObjectResizer[2].shouldRender=false;this.tileObjectResizer[4].shouldRender=false;this.tileObjectResizer[6].shouldRender=false};SceneEditorUI.prototype.updateResizerSize=function(){var editorCamera=this.editor.camera;var cameraHeight=editorCamera.calcCameraHeightForOffset(editorCamera.offset[2]);var size=cameraHeight*.025;if(CCEngine.IsMobile()){size*=3}for(i=0;i<this.tileObjectResizer.length;++i){this.tileObjectResizer[i].setTileSize(size,size,size)}};SceneEditorUI.prototype.getResizerObjectSize=function(tileObjectResizer,object,movement){if(tileObjectResizer===this.tileObjectResizer[0]){size=object.collisionBounds[1]*2+movement[1]*2}else if(tileObjectResizer===this.tileObjectResizer[4]){size=object.collisionBounds[1]*2+-movement[1]*2}else if(tileObjectResizer===this.tileObjectResizer[2]){size=object.collisionBounds[0]*2+movement[0]*2}else if(tileObjectResizer===this.tileObjectResizer[6]){size=object.collisionBounds[0]*2+-movement[0]*2}else if(tileObjectResizer===this.tileObjectResizer[1]||tileObjectResizer===this.tileObjectResizer[3]){size=object.collisionBounds[0]*2+movement[0]*2}else{size=object.collisionBounds[0]*2+-movement[0]*2}return size};SceneEditorUI.prototype.hideResizers=function(useZPlane){var editorCamera=this.editor.camera;for(var i=0;i<this.tileObjectResizer.length;++i){if(useZPlane){this.tileObjectResizer[i].setPositionXZ(editorCamera.targetWidth,editorCamera.targetHeight)}else{this.tileObjectResizer[i].setPositionXY(editorCamera.targetWidth,editorCamera.targetHeight)}}};SceneEditorUI.prototype.setResizersAroundObject=function(object,useZPlane){var tile;if(useZPlane){tile=this.tileObjectResizer[0];tile.setPositionXZ(object.position[0],object.aabbMax[2]);tile=this.tileObjectResizer[1];tile.setPositionXZ(object.aabbMax[0],object.aabbMax[2]);tile=this.tileObjectResizer[2];tile.setPositionXZ(object.aabbMax[0],object.position[2]);tile=this.tileObjectResizer[3];tile.setPositionXZ(object.aabbMax[0],object.aabbMin[2]);tile=this.tileObjectResizer[4];tile.setPositionXZ(object.position[0],object.aabbMin[2]);tile=this.tileObjectResizer[5];tile.setPositionXZ(object.aabbMin[0],object.aabbMin[2]);tile=this.tileObjectResizer[6];tile.setPositionXZ(object.aabbMin[0],object.position[2]);tile=this.tileObjectResizer[7];tile.setPositionXZ(object.aabbMin[0],object.aabbMax[2])}else{tile=this.tileObjectResizer[0];tile.setPositionXY(object.position[0],object.aabbMax[1]);tile=this.tileObjectResizer[1];tile.setPositionXY(object.aabbMax[0],object.aabbMax[1]);tile=this.tileObjectResizer[2];tile.setPositionXY(object.aabbMax[0],object.position[1]);tile=this.tileObjectResizer[3];tile.setPositionXY(object.aabbMax[0],object.aabbMin[1]);tile=this.tileObjectResizer[4];tile.setPositionXY(object.position[0],object.aabbMin[1]);tile=this.tileObjectResizer[5];tile.setPositionXY(object.aabbMin[0],object.aabbMin[1]);tile=this.tileObjectResizer[6];tile.setPositionXY(object.aabbMin[0],object.position[1]);tile=this.tileObjectResizer[7];tile.setPositionXY(object.aabbMin[0],object.aabbMax[1])}};function SceneMapEditorUI(editor,manager){this.construct();this.manager=manager;{this.editor=editor;editor.linkScene(this)}{var parentCameraIndex=gEngine.findCameraIndex(editor.camera);var camera=gEngine.newSceneCamera(this,parentCameraIndex+1);camera.setupViewport(0,0,1,1)}this.sceneJSMapEditor=null;this.sceneUIListObjects=null;this.ObjectsListClass=SceneUIListObjectsMap;this.sceneUIListDBModels=null;this.sceneAssetEditor=null;this.enableSelectionBox=false;this.enableObjectResizing=true}ExtendPrototype(SceneMapEditorUI,SceneEditorUI);SceneMapEditorUI.prototype.setupUI=function(){var self=this;var camera=this.camera;var tile;var bottomMenuTiles=this.bottomMenuTiles;var sideMenuTiles=this.sideMenuTiles;{{tile=new CCTile3DButton(this);tile.setupTextured("editor_icon_delete.jpg",function(){self.requestResize()});tile.setColour(gColour.setRGBA(.5,0,0,0));tile.setDrawOrder(204);tile.onRelease.push(function(){self.manager.handleDeleteMap()});this.addTile(tile,0);bottomMenuTiles.add(tile);this.tileDelete=tile}{tile=new CCTile3DButton(this);tile.setupText(" ",1,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.setColour(gColour.setRGBA(.5,.65,1,0));tile.setTextColour(gColour.setRGBA(1,1,1,0));tile.setColour(gColour.set(.55,0));tile.setDrawOrder(204);tile.onRelease.push(function(){self.manager.handleEditName()});this.addTile(tile,0);bottomMenuTiles.add(tile);this.tileMapName=tile}{tile=new CCTile3DButton(this);tile.setupTile(1);tile.setColour(gColour.set(1,0));tile.setDrawOrder(204);tile.onRelease.push(function(){self.manager.handleEditPrivacy()});this.addTile(tile,0);bottomMenuTiles.add(tile);this.tileMapPrivacy=tile}{tile=new CCTile3DButton(this);tile.setupText(" ",1,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.setColour(gColour.setRGBA(.5,.65,1,0));tile.setTextColour(gColour.setRGBA(1,1,1,0));tile.setColour(gColour.set(.55,0));tile.setDrawOrder(204);this.addTile(tile,0);bottomMenuTiles.add(tile);this.tileMapID=tile}}{{tile=new CCTile3DButton(this);tile.setupTexturedWidth(camera.cameraWidth*.1,"editor_tile_back.jpg",function(){self.requestResize()});tile.setColour(gColour.setRGBA(1,1,1,0));tile.setDrawOrder(204);tile.onRelease.push(function(){self.manager.handleBackButton()});this.addTile(tile,0);this.tileBack=tile;sideMenuTiles.add(tile)}{tile=new CCTile3DButton(this);tile.setupTexturedWidth(camera.cameraWidth*.1,"editor_tile_selection.jpg",function(){self.requestResize()});tile.setColour(gColour.setRGBA(1,1,1,0));tile.setDrawOrder(204);tile.onRelease.push(function(){self.handleSelectionButton()});this.addTile(tile,0);this.tileSelection=tile;sideMenuTiles.add(tile)}{tile=new CCTile3DButton(this);tile.setupTexturedWidth(camera.cameraWidth*.1,"editor_tile_hammer.jpg",function(){self.requestResize()});tile.setColour(gColour.setRGBA(1,1,1,0));tile.setDrawOrder(204);tile.onRelease.push(function(){self.handleCreateButton()});this.addTile(tile,0);this.tileCreate=tile;sideMenuTiles.add(tile)}var objectMenuTiles=this.objectMenuTiles=[];if(CCEngine.IsMobile()){tile=new CCTile3DButton(this);tile.setupTexturedWidth(camera.cameraWidth*.1,"editor_tile_resize.jpg",function(){self.requestResize()});tile.setColour(gColour.setRGBA(1,1,1,0));tile.setDrawOrder(204);tile.onRelease.push(function(){self.handleResizeButton()});this.addTile(tile,0);sideMenuTiles.add(tile);objectMenuTiles.add(tile);tile.disabled=true;this.tileResize=tile}}};SceneMapEditorUI.prototype.setupMenu=function(mapID,mapName,mapOpen){var self=this;var camera=this.camera;var bottomMenuTiles=this.bottomMenuTiles;var sideMenuTiles=this.sideMenuTiles;var tile,i;for(i=0;i<bottomMenuTiles.length;++i){tile=bottomMenuTiles[i];tile.setCollideable(true);if(tile===this.tileMapID){tile.setText(mapID,true);tile.setTextColourAlpha(1,true)}else if(tile===this.tileMapName){tile.setText(mapName,true);tile.setTextColourAlpha(1,true)}else if(tile===this.tileMapPrivacy){if(mapOpen){tile.setTileTexture("editor_icon_public.jpg")}else{tile.setTileTexture("editor_icon_private.jpg")}}tile.setColourAlpha(1,true)}this.requestResize();this.showMenu()};SceneMapEditorUI.prototype.hideMenu=function(shouldDelete){this.objectEditorClose();this.closeModelsList();this.closeAssetEditor();this.SceneEditorUI_hideMenu(shouldDelete)};SceneMapEditorUI.prototype.handleSelectionButton=function(){this.enableSelectionBox=!this.enableSelectionBox;if(this.enableSelectionBox){if(this.creatingObjects){this.handleCreateButton()}this.enableSelectionBox=true;this.tileSelection.setColour(gColour.setRGBA(.25,.5,1,1),true)}else{this.tileSelection.setColour(gColour.setRGBA(1,1,1,1),true)}};SceneMapEditorUI.prototype.handleCreateButton=function(){this.creatingObjects=!this.creatingObjects;if(this.creatingObjects){if(this.enableSelectionBox){this.handleSelectionButton()}this.openModelsList();this.tileCreate.setColour(gColour.setRGBA(.25,.5,1,1),true)}else{this.closeModelsList();this.tileCreate.setColour(gColour.setRGBA(1,1,1,1),true)}this.editor.selectedObjectsUpdated()};SceneMapEditorUI.prototype.openModelsList=function(){this.objectEditorClose();if(!this.sceneUIListDBModels){var self=this;this.sceneUIListDBModels=new SceneUIListDBModels(this);this.sceneUIListDBModels.onSelected=function(modelInfo){self.manager.modelSelected(modelInfo)};this.sceneUIListDBModels.onEdit=function(modelInfo){self.openAssetEditor("Edit Model",true,false,function(modelInfo){self.manager.modelSelected(modelInfo)});self.sceneAssetEditor.setModel(modelInfo)};var selectedObjects=this.editor.selectedObjects;if(selectedObjects&&selectedObjects.length>0){var object=selectedObjects[0];if(object.modelID){this.findAndSelectModelID(object.modelID)}else{var info={};info.obj=object.obj;info.tex=object.tex;if(this.sceneUIListDBModels){this.sceneUIListDBModels.findAndSelect(info)}}}}};SceneMapEditorUI.prototype.getSelectedModel=function(){if(this.sceneUIListDBModels){return this.sceneUIListDBModels.getSelected()}return null};SceneMapEditorUI.prototype.closeModelsList=function(){if(this.sceneUIListDBModels){this.sceneUIListDBModels.close();this.sceneUIListDBModels=null}};SceneMapEditorUI.prototype.flagPendingModelUpdate=function(){if(this.sceneUIListDBModels){this.sceneUIListDBModels.loaded=false}};SceneMapEditorUI.prototype.findAndSelectModelID=function(modelID,callback){if(this.sceneUIListDBModels){this.sceneUIListDBModels.findAndSelectID(modelID,callback)}};SceneMapEditorUI.prototype.openJSMapEditor=function(callback){if(this.sceneAssetEditor){this.closeAssetEditor()}if(this.sceneJSMapEditor){this.closeJSMapEditor()}this.hideMenu();this.sceneJSMapEditor=new SceneJSMapEditor(this);this.sceneJSMapEditor.open();if(callback){this.sceneJSMapEditor.onClose=callback}};SceneMapEditorUI.prototype.closeJSMapEditor=function(){if(this.sceneJSMapEditor){this.sceneJSMapEditor.close();this.sceneJSMapEditor=null}};SceneMapEditorUI.prototype.openAssetEditor=function(title,supportObj,showLists,callback){if(this.sceneAssetEditor){this.closeAssetEditor()}if(this.sceneJSMapEditor){this.closeJSMapEditor()}this.sceneAssetEditor=new SceneAssetEditor(this,supportObj,showLists);this.sceneAssetEditor.open(title);if(callback){this.sceneAssetEditor.onClose=callback}};SceneMapEditorUI.prototype.closeAssetEditor=function(){if(this.sceneAssetEditor){this.sceneAssetEditor.close();this.sceneAssetEditor=null}};function SceneMapEditor(mapID,mapsManager,mapData){this.mapsManager=mapsManager;this.name=mapData.name;this.open=mapData.open;this.construct(mapID,"MapEditor");this.syncUpdate(mapData)}ExtendPrototype(SceneMapEditor,SceneGameMap);SceneMapEditor.prototype.construct=function(mapID,mapType){var self=this;this.SceneGameMap_construct(mapID,mapType);this.camera.setPerspective(15);this.camera.offsetInterpolator.setDuration(.3);this.onDragDropFunction=function(files,event){self.mapsManager.onDragDrop(files,event)};gEngine.controls.onDragDrop.add(this.onDragDropFunction);this.selectedObjects=[]};SceneMapEditor.prototype.destruct=function(){if(this.onDragDropFunction){gEngine.controls.onDragDrop.remove(this.onDragDropFunction);this.onDragDropFunction=null}this.SceneGameMap_destruct()};SceneMapEditor.prototype.deleteLater=function(){if(this.sceneUI){this.sceneUI.hideMenu(true);this.sceneUI=null}this.SceneGameMap_deleteLater()};SceneMapEditor.prototype.setup=function(){var self=this;this.SceneGameMap_setup();var camera=this.camera;camera.setRotationX(-80);this.sceneUI=new SceneMapEditorUI(this,this.mapsManager);gEngine.addScene(this.sceneUI);this.sceneUI.setupMenu(this.mapID,this.name,this.open);this.sceneUI.hideUpDownLeftRightResizrs()};SceneMapEditor.prototype.setMapSize=function(size,zoom){if(zoom===undefined){zoom=true}this.SceneGameMap_setMapSize(size);var camera=this.camera;var mapSizeOffset;if(camera.targetWidth<=camera.targetHeight){mapSizeOffset=camera.calcCameraOffsetForWidth(this.mapSize);this.minZoomOffset=camera.calcCameraOffsetForWidth(300)}else{mapSizeOffset=camera.calcCameraOffsetForHeight(this.mapSize);this.minZoomOffset=camera.calcCameraOffsetForHeight(300)}this.maxZoomOffset=mapSizeOffset*2;if(this.maxZoomOffset>3e4){this.maxZoomOffset=3e4}if(zoom){camera.targetOffset[2]=mapSizeOffset*1.25;camera.targetOffset[2]=CC.FloatClamp(camera.targetOffset[2],this.minZoomOffset,this.maxZoomOffset);camera.targetWidth=camera.calcCameraWidthForOffset(camera.targetOffset[2]);camera.flagUpdate()}};SceneMapEditor.prototype.updateScene=function(delta){return this.SceneGameMap_updateScene(delta)};SceneMapEditor.prototype.updateCamera=function(delta){var updated=false;var camera=this.camera;var lookAtSpeed=this.controlsMoving&&!this.cameraScrolling?20:1.5;if(this.camera.interpolateCamera(delta,lookAtSpeed)){if(this.scrollBar){}var tile;var cameraStickyTiles=this.cameraStickyTiles;for(var i=0;i<cameraStickyTiles.length;++i){tile=cameraStickyTiles[i];tile.setPosition(this.camera.currentLookAt)}{this.sceneUI.updateResizerSize();this.objectResized()}updated=true}else{if(this.cameraScrolling){this.cameraScrolling=false;this.lockCameraView();updated=true}if(this.resizing){this.resizing=false;this.refreshCameraView();this.lockCameraView();updated=true}}return updated};SceneMapEditor.prototype.postRender=function(camera,pass,alpha){if(this.camera===camera){this.SceneGameMap_postRender(camera,pass,alpha);if(pass===CCRenderer.render_main&&alpha){var renderer=gRenderer;var object;var selectedObjects=this.selectedObjects;if(selectedObjects.length>0){gEngine.textureManager.setTextureIndex(1);renderer.CCDefaultTexCoords();renderer.CCSetColour(gColour.setRGBA(1,0,0,.5));for(var i=0;i<selectedObjects.length;++i){object=selectedObjects[i];CCRenderer.GLPushMatrix();var position=object.position;CCRenderer.GLTranslate([position[0],0,position[2]]);CCRenderer.GLScale([object.collisionSize.width,1,object.collisionSize.width]);renderer.CCRenderCube(true);CCRenderer.GLPopMatrix()}}if(this.selectionBoxStart&&this.selectionBoxEnd){var selectionBoxStart=this.selectionBoxStart;var selectionBoxEnd=this.selectionBoxEnd;var size=vec3.clone(selectionBoxEnd);vec3.subtract(size,selectionBoxEnd,selectionBoxStart);var position=vec3.clone(selectionBoxStart);position[0]+=size[0]*.5;position[1]+=size[1]*.5;position[2]+=size[2]*.5;gEngine.textureManager.setTextureIndex(1);renderer.CCSetColour(gColour.setRGBA(1,0,0,.5));CCRenderer.GLPushMatrix();CCRenderer.GLTranslate(position);CCRenderer.GLScale([size[0],1,size[2]]);renderer.CCRenderCube(true);CCRenderer.GLPopMatrix()}}}};SceneMapEditor.prototype.updateControls=function(controls){var usingControls=this.SceneGameMap_updateControls(controls);var cameraTouches=this.camera.cameraTouches;var touch=cameraTouches[0];if(touch.x>0&&touch.x<1&&touch.y>0&&touch.y<1&&touch.startX>0&&touch.startX<1&&touch.startY>0&&touch.startY<1){if(controls.wheel&&controls.wheel.delta!==0){var delta=controls.wheel.delta;var camera=this.camera;camera.targetOffset[2]+=camera.targetOffset[2]*delta*.1;camera.targetOffset[2]=CC.FloatClamp(camera.targetOffset[2],this.minZoomOffset,this.maxZoomOffset);camera.targetWidth=camera.calcCameraWidthForOffset(camera.targetOffset[2]);camera.flagUpdate();return true}}return usingControls};SceneMapEditor.prototype.handleTwoTouches=function(touch1,touch2){var topTouch=touch1;var bottomTouch=touch2;if(touch1.y<touch2.y){topTouch=touch2;bottomTouch=touch1}var rightTouch=touch1;var leftTouch=touch2;if(touch1.x<touch2.x){rightTouch=touch2;leftTouch=touch1}var combinedDelta=topTouch.deltaY+rightTouch.deltaX+-bottomTouch.deltaY+-leftTouch.deltaX;return this.touchCameraZooming(combinedDelta)};SceneMapEditor.prototype.touchPressed=function(touch){var camera=this.camera;var hitLocation,projectionResults,offset,i;if(this.sceneUI.enableSelectionBox){if(camera.project3D(touch.x,touch.y)){hitLocation=vec3.create();projectionResults=camera.projectionResults;offset=projectionResults.vNear[1]/Math.abs(projectionResults.vDirection[1]);vec3.scale(hitLocation,projectionResults.vDirection,offset);vec3.add(hitLocation,hitLocation,projectionResults.vNear);this.selectionBoxStart=hitLocation}}else{var result=this.handleTilesTouch(touch,CCControls.touch_pressed);if(result===CCSceneAppUI.tile_touchAction){return true}else{var selectedObjects=this.selectedObjects;if(selectedObjects.length>0){var containsStaticObjectsOnly=true;for(i=0;i<selectedObjects.length;++i){if(selectedObjects[i]===this.ground||selectedObjects[i].playerID){containsStaticObjectsOnly=false;break}}if(containsStaticObjectsOnly){if(camera.project3D(touch.x,touch.y)){hitLocation=vec3.create();projectionResults=camera.projectionResults;offset=projectionResults.vNear[1]/Math.abs(projectionResults.vDirection[1]);vec3.scale(hitLocation,projectionResults.vDirection,offset);vec3.add(hitLocation,hitLocation,projectionResults.vNear);for(i=0;i<selectedObjects.length;++i){var object=selectedObjects[i];CC.UpdateCollisions(object);if(CC.BasicBoxCollisionCheck(object.aabbMin,object.aabbMax,hitLocation,hitLocation)){this.touchPressedStartLocation=hitLocation;return true}}}}}}}return false};SceneMapEditor.prototype.touchMoving=function(touch,touchDelta){var camera=this.camera;var hitLocation,projectionResults,offset;var allowCameraMovement=true;if(this.sceneUI.enableSelectionBox){allowCameraMovement=false;if(camera.project3D(touch.x,touch.y)){hitLocation=this.selectionBoxEnd?this.selectionBoxEnd:vec3.create();projectionResults=camera.projectionResults;offset=projectionResults.vNear[1]/Math.abs(projectionResults.vDirection[1]);vec3.scale(hitLocation,projectionResults.vDirection,offset);vec3.add(hitLocation,hitLocation,projectionResults.vNear);this.selectionBoxEnd=hitLocation}}else if(this.touchPressedStartLocation){allowCameraMovement=false;if(camera.project3D(touch.x,touch.y)){hitLocation=vec3.create();projectionResults=camera.projectionResults;offset=projectionResults.vNear[1]/Math.abs(projectionResults.vDirection[1]);vec3.scale(hitLocation,projectionResults.vDirection,offset);vec3.add(hitLocation,hitLocation,projectionResults.vNear);var movement=vec3.clone(hitLocation);vec3.subtract(movement,movement,this.touchPressedStartLocation);var i,object;if(this.touchPressedResizing){this.objectResizingMove(hitLocation,movement)}else{this.movingObjects=true;var selectedObjects=this.selectedObjects;for(i=0;i<selectedObjects.length;++i){object=selectedObjects[i];if(!object.playerID&&object!==this.ground){object.translate(movement[0],movement[1],movement[2])}}this.objectResized()}this.touchPressedStartLocation=hitLocation;return true}}else{var result=this.handleTilesTouch(touch,this.controlsMovingVertical?CCControls.touch_movingVertical:CCControls.touch_movingHorizontal);if(result===CCSceneAppUI.tile_touchAction){return true}}if(allowCameraMovement){return this.touchCameraMoving(touchDelta.x,touchDelta.y)}return false};SceneMapEditor.prototype.touchReleased=function(touch,touchAction){var usingControls=false;if(this.touchPressedStartLocation){delete this.touchPressedStartLocation}if(this.sceneUI.enableSelectionBox){usingControls=this.handleSelectionBox(touch)}else if(this.movingObjects){usingControls=true;this.mapsManager.objectsMoved();delete this.movingObjects}else{var result=this.handleTilesTouch(touch,touchAction);usingControls=result===CCSceneAppUI.tile_touchAction;if(!usingControls&&touchAction>=CCControls.touch_released){if(this.oneTouchDoubleTapped){}else if(this.controlsMoving){if(this.touchPressedResizing){this.objectResizingEnd();usingControls=true}else{usingControls=this.touchReleaseSwipe(touch)}}else if(touchAction===CCControls.touch_released){if(this.sceneUI.creatingObjects){usingControls=this.handleCreatingObjects(touch)}if(!usingControls){usingControls=this.handleObjectSelection(touch)}}}}if(this.oneTouchDoubleTappedLastPress){this.oneTouchDoubleTappedLastPress=false}if(this.oneTouchDoubleTapped){this.oneTouchDoubleTappedLastPress=true;this.oneTouchDoubleTapped=false}return usingControls};SceneMapEditor.prototype.touchReleaseSwipe=function(touch){return this.CCSceneAppUI_touchReleaseSwipe(touch)};SceneMapEditor.prototype.refreshCameraView=function(){var collisionBounds=this.ground.collisionBounds;this.sceneLeft=-collisionBounds[0];this.sceneRight=collisionBounds[0];this.sceneTop=collisionBounds[2];this.sceneBottom=-collisionBounds[2]};SceneMapEditor.prototype.updatePathFinder=function(){var pathFinderNetwork=this.pathFinderNetwork;var selectedObjects=this.selectedObjects;for(var i=0;i<selectedObjects.length;++i){var object=selectedObjects[i];if(!object.playerID&&object!==this.ground){pathFinderNetwork.removeCollideable(object);pathFinderNetwork.addCollideable(object,this.ground.collisionBounds)}}this.SceneGameMap_updatePathFinder()};SceneMapEditor.prototype.removeEnemyID=function(playerID){var selectedObjects=this.selectedObjects;for(var i=0;i<selectedObjects.length;++i){var object=selectedObjects[i];if(object.playerID===playerID){this.selectedObjectsRemove(object);break}}this.SceneGameMap_removeEnemyID(playerID)};SceneMapEditor.prototype.syncRemoveStaticObject=function(objectID){var selectedObjects=this.selectedObjects;for(var i=0;i<selectedObjects.length;++i){var object=selectedObjects[i];if(object.getID()===objectID){this.selectedObjectsRemove(object);break}}this.SceneGameMap_syncRemoveStaticObject(objectID)};SceneMapEditor.prototype.selectedObjectsAdd=function(object){if(object){if(object.getMovementInterpolator()){object.getMovementInterpolator().finish()}if(this.selectedObjects.find(object)===-1){this.selectedObjects.add(object);this.selectedObjectsUpdated()}}};SceneMapEditor.prototype.selectedObjectsRemove=function(object){this.selectedObjects.remove(object);this.selectedObjectsUpdated()};SceneMapEditor.prototype.selectedObjectsClear=function(){this.selectedObjects.length=0;this.selectedObjectsUpdated()};SceneMapEditor.prototype.selectedObjectsUpdated=function(){if(this.sceneUI){if(this.sceneUI.enableSelectionBox){this.sceneUI.handleSelectionButton()}var selectedObjects=this.selectedObjects;if(selectedObjects&&selectedObjects.length>0){if(!this.sceneUI.sceneUIListDBModels){this.sceneUI.objectEditorOpen(selectedObjects)}}else{this.sceneUI.objectEditorClose()}}this.objectResized()};SceneMapEditor.prototype.handleSelectionBox=function(touch){var camera=this.camera;if(this.selectionBoxStart&&camera.project3D(touch.x,touch.y)){var hitLocation=vec3.create();var projectionResults=camera.projectionResults;var offset=projectionResults.vNear[1]/Math.abs(projectionResults.vDirection[1]);vec3.scale(hitLocation,projectionResults.vDirection,offset);vec3.add(hitLocation,hitLocation,projectionResults.vNear);var selectionBoxMin=this.selectionBoxStart;var selectionBoxMax=hitLocation;CC.CalculateMinMaxVectors(selectionBoxMin,selectionBoxMax);var selectedObjects=this.selectedObjects;selectedObjects.length=0;var objects=this.players;var i,object;for(i=0;i<objects.length;++i){object=objects[i];CC.UpdateCollisions(object);if(CC.BasicBoxCollisionCheck(object.aabbMin,object.aabbMax,selectionBoxMin,selectionBoxMax)){selectedObjects.add(object)}}objects=this.staticObjects;for(i=0;i<objects.length;++i){object=objects[i];CC.UpdateCollisions(object);if(CC.BasicBoxCollisionCheck(object.aabbMin,object.aabbMax,selectionBoxMin,selectionBoxMax)){selectedObjects.add(object)}}this.selectedObjectsUpdated();delete this.selectionBoxStart;if(this.selectionBoxEnd){delete this.selectionBoxEnd}}return true};SceneMapEditor.prototype.handleObjectSelection=function(touch){if(this.sceneUI.creatingObjects){this.sceneUI.handleCreateButton()}var camera=this.camera;var hitObject=null;var hitLocation=vec3.create();if(camera.project3D(touch.x,touch.y)){var projectionResults=camera.projectionResults;var collideables=this.collideables;hitObject=CC.BasicLineCollisionCheck(collideables,projectionResults.vNear,projectionResults.vFar,hitLocation,true,CC.collision_box,null,false,true);if(!hitObject){var offset=projectionResults.vNear[1]/Math.abs(projectionResults.vDirection[1]);vec3.scale(hitLocation,projectionResults.vDirection,offset);vec3.add(hitLocation,hitLocation,projectionResults.vNear);var hScanArea=camera.targetWidth*.01;var min=vec3.clone(hitLocation);min[0]-=hScanArea;min[2]-=hScanArea;var max=vec3.clone(hitLocation);max[0]+=hScanArea;max[2]+=hScanArea;hitObject=CC.CollideableScan(min,max,null,CC.collision_box,true)}}this.mapsManager.objectSelected(hitObject,hitLocation);return!!hitObject};SceneMapEditor.prototype.handleCreatingObjects=function(touch){var camera=this.camera;var hitObject=null;var hitLocation=vec3.create();if(camera.project3D(touch.x,touch.y)){var projectionResults=camera.projectionResults;var collideables=this.collideables;hitObject=CC.BasicLineCollisionCheck(collideables,projectionResults.vNear,projectionResults.vFar,hitLocation,true,CC.collision_box,[this.ground],false);if(!hitObject){var offset=projectionResults.vNear[1]/Math.abs(projectionResults.vDirection[1]);vec3.scale(hitLocation,projectionResults.vDirection,offset);vec3.add(hitLocation,hitLocation,projectionResults.vNear);this.selectedObjectsClear();this.mapsManager.createObject(hitLocation)}}return!hitObject};SceneMapEditor.prototype.findObject=function(object){var camera=this.camera;camera.targetOffset[2]=camera.calcCameraOffsetForWidth(object.collisionSize.width*4);camera.targetOffset[2]=CC.FloatClamp(camera.targetOffset[2],this.minZoomOffset,this.maxZoomOffset);camera.targetLookAt[0]=object.position[0];camera.targetLookAt[2]=object.position[2];camera.flagUpdate()};SceneMapEditor.prototype.deleteObject=function(object){this.mapsManager.deleteObject(object)};SceneMapEditor.prototype.objectResizingBegin=function(tile,touch){var camera=this.camera;if(camera.project3D(touch.x,touch.y)){var hitLocation=vec3.create();var projectionResults=camera.projectionResults;var offset=projectionResults.vNear[1]/Math.abs(projectionResults.vDirection[1]);vec3.scale(hitLocation,projectionResults.vDirection,offset);vec3.add(hitLocation,hitLocation,projectionResults.vNear);this.touchPressedStartLocation=hitLocation;this.touchPressedResizing=tile}};SceneMapEditor.prototype.objectResizingMove=function(hitLocation,movement){this.touchPressedResizing.setPositionXZ(hitLocation[0],hitLocation[2]);var selectedObjects=this.selectedObjects;if(selectedObjects.length>0){var tileObjectResizer=this.touchPressedResizing;var size;for(i=0;i<selectedObjects.length;++i){var object=selectedObjects[i];size=this.sceneUI.getResizerObjectSize(tileObjectResizer,object,movement);if(object===this.ground){if(size<200){size=200}if(size>5e3){size=5e3}this.setMapSize(size,false)}else if(!object.playerID){if(size<10){size=10}if(size>this.mapSize*.5){size=this.mapSize*.5}object.resize(size)}}}this.objectResized()};SceneMapEditor.prototype.objectResized=function(){this.sceneUI.hideResizers(true);if(this.sceneUI&&this.sceneUI.enableObjectResizing){var selectedObjects=this.selectedObjects;for(var i=0;i<selectedObjects.length;++i){var object=selectedObjects[i];if(!object.playerID){this.sceneUI.setResizersAroundObject(object,true);break}}}};SceneMapEditor.prototype.objectResizingEnd=function(){delete this.touchPressedResizing;delete this.touchPressedStartLocation;this.refreshCameraView();var selectedObjects=this.selectedObjects;if(selectedObjects.length>0){this.mapsManager.objectsResized()}};function SceneUIEditorUI(editor,manager){this.construct();this.manager=manager;{this.editor=editor;manager.linkScene(this)}{var parentCameraIndex=gEngine.findCameraIndex(editor.camera);var camera=gEngine.newSceneCamera(this,parentCameraIndex-1);camera.setupViewport(0,0,1,1)}this.sceneUIListObjects=null;this.ObjectsListClass=SceneUIListObjectsUI;this.sceneAssetEditor=null;this.enableSelectionBox=false;gEngine.addScene(this)}ExtendPrototype(SceneUIEditorUI,SceneEditorUI);SceneUIEditorUI.prototype.resize=function(){this.SceneEditorUI_resize();var camera=this.camera;var tile;{tile=this.tileBackground;var width=camera.targetWidth*.55;var height=720/1080*width;tile.setTileSize(width,height)}};SceneUIEditorUI.prototype.handleOneTouch=function(touch){return this.CCSceneAppUI_handleOneTouch(touch)};SceneUIEditorUI.prototype.touchReleased=function(touch,touchAction){if(!this.SceneEditorUI_touchReleased(touch,touchAction)){this.editor.selectedObjectsClear()}};SceneUIEditorUI.prototype.setupUI=function(){var self=this;var camera=this.camera;var tile;{tile=new CCTile3DButton(this);tile.setupTile();tile.setTileTexture("editor_tabletscreen.png");tile.setColour(gColour.set(1,0));tile.setColourAlpha(1,true);tile.setDrawOrder(200);this.cameraStickyTiles.add(tile);this.tileBackground=tile}var bottomMenuTiles=this.bottomMenuTiles;var sideMenuTiles=this.sideMenuTiles;{{tile=new CCTile3DButton(this);tile.setupTextured("editor_icon_delete.jpg",function(){self.requestResize()});tile.setColour(gColour.setRGBA(.5,0,0,0));tile.setDrawOrder(204);tile.onRelease.push(function(){self.manager.handleDelete()});this.addTile(tile,0);bottomMenuTiles.add(tile);this.tileDelete=tile}{tile=new CCTile3DButton(this);tile.setupTile(1);tile.setColour(gColour.set(1,0));tile.setDrawOrder(204);tile.onRelease.push(function(){self.manager.handleEditPrivacy()});this.addTile(tile,0);bottomMenuTiles.add(tile);this.tilePrivacy=tile
}{tile=new CCTile3DButton(this);tile.setupText(" ",1,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.setColour(gColour.setRGBA(.5,.65,1,0));tile.setTextColour(gColour.setRGBA(1,1,1,0));tile.setColour(gColour.set(.55,0));tile.setDrawOrder(204);tile.onRelease.push(function(){self.manager.handleEditJS()});this.addTile(tile,0);bottomMenuTiles.add(tile);this.tileID=tile}{tile=new CCTile3DButton(this);tile.setupText(" ",1,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.setColour(gColour.setRGBA(.5,.65,1,0));tile.setTextColour(gColour.setRGBA(1,1,1,0));tile.setColour(gColour.set(.55,0));tile.setDrawOrder(204);tile.onRelease.push(function(){self.manager.handleEditName()});this.addTile(tile,0);bottomMenuTiles.add(tile);this.tileName=tile}}{{tile=new CCTile3DButton(this);tile.setupTexturedWidth(camera.cameraWidth*.1,"editor_tile_back.jpg",function(){self.requestResize()});tile.setColour(gColour.setRGBA(1,1,1,0));tile.setDrawOrder(204);tile.onRelease.push(function(){self.manager.handleBackButton()});this.addTile(tile,0);this.tileBack=tile;sideMenuTiles.add(tile)}{tile=new CCTile3DButton(this);tile.setupTexturedWidth(camera.cameraWidth*.1,"editor_tile_selection.jpg",function(){self.requestResize()});tile.setColour(gColour.setRGBA(1,1,1,0));tile.setDrawOrder(204);tile.onRelease.push(function(){self.handleSelectionButton()});this.addTile(tile,0);this.tileSelection=tile;sideMenuTiles.add(tile)}{tile=new CCTile3DButton(this);tile.setupTexturedWidth(camera.cameraWidth*.1,"editor_tile_hammer.jpg",function(){self.requestResize()});tile.setColour(gColour.setRGBA(1,1,1,0));tile.setDrawOrder(204);tile.onRelease.push(function(){self.handleCreateButton()});this.addTile(tile,0);this.tileCreate=tile;sideMenuTiles.add(tile)}var objectMenuTiles=this.objectMenuTiles=[];if(CCEngine.IsMobile()){tile=new CCTile3DButton(this);tile.setupTexturedWidth(camera.cameraWidth*.1,"editor_tile_resize.jpg",function(){self.requestResize()});tile.setColour(gColour.setRGBA(1,1,1,0));tile.setDrawOrder(204);tile.onRelease.push(function(){self.handleResizeButton()});this.addTile(tile,0);sideMenuTiles.add(tile);objectMenuTiles.add(tile);tile.disabled=true;this.tileResize=tile}{tile=new CCTile3DButton(this);tile.setupTexturedWidth(camera.cameraWidth*.1,"editor_tile_copy.jpg",function(){self.requestResize()});tile.setColour(gColour.setRGBA(1,1,1,0));tile.setDrawOrder(204);tile.onRelease.push(function(){self.handleCopyButton()});this.addTile(tile,0);sideMenuTiles.add(tile);objectMenuTiles.add(tile);tile.disabled=true}}};SceneUIEditorUI.prototype.setupMenu=function(info){var id=info.id;var name=info.name;var open=info.open;var self=this;var camera=this.camera;var bottomMenuTiles=this.bottomMenuTiles;var tile,i;for(i=0;i<bottomMenuTiles.length;++i){tile=bottomMenuTiles[i];tile.setCollideable(true);if(tile===this.tileID){tile.setText(id,true);tile.setTextColourAlpha(1,true)}else if(tile===this.tileName){tile.setText(name,true);tile.setTextColourAlpha(1,true)}else if(tile===this.tilePrivacy){if(open){tile.setTileTexture("editor_icon_public.jpg")}else{tile.setTileTexture("editor_icon_private.jpg")}}tile.setColourAlpha(1,true)}this.requestResize();this.showMenu()};SceneUIEditorUI.prototype.hideMenu=function(shouldDelete){this.tileBackground.getColourInterpolator().setDuration(.1);this.tileBackground.setColourAlpha(0,true);this.objectEditorClose();this.closeAssetEditor();this.SceneEditorUI_hideMenu(shouldDelete)};SceneUIEditorUI.prototype.handleSelectionButton=function(){this.enableSelectionBox=!this.enableSelectionBox;if(this.enableSelectionBox){if(this.creatingObjects){this.handleCreateButton()}this.enableSelectionBox=true;this.tileSelection.setColour(gColour.setRGBA(.25,.5,1,1),true)}else{this.tileSelection.setColour(gColour.setRGBA(1,1,1,1),true)}};SceneUIEditorUI.prototype.handleCreateButton=function(){this.creatingObjects=!this.creatingObjects;if(this.creatingObjects){if(this.enableSelectionBox){this.handleSelectionButton()}this.objectEditorClose();this.tileCreate.setColour(gColour.setRGBA(.25,.5,1,1),true)}else{this.tileCreate.setColour(gColour.setRGBA(1,1,1,1),true)}this.editor.selectedObjectsUpdated()};SceneUIEditorUI.prototype.handleCopyButton=function(){this.editor.selectedObjectsCopy()};SceneUIEditorUI.prototype.openAssetEditor=function(title,supportObj,callback){if(this.sceneAssetEditor){this.closeAssetEditor()}this.sceneAssetEditor=new SceneAssetEditor(this,supportObj);var self=this;this.sceneAssetEditor.onClose=function(tex){if(tex){if(self.sceneAssetEditor&&self.sceneAssetEditor.sceneUIListDBImages){self.sceneAssetEditor.sceneUIListDBImages.findAndSelect(tex)}}if(callback){callback(tex)}};if(callback){this.sceneAssetEditor.onClose=callback}this.sceneAssetEditor.open(title)};SceneUIEditorUI.prototype.closeAssetEditor=function(){if(this.sceneAssetEditor){this.sceneAssetEditor.close();this.sceneAssetEditor=null}};function SceneUIEditor(info,manager){this.info=info;this.manager=manager;this.construct();this.cameraCentered=true;this.cameraReletivePositions=true;this.customJSMarker="// custom functions below this point will remain unmodified by the UI Editor (please don't delete this marker)";gEngine.addScene(this)}ExtendPrototype(SceneUIEditor,CCSceneAppUI);SceneUIEditor.prototype.construct=function(){var self=this;this.CCSceneAppUI_construct();this.onKeyboardFunction=function(event,key,pressed){return self.onKeyboard(event,key,pressed)};gEngine.controls.requestKeyboard(this.onKeyboardFunction,false);this.selectedObjects=[];this.uiObjects=[]};SceneUIEditor.prototype.destruct=function(){if(this.onKeyboardFunction){gEngine.controls.removeKeyboard(this.onKeyboardFunction);delete this.onKeyboardFunction}this.selectedObjectsClear();this.CCSceneAppUI_destruct()};SceneUIEditor.prototype.deleteLater=function(){if(this.sceneUI){this.sceneUI.hideMenu(true);this.sceneUI=null}this.CCSceneAppUI_deleteLater()};SceneUIEditor.prototype.setup=function(){var self=this;var camera=gEngine.newSceneCamera(this);this.setupViewport();camera.offsetInterpolator.setDuration(.3);this.CCSceneAppUI_setup();this.sceneUI=new SceneUIEditorUI(this,this.manager);this.sceneUI.setupMenu(this.info)};SceneUIEditor.prototype.setupViewport=function(){var frameBufferWidth,frameBufferHeight;if(CCEngine.IsPortrait()){frameBufferWidth=gRenderer.width;frameBufferHeight=gRenderer.height}else{frameBufferWidth=gRenderer.height;frameBufferHeight=gRenderer.width}var targetAspectRatio=720/1080;var targetFrameHeight=targetAspectRatio*frameBufferWidth*.5;var viewportHeight=targetFrameHeight/frameBufferHeight;var viewportY=(1-viewportHeight)*.5;this.camera.setupViewport(.25,viewportY,.5,viewportHeight)};SceneUIEditor.prototype.resize=function(){this.setupViewport();this.CCSceneAppUI_resize();this.selectedObjectsUpdated()};SceneUIEditor.prototype.updateScene=function(delta){return this.CCSceneAppUI_updateScene(delta)};SceneUIEditor.prototype.updateCamera=function(delta){var updated=false;var camera=this.camera;var lookAtSpeed=this.controlsMoving&&!this.cameraScrolling?20:1.5;if(this.camera.interpolateCamera(delta,lookAtSpeed)){if(this.scrollBar){}var tile,i;var cameraStickyTiles=this.cameraStickyTiles;for(i=0;i<cameraStickyTiles.length;++i){tile=cameraStickyTiles[i];tile.setPosition(this.camera.currentLookAt)}{this.sceneUI.updateResizerSize();this.objectResized()}updated=true}else{if(this.cameraScrolling){this.cameraScrolling=false;this.lockCameraView();updated=true}if(this.resizing){this.resizing=false;this.refreshCameraView();this.lockCameraView();updated=true}}return updated};SceneUIEditor.prototype.postRender=function(camera,pass,alpha){if(this.camera===camera){if(pass===CCRenderer.render_main&&alpha){var renderer=gRenderer;var object;var selectedObjects=this.selectedObjects;if(selectedObjects.length>0){gEngine.textureManager.setTextureIndex(1);renderer.CCDefaultTexCoords();renderer.CCSetColour(gColour.setRGBA(1,0,0,.5));for(var i=0;i<selectedObjects.length;++i){object=selectedObjects[i];CCRenderer.GLPushMatrix();CCRenderer.GLTranslate(object.position);CCRenderer.GLScale([object.collisionSize.width,object.collisionSize.height,1]);renderer.CCRenderCube(true);CCRenderer.GLPopMatrix()}}if(this.selectionBoxStart&&this.selectionBoxEnd){var selectionBoxStart=this.selectionBoxStart;var selectionBoxEnd=this.selectionBoxEnd;var size=vec3.clone(selectionBoxEnd);vec3.subtract(size,selectionBoxEnd,selectionBoxStart);var position=vec3.clone(selectionBoxStart);position[0]+=size[0]*.5;position[1]+=size[1]*.5;position[2]+=size[2]*.5;gEngine.textureManager.setTextureIndex(1);renderer.CCSetColour(gColour.setRGBA(1,0,0,.5));CCRenderer.GLPushMatrix();CCRenderer.GLTranslate(position);CCRenderer.GLScale([size[0],size[1],1]);renderer.CCRenderCube(true);CCRenderer.GLPopMatrix()}}}};SceneUIEditor.prototype.updateControls=function(controls){var usingControls=this.CCSceneAppUI_updateControls(controls);return usingControls};SceneUIEditor.prototype.handleTwoTouches=function(touch1,touch2){return false};SceneUIEditor.prototype.touchPressed=function(touch){var camera=this.camera;var hitLocation,projectionResults,offset,i;if(this.sceneUI.enableSelectionBox){if(camera.project3D(touch.x,touch.y)){hitLocation=vec3.create();projectionResults=camera.projectionResults;offset=projectionResults.vNear[2]/Math.abs(projectionResults.vDirection[2]);vec3.scale(hitLocation,projectionResults.vDirection,offset);vec3.add(hitLocation,hitLocation,projectionResults.vNear);this.selectionBoxStart=hitLocation}}else{var result=this.handleTilesTouch(touch,CCControls.touch_pressed);if(result===CCSceneAppUI.tile_touchAction){return true}else{var selectedObjects=this.selectedObjects;if(selectedObjects.length>0){if(camera.project3D(touch.x,touch.y)){hitLocation=vec3.create();projectionResults=camera.projectionResults;offset=projectionResults.vNear[2]/Math.abs(projectionResults.vDirection[2]);vec3.scale(hitLocation,projectionResults.vDirection,offset);vec3.add(hitLocation,hitLocation,projectionResults.vNear);for(i=0;i<selectedObjects.length;++i){var object=selectedObjects[i];CC.UpdateCollisions(object);if(CC.BasicBoxCollisionCheck(object.aabbMin,object.aabbMax,hitLocation,hitLocation)){this.touchPressedStartLocation=hitLocation;return true}}}}}}return true};SceneUIEditor.prototype.touchMoving=function(touch,touchDelta){var camera=this.camera;var hitLocation,projectionResults,offset;var allowCameraMovement=true;if(this.sceneUI.enableSelectionBox){allowCameraMovement=false;if(camera.project3D(touch.x,touch.y)){hitLocation=this.selectionBoxEnd?this.selectionBoxEnd:vec3.create();projectionResults=camera.projectionResults;offset=projectionResults.vNear[2]/Math.abs(projectionResults.vDirection[2]);vec3.scale(hitLocation,projectionResults.vDirection,offset);vec3.add(hitLocation,hitLocation,projectionResults.vNear);this.selectionBoxEnd=hitLocation;gRenderer.pendingRender=true;return true}}else if(this.touchPressedStartLocation){allowCameraMovement=false;if(camera.project3D(touch.x,touch.y)){hitLocation=vec3.create();projectionResults=camera.projectionResults;offset=projectionResults.vNear[2]/Math.abs(projectionResults.vDirection[2]);vec3.scale(hitLocation,projectionResults.vDirection,offset);vec3.add(hitLocation,hitLocation,projectionResults.vNear);var movement=vec3.clone(hitLocation);vec3.subtract(movement,movement,this.touchPressedStartLocation);var i,object;if(this.touchPressedResizing){this.objectResizingMove(hitLocation,movement)}else{this.movingObjects=true;var selectedObjects=this.selectedObjects;for(i=0;i<selectedObjects.length;++i){object=selectedObjects[i];object.translate(movement[0],movement[1],movement[2])}this.objectResized()}this.touchPressedStartLocation=hitLocation;return true}}else{var result=this.handleTilesTouch(touch,this.controlsMovingVertical?CCControls.touch_movingVertical:CCControls.touch_movingHorizontal);if(result===CCSceneAppUI.tile_touchAction){return true}}if(allowCameraMovement){return this.touchCameraMoving(touchDelta.x,touchDelta.y)}return false};SceneUIEditor.prototype.touchReleased=function(touch,touchAction){var usingControls=false;if(this.touchPressedStartLocation){delete this.touchPressedStartLocation}if(this.sceneUI.enableSelectionBox){usingControls=this.handleSelectionBox(touch)}else if(this.movingObjects){usingControls=true;delete this.movingObjects;this.manager.objectsMoved();this.selectedObjectsUpdated()}else if(this.sceneUI.creatingObjects){usingControls=this.handleCreatingObjects(touch);this.sceneUI.handleCreateButton()}else{var result=this.handleTilesTouch(touch,touchAction);usingControls=result===CCSceneAppUI.tile_touchAction;if(!usingControls&&touchAction>=CCControls.touch_released){if(this.oneTouchDoubleTapped){}else if(this.controlsMoving){if(this.touchPressedResizing){this.objectResizingEnd();usingControls=true}else{usingControls=this.touchReleaseSwipe(touch)}}else if(touchAction===CCControls.touch_released){if(!usingControls){usingControls=this.handleObjectSelection(touch)}}}}if(this.oneTouchDoubleTappedLastPress){this.oneTouchDoubleTappedLastPress=false}if(this.oneTouchDoubleTapped){this.oneTouchDoubleTappedLastPress=true;this.oneTouchDoubleTapped=false}return usingControls};SceneUIEditor.prototype.touchCameraMoving=function(x,y){return false};SceneUIEditor.prototype.touchReleaseSwipe=function(touch){return false};SceneUIEditor.prototype.selectedObjectsAdd=function(object){if(object){if(object.getMovementInterpolator()){object.getMovementInterpolator().finish()}if(this.selectedObjects.find(object)===-1){this.selectedObjects.add(object);this.selectedObjectsUpdated()}}};SceneUIEditor.prototype.selectedObjectsRemove=function(object){this.selectedObjects.remove(object);this.selectedObjectsUpdated()};SceneUIEditor.prototype.selectedObjectsClear=function(){this.selectedObjects.length=0;this.selectedObjectsUpdated()};SceneUIEditor.prototype.selectedObjectsCopy=function(){for(var i=0;i<this.selectedObjects.length;++i){var object=this.selectedObjects[i];var objectCopy=this.createObject(object.position,object.constructor.name);objectCopy.translate(this.camera.targetWidth*.05);objectCopy.setTileSize(object.collisionSize.width,object.collisionSize.height);var image=object.getTileTextureFilename();if(object.constructor.name==="TileSocialProfile"){}else if(object.constructor.name==="TileOverlay"){}else if(image){objectCopy.setTileTexture(image)}}};SceneUIEditor.prototype.selectedObjectsUpdated=function(){if(this.sceneUI){if(this.sceneUI.enableSelectionBox){this.sceneUI.handleSelectionButton()}var selectedObjects=this.selectedObjects;if(selectedObjects&&selectedObjects.length>0){this.sceneUI.objectEditorOpen(selectedObjects)}else{this.sceneUI.objectEditorClose()}this.objectResized()}};SceneUIEditor.prototype.handleSelectionBox=function(touch){var camera=this.camera;if(this.selectionBoxStart&&camera.project3D(touch.x,touch.y)){var hitLocation=vec3.create();var projectionResults=camera.projectionResults;var offset=projectionResults.vNear[2]/Math.abs(projectionResults.vDirection[2]);vec3.scale(hitLocation,projectionResults.vDirection,offset);vec3.add(hitLocation,hitLocation,projectionResults.vNear);var selectionBoxMin=this.selectionBoxStart;var selectionBoxMax=hitLocation;CC.CalculateMinMaxVectors(selectionBoxMin,selectionBoxMax);var selectedObjects=this.selectedObjects;selectedObjects.length=0;var objects=this.uiObjects;for(i=0;i<objects.length;++i){var object=objects[i];CC.UpdateCollisions(object);if(CC.BasicBoxCollisionCheck(object.aabbMin,object.aabbMax,selectionBoxMin,selectionBoxMax)){selectedObjects.add(object)}}this.selectedObjectsUpdated();delete this.selectionBoxStart;if(this.selectionBoxEnd){delete this.selectionBoxEnd}}return true};SceneUIEditor.prototype.handleObjectSelection=function(touch){if(this.sceneUI.creatingObjects){this.sceneUI.handleCreateButton()}if(!this.lastHitObjects){this.lastHitObjects=[]}else{if(CC.Distance(touch.x,this.lastHitX)>.05||CC.Distance(touch.y,this.lastHitY)>.05){if(this.lastHitObjects.length>0){this.lastHitObjects.length=0}}}this.lastHitX=touch.x;this.lastHitY=touch.y;var camera=this.camera;var hitObject=null;var hitLocation=vec3.create();if(camera.project3D(touch.x,touch.y)){var projectionResults=camera.projectionResults;var collideables=this.collideables;hitObject=CC.BasicLineCollisionCheck(collideables,projectionResults.vNear,projectionResults.vFar,hitLocation,true,CC.collision_box,this.lastHitObjects,false,true);if(hitObject){this.lastHitObjects.push(hitObject)}else if(this.lastHitObjects.length>0){this.lastHitObjects.length=0}}this.manager.objectSelected(hitObject,hitLocation);return!!hitObject};SceneUIEditor.prototype.handleCreatingObjects=function(touch){var camera=this.camera;var hitObject=null;var hitLocation=vec3.create();if(camera.project3D(touch.x,touch.y)){var projectionResults=camera.projectionResults;var offset=projectionResults.vNear[2]/Math.abs(projectionResults.vDirection[2]);vec3.scale(hitLocation,projectionResults.vDirection,offset);vec3.add(hitLocation,hitLocation,projectionResults.vNear);this.selectedObjectsClear();var object=this.createObject(hitLocation);this.selectedObjects.add(object);this.selectedObjectsUpdated()}return!hitObject};SceneUIEditor.prototype.createObject=function(position,type){if(!type||!window[type]){type="CCTile3DButton"}var tile=new window[type](this);if(type==="CCTile3DButton"){tile.setupTile(30)}else if(type==="TileOverlay"){tile.setupTexturedHeight(30);tile.aspectRatioLocked=true}else if(type==="TileSocialProfile"){tile.setTileSize(this.camera.targetHeight*.1);tile.aspectRatioLocked=true}this.uiObjects.add(tile);tile.setPositionXY(position[0],position[1]);this.updatedObject(tile);this.manager.objectCreated();return tile};SceneUIEditor.prototype.findObject=function(object){var camera=this.camera;camera.targetOffset[2]=camera.calcCameraOffsetForWidth(object.collisionSize.width*4);camera.targetOffset[2]=CC.FloatClamp(camera.targetOffset[2],this.minZoomOffset,this.maxZoomOffset);camera.targetLookAt[0]=object.position[0];camera.targetLookAt[2]=object.position[2];camera.flagUpdate()};SceneUIEditor.prototype.updatedObject=function(object){this.manager.objectUpdated();this.collideables.sort(function(a,b){return b.drawOrder-a.drawOrder});this.uiObjects.sort(function(a,b){return b.drawOrder-a.drawOrder});var camera=this.camera;var tile=object;if(tile.fullScreen){var image=tile.getTileTextureFilename();if(image){tile.setupTexturedFit(camera.targetWidth,camera.targetHeight,true,image)}else{tile.setTileSize(camera.targetWidth,camera.targetHeight)}}this.selectedObjectsUpdated()};SceneUIEditor.prototype.deleteObject=function(object){var uiObjects=this.uiObjects;for(var i=0;i<uiObjects.length;++i){if(uiObjects[i]===object){uiObjects.remove(object);this.tiles.remove(object);this.selectedObjectsRemove(object);object.deleteLater();this.manager.objectDeleted();break}}};SceneUIEditor.prototype.objectResizingBegin=function(tile,touch){var camera=this.camera;if(camera.project3D(touch.x,touch.y)){var hitLocation=vec3.create();var projectionResults=camera.projectionResults;var offset=projectionResults.vNear[2]/Math.abs(projectionResults.vDirection[2]);vec3.scale(hitLocation,projectionResults.vDirection,offset);vec3.add(hitLocation,hitLocation,projectionResults.vNear);this.touchPressedStartLocation=hitLocation;this.touchPressedResizing=tile}};SceneUIEditor.prototype.objectResizingMove=function(hitLocation,movement){this.touchPressedResizing.setPositionXY(hitLocation[0],hitLocation[1]);var selectedObjects=this.selectedObjects;if(selectedObjects.length>0){var tileObjectResizer=this.touchPressedResizing;var size;for(i=0;i<selectedObjects.length;++i){var object=selectedObjects[i];size=this.sceneUI.getResizerObjectSize(tileObjectResizer,object,movement);if(size<10){size=10}if(size>this.camera.targetWidth*1.5){size=this.camera.targetWidth*1.5}var aspectRatio=object.collisionSize.height/object.collisionSize.width;if(tileObjectResizer===this.sceneUI.tileObjectResizer[0]||tileObjectResizer===this.sceneUI.tileObjectResizer[4]){object.setTileSize(object.aspectRatioLocked?size/aspectRatio:object.collisionSize.width,size)}else if(tileObjectResizer===this.sceneUI.tileObjectResizer[2]||tileObjectResizer===this.sceneUI.tileObjectResizer[6]){object.setTileSize(size,object.aspectRatioLocked?size*aspectRatio:object.collisionSize.height)}else{object.setTileSize(size,size*aspectRatio)}}}this.objectResized()};SceneUIEditor.prototype.objectResized=function(){this.sceneUI.hideResizers();if(this.sceneUI&&this.sceneUI.enableObjectResizing){var selectedObjects=this.selectedObjects;for(var i=0;i<selectedObjects.length;++i){var object=selectedObjects[i];if(!object.fullScreen){this.sceneUI.setResizersAroundObject(object);break}}}};SceneUIEditor.prototype.objectResizingEnd=function(){delete this.touchPressedResizing;delete this.touchPressedStartLocation;this.refreshCameraView();this.manager.objectsResized();this.selectedObjectsUpdated()};SceneUIEditor.prototype.startJS=function(){this.js="";this.jsIndent=0};SceneUIEditor.prototype.endJS=function(){var js=this.js;delete this.js;delete this.jsIndent;return js};SceneUIEditor.prototype.addJS=function(js){if(!js){js=""}else{if(js==="}"||js==="};"){this.jsIndent--}for(var i=0;i<this.jsIndent;++i){this.js+="	"}if(js==="{"){this.jsIndent++}}this.js+=js+"\n"};SceneUIEditor.prototype.validateJS=function(js){var validatedJS="";var openSplit=js.split("(");if(openSplit.length>1){validatedJS=openSplit[0];var closeSplit=openSplit[1].split(")");if(closeSplit.length>0){var parameters=closeSplit[0];parameters=parameters.formatSpacesAndTabs();if(parameters.length>0){var openDoubleQuote=-1;var openSingleQuote=-1;for(var i=0;i<parameters.length;++i){var character=parameters[i];if(character==='"'){if(openDoubleQuote!==-1){if(openDoubleQuote<openSingleQuote){openSingleQuote=-1}openDoubleQuote=-1}else{openDoubleQuote=i}}else if(character==="'"){if(openSingleQuote!==-1){if(openSingleQuote<openDoubleQuote){openDoubleQuote=-1}openSingleQuote=-1}else{openSingleQuote=i}}}if(openDoubleQuote!==-1&&openSingleQuote!==-1){if(openDoubleQuote>openSingleQuote){openDoubleQuote=false}else{openSingleQuote=false}}if(openDoubleQuote!==-1){parameters+='"'}else if(openSingleQuote!==-1){parameters+="'"}}validatedJS+="( ";validatedJS+=parameters;validatedJS+=" )"}else{validatedJS+="()"}}return validatedJS};SceneUIEditor.prototype.exportJS=function(){var i;this.startJS();this.addJS("// This function will be overritten if modified by the UI Editor");this.addJS("function "+this.info.name+"(parentScene)");this.addJS("{");this.addJS("this.jsSyncReCreate = true;    // Tell our engine that it's ok to reset this class if it's JS code is updated");this.addJS("this.construct();");this.addJS("this.cameraCentered = true;");this.addJS("this.cameraReletivePositions = true;");this.addJS("gEngine.addScene( this );");this.addJS("");this.addJS("if( parentScene )");this.addJS("{");this.addJS("this.setParent( parentScene );         // Tell our parent when this class is deleted");this.addJS("this.parentScene.linkScene( this );    // Tell our parent to delete this class when it is deleted");this.addJS("}");this.addJS("}");this.addJS("ExtendPrototype( "+this.info.name+", CCSceneAppUI );");this.addJS();this.addJS();this.addJS("// This function can be tweaked, however aggressive changes will be overriten if modified by the UI Editor.");this.addJS(this.info.name+".prototype.setup = function()");this.addJS("{");this.addJS("var self = this;");this.addJS();this.addJS("this.CCSceneAppUI_setup();");this.addJS();this.addJS("var tile;");this.addJS();var uiObjects=this.uiObjects;var tile,image;var cachedImages=[];for(i=uiObjects.length-1;i>=0;--i){tile=uiObjects[i];if(tile.constructor.name==="TileSocialProfile"){continue}var textureHandle=tile.getTileTextureHandle();if(textureHandle&&textureHandle.image){if(!textureHandle.src.contains("/resources/")){if(cachedImages.length===0){this.addJS("// Load images in back to front order")}if(cachedImages.find(textureHandle.filename)===-1){cachedImages.push(textureHandle.filename);this.addJS('gEngine.textureManager.getTextureHandle( "'+textureHandle.filename+'" );')}}}}if(cachedImages.length>0){this.addJS()}this.addJS("this.uiObjects = [];");for(i=0;i<uiObjects.length;++i){tile=uiObjects[i];this.addJS("{");this.addJS("tile = new "+tile.constructor.name+"( this );");if(tile.name){this.addJS("this."+tile.name+" = tile;")}this.addJS("this.uiObjects.push( tile );");if(tile.drawOrder!==100){this.addJS("tile.setDrawOrder( "+tile.drawOrder+" );")}this.addJS("tile.setTileSize( "+tile.collisionSize.width+", "+tile.collisionSize.height+" );");this.addJS("this.setReletiveX( tile, "+this.getReletiveX(tile)+" );");this.addJS("this.setReletiveY( tile, "+this.getReletiveY(tile)+" );");image=tile.getTileTextureFilename();if(tile.constructor.name==="TileSocialProfile"){}else if(tile.constructor.name==="TileOverlay"){}else if(image){this.addJS();this.addJS('tile.setTileTexture( "'+image+'" );')}this.addJS();this.addJS('tile.setColour( gColour.fromString( "'+tile.colour.toString()+'" ) );');if(tile.isBlinking()){this.addJS("tile.setBlinking( true );")}if(tile.aspectRatioLocked){this.addJS();this.addJS("tile.aspectRatioLocked = true;")}if(tile.fullScreen){this.addJS("tile.fullScreen = true;")}if(tile.flippedX){this.addJS();this.addJS("tile.flipTileX();")}if(tile.flippedY){this.addJS();this.addJS("tile.flipTileY();")}if(tile.rotation[2]!==0){this.addJS();this.addJS("tile.setRotationZ( "+tile.rotation[2]+" );")}var text=tile.getText();if(text){this.addJS();var textScale=tile.textScale;if(textScale!==undefined){this.addJS("tile.setTextScale( "+textScale+" );")}this.addJS('tile.setText( "'+text+'" );');this.addJS('tile.setTextColour( gColour.fromString( "'+tile.textObject.colour.toString()+'" ) );');if(tile.isTextBlinking()){this.addJS("tile.setTextBlinking( true );")}}if(tile.get3DModelFilename()){this.addJS();this.addJS('tile.set3DModel( "'+tile.get3DModelFilename()+'", "'+tile.get3DModelTextureFilename()+'" );');if(tile.model3dObject.colour){if(!gColour.white().equals(tile.model3dObject.colour)){this.addJS('tile.model3dObject.setColour( gColour.fromString( "'+tile.model3dObject.colour.toString()+'" ) );')}}if(tile.model3dAnimationSpeed){this.addJS("tile.set3DModelAnimationSpeed( "+tile.model3dAnimationSpeed+" );")}if(!vec3.isZero(tile.model3dObject.rotation)){this.addJS('tile.set3DModelRotation( "'+vec3.toString(tile.model3dObject.rotation)+'" );')}}if(tile.onPress.length>0||tile.onRelease.length>0||tile.onLoss.length>0){this.addJS();if(tile.onPress.length>0){this.addJS("tile.onPress.push( function() { "+tile.onPress[0]+"; } );")}if(tile.onRelease.length>0){this.addJS("tile.onRelease.push( function() { "+tile.onRelease[0]+"; } );")}if(tile.onLoss.length>0){this.addJS("tile.onLoss.push( function() { "+tile.onLoss[0]+"; } );")}this.addJS("this.addTile( tile );")}this.addJS("}");this.addJS()}this.addJS("if( this.setupFinish )");this.addJS("{");this.addJS("// Custom setup should be written into a setupFinish function");this.addJS("this.setupFinish();");this.addJS("}");this.addJS();this.addJS("this.requestResize();");this.addJS("};");this.addJS();this.addJS();this.addJS("// This function will be overritten if modified by the UI Editor");this.addJS(this.info.name+".prototype.resize = function()");this.addJS("{");this.addJS("var self = this;");this.addJS("this.CCSceneAppUI_resize();");this.addJS("var camera = this.camera;");this.addJS();this.addJS("var tile;");for(i=0;i<uiObjects.length;++i){tile=uiObjects[i];if(tile.fullScreen){this.addJS("{");this.addJS("tile = this.uiObjects["+i+"];");image=tile.getTileTextureFilename();if(image){this.addJS('tile.setupTexturedFit( camera.targetWidth, camera.targetHeight, true, "'+image+'" );')}else{this.addJS("tile.setTileSize( camera.targetWidth, camera.targetHeight );")}this.addJS("}")}}this.addJS("};");this.addJS();this.addJS();this.addJS("// This function will be overritten if modified by the UI Editor");this.addJS(this.info.name+".prototype.touchCameraMoving = function()");this.addJS("{");this.addJS("return false;");this.addJS("};");this.addJS("");this.addJS("");this.addJS("// While it is recommended to write new functions for this class in a new file,");this.js+=this.customJSMarker;if(this.customJS){this.js+=this.customJS}if(window.console&&console.log){console.log(this.js)}return this.endJS()};SceneUIEditor.prototype.loadJS=function(js){var jsLines=js.split("\n");var line,formattedLine;var tile,parameters,i;for(i=0;i<jsLines.length;++i){line=jsLines[i];line=line.formatSpacesAndTabs();if(line.startsWith("if( this.setupFinish )")){tile=null;break}if(line.startsWith("tile")){if(line.startsWith("tile = new TileOverlay")){tile=new TileOverlay(this);tile.setupTile(30);this.uiObjects.add(tile)}else if(line.startsWith("tile = new TileSocialProfile")){tile=new TileSocialProfile(this);this.uiObjects.add(tile)}else if(line.startsWith("tile = new CCTile3DButton")){tile=new CCTile3DButton(this);tile.setupTile(30);this.uiObjects.add(tile)}else if(line.startsWith("tile.setTileSize")||line.startsWith("tile.setPositionXY")||line.startsWith("tile.setTextScale")||line.startsWith("tile.setColour")||line.startsWith("tile.setBlinking")||line.startsWith("tile.setText")||line.startsWith("tile.setTextColour")||line.startsWith("tile.setTextBlinking")||line.startsWith("tile.setTileTexture")||line.startsWith("tile.aspectRatioLocked")||line.startsWith("tile.flipTileX")||line.startsWith("tile.flipTileY")||line.startsWith("tile.setRotationZ")||line.startsWith("tile.setDrawOrder")||line.startsWith("tile.set3DModel")||line.startsWith("tile.model3dObject.setColour")){try{eval(line)}catch(e){if(window.console&&console.log){console.log(e)}}}else if(line.startsWith("tile.fullScreen")){tile.fullScreen=true;var image=tile.getTileTextureFilename();if(image){tile.setupTexturedFit(this.camera.targetWidth,this.camera.targetHeight,true,image)}else{tile.setTileSize(this.camera.targetWidth,this.camera.targetHeight)}}else if(line.startsWith("tile.onPress")||line.startsWith("tile.onRelease")||line.startsWith("tile.onLoss")){if(tile){formattedLine=String.SplitBetween(line,"{","}");formattedLine=formattedLine.formatSpacesAndTabs();if(formattedLine.length>0){if(formattedLine[formattedLine.length-1]===";"){formattedLine=formattedLine.substring(0,formattedLine.length-1)}}if(line.startsWith("tile.onPress")){tile.onPress.push(formattedLine)}else if(line.startsWith("tile.onRelease")){tile.onRelease.push(formattedLine)}else if(line.startsWith("tile.onLoss")){tile.onLoss.push(formattedLine)}}}}else if(line.startsWith("this.")){if(line.startsWith("this.setReletive")){if(tile){try{eval(line)}catch(e){if(window.console&&console.log){console.log(e)}}}}else if(line.contains("= tile;")){if(tile){formattedLine=String.SplitBetween(line,"this.","=");formattedLine=formattedLine.formatSpacesAndTabs();tile.name=formattedLine}}}}var customJSSplit=js.split(this.customJSMarker);if(customJSSplit.length>1){this.customJS=customJSSplit[1];for(i=2;i<customJSSplit.length;++i){this.customJS+=this.customJSMarker;this.customJS+=customJSSplit[i]}}return true};SceneUIEditor.prototype.onKeyboard=function(event,key,pressed){if(event.metaKey){return false}if(event.ctrlKey){return false}if(pressed){var selectedObjects=this.selectedObjects;if(selectedObjects.length>0){{var x=0;var y=0;if(key==="up"){y=1}else if(key==="down"){y=-1}else if(key==="left"){x=-1}else if(key==="right"){x=1}if(x!==0||y!==0){var i;var object;if(event.shiftKey){var size;for(i=0;i<selectedObjects.length;++i){object=selectedObjects[i];var aspectRatio=object.collisionSize.height/object.collisionSize.width;if(y!==0){size=object.collisionBounds[1]*2+y*2;object.setTileSize(object.aspectRatioLocked?size/aspectRatio:object.collisionSize.width,size)}else{size=object.collisionBounds[0]*2+x*2;object.setTileSize(size,object.aspectRatioLocked?size*aspectRatio:object.collisionSize.height)}this.objectResized()}}else{for(i=0;i<selectedObjects.length;++i){object=selectedObjects[i];this.setReletiveX(object,Math.round(this.getReletiveX(object)*100+x)/100);
this.setReletiveY(object,Math.round(this.getReletiveY(object)*100+y)/100)}this.manager.objectsMoved();this.selectedObjectsUpdated()}}}}}return false};function SceneManagerList(parentScene){this.construct();parentScene.linkScene(this);this.setParent(parentScene)}ExtendPrototype(SceneManagerList,CCSceneAppUI);SceneManagerList.prototype.construct=function(){MultiplayerManager.UpdateCallbacks.addOnce(this);this.CCSceneAppUI_construct();{var parentCameraIndex=gEngine.findCameraIndex(this.parentScene.camera);var camera=gEngine.newSceneCamera(this,parentCameraIndex+1);camera.setupViewport(0,0,1,1)}var self=this;this.sceneUIBack=new SceneUIBack(this,function(){self.parentScene.close()},true)};SceneManagerList.prototype.deleteLater=function(){if(this.sceneUIBack){this.sceneUIBack.close();this.sceneUIBack=null}this.CCSceneAppUI_deleteLater()};SceneManagerList.prototype.setup=function(){var self=this;var camera=this.camera;camera.setCameraWidth(640,false);var tile;{tile=new CCTile3DButton(this);tile.setupTile(camera.targetWidth,camera.targetHeight);tile.setColour(gColour.set(.25,0));tile.setColourAlpha(.9,true);tile.setDrawOrder(203);this.cameraStickyTiles.add(tile);this.tileBackground=tile}this.tileLists=[]};SceneManagerList.prototype.syncUpdate=function(jsonData){};SceneManagerList.prototype.updateCamera=function(delta){return this.CCSceneAppUI_updateCamera(delta)};SceneManagerList.prototype.render=function(camera,pass,alpha){this.CCSceneAppUI_render(camera,pass,alpha)};SceneManagerList.prototype.resize=function(){this.CCSceneAppUI_resize();var camera=this.camera;var tile;{tile=this.tileBackground;tile.setTileSize(camera.targetWidth,camera.targetHeight)}var y;var tileLists=this.tileLists;for(var i=0;i<tileLists.length;++i){var tileList=tileLists[i];var title=tileList.title;var list=tileList.list;if(i===0){tile=title;tile.setTextHeight(camera.targetHeight*.055,true);y=tile.getTileMovementTarget()[1]-tile.collisionBounds[1];this.listTiles(list,y)}else{tile=this.tileLists[i-1].list.last();if(!tile){tile=title}y=tile.getTileMovementTarget()[1]-tile.collisionBounds[1];tile=title;tile.setTextHeight(camera.targetHeight*.055,true);y-=tile.collisionBounds[1];y-=tile.collisionSize.height;tile.setPositionY(y);y=tile.getTileMovementTarget()[1]-tile.collisionBounds[1];this.listTiles(list,y)}}};SceneManagerList.prototype.listTiles=function(tiles,y){var camera=this.camera;var columns=3;var sideSpacing=camera.targetWidth*.1;var tileSpacing=camera.targetWidth*.025;var tileWidth=(camera.targetWidth-tileSpacing*(columns-1)-sideSpacing*2)/columns;var tileHeight=tileWidth*.5;var hTileWidth=tileWidth*.5;var hTileHeight=tileHeight*.5;var x=-(camera.targetWidth*.5)+sideSpacing+hTileWidth;y-=(tileHeight+tileSpacing)*.5;var columnIndex=0;for(i=0;i<tiles.length;++i){var tile=tiles[i];tile.setTileSize(tileWidth,tileHeight);tile.setTextHeight(tileHeight*.25);tile.setPositionXYZ(x,y,0);x+=tileWidth+tileSpacing;columnIndex++;if(columnIndex>=columns){columnIndex=0;x=-(camera.targetWidth*.5)+sideSpacing+hTileWidth;y-=tileHeight+tileSpacing}}};SceneManagerList.prototype.updateControls=function(controls){var usingControls=this.CCSceneAppUI_updateControls(controls);var cameraTouches=this.camera.cameraTouches;var touch=cameraTouches[0];if(touch.x>0&&touch.x<1&&touch.y>0&&touch.y<1&&touch.startX>0&&touch.startX<1&&touch.startY>0&&touch.startY<1){if(controls.wheel&&controls.wheel.delta!==0){var delta=controls.wheel.delta;this.cameraScrolling=true;this.controlsMovingVertical=true;this.touchCameraMoving(0,delta*.1);return true}}return usingControls};SceneManagerList.prototype.touchPressed=function(touch){if(this.CCSceneAppUI_touchPressed(touch)){return true}return false};SceneManagerList.prototype.touchMovementAllowed=function(touch,touchDelta){var absDeltaX=Math.abs(touch.totalDeltaX);var absDeltaY=Math.abs(touch.totalDeltaY);if(absDeltaX>CCControls.TouchMovementThreashold.x||absDeltaY>CCControls.TouchMovementThreashold.y){this.controlsMoving=true;touchDelta.x+=touch.totalDeltaX;touchDelta.y+=touch.totalDeltaY;this.controlsMovingVertical=true;return true}return false};SceneManagerList.prototype.touchMoving=function(touch,touchDelta){return this.CCSceneAppUI_touchMoving(touch,touchDelta)};SceneManagerList.prototype.touchReleased=function(touch,touchAction){return this.CCSceneAppUI_touchReleased(touch,touchAction)};SceneManagerList.prototype.refreshCameraView=function(){this.sceneLeft=0;this.sceneRight=0;this.sceneTop=0;this.sceneBottom=0;var tiles=this.tiles;var tile=tiles.first();if(tile){this.sceneTop=tile.getTileMovementTarget()[1]+tile.collisionBounds[1];if(this.sceneTop<this.sceneBottom){this.sceneTop=this.sceneBottom}this.sceneTop+=tile.collisionSize.height;this.sceneTop-=this.camera.cameraHeight*.5}var bottomTile;for(var i=0;i<tiles.length;++i){tile=tiles[i];if(!bottomTile||tile.getTileMovementTarget()[1]<bottomTile.getTileMovementTarget()[1]){bottomTile=tile}}if(bottomTile){this.sceneBottom=bottomTile.getTileMovementTarget()[1]-bottomTile.collisionBounds[1];if(this.sceneBottom>this.sceneTop){this.sceneBottom=this.sceneTop}}};SceneManagerList.prototype.lockCameraView=function(){if(this.cameraScrolling){return}var camera=this.camera;camera.flagUpdate();camera.targetLookAt[0]=0;if(camera.targetLookAt[1]>this.sceneTop){camera.targetLookAt[1]=this.sceneTop}else if(camera.targetLookAt[1]<this.sceneBottom){camera.targetLookAt[1]=this.sceneBottom}};SceneManagerList.prototype.addList=function(name,colour){var tileList={};var tile=new CCTile3DButton(this);tile.setupText(name,1,true,false);tile.setTextColour(colour);tile.setDrawOrder(204);this.tilePublic=tile;this.addTile(tile);tile.setTouchDepressDepth(0);tileList.title=tile;tileList.list=[];this.tileLists.push(tileList)};function SceneMapsManagerList(parentScene){parentScene.linkScene(this);this.setParent(parentScene);this.construct();gEngine.addScene(this)}ExtendPrototype(SceneMapsManagerList,SceneManagerList);SceneMapsManagerList.prototype.deleteLater=function(){if(this.syncingUpdates){MultiplayerManager.Emit("EditorMapsUnregisterListUpdates");this.syncingUpdates=false}this.SceneManagerList_deleteLater()};SceneMapsManagerList.prototype.setup=function(){this.SceneManagerList_setup();this.maps=[];this.addList("Your Public Levels",EditorManager.LightGreen);this.addList("Your Private Levels",EditorManager.LightRed);var self=this;CCFileManager.Load("SceneMapsManagerList.db",function(data){if(data){if(!self.loaded){var list=JSON.parse(data);self.show(list)}}});if(MultiplayerManager.Emit("EditorMapsRequestList")){this.syncingUpdates=true}};SceneMapsManagerList.prototype.syncUpdate=function(jsonData){var publicTiles=this.tileLists[0].list;var privateTiles=this.tileLists[1].list;var map,i,tile,tileText;if(jsonData.EditorMaps){var list=jsonData.EditorMaps;this.show(list);CCFileManager.Save("SceneMapsManagerList.db",list);if(!this.loaded){this.loaded=true}}else if(jsonData.EditorMapsListUpdated){map=jsonData.EditorMapsListUpdated;mapID=map.mapID;var mapTile;for(i=0;i<privateTiles.length;++i){tile=privateTiles[i];if(mapID===tile.mapID){mapTile=tile;break}}if(!mapTile){for(i=0;i<publicTiles.length;++i){tile=publicTiles[i];if(mapID===tile.mapID){mapTile=tile;break}}}if(mapTile){tileText=map.name;tileText+="\nid:"+map.mapID;tileText+="\n Players:";tileText+=map.players;tileText+=" Objects:";tileText+=map.objects;mapTile.setText(tileText)}}};SceneMapsManagerList.prototype.show=function(list){var self=this;var publicTiles=this.tileLists[0].list;var privateTiles=this.tileLists[1].list;var map,i,tile,tileText;var EnterMapFunction=function(mapID){return function(){self.parentScene.enterMap(mapID)}};var tiles=this.tiles;{for(i=0;i<privateTiles.length;++i){tile=privateTiles[i];tiles.remove(tile);tile.deleteLater()}privateTiles.length=0}{for(i=0;i<publicTiles.length;++i){tile=publicTiles[i];tiles.remove(tile);tile.deleteLater()}publicTiles.length=0}for(i=0;i<list.length;++i){map=list[i];tileText=map.name;tileText+="\nid:"+map.mapID;tileText+="\n Players:";tileText+=map.players;tileText+=" Objects:";tileText+=map.objects;tile=new CCTile3DButton(this);tile.setupText(tileText,1,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setTextColour(gColour.set(0,1));if(map.open){tile.setColour(EditorManager.LightGreen)}else{tile.setColour(EditorManager.LightRed)}tile.setDrawOrder(205);tile.onRelease.push(new EnterMapFunction(map.mapID));this.addTile(tile);if(map.open){publicTiles.add(tile)}else{privateTiles.add(tile)}tile.mapID=map.mapID}{tile=new CCTile3DButton(this);tile.setupText("+",1,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setTextColour(gColour.set(.125,1));tile.setColour(gColour.set(.5,.9));tile.setDrawOrder(205);tile.onRelease.push(function(){self.parentScene.newMap(true)});this.addTile(tile);publicTiles.add(tile)}{tile=new CCTile3DButton(this);tile.setupText("+",1,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setTextColour(gColour.set(0,1));tile.setColour(gColour.set(.5,.9));tile.setDrawOrder(205);tile.onRelease.push(function(){self.parentScene.newMap(false)});this.addTile(tile);privateTiles.add(tile)}this.requestResize()};function SceneMapsManager(){this.construct()}ExtendPrototype(SceneMapsManager,SceneManagerPlay);SceneMapsManager.prototype.construct=function(){this.SceneManagerPlay_construct();this.syncDisconnected()};SceneMapsManager.prototype.destruct=function(){this.SceneManagerPlay_destruct()};SceneMapsManager.prototype.deleteLater=function(){CC.RemoveJSLocationBarData("SceneMapsManager");this.SceneManagerPlay_deleteLater()};SceneMapsManager.prototype.setup=function(){this.SceneManagerPlay_setup()};SceneMapsManager.prototype.updateScene=function(delta){return this.SceneManagerPlay_updateScene(delta)};SceneMapsManager.prototype.syncDisconnected=function(){AlertsManager.ModalAlert("connecting...")};SceneMapsManager.prototype.syncLoggedIn=function(){this.SceneManagerPlay_syncLoggedIn();AlertsManager.Hide("connecting...",2);if(this.map){this.map.deleteLater();this.map=null}var mapsManagerSettings=CC.GetJSLocationBarData("SceneMapsManager");if(mapsManagerSettings&&mapsManagerSettings!=="menu"){this.enterMap(mapsManagerSettings)}else{this.openMapsList()}};SceneMapsManager.prototype.syncUpdate=function(jsonData){this.SceneManagerPlay_syncUpdate(jsonData);var map,mapID;if(jsonData.EditorEnteredMap){map=jsonData.EditorEnteredMap;this.enteredMap(map)}else if(jsonData.EditorCopiedMap){mapID=jsonData.EditorCopiedMap;AlertsManager.Hide("creating copy...");if(this.map){this.map.deleteLater();this.map=null}this.enterMap(mapID)}else if(jsonData.EditorDeletedMap){mapID=jsonData.EditorDeletedMap;AlertsManager.Hide("deleting...");this.handleBackButton()}else if(jsonData.EditorSelectObject){var objectID=jsonData.EditorSelectObject;if(this.map){var object=this.map.getStaticObject(objectID);if(object){this.map.selectedObjectsAdd(object)}}}};SceneMapsManager.prototype.openMapsList=function(){CC.SetJSLocationBarData("SceneMapsManager","menu");if(this.sceneMapsList){this.closeMapsList()}if(MultiplayerManager.LoggedIn){this.sceneMapsList=new SceneMapsManagerList(this)}};SceneMapsManager.prototype.closeMapsList=function(){if(this.sceneMapsList){this.sceneMapsList.deleteLater();this.sceneMapsList=null}};SceneMapsManager.prototype.newMap=function(open){if(MultiplayerManager.Emit("EditorMapNew",open)){AlertsManager.ModalAlert("loading...")}};SceneMapsManager.prototype.enterMap=function(mapID){if(MultiplayerManager.Emit("EditorMapEnter",mapID)){AlertsManager.ModalAlert("loading...")}};SceneMapsManager.prototype.enteredMap=function(mapData){CC.SetJSLocationBarData("SceneMapsManager",mapData.loadGame);AlertsManager.Hide("loading...");if(this.map){this.map.deleteLater();this.map=null}this.map=new SceneMapEditor(mapData.loadGame,this,mapData);this.closeMapsList()};SceneMapsManager.prototype.onDragDrop=function(files,event){if(event&&event.target){if(MultiplayerManager.LoggedIn){if(this.map){var self=this;var i,filename,fileExtension;var isJS=true;for(i=0;i<files.length;++i){filename=files[i].name;fileExtension=filename.getExtension();if(fileExtension!=="js"){isJS=false;break}}if(isJS){this.map.sceneUI.openJSMapEditor(function(result,js){if(result){MultiplayerManager.Emit("EditorJS",js)}if(self.map){self.map.sceneUI.showMenu()}});return}if(!this.map.sceneUI.sceneAssetEditor){var openModelCreator=false;if(this.map.selectedObjects.length>0){for(i=0;i<this.map.selectedObjects.length;++i){if(this.map.selectedObjects[i]!==this.map.ground){openModelCreator=true}}}else if(this.map.sceneUI.creatingObjects){openModelCreator=true}else{for(i=0;i<files.length;++i){filename=files[i].name;fileExtension=filename.getExtension();if(fileExtension==="obj"||fileExtension==="fbx"||fileExtension==="fbxi"){openModelCreator=true;break}}}if(openModelCreator){if(!this.map.sceneUI.creatingObjects){this.map.sceneUI.handleCreateButton()}var OnCreatedFunction=function(modelInfo){if(modelInfo){self.modelCreated(modelInfo)}};if(this.map.selectedObjects.length>0){var object=this.map.selectedObjects[0];var modelID=object.modelID;this.map.sceneUI.findAndSelectModelID(modelID,function(result){if(result){var modelInfo=self.map.sceneUI.getSelectedModel();self.map.sceneUI.openAssetEditor("Edit Model",true,false,OnCreatedFunction);self.map.sceneUI.sceneAssetEditor.setModel(modelInfo)}else{self.map.sceneUI.openAssetEditor("Create Model",true,false,OnCreatedFunction);self.map.sceneUI.sceneAssetEditor.setAsset(object.obj);self.map.sceneUI.sceneAssetEditor.setAsset(object.tex)}})}else{this.map.sceneUI.openAssetEditor("Create Model",true,false,OnCreatedFunction)}}else{this.map.sceneUI.openAssetEditor("Upload Map Texture",false,false,function(tex){if(tex){self.handleEditMapTexture(tex)}})}}}}}};SceneMapsManager.prototype.handleBackButton=function(){if(this.map){this.map.deleteLater();this.map=null;this.openMapsList();MultiplayerManager.Emit("EditorMapExit")}return true};SceneMapsManager.prototype.handleDeleteMap=function(){if(this.map){if(MultiplayerManager.LoggedIn){var self=this;AlertsManager.ConfirmationAlert("Delete map?",function(result){if(result){if(MultiplayerManager.Emit("EditorMapDelete")){AlertsManager.Hide("deleting...")}}})}}};SceneMapsManager.prototype.handleEditName=function(){if(this.map){if(MultiplayerManager.LoggedIn){var self=this;var map=this.map;AlertsManager.InputAlert(map.sceneUI.tileMapName.getText(),function(result){if(result){if(self.map.name!==result){if(MultiplayerManager.Emit("EditorMapEditName",result)){map.name=result;map.sceneUI.setupMenu(self.map.mapID,self.map.name,open)}}}},{space:true})}}};SceneMapsManager.prototype.handleEditPrivacy=function(){if(this.map){if(MultiplayerManager.LoggedIn){var self=this;var map=this.map;var open=map.open;AlertsManager.ConfirmationAlert(open?"Make private?":"Make public?",function(result){if(result){if(MultiplayerManager.Emit("EditorMapEditPrivacy",!open)){open=!open;map.sceneUI.setupMenu(self.map.mapID,self.map.name,open)}}})}}};SceneMapsManager.prototype.handleCopyButton=function(){if(this.map){if(MultiplayerManager.Emit("EditorMapCopy")){AlertsManager.ModalAlert("creating copy...")}}return true};SceneMapsManager.prototype.handleEditMapTexture=function(filename){if(filename){var fileExtension=filename.getExtension();if(fileExtension==="png"||fileExtension==="jpg"){MultiplayerManager.Emit("EditorMapTexture",filename)}}};SceneMapsManager.prototype.objectSelected=function(hitObject,location){var map=this.map;var selectedObjects=map.selectedObjects;var i;var reselectedObject=false;for(i=0;i<selectedObjects.length;++i){if(hitObject===selectedObjects[i]){reselectedObject=true;break}}if(reselectedObject){if(selectedObjects.length===1){if(map.sceneUI.creatingObjects){map.sceneUI.handleCreateButton()}else{map.selectedObjectsClear()}}else{map.selectedObjectsClear();map.selectedObjectsAdd(hitObject)}}else{var containsPlayers=selectedObjects.length>0;for(i=0;i<selectedObjects.length;++i){if(!selectedObjects[i].playerID){containsPlayers=false;break}}if(!containsPlayers){map.selectedObjectsClear();if(hitObject){if(hitObject.playerID){if(map.sceneUI.creatingObjects){map.sceneUI.handleCreateButton()}}map.selectedObjectsAdd(hitObject)}}else{var player;if(hitObject){if(hitObject.playerID){for(i=0;i<selectedObjects.length;++i){player=selectedObjects[i];if(player.playerID){MultiplayerManager.Emit("EditorShootAt",player.playerID,hitObject.playerID)}}}else{map.selectedObjectsClear();map.selectedObjectsAdd(hitObject)}}else{var mapBounds=map.getMapBounds();location[0]/=mapBounds.width;location[2]/=mapBounds.height;var tLocation=vec3.toString(location);for(i=0;i<selectedObjects.length;++i){player=selectedObjects[i];if(player.playerID){MultiplayerManager.Emit("EditorGotoLocation",player.playerID,tLocation)}}}}}};SceneMapsManager.prototype.objectsMoved=function(objects){var map=this.map;if(map){var selectedObjects=map.selectedObjects;if(selectedObjects.length>0){var mapBounds=map.getMapBounds();var i;for(i=0;i<selectedObjects.length;++i){var object=selectedObjects[i];if(!object.playerID&&object!==map.ground){var objectID=object.getID();var location=vec3.clone(object.position);location[0]/=mapBounds.width;location[2]/=mapBounds.height;var tLocation=vec3.toString(location);MultiplayerManager.Emit("EditorObjectMove",objectID,tLocation)}}map.updatePathFinder()}map.selectedObjectsUpdated()}};SceneMapsManager.prototype.objectsResized=function(){var map=this.map;if(map){var selectedObjects=map.selectedObjects;if(selectedObjects.length>0){for(i=0;i<selectedObjects.length;++i){var object=selectedObjects[i];if(!object.playerID){var size=object.collisionSize.width;if(object===map.ground){MultiplayerManager.Emit("EditorMapSize",size)}else{var objectID=object.getID();MultiplayerManager.Emit("EditorObjectSize",objectID,size)}}}map.updatePathFinder()}map.selectedObjectsUpdated()}};SceneMapsManager.prototype.createObject=function(location){var map=this.map;if(map){var mapBounds=map.getMapBounds();location[0]/=mapBounds.width;location[2]/=mapBounds.height;var tLocation=vec3.toString(location);var obj,tex;var modelInfo=map.sceneUI.getSelectedModel();if(modelInfo){MultiplayerManager.Emit("EditorObjectCreate",tLocation,modelInfo.objectID)}else{MultiplayerManager.Emit("EditorObjectCreate",tLocation)}}};SceneMapsManager.prototype.deleteObject=function(object){var map=this.map;if(map){var id=object.objectID;if(MultiplayerManager.Emit("EditorObjectDelete",id)){map.syncRemoveStaticObject(id)}}};SceneMapsManager.prototype.modelCreated=function(modelInfo){if(MultiplayerManager.LoggedIn){var map=this.map;if(map){var objects=map.selectedObjects;var i,object;if(modelInfo){for(i=0;i<objects.length;++i){object=objects[i];MultiplayerManager.Emit("EditorObjectModel",object.getID(),modelInfo.objectID)}}map.sceneUI.flagPendingModelUpdate();map.sceneUI.findAndSelectModelID(modelInfo.objectID)}}};SceneMapsManager.prototype.modelSelected=function(modelInfo){if(MultiplayerManager.LoggedIn){var map=this.map;if(map){var objects=map.selectedObjects;var i,object;if(modelInfo){var modelID=modelInfo.objectID;for(i=0;i<objects.length;++i){object=objects[i];var id=object.objectID;MultiplayerManager.Emit("EditorObjectModel",id,modelID);object.setupModel(modelInfo.obj,modelInfo.tex)}if(!this.map.sceneUI.creatingObjects){this.map.sceneUI.handleCreateButton()}}}}};SceneMapsManager.prototype.close=function(){this.deleteLater();new SceneProjectManager};function SceneTemplateUIManagerList(manager){this.manager=manager;manager.linkScene(this);this.setParent(manager);this.construct()}ExtendPrototype(SceneTemplateUIManagerList,SceneManagerList);SceneTemplateUIManagerList.prototype.deleteLater=function(){this.SceneManagerList_deleteLater()};SceneTemplateUIManagerList.prototype.setup=function(){this.SceneManagerList_setup();this.ui=[];this.addList("Your Private Screens",EditorManager.LightRed);this.addList("Open Source Screens",EditorManager.LightGreen);var self=this;CCFileManager.Load("SceneTemplateUIManagerList.db",function(data){if(data){if(!self.loaded){var list=JSON.parse(data);self.show(list)}}});if(MultiplayerManager.Emit("EditorUIRequestList")){this.syncingUpdates=true}};SceneTemplateUIManagerList.prototype.syncUpdate=function(jsonData){var privateTiles=this.tileLists[0].list;var publicTiles=this.tileLists[1].list;var tiles=this.tiles;var info,i,tile;if(jsonData.EditorUI){var list=jsonData.EditorUI;this.show(list);CCFileManager.Save("SceneTemplateUIManagerList.db",list);if(!this.loaded){this.loaded=true}}else if(jsonData.EditorUIUpdated){info=jsonData.EditorUIUpdated;id=info.id;var uiTile;for(i=0;i<privateTiles.length;++i){tile=privateTiles[i];if(id===tile.id){uiTile=tile;break}}if(!uiTile){for(i=0;i<publicTiles.length;++i){tile=publicTiles[i];if(id===tile.id){uiTile=tile;break}}}if(uiTile){uiTile.setText(info.id+"\n"+info.name)}}};SceneTemplateUIManagerList.prototype.show=function(list){var self=this;var privateTiles=this.tileLists[0].list;var publicTiles=this.tileLists[1].list;var tiles=this.tiles;var info,i,tile;var OpenUIFunction=function(info){return function(){self.manager.openUI(info)}};{for(i=0;i<privateTiles.length;++i){tile=privateTiles[i];tiles.remove(tile);tile.deleteLater()}privateTiles.length=0}{for(i=0;i<publicTiles.length;++i){tile=publicTiles[i];tiles.remove(tile);tile.deleteLater()}publicTiles.length=0}var ignoreUIs=this.manager.ignoreUIs;for(i=0;i<list.length;++i){info=list[i];var skip=false;for(var j=0;j<ignoreUIs.length;++j){var ignoreUI=ignoreUIs[j];if(info.id===ignoreUI.id){skip=true;break}}if(skip){continue}tile=new CCTile3DButton(this);tile.setupText(info.id+"\n"+info.name,1,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setTextColour(gColour.set(0,1));if(info.open){tile.setColour(EditorManager.LightGreen)}else{tile.setColour(EditorManager.Red)}tile.setDrawOrder(205);tile.onRelease.push(new OpenUIFunction(info));this.addTile(tile);if(info.open){publicTiles.add(tile)}else{privateTiles.add(tile)}tile.id=info.id}{{tile=new CCTile3DButton(this);tile.setupText("+",1,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setTextColour(gColour.set(.125,1));tile.setColour(gColour.set(.5,.9));tile.setDrawOrder(205);tile.onRelease.push(function(){self.manager.createUI(true)});this.addTile(tile);publicTiles.add(tile)}{tile=new CCTile3DButton(this);tile.setupText("+",1,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setTextColour(gColour.set(0,1));tile.setColour(gColour.set(.5,.9));tile.setDrawOrder(205);tile.onRelease.push(function(){self.manager.createUI(false)});this.addTile(tile);privateTiles.add(tile)}}this.requestResize()};function SceneTemplateUIManager(uiID,onSelect,onClose,ignoreUIs){this.construct();if(uiID){this.loadingUI=uiID}else{var managerSettings=CC.GetJSLocationBarData("SceneTemplateUIManager");if(managerSettings&&managerSettings!=="menu"){this.loadingUI=managerSettings}}if(onSelect){this.onSelect=onSelect}if(onClose){this.onClose=onClose}if(ignoreUIs){this.ignoreUIs=ignoreUIs}else{this.ignoreUIs=[]}gEngine.addScene(this)}ExtendPrototype(SceneTemplateUIManager,SceneManagerPlay);SceneTemplateUIManager.prototype.construct=function(){this.SceneManagerPlay_construct();this.syncDisconnected()};SceneTemplateUIManager.prototype.destruct=function(){this.SceneManagerPlay_destruct()};SceneTemplateUIManager.prototype.deleteLater=function(){if(window.socket){if(!this.unregistered){MultiplayerManager.Emit("EditorUIUnregisterUpdates");this.unregistered=false}}CC.RemoveJSLocationBarData("SceneTemplateUIManager");this.SceneManagerPlay_deleteLater()};SceneTemplateUIManager.prototype.setup=function(){this.SceneManagerPlay_setup()};SceneTemplateUIManager.prototype.onPause=function(){if(this.syncJSTime!==undefined){this.syncJS()}};SceneTemplateUIManager.prototype.updateScene=function(delta){var updated=this.SceneManagerPlay_updateScene(delta);if(this.syncJSTime!==undefined){this.syncJSTime-=delta;if(this.syncJSTime<=0){this.syncJS()}}return updated};SceneTemplateUIManager.prototype.syncDisconnected=function(){AlertsManager.ModalAlert("connecting...",2);if(this.ui){if(!this.loadingUI){if(this.ui.info){this.loadingUI=this.ui.info.id}}this.ui.deleteLater();this.ui=null}};SceneTemplateUIManager.prototype.syncLoggedIn=function(){this.SceneManagerPlay_syncLoggedIn();MultiplayerManager.Emit("EditorUIRegisterUpdates");AlertsManager.Hide("connecting...");if(this.webViewController){CCEngine.WebViewClose(this.webViewController);delete this.webViewController}if(this.loadingUI){this.requestUI(this.loadingUI);delete this.loadingUI}else{this.openList()}};SceneTemplateUIManager.prototype.syncUpdate=function(jsonData){this.SceneManagerPlay_syncUpdate(jsonData);var info,id;if(jsonData.EditorUIUpdated){if(this.ui){info=this.ui.info;var newInfo=jsonData.EditorUIUpdated;if(info.id===newInfo.id){if(info.filename!==newInfo.filename){this.openUI(newInfo)}}}}else if(jsonData.EditorUICreated){AlertsManager.Hide("loading...");info=jsonData.EditorUICreated;this.openUI(info)}else if(jsonData.EditorUICopied!==undefined){AlertsManager.Hide("copying...");if(this.ui){this.handleBackButton()}info=jsonData.EditorUICopied;if(info){this.openUI(info);AlertsManager.TimeoutAlert("UI Copied",2)}else{AlertsManager.TimeoutAlert("failed to copy UI",2)}}else if(jsonData.EditorUIDeleted!==undefined){AlertsManager.Hide("deleting...");id=jsonData.EditorUIDeleted;if(id===-1){AlertsManager.TimeoutAlert("failed to delete UI",2)}this.handleBackButton()}else if(jsonData.uiInfo!==undefined){AlertsManager.Hide("loading...");info=jsonData.uiInfo;if(info){this.openUI(info)}else{AlertsManager.TimeoutAlert("failed to load UI",2);this.openList()}}};SceneTemplateUIManager.prototype.openList=function(){CC.SetJSLocationBarData("SceneTemplateUIManager","menu");if(this.sceneList){this.closeList()}this.sceneList=new SceneTemplateUIManagerList(this);gEngine.addScene(this.sceneList)};SceneTemplateUIManager.prototype.closeList=function(){if(this.sceneList){this.sceneList.deleteLater();this.sceneList=null}};SceneTemplateUIManager.prototype.createUI=function(open){AlertsManager.ModalAlert("loading...");MultiplayerManager.Emit("EditorUICreate",open)};SceneTemplateUIManager.prototype.requestUI=function(id){AlertsManager.ModalAlert("loading...");MultiplayerManager.Emit("UIRequest",id)};SceneTemplateUIManager.prototype.openUI=function(info){if(this.onSelect){if(this.onSelect(this,info)){this.close();return}}CC.SetJSLocationBarData("SceneTemplateUIManager",info.id);this.closeList();if(info.filename){var filename=info.filename;var url=MultiplayerManager.GetAssetURL(info.filename);AlertsManager.Notification("editor","loading...");var self=this;gURLManager.requestURL(url,null,function(status,responseText){if(self.ui){self.handleBackButton(true)}self.ui=new SceneUIEditor(info,self);AlertsManager.Hide("loading...");var loaded=false;if(status>=CCURLRequest.Succeeded){loaded=self.ui.loadJS(responseText)}if(!loaded){AlertsManager.TimeoutAlert("failed to load js :(",2)}},1,filename)}else{if(this.ui){this.handleBackButton(true)}this.ui=new SceneUIEditor(info,this)}};SceneTemplateUIManager.prototype.handleBackButton=function(restarting){if(this.ui){if(!restarting){if(this.syncJSTime!==undefined){this.syncJS()}}if(this.webViewController){CCEngine.WebViewClose(this.webViewController);delete this.webViewController}this.ui.deleteLater();this.ui=null;if(!restarting){this.openList();if(this.onClose){this.close()}}}return true};SceneTemplateUIManager.prototype.handleDelete=function(){if(this.ui){if(MultiplayerManager.LoggedIn){var self=this;AlertsManager.ConfirmationAlert("Delete UI?",function(result){if(result){MultiplayerManager.Emit("EditorUIDelete",self.ui.info.id);AlertsManager.Hide("deleting...")}})}}};SceneTemplateUIManager.prototype.handleEditName=function(){if(this.ui){if(MultiplayerManager.LoggedIn){var self=this;var ui=this.ui;var name=ui.info.name;AlertsManager.InputAlert(name,function(result){if(result){if(name!==result){if(MultiplayerManager.LoggedIn){ui.info.name=result;ui.sceneUI.setupMenu(ui.info);MultiplayerManager.Emit("EditorUIEditName",ui.info.id,ui.info.name);self.syncJS()}}}},{space:true})}}};SceneTemplateUIManager.prototype.handleEditPrivacy=function(){if(this.ui){if(MultiplayerManager.LoggedIn){var self=this;var ui=this.ui;var open=ui.info.open;AlertsManager.ConfirmationAlert(open?"Make private?":"Make public?",function(result){if(result){ui.info.open=!open;if(MultiplayerManager.Emit("EditorUIEditPrivacy",ui.info.id,ui.info.open)){ui.sceneUI.setupMenu(ui.info)}}})}}};SceneTemplateUIManager.prototype.handleEditJS=function(){if(MultiplayerManager.LoggedIn){if(this.ui){if(MultiplayerManager.LoggedIn){var self=this;var ui=this.ui;var info=ui.info;var fileID=info.id;var OpenCodeEditor=function(filename){var url=SERVER_ROOT+"jseditor/#file="+filename;if(SERVER_ASSETS_URL.getDomain()!==WINDOW_DOMAIN){url+="&proxy="+SERVER_ASSETS_URL}CCEngine.WebViewOpen(url,function(webViewController,opened){if(webViewController&&opened){self.webViewController=webViewController;webViewController.webView.fileID=fileID}},function(webViewController,url,open){if(open){var splitURL=url.split("#save");if(splitURL.length>1){if(MultiplayerManager.LoggedIn){if(self.webViewController){var webView=self.webViewController.webView;var data=webView.GetData();webView.SavedData(data);self.uploadJS(fileID,data,true);self.ui.deleteLater();self.ui=new SceneUIEditor(info,self);self.ui.loadJS(data)}}}}},"jseditor","_newtab")};if(this.syncJSTime!==undefined){this.syncJS(OpenCodeEditor)}else{OpenCodeEditor(info.filename)}}}}};SceneTemplateUIManager.prototype.close=function(){this.deleteLater();if(this.onClose){this.onClose()}else{new SceneProjectManager}};SceneTemplateUIManager.prototype.objectSelected=function(hitObject,location){var ui=this.ui;var selectedObjects=ui.selectedObjects;var i;if(ui.sceneUI.creatingObjects){ui.sceneUI.handleCreateButton()}var reselectedObject=false;for(i=0;i<selectedObjects.length;++i){if(hitObject===selectedObjects[i]){reselectedObject=true;break}}if(reselectedObject){if(!gEngine.controls.keys[91]&&!gEngine.controls.keys[17]){ui.selectedObjectsClear()}else{ui.selectedObjectsRemove(hitObject)}}else{if(!gEngine.controls.keys[91]&&!gEngine.controls.keys[17]){ui.selectedObjectsClear()}if(hitObject){ui.selectedObjectsAdd(hitObject)}}};SceneTemplateUIManager.prototype.objectCreated=function(){this.requestSyncJS()};SceneTemplateUIManager.prototype.objectsMoved=function(){this.requestSyncJS()};SceneTemplateUIManager.prototype.objectsResized=function(){this.requestSyncJS()};SceneTemplateUIManager.prototype.objectUpdated=function(){this.requestSyncJS()};SceneTemplateUIManager.prototype.objectDeleted=function(){this.requestSyncJS()};SceneTemplateUIManager.prototype.requestSyncJS=function(){this.syncJSTime=.5;if(this.webViewController){CCEngine.WebViewClose(this.webViewController);delete this.webViewController}};SceneTemplateUIManager.prototype.syncJS=function(callback){if(MultiplayerManager.LoggedIn){delete this.syncJSTime;if(this.ui){var id=this.ui.info.id;if(MultiplayerManager.IsOwner(this.ui.info.owners)){var fileID=id;var data=this.ui.exportJS();this.uploadJS(fileID,data,false,callback)}else{AlertsManager.ConfirmationAlert("In order to make changes to this UI,\nyou must first create a copy",function(result){if(result){if(MultiplayerManager.Emit("EditorUICopy",id)){AlertsManager.ModalAlert("copying...")}}})}}}};SceneTemplateUIManager.prototype.uploadJS=function(fileID,data,alert,callback){var self=this;EditorManager.EditorUploadJS(fileID,data,function(fileID,filename){var uploaded=false;if(filename){if(MultiplayerManager.LoggedIn){uploaded=true;self.uploadedJS(filename);if(callback){callback(filename)}}}if(!uploaded){AlertsManager.TimeoutAlert("failed to upload "+fileID+" :(",2)}},alert)};SceneTemplateUIManager.prototype.uploadedJS=function(filename){if(this.ui){var info=this.ui.info;info.filename=filename;
MultiplayerManager.Emit("EditorUIUpdateJS",info.id,filename)}};function SceneProjectUIManager(appID,uiInfo,onClose){this.construct();this.appID=appID;this.onClose=onClose;gEngine.addScene(this);this.uiInfo=uiInfo;this.openUI(uiInfo);if(!uiInfo.filename){this.syncJS()}}ExtendPrototype(SceneProjectUIManager,SceneManagerPlay);SceneProjectUIManager.prototype.construct=function(){this.SceneManagerPlay_construct();this.syncDisconnected()};SceneProjectUIManager.prototype.destruct=function(){this.SceneManagerPlay_destruct()};SceneProjectUIManager.prototype.deleteLater=function(){CC.RemoveJSLocationBarData("SceneProjectUIManager");this.SceneManagerPlay_deleteLater()};SceneProjectUIManager.prototype.setup=function(){this.SceneManagerPlay_setup()};SceneProjectUIManager.prototype.updateAppInfo=function(appInfo){if(appInfo.id===this.appID){var uiScenes=appInfo.uiScenes;for(var i=0;i<uiScenes.length;++i){var ui=uiScenes[i];if(ui.id===this.uiInfo.id){if(!CC.DeepEquals(ui,this.uiInfo)){this.uiInfo=ui;this.openUI(ui)}break}}}};SceneProjectUIManager.prototype.onPause=function(){if(this.syncJSTime!==undefined){this.syncJS()}};SceneProjectUIManager.prototype.updateScene=function(delta){var updated=this.SceneManagerPlay_updateScene(delta);if(this.syncJSTime!==undefined){this.syncJSTime-=delta;if(this.syncJSTime<=0){this.syncJS()}}return updated};SceneProjectUIManager.prototype.syncDisconnected=function(){};SceneProjectUIManager.prototype.syncLoggedIn=function(){this.SceneManagerPlay_syncLoggedIn();if(this.webViewController){CCEngine.WebViewClose(this.webViewController);delete this.webViewController}};SceneProjectUIManager.prototype.syncUpdate=function(jsonData){this.SceneManagerPlay_syncUpdate(jsonData);var info,id;if(jsonData.EditorUIUpdated){if(this.ui){info=this.ui.info;var newInfo=jsonData.EditorUIUpdated;if(info.id===newInfo.id){if(info.filename!==newInfo.filename){this.openUI(newInfo)}}}}else if(jsonData.EditorUIDeleted!==undefined){AlertsManager.Hide("deleting...");id=jsonData.EditorUIDeleted;if(id===-1){AlertsManager.TimeoutAlert("failed to delete UI",2)}this.handleBackButton()}};SceneProjectUIManager.prototype.openUI=function(info){if(this.onSelect){if(this.onSelect(this,info)){this.close();return}}CC.SetJSLocationBarData("SceneProjectUIManager",info.id);if(info.filename){var filename=info.filename;var url=MultiplayerManager.GetAssetURL(info.filename);AlertsManager.Notification("editor","loading...");var self=this;gURLManager.requestURL(url,null,function(status,responseText){if(self.ui){self.handleBackButton(true)}self.ui=new SceneUIEditor(info,self);AlertsManager.Hide("loading...");var loaded=false;if(status>=CCURLRequest.Succeeded){loaded=self.ui.loadJS(responseText)}if(!loaded){AlertsManager.TimeoutAlert("failed to load js :(",2)}},1,filename)}else{this.ui=new SceneUIEditor(info,this)}};SceneProjectUIManager.prototype.handleBackButton=function(restarting){if(this.ui){if(!restarting){if(this.syncJSTime!==undefined){this.syncJS()}}if(this.webViewController){CCEngine.WebViewClose(this.webViewController);delete this.webViewController}this.ui.deleteLater();this.ui=null;if(!restarting){if(this.onClose){this.close()}}}return true};SceneProjectUIManager.prototype.handleDelete=function(){if(this.ui){if(MultiplayerManager.LoggedIn){var self=this;AlertsManager.ConfirmationAlert("Delete UI?",function(result){if(result){MultiplayerManager.Emit("EditorUIDelete",self.ui.info.id);AlertsManager.Hide("deleting...")}})}}};SceneProjectUIManager.prototype.handleEditName=function(){if(this.ui){if(MultiplayerManager.LoggedIn){var self=this;var ui=this.ui;var name=ui.info.name;AlertsManager.InputAlert(name,function(result){if(result){if(name!==result){if(MultiplayerManager.LoggedIn){ui.info.name=result;ui.sceneUI.setupMenu(ui.info);MultiplayerManager.Emit("EditorProjectEditUIName",self.appID,ui.info.id,ui.info.name);self.syncJS()}}}},{space:true})}}};SceneProjectUIManager.prototype.handleEditPrivacy=function(){if(this.ui){if(MultiplayerManager.LoggedIn){var self=this;var ui=this.ui;var open=ui.info.open;AlertsManager.ConfirmationAlert(open?"Make private?":"Make public?",function(result){if(result){ui.info.open=!open;if(MultiplayerManager.Emit("EditorUIEditPrivacy",ui.info.id,ui.info.open)){ui.sceneUI.setupMenu(ui.info)}}})}}};SceneProjectUIManager.prototype.handleEditJS=function(){if(CCEngine.IsMobile()){AlertsManager.TimeoutAlert("Please visit playir.com to edit source code",10);return}if(MultiplayerManager.LoggedIn){if(this.ui){if(MultiplayerManager.LoggedIn){var self=this;var ui=this.ui;var info=ui.info;var fileID=info.id;var OpenCodeEditor=function(filename){var url=SERVER_ROOT+"jseditor/#file="+filename;if(SERVER_ASSETS_URL.getDomain()!==WINDOW_DOMAIN){url+="&proxy="+SERVER_ASSETS_URL}CCEngine.WebViewOpen(url,function(webViewController,opened){if(webViewController&&opened){self.webViewController=webViewController;webViewController.webView.fileID=fileID}},function(webViewController,url,open){if(open){var splitURL=url.split("#save");if(splitURL.length>1){if(MultiplayerManager.LoggedIn){if(self.webViewController){var webView=self.webViewController.webView;var data=webView.GetData();webView.SavedData(data);self.uploadJS(fileID,data,true);self.ui.deleteLater();self.ui=new SceneUIEditor(info,self);self.ui.loadJS(data)}}}}},"jseditor","_newtab")};if(this.syncJSTime!==undefined){this.syncJS(OpenCodeEditor)}else{OpenCodeEditor(info.filename)}}}}};SceneProjectUIManager.prototype.close=function(){this.deleteLater();if(this.onClose){this.onClose()}else{new SceneProjectManager}};SceneProjectUIManager.prototype.objectSelected=function(hitObject,location){var ui=this.ui;var selectedObjects=ui.selectedObjects;var i;if(ui.sceneUI.creatingObjects){ui.sceneUI.handleCreateButton()}var reselectedObject=false;for(i=0;i<selectedObjects.length;++i){if(hitObject===selectedObjects[i]){reselectedObject=true;break}}if(reselectedObject){if(!gEngine.controls.keys[91]&&!gEngine.controls.keys[17]){ui.selectedObjectsClear()}else{ui.selectedObjectsRemove(hitObject)}}else{if(!gEngine.controls.keys[91]&&!gEngine.controls.keys[17]){ui.selectedObjectsClear()}if(hitObject){ui.selectedObjectsAdd(hitObject)}}};SceneProjectUIManager.prototype.objectCreated=function(){this.requestSyncJS()};SceneProjectUIManager.prototype.objectsMoved=function(){this.requestSyncJS()};SceneProjectUIManager.prototype.objectsResized=function(){this.requestSyncJS()};SceneProjectUIManager.prototype.objectUpdated=function(){this.requestSyncJS()};SceneProjectUIManager.prototype.objectDeleted=function(){this.requestSyncJS()};SceneProjectUIManager.prototype.requestSyncJS=function(){this.syncJSTime=.5;if(this.webViewController){CCEngine.WebViewClose(this.webViewController);delete this.webViewController}};SceneProjectUIManager.prototype.syncJS=function(callback){if(MultiplayerManager.LoggedIn){if(this.syncJSTime){delete this.syncJSTime}if(this.ui){var uiID=this.ui.info.id;var fileID=uiID;var data=this.ui.exportJS();this.uploadJS(fileID,data,false,callback)}}};SceneProjectUIManager.prototype.uploadJS=function(fileID,data,alert,callback){var self=this;EditorManager.EditorUploadJS(fileID,data,function(fileID,filename){var uploaded=false;if(filename){if(MultiplayerManager.LoggedIn){uploaded=true;self.uploadedJS(filename);if(callback){callback(filename)}}}if(!uploaded){AlertsManager.TimeoutAlert("failed to upload "+fileID+" :(",2)}},alert)};SceneProjectUIManager.prototype.uploadedJS=function(filename){if(this.ui){var info=this.ui.info;info.filename=filename;MultiplayerManager.Emit("EditorProjectEditUI",this.appID,info.id,filename)}};function SceneImagesManager(){this.construct()}ExtendPrototype(SceneImagesManager,SceneManagerPlay);SceneImagesManager.prototype.construct=function(){this.SceneManagerPlay_construct();this.openList();this.syncDisconnected();CC.SetJSLocationBarData("SceneImagesManager");var camera=gEngine.newSceneCamera(this);camera.setupViewport(0,0,1,1)};SceneImagesManager.prototype.deleteLater=function(){CC.RemoveJSLocationBarData("SceneImagesManager");this.SceneManagerPlay_deleteLater()};SceneImagesManager.prototype.syncDisconnected=function(){AlertsManager.ModalAlert("connecting...",2)};SceneImagesManager.prototype.syncLoggedIn=function(){this.SceneManagerPlay_syncLoggedIn();AlertsManager.Hide("connecting...")};SceneImagesManager.prototype.syncUpdate=function(jsonData){this.SceneManagerPlay_syncUpdate(jsonData);if(jsonData.EditorImageDeleted){this.openList()}};SceneImagesManager.prototype.close=function(){this.deleteLater();new SceneProjectManager};SceneImagesManager.prototype.openList=function(){if(!this.sceneAssetEditor){var self=this;this.sceneAssetEditor=new SceneAssetEditor(this,false,true,true);this.sceneAssetEditor.open("Edit Images");this.sceneAssetEditor.onClose=function(tex){if(tex){self.sceneAssetEditor=null;self.openList();self.sceneAssetEditor.sceneUIListDBImages.findAndSelect(tex)}else{self.close()}};var currentImageInfo;this.sceneAssetEditor.onSelected=function(imageInfo){if(imageInfo!==currentImageInfo){currentImageInfo=imageInfo;self.sceneAssetEditor.setImage(imageInfo)}}}};SceneImagesManager.prototype.closeList=function(){if(this.sceneAssetEditor){this.sceneAssetEditor.close()}};function SceneModelsManager(){this.construct()}ExtendPrototype(SceneModelsManager,SceneManagerPlay);SceneModelsManager.prototype.construct=function(){this.SceneManagerPlay_construct();this.openList();this.syncDisconnected();CC.SetJSLocationBarData("SceneModelsManager");var camera=gEngine.newSceneCamera(this);camera.setupViewport(0,0,1,1)};SceneModelsManager.prototype.deleteLater=function(){CC.RemoveJSLocationBarData("SceneModelsManager");this.SceneManagerPlay_deleteLater()};SceneModelsManager.prototype.syncDisconnected=function(){AlertsManager.ModalAlert("connecting...",2)};SceneModelsManager.prototype.syncLoggedIn=function(){this.SceneManagerPlay_syncLoggedIn();AlertsManager.Hide("connecting...")};SceneModelsManager.prototype.syncUpdate=function(jsonData){this.SceneManagerPlay_syncUpdate(jsonData);if(jsonData.EditorCharacterDeleted){this.openList()}};SceneModelsManager.prototype.close=function(){this.deleteLater();new SceneProjectManager};SceneModelsManager.prototype.openList=function(){if(!this.sceneAssetEditor){var self=this;this.sceneAssetEditor=new SceneAssetEditor(this,true,true,true);this.sceneAssetEditor.onClose=function(info){if(info){self.sceneAssetEditor.sceneUIListDBModels.findAndSelect(info);return true}else{self.close()}};this.sceneAssetEditor.onDeleted=function(){};var currentImageInfo;this.sceneAssetEditor.onSelected=function(imageInfo){if(imageInfo!==currentImageInfo){currentImageInfo=imageInfo;self.sceneAssetEditor.setImage(imageInfo)}};this.sceneAssetEditor.open("Edit Models")}};SceneModelsManager.prototype.closeList=function(){if(this.sceneAssetEditor){this.sceneAssetEditor.close()}};function SceneCharactersManager(){this.construct()}ExtendPrototype(SceneCharactersManager,SceneManagerPlay);SceneCharactersManager.prototype.construct=function(){this.SceneManagerPlay_construct();var managerSettings=CC.GetJSLocationBarData("SceneCharactersManager");if(managerSettings&&managerSettings!=="menu"){this.loadingCharacterID=managerSettings}this.openList();this.syncDisconnected();var camera=gEngine.newSceneCamera(this);camera.setupViewport(0,0,1,1);var self=this;this.sceneUIBack=new SceneUIBack(this,function(){self.closeList();self.close()},true)};SceneCharactersManager.prototype.deleteLater=function(){if(this.sceneUIBack){this.sceneUIBack.close();this.sceneUIBack=null}CC.RemoveJSLocationBarData("SceneCharactersManager");this.SceneManagerPlay_deleteLater()};SceneCharactersManager.prototype.syncDisconnected=function(){AlertsManager.ModalAlert("connecting...",2)};SceneCharactersManager.prototype.syncLoggedIn=function(){this.SceneManagerPlay_syncLoggedIn();AlertsManager.Hide("connecting...")};SceneCharactersManager.prototype.syncUpdate=function(jsonData){this.SceneManagerPlay_syncUpdate(jsonData);if(jsonData.EditorCharacterDeleted){this.openList()}};SceneCharactersManager.prototype.close=function(){this.deleteLater();new SceneProjectManager};SceneCharactersManager.prototype.newCharacter=function(){var self=this;if(this.loadingCharacterID){delete this.loadingCharacterID}this.closeList();if(!this.sceneCharacterEditor){this.sceneCharacterEditor=new SceneCharacterEditor(this.sceneUI);this.sceneCharacterEditor.selectModel();this.sceneCharacterEditor.onClose=function(characterInfo){self.sceneCharacterEditor=null;self.openList()}}};SceneCharactersManager.prototype.editCharacter=function(characterInfo){var self=this;if(this.loadingCharacterID){delete this.loadingCharacterID}this.closeList();if(!this.sceneCharacterEditor){this.sceneCharacterEditor=new SceneCharacterEditor(this);this.sceneCharacterEditor.onClose=function(characterInfo){self.sceneCharacterEditor=null;self.openList()}}this.sceneCharacterEditor.setCharacter(characterInfo);CC.SetJSLocationBarData("SceneCharactersManager",characterInfo.objectID)};SceneCharactersManager.prototype.openList=function(){if(!this.sceneUIListDB){CC.SetJSLocationBarData("SceneCharactersManager","menu");var self=this;this.sceneUIListDB=new SceneUIListDBCharacters(this,function(){self.newCharacter()},function(list){var characterID;if(self.sceneCharacterEditor){characterID=self.sceneCharacterEditor.info.objectID}else if(self.loadingCharacterID){characterID=self.loadingCharacterID}for(var i=0;i<list.length;++i){var info=list[i];if(info.objectID===characterID){self.editCharacter(info);break}}});this.sceneUIListDB.onSelected=function(characterInfo){self.editCharacter(characterInfo)}}};SceneCharactersManager.prototype.closeList=function(){if(this.sceneUIListDB){this.sceneUIListDB.close();this.sceneUIListDB=null}};function SceneAudioManager(){this.construct()}ExtendPrototype(SceneAudioManager,SceneManagerPlay);SceneAudioManager.prototype.construct=function(){this.SceneManagerPlay_construct();this.openList();this.syncDisconnected();CC.SetJSLocationBarData("SceneAudioManager");var camera=gEngine.newSceneCamera(this);camera.setupViewport(0,0,1,1)};SceneAudioManager.prototype.deleteLater=function(){if(this.sceneUIBack){this.sceneUIBack.close();this.sceneUIBack=null}CC.RemoveJSLocationBarData("SceneAudioManager");this.SceneManagerPlay_deleteLater()};SceneAudioManager.prototype.syncDisconnected=function(){AlertsManager.ModalAlert("connecting...",2)};SceneAudioManager.prototype.syncLoggedIn=function(){this.SceneManagerPlay_syncLoggedIn();AlertsManager.Hide("connecting...")};SceneAudioManager.prototype.syncUpdate=function(jsonData){this.SceneManagerPlay_syncUpdate(jsonData);if(jsonData.EditorCharacterDeleted){this.openList()}};SceneAudioManager.prototype.close=function(){this.deleteLater();new SceneProjectManager};SceneAudioManager.prototype.edit=function(info){var self=this;this.closeList();this.sceneEditor=new SceneAudioEditor(this.sceneUI);this.sceneEditor.setInfo(info);this.sceneEditor.open("Play "+info.id);this.sceneEditor.onClose=function(info){self.openList()}};SceneAudioManager.prototype.openList=function(){var self=this;if(!this.sceneUIListDB){this.sceneUIListDB=new SceneUIListDBAudio(this,function(){if(CCEngine.IsMobile()){AlertsManager.TimeoutAlert("Please visit playir.com to upload assets",10)}else{AlertsManager.TimeoutAlert("Drop in .mp3",3)}});this.sceneUIListDB.onSelected=function(info){self.edit(info)}}if(!this.sceneUIBack){this.sceneUIBack=new SceneUIBack(this.sceneUIListDB,function(){self.closeList();self.close()},true)}};SceneAudioManager.prototype.closeList=function(){if(this.sceneUIListDB){this.sceneUIListDB.close();this.sceneUIListDB=null}if(this.sceneUIBack){this.sceneUIBack.close();this.sceneUIBack=null}};function ColumnOfTiles(){this.tiles=[]}function RowOfTiles(){this.columns=[new ColumnOfTiles];this.columnIndex=0}RowOfTiles.prototype.addTile=function(tile){this.columns[this.columnIndex].tiles.add(tile)};RowOfTiles.prototype.addColumn=function(tile){this.columns.add(new ColumnOfTiles);this.columnIndex++;this.addTile(tile)};function SceneProjectEditor(parentScene,projectManager,appInfo){this.construct();this.controlsSwipeMomentum=true;this.projectManager=projectManager;this.appInfo=appInfo;this.appInfoRows=[];{this.setParent(parentScene)}{var camera=gEngine.newSceneCamera(this);camera.setupViewport(0,0,1,1)}this.show();this.open=true;MultiplayerManager.UpdateCallbacks.addOnce(this);gEngine.addScene(this)}ExtendPrototype(SceneProjectEditor,CCSceneAppUI);SceneProjectEditor.prototype.deleteLater=function(){if(this.webViewControllers){for(var i=0;i<this.webViewControllers.length;++i){var webViewController=this.webViewControllers[i];CCEngine.WebViewClose(webViewController)}delete this.webViewControllers}this.CCSceneAppUI_deleteLater()};SceneProjectEditor.prototype.setup=function(){this.camera.setCameraWidth(640,false);this.setupAppInfo(this.appInfo);if(CC.GetJSLocationBarData("SceneProjectUIManager")){var uiID=CC.GetJSLocationBarData("SceneProjectUIManager");this.editUI(uiID)}};SceneProjectEditor.prototype.syncUpdate=function(jsonData){if(jsonData.EditorProjectEdited!==undefined){AlertsManager.Hide("updating...");if(jsonData.appInfo){this.setupAppInfo(jsonData.appInfo,false)}if(jsonData.EditorProjectNewUI){if(!this.appInfo.uiScenes){this.appInfo.uiScenes=[]}var found=false;var ui=jsonData.EditorProjectNewUI;for(var i=0;i<this.appInfo.uiScenes.length;++i){if(ui.id===this.appInfo.uiScenes[i].id){found=true;break}}if(!found){this.appInfo.uiScenes.addOnce(jsonData.EditorProjectNewUI);this.setupAppInfo(this.appInfo,false)}this.editUI(jsonData.EditorProjectNewUI.id)}}else if(jsonData.EditorProjectImport!==undefined){AlertsManager.Hide("importing...");AlertsManager.Hide("forking...");if(jsonData.EditorProjectImport){if(typeof jsonData.EditorProjectImport==="object"){this.setupAppInfo(jsonData.EditorProjectImport)}else{this.setupAppInfo(this.appInfo)}}else{AlertsManager.TimeoutAlert("import failed :(",5)}}else if(jsonData.EditorProjectDeleted!==undefined){AlertsManager.Hide("deleting...");var deletedID=jsonData.EditorProjectDeleted;var appInfo=this.appInfo;if(deletedID&&deletedID===appInfo.id){this.close(true)}else{AlertsManager.TimeoutAlert("delete failed :(",5)}}else if(jsonData.AppsRequestInfo!==undefined){this.setupAppInfo(jsonData.AppsRequestInfo)}};SceneProjectEditor.prototype.setupAppInfo=function(appInfo,animate){if(animate===undefined){animate=true}CC.SetJSLocationBarData("SceneProjectEditor",appInfo.id);this.appInfo=appInfo;if(this.hidden){if(this.sceneProjectUIManager){this.sceneProjectUIManager.updateAppInfo(appInfo)}return}var self=this;var camera=this.camera;var i,js;var cameraX=camera.targetLookAt[0];var cameraY=camera.targetLookAt[1];var jsFiles=appInfo.jsFiles;if(this.webViewControllers){for(i=0;i<this.webViewControllers.length;++i){var webViewController=this.webViewControllers[i];if(!CCEngine.IsWebViewOpen(webViewController)){this.webViewControllers.remove(webViewController);--i;continue}if(jsFiles){var webView=webViewController.webView;for(var iJS=0;iJS<jsFiles.length;++iJS){js=jsFiles[iJS];webView.UpdatedFilename(js.fileID,js.filename)}}}}var objects=this.objects;for(i=0;i<this.objects.length;++i){objects[i].deleteLater()}this.objects.length=0;this.collideables.length=0;this.tiles.length=0;this.appInfoRows.length=0;var tile;{tile=new CCTile3DButton(this);tile.setupTile(camera.targetWidth);tile.setColour(gColour.set(.25,0));tile.setColourAlpha(.975,true);tile.setDrawOrder(99);this.tileBackground=tile;this.cameraStickyTiles.add(tile)}var LoadImageFunction=function(tile,textureSrc){return function(textureHandle){if(textureHandle){tile.setTileTexture(textureSrc);self.requestResize()}}};var textureSrc;var appInfoRows=this.appInfoRows;var row;{row=new RowOfTiles;appInfoRows.add(row);{tile=new CCTile3DButton(self);tile.setupText("Project ID:",1,false,true);this.addTile(tile);row.addTile(tile)}{tile=new CCTile3DButton(self);tile.setupText(appInfo.id,1,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.onRelease.push(function(){var url;if(window.DEBUG_IsLocalClient){url=SERVER_ROOT+"x/debug.html#id="+appInfo.id+"&online"}else{url=SERVER_ROOT+"x/#id="+appInfo.id+"&online"}CCEngine.WebViewOpen(url,null,null,{title:"game"})});this.addTile(tile);row.addColumn(tile)}}if(appInfo.name){row=new RowOfTiles;appInfoRows.add(row);{tile=new CCTile3DButton(self);tile.setupText("Name:",1,false,true);this.addTile(tile);row.addTile(tile)}{tile=new CCTile3DButton(self);tile.setupText(appInfo.name,1,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.onRelease.push(function(){AlertsManager.InputAlert(appInfo.name,function(result){if(result){if(appInfo.name!==result){if(MultiplayerManager.Emit("EditorProjectEditName",appInfo.id,result)){AlertsManager.ModalAlert("updating...");appInfo.name=result;self.setupAppInfo(appInfo,false)}}}},{space:true})});this.addTile(tile);row.addColumn(tile)}}var titleImage=appInfo.titleImage?appInfo.titleImage:SceneMultiManager.DefaultTitleImage;{row=new RowOfTiles;appInfoRows.add(row);{tile=new CCTile3DButton(self);tile.setupText("Title Image:",1,false,true);this.addTile(tile);row.addTile(tile)}{tile=new CCTile3DButton(self);tile.setupTile(1);gEngine.textureManager.getTextureHandle(titleImage,new LoadImageFunction(tile,titleImage));tile.onRelease.push(function(){self.editTitleImage()});this.addTile(tile);row.addColumn(tile)}}{row=new RowOfTiles;appInfoRows.add(row);{tile=new CCTile3DButton(self);tile.setupText("",1,false,true);row.addTile(tile)}}{row=new RowOfTiles;appInfoRows.add(row);{tile=new CCTile3DButton(self);tile.setupText(".js Start:",1,false,true);this.addTile(tile);row.addTile(tile)}{tile=new CCTile3DButton(self);if(appInfo.jsStart){tile.setupText(appInfo.jsStart,1,true,true)}else{tile.setupText("OverheadShooterTemplate",1,true,true)}tile.setTileTexture("editor_tile_background.jpg");tile.onRelease.push(function(){self.projectManager.onGameEditJSStart(appInfo)});this.addTile(tile);row.addColumn(tile)}}{row=new RowOfTiles;appInfoRows.add(row);{tile=new CCTile3DButton(self);tile.setupText(".js Sync:",1,false,true);this.addTile(tile);row.addTile(tile)}{var jsSyncName="On next start";if(appInfo.jsSync){jsSyncName="Runtime patching"}tile=new CCTile3DButton(self);tile.setupText(jsSyncName,1,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.onRelease.push(function(){if(MultiplayerManager.Emit("EditorProjectEditJSSync",appInfo.id,!appInfo.jsSync)){appInfo.jsSync=!appInfo.jsSync;AlertsManager.ModalAlert("updating...");self.setupAppInfo(appInfo,false)}});this.addTile(tile);row.addColumn(tile)}}{row=new RowOfTiles;appInfoRows.add(row);{tile=new CCTile3DButton(self);tile.setupText("Restart:",1,false,true);this.addTile(tile);row.addTile(tile)}{tile=new CCTile3DButton(self);tile.setupText("Soft",1,true,true);tile.setColour(EditorManager.Red);tile.setTileTexture("editor_tile_background.jpg");tile.onRelease.push(function(){self.projectManager.onGameRestart(appInfo,true)});this.addTile(tile);row.addColumn(tile)}{tile=new CCTile3DButton(self);tile.setupText("Hard",1,true,true);tile.setColour(EditorManager.Red);tile.setTileTexture("editor_tile_background.jpg");tile.onRelease.push(function(){self.projectManager.onGameRestart(appInfo,false)});this.addTile(tile);row.addColumn(tile)}}{row=new RowOfTiles;appInfoRows.add(row);{tile=new CCTile3DButton(self);tile.setupText("",1,false,true);row.addTile(tile)}}var uiScenes=appInfo.uiScenes;var uiInfo;var TextJSEditFunction=function(fileID){return function(){if(CCEngine.IsMobile()){AlertsManager.TimeoutAlert("Please visit playir.com to edit source code",10);return}var webViewController,i;if(self.webViewControllers){for(i=0;i<self.webViewControllers.length;++i){webViewController=self.webViewControllers[i];if(!CCEngine.IsWebViewOpen(webViewController)){self.webViewControllers.remove(webViewController);--i;continue}}}var controlKeyPressed=gEngine.controls.keys[91]||gEngine.controls.keys[17];var webViewControllerTarget=controlKeyPressed?1:0;var title="jseditor"+webViewControllerTarget;if(!self.webViewControllers){self.webViewControllers=[]}webViewController=CCEngine.GetWebView(title);if(webViewController){self.webViewControllers.addOnce(webViewController)}else{var url=SERVER_ROOT+"jseditor/tabs.php";webViewController=CCEngine.WebViewOpen(url,null,function(webViewController,url,open){if(open){var splitURL=url.split("#save");if(splitURL.length>1){if(MultiplayerManager.LoggedIn){if(webViewController){var webView=webViewController.webView;var fileID=webView.GetFileID();var data=webView.GetData();self.uploadJS(fileID,data);webView.SavedData(data)}}}}},{title:title});if(webViewController){self.webViewControllers.push(webViewController)}}var OnOpenFunction=function(webViewController,fileID,filename){return function(){if(self.webViewControllers.find(webViewController)!==-1){if(CCEngine.IsWebViewOpen(webViewController)){var webView=webViewController.webView;if(webView.editFile){webView.editFile(fileID,filename,SERVER_ASSETS_URL)}else{setTimeout(new OnOpenFunction(webViewController,fileID,filename),500)}}else{}}else{}}};for(i=0;i<jsFiles.length;++i){var js=jsFiles[i];if(fileID===js.fileID){var filename=js.filename;setTimeout(new OnOpenFunction(webViewController,fileID,filename),500);break}}}};var VisualJSEditFunction=function(fileID){return function(){for(var i=0;i<jsFiles.length;++i){var js=jsFiles[i];if(fileID===js.fileID){var filename=js.filename;self.projectManager.onVisualJSEditor(appInfo,filename);break}}}};{row=new RowOfTiles;appInfoRows.add(row);{tile=new CCTile3DButton(self);tile.setupText(".js Files:",1,false,true);this.addTile(tile);row.addTile(tile)}{tile=new CCTile3DButton(self);tile.setupText("New .js",1,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.onRelease.push(function(){AlertsManager.InputAlert("",function(result){if(result){result+=".js";if(MultiplayerManager.LoggedIn){self.uploadedJS(result,result,"")}}})});this.addTile(tile);row.addColumn(tile)}{tile=new CCTile3DButton(self);tile.setupText("Import .js",1,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.onRelease.push(function(){if(CCEngine.IsMobile()){AlertsManager.TimeoutAlert("Please visit playir.com to import",10);return}self.uploadingJS=true;AlertsManager.Alert("drop in .js file",function(){self.uploadingJS=false})});this.addTile(tile);row.addColumn(tile)}if(appInfo.jsFiles){var DeleteJSFunction=function(fileID){return function(){AlertsManager.ConfirmationAlert("Delete "+fileID+"?",function(result){if(result){self.deleteJSFile(appInfo,fileID)}})}};row=new RowOfTiles;appInfoRows.add(row);{tile=new CCTile3DButton(self);tile.setupText("",1,true,true);this.addTile(tile);row.addTile(tile)}var isUI,iUI;var fileID;for(i=0;i<jsFiles.length;++i){fileID=jsFiles[i].fileID;isUI=false;if(uiScenes){for(iUI=0;iUI<uiScenes.length;++iUI){if(uiScenes[iUI].id===fileID){isUI=true;break}}}if(isUI){continue}{tile=new CCTile3DButton(self);tile.setupText(" "+fileID,1,false,true);tile.setTileTexture("editor_tile_background.jpg");tile.onRelease.push(new TextJSEditFunction(fileID));this.addTile(tile);if(row.columnIndex<1){row.addColumn(tile)}else{row.addTile(tile)}}}for(i=0;i<jsFiles.length;++i){fileID=jsFiles[i].fileID;isUI=false;if(uiScenes){for(iUI=0;iUI<uiScenes.length;++iUI){if(uiScenes[iUI].id===fileID){isUI=true;break}}}if(isUI){continue}{tile=new CCTile3DButton(this);tile.textIcon=true;tile.setupTextured("editor_icon_js.jpg",function(){self.requestResize()});tile.onRelease.push(new VisualJSEditFunction(fileID));this.addTile(tile,0);if(row.columnIndex<2){row.addColumn(tile)}else{row.addTile(tile)}}}for(i=0;i<jsFiles.length;++i){fileID=jsFiles[i].fileID;isUI=false;if(uiScenes){for(iUI=0;iUI<uiScenes.length;++iUI){if(uiScenes[iUI].id===fileID){isUI=true;break}}}if(isUI){continue}tile=new CCTile3DButton(self);tile.setColour(EditorManager.Red);tile.textIcon=true;tile.setupTextured("editor_icon_delete.jpg",function(){self.requestResize()});tile.onRelease.push(new DeleteJSFunction(fileID));this.addTile(tile);if(row.columnIndex<3){row.addColumn(tile)}else{row.addTile(tile)}}}}{row=new RowOfTiles;appInfoRows.add(row);{tile=new CCTile3DButton(self);tile.setupText("",1,false,true);row.addTile(tile)}}{row=new RowOfTiles;appInfoRows.add(row);{tile=new CCTile3DButton(self);tile.setupText("UI Scenes:",1,false,true);this.addTile(tile);row.addTile(tile)}{tile=new CCTile3DButton(self);tile.setupText("New UI",1,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.onRelease.push(function(){self.newUI()});this.addTile(tile);row.addColumn(tile)}{tile=new CCTile3DButton(self);tile.setupText("Import UI",1,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.onRelease.push(function(){self.selectUI()});this.addTile(tile);row.addColumn(tile)}if(uiScenes){var EditUIFunction=function(id){return function(){self.editUI(id)}};var CloneUIFunction=function(uiID){return function(){self.cloneUI(uiID)}};var DeleteUIFunction=function(uiName,uiID){return function(){AlertsManager.ConfirmationAlert("Delete "+uiName+"?",function(result){if(result){self.deleteUI(appInfo,uiID)}})}};row=new RowOfTiles;appInfoRows.add(row);{tile=new CCTile3DButton(self);tile.setupText("",1,true,true);this.addTile(tile);row.addTile(tile)}for(i=0;i<uiScenes.length;++i){uiInfo=uiScenes[i];tile=new CCTile3DButton(self);tile.setupText(" "+uiInfo.name+" ("+uiInfo.id+")",1,false,true);tile.setTileTexture("editor_tile_background.jpg");tile.onRelease.push(new TextJSEditFunction(uiInfo.id));this.addTile(tile);if(i===0){row.addColumn(tile)}else{row.addTile(tile)}}for(i=0;i<uiScenes.length;++i){uiInfo=uiScenes[i];{tile=new CCTile3DButton(this);tile.textIcon=true;tile.setupTextured("editor_icon_hammer.jpg",function(){self.requestResize()});tile.onRelease.push(new EditUIFunction(uiInfo.id));this.addTile(tile,0);if(i===0){row.addColumn(tile)}else{row.addTile(tile)}}}for(i=0;i<uiScenes.length;++i){uiInfo=uiScenes[i];{tile=new CCTile3DButton(this);tile.textIcon=true;tile.setupTextured("editor_icon_js.jpg",function(){self.requestResize()});tile.onRelease.push(new VisualJSEditFunction(uiInfo.id));this.addTile(tile,0);if(i===0){row.addColumn(tile)}else{row.addTile(tile)}}}for(i=0;i<uiScenes.length;++i){uiInfo=uiScenes[i];{tile=new CCTile3DButton(this);tile.setupText("Clone",1,true,true);tile.setColour(EditorManager.LightGreen);tile.onRelease.push(new CloneUIFunction(uiInfo.id));this.addTile(tile,0);if(i===0){row.addColumn(tile)}else{row.addTile(tile)}}}for(i=0;i<uiScenes.length;++i){uiInfo=uiScenes[i];{tile=new CCTile3DButton(self);tile.setColour(EditorManager.Red);tile.textIcon=true;tile.setupTextured("editor_icon_delete.jpg",function(){self.requestResize()});tile.onRelease.push(new DeleteUIFunction(uiInfo.name,uiInfo.id));this.addTile(tile);if(i===0){row.addColumn(tile)}else{row.addTile(tile)}}}}}if(!appInfo.jsStart){{row=new RowOfTiles;appInfoRows.add(row);{tile=new CCTile3DButton(self);tile.setupText("Background:",1,false,true);this.addTile(tile);row.addTile(tile)}{tile=new CCTile3DButton(self);tile.setupTile(1);var backgroundImage=appInfo.backgroundImage?appInfo.backgroundImage:SceneBackground.BackgroundImage;if(backgroundImage){gEngine.textureManager.getTextureHandle(backgroundImage,new LoadImageFunction(tile,backgroundImage))}tile.onRelease.push(function(){self.editBackgroundImage()});this.addTile(tile);row.addColumn(tile)}}{row=new RowOfTiles;appInfoRows.add(row);{tile=new CCTile3DButton(self);tile.setupText("Players:",1,false,true);this.addTile(tile);row.addTile(tile)}var LoadedModelFunction=function(tile,tex){return function(model3d){if(model3d){var modelObject=tile.modelObject;modelObject.setModel(model3d);modelObject.setColourAlpha(0);modelObject.setColourAlpha(1,true);if(tex){model3d.setTexture(tex)}tile.model3d=model3d;self.requestResize()}}};var EditPlayerModelFunction=function(playerTypeInfo){return function(){self.projectManager.onGameEditPlayerType(appInfo,playerTypeInfo)}};var EditPlayerIconFunction=function(playerTypeInfo){return function(){self.projectManager.onGameEditPlayerIcon(appInfo,playerTypeInfo)}};
var DeletePlayerFunction=function(playerTypeID){return function(){if(MultiplayerManager.Emit("EditorProjectDeletePlayer",appInfo.id,playerTypeID)){AlertsManager.ModalAlert("updating...")}}};var playerTypes=appInfo.playerTypes?appInfo.playerTypes:SceneManagerGame.DefaultPlayerTypes;for(i=0;playerTypes&&i<playerTypes.length;++i){var playerTypeInfo=playerTypes[i];{tile=new CCTile3DButton(self);tile.setupText("Player: "+(i+1),1,true,true);tile.setTileTexture("editor_tile_background.jpg");row.addColumn(tile)}{tile=new CCTile3DButton(self);tile.setupTile(1);tile.setTileTexture("editor_tile_background.jpg");if(playerTypeInfo.icon){gEngine.textureManager.getTextureHandle(playerTypeInfo.icon,new LoadImageFunction(tile,playerTypeInfo.icon))}tile.onRelease.push(new EditPlayerIconFunction(playerTypeInfo));this.addTile(tile);row.addTile(tile)}{tile=new CCTile3DButton(self);tile.setupTile(1);{var modelObject=new CCObject;tile.addChild(modelObject);modelObject.setTransparent();tile.modelObject=modelObject}tile.onRelease.push(new EditPlayerModelFunction(playerTypeInfo));this.addTile(tile);row.addTile(tile);var obj=playerTypeInfo.obj;var tex=playerTypeInfo.tex;if(obj){CCModel3D.CacheModel(obj,true,new LoadedModelFunction(tile,tex))}}if(playerTypes.length>2){tile=new CCTile3DButton(self);tile.setupText("Delete",1,true,true);tile.setColour(EditorManager.Red);tile.setTileTexture("editor_tile_background.jpg");tile.onRelease.push(new DeletePlayerFunction(playerTypeInfo.type));this.addTile(tile);row.addTile(tile)}}{tile=new CCTile3DButton(self);tile.setupText("Add Player",1,true,true);tile.setColour(EditorManager.LightGreen);tile.setTileTexture("editor_tile_background.jpg");tile.onRelease.push(function(){if(MultiplayerManager.Emit("EditorProjectAddPlayer",appInfo.id)){AlertsManager.ModalAlert("updating...")}});this.addTile(tile);row.addColumn(tile)}}}{row=new RowOfTiles;appInfoRows.add(row);{tile=new CCTile3DButton(self);tile.setupText("",1,false,true);row.addTile(tile)}}{row=new RowOfTiles;appInfoRows.add(row);{tile=new CCTile3DButton(self);tile.setupText("Publish:",1,false,true);this.addTile(tile);row.addTile(tile)}{tile=new CCTile3DButton(self);if(appInfo.open){tile.setupText("Published",1,true,true);tile.setColour(EditorManager.LightGreen)}else{tile.setupText("Unpublished",1,true,true);tile.setColour(EditorManager.Red)}tile.setTileTexture("editor_tile_background.jpg");tile.onRelease.push(function(){AlertsManager.ConfirmationAlert(!appInfo.open?"Publish?":"Unpublish?",function(result){if(result){if(MultiplayerManager.Emit("EditorProjectPublish",appInfo.id,!appInfo.open)){appInfo.open=!appInfo.open;AlertsManager.ModalAlert("updating...");self.setupAppInfo(appInfo,false)}}})});this.addTile(tile);row.addColumn(tile)}}if(window.JSZip){row=new RowOfTiles;appInfoRows.add(row);{tile=new CCTile3DButton(self);tile.setupText("",1,true,true);this.addTile(tile);row.addTile(tile)}if(window.JSZip){tile=new CCTile3DButton(self);tile.setupText("Export .zip",1,true,true);tile.setColour(EditorManager.LightGreen);tile.setTileTexture("editor_tile_background.jpg");tile.onRelease.push(function(){if(CCEngine.IsMobile()){AlertsManager.TimeoutAlert("Please visit playir.com to export",10);return}self.exportProject(appInfo)});this.addTile(tile);row.addColumn(tile)}if(window.JSZip){tile=new CCTile3DButton(self);tile.setupText("Import .zip",1,true,true);tile.setColour(EditorManager.Red);tile.setTileTexture("editor_tile_background.jpg");tile.onRelease.push(function(){if(CCEngine.IsMobile()){AlertsManager.TimeoutAlert("Please visit playir.com to import",10);return}self.uploadingImport=true;AlertsManager.Alert("drop in appInfo.json or .zip package\n\nwarning: this will overwrite your current project",function(){self.uploadingImport=false})});this.addTile(tile);row.addColumn(tile)}}{row=new RowOfTiles;appInfoRows.add(row);{tile=new CCTile3DButton(self);tile.setupText("",1,true,true);this.addTile(tile);row.addTile(tile)}{tile=new CCTile3DButton(self);tile.setupText("Clone project",1,true,true);tile.setColour(EditorManager.LightGreen);tile.setTileTexture("editor_tile_background.jpg");tile.onRelease.push(function(){self.forkProject(appInfo)});this.addTile(tile);row.addColumn(tile)}{tile=new CCTile3DButton(self);tile.setupText("Import project",1,true,true);tile.setColour(EditorManager.Red);tile.setTileTexture("editor_tile_background.jpg");tile.onRelease.push(function(){self.importProject(appInfo)});this.addTile(tile);row.addColumn(tile)}}{row=new RowOfTiles;appInfoRows.add(row);var iOSID=appInfo.IOS_APP_ID?appInfo.IOS_APP_ID:"";{tile=new CCTile3DButton(self);tile.setupText("iOS App ID:",1,false,true);this.addTile(tile);row.addTile(tile)}{tile=new CCTile3DButton(self);tile.setupText(iOSID,1,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.onRelease.push(function(){var result=CC.WindowPrompt("iOS App ID",iOSID);if(result!==null&&result!==iOSID){if(result.length<1024){if(MultiplayerManager.Emit("EditorProjectiOSAppID",appInfo.id,result)){appInfo.IOS_APP_ID=result;AlertsManager.ModalAlert("updating...");self.setupAppInfo(appInfo,false)}}}});this.addTile(tile);row.addColumn(tile)}}{row=new RowOfTiles;appInfoRows.add(row);var androidID=appInfo.ANDROID_APP_ID?appInfo.ANDROID_APP_ID:"";{tile=new CCTile3DButton(self);tile.setupText("Android App ID:",1,false,true);this.addTile(tile);row.addTile(tile)}{tile=new CCTile3DButton(self);tile.setupText(androidID,1,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.onRelease.push(function(){var result=CC.WindowPrompt("Android ID",androidID);if(result!==null&&result!==androidID){if(result.length<1024){if(MultiplayerManager.Emit("EditorProjectAndroidAppID",appInfo.id,result)){appInfo.ANDROID_APP_ID=result;AlertsManager.ModalAlert("updating...");self.setupAppInfo(appInfo,false)}}}});this.addTile(tile);row.addColumn(tile)}}{row=new RowOfTiles;appInfoRows.add(row);var purchaseID=appInfo.PURCHASE_ID?appInfo.PURCHASE_ID:"";{tile=new CCTile3DButton(self);tile.setupText("In-App Purchase ID:",1,false,true);this.addTile(tile);row.addTile(tile)}{tile=new CCTile3DButton(self);tile.setupText(purchaseID,1,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.onRelease.push(function(){var result=CC.WindowPrompt("Default In-App Purchase ID",purchaseID);if(result!==null&&result!==purchaseID){if(result.length<1024){if(MultiplayerManager.Emit("EditorProjectInAppPurchaseID",appInfo.id,result)){appInfo.PURCHASE_ID=result;AlertsManager.ModalAlert("updating...");self.setupAppInfo(appInfo,false)}}}});this.addTile(tile);row.addColumn(tile)}}{row=new RowOfTiles;appInfoRows.add(row);{tile=new CCTile3DButton(self);tile.setupText("Owners:",1,false,true);this.addTile(tile);row.addTile(tile)}{tile=new CCTile3DButton(self);tile.setupText("Add Owner",1,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.onRelease.push(function(){AlertsManager.InputAlert(MultiplayerManager.UserID,function(result){if(result){if(MultiplayerManager.Emit("EditorProjectAddOwner",appID,result)){AlertsManager.ModalAlert("updating...")}}},{dot:true})});this.addTile(tile);row.addColumn(tile)}var ownerID;if(appInfo.owners){for(i=0;i<appInfo.owners.length;++i){ownerID=appInfo.owners[i];tile=new CCTile3DButton(self);tile.setupText(ownerID,1,true,true);tile.setTileTexture("editor_tile_background.jpg");this.addTile(tile);row.addTile(tile)}}{tile=new CCTile3DButton(self);tile.textIcon=true;tile.setupTextured("editor_icon_delete.jpg",function(){self.requestResize()});tile.shouldRender=false;this.addTile(tile);row.addColumn(tile)}if(appInfo.owners){var DeleteOwnerFunction=function(ownerID){return function(){self.deleteOwner(appInfo,ownerID)}};for(i=0;i<appInfo.owners.length;++i){ownerID=appInfo.owners[i];{tile=new CCTile3DButton(self);tile.setColour(EditorManager.Red);tile.textIcon=true;tile.setupTextured("editor_icon_delete.jpg",function(){self.requestResize()});tile.onRelease.push(new DeleteOwnerFunction(ownerID));this.addTile(tile);row.addTile(tile);if(MultiplayerManager.IsOwner([ownerID])){tile.shouldRender=false}}}}}{row=new RowOfTiles;appInfoRows.add(row);{tile=new CCTile3DButton(self);tile.setupText("",1,false,true);row.addTile(tile)}}{row=new RowOfTiles;appInfoRows.add(row);{tile=new CCTile3DButton(self);tile.setupText("",1,false,true);row.addTile(tile)}{tile=new CCTile3DButton(self);tile.setupText("Delete project",1,true,true);tile.setColour(EditorManager.Red);tile.onRelease.push(function(){AlertsManager.ConfirmationAlert("Delete?",function(result){if(result){if(MultiplayerManager.Emit("EditorProjectDelete",self.appInfo.id)){self.deletingProject=true;AlertsManager.ModalAlert("deleting...")}}})});this.addTile(tile);row.addColumn(tile)}}for(var rowIndex=0;rowIndex<appInfoRows.length;++rowIndex){row=appInfoRows[rowIndex];for(var columnIndex=0;columnIndex<row.columns.length;++columnIndex){var column=row.columns[columnIndex];for(var tileIndex=0;tileIndex<column.tiles.length;++tileIndex){tile=column.tiles[tileIndex];tile.setColourAlpha(0);if(columnIndex>0){if(tile.modelObject){}else{tile.setColourAlpha(1,animate)}}if(tile.textObject){if(columnIndex>0){tile.setColourAlpha(.5,animate)}tile.setTextColour(gColour.set(1,0));tile.setTextColourAlpha(1,animate)}tile.setDrawOrder(205)}}}this.requestResize();this.refreshCameraView();this.lockCameraView();camera.setLookAt([camera.targetLookAt[0],camera.targetHeight,0],false);this.lockCameraView();if(!animate){camera.targetLookAt[0]=cameraX;camera.targetLookAt[1]=cameraY;camera.setLookAt(camera.targetLookAt);this.tileBackground.setColourAlpha(1)}};SceneProjectEditor.prototype.resize=function(){if(!this.enabled||this.deletingScene){return}this.CCSceneAppUI_resize();var camera=this.camera;{this.tileBackground.setTileSize(camera.targetWidth,camera.targetHeight)}var resize3DModel=function(tile){var model3d=tile.model3d;{var size=tile.collisionSize.height<tile.collisionSize.width?tile.collisionSize.height:tile.collisionSize.width;size*=.75;var scaleFactor;var modelWidth=model3d.getWidth()>model3d.getDepth()?model3d.getWidth():model3d.getDepth();var modelHeight=model3d.getHeight();if(modelWidth>modelHeight){scaleFactor=size/modelWidth}else{scaleFactor=size/modelHeight}model3d.setScale(scaleFactor)}};var textHeight=camera.targetHeight*.05;var valueFieldSize=textHeight*1.2;var imageHeight=camera.targetHeight*.3;var modelSize=imageHeight;var minTextWidth=camera.targetWidth*.1;var tile;var row,column,rowIndex,columnIndex,tileIndex;var appInfoRows=this.appInfoRows;var firstColumnWidth=0;for(rowIndex=0;rowIndex<appInfoRows.length;++rowIndex){row=appInfoRows[rowIndex];for(columnIndex=0;columnIndex<row.columns.length;++columnIndex){column=row.columns[columnIndex];var columnMaxWidth=100;for(tileIndex=0;tileIndex<column.tiles.length;++tileIndex){tile=column.tiles[tileIndex];if(tile.textObject){tile.setTextHeight(textHeight,true);tile.setTileSize(tile.collisionSize.width*1.1,valueFieldSize);if(tile.collisionSize.width>columnMaxWidth){columnMaxWidth=tile.collisionSize.width}}else if(tile.textIcon){tile.setTileSize(valueFieldSize)}else if(tile.modelObject){tile.setTileSize(modelSize)}else if(tile.getTileTextureImage()){tile.setTileTexturedHeight(imageHeight)}if(columnIndex===0){if(tile.collisionBounds[0]>firstColumnWidth){firstColumnWidth=tile.collisionBounds[0]}}else if(tile.textIcon){}else{if(tile.collisionSize.width<minTextWidth){tile.setTileSize(minTextWidth,tile.collisionSize.height)}if(tile.model3d){resize3DModel(tile)}}}for(tileIndex=0;tileIndex<column.tiles.length;++tileIndex){tile=column.tiles[tileIndex];if(tile.textObject){tile.setTileSize(columnMaxWidth,valueFieldSize)}}}}var y=0;for(rowIndex=0;rowIndex<appInfoRows.length;++rowIndex){var maxRowWidths=[0];var maxRowHeights=[0];row=appInfoRows[rowIndex];for(columnIndex=0;columnIndex<row.columns.length;++columnIndex){column=row.columns[columnIndex];for(tileIndex=0;tileIndex<column.tiles.length;++tileIndex){tile=column.tiles[tileIndex];if(columnIndex>=maxRowWidths.length){maxRowWidths.add(0)}if(tile.collisionBounds[0]>maxRowWidths[columnIndex]){maxRowWidths[columnIndex]=tile.collisionBounds[0]}if(tileIndex>=maxRowHeights.length){maxRowHeights.add(0)}if(tile.collisionBounds[1]>maxRowHeights[tileIndex]){maxRowHeights[tileIndex]=tile.collisionBounds[1]}}}var x=firstColumnWidth;for(columnIndex=1;columnIndex<row.columns.length;++columnIndex){x+=maxRowWidths[columnIndex];column=row.columns[columnIndex];for(tileIndex=0;tileIndex<column.tiles.length;++tileIndex){tile=column.tiles[tileIndex];tile.setPositionX(x)}x+=maxRowWidths[columnIndex]}for(var subRowIndex=0;subRowIndex<maxRowHeights.length;++subRowIndex){y-=maxRowHeights[subRowIndex];for(columnIndex=0;columnIndex<row.columns.length;++columnIndex){column=row.columns[columnIndex];tileIndex=subRowIndex;if(tileIndex<column.tiles.length){tile=column.tiles[tileIndex];if(tileIndex===0){tile.setPositionY(y)}else{tile.positionTileBelow(column.tiles[tileIndex-1])}}}}for(var i=0;i<maxRowHeights.length;++i){y-=maxRowHeights[i]}}};SceneProjectEditor.prototype.updateControls=function(controls){var usingControls=this.CCSceneAppUI_updateControls(controls);var cameraTouches=this.camera.cameraTouches;var touch=cameraTouches[0];if(touch.x>0&&touch.x<1&&touch.y>0&&touch.y<1&&touch.startX>0&&touch.startX<1&&touch.startY>0&&touch.startY<1){if(controls.wheel&&controls.wheel.delta!==0){var delta=controls.wheel.delta;this.cameraScrolling=true;this.controlsMovingVertical=true;this.touchCameraMoving(0,delta*.1);return true}}return usingControls};SceneProjectEditor.prototype.touchPressed=function(touch){this.CCSceneAppUI_touchPressed(touch);return this.open};SceneProjectEditor.prototype.refreshCameraView=function(){var left=CC_MAXFLOAT;var right=-CC_MAXFLOAT;var top=-CC_MAXFLOAT;var bottom=CC_MAXFLOAT;var tiles=this.tiles;for(var i=0;i<tiles.length;++i){var tile=tiles[i];var leftX=tile.getTileMovementTarget()[0]-tile.collisionBounds[0];var rightX=tile.getTileMovementTarget()[0]+tile.collisionBounds[0];var topY=tile.getTileMovementTarget()[1]+tile.collisionBounds[1];var bottomY=tile.getTileMovementTarget()[1]-tile.collisionBounds[1];if(leftX<left){left=leftX}if(rightX>right){right=rightX}if(topY>top){top=topY}if(bottomY<bottom){bottom=bottomY}}var camera=this.camera;this.sceneLeft=left+camera.targetWidth*.4;this.sceneRight=right;this.sceneTop=top-camera.targetHeight*.4;this.sceneBottom=bottom;if(this.sceneBottom>this.sceneTop){this.sceneBottom=this.sceneTop}};SceneProjectEditor.prototype.lockCameraView=function(){if(this.cameraScrolling){return}var camera=this.camera;if(camera.targetLookAt[0]<this.sceneLeft){camera.targetLookAt[0]=this.sceneLeft;camera.flagUpdate()}if(camera.targetLookAt[0]>this.sceneRight){camera.targetLookAt[0]=this.sceneRight;camera.flagUpdate()}if(camera.targetLookAt[1]>this.sceneTop){camera.targetLookAt[1]=this.sceneTop;camera.flagUpdate()}if(camera.targetLookAt[1]<this.sceneBottom){camera.targetLookAt[1]=this.sceneBottom;camera.flagUpdate()}};SceneProjectEditor.prototype.hide=function(){this.hidden=true;var tiles=this.tiles;for(var i=0;i<tiles.length;++i){var tile=tiles[i];tile.setColourAlpha(0,true);tile.setTextColourAlpha(0,true)}var self=this;this.tileBackground.setColourAlpha(0,true,function(){self.enabled=false;self.camera.enabled=false});if(this.sceneUIBack){this.sceneUIBack.close()}if(this.onDragDropFunction){gEngine.controls.onDragDrop.remove(this.onDragDropFunction);delete this.onDragDropFunction}if(this.onDragDropLoadFunction){gEngine.controls.onDragDropLoad.remove(this.onDragDropLoadFunction);delete this.onDragDropLoadFunction}};SceneProjectEditor.prototype.show=function(){this.hidden=false;var self=this;if(!this.sceneUIBack){this.sceneUIBack=new SceneUIBack(this,function(){self.close()},true)}if(!this.onDragDropFunction){this.onDragDropFunction=function(files,event){self.onDragDrop(files,event)};gEngine.controls.onDragDrop.add(this.onDragDropFunction)}if(!this.onDragDropLoadFunction){this.onDragDropLoadFunction=function(file,event){self.onDragDropLoad(file,event)};gEngine.controls.onDragDropLoad.add(this.onDragDropLoadFunction)}this.enabled=true;this.camera.enabled=true;if(this.open){var cameraX=this.camera.targetLookAt[0];var cameraY=this.camera.targetLookAt[1];this.setupAppInfo(this.appInfo);this.camera.targetLookAt[0]=cameraX;this.camera.targetLookAt[1]=cameraY;this.camera.setLookAt(this.camera.targetLookAt)}};SceneProjectEditor.prototype.close=function(openProjectsList){if(this.deletingProject){AlertsManager.Hide("deleting...")}CC.RemoveJSLocationBarData("SceneProjectEditor");if(openProjectsList===undefined){openProjectsList=true}this.open=false;this.hide();var camera=this.camera;camera.flagUpdate();camera.targetLookAt[1]=camera.targetHeight;if(this.parentScene){this.parentScene.deletingChild(this)}var self=this;this.tileBackground.setColourAlpha(0,true,function(){self.deleteLater()});if(openProjectsList){this.projectManager.openProjectsList()}};SceneProjectEditor.prototype.onDragDrop=function(files,event){AlertsManager.ModalAlert("loading...")};SceneProjectEditor.prototype.onDragDropLoad=function(file,event){AlertsManager.Hide("loading...");if(event&&event.target&&event.target.result){if(MultiplayerManager.LoggedIn){var data=event.target.result;this.prepareUpload(file,data)}}};SceneProjectEditor.prototype.prepareUpload=function(file,data){var filename=file.name;filename=filename.toLowerCase();var fileExtension=filename.getExtension();if(this.projectManager.sceneUI.sceneAssetEditor){}else if(this.uploadingImport){this.uploadingImport=false;AlertsManager.Hide("drop in appInfo.json or .zip package\n\nwarning: this will overwrite your current project");if(fileExtension==="zip"){this.importZip(data)}else if(filename==="appinfo.json"||filename==="gameinfo.json"){this.importAppInfoJSON(data)}else{AlertsManager.TimeoutAlert("only .json or .zip files supported",2)}}else if(fileExtension==="zip"){this.importZip(data)}else if(filename==="appinfo.json"||filename==="gameinfo.json"){this.importAppInfoJSON(data)}else if(fileExtension==="js"||this.uploadingJS){if(this.uploadingJS){this.uploadingJS=false;AlertsManager.Hide("drop in .js file");if(fileExtension!=="js"){AlertsManager.TimeoutAlert("only .js supported",2);return}}if(file.size>1024*1024){AlertsManager.TimeoutAlert("file size too large",2)}else{this.uploadJS(filename,data)}}else if(fileExtension==="bmp"||fileExtension==="jpeg"||fileExtension==="jpg"||fileExtension==="png"){this.editTitleImage()}};SceneProjectEditor.prototype.uploadJS=function(fileID,data){var self=this;EditorManager.EditorUploadJS(fileID,data,function(fileID,filename){var uploaded=false;if(filename){if(MultiplayerManager.LoggedIn){uploaded=self.uploadedJS(fileID,filename,data)}}if(!uploaded){AlertsManager.TimeoutAlert("failed to upload "+fileID+" :(",2)}})};SceneProjectEditor.prototype.uploadedJS=function(fileID,filename,data){var fileExtension=filename.getExtension();if(fileExtension==="js"){var i;var jsFiles=this.appInfo.jsFiles;if(jsFiles){for(i=0;i<jsFiles.length;++i){var js=jsFiles[i];if(js.fileID===fileID){if(js.filename===filename){return true}}}}if(this.webViewControllers){for(i=0;i<this.webViewControllers.length;++i){var webViewController=this.webViewControllers[i];if(!CCEngine.IsWebViewOpen(webViewController)){this.webViewControllers.remove(webViewController);--i;continue}var webView=webViewController.webView;webView.UpdatedFilenameForData(fileID,filename,data)}}var uiScenes=this.appInfo.uiScenes;if(uiScenes){for(i=0;i<uiScenes.length;++i){var uiInfo=uiScenes[i];if(uiInfo.id===fileID){this.editUIFile(fileID,filename);return true}}}this.addJSFile(this.appInfo,fileID,filename);return true}else{AlertsManager.TimeoutAlert("failed to upload "+fileID+" :(",2)}return false};SceneProjectEditor.prototype.editTitleImage=function(){this.hide();var self=this;var appInfo=this.appInfo;var sceneAssetEditor=null;if(SceneAssetEditor.self){sceneAssetEditor=SceneAssetEditor.self}else{sceneAssetEditor=new SceneAssetEditor(this,false,true);sceneAssetEditor.open("Edit Title Image");sceneAssetEditor.setAsset(appInfo.titleImage)}sceneAssetEditor.onClose=function(tex){self.show();if(tex){if(appInfo.titleImage!==tex){if(MultiplayerManager.Emit("EditorProjectEditTitleImage",appInfo.id,tex)){appInfo.titleImage=tex;AlertsManager.ModalAlert("updating...");self.setupAppInfo(appInfo,false)}}}}};SceneProjectEditor.prototype.editBackgroundImage=function(){this.hide();var self=this;var appInfo=this.appInfo;var sceneAssetEditor=null;if(SceneAssetEditor.self){sceneAssetEditor=SceneAssetEditor.self}else{sceneAssetEditor=new SceneAssetEditor(this,false,true);sceneAssetEditor.open("Edit Background Image");sceneAssetEditor.setAsset(appInfo.titleImage)}sceneAssetEditor.onClose=function(tex){self.show();if(tex){if(appInfo.backgroundImage!==tex){if(MultiplayerManager.Emit("EditorProjectEditBackgroundImage",appInfo.id,tex)){appInfo.backgroundImage=tex;AlertsManager.ModalAlert("updating...");self.setupAppInfo(appInfo,false)}}}}};SceneProjectEditor.prototype.addJSFile=function(appInfo,fileID,filename){if(MultiplayerManager.LoggedIn){if(!appInfo.jsFiles){appInfo.jsFiles=[]}var found=false;var jsFiles=appInfo.jsFiles;for(var i=0;i<jsFiles.length;++i){var itr=jsFiles[i];if(itr.fileID===fileID){if(itr.filename===filename){found=true}else{itr.filename=filename}break}}if(!found){if(MultiplayerManager.Emit("EditorProjectAddJSFile",appInfo.id,fileID,filename)){AlertsManager.ModalAlert("updating...");this.setupAppInfo(appInfo,false)}}}};SceneProjectEditor.prototype.deleteJSFile=function(appInfo,fileID){if(MultiplayerManager.LoggedIn){if(appInfo.jsFiles){var jsFiles=appInfo.jsFiles;for(var i=0;i<jsFiles.length;++i){var js=jsFiles[i];if(js.fileID===fileID){if(MultiplayerManager.Emit("EditorProjectRemoveJSFile",appInfo.id,fileID)){AlertsManager.ModalAlert("updating...");jsFiles.remove(js);if(jsFiles.length===0){delete appInfo.jsFiles}this.setupAppInfo(appInfo,false)}break}}}}};SceneProjectEditor.prototype.newUI=function(){AlertsManager.ModalAlert("updating...");MultiplayerManager.Emit("EditorProjectNewUI",this.appInfo.id)};SceneProjectEditor.prototype.editUI=function(uiID){this.currentLookAt=this.camera.targetLookAt[0];this.camera.targetLookAt[0]+=this.camera.targetWidth;this.camera.flagUpdate();this.hide();var self=this;var uiScenes=this.appInfo.uiScenes;if(uiScenes){for(var i=0;i<uiScenes.length;++i){var ui=uiScenes[i];if(ui.id===uiID){this.sceneProjectUIManager=new SceneProjectUIManager(this.appInfo.id,ui,function(){delete self.sceneProjectUIManager;self.show();self.camera.targetLookAt[0]=self.currentLookAt;self.camera.flagUpdate();delete self.currentLookAt});break}}}};SceneProjectEditor.prototype.editUIFile=function(uiID,filename){if(MultiplayerManager.LoggedIn){var uiScenes=this.appInfo.uiScenes;for(var i=0;i<uiScenes.length;++i){var ui=uiScenes[i];if(ui.id===uiID){MultiplayerManager.Emit("EditorProjectEditUI",this.appInfo.id,uiID,filename);break}}}};SceneProjectEditor.prototype.selectUI=function(){this.hide();var self=this;new SceneTemplateUIManager(null,function(uiManager,info){self.importUI(info.id);return true},function(){self.show()},this.appInfo.uiScenes)};SceneProjectEditor.prototype.importUI=function(uiID){var i;var appInfo=this.appInfo;var uiScenes=appInfo.uiScenes;if(uiScenes){for(i=0;i<uiScenes.length;++i){var ui=uiScenes[i];if(ui.parentID===uiID){return true}}}if(!appInfo.uiScenes){uiScenes=appInfo.uiScenes=[]}if(MultiplayerManager.Emit("EditorProjectImportUI",appInfo.id,uiID)){AlertsManager.ModalAlert("updating...")}};SceneProjectEditor.prototype.cloneUI=function(uiID){var i;var appInfo=this.appInfo;var uiScenes=appInfo.uiScenes;if(uiScenes){for(i=0;i<uiScenes.length;++i){var ui=uiScenes[i];if(ui.id===uiID){if(MultiplayerManager.Emit("EditorProjectCloneUI",appInfo.id,uiID)){AlertsManager.ModalAlert("updating...")}break}}}};SceneProjectEditor.prototype.deleteUI=function(appInfo,uiID){if(MultiplayerManager.LoggedIn){if(appInfo.uiScenes){var uiScenes=appInfo.uiScenes;for(var i=0;i<uiScenes.length;++i){var itr=uiScenes[i];if(itr.id===uiID){uiScenes.remove(itr);if(uiScenes.length===0){delete appInfo.uiScenes}if(MultiplayerManager.Emit("EditorProjectDeleteUI",appInfo.id,uiID)){AlertsManager.ModalAlert("updating...")}break}}}this.setupAppInfo(appInfo,false)}};SceneProjectEditor.prototype.deleteOwner=function(appInfo,ownerID){if(MultiplayerManager.LoggedIn){if(appInfo.owners&&appInfo.owners.length>1){var owners=appInfo.owners;for(var i=0;i<owners.length;++i){var owner=owners[i];if(owner!==MultiplayerManager.UserID){if(MultiplayerManager.Emit("EditorProjectRemoveOwner",appInfo.id,ownerID)){owners.remove(owner);AlertsManager.ModalAlert("updating...");this.setupAppInfo(appInfo,false)}break}}}}};SceneProjectEditor.prototype.importAppInfoJSON=function(jsonString){if(jsonString){var json=JSON.parse(jsonString);if(json){if(MultiplayerManager.Emit("EditorProjectImportZip",this.appInfo.id,json,SERVER_ASSETS_URL)){AlertsManager.ModalAlert("importing...")}}}};SceneProjectEditor.prototype.importZip=function(zipBuffer){if(window.JSZip){AlertsManager.ModalAlert("importing...",2);var appInfoString;var file,i;var assetFiles=[];var jsFiles=[];try{var zip=new JSZip(new Uint8Array(zipBuffer));if(zip&&zip.files){var fileNames=Object.keys(zip.files);for(i=0;i<fileNames.length;++i){var zipFile=zip.files[fileNames[i]];if(zipFile.name==="appinfo.json"||zipFile.name==="gameinfo.json"){appInfoString=zipFile.asText();continue}file={};file.name=zipFile.name;var extension=zipFile.name.getExtension();if(extension==="js"){file.data=zipFile.asText();jsFiles.push(file)}else{file.data=zipFile.asArrayBuffer();assetFiles.push(file)}}}}catch(e){}if(!appInfoString){AlertsManager.Hide("importing...");AlertsManager.TimeoutAlert("error importing appinfo.json",5);return}if(assetFiles.length>0){var self=this;var filesUploaded=[];var UploadedFunction=function(uploadFilename,newFilename){if(newFilename){AlertsManager.Notification("editor"+filesUploaded.length,"importing "+uploadFilename,null,2);filesUploaded.push(newFilename);if(uploadFilename!==newFilename){appInfoString=self.patchAppInfoFile(appInfoString,uploadFilename,newFilename);self.patchJSFiles(jsFiles,uploadFilename,newFilename)}if(filesUploaded.length===assetFiles.length){self.importJSFiles(appInfoString,jsFiles)}}else{AlertsManager.Hide("importing...");AlertsManager.TimeoutAlert("error importing "+uploadFilename,5)}};for(i=0;i<assetFiles.length;++i){file=assetFiles[i];EditorManager.EditorUploadFile(file.name,file.data,UploadedFunction,false)}}else{this.importJSFiles(appInfoString,jsFiles)}}};SceneProjectEditor.prototype.importJSFiles=function(appInfoString,jsFiles){if(jsFiles.length>0){var self=this;var filesUploaded=[];var UploadedFunction=function(uploadFilename,newFilename){if(newFilename){filesUploaded.push(newFilename);if(uploadFilename!==newFilename){appInfoString=self.patchAppInfoFile(appInfoString,uploadFilename,newFilename)}if(filesUploaded.length===jsFiles.length){AlertsManager.Hide("importing...");self.importAppInfoJSON(appInfoString)}}else{AlertsManager.Hide("importing...");AlertsManager.TimeoutAlert("error importing "+uploadFilename,5)}};for(i=0;i<jsFiles.length;++i){file=jsFiles[i];EditorManager.EditorUploadFile(file.name,file.data,UploadedFunction,false)}}else{AlertsManager.Hide("importing...");this.importAppInfoJSON(appInfoString)}};SceneProjectEditor.prototype.patchAppInfoFile=function(appInfoString,oldFilename,newFilename){appInfoString=String.ReplaceChar(appInfoString,'"'+oldFilename+'"','"'+newFilename+'"');appInfoString=String.ReplaceChar(appInfoString,"'"+oldFilename+"'","'"+newFilename+"'");return appInfoString};SceneProjectEditor.prototype.patchJSFiles=function(jsFiles,oldFilename,newFilename){for(var i=0;i<jsFiles.length;++i){var file=jsFiles[i];file.data=String.ReplaceChar(file.data,'"'+oldFilename+'"','"'+newFilename+'"');file.data=String.ReplaceChar(file.data,"'"+oldFilename+"'","'"+newFilename+"'")}};SceneProjectEditor.prototype.forkProject=function(appInfo){if(MultiplayerManager.Emit("EditorProjectFork",this.appInfo.id)){AlertsManager.ModalAlert("forking...")}};SceneProjectEditor.prototype.importProject=function(){if(!this.sceneProjectsList){this.hide();var self=this;this.sceneProjectsList=new SceneProjectsList(this,function(appInfo){self.sceneProjectsList=null;self.show();if(self.appInfo.id!==appInfo.id){AlertsManager.ConfirmationAlert("warning: this will overwrite your current project",function(result){if(result){if(MultiplayerManager.Emit("EditorProjectImportProject",self.appInfo.id,appInfo.id)){AlertsManager.ModalAlert("importing...")}}})}},null,function(){self.sceneProjectsList=null;self.show()})}};SceneProjectEditor.prototype.exportProject=function(appInfo){AlertsManager.ModalAlert("exporting...");var numberOfFileRequests=0;var files=[];var self=this;var finishedRequests=false;var DownloadedFunction=function(filename){return function(status,data){if(status>=CCURLRequest.Succeeded&&data&&data.length>0){var file={};file.name=filename;file.data=data;files.push(file);if(finishedRequests&&files.length===numberOfFileRequests){self.BuildExportAssets(appInfo,files)}}else{AlertsManager.Hide("exporting...");AlertsManager.TimeoutAlert("error exporting "+filename,5)}}};if(appInfo.titleImage){if(!appInfo.jsFiles||appInfo.jsFiles.length===0){finishedRequests=true}numberOfFileRequests++;gURLManager.requestURL(MultiplayerManager.GetAssetURL(appInfo.titleImage),null,new DownloadedFunction(appInfo.titleImage),0,null,-1,0,true)}if(appInfo.jsFiles){var jsFiles=appInfo.jsFiles;for(var i=0;i<jsFiles.length;++i){if(i===jsFiles.length-1){finishedRequests=true}var js=jsFiles[i];if(js.filename){numberOfFileRequests++;gURLManager.requestURL(MultiplayerManager.GetAssetURL(js.filename),null,new DownloadedFunction(js.filename),0,js.filename,-1,0)}}}};SceneProjectEditor.prototype.BuildExportAssets=function(appInfo,files){var i;var assetFiles=[];var assetIDs=[];for(i=0;i<files.length;++i){var file=files[i];var extension=file.name.getExtension();if(extension==="js"){JSManager.ParseJSForAssets(file.data,assetFiles,assetIDs)}}appInfo.assetIDs=assetIDs;if(assetIDs.length>0){var self=this;appInfo.dbInfos=[];var requestingDownloads=true;var numberOfDownloads=0;var DownloadedFunction=function(id){return function(info){if(info){var i;numberOfDownloads++;if(window.DEBUG_IsLocalClient){console.log(numberOfDownloads,id)}AlertsManager.Notification("editor"+numberOfDownloads,"exporting "+id,null,1);appInfo.dbInfos.addOnce(info);if(info.mp3){assetFiles.addOnce(info.mp3)}if(info.actions){for(i=0;i<info.actions.length;++i){var action=info.actions[i];if(action.modelID){if(assetIDs.addOnce(action.modelID)){DBAssets.LoadID(action.modelID,new DownloadedFunction(action.modelID))}}}}if(info.obj){assetFiles.addOnce(info.obj)}if(info.tex){assetFiles.addOnce(info.tex)}if(info.mapTexture){assetFiles.addOnce(info.mapTexture)}if(info.staticObjects){for(i=0;i<info.staticObjects.length;++i){var object=info.staticObjects[i];if(object.obj){assetFiles.addOnce(object.obj)}if(object.tex){assetFiles.addOnce(object.tex)}}}}if(!requestingDownloads){if(assetIDs.length===numberOfDownloads){self.DownloadExportAssets(appInfo,files,assetFiles)}else{if(DBAssets.requests.length===0){console.log("BuildExportAssets::Missing Assets",assetIDs,assetFiles);self.DownloadExportAssets(appInfo,files,assetFiles)}}}}};for(i=0;i<assetIDs.length;++i){if(i===assetIDs.length-1){requestingDownloads=false}var assetID=assetIDs[i];DBAssets.LoadID(assetID,new DownloadedFunction(assetID))}}else{this.DownloadExportAssets(appInfo,files,assetFiles)}};SceneProjectEditor.prototype.DownloadExportAssets=function(appInfo,files,assetFiles){if(assetFiles.length>0){var self=this;var numberOfDownloads=0;var DownloadedFunction=function(filename){return function(status,data){numberOfDownloads++;if(status>=CCURLRequest.Succeeded&&data&&data.length>0){AlertsManager.Notification("editor"+numberOfDownloads,"exporting "+filename,null,1);var file={};file.name=filename;file.data=data;files.push(file)}else{AlertsManager.Notification("error"+numberOfDownloads,"error exporting "+filename,null,10)
}if(assetFiles.length===numberOfDownloads){self.ExportZip(appInfo,files)}}};for(i=0;i<assetFiles.length;++i){var filename=assetFiles[i];gURLManager.requestURL(MultiplayerManager.GetAssetURL(filename),null,new DownloadedFunction(filename),0,null,null,null,true)}}else{this.ExportZip(appInfo,files)}};SceneProjectEditor.prototype.ExportZip=function(appInfo,files){var filename="GameData."+appInfo.id+".zip";var zip=new JSZip;zip.file("appinfo.json",JSON.stringify(appInfo));for(var i=0;i<files.length;++i){var file=files[i];zip.file(file.name,file.data)}var a=document.createElement("a");a.href=window.URL.createObjectURL(zip.generate({type:"blob"}));a.download=filename;a.style.display="none";document.body.appendChild(a);a.click();document.body.removeChild(a);AlertsManager.Hide("exporting...");AlertsManager.TimeoutAlert("exported "+filename,5)};function SceneProjectNew(parentScene,projectManager){this.construct();CC.SetJSLocationBarData("SceneProjectNew");this.controlsSwipeMomentum=true;this.projectManager=projectManager;{parentScene.linkScene(this);this.setParent(parentScene)}{var camera=gEngine.newSceneCamera(this,0);camera.setupViewport(0,0,1,1)}this.open=true;this.controlsEnabled=false;gEngine.addScene(this);var self=this;this.sceneUIBack=new SceneUIBack(this,function(){self.projectManager.openProjectsList();self.close()},true)}ExtendPrototype(SceneProjectNew,CCSceneAppUI);SceneProjectNew.prototype.setup=function(){var self=this;var camera=this.camera;camera.setCameraWidth(640,false);var tile;{tile=new CCTile3DButton(self);tile.setColour(gColour.set(1,0));tile.setDrawOrder(201);this.tileBackground=tile}this.appsList=[];this.addAppInfo({type:"overheadshooter",titleImage:"template_overheadshooter.jpg",name:"Overhead Shooter Template"});this.addAppInfo({id:"205",titleImage:"template_fighting.jpg",name:"Fighting Game Template"});this.addAppInfo({id:"126",titleImage:"template_helloworldjs.jpg",name:"Hello World.js"});this.addAppInfo({id:"375",titleImage:"template_helloworldui.jpg",name:"Hello World UI"});this.addAppInfo({titleImage:"template_actionrpg.jpg",name:"Action RPG Template",www:"http://igg.me/at/playir/x/3276321"});this.addAppInfo({titleImage:"template_rts.jpg",name:"RTS Template",www:"http://igg.me/at/playir/x/3276321"});this.addAppInfo({titleImage:"template_flightsim.jpg",name:"Flight Sim Template",www:"http://igg.me/at/playir/x/3276321"});this.addAppInfo({titleImage:"template_camelracer.png",name:"Camel Racer Template",www:"http://igg.me/at/playir/x/3276321"});this.addAppInfo({titleImage:"template_carracer.jpg",name:"Car Racer Template",www:"http://igg.me/at/playir/x/3276321"});this.requestResize()};SceneProjectNew.prototype.updateCamera=function(delta){var updated=this.CCSceneAppUI_updateCamera(delta);if(updated){var camera=this.camera;var tile,i;{tile=this.tileBackground;if(this.appsList.length>1){var unseenTileSize=camera.targetWidth-tile.collisionSize.width;tile.setPositionX(camera.currentLookAt[0]-camera.targetWidth*.5+tile.collisionBounds[0]);var sceneDistance=this.sceneRight-this.sceneLeft;sceneDistance=sceneDistance===0?1:sceneDistance;var scenePositionPercentage=(camera.currentLookAt[0]-this.sceneLeft)/sceneDistance;scenePositionPercentage=CC.FloatClamp(scenePositionPercentage,0,1);tile.translate(unseenTileSize*scenePositionPercentage,0,0)}else{tile.setPositionXY(camera.currentLookAt[0],camera.currentLookAt[1])}}}};SceneProjectNew.prototype.resize=function(){if(this.open){this.CCSceneAppUI_resize();var camera=this.camera;var tile,i;this.tileBackground.setupTexturedFit(camera.targetWidth,camera.targetHeight,true,EditorManager.GetBackground(),function(tile){var tileBackground=tile;tileBackground.setColourAlpha(.25,true);camera.flagUpdate()});var idealAspectRatio=1.5;var aspectRatioAdjutment=camera.getAspectRatio()<1.25?camera.getAspectRatio()/idealAspectRatio:1;var tileHeight=camera.targetHeight*.33*aspectRatioAdjutment;var appsList=this.appsList;for(i=0;i<appsList.length;++i){var app=appsList[i];var appTiles=app.tiles;if(appTiles.length>0){tile=appTiles[0];if(tile.getTileTextureImage()){tile.setTileTexturedHeight(tileHeight)}else{tile.setTileSize(tileHeight*1.5,tileHeight)}for(var j=1;j<appTiles.length;++j){tile=appTiles[j];tile.setTextHeight(tileHeight*.125,true);tile.positionTileBelow(appTiles[j-1])}}}this.show()}};SceneProjectNew.prototype.updateControls=function(controls){var usingControls=this.CCSceneAppUI_updateControls(controls);var cameraTouches=this.camera.cameraTouches;var touch=cameraTouches[0];if(touch.x>0&&touch.x<1&&touch.y>0&&touch.y<1&&touch.startX>0&&touch.startX<1&&touch.startY>0&&touch.startY<1){if(controls.wheel&&controls.wheel.delta!==0){this.cameraScrolling=true;var delta=controls.wheel.delta;this.touchCameraMoving(delta*.1,0);return true}}return usingControls};SceneProjectNew.prototype.touchMovementAllowed=function(touch,touchDelta){var absDeltaX=Math.abs(touch.totalDeltaX);var absDeltaY=Math.abs(touch.totalDeltaY);if(absDeltaX>CCControls.TouchMovementThreashold.x||absDeltaY>CCControls.TouchMovementThreashold.y){this.controlsMoving=true;touchDelta.x+=touch.totalDeltaX;touchDelta.y+=touch.totalDeltaY;this.controlsMovingVertical=false;return true}return false};SceneProjectNew.prototype.refreshCameraView=function(){this.sceneLeft=0;this.sceneRight=0;this.sceneTop=0;this.sceneBottom=0;var camera=this.camera;var appsList=this.appsList;var app,tile;if(appsList.length>1){app=appsList.last();tile=app.tiles[0];this.sceneRight=tile.getTileMovementTarget()[0]+tile.collisionBounds[0];this.sceneRight-=tile.collisionBounds[0]}};SceneProjectNew.prototype.lockCameraView=function(){if(this.cameraScrolling){return}var camera=this.camera;if(camera.targetLookAt[0]<this.sceneLeft){camera.targetLookAt[0]=this.sceneLeft;camera.flagUpdate()}else if(camera.targetLookAt[0]>this.sceneRight){camera.targetLookAt[0]=this.sceneRight;camera.flagUpdate()}var closestTile;var closestDistance=CC_MAXFLOAT;var appsList=this.appsList;for(var i=0;i<appsList.length;++i){var app=appsList[i];var tile=app.tiles[0];var distance=CC.Vector3Distance2D(tile.position,camera.targetLookAt,false);if(distance<closestDistance){closestDistance=distance;closestTile=tile}}if(closestTile){vec3.copy(camera.targetLookAt,closestTile.getTileMovementTarget());camera.flagUpdate()}};SceneProjectNew.prototype.show=function(){if(this.open){this.controlsEnabled=true;if(this.tileBackground.getTileTextureImage()){this.tileBackground.setColourAlpha(.25,true)}var camera=this.camera;var tile,i;var appsList=this.appsList;var padding=camera.targetWidth*.0125;var x=0;for(i=0;i<appsList.length;++i){var app=appsList[i];var appTiles=app.tiles;if(appTiles.length>0){var mainTile=appTiles[0];if(i>0){x+=mainTile.collisionBounds[0]}mainTile.setColourAlpha(1,true);mainTile.setCollideable(true);for(var j=0;j<appTiles.length;++j){tile=appTiles[j];if(x<camera.targetWidth){tile.setTileMovementX(x)}else{tile.setPositionX(x)}}x+=mainTile.collisionBounds[0];x+=padding}}this.refreshCameraView();this.lockCameraView()}};SceneProjectNew.prototype.close=function(){CC.RemoveJSLocationBarData("SceneProjectNew");this.open=false;for(var i=0;i<this.tiles.length;++i){var tile=this.tiles[i];tile.setColourAlpha(0,true);tile.setTextColourAlpha(0,true);tile.setCollideable(false)}var self=this;this.tileBackground.setColourAlpha(0,true,function(){self.deleteLater()})};SceneProjectNew.prototype.select=function(app){if(app.info.www){CCEngine.WebViewOpen(app.info.www);return}this.open=false;var tile;for(var i=0;i<this.tiles.length;++i){tile=this.tiles[i];tile.setColourAlpha(0,true);tile.setTextColourAlpha(0,true);tile.setCollideable(false)}var camera=this.camera;{tile=app.tiles[0];tile.setDrawOrder(300);vec3.copy(camera.targetLookAt,tile.getTileMovementTarget());camera.flagUpdate()}this.tileBackground.setColourAlpha(0,true);if(app.info.type==="overheadshooter"){AlertsManager.ModalAlert("creating...");MultiplayerManager.Emit("EditorProjectNew")}else if(app.info.id){if(MultiplayerManager.Emit("EditorProjectFork",app.info.id)){AlertsManager.ModalAlert("forking...")}}};SceneProjectNew.prototype.addAppInfo=function(info){var self=this;var camera=this.camera;var tiles=this.tiles;var appsList=this.appsList;var tile;var SelectFunction=function(info){return function(){self.select(app)}};var LoadImageFunction=function(tile,textureSrc){return function(textureHandle){if(textureHandle){tile.setTileTexture(textureSrc);self.requestResize()}}};var x=camera.currentLookAt[0]+camera.targetWidth;var app={};app.info=info;app.tiles=[];appsList.add(app);{tile=new CCTile3DButton(this);app.tiles.add(tile);tile.setupTile(1);var titleImage=info.titleImage?info.titleImage:SceneMultiManager.DefaultTitleImage;tile.setTileTexture(info.titleImage,function(tile,textureHandle){if(textureHandle){if(self.open){tile.setColourAlpha(1,true)}}});tile.setColour(gColour.set(1,0));tile.setCollideable(false);tile.setPositionX(x);tile.onRelease.push(new SelectFunction(app));this.addTile(tile)}{tile=new CCTile3DButton(this);app.tiles.add(tile);tile.setupText(info.name,1,true,false);tile.setTextColour(gColour.set(1,1));tile.setCollideable(false);tile.setPositionX(x);this.addTile(tile)}{tile=new CCTile3DButton(this);app.tiles.add(tile);if(!info.price){tile.setupText("",1,true,false)}else{tile.setupText("£"+info.price,1,true,false)}tile.setTextColour(gColour.set(1,1));tile.setCollideable(false);tile.setPositionX(x);this.addTile(tile)}var drawOrder=300;var duration=1;for(var i=0;i<appsList.length;++i){var appTiles=appsList[i].tiles;for(var j=0;j<appTiles.length;++j){tile=appTiles[j];tile.movementInterpolator.setDuration(duration);if(duration<2){duration+=.125}tile.setDrawOrder(drawOrder);if(drawOrder>205){drawOrder--}}}this.requestResize();return app};function SceneProjectsList(parentScene,onSelected,onNew,onBack){this.construct();this.cameraCentered=true;this.controlsSwipeMomentum=true;{parentScene.linkScene(this);this.setParent(parentScene)}{var camera=gEngine.newSceneCamera(this,0);camera.setupViewport(0,0,1,1)}this.onSelected=onSelected;this.onNew=onNew;this.open=true;this.controlsEnabled=false;gEngine.addScene(this);var self=this;this.dbApps=new DBApps;this.dbApps.load(function(appInfos){self.loadAppInfos(appInfos)},function(appInfo,removed){self.updatedAppInfo(appInfo,removed)});if(onBack){this.sceneUIBack=new SceneUIBack(this,function(){onBack();self.close()},true)}EditorManager.RefreshBackground()}ExtendPrototype(SceneProjectsList,CCSceneAppUI);SceneProjectsList.prototype.deleteLater=function(){if(this.dbApps){this.dbApps.destruct();this.dbApps=null}this.CCSceneAppUI_deleteLater()};SceneProjectsList.prototype.setup=function(){var self=this;var camera=this.camera;camera.setCameraWidth(640,false);var tile;{tile=new CCTile3DButton(self);tile.setColour(gColour.set(1,0));tile.setDrawOrder(201);this.tileBackground=tile}{tile=new CCTile3DButton(this,true);tile.setColour(gColour.set(.05,0));tile.setDrawOrder(204);this.tileAlert=tile;this.cameraStickyTiles.add(tile)}if(this.onNew){tile=new CCTile3DButton(self);tile.setupText("New\nProject",1,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.setColour(EditorManager.LightGreen);tile.setColourAlpha(0);tile.setTextColour(gColour.set(1,0));tile.setCollideable(false);tile.setDrawOrder(205);tile.onRelease.push(function(){self.onNew()});this.addTile(tile);this.tileNewProject=tile;tile=new CCTile3DButton(self);tile.setupText("User Guide",1,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.setColour(EditorManager.LightGrey);tile.setColourAlpha(0);tile.setTextColour(gColour.set(1,0));tile.setCollideable(false);tile.setDrawOrder(205);tile.onRelease.push(function(){CCEngine.WebViewOpen("http://playir.com/userguide")});this.addTile(tile);this.tileUserGuide=tile}this.gamesList=[];this.refreshCameraView();this.lockCameraView()};SceneProjectsList.prototype.updateCamera=function(delta){var updated=this.CCSceneAppUI_updateCamera(delta);if(updated){var camera=this.camera;var tile,i;{tile=this.tileBackground;if(this.gamesList.length>1){var unseenTileSize=camera.targetWidth-tile.collisionSize.width;tile.setPositionX(camera.currentLookAt[0]-camera.targetWidth*.5+tile.collisionBounds[0]);var sceneDistance=this.sceneRight-this.sceneLeft;sceneDistance=sceneDistance===0?1:sceneDistance;var scenePositionPercentage=(camera.currentLookAt[0]-this.sceneLeft)/sceneDistance;scenePositionPercentage=CC.FloatClamp(scenePositionPercentage,0,1);tile.translate(unseenTileSize*scenePositionPercentage,0,0)}else{tile.setPositionXY(camera.currentLookAt[0],camera.currentLookAt[1])}}if(this.tileUserGuide){var padding=camera.targetWidth*.0125;tile=this.tileUserGuide;tile.setPositionXY(camera.currentLookAt[0]+-(camera.targetWidth*.5)+(tile.collisionBounds[0]+padding),camera.currentLookAt[1]+camera.targetHeight*.5-(tile.collisionBounds[1]+padding))}}};SceneProjectsList.prototype.resize=function(){if(this.open){this.CCSceneAppUI_resize();var camera=this.camera;var tile,i;this.tileBackground.setupTexturedFit(camera.targetWidth,camera.targetHeight,true,EditorManager.GetBackground(),function(tile){var tileBackground=tile;tileBackground.setColourAlpha(.5,true);camera.flagUpdate()});{tile=this.tileAlert;tile.setTileSize(camera.targetWidth,camera.targetHeight*.375)}var idealAspectRatio=1.5;var aspectRatioAdjutment=camera.getAspectRatio()<1.25?camera.getAspectRatio()/idealAspectRatio:1;var tileHeight;tileHeight=camera.targetHeight*.25*aspectRatioAdjutment;if(this.tileNewProject){this.tileNewProject.setTileSize(tileHeight,tileHeight);this.tileNewProject.setTextHeight(tileHeight*.25)}if(this.tileUserGuide){this.tileUserGuide.setTileSize(tileHeight,tileHeight*.5);this.tileUserGuide.setTextHeight(tileHeight*.25)}var gamesList=this.gamesList;for(i=0;i<gamesList.length;++i){var game=gamesList[i];var gameTiles=game.tiles;if(gameTiles.length>0){tile=gameTiles[0];if(tile.getTileTextureImage()){tile.setTileTexturedHeight(tileHeight)}else{tile.setTileSize(tileHeight*1.5,tileHeight)}for(var j=1;j<gameTiles.length;++j){tile=gameTiles[j];tile.setTextHeight(tileHeight*.125,true);tile.positionTileBelow(gameTiles[j-1])}}}this.show()}};SceneProjectsList.prototype.updateControls=function(controls){var usingControls=this.CCSceneAppUI_updateControls(controls);var cameraTouches=this.camera.cameraTouches;var touch=cameraTouches[0];if(touch.x>0&&touch.x<1&&touch.y>0&&touch.y<1&&touch.startX>0&&touch.startX<1&&touch.startY>0&&touch.startY<1){if(controls.wheel&&controls.wheel.delta!==0){this.cameraScrolling=true;var delta=controls.wheel.delta;this.touchCameraMoving(delta*.1,0);return true}}return usingControls};SceneProjectsList.prototype.touchMovementAllowed=function(touch,touchDelta){var absDeltaX=Math.abs(touch.totalDeltaX);var absDeltaY=Math.abs(touch.totalDeltaY);if(absDeltaX>CCControls.TouchMovementThreashold.x||absDeltaY>CCControls.TouchMovementThreashold.y){this.controlsMoving=true;touchDelta.x+=touch.totalDeltaX;touchDelta.y+=touch.totalDeltaY;this.controlsMovingVertical=false;return true}return false};SceneProjectsList.prototype.refreshCameraView=function(){this.sceneLeft=0;this.sceneRight=0;this.sceneTop=0;this.sceneBottom=0;var camera=this.camera;var gamesList=this.gamesList;var game,tile;if(gamesList.length>1){game=gamesList.last();tile=game.tiles[0];this.sceneRight=tile.getTileMovementTarget()[0]+tile.collisionBounds[0];this.sceneRight-=tile.collisionBounds[0]}};SceneProjectsList.prototype.lockCameraView=function(){if(this.cameraScrolling){return}var camera=this.camera;if(camera.targetLookAt[0]<this.sceneLeft){camera.targetLookAt[0]=this.sceneLeft;camera.flagUpdate()}else if(camera.targetLookAt[0]>this.sceneRight){camera.targetLookAt[0]=this.sceneRight;camera.flagUpdate()}var closestTile;var closestDistance=CC_MAXFLOAT;var gamesList=this.gamesList;for(var i=0;i<gamesList.length;++i){var game=gamesList[i];var tile=game.tiles[0];var distance=CC.Vector3Distance2D(tile.position,camera.targetLookAt,false);if(distance<closestDistance){closestDistance=distance;closestTile=tile}}if(closestTile){vec3.copy(camera.targetLookAt,closestTile.getTileMovementTarget());camera.flagUpdate()}};SceneProjectsList.prototype.show=function(){if(this.open){this.controlsEnabled=true;if(this.tileBackground.getTileTextureImage()){this.tileBackground.setColourAlpha(.5,true)}this.tileAlert.setColourAlpha(.5,true);var camera=this.camera;var tile,i;if(this.tileNewProject){this.tileNewProject.setColourAlpha(1,true);this.tileNewProject.setTextColourAlpha(1,true);this.tileNewProject.setCollideable(true)}if(this.tileUserGuide){this.tileUserGuide.setColourAlpha(.5,true);this.tileUserGuide.setTextColourAlpha(1,true);this.tileUserGuide.setCollideable(true)}var gamesList=this.gamesList;var padding=camera.targetWidth*.0125;var x=0;for(i=0;i<gamesList.length;++i){var game=gamesList[i];var gameTiles=game.tiles;if(gameTiles.length>0){var mainTile=gameTiles[0];if(i>0){x+=mainTile.collisionBounds[0]}mainTile.setColourAlpha(1,true);mainTile.setCollideable(true);for(var j=0;j<gameTiles.length;++j){tile=gameTiles[j];if(x<camera.targetWidth){tile.setTileMovementX(x)}else{tile.setPositionX(x)}}x+=mainTile.collisionBounds[0];x+=padding}}if(this.tileNewProject){if(gamesList.length>0){this.tileNewProject.positionTileLeftX(gamesList[0].tiles[0]);this.tileNewProject.translate(-padding)}}this.refreshCameraView();this.lockCameraView()}};SceneProjectsList.prototype.close=function(shouldDelete){if(shouldDelete===undefined){shouldDelete=true}this.open=false;for(var i=0;i<this.tiles.length;++i){var tile=this.tiles[i];tile.setColourAlpha(0,true);tile.setTextColourAlpha(0,true);tile.setCollideable(false)}this.tileAlert.setColourAlpha(0,true);if(shouldDelete){var self=this;this.tileBackground.setColourAlpha(0,true,function(){self.deleteLater()})}};SceneProjectsList.prototype.selectGame=function(game){this.close(false);var camera=this.camera;{tile=game.tiles[0];tile.setDrawOrder(300);vec3.copy(camera.targetLookAt,tile.getTileMovementTarget());camera.flagUpdate()}var self=this;this.tileBackground.setColourAlpha(0,true,function(){self.onSelected(game.appInfo);self.deleteLater()})};SceneProjectsList.prototype.addAppInfo=function(appInfo){var self=this;var camera=this.camera;var tiles=this.tiles;var gamesList=this.gamesList;var tile;var SelectGameFunction=function(game){return function(){self.selectGame(game)}};var LoadImageFunction=function(tile,textureSrc){return function(textureHandle){if(textureHandle){tile.setTileTexture(textureSrc);self.requestResize()}}};var x=camera.currentLookAt[0]+camera.targetWidth;var game={};game.appInfo=appInfo;game.tiles=[];gamesList.add(game);{tile=new CCTile3DButton(this);game.tiles.add(tile);tile.setupTile(1);var titleImage=appInfo.titleImage?appInfo.titleImage:SceneMultiManager.DefaultTitleImage;tile.setTileTexture(appInfo.titleImage,function(tile,textureHandle){if(textureHandle){if(self.open){tile.setColourAlpha(1,true)}}});tile.setColour(gColour.set(1,0));tile.setCollideable(false);tile.setPositionX(x);tile.onRelease.push(new SelectGameFunction(game));this.addTile(tile)}{tile=new CCTile3DButton(this);game.tiles.add(tile);var name=appInfo.name;if(!appInfo.open){name+=" (Unpublished)"}tile.setupText(name,1,true,false);tile.setTextColour(gColour.set(1,1));tile.setCollideable(false);tile.setPositionX(x);this.addTile(tile)}var drawOrder=300;var duration=1;for(var i=0;i<gamesList.length;++i){var gameTiles=gamesList[i].tiles;for(var j=0;j<gameTiles.length;++j){tile=gameTiles[j];tile.movementInterpolator.setDuration(duration);if(duration<2){duration+=.125}tile.setDrawOrder(drawOrder);if(drawOrder>205){drawOrder--}}}this.requestResize();return game};SceneProjectsList.prototype.loadAppInfos=function(appInfos){var self=this;var camera=this.camera;var tiles=this.tiles;var gamesList=this.gamesList;var GameCompare=function(appInfo){if(appInfo.id==="androids"){return 101}else if(appInfo.id==="tanks"){return 102}else if(appInfo.id==="burgers"){return 103}else if(appInfo.id==="space"){return 104}else if(MultiplayerManager.IsOwner(appInfo.owners)){if(appInfo.jsFiles){return 100-appInfo.jsFiles.length}return 100}else if(appInfo.jsFiles){return 105}return 1e3};appInfos.sort(function(a,b){var scoreA=GameCompare(a);var scoreB=GameCompare(b);if(scoreA===scoreB){return a.id-b.id}return scoreA-scoreB});var game,tile;var i,j;for(i=0;i<appInfos.length;++i){var appInfo=appInfos[i];game=null;if(gamesList.length>i){game=gamesList[i]}if(game){if(game.appInfo.id===appInfo.id){tile=game.tiles[0];tile.setTileTexture(appInfo.titleImage);continue}else{for(j=0;j<game.tiles.length;++j){tile=game.tiles[j];tiles.remove(tile);tile.deleteLater()}gamesList.remove(game)}}if(MultiplayerManager.IsOwner(appInfo.owners)){game=this.addAppInfo(appInfo);gamesList.insert(game,i)}}while(gamesList.length>appInfos.length){game=gamesList[appInfos.length];for(j=0;j<game.tiles.length;++j){tile=game.tiles[j];tiles.remove(tile);tile.deleteLater()}gamesList.remove(game)}this.requestResize()};SceneProjectsList.prototype.updatedAppInfo=function(appInfo,removed){var self=this;var camera=this.camera;var gamesList=this.gamesList;var i,game,tile;var LoadImageFunction=function(tile,textureSrc){return function(textureHandle){if(textureHandle){tile.setTileTexture(textureSrc);self.requestResize()}}};for(i=0;i<gamesList.length;++i){game=gamesList[i];if(game.appInfo.id===appInfo.id){if(removed){for(var j=0;j<game.tiles.length;++j){tile=game.tiles[j];this.tiles.remove(tile);tile.deleteLater()}gamesList.remove(game);this.requestResize()}else{tile=game.tiles[0];if(appInfo.titleImage){gEngine.textureManager.getTextureHandle(appInfo.titleImage,new LoadImageFunction(tile,appInfo.titleImage))}var name=appInfo.name;if(!appInfo.open){name+=" (Unpublished)"}game.tiles[1].setText(name)}return}}if(!removed){this.addAppInfo(appInfo)}};function SceneProjectManagerList(parentScene,projectManager){this.construct();this.projectManager=projectManager;{parentScene.linkScene(this);this.setParent(parentScene)}{var camera=gEngine.newSceneCamera(this,0);camera.setupViewport(0,0,1,1)}this.open=true;this.controlsEnabled=false;gEngine.addScene(this);var self=this;this.projectsList=new SceneProjectsList(parentScene,function(appInfo){self.hide();projectManager.onEditGame(appInfo)},function(){self.hide();projectManager.onNewProject()});this.resize()}ExtendPrototype(SceneProjectManagerList,CCSceneAppUI);SceneProjectManagerList.prototype.deleteLater=function(){this.CCSceneAppUI_deleteLater()};SceneProjectManagerList.prototype.setup=function(){var self=this;var camera=this.camera;camera.setCameraWidth(640,false);var tile;var buttons=this.buttons=[];{tile=new CCTile3DButton(self);tile.setupText("Levels",1,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.setColour(gColour.set(.5,0));tile.setColourAlpha(0);tile.setTextColour(gColour.set(1,0));tile.setCollideable(false);tile.setDrawOrder(205);tile.onRelease.push(function(){self.projectManager.onEditMaps()});this.addTile(tile);buttons.push(tile)}{tile=new CCTile3DButton(self);tile.setupText("Images",1,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.setColour(gColour.set(.5,0));tile.setColourAlpha(0);tile.setTextColour(gColour.set(1,0));tile.setCollideable(false);tile.setDrawOrder(205);tile.onRelease.push(function(){self.projectManager.onEditImages()});this.addTile(tile);buttons.push(tile)}{tile=new CCTile3DButton(self);tile.setupText("Models",1,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.setColour(gColour.set(.5,0));tile.setColourAlpha(0);tile.setTextColour(gColour.set(1,0));tile.setCollideable(false);tile.setDrawOrder(205);tile.onRelease.push(function(){self.projectManager.onEditModels()});this.addTile(tile);buttons.push(tile)}{tile=new CCTile3DButton(self);tile.setupText("Characters",1,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.setColour(gColour.set(.5,0));tile.setColourAlpha(0);tile.setTextColour(gColour.set(1,0));tile.setCollideable(false);tile.setDrawOrder(205);tile.onRelease.push(function(){self.projectManager.onEditCharacters()});this.addTile(tile);buttons.push(tile)}{tile=new CCTile3DButton(self);tile.setupText("Audio",1,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.setColour(gColour.set(.5,0));tile.setColourAlpha(0);tile.setTextColour(gColour.set(1,0));tile.setCollideable(false);tile.setDrawOrder(205);tile.onRelease.push(function(){self.projectManager.onEditAudio()});this.addTile(tile);buttons.push(tile)}this.refreshCameraView();this.lockCameraView()};SceneProjectManagerList.prototype.updateCamera=function(delta){var updated=this.CCSceneAppUI_updateCamera(delta);if(updated){var camera=this.camera;var tile,i;var buttons=this.buttons;var totalWidth=0;for(i=0;i<buttons.length;++i){tile=buttons[i];totalWidth+=tile.collisionSize.width}var x=camera.currentLookAt[0]-totalWidth*.5;for(i=0;i<buttons.length;++i){tile=buttons[i];x+=tile.collisionBounds[0];tile.setPositionXY(x,camera.currentLookAt[1]-camera.targetHeight*.4);x+=tile.collisionBounds[0]}}};SceneProjectManagerList.prototype.resize=function(){if(this.open){this.CCSceneAppUI_resize();var camera=this.camera;var tile,i;var idealAspectRatio=1.5;var aspectRatioAdjutment=camera.getAspectRatio()<1.25?camera.getAspectRatio()/idealAspectRatio:1;var tileHeight;tileHeight=camera.targetHeight*.05*aspectRatioAdjutment;var buttons=this.buttons;for(i=0;i<buttons.length;++i){tile=buttons[i];tile.setTextHeight(tileHeight,true);var width=tile.collisionSize.width*1.5;if(width<25){width=25}tile.setTileSize(width,tile.collisionSize.height*1.2)}this.show()}};SceneProjectManagerList.prototype.updateControls=function(controls){var usingControls=this.CCSceneAppUI_updateControls(controls);return usingControls};SceneProjectManagerList.prototype.touchMovementAllowed=function(touch,touchDelta){return false};SceneProjectManagerList.prototype.refreshCameraView=function(){this.sceneLeft=0;this.sceneRight=0;this.sceneTop=0;this.sceneBottom=0};SceneProjectManagerList.prototype.lockCameraView=function(){if(this.cameraScrolling){return}var camera=this.camera;if(camera.targetLookAt[0]<this.sceneLeft){camera.targetLookAt[0]=this.sceneLeft;camera.flagUpdate()}else if(camera.targetLookAt[0]>this.sceneRight){camera.targetLookAt[0]=this.sceneRight;camera.flagUpdate()}};SceneProjectManagerList.prototype.show=function(){if(this.open){this.controlsEnabled=true;this.projectsList.show();var camera=this.camera;var tile,i;var buttons=this.buttons;for(i=0;i<buttons.length;++i){tile=buttons[i];tile.setColourAlpha(1,true);tile.setTextColourAlpha(1,true);tile.setCollideable(true)}this.refreshCameraView();this.lockCameraView()}};SceneProjectManagerList.prototype.close=function(){this.open=false;this.hide();this.projectsList.close()};SceneProjectManagerList.prototype.hide=function(){for(var i=0;i<this.tiles.length;++i){var tile=this.tiles[i];tile.setColourAlpha(0,true);tile.setTextColourAlpha(0,true);tile.setCollideable(false);tile.setTileMovementY(-this.camera.targetHeight)}};function SceneProjectManagerUI(projectManager){this.construct();{this.projectManager=projectManager;projectManager.linkScene(this);this.linkScene(projectManager)}{var parentCameraIndex=gEngine.findCameraIndex(projectManager.camera);var camera=gEngine.newSceneCamera(this,parentCameraIndex+1);camera.setupViewport(0,0,1,1)}this.sceneMultiLauncher=new SceneMultiUILauncher(this);this.sceneLogin=null;this.sceneProjectsList=null}ExtendPrototype(SceneProjectManagerUI,CCSceneAppUI);SceneProjectManagerUI.prototype.deleteLater=function(){this.close();this.CCSceneAppUI_deleteLater();if(this.sceneMultiLauncher){this.sceneMultiLauncher.hide(true);this.sceneMultiLauncher=null}};SceneProjectManagerUI.prototype.setup=function(){var self=this;var camera=this.camera;camera.setCameraWidth(640,false);this.requestResize()};SceneProjectManagerUI.prototype.deletingChild=function(inScene){if(inScene===this.sceneMultiLauncher){this.hideLogin()}this.CCSceneAppUI_deletingChild(inScene)};SceneProjectManagerUI.prototype.touchMoving=function(touch,touchDelta){return false};SceneProjectManagerUI.prototype.close=function(){this.closeProjectsList();this.closeProjectEditor();this.closeAssetEditor()};SceneProjectManagerUI.prototype.showLogin=function(){if(!this.sceneLogin){this.sceneLogin=new SceneMultiUILogin(this,this.multiManager)}};SceneProjectManagerUI.prototype.hideLogin=function(){if(this.sceneLogin){this.sceneLogin.close();this.sceneLogin=null}};SceneProjectManagerUI.prototype.openProjectsList=function(){if(this.projectEditor){this.closeProjectEditor()}if(this.sceneProjectsList){this.closeProjectsList()}this.sceneProjectsList=new SceneProjectManagerList(this,this.projectManager);this.sceneMultiLauncher.show();this.showLogin();if(MultiplayerManager.LoggedIn&&!MultiplayerManager.IsUserLoggedIn()){var ownedApps=DBApps.GetOwnedApps();if(ownedApps.length>0){var self=this;AlertsManager.Notification("","Login to save projects",function(){new SceneProfileLogin},10,EditorManager.LightRed)}}};SceneProjectManagerUI.prototype.closeProjectsList=function(){this.hideLogin();if(this.sceneProjectsList){this.sceneProjectsList.close();this.sceneProjectsList=null}if(this.sceneMultiLauncher){this.sceneMultiLauncher.hide()}};SceneProjectManagerUI.prototype.openNewProject=function(){if(!this.projectNew){this.projectNew=new SceneProjectNew(this,this.projectManager)}};SceneProjectManagerUI.prototype.openProjectEditor=function(appInfo,checkForChangesBeforeReOpen){if(this.projectNew){this.projectNew.close()}if(this.projectEditor){if(checkForChangesBeforeReOpen){var currentAppInfo=this.projectEditor.appInfo;if(appInfo.id===currentAppInfo.id){if(CC.DeepEquals(currentAppInfo,appInfo)){return}}}this.projectEditor.setupAppInfo(appInfo,false);return}this.projectEditor=new SceneProjectEditor(this,this.projectManager,appInfo)};SceneProjectManagerUI.prototype.closeProjectEditor=function(){if(this.projectEditor){this.projectEditor.close(false);this.projectEditor=null}};SceneProjectManagerUI.prototype.openAssetEditor=function(title,supportObj,callback){if(this.sceneAssetEditor){this.closeAssetEditor()}this.sceneAssetEditor=new SceneAssetEditor(this,supportObj,true);this.sceneAssetEditor.open(title);if(callback){this.sceneAssetEditor.onClose=callback}};SceneProjectManagerUI.prototype.closeAssetEditor=function(){if(this.sceneAssetEditor){this.sceneAssetEditor.close();this.sceneAssetEditor=null}};SceneProjectManagerUI.prototype.editAsset=function(src){if(src){this.sceneAssetEditor.setAsset(src)}};SceneProjectManagerUI.prototype.openVisualJSEditor=function(filename,onClose){this.closeVisualJSEditor();this.sceneVisualJSEditor=new SceneVisualJSEditor(this);this.sceneVisualJSEditor.open(filename,onClose);return true};SceneProjectManagerUI.prototype.closeVisualJSEditor=function(){if(this.sceneVisualJSEditor){this.sceneVisualJSEditor.close(false);this.sceneVisualJSEditor=null}};function SceneProjectManager(){CCAudioManager.Enabled=true;this.construct()}ExtendPrototype(SceneProjectManager,SceneManagerPlay);SceneProjectManager.prototype.construct=function(){this.SceneManagerPlay_construct();this.sceneUI=new SceneProjectManagerUI(this);gEngine.addScene(this.sceneUI);var self=this;this.dbApps=new DBApps;this.dbApps.load(function(appInfos){AlertsManager.Hide("connecting...");if(self.sceneUI.projectEditor){var currentAppInfo=self.sceneUI.projectEditor.appInfo;for(var i=0;i<appInfos.length;++i){var appInfo=appInfos[i];if(appInfo.id===currentAppInfo.id){self.sceneUI.openProjectEditor(appInfo,true);return}}}},function(appInfo,removed){self.updatedAppInfo(appInfo,removed)});if(!MultiplayerManager.LoggedIn){this.syncDisconnected()}gEngine.addScene(this);this.openProjectsList()};SceneProjectManager.prototype.deleteLater=function(){if(this.dbApps){this.dbApps.destruct();this.dbApps=null}this.SceneManagerPlay_deleteLater();if(this.sceneUI){this.sceneUI.close();this.sceneUI=null}};SceneProjectManager.prototype.setup=function(){this.SceneManagerPlay_setup();this.camera.enabled=false};SceneProjectManager.prototype.syncDisconnected=function(){if(!MultiplayerManager.ForceDisconnected){if(this.dbApps){AlertsManager.ModalAlert("connecting...",2)
}}};SceneProjectManager.prototype.syncLoggedIn=function(){this.SceneManagerPlay_syncLoggedIn();if(CC.GetJSLocationBarData("SceneProjectEditor")){var gameID=CC.GetJSLocationBarData("SceneProjectEditor");this.onEditGameID(gameID)}else if(CC.GetJSLocationBarData("SceneProjectNew")){this.onNewProject()}else if(CC.GetJSLocationBarData("SceneMapsManager")){this.onEditMaps()}else if(CC.GetJSLocationBarData("SceneTemplateUIManager")){this.onEditUI()}else if(CC.GetJSLocationBarData("SceneModelsManager")){this.onEditModels()}else if(CC.GetJSLocationBarData("SceneImagesManager")){this.onEditImages()}else if(CC.GetJSLocationBarData("SceneCharactersManager")){this.onEditCharacters()}else if(CC.GetJSLocationBarData("SceneAudioManager")){this.onEditAudio()}};SceneProjectManager.prototype.syncLoggedIntoSocialNetwork=function(network){this.sceneUI.hideLogin();this.sceneUI.showLogin()};SceneProjectManager.prototype.updatedAppInfo=function(appInfo,removed){if(this.sceneUI.projectEditor){var currentAppInfo=this.sceneUI.projectEditor.appInfo;if(appInfo.id===currentAppInfo.id){if(removed){this.sceneUI.closeProjectEditor();this.openProjectsList()}else{this.sceneUI.openProjectEditor(appInfo,true)}return}}};SceneProjectManager.prototype.syncUpdate=function(jsonData){if(jsonData.EditorProjectNew){if(!this.sceneUI.projectEditor){AlertsManager.Hide("creating...");this.sceneUI.openProjectEditor(jsonData.EditorProjectNew)}}else if(jsonData.EditorProjectImport){if(!this.sceneUI.projectEditor){AlertsManager.Hide("forking...");AlertsManager.Hide("importing...");this.sceneUI.openProjectEditor(jsonData.EditorProjectImport)}}else if(jsonData.EditorProjectEdited!==undefined){AlertsManager.Hide("updating...");if(jsonData.appInfo){this.sceneUI.openProjectEditor(jsonData.appInfo)}}else if(jsonData.AppsRequestInfo!==undefined){this.onEditGame(jsonData.AppsRequestInfo)}};SceneProjectManager.prototype.onNewProject=function(){this.sceneUI.closeProjectsList();this.sceneUI.openNewProject()};SceneProjectManager.prototype.onEditMaps=function(){this.deleteLater();gEngine.addScene(new SceneMapsManager)};SceneProjectManager.prototype.onEditUI=function(uiID,onSelect,onClose){this.deleteLater();new SceneTemplateUIManager(uiID,onSelect,onClose)};SceneProjectManager.prototype.onEditCharacters=function(){this.deleteLater();gEngine.addScene(new SceneCharactersManager)};SceneProjectManager.prototype.onEditImages=function(){this.deleteLater();gEngine.addScene(new SceneImagesManager)};SceneProjectManager.prototype.onEditModels=function(){this.deleteLater();gEngine.addScene(new SceneModelsManager)};SceneProjectManager.prototype.onEditAudio=function(){this.deleteLater();gEngine.addScene(new SceneAudioManager)};SceneProjectManager.prototype.onEditGameID=function(gameID){CC.SetJSLocationBarData("SceneProjectEditor",gameID);MultiplayerManager.Emit("AppsRequestInfo",gameID)};SceneProjectManager.prototype.onEditGame=function(appInfo){AlertsManager.Hide("loading...");if(appInfo){this.sceneUI.closeProjectsList();this.sceneUI.openProjectEditor(appInfo)}else{AlertsManager.TimeoutAlert("unable to load game info :(",2)}};SceneProjectManager.prototype.openProjectsList=function(){this.sceneUI.openProjectsList()};SceneProjectManager.prototype.onGameEditJSStart=function(appInfo){var self=this;AlertsManager.InputAlert(appInfo.jsStart?appInfo.jsStart:"",function(result){if(result){if(appInfo.jsStart!==result){appInfo.jsStart=result;if(MultiplayerManager.Emit("EditorProjectEditJSStart",appInfo.id,appInfo.jsStart)){AlertsManager.ModalAlert("updating...");self.sceneUI.openProjectEditor(appInfo)}}}})};SceneProjectManager.prototype.onVisualJSEditor=function(appInfo,filename){if(MultiplayerManager.LoggedIn){var self=this;this.sceneUI.closeProjectEditor();this.sceneUI.openVisualJSEditor(filename,function(){self.sceneUI.openProjectEditor(appInfo)})}};SceneProjectManager.prototype.onGameRestart=function(appInfo,softRestart){if(MultiplayerManager.LoggedIn){softRestart=!!softRestart;MultiplayerManager.Emit("EditorProjectRestart",appInfo.id,softRestart)}};SceneProjectManager.prototype.onGameEditPlayerType=function(appInfo,playerTypeInfo){var self=this;var cameraX=this.sceneUI.projectEditor.camera.targetLookAt[0];var cameraY=this.sceneUI.projectEditor.camera.targetLookAt[1];this.sceneUI.closeProjectEditor();function OnResultFunction(modelInfo){if(MultiplayerManager.LoggedIn){if(modelInfo){if(modelInfo.obj&&modelInfo.tex){if(!playerTypeInfo||playerTypeInfo.obj!==modelInfo.obj||playerTypeInfo.tex!==modelInfo.tex){if(playerTypeInfo){playerTypeInfo.obj=modelInfo.obj;playerTypeInfo.tex=modelInfo.tex}if(MultiplayerManager.Emit("EditorProjectEditPlayerType",appInfo.id,playerTypeInfo?playerTypeInfo.type:null,modelInfo.obj,modelInfo.tex)){AlertsManager.ModalAlert("updating...")}}}else{AlertsManager.TimeoutAlert("a 3d model and texture is required",2);self.onGameEditPlayerType(appInfo,null);return}}self.sceneUI.openProjectEditor(appInfo);self.sceneUI.projectEditor.camera.targetLookAt[0]=cameraX;self.sceneUI.projectEditor.camera.targetLookAt[1]=cameraY}}this.sceneUI.openAssetEditor(playerTypeInfo?"Edit Player Model":"New Player Model",true,function(modelInfo){OnResultFunction(modelInfo)});this.sceneUI.editAsset(playerTypeInfo.obj);this.sceneUI.editAsset(playerTypeInfo.tex)};SceneProjectManager.prototype.onGameEditPlayerIcon=function(appInfo,playerTypeInfo){var self=this;if(playerTypeInfo){var cameraX=this.sceneUI.projectEditor.camera.targetLookAt[0];var cameraY=this.sceneUI.projectEditor.camera.targetLookAt[1];this.sceneUI.closeProjectEditor();this.sceneUI.openAssetEditor("Edit Player Icon",false,function(tex){if(MultiplayerManager.LoggedIn){if(tex){if(playerTypeInfo.icon!==tex){playerTypeInfo.icon=tex;if(MultiplayerManager.Emit("EditorProjectEditPlayerIcon",appInfo.id,playerTypeInfo.type,tex)){AlertsManager.ModalAlert("updating...")}}}self.sceneUI.openProjectEditor(appInfo);self.sceneUI.projectEditor.camera.targetLookAt[0]=cameraX;self.sceneUI.projectEditor.camera.targetLookAt[1]=cameraY}});this.sceneUI.editAsset(playerTypeInfo.icon)}};function EditorManager(){}EditorManager.Red=(new CCColour).setRGBA(.5,0,0,1);EditorManager.LightRed=(new CCColour).setRGBA(.75,.25,.25,1);EditorManager.LightGreen=(new CCColour).setRGBA(.25,.75,.25,1);EditorManager.LightBlue=(new CCColour).setRGBA(.25,.5,.75,1);EditorManager.LightYellow=(new CCColour).setRGBA(.75,.75,.25,1);EditorManager.LightGrey=(new CCColour).set(.75,1);EditorManager.Green=(new CCColour).setRGBA(.125,.75,0,.9);EditorManager.Red=(new CCColour).setRGBA(.75,.125,0,1);EditorManager.RefreshBackground=function(){var images=["blackhole_background","collide_background","greenearth_background"];var random=CC.Random(images.length-1);this.backgroundImage=images[random]+".jpg";gEngine.textureManager.getTextureHandle(this.backgroundImage)};EditorManager.GetBackground=function(){if(!this.backgroundImage){this.RefreshBackground()}return this.backgroundImage};EditorManager.syncUpdate=function(jsonData){if(jsonData.EditorAudioDeleted){AlertsManager.Hide("deleting...")}else if(jsonData.EditorModelDeleted){AlertsManager.Hide("deleting...")}else if(jsonData.EditorImageDeleted){AlertsManager.Hide("deleting...")}else if(jsonData.EditorCharacterDeleted){AlertsManager.Hide("deleting...")}};EditorManager.EditorDeleteAudio=function(info){if(MultiplayerManager.Emit("EditorAudioDelete",info.id)){MultiplayerManager.UpdateCallbacks.addOnce(this);AlertsManager.ModalAlert("deleting...")}};EditorManager.EditorDeleteModel=function(info){if(MultiplayerManager.Emit("EditorModelDelete",info.objectID)){MultiplayerManager.UpdateCallbacks.addOnce(this);AlertsManager.ModalAlert("deleting...")}};EditorManager.EditorDeleteImage=function(info){if(MultiplayerManager.Emit("EditorImageDelete",info.objectID)){MultiplayerManager.UpdateCallbacks.addOnce(this);AlertsManager.ModalAlert("deleting...")}};EditorManager.EditorDeleteCharacter=function(info){if(MultiplayerManager.Emit("EditorCharacterDelete",info.objectID)){MultiplayerManager.UpdateCallbacks.addOnce(this);AlertsManager.ModalAlert("deleting...")}};EditorManager.EditorUploadJS=function(filename,data,callback,showAlert){if(showAlert===undefined){showAlert=true}if(showAlert){AlertsManager.Notification("editor","uploading...")}var url=SERVER_ASSETS_URL+"assets/upload.php";var postData={filename:filename};if(CCEngine.NativeUpdateCommands===undefined){postData.file=new Blob([data],{type:"text/plain"})}else{postData.file=data}if(MultiplayerManager.UseURLProxy(url)){postData.url=url;url=SERVER_ROOT+"backend/helper.php?uploadfile"}var fileID=filename;gURLManager.requestURL(url,postData,function(status,responseText){if(showAlert){AlertsManager.Hide("uploading...")}if(status>=CCURLRequest.Succeeded){if(responseText){var filename=responseText;if(callback){callback(fileID,filename)}}}},1)};EditorManager.EditorUploadFile=function(filename,data,callback,showAlert){if(showAlert===undefined){showAlert=true}if(showAlert){AlertsManager.ModalAlert("uploading...")}md5Async(data,function(hash){var url=SERVER_ASSETS_URL+"assets/upload.php?hash="+hash;var postData={filename:filename};if(MultiplayerManager.UseURLProxy(url)){postData.url=url;url=SERVER_ROOT+"backend/helper.php?post"}var uploadFilename=filename;gURLManager.requestURL(url,postData,function(status,newFilename){if(showAlert){AlertsManager.Hide("uploading...")}if(status>=CCURLRequest.Succeeded){if(newFilename&&newFilename.length>4){callback(uploadFilename,newFilename);return}}EditorManager.EditorUploadFileData(filename,data,callback,showAlert)},1)})};EditorManager.EditorUploadFileData=function(filename,data,callback,showAlert){if(showAlert===undefined){showAlert=true}if(showAlert){AlertsManager.ModalAlert("uploading...")}var url=SERVER_ASSETS_URL+"assets/upload.php";var postData={filename:filename};postData.file=new Blob([data]);if(MultiplayerManager.UseURLProxy(url)){postData.url=url;url=SERVER_ROOT+"backend/helper.php?uploadfile"}var uploadFilename=filename;gURLManager.requestURL(url,postData,function(status,newFilename){if(showAlert){AlertsManager.Hide("uploading...")}if(status>=CCURLRequest.Succeeded){if(newFilename&&newFilename.length>0){if(window.DEBUG_IsLocalClient){console.log("Uploaded",uploadFilename,"as",newFilename)}callback(uploadFilename,newFilename);return}}callback(uploadFilename,false)},1)};function SceneMultiUIGamesList(parentScene){this.construct();this.cameraCentered=true;this.controlsSwipeMomentum=true;{parentScene.linkScene(this);this.setParent(parentScene)}{var camera=gEngine.newSceneCamera(this,0);camera.setupViewport(0,0,1,1)}this.open=true;this.controlsEnabled=false;this.cameraCentered=true;EditorManager.RefreshBackground();gEngine.addScene(this)}ExtendPrototype(SceneMultiUIGamesList,CCSceneAppUI);SceneMultiUIGamesList.prototype.setup=function(){var self=this;var camera=this.camera;camera.setCameraWidth(200,false);var tile;{tile=new CCTile3DButton(self);tile.setColour(gColour.set(1,0));tile.setDrawOrder(98);this.tileBackground=tile}this.tileAlerts=[];for(var i=0;i<2;++i){tile=new CCTile3DButton(this,true);tile.setColour(gColour.set(.05,0));tile.setDrawOrder(99);this.tileAlerts.push(tile)}this.gamesList=[]};SceneMultiUIGamesList.prototype.updateCamera=function(delta){var updated=this.CCSceneAppUI_updateCamera(delta);if(updated){var camera=this.camera;var tile=this.tileBackground;if(this.gamesList.length>1){var unseenTileSize=camera.targetWidth-tile.collisionSize.width;tile.setPositionXY(camera.currentLookAt[0]-camera.targetWidth*.5+tile.collisionBounds[0],camera.currentLookAt[1]);var sceneDistance=this.sceneRight-this.sceneLeft;sceneDistance=sceneDistance===0?1:sceneDistance;var scenePositionPercentage=(camera.currentLookAt[0]-this.sceneLeft)/sceneDistance;scenePositionPercentage=CC.FloatClamp(scenePositionPercentage,0,1);tile.translate(unseenTileSize*scenePositionPercentage,0,0)}else{tile.setPositionXY(camera.currentLookAt[0],camera.currentLookAt[1])}for(var i=0;i<this.tileAlerts.length;++i){tile=this.tileAlerts[i];tile.setPositionX(camera.currentLookAt[0])}}};SceneMultiUIGamesList.prototype.resize=function(){if(this.open){var self=this;this.CCSceneAppUI_resize();var camera=this.camera;var tile,i;this.tileBackground.setupTexturedFit(camera.targetWidth,camera.targetHeight,true,EditorManager.GetBackground(),function(tile){if(self.showing){var tileBackground=tile;tileBackground.setColourAlpha(.5,true)}camera.flagUpdate()});var idealAspectRatio=1.5;var aspectRatioAdjutment=camera.getAspectRatio()<1.25?camera.getAspectRatio()/idealAspectRatio:1;var tileHeight=camera.targetHeight*.3*aspectRatioAdjutment;var altRow=false;for(i=0;i<this.tileAlerts.length;++i){tile=this.tileAlerts[i];tile.setTileSize(camera.targetWidth,camera.targetHeight*.375);tile.setPositionY(altRow?-tileHeight*.66:tileHeight*.66);altRow=!altRow}var gamesList=this.gamesList;for(i=0;i<gamesList.length;++i){var game=gamesList[i];var gameTiles=game.tiles;if(gameTiles.length>0){gameTiles[0].setPositionY(altRow?-tileHeight*.66:tileHeight*.66);gameTiles[0].setTileSize(tileHeight*1.5,tileHeight);for(var j=1;j<gameTiles.length;++j){tile=gameTiles[j];tile.setTextHeight(tileHeight*.125,true);tile.positionTileBelow(gameTiles[j-1])}}altRow=!altRow}if(this.showing){this.show()}}};SceneMultiUIGamesList.prototype.updateControls=function(controls){var usingControls=this.CCSceneAppUI_updateControls(controls);var cameraTouches=this.camera.cameraTouches;var touch=cameraTouches[0];if(touch.x>0&&touch.x<1&&touch.y>0&&touch.y<1&&touch.startX>0&&touch.startX<1&&touch.startY>0&&touch.startY<1){if(controls.wheel&&controls.wheel.delta!==0){this.cameraScrolling=true;var delta=controls.wheel.delta;this.touchCameraMoving(delta*.1,0);return true}}return usingControls};SceneMultiUIGamesList.prototype.touchMovementAllowed=function(touch,touchDelta){var absDeltaX=Math.abs(touch.totalDeltaX);var absDeltaY=Math.abs(touch.totalDeltaY);if(absDeltaX>CCControls.TouchMovementThreashold.x||absDeltaY>CCControls.TouchMovementThreashold.y){this.controlsMoving=true;touchDelta.x+=touch.totalDeltaX;touchDelta.y+=touch.totalDeltaY;this.controlsMovingVertical=false;return true}return false};SceneMultiUIGamesList.prototype.refreshCameraView=function(){this.sceneLeft=0;this.sceneRight=0;this.sceneTop=0;this.sceneBottom=0;var camera=this.camera;var gamesList=this.gamesList;var game,tile;if(gamesList.length>1){game=gamesList.last();tile=game.tiles[0];this.sceneRight=tile.getTileMovementTarget()[0]+tile.collisionBounds[0];this.sceneRight-=tile.collisionBounds[0]}};SceneMultiUIGamesList.prototype.lockCameraView=function(){if(this.cameraScrolling){return}var camera=this.camera;if(camera.targetLookAt[0]<this.sceneLeft){camera.targetLookAt[0]=this.sceneLeft;camera.flagUpdate()}else if(camera.targetLookAt[0]>this.sceneRight){camera.targetLookAt[0]=this.sceneRight;camera.flagUpdate()}if(this.showing){var closestTile;var closestDistance=CC_MAXFLOAT;var gamesList=this.gamesList;for(var i=0;i<gamesList.length;++i){var game=gamesList[i];var tile=game.tiles[0];var tilePosition=tile.getTileMovementTarget();var distance=CC.Vector3Distance2D(tilePosition,camera.targetLookAt,false);if(distance<closestDistance){closestDistance=distance;closestTile=tile}}if(closestTile){var closestTileVector=closestTile.getTileMovementTarget();camera.targetLookAt[0]=closestTileVector[0];camera.flagUpdate()}}};SceneMultiUIGamesList.prototype.show=function(){if(this.open){this.showing=true;this.controlsEnabled=true;if(this.tileBackground.getTileTextureImage()){this.tileBackground.setColourAlpha(.5,true)}var i;for(i=0;i<this.tileAlerts.length;++i){this.tileAlerts[i].setColourAlpha(.25,true)}var camera=this.camera;var gamesList=this.gamesList;var x=0;var altRow=false;for(i=0;i<gamesList.length;++i){var game=gamesList[i];var gameTiles=game.tiles;if(gameTiles.length>0){var mainTile=gameTiles[0];if(i>0){x+=mainTile.collisionBounds[0]}if(mainTile.getTileTextureImage()){mainTile.setColourAlpha(1,true)}else{mainTile.setColourAlpha(.125,true)}mainTile.setCollideable(true);for(var j=0;j<gameTiles.length;++j){tile=gameTiles[j];if(x<camera.targetWidth){tile.setTileMovementX(x)}else{tile.setPositionX(x)}}if(altRow){x+=camera.targetWidth*.0125}altRow=!altRow}}this.refreshCameraView();this.lockCameraView()}};SceneMultiUIGamesList.prototype.selectGame=function(game){this.open=false;this.showing=false;this.controlsEnabled=false;var i,tile;var gamesList=this.gamesList;for(i=0;i<gamesList.length;++i){var gameItr=gamesList[i];for(var j=0;j<gameItr.tiles.length;++j){tile=gameItr.tiles[j];tile.setColourAlpha(0,true);tile.setTextColourAlpha(0,true);tile.setCollideable(false)}}var camera=this.camera;tile=game.tiles[0];tile.setDrawOrder(300);vec3.copy(camera.targetLookAt,tile.getTileMovementTarget());camera.targetOffset[2]=camera.calcCameraOffsetForWidth(tile.collisionSize.width);camera.flagUpdate();this.parentScene.hide();for(i=0;i<this.tileAlerts.length;++i){this.tileAlerts[i].setColourAlpha(.5,true)}var self=this;this.tileBackground.setColourAlpha(0,true,function(){self.parentScene.loadGame(game.appInfo.id)})};SceneMultiUIGamesList.prototype.addAppInfo=function(appInfo){var self=this;var camera=this.camera;var tiles=this.tiles;var gamesList=this.gamesList;var tile;var SelectGameFunction=function(game){return function(){self.selectGame(game)}};var x=camera.currentLookAt[0]+camera.targetWidth;var game={};game.appInfo=appInfo;game.tiles=[];gamesList.add(game);{tile=new CCTile3DButton(this);game.tiles.add(tile);tile.setupTile(1);var titleImage=appInfo.titleImage?appInfo.titleImage:SceneMultiManager.DefaultTitleImage;tile.setTileTexture(appInfo.titleImage,function(tile,textureHandle){if(textureHandle){if(self.showing){tile.setColourAlpha(1,true)}}});tile.setColour(gColour.set(1,0));tile.setCollideable(false);tile.setPositionX(x);tile.onRelease.push(new SelectGameFunction(game));this.addTile(tile)}{tile=new CCTile3DButton(this);game.tiles.add(tile);var name=appInfo.name;if(!appInfo.open){name+=" (Unpublished)"}tile.setupText(name,1,true,false);tile.setColour(gColour.set(.05,.5));tile.setTextColour(gColour.set(1,1));tile.setCollideable(false);tile.setPositionX(x);this.addTile(tile)}var drawOrder=300;var duration=1;for(var i=0;i<gamesList.length;++i){var gameTiles=gamesList[i].tiles;for(var j=0;j<gameTiles.length;++j){tile=gameTiles[j];tile.movementInterpolator.setDuration(duration);duration+=.125;tile.setDrawOrder(drawOrder);if(drawOrder>205){drawOrder--}}}this.requestResize();return game};SceneMultiUIGamesList.prototype.loadAppInfos=function(appInfos){var self=this;var camera=this.camera;var tiles=this.tiles;var gamesList=this.gamesList;var GameCompare=function(appInfo){if(appInfo.id==="androids"){return 101}else if(appInfo.id==="tanks"){return 102}else if(appInfo.id==="burgers"){return 103}else if(appInfo.id==="space"){return 104}else if(MultiplayerManager.IsOwner(appInfo.owners)){if(appInfo.jsFiles){return 100-appInfo.jsFiles.length}return 100}else if(appInfo.jsFiles){return 105}return 1e3};appInfos.sort(function(a,b){var scoreA=GameCompare(a);var scoreB=GameCompare(b);if(scoreA===scoreB){return a.id-b.id}return scoreA-scoreB});var game,tile;var i,j;for(i=0;i<appInfos.length;++i){var appInfo=appInfos[i];game=null;if(gamesList.length>i){game=gamesList[i]}if(game){if(game.appInfo.id===appInfo.id){tile=game.tiles[0];if(appInfo.titleImage){tile.setTileTexture(appInfo.titleImage)}continue}else{for(j=0;j<game.tiles.length;++j){tile=game.tiles[j];tiles.remove(tile);tile.deleteLater()}gamesList.remove(game)}}game=this.addAppInfo(appInfo);gamesList.insert(game,i)}while(gamesList.length>appInfos.length){game=gamesList[appInfos.length];for(j=0;j<game.tiles.length;++j){tile=game.tiles[j];tiles.remove(tile);tile.deleteLater()}gamesList.remove(game)}this.requestResize()};SceneMultiUIGamesList.prototype.updatedAppInfo=function(appInfo,removed){var self=this;var camera=this.camera;var gamesList=this.gamesList;var i,game,tile;for(i=0;i<gamesList.length;++i){game=gamesList[i];if(game.appInfo.id===appInfo.id){if(removed){for(var j=0;j<game.tiles.length;++j){tile=game.tiles[j];this.tiles.remove(tile);tile.deleteLater()}gamesList.remove(game);this.requestResize()}else{tile=game.tiles[0];if(appInfo.titleImage){tile.setTileTexture(appInfo.titleImage)}var name=appInfo.name;if(!appInfo.open){name+=" (Unpublished)"}game.tiles[1].setText(name)}return}}this.addAppInfo(appInfo)};function SceneMultiUIIntro(parentScene){this.construct();this.cameraCentered=true;if(parentScene){parentScene.linkScene(this);this.setParent(parentScene)}gEngine.addScene(this);this.started=false}ExtendPrototype(SceneMultiUIIntro,CCSceneAppUI);SceneMultiUIIntro.prototype.setup=function(){var self=this;var camera=gEngine.newSceneCamera(this);camera.setupViewport(0,0,1,1);camera.setCameraWidth(640,false);var tile;{tile=new CCTile3DButton(this);tile.setColour(gColour.set(1,0));tile.setDrawOrder(205);tile.tileRotationInterpolator=new CCInterpolatorListV3(CCInterpolatorX3Curve);tile.disableCulling=true;tile.setColourAlpha(0);tile.setTileScale(0,false);tile.setCollideable(false);tile.setTileSize(camera.targetWidth*.35);tile.setTileTexture("playir_icon.png");this.tileIcon=tile;tile.onRelease.push(function(){self.parentScene.launchEditor()});this.addTile(tile)}var timer=new CCTimer;timer.onTime.push(function(){self.started=true;self.start()});timer.start(1);this.timers.push(timer)};SceneMultiUIIntro.prototype.resize=function(){this.CCSceneAppUI_resize();if(this.started){this.start()}};SceneMultiUIIntro.prototype.touchMoving=function(touch,touchDelta){return false};SceneMultiUIIntro.prototype.start=function(){var self=this;var camera=this.camera;var tile;{tile=this.tileIcon;self.showIcon()}};SceneMultiUIIntro.prototype.showIcon=function(){var self=this;var tile=this.tileIcon;if(!this.hidingIcon){tile.setTileScale(1,true);tile.setColourAlpha(1,true,function(){tile.tileRotationInterpolator.pushV3(tile.rotation,vec3.clone([0,20,0]),false,function(){self.showingIcon=true;if(self.dockingIcon){self.dockIcon()}})})}};SceneMultiUIIntro.prototype.showLoadingBar=function(){var tile=new TileOverlay(this,"white.png","white.png",0);tile.setColourAlpha(.25);tile.setTileSize(this.camera.targetWidth*.25,this.camera.targetHeight*.005125);tile.setPositionY(-this.camera.targetHeight*.35);tile.setAmount(0);this.tileLoadingBar=tile};SceneMultiUIIntro.prototype.updateLoadingBar=function(amount){if(this.tileLoadingBar){this.tileLoadingBar.setAmount(amount)}};SceneMultiUIIntro.prototype.dockIcon=function(callback){if(!this.hidingIcon){this.dockingIcon=true;var self=this;if(callback){this.dockedCallback=callback}if(this.showingIcon){delete this.showingIcon;this.dockedIcon=true;var camera=this.camera;var newSize=camera.targetWidth*.125;var tile=this.tileIcon;var scale=newSize/tile.collisionSize.width;tile.setTileMovementXY(-camera.targetWidth*.5+newSize,-camera.targetHeight*.5+newSize);tile.movementInterpolator.setDuration(.5);tile.tileRotationInterpolator.setDuration(.5);tile.setTileScale(scale*2,true);tile.tileRotationInterpolator.pushV3(tile.rotation,vec3.clone([0,0,0]),false,function(){tile.setTileScale(scale,true,function(){tile.setTileSize(newSize);tile.setTileScale(1,false)});tile.rotation[1]=0;tile.setCollideable(true);if(self.dockedIcon){if(self.dockedCallback){self.dockedCallback();delete self.dockedCallback}}})}}};SceneMultiUIIntro.prototype.hide=function(callback){this.hidingIcon=true;if(this.tileLoadingBar){this.tileLoadingBar.setColourAlpha(0,true);this.tileLoadingBar.tileOverlay.setColourAlpha(0,true);this.tileLoadingBar=null}var tile=this.tileIcon;if(this.dockingIcon){tile.setColourAlpha(0,true);tile.setTileScale(1.5,true);tile.tileRotationInterpolator.setDuration(1);tile.tileRotationInterpolator.pushV3(tile.rotation,vec3.clone([0,-720,0]),false,function(){if(callback){callback()}})}else{this.start();tile.setTileScale(1,true);tile.setColourAlpha(1,true,function(){tile.tileRotationInterpolator.pushV3(tile.rotation,vec3.clone([0,0,0]),true,function(){tile.setColourAlpha(0,true,function(){if(callback){callback()}})})})}};function SceneMultiUILogin(parentScene){this.construct();this.cameraCentered=true;if(parentScene){parentScene.linkScene(this);this.setParent(parentScene)}gEngine.addScene(this)}ExtendPrototype(SceneMultiUILogin,CCSceneAppUI);SceneMultiUILogin.prototype.setup=function(){var self=this;var camera=gEngine.newSceneCamera(this);camera.setupViewport(0,0,1,1);camera.setCameraWidth(640,false);{tile=new TileSocialProfile(this);tile.setTileSize(camera.targetHeight*.1);tile.setPositionX(camera.targetWidth*.5-tile.collisionBounds[0]*1.5);tile.setPositionY(camera.targetHeight*.5+tile.collisionBounds[1]);this.tileProfile=tile;tile.onRelease.push(function(){self.showProfileLogin()});this.addTile(tile,0)}var timer=new CCTimer;timer.onTime.push(function(){self.open=true;self.requestResize()});timer.start(1);this.timers.push(timer)};SceneMultiUILogin.prototype.resize=function(){this.CCSceneAppUI_resize();var camera=this.camera;var tile=this.tileProfile;tile.setTileSize(camera.targetHeight*.1);if(this.open){tile.setTileMovementY(camera.targetHeight*.5-tile.collisionBounds[1]*1.5)}};SceneMultiUILogin.prototype.touchMoving=function(touch,touchDelta){return false};SceneMultiUILogin.prototype.close=function(){this.open=false;if(this.sceneProfileLogin){this.sceneProfileLogin.close()}var camera=this.camera;var tile=this.tileProfile;tile.setTileMovementY(camera.targetHeight);var self=this;tile.setColourAlpha(0,true,function(){self.deleteLater()})};SceneMultiUILogin.prototype.showProfileLogin=function(){if(MultiplayerManager.LoggedIn){if(!this.sceneProfileLogin){this.sceneProfileLogin=new SceneProfileLogin(this)}}};function SceneMultiUILauncher(parentScene,handleBackButton){this.construct();this.cameraCentered=true;if(parentScene){parentScene.linkScene(this);this.setParent(parentScene)}gEngine.addScene(this);if(handleBackButton===true){this.shouldHandleBackButton=true;CCEngine.EnableBackButton(this)}SceneMultiUILauncher.Instance=this}ExtendPrototype(SceneMultiUILauncher,CCSceneAppUI);SceneMultiUILauncher.Instance=null;SceneMultiUILauncher.prototype.handleBackButton=function(){if(this.shouldHandleBackButton){this.shouldHandleBackButton=false;this.launch();return true}return false};SceneMultiUILauncher.prototype.deleteLater=function(){if(SceneMultiUILauncher.Instance===this){SceneMultiUILauncher.Instance=null}this.CCSceneAppUI_deleteLater()};SceneMultiUILauncher.prototype.setup=function(){var self=this;var camera=gEngine.newSceneCamera(this);camera.setupViewport(0,0,1,1);camera.setCameraWidth(640,false);camera.useSceneCollideables(this);var tile;{tile=new CCTile3DButton(this);tile.setupTile(camera.targetWidth,camera.targetHeight);tile.setColour(gColour.set(0,0));tile.getColourInterpolator().setDuration(1);tile.setDrawOrder(204);this.cameraStickyTiles.add(tile);this.tileBackground=tile}{tile=new CCTile3DButton(this);tile.setColour(gColour.set(1,0));tile.getColourInterpolator().setDuration(.5);tile.setDrawOrder(205);tile.setCollideable(false);tile.tileRotationInterpolator=new CCInterpolatorListV3(CCInterpolatorX3Curve);tile.setCulling(false);this.tileIcon=tile;tile.onRelease.push(function(){self.launch()});this.addTile(tile);this.iconSrc="playir_icon.png";gEngine.textureManager.getTextureHandle(this.iconSrc)}};SceneMultiUILauncher.prototype.resize=function(){this.CCSceneAppUI_resize();if(this.showing){this.show()}};SceneMultiUILauncher.prototype.render=function(camera,pass,alpha){};SceneMultiUILauncher.prototype.touchMoving=function(touch,touchDelta){return false};SceneMultiUILauncher.prototype.show=function(){this.showing=true;var self=this;var camera=this.camera;var tile=this.tileIcon;this.enabled=true;camera.enabled=true;gEngine.textureManager.getTextureHandle(self.iconSrc,function(textureHandle){tile.setCollideable(true);var size=camera.targetHeight*.2;tile.setTileSize(size);var padding=size*.6;tile.setPositionXY(camera.targetWidth*.5-padding,-camera.targetHeight*.5+padding);tile.setTileTexture(self.iconSrc);tile.setTileScale(0,false);tile.setTileScale(1.5,true);tile.setColourAlpha(1,true,function(){tile.tileRotationInterpolator.pushV3(tile.rotation,vec3.clone([0,-5,0]),true,function(){tile.setTileScale(1,true);tile.tileRotationInterpolator.setDuration(.5);tile.tileRotationInterpolator.pushV3(tile.rotation,vec3.clone([0,0,0]),false,function(){tile.rotation[1]=0})})})})};SceneMultiUILauncher.prototype.hide=function(close){this.showing=false;var self=this;var tile=this.tileIcon;tile.setColourAlpha(0,true,function(){if(!self.showing){self.enabled=false;self.camera.enabled=false;if(close){self.deleteLater()}}});tile.tileRotationInterpolator.pushV3(tile.rotation,vec3.clone([0,-5,0]),true);tile.setTileScale(1.5,true);tile.setCollideable(false)};SceneMultiUILauncher.prototype.launch=function(fast,callback){if(!this.launching){this.launching=true;if(fast){this.tileBackground.getColourInterpolator().setDuration(.25);this.tileIcon.getColourInterpolator().setDuration(.2);this.tileIcon.tileRotationInterpolator.setDuration(.25)}var self=this;if(this.parentScene){this.unlinkScene(this.parentScene)}var camera=this.camera;this.enabled=true;camera.enabled=true;var tile;{tile=this.tileBackground;tile.setTileSize(camera.targetWidth,camera.targetHeight);tile.setColourAlpha(1,true)}{tile=this.tileIcon;tile.setColourAlpha(1,true,function(){tile.setColourAlpha(0,true);tile.setTileScale(4,true);tile.tileRotationInterpolator.pushV3(tile.rotation,vec3.clone([0,-5,0]),true,function(){if(callback){callback()}self.deleteLater();SceneMultiManager.Launch()})})}}};function SceneMultiManager(){this.construct()}ExtendPrototype(SceneMultiManager,SceneManagerPlay);SceneMultiManager.Instance=null;SceneMultiManager.DefaultTitleImage="phonewars_title.jpg";SceneMultiManager.prototype.construct=function(){SceneMultiManager.Instance=this;this.SceneManagerPlay_construct();if(gEngine.restarting){delete gEngine.restarting}else{this.showIcon()}SceneMultiManager.LoadingGame=window.APP_ID==="multi"?false:window.APP_ID;var self=this;this.dbApps=new DBApps;this.dbApps.load(function(appInfos){if(!self.startingGame){if(SceneMultiManager.LoadingGame){self.findGameToLoad()}else{self.loadGamesList(appInfos);self.dockIcon(function(){self.showGamesList()})}}},function(appInfo,removed){if(!self.startingGame){if(SceneMultiManager.LoadingGame){self.findGameToLoad()}else{self.updateGamesList(appInfo,removed)}}});this.syncDisconnected();gEngine.addScene(this)};SceneMultiManager.prototype.deleteLater=function(){if(SceneMultiManager.Instance===this){SceneMultiManager.Instance=null}if(this.dbApps){this.dbApps.destruct();this.dbApps=null}this.SceneManagerPlay_deleteLater()};SceneMultiManager.prototype.updateControls=function(controls){return false};SceneMultiManager.prototype.syncDisconnected=function(){this.SceneManagerPlay_syncDisconnected();this.hideLogin()};SceneMultiManager.prototype.syncLoggedIn=function(){this.SceneManagerPlay_syncLoggedIn();if(!this.startingGame){this.showLogin()}};SceneMultiManager.prototype.syncLoggedIntoSocialNetwork=function(network){if(!this.startingGame){this.hideLogin();this.showLogin()}};SceneMultiManager.prototype.findGameToLoad=function(){var AppInfos=DBApps.AppInfos;for(var i=0;i<AppInfos.length;++i){var appInfo=AppInfos[i];if(window.APP_ID===appInfo.id){this.loadGame(appInfo.id);return}}this.dbApps.requestGameID(window.APP_ID)};SceneMultiManager.prototype.loadGame=function(appID){if(appID!==LAUNCH_APP_ID){CCEngine.EnableBackButton(gEngine)}this.startingGame=true;this.hideLogin();var appInfo=null;if(this.dbApps){appInfo=this.dbApps.getAppInfo(appID)}if(!appInfo){SceneMultiManager.Launch()}else if(!appInfo.jsFiles||appInfo.jsFiles.length===0){this.startGame(appInfo)}else{this.showIcon();this.sceneIntro.showLoadingBar();var self=this;var jsFiles=appInfo.jsFiles;JSManager.SyncJSFiles(jsFiles,function(updatedJS){if(SceneMultiManager.Instance===self){self.loadedJS(appInfo)}},function(progress){if(SceneMultiManager.Instance===self&&self.sceneIntro){self.sceneIntro.updateLoadingBar(progress)}})}};SceneMultiManager.prototype.loadedJS=function(appInfo){var jsFiles=appInfo.jsFiles;
for(var i=0;i<jsFiles.length;++i){var js=jsFiles[i];if(js.filename){var script=JSManager.GetScript(js.filename);if(!script){this.loadGame(appInfo.id);return}}}if(SceneMultiManager.LoadingAppInfoUpdated){SceneMultiManager.LoadingAppInfoUpdated=false;this.loadGame(SceneMultiManager.LoadingGame)}this.startGame(appInfo)};SceneMultiManager.prototype.startGame=function(appInfo){MultiplayerManager.Emit("SetApp",APP_ID);SceneMultiManager.LoadingGame=false;var self=this;this.hideIcon(function(){self.deleteLater();if(appInfo.jsStart&&window[appInfo.jsStart]){new window[appInfo.jsStart]}else{gEngine.addScene(new SceneManagerGame)}})};SceneMultiManager.prototype.hide=function(){this.hideIcon()};SceneMultiManager.prototype.launchEditor=function(){if(SceneMultiManager.EditorAllowed){this.deleteLater();SceneMultiManager.EditorEnabled=!SceneMultiManager.EditorEnabled;if(SceneMultiManager.EditorEnabled){new SceneProjectManager}}else{CCEngine.WebViewOpen("http://playir.com/")}};SceneMultiManager.Launch=function(){SceneMultiManager.LoadingGame=false;{for(var i=0;i<gEngine.scenes.length;++i){gEngine.scenes[i].deleteLater()}CCEngine.DisableBackButton(gEngine);if(APP_ID!=="multi"){APP_ID="multi"}else{APP_ID=LAUNCH_APP_ID}if(APP_ID!==LAUNCH_APP_ID){CCEngine.EnableBackButton(gEngine)}gEngine.restarting=true;gEngine.start();return}if(sceneManagerPlay){sceneManagerPlay.deleteLater()}MultiplayerManager.Disconnect();if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCEngine.Restart\n"}else{var url=CC.GetURLWithoutLocationBarData();if(window.location!==url){window.location=url}else{window.location.reload()}}};SceneMultiManager.RestartClient=function(){MultiplayerManager.Disconnect();if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCEngine.RestartClient;"+APP_ID+"\n"}else{while(gEngine.scenes.length>0){gEngine.removeScene(gEngine.scenes.last())}CC.SetJSLocationBarData("id",APP_ID);window.location.reload()}};SceneMultiManager.prototype.showIcon=function(){if(!this.sceneIntro){this.sceneIntro=new SceneMultiUIIntro(this)}};SceneMultiManager.prototype.hideIcon=function(callback){if(this.sceneIntro){this.sceneIntro.hide(callback)}else if(callback){callback()}};SceneMultiManager.prototype.dockIcon=function(callback){if(this.sceneIntro){this.sceneIntro.dockIcon(callback)}else if(callback){callback()}};SceneMultiManager.prototype.showLogin=function(){if(!this.sceneLogin){this.sceneLogin=new SceneMultiUILogin(this)}};SceneMultiManager.prototype.hideLogin=function(){if(this.sceneLogin){this.sceneLogin.close();this.sceneLogin=null}};SceneMultiManager.prototype.preloadGamesList=function(callback){if(!this.sceneGamesList){this.sceneGamesList.preloadGamesList(callback)}};SceneMultiManager.prototype.reconnect=function(){if(this.sceneGamesList){this.sceneGamesList.reconnect()}};SceneMultiManager.prototype.loadGamesList=function(appInfos){if(!this.sceneGamesList){this.sceneGamesList=new SceneMultiUIGamesList(this)}this.sceneGamesList.loadAppInfos(appInfos)};SceneMultiManager.prototype.showGamesList=function(){if(this.sceneGamesList){this.sceneGamesList.show()}};SceneMultiManager.prototype.updateGamesList=function(appInfo,removed){if(this.sceneGamesList){this.sceneGamesList.updatedAppInfo(appInfo,removed)}};SceneMultiManager.prototype.hideGamesList=function(){if(this.sceneGamesList){this.sceneGamesList.deleteLater();this.sceneGamesList=null}};function DBApps(){MultiplayerManager.UpdateCallbacks.addOnce(DBApps);DBApps.Instances.add(this);if(MultiplayerManager.LoggedIn){DBApps.syncLoggedIn()}}DBApps.Instances=[];DBApps.SyncingUpdates=false;DBApps.AppInfos=[];DBApps.prototype.load=function(loadedCallback,updatedCallback){this.loadedCallback=loadedCallback;this.updatedCallback=updatedCallback;if(!window.FORCE_ONLINE){if(DBApps.AppInfos.length===0){var appInfosString=CC.LoadData("appInfos");var appInfos=appInfosString?JSON.parse(appInfosString):null;if(appInfos){DBApps.LoadAppInfos(appInfos)}else{appInfos=[{id:"androids",name:"Phone Wars",open:true,titleImage:"phonewars_title.jpg",jsStart:"SceneManagerAndroids"}];DBApps.LoadAppInfos(appInfos)}}else{this.loadedCallback(DBApps.AppInfos)}}};DBApps.prototype.destruct=function(){MultiplayerManager.UpdateCallbacks.remove(this);if(DBApps.Instances.remove(this)){if(DBApps.Instances.length===0){if(DBApps.SyncingUpdates){DBApps.SyncingUpdates=false;MultiplayerManager.Emit("AppsUnregisterListUpdates")}}}};DBApps.syncDisconnected=function(){if(DBApps.SyncingUpdates){DBApps.SyncingUpdates=false}};DBApps.syncLoggedIn=function(){if(!DBApps.SyncingUpdates){if(MultiplayerManager.Emit("AppsRequestList")){DBApps.SyncingUpdates=true}}};DBApps.syncUpdate=function(jsonData){if(jsonData.multiGamesList){this.AppInfos.length=0;this.LoadAppInfos(jsonData.multiGamesList)}else if(jsonData.multiGamesListUpdated){this.UpdatedAppInfo(jsonData.multiGamesListUpdated)}else if(jsonData.AppsRequestInfo){this.UpdatedAppInfo(jsonData.AppsRequestInfo)}else if(jsonData.multiGamesListRemoved){this.RemovedAppInfo(jsonData.multiGamesListRemoved)}};DBApps.prototype.requestGameID=function(gameID){MultiplayerManager.Emit("AppsRequestInfo",gameID)};DBApps.LoadAppInfos=function(appInfos){var i;for(i=0;i<appInfos.length;++i){DBApps.AddAppInfo(appInfos[i])}CC.SaveData("appInfos",JSON.stringify(this.AppInfos));for(i=0;i<DBApps.Instances.length;++i){if(DBApps.Instances[i].loadedCallback){DBApps.Instances[i].loadedCallback(appInfos)}}};DBApps.AddAppInfo=function(appInfo){var AppInfos=this.AppInfos;for(var i=0;i<AppInfos.length;++i){if(AppInfos[i].id===appInfo.id){AppInfos[i]=appInfo;return}}AppInfos.add(appInfo)};DBApps.UpdatedAppInfo=function(appInfo){var i,j;var AppInfos=this.AppInfos;for(i=0;i<AppInfos.length;++i){if(AppInfos[i].id===appInfo.id){AppInfos[i]=appInfo;for(j=0;j<DBApps.Instances.length;++j){if(DBApps.Instances[j].updatedCallback){DBApps.Instances[j].updatedCallback(appInfo)}}return}}AppInfos.push(appInfo);CC.SaveData("appInfos",JSON.stringify(AppInfos));for(j=0;j<DBApps.Instances.length;++j){if(DBApps.Instances[j].updatedCallback){DBApps.Instances[j].updatedCallback(appInfo)}}};DBApps.RemovedAppInfo=function(appInfo){var i,j;var AppInfos=this.AppInfos;for(i=0;i<AppInfos.length;++i){if(AppInfos[i].id===appInfo.id){AppInfos.remove(AppInfos[i]);CC.SaveData("appInfos",JSON.stringify(AppInfos));for(j=0;j<DBApps.Instances.length;++j){if(DBApps.Instances[j].updatedCallback){DBApps.Instances[j].updatedCallback(appInfo,true)}}return}}};DBApps.prototype.getAppInfo=function(appID){var appInfos=DBApps.AppInfos;for(var i=0;i<appInfos.length;++i){var appInfo=appInfos[i];if(appInfo.id===appID){return appInfo}}return null};DBApps.GetOwnedApps=function(){var ownedApps=[];for(var i=0;i<DBApps.AppInfos.length;++i){var appInfo=DBApps.AppInfos[i];if(MultiplayerManager.IsOwner(appInfo.owners)){ownedApps.push(appInfo)}}return ownedApps};function DBAssets(){this.initialized=false}DBAssets.Initialize=function(){MultiplayerManager.UpdateCallbacks.addOnce(this);if(!this.dbInfos){this.dbInfos=[]}this.requests=[];this.currentRequest=null;this.updateCallbacks=[];this.initialized=true};DBAssets.AddUpdateCallback=function(id,callback,pointer){if(pointer){var packet={};packet.id=id;packet.callback=callback;packet.pointer=pointer;this.updateCallbacks.push(packet);if(window.DEBUG_IsLocalClient){}}};DBAssets.RemoveUpdateCallbacks=function(pointer){for(var i=0;i<this.updateCallbacks.length;++i){var packet=this.updateCallbacks[i];if(packet.pointer===pointer){this.updateCallbacks.remove(packet);--i}}};DBAssets.RunUpdateCallbacks=function(id,info){for(var i=0;i<this.updateCallbacks.length;++i){var packet=this.updateCallbacks[i];if(packet.id===id){packet.callback(info)}}};DBAssets.UpdateDBInfo=function(id,info){if(!this.initialized){this.Initialize()}for(var i=0;i<this.dbInfos.length;++i){var dbInfo=this.dbInfos[i];var dbID=dbInfo.id;if(dbID===id){this.dbInfos[i].info=info;DBAssets.RunUpdateCallbacks(id,info);return}}var packet={id:id,info:info};this.dbInfos.push(packet);DBAssets.RunUpdateCallbacks(id,info)};DBAssets.LoadDBInfos=function(dbInfos){if(!this.initialized){this.Initialize()}for(var i=0;i<dbInfos.length;++i){var dbInfo=dbInfos[i];var id=DBAssets.GetID(dbInfo);dbInfo.localCachedVersion=true;DBAssets.UpdateDBInfo(id,dbInfo)}};DBAssets.RemoveDBID=function(id){var dbInfos=this.dbInfos;if(dbInfos){for(var i=0;i<dbInfos.length;++i){var dbInfo=dbInfos[i];var dbID=dbInfo.id;if(dbID===id){dbInfos.remove(dbInfo);break}}}};DBAssets.LoadCharacters=function(characterInfos){for(var i=0;i<characterInfos.length;++i){var characterInfo=characterInfos[i];DBAssets.UpdateDBInfo(characterInfo.objectID,characterInfo)}};DBAssets.syncLoggedIn=function(){{var SyncAssetIDs=[];for(var i=0;i<this.dbInfos.length;++i){var id=this.dbInfos[i].id;SyncAssetIDs.push(id)}MultiplayerManager.Emit("SyncAssetIDs",SyncAssetIDs)}if(this.currentRequest){this.Request()}};DBAssets.syncUpdate=function(jsonData){if(jsonData.mapInfo!==undefined){this.Result(jsonData.id,jsonData.mapInfo)}if(jsonData.modelInfo!==undefined){this.Result(jsonData.id,jsonData.modelInfo)}if(jsonData.characterInfo!==undefined){this.Result(jsonData.id,jsonData.characterInfo)}if(jsonData.audioInfo!==undefined){this.Result(jsonData.id,jsonData.audioInfo)}};DBAssets.LoadID=function(id,callback){if(id.startsWith("audio")){this.LoadAudioID(id,function(info){if(callback){callback(info)}})}else if(id.startsWith("map")){this.LoadMapID(id,function(info){if(callback){callback(info)}})}else if(id.startsWith("model")){this.LoadModelID(id,function(info){if(callback){callback(info)}})}else if(id.startsWith("character")){this.LoadCharacterID(id,function(info){if(callback){callback(info)}})}};DBAssets.LoadMapID=function(id,callback){if(!this.initialized){this.Initialize()}var info=this.GetCachedID(id);if(info){if(callback){callback(info)}return}var OnFinish=function(callback){return function(info){if(callback){callback(info)}}};var request={};request.type="MapInfoRequest";request.id=id;request.callback=new OnFinish(callback);if(!this.currentRequest){this.currentRequest=request;this.Request()}else{this.requests.push(request)}};DBAssets.LoadAudioID=function(id,callback){if(!this.initialized){this.Initialize()}var info=this.GetCachedID(id);if(info){if(callback){callback(info)}return}var OnFinish=function(callback){return function(info){if(info&&info.mp3){CCAudioManager.Cache(info.mp3)}if(callback){callback(info)}}};var request={};request.type="AudioInfoRequest";request.id=id;request.callback=new OnFinish(callback);if(!this.currentRequest){this.currentRequest=request;this.Request()}else{this.requests.push(request)}};DBAssets.LoadModelID=function(id,callback,priority,updatePointer){if(!this.initialized){this.Initialize()}this.AddUpdateCallback(id,callback,updatePointer);var info=this.GetCachedID(id);if(info){if(callback){callback(info)}return}if(updatePointer){callback=null}var OnFinish=function(callback){return function(modelInfo){if(callback){callback(modelInfo)}if(modelInfo){if(modelInfo.tex){gEngine.textureManager.getTextureHandle(modelInfo.tex)}if(modelInfo.obj){CCModel3D.CacheModel(modelInfo.obj,true)}}}};var request={};request.type="ModelInfoRequest";request.id=id;request.callback=new OnFinish(callback);if(!this.currentRequest){this.currentRequest=request;this.Request()}else{this.requests.push(request);if(priority>0){request.priority=priority;for(var i=0;i<this.requests.length;++i){var currentRequest=this.requests[i];if(!currentRequest.priority||currentRequest.priority<priority){this.requests.insert(request,i);break}}}}};DBAssets.LoadCharacterID=function(id,callback,updatePointer){if(!this.initialized){this.Initialize()}this.AddUpdateCallback(id,callback,updatePointer);var info=this.GetCachedID(id);if(info){if(callback){callback(info)}return}if(updatePointer){callback=null}var OnFinish=function(callback){return function(characterInfo){if(callback){callback(characterInfo)}if(characterInfo){var actions=characterInfo.actions;for(var i=0;i<actions.length;++i){var action=actions[i];if(action.modelID){DBAssets.LoadModelID(action.modelID)}if(action.sfxID){DBAssets.LoadAudioID(action.sfxID)}}}if(callback){callback(characterInfo)}}};var request={};request.type="CharacterInfoRequest";request.id=id;request.callback=callback;if(!this.currentRequest){this.currentRequest=request;this.Request()}else{this.requests.push(request)}};DBAssets.GetID=function(info){if(info.objectID){return info.objectID}else if(info.mapID){return info.mapID}return info.id};DBAssets.GetCachedID=function(id){var dbInfos=this.dbInfos;for(var i=0;i<dbInfos.length;++i){var dbInfo=dbInfos[i];var dbID=dbInfo.id;if(dbID===id){return dbInfo.info}}return null};DBAssets.Request=function(){var requestID=this.currentRequest.id;var info=DBAssets.GetCachedID(requestID);if(info){this.Result(requestID,info);return}var requestType=this.currentRequest.type;if(window.DEBUG_IsLocalClient){console.log(requestType,requestID)}MultiplayerManager.Emit(requestType,requestID)};DBAssets.Result=function(resultID,info){if(window.DEBUG_IsLocalClient){}if(this.currentRequest){var requestID=this.currentRequest.id;if(requestID===resultID){var callback=this.currentRequest.callback;this.UpdateDBInfo(resultID,info);this.currentRequest=null;if(callback){callback(info)}}}if(!this.currentRequest){if(this.requests.length>0){this.currentRequest=this.requests.safePop();this.Request()}}};DBAssets.PrepareAudioID=function(channel,audioID){DBAssets.LoadAudioID(audioID,function(info){if(info&&info.mp3){CCAudioManager.Prepare(channel,info.mp3)}})};DBAssets.PlayAudioID=function(channel,audioID,restart,loop){DBAssets.LoadAudioID(audioID,function(info){if(info&&info.mp3){CCAudioManager.Play(channel,info.mp3,restart,loop)}})};DBAssets.ResourceFiles=["editor_back.png","editor_icon_delete.jpg","editor_icon_hammer.jpg","editor_icon_js.jpg","editor_icon_private.jpg","editor_icon_public.jpg","editor_icon_resize.png","editor_tabletscreen.png","editor_tile_back.jpg","editor_tile_background.jpg","editor_tile_copy.jpg","editor_tile_cross.jpg","editor_tile_hammer.jpg","editor_tile_refresh.jpg","editor_tile_resize.jpg","editor_tile_selection.jpg","editor_tile_tick.jpg","bazooka.obj","bazooka_diffuse.jpg","burger.obj","burger_diffuse.jpg","burger_icon.png","doubleburger.obj","foodfighters_background.jpg","foodfighters_helpscreen.jpg","foodfighters_title.jpg","fries.obj","fries_diffuse.jpg","fries_icon.png","androBot_body.obj","androBot_diffuse.jpg","androBot_head.obj","androBot_icon.png","androBot_rightarm.obj","androBot_screen.obj","androBot_screen_diffuse.jpg","iBot_body.obj","iBot_diffuse.jpg","iBot_head.obj","iBot_icon.png","iBot_leftarm.obj","iBot_rightarm.obj","phonewars_background.jpg","phonewars_helpscreen.jpg","phonewars_title.jpg","webBot_bazooka.obj","webBot_body.obj","webBot_diffuse.jpg","webBot_head.obj","winBot_body.obj","winBot_diffuse.jpg","winBot_rightarm.obj","playir_icon.png","miniche_body_diffuse.jpg","miniche_head.obj","miniche_head_diffuse.jpg","soldier_body.obj","soldier_body_diffuse.jpg","soldier_head.obj","soldier_head_diffuse.jpg","soldier_icon.png","soldier_weapon_bazooka.obj","soldier_weapon_bazooka_diffuse.jpg","tank_body.obj","tank_diffuse.jpg","tank_head.obj","tank_icon.png","tanklegends_background.jpg","tanklegends_helpscreen.jpg","tanklegends_title.jpg","PressStartK.data","PressStartK.png","fx_character_highlight_texture.png","fx_character_shooting_texture.png","fx_impact_texture.png","fx_weapon_bullet.obj","fx_weapon_bullet_diffuse.jpg","fx_weapon_bullet_glow_texture.png","fx_weapon_muzzleflash.obj","fx_weapon_muzzleflash_texture.png","barbedwire.obj","barbedwire_diffuse.png","level_map_diffuse.jpg","level_particles.obj","level_particles_diffuse.png","sandbags.obj","sandbags_diffuse.png","healthpack.obj","healthpack_diffuse.jpg","icon_facebook.png","icon_googleplus.png","icon_twitter.png","profile_derp.png","profile_f7u12.png","profile_girl.png","profile_grandma.png","profile_happy.png","profile_ibot.jpg","profile_poker.png","profile_rich.png","profile_troll.png","ui_fight.png","ui_fire_charge.png","ui_fire_icon.png","ui_health_bar.png","ui_health_bar_energy.png","ui_health_icon.png","ui_lose.png","ui_win.png","icon_platform_android.png","icon_platform_ios.png","icon_platform_linux.png","icon_platform_mac.png","icon_platform_web.png","icon_platform_windows.png","icon_store.png","icon_store_googleplay.png","icon_store_windows.png","ui_arrow.png","ui_back.png","ui_border.png","ui_button_1vs1.png","ui_button_battleroyale.png","ui_button_moremaps.png","ui_exit.png","ui_help.png","ui_info.png","ui_leaderboards.png","ui_leaderboards_alltime.png","ui_leaderboards_daily.png","ui_leaderboards_weekly.png","ui_practice.png","ui_pushnotifications_off.png","ui_pushnotifications_on.png","ui_sidebackground.png","ui_vs.png","ui_vs_bluestripe.png","ui_vs_redstripe.png","ui_vs_whitestripe.png","HelveticaNeueBold.csv","HelveticaNeueBold.png","HelveticaNeueLight.csv","HelveticaNeueLight.png","alphacolour.fx","basic.fx","basic_vc.fx","phong.fx","phongenv.fx","transparent.png","white.png"];function JSManager(){}JSManager.DownloadJS=function(js,callback){var DownloadedJSFunction=function(js){return function(status,responseText){if(status>=CCURLRequest.Succeeded&&responseText&&responseText.length>0){head=document.getElementsByTagName("head")[0];var scriptID="customjs."+js.fileID;var LoadScript=function(url,callback){if(window.DEBUG_IsLocalClient&&CCEngine.DeviceType==="Web"){script=document.getElementById(scriptID);var newScript=false;if(!script){script=document.createElement("script");script.type="text/javascript";newScript=true}if(!newScript){console.log("JSManager.DownloadJS",url)}script.onload=function(){console.log("JSManager.Downloaded::onload",url);callback(this,true)};script.onerror=function(){console.log("JSManager.DownloadJS::onerror",url);callback(null,false)};script.src=url;if(newScript){head.appendChild(script)}}else{callback(null,false)}};LoadScript(url,function(script,loaded){if(!script){script=document.createElement("script");script.type="text/javascript";head.appendChild(script)}script.id=scriptID;script.fileID=js.fileID;script.filename=js.filename;script.jsData=responseText;if(loaded){if(callback){callback(true)}}else{try{script.text=responseText}catch(error){if(window.console&&console.log){console.log(error)}}if(callback){callback(true)}}})}else{if(callback){callback(false)}}}};if(js.filename){if(JSManager.GetScript(js.filename)){callback(true);return}var url=MultiplayerManager.GetAssetURL(js.filename);gURLManager.requestURL(url,null,new DownloadedJSFunction(js),0,js.filename,-1,0)}else{callback(true)}};JSManager.GetClassNames=function(jsData){var classNames=[];jsData=jsData.formatSpacesAndTabs();var functionSearch=jsData;var functionIndex;while((functionIndex=functionSearch.search("function"))!==-1){var foundFunction=true;if(functionIndex>2){if(functionSearch[functionIndex-2]==="="){foundFunction=false}else if(functionSearch[functionIndex-2]==="/"){foundFunction=false}else if(functionSearch[functionIndex-2]==="("){foundFunction=false}else{functionSearch=functionSearch.substring(functionIndex+8)}}if(foundFunction){var functionName=String.SplitBefore(functionSearch,"(");functionName=functionName.formatSpacesAndTabs();var spaces=functionName.split(" ");if(functionName&&spaces.length===1){if(classNames.find(functionName)===-1){classNames.addOnce(functionName)}}}functionSearch=functionSearch.substring(functionIndex+1)}var prototypes=jsData.split(".prototype.");for(var iPrototype=1;iPrototype<prototypes.length;++iPrototype){var className=prototypes[iPrototype-1];var classNameStartIndex=0;for(var j=className.length-1;j>=0;--j){var character=className[j];if(/[^a-zA-Z0-9]/.test(character)){classNameStartIndex=j+1;break}}className=className.substr(classNameStartIndex,className.length);if(className){if(classNames.find(className)===-1){classNames.addOnce(className)}}}return classNames};JSManager.GetScript=function(filename){var head=document.getElementsByTagName("head")[0];var scripts=head.getElementsByTagName("script");var js,scriptID,script;for(var i=0;i<scripts.length;++i){script=scripts[i];if(script.id){if(script.id.contains("customjs.")){if(script.filename===filename){return script}}}}return null};JSManager.RemoveJSScript=function(script){var jsData=script.jsData;var prototypes=jsData.split(".prototype.");for(var iPrototype=1;iPrototype<prototypes.length;++iPrototype){var className=prototypes[iPrototype-1];var classNameStartIndex=0;for(var j=className.length-1;j>=0;--j){var character=className[j];if(/[^a-zA-Z0-9]/.test(character)){classNameStartIndex=j+1;break}}className=className.substr(classNameStartIndex,className.length);var prototypeName=prototypes[iPrototype];prototypeName=String.SplitBefore(prototypeName," ");prototypeName=String.SplitBefore(prototypeName,"=");prototypeName=String.SplitBefore(prototypeName,"\n");var sourceClass=window[className];if(sourceClass){if(sourceClass.super){var parentClass=sourceClass.super;if(sourceClass.prototype[prototypeName]){if(parentClass.prototype[prototypeName]){sourceClass.prototype[prototypeName]=parentClass.prototype[prototypeName]}}}}}script.parentNode.removeChild(script)};JSManager.RemoveJSFiles=function(){var head=document.head;var scripts=head.children;var js,scriptID,script;for(var i=0;i<scripts.length;++i){script=scripts[i];if(script.id){if(script.id.contains("customjs.")){this.RemoveJSScript(script);--i}}}};JSManager.SyncJSFiles=function(jsFiles,onSynced,onUpdate){var head=document.getElementsByTagName("head")[0];var scripts=head.getElementsByTagName("script");var js,scriptID,script;for(var i=0;i<scripts.length;++i){script=scripts[i];if(script.id){if(script.id.contains("customjs.")){found=false;if(jsFiles){for(var jsIndex=0;jsIndex<jsFiles.length;++jsIndex){js=jsFiles[jsIndex];if(script.filename===js.filename){found=true;break}}}if(!found){this.RemoveJSScript(script)}}}}var updatedJS=[];function DownloadJS(jsFiles,index){if(onUpdate){onUpdate(index/jsFiles.length)}if(jsFiles&&index<jsFiles.length){var js=jsFiles[index];var script=JSManager.GetScript(js.filename);if(!script){JSManager.DownloadJS(js,function(result){if(result){updatedJS.add(js.filename)}else if(window.console&&console.log){console.log("JSManager.DownloadJS Failed "+js.filename)}DownloadJS(jsFiles,index+1)})}else{DownloadJS(jsFiles,index+1)}}else{onSynced(updatedJS)}}DownloadJS(jsFiles,0)};JSManager.ReplaceClassInternalPointers=function(classPointer,oldPointer,newPointer){var keys=Object.keys(classPointer);for(var i=0;i<keys.length;++i){var key=keys[i];if(classPointer[key]===oldPointer){classPointer[key]=newPointer}}};JSManager.RuntimePatch=function(jsFiles){JSManager.SyncJSFiles(jsFiles,function(updatedJS){for(var i=0;i<updatedJS.length;++i){var script=JSManager.GetScript(updatedJS[i]);if(script){var classNames=JSManager.GetClassNames(script.jsData);if(classNames.length>0){for(var iClassName=0;iClassName<classNames.length;++iClassName){var className=classNames[iClassName];for(var iScene=0;iScene<gEngine.scenes.length;++iScene){var scene=gEngine.scenes[iScene];var sceneName=String.SplitBetween(scene.constructor.toString()," ","(");if(window[sceneName]){var Class=window[sceneName];for(var m in Class.prototype){scene[m]=Class.prototype[m]}if(window[sceneName].jsSyncRestartFunction){window[sceneName].jsSyncRestartFunction(scene)}else if(scene.jsSyncReCreate){if(sceneName===className){var parent=scene.parentScene;var newScene=new window[sceneName](parent);if(parent){JSManager.ReplaceClassInternalPointers(parent,scene,newScene)}gEngine.removeScene(scene);break}}}}}}}}})};JSManager.SoftRestart=function(jsonData){while(gEngine.scenes.length>0){gEngine.removeScene(gEngine.scenes.last())}JSManager.SyncJSFiles(jsonData.jsFiles,function(){if(jsonData.jsStart&&window[jsonData.jsStart]){new window[jsonData.jsStart]}else{gEngine.addScene(new SceneManagerGame)}})};JSManager.ParseJSForFileType=function(jsData,db,format){var FindOpeningQuote=function(string){for(var i=string.length-2;i>=0;--i){if(string[i]==='"'||string[i]==="'"){return string.substring(i+1)}}return string};var files,file,i;files=jsData.split(format+'"');if(files.length>1){for(i=0;i<files.length-1;++i){file=files[i];file=FindOpeningQuote(file);if(file){if(!file.isHTTP()){file+=format;if(DBAssets.ResourceFiles.find(file)===-1){db.addOnce(file)}}}}}files=jsData.split(format+"'");if(files.length>1){for(i=0;i<files.length-1;++i){file=files[i];file=FindOpeningQuote(file);if(file){if(!file.isHTTP()){file+=format;if(DBAssets.ResourceFiles.find(file)===-1){db.addOnce(file)}}}}}};JSManager.ParseJSForInfoType=function(jsData,db,token){var FindClosingQuote=function(string){for(var i=0;i<string.length;++i){if(string[i]==='"'||string[i]==="'"){return string.substring(0,i)}}return null};var infos,info,i;infos=jsData.split('"'+token+".");if(infos.length>1){for(i=1;i<infos.length;++i){info=infos[i];info=FindClosingQuote(info);if(info){info=token+"."+info;db.addOnce(info)}}}infos=jsData.split("'"+token+".");if(infos.length>1){for(i=1;i<infos.length;++i){info=infos[i];info=FindClosingQuote(info);if(info){info=token+"."+info;db.addOnce(info)}}}};JSManager.ParseJSForAssets=function(jsData,files,infos){var deadCode=jsData.split("//");jsData=deadCode[0];for(var i=1;i<deadCode.length;++i){var code=String.SplitAfter(deadCode[i],"\n");jsData+="\n";jsData+=code}JSManager.ParseJSForFileType(jsData,files,".jpg");JSManager.ParseJSForFileType(jsData,files,".png");JSManager.ParseJSForFileType(jsData,files,".fbxi");JSManager.ParseJSForFileType(jsData,files,".obj");JSManager.ParseJSForInfoType(jsData,infos,"audio");JSManager.ParseJSForInfoType(jsData,infos,"character");JSManager.ParseJSForInfoType(jsData,infos,"map");JSManager.ParseJSForInfoType(jsData,infos,"model")};function MultiplayerManager(){}MultiplayerManager.LoggedIn=false;MultiplayerManager.SessionID="undefined";MultiplayerManager.UserID=CC.LoadData("userID");if(!MultiplayerManager.UserID){MultiplayerManager.UserID="undefined"}MultiplayerManager.LinkedUsers=CC.LoadData("MultiplayerManager.LinkedUsers");if(MultiplayerManager.LinkedUsers){MultiplayerManager.LinkedUsers=MultiplayerManager.LinkedUsers.split(",")}else{MultiplayerManager.LinkedUsers=[]}MultiplayerManager.Password=undefined;MultiplayerManager.UpdateCallbacks=[];MultiplayerManager.UserInfos=[];MultiplayerManager.Disconnect=function(){this.ForceDisconnected=true;if(window.SocketManager){SocketManager.ForceDisconnect()}};MultiplayerManager.Emit=function(id){if(MultiplayerManager.LoggedIn&&window.socket){if(arguments.length===1){window.socket.emit(id)}else if(arguments.length===2){window.socket.emit(id,arguments[1])}else if(arguments.length===3){window.socket.emit(id,arguments[1],arguments[2])}else if(arguments.length===4){window.socket.emit(id,arguments[1],arguments[2],arguments[3])}else if(arguments.length===5){window.socket.emit(id,arguments[1],arguments[2],arguments[3],arguments[4])}else{alert("MultiplayerManager.Emit: Too many arguments")}return true}return false};MultiplayerManager.Connect=function(){if(MultiplayerManager.ForceDisconnected){delete this.ForceDisconnected}if(window.socket){return}if(window.SocketManager){SocketManager.Restart();return}var serverURL,httpServerURL;var httpPorts=[80,4e3];var currentPortIndex=0;var SocketIOConnectionFunction=function(result){if(!window.SocketManager){setTimeout(function(){currentPortIndex++;if(currentPortIndex>=httpPorts.length){currentPortIndex=0}httpServerURL="http://"+serverURL+":"+httpPorts[currentPortIndex]+"/";CC.LoadScript(httpServerURL+"socketmanager.js",SocketIOConnectionFunction)},5e3)}else{var LoadClientServices=function(result){CC.LoadScript(httpServerURL+"clientservices.js",function(result){if(result&&window.services){SocketManager.Start(serverURL,httpPorts[currentPortIndex])}else{setTimeout(LoadClientServices,5e3)}})};LoadClientServices()}};if(DEBUG_UseLocalServer){currentPortIndex=1;serverURL="192.168.1.89";if(window.location.href.split("/localhost/").length>1){serverURL="localhost"}httpServerURL="http://"+serverURL+":4000/";CC.LoadScript(httpServerURL+"socketmanager.js",SocketIOConnectionFunction)}else{var ServerConnectionFunction=function(){var url="http://playir.com/backend/lobby.php?list&client="+window.APP_ID;if(MultiplayerManager.UseURLProxy(url)){url=SERVER_ROOT+"backend/helper.php?url="+url+"&noCache="+(new Date).getTime()}gURLManager.requestURL(url,null,function(status,responseText){if(status>=CCURLRequest.Succeeded&&responseText&&responseText.length>0){serverURL=responseText.split(":")[0];httpServerURL="http://"+responseText+"/";CC.LoadScript(httpServerURL+"socketmanager.js",SocketIOConnectionFunction)}else{setTimeout(ServerConnectionFunction,1e4)}},1,"socketURL",0)};ServerConnectionFunction()}};MultiplayerManager.DetectGeoLocation=function(){var url="http://playir.com/backend/mapper.php?ip";if(MultiplayerManager.UseURLProxy(url)){url=SERVER_ROOT+"backend/helper.php?url="+url}gURLManager.requestURL(url,null,function(status,responseText){if(status>=CCURLRequest.Succeeded){MultiplayerManager.DetectedGeoLocation(responseText)}})};MultiplayerManager.DetectedGeoLocation=function(geoLocationData){if(geoLocationData&&geoLocationData.length>0){try{var root=JSON.parse(geoLocationData);if(root){if(root.statusCode==="OK"){var geoLocationCountryCode=root.countryCode;if(geoLocationCountryCode&&geoLocationCountryCode.length===2){MultiplayerManager.geoLocationCountryCode=geoLocationCountryCode.toLowerCase();if(window.sceneManagerGame){sceneManagerGame.createFlag()}}}}}catch(error){}}};MultiplayerManager.RequestJoinMap=function(mapID,playerType){MultiplayerManager.Emit("BSJoinMap",playerType,mapID)};MultiplayerManager.SyncLoadedMap=function(location){if(MultiplayerManager.LoggedIn){BurgersClient.enteredGame(location)}};MultiplayerManager.LocationVector=vec3.create();MultiplayerManager.SyncServerPlayerGotoLocation=function(map,location){if(map.isOnlineGame()){if(MultiplayerManager.LoggedIn){var mapBounds=map.getMapBounds();var LocationVector=MultiplayerManager.LocationVector;LocationVector[0]=location[0]/mapBounds.width;LocationVector[1]=location[1];LocationVector[2]=location[2]/mapBounds.width;var tLocation=vec3.toString(LocationVector);BurgersClient.gotoLocation(tLocation)}}};MultiplayerManager.SyncServerPlayerShootAt=function(map,targetID){if(map.isOnlineGame()){if(MultiplayerManager.LoggedIn){BurgersClient.shootAt(targetID)}}};MultiplayerManager.SyncShootAtTarget=function(map,targetLocation){if(map.isOnlineGame()){var mapBounds=map.getMapBounds();var LocationVector=MultiplayerManager.LocationVector;LocationVector[0]=location[0]/mapBounds.width;LocationVector[1]=location[1];LocationVector[2]=location[2]/mapBounds.width;var tLocation=vec3.toString(LocationVector);MultiplayerManager.Emit("SyncShootAtTarget",targetLocation)}};MultiplayerManager.SyncHealth=function(map,health){if(map.isOnlineGame()){MultiplayerManager.Emit("SyncHealth",health)}};MultiplayerManager.SyncPlayerAction=function(map,actionID){if(map.isOnlineGame()){MultiplayerManager.Emit("SyncPlayerAction",actionID)}};MultiplayerManager.SyncRegisterDamage=function(victimID,attackerID,damage){MultiplayerManager.Emit("SyncRegisterDamage",victimID,attackerID,damage)};MultiplayerManager.SyncServerRegisterPickup=function(playerID,pickupType,pickupID){MultiplayerManager.Emit("BSRegisterPickup",playerID,pickupType,pickupID?pickupID:"0")};MultiplayerManager.SyncMessage=function(message,toID){MultiplayerManager.Emit("SyncMessage",message,toID)};MultiplayerManager.IsOwner=function(owners){if(MultiplayerManager.admin){return true}if(owners){var i;var LinkedUsers=MultiplayerManager.LinkedUsers;for(i=0;i<owners.length;++i){var ownerID=owners[i];if(ownerID===MultiplayerManager.UserID){return true}for(var j=0;j<LinkedUsers.length;++j){var linkedID=LinkedUsers[j];if(ownerID===linkedID){return true}}}}return false};MultiplayerManager.UseURLProxy=function(url){if(window.tizen){return false}if(url.getDomain()!==WINDOW_DOMAIN){return true}return false};MultiplayerManager.GetAssetURL=function(path){if(path.isHTTP()){return path
}if(path.containsDirectory()){return SERVER_ROOT+path}if(window.tizen){var PackagedFiles=CCEngine.PackagedFiles;if(PackagedFiles){for(var i=0;i<PackagedFiles.length;++i){var packagedFile=PackagedFiles[i];if(packagedFile===path){return"packaged/"+packagedFile}}}}var filename=path.stripDirectory();var url=SERVER_ASSETS_URL+"assets/?file="+filename;if(MultiplayerManager.UseURLProxy(url)){url=SERVER_ROOT+"backend/helper.php?url="+url}return url};MultiplayerManager.LoadCountry=function(tile,countryCode,callback){tile.shouldRender=false;if(countryCode&&countryCode.length===2){var geoLocationCountryCode=countryCode.toLowerCase();var src="flag_";src+=geoLocationCountryCode;src+=".png";if(tile.tileSquares.length===0){tile.setupTextured(src,callback)}else{tile.setupTexturedHeight(tile.collisionSize.height,src,callback)}tile.shouldRender=true}};MultiplayerManager.LoadLocalUserInfo=function(callback){CCFileManager.Load(APP_ID+".db",function(data){callback(data)});CCFileManager.Save(APP_ID+".db",JSON.stringify(this.db))};MultiplayerManager.SaveLocalUserInfo=function(data){CCFileManager.Save(APP_ID+".db",data)};MultiplayerManager.IsUserLoggedIn=function(){var userInfo=MultiplayerManager.GetUserInfo(MultiplayerManager.UserID);if(userInfo){return userInfo.facebook||userInfo.twitter||userInfo.google}return false};MultiplayerManager.RegisterFacebook=function(){if(MultiplayerManager.LoggedIn){var self=this;TileSocialProfile.GetFBInfo(2,function(id,name){if(id&&name){if(MultiplayerManager.Emit("BSRegisterFacebook",id,name)){var userInfo=MultiplayerManager.GetUserInfo(MultiplayerManager.UserID);if(userInfo){userInfo.facebook=true}var UpdateCallbacks=MultiplayerManager.UpdateCallbacks;for(i=0;i<UpdateCallbacks.length;++i){if(UpdateCallbacks[i].syncLoggedIntoSocialNetwork){UpdateCallbacks[i].syncLoggedIntoSocialNetwork("facebook",id,name)}}}}})}};MultiplayerManager.RegisterTwitter=function(){if(MultiplayerManager.LoggedIn){var self=this;var username=TileSocialProfile.GetTwitterInfo();if(username){if(MultiplayerManager.Emit("BSRegisterTwitter",username)){var userInfo=MultiplayerManager.GetUserInfo(MultiplayerManager.UserID);if(userInfo){userInfo.twitter=true}var UpdateCallbacks=MultiplayerManager.UpdateCallbacks;for(i=0;i<UpdateCallbacks.length;++i){if(UpdateCallbacks[i].syncLoggedIntoSocialNetwork){UpdateCallbacks[i].syncLoggedIntoSocialNetwork("twitter",username,"@"+username)}}}}}};MultiplayerManager.RegisterGoogle=function(){if(MultiplayerManager.LoggedIn){var self=this;TileSocialProfile.GetGoogleInfo(function(id,name){if(id&&name){if(MultiplayerManager.Emit("BSRegisterGoogle",id,name)){var userInfo=MultiplayerManager.GetUserInfo(MultiplayerManager.UserID);if(userInfo){userInfo.google=true}var UpdateCallbacks=MultiplayerManager.UpdateCallbacks;for(i=0;i<UpdateCallbacks.length;++i){if(UpdateCallbacks[i].syncLoggedIntoSocialNetwork){UpdateCallbacks[i].syncLoggedIntoSocialNetwork("google",id)}}}}})}};MultiplayerManager.UpdateUserInfo=function(userInfo){for(var i=0;i<this.UserInfos.length;++i){var itr=this.UserInfos[i];if(itr.userID===userInfo.userID){this.UserInfos[i]=userInfo;return}}this.UserInfos.add(userInfo)};MultiplayerManager.GetUserInfo=function(userID){for(var i=0;i<this.UserInfos.length;++i){var itr=this.UserInfos[i];if(itr.userID===userID){return itr}}return null};function onServerUpdate(service,id,jsonData){var UpdateCallbacks=MultiplayerManager.UpdateCallbacks;var HandleUpdateFunction=function(){var i;if(id==="BurgersLoggedIn"){if(!MultiplayerManager.ForceDisconnected&&window.socket){var serviceID=service.serviceID;MultiplayerManager.LoggedIn=true;if(jsonData){MultiplayerManager.LinkedUsers=jsonData;CC.SaveData("MultiplayerManager.LinkedUsers",MultiplayerManager.LinkedUsers)}BurgersClient.registerDevice(CCEngine.DeviceType,APP_ID,CLIENT_VERSION);for(i=0;i<UpdateCallbacks.length;++i){if(UpdateCallbacks[i].syncLoggedIn){UpdateCallbacks[i].syncLoggedIn()}}socket.onOnly("SyncMessage",function(message,fromPlayerID,fromUserID){for(i=0;i<UpdateCallbacks.length;++i){if(UpdateCallbacks[i].syncMessage){UpdateCallbacks[i].syncMessage(message,fromPlayerID,fromUserID)}}})}}else if(id==="UpdateLinkedUsers"){if(jsonData){MultiplayerManager.LinkedUsers=jsonData;CC.SaveData("MultiplayerManager.LinkedUsers",MultiplayerManager.LinkedUsers)}}else if(id==="BurgersGameUpdate"){var pendingCallbacks=UpdateCallbacks.slice(0);for(i=0;i<pendingCallbacks.length;++i){if(pendingCallbacks[i].syncUpdate){pendingCallbacks[i].syncUpdate(jsonData)}}if(jsonData.Restart){SceneMultiManager.RestartClient()}else if(jsonData.SoftRestart){JSManager.SoftRestart(jsonData)}else if(jsonData.userInfo){var userInfo=jsonData.userInfo;if(userInfo.userID===MultiplayerManager.UserID){if(!userInfo.facebook){MultiplayerManager.RegisterFacebook()}if(!userInfo.twitter){MultiplayerManager.RegisterTwitter()}if(!userInfo.google){MultiplayerManager.RegisterGoogle()}}MultiplayerManager.UpdateUserInfo(userInfo)}else if(jsonData.appInfo){var appInfo=jsonData.appInfo;var appInfos;var appInfoString=CC.LoadData("appInfos");if(appInfoString){appInfos=JSON.parse(appInfoString);if(!appInfos){appInfos=[]}}else{appInfos=[]}var found=false;for(i=0;i<appInfos.length;++i){if(appInfos[i].id===appInfo.id){found=true;appInfos[i]=appInfo;break}}if(!found){appInfos.push(appInfo)}CC.SaveData("appInfos",JSON.stringify(appInfos));if(appInfo.jsSync){if(SceneMultiManager.LoadingGame){SceneMultiManager.LoadingAppInfoUpdated=true;return}JSManager.RuntimePatch(appInfo.jsFiles)}}}};HandleUpdateFunction()}function onConnect(sessionID,sessionPassword){if(MultiplayerManager.ForceDisconnected){if(window.SocketManager){SocketManager.ForceDisconnect()}}if(MultiplayerManager.LoggedIn){MultiplayerManager.LoggedIn=false}MultiplayerManager.SessionID=sessionID;var userID=getUserID(sessionID);var password=getPassword(sessionPassword);MultiplayerManager.UserID=userID;MultiplayerManager.Password=password;login(userID,password);registerSocketServices(socket)}function onDisconnect(){if(MultiplayerManager.LoggedIn){MultiplayerManager.LoggedIn=false}var UpdateCallbacks=MultiplayerManager.UpdateCallbacks;for(i=0;i<UpdateCallbacks.length;++i){if(UpdateCallbacks[i].syncDisconnected){UpdateCallbacks[i].syncDisconnected()}}disconnectServices()}function updateServices(){}var DEBUG_UseLocalServer=0;var DEBUG_SlowNetwork=0;if(!window.WINDOW_DOMAIN){window.WINDOW_DOMAIN=window.location.href}WINDOW_DOMAIN=WINDOW_DOMAIN.getDomain();if(window.location.href.startsWith("http://localhost")||window.location.href.startsWith("http://192.168.")){window.DEBUG_IsLocalClient=true}if(!window.SERVER_ROOT){window.SERVER_ROOT=""}SERVER_ROOT=SERVER_ROOT.resolveURL();if(DEBUG_UseLocalServer){window.SERVER_ASSETS_URL=SERVER_ROOT}else{window.SERVER_ASSETS_URL="http://playir.com/"}var CLIENT_VERSION=17;var FORCE_ONLINE=CC.GetJSLocationBarData("online");window.APP_ID=CC.GetJSLocationBarData("id",window.APP_ID);if(!window.APP_ID){window.APP_ID="multi"}window.LAUNCH_APP_ID=window.APP_ID;window.DEFAULT_PURCHASE_ID="topup_1";CCEngine.prototype.start=function(){JSManager.RemoveJSFiles();CCAudioManager.StopAll();this.textureManager.loadFont("HelveticaNeueLight");if(window.APP_ID==="testgame"){TestGame()}else if(window.APP_ID==="testshop"){setTimeout(function(){new SceneItemShop("Get more coins","topup_1",true,1e3,10,10,function(type,itemCode,value){alert(type+" "+value)})},50)}else if(window.APP_ID==="testperceptual"){TestPerceptual()}else if(window.APP_ID==="editor"){new SceneProjectManager;SceneMultiManager.EditorEnabled=true;SceneMultiManager.EditorAllowed=true}else{var joinMapID=CC.GetJSLocationBarData("map");var joinPlayerType=CC.GetJSLocationBarData("player");if(joinMapID){new SceneManagerJoinMap(joinMapID,joinPlayerType)}else{setTimeout(function(){},1);new SceneMultiManager}}MultiplayerManager.DetectGeoLocation();MultiplayerManager.Connect()};function TestGame(){var map=new SceneGame1vs1(null);var objFile="androBot_head.obj";var texFile="_boxxy.jpg";var object=new CCCollideableStaticMesh("boxxy");object.setScene(map);object.setCollideable(false);object.setTransparent();object.setDrawOrder(99);object.setupModel(objFile,texFile,50,function(object){});var player;{player=map.spawnCharacter("iBot");map.assignPlayerCharacter(player);player.setPositionX(-50)}{player=map.spawnCharacter("androBot");map.addEnemy(player);player.setPositionX(50)}map.startPlaying()}function TestPerceptual(){var map=new SceneGame1vs1(null);var objFile="androBot_head.obj";var texFile="_boxxy.jpg";var object=new CCCollideableStaticMesh("boxxy");object.setScene(map);object.setCollideable(false);var referencedTextureIndex=0;if(gEngine.textureManager.referenceTexture){referencedTextureIndex=gEngine.textureManager.referenceTexture("camera")}var primitive=new CCPrimitiveOBJ;if(primitive.reference){primitive.reference("camera");primitive.setTextureIndex(referencedTextureIndex);object.setCulling(false)}object.model.addPrimitive(primitive);object.setTransparent();CCModel3D.CacheModel(objFile,true,function(model3d){if(model3d){object.model3d=model3d;object.setColourAlpha(1,true);object.model.addModel(model3d)}},1);var player;{player=map.spawnCharacter("iBot");map.assignPlayerCharacter(player);player.setPositionX(-50)}{player=map.spawnCharacter("androBot");map.addEnemy(player);player.setPositionX(50)}map.startPlaying()}