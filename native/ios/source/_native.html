<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="cache-control" content="no-cache" />

        <script>
        window.SERVER_ROOT = "http://playir.com/";

        if( window.location && window.location.href )
        {
            var split = window.location.href.split( "server=" );
            if( split.length > 1 )
            {
                SERVER_ROOT = split[1];
            }
        }
        window.WINDOW_DOMAIN = SERVER_ROOT;
        </script>

        <script>
!function(){"use strict";var shim={};if(typeof exports==="undefined"){if(typeof define=="function"&&typeof define.amd=="object"&&define.amd){shim.exports={};define(function(){return shim.exports})}else{shim.exports=window}}else{shim.exports=exports}!function(exports){if(!GLMAT_EPSILON){var GLMAT_EPSILON=1e-6}if(!GLMAT_ARRAY_TYPE){var GLMAT_ARRAY_TYPE=typeof Float32Array!=="undefined"?Float32Array:Array}var glMatrix={};glMatrix.setMatrixArrayType=function(type){GLMAT_ARRAY_TYPE=type};if(typeof exports!=="undefined"){exports.glMatrix=glMatrix}var vec2={};vec2.create=function(){var out=new GLMAT_ARRAY_TYPE(2);out[0]=0;out[1]=0;return out};vec2.clone=function(a){var out=new GLMAT_ARRAY_TYPE(2);out[0]=a[0];out[1]=a[1];return out};vec2.fromValues=function(x,y){var out=new GLMAT_ARRAY_TYPE(2);out[0]=x;out[1]=y;return out};vec2.copy=function(out,a){out[0]=a[0];out[1]=a[1];return out};vec2.set=function(out,x,y){out[0]=x;out[1]=y;return out};vec2.add=function(out,a,b){out[0]=a[0]+b[0];out[1]=a[1]+b[1];return out};vec2.subtract=function(out,a,b){out[0]=a[0]-b[0];out[1]=a[1]-b[1];return out};vec2.sub=vec2.subtract;vec2.multiply=function(out,a,b){out[0]=a[0]*b[0];out[1]=a[1]*b[1];return out};vec2.mul=vec2.multiply;vec2.divide=function(out,a,b){out[0]=a[0]/b[0];out[1]=a[1]/b[1];return out};vec2.div=vec2.divide;vec2.min=function(out,a,b){out[0]=Math.min(a[0],b[0]);out[1]=Math.min(a[1],b[1]);return out};vec2.max=function(out,a,b){out[0]=Math.max(a[0],b[0]);out[1]=Math.max(a[1],b[1]);return out};vec2.scale=function(out,a,b){out[0]=a[0]*b;out[1]=a[1]*b;return out};vec2.distance=function(a,b){var x=b[0]-a[0],y=b[1]-a[1];return Math.sqrt(x*x+y*y)};vec2.dist=vec2.distance;vec2.squaredDistance=function(a,b){var x=b[0]-a[0],y=b[1]-a[1];return x*x+y*y};vec2.sqrDist=vec2.squaredDistance;vec2.length=function(a){var x=a[0],y=a[1];return Math.sqrt(x*x+y*y)};vec2.len=vec2.length;vec2.squaredLength=function(a){var x=a[0],y=a[1];return x*x+y*y};vec2.sqrLen=vec2.squaredLength;vec2.negate=function(out,a){out[0]=-a[0];out[1]=-a[1];return out};vec2.normalize=function(out,a){var x=a[0],y=a[1];var len=x*x+y*y;if(len>0){len=1/Math.sqrt(len);out[0]=a[0]*len;out[1]=a[1]*len}return out};vec2.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]};vec2.cross=function(out,a,b){var z=a[0]*b[1]-a[1]*b[0];out[0]=out[1]=0;out[2]=z;return out};vec2.lerp=function(out,a,b,t){var ax=a[0],ay=a[1];out[0]=ax+t*(b[0]-ax);out[1]=ay+t*(b[1]-ay);return out};vec2.transformMat2=function(out,a,m){var x=a[0],y=a[1];out[0]=m[0]*x+m[2]*y;out[1]=m[1]*x+m[3]*y;return out};vec2.transformMat2d=function(out,a,m){var x=a[0],y=a[1];out[0]=m[0]*x+m[2]*y+m[4];out[1]=m[1]*x+m[3]*y+m[5];return out};vec2.transformMat3=function(out,a,m){var x=a[0],y=a[1];out[0]=m[0]*x+m[3]*y+m[6];out[1]=m[1]*x+m[4]*y+m[7];return out};vec2.transformMat4=function(out,a,m){var x=a[0],y=a[1];out[0]=m[0]*x+m[4]*y+m[12];out[1]=m[1]*x+m[5]*y+m[13];return out};vec2.forEach=function(){var vec=vec2.create();return function(a,stride,offset,count,fn,arg){var i,l;if(!stride){stride=2}if(!offset){offset=0}if(count){l=Math.min(count*stride+offset,a.length)}else{l=a.length}for(i=offset;i<l;i+=stride){vec[0]=a[i];vec[1]=a[i+1];fn(vec,vec,arg);a[i]=vec[0];a[i+1]=vec[1]}return a}}();vec2.str=function(a){return"vec2("+a[0]+", "+a[1]+")"};if(typeof exports!=="undefined"){exports.vec2=vec2}var vec3={};vec3.create=function(){var out=new GLMAT_ARRAY_TYPE(3);out[0]=0;out[1]=0;out[2]=0;return out};vec3.clone=function(a){var out=new GLMAT_ARRAY_TYPE(3);out[0]=a[0];out[1]=a[1];out[2]=a[2];return out};vec3.fromValues=function(x,y,z){var out=new GLMAT_ARRAY_TYPE(3);out[0]=x;out[1]=y;out[2]=z;return out};vec3.copy=function(out,a){out[0]=a[0];out[1]=a[1];out[2]=a[2];return out};vec3.set=function(out,x,y,z){out[0]=x;out[1]=y;out[2]=z;return out};vec3.add=function(out,a,b){out[0]=a[0]+b[0];out[1]=a[1]+b[1];out[2]=a[2]+b[2];return out};vec3.subtract=function(out,a,b){out[0]=a[0]-b[0];out[1]=a[1]-b[1];out[2]=a[2]-b[2];return out};vec3.sub=vec3.subtract;vec3.multiply=function(out,a,b){out[0]=a[0]*b[0];out[1]=a[1]*b[1];out[2]=a[2]*b[2];return out};vec3.mul=vec3.multiply;vec3.divide=function(out,a,b){out[0]=a[0]/b[0];out[1]=a[1]/b[1];out[2]=a[2]/b[2];return out};vec3.div=vec3.divide;vec3.min=function(out,a,b){out[0]=Math.min(a[0],b[0]);out[1]=Math.min(a[1],b[1]);out[2]=Math.min(a[2],b[2]);return out};vec3.max=function(out,a,b){out[0]=Math.max(a[0],b[0]);out[1]=Math.max(a[1],b[1]);out[2]=Math.max(a[2],b[2]);return out};vec3.scale=function(out,a,b){out[0]=a[0]*b;out[1]=a[1]*b;out[2]=a[2]*b;return out};vec3.dist=vec3.distance;vec3.squaredDistance=function(a,b){var x=b[0]-a[0],y=b[1]-a[1],z=b[2]-a[2];return x*x+y*y+z*z};vec3.sqrDist=vec3.squaredDistance;vec3.length=function(a){var x=a[0],y=a[1],z=a[2];return Math.sqrt(x*x+y*y+z*z)};vec3.len=vec3.length;vec3.squaredLength=function(a){var x=a[0],y=a[1],z=a[2];return x*x+y*y+z*z};vec3.sqrLen=vec3.squaredLength;vec3.negate=function(out,a){out[0]=-a[0];out[1]=-a[1];out[2]=-a[2];return out};vec3.normalize=function(out,a){var x=a[0],y=a[1],z=a[2];var len=x*x+y*y+z*z;if(len>0){len=1/Math.sqrt(len);out[0]=a[0]*len;out[1]=a[1]*len;out[2]=a[2]*len}return out};vec3.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]};vec3.cross=function(out,a,b){var ax=a[0],ay=a[1],az=a[2],bx=b[0],by=b[1],bz=b[2];out[0]=ay*bz-az*by;out[1]=az*bx-ax*bz;out[2]=ax*by-ay*bx;return out};vec3.lerp=function(out,a,b,t){var ax=a[0],ay=a[1],az=a[2];out[0]=ax+t*(b[0]-ax);out[1]=ay+t*(b[1]-ay);out[2]=az+t*(b[2]-az);return out};vec3.transformMat4=function(out,a,m){var x=a[0],y=a[1],z=a[2];out[0]=m[0]*x+m[4]*y+m[8]*z+m[12];out[1]=m[1]*x+m[5]*y+m[9]*z+m[13];out[2]=m[2]*x+m[6]*y+m[10]*z+m[14];return out};vec3.transformQuat=function(out,a,q){var x=a[0],y=a[1],z=a[2],qx=q[0],qy=q[1],qz=q[2],qw=q[3],ix=qw*x+qy*z-qz*y,iy=qw*y+qz*x-qx*z,iz=qw*z+qx*y-qy*x,iw=-qx*x-qy*y-qz*z;out[0]=ix*qw+iw*-qx+iy*-qz-iz*-qy;out[1]=iy*qw+iw*-qy+iz*-qx-ix*-qz;out[2]=iz*qw+iw*-qz+ix*-qy-iy*-qx;return out};vec3.forEach=function(){var vec=vec3.create();return function(a,stride,offset,count,fn,arg){var i,l;if(!stride){stride=3}if(!offset){offset=0}if(count){l=Math.min(count*stride+offset,a.length)}else{l=a.length}for(i=offset;i<l;i+=stride){vec[0]=a[i];vec[1]=a[i+1];vec[2]=a[i+2];fn(vec,vec,arg);a[i]=vec[0];a[i+1]=vec[1];a[i+2]=vec[2]}return a}}();vec3.str=function(a){return"vec3("+a[0]+", "+a[1]+", "+a[2]+")"};if(typeof exports!=="undefined"){exports.vec3=vec3}var vec4={};vec4.create=function(){var out=new GLMAT_ARRAY_TYPE(4);out[0]=0;out[1]=0;out[2]=0;out[3]=0;return out};vec4.clone=function(a){var out=new GLMAT_ARRAY_TYPE(4);out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];return out};vec4.fromValues=function(x,y,z,w){var out=new GLMAT_ARRAY_TYPE(4);out[0]=x;out[1]=y;out[2]=z;out[3]=w;return out};vec4.copy=function(out,a){out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];return out};vec4.set=function(out,x,y,z,w){out[0]=x;out[1]=y;out[2]=z;out[3]=w;return out};vec4.add=function(out,a,b){out[0]=a[0]+b[0];out[1]=a[1]+b[1];out[2]=a[2]+b[2];out[3]=a[3]+b[3];return out};vec4.subtract=function(out,a,b){out[0]=a[0]-b[0];out[1]=a[1]-b[1];out[2]=a[2]-b[2];out[3]=a[3]-b[3];return out};vec4.sub=vec4.subtract;vec4.multiply=function(out,a,b){out[0]=a[0]*b[0];out[1]=a[1]*b[1];out[2]=a[2]*b[2];out[3]=a[3]*b[3];return out};vec4.mul=vec4.multiply;vec4.divide=function(out,a,b){out[0]=a[0]/b[0];out[1]=a[1]/b[1];out[2]=a[2]/b[2];out[3]=a[3]/b[3];return out};vec4.div=vec4.divide;vec4.min=function(out,a,b){out[0]=Math.min(a[0],b[0]);out[1]=Math.min(a[1],b[1]);out[2]=Math.min(a[2],b[2]);out[3]=Math.min(a[3],b[3]);return out};vec4.max=function(out,a,b){out[0]=Math.max(a[0],b[0]);out[1]=Math.max(a[1],b[1]);out[2]=Math.max(a[2],b[2]);out[3]=Math.max(a[3],b[3]);return out};vec4.scale=function(out,a,b){out[0]=a[0]*b;out[1]=a[1]*b;out[2]=a[2]*b;out[3]=a[3]*b;return out};vec4.distance=function(a,b){var x=b[0]-a[0],y=b[1]-a[1],z=b[2]-a[2],w=b[3]-a[3];return Math.sqrt(x*x+y*y+z*z+w*w)};vec4.dist=vec4.distance;vec4.squaredDistance=function(a,b){var x=b[0]-a[0],y=b[1]-a[1],z=b[2]-a[2],w=b[3]-a[3];return x*x+y*y+z*z+w*w};vec4.sqrDist=vec4.squaredDistance;vec4.length=function(a){var x=a[0],y=a[1],z=a[2],w=a[3];return Math.sqrt(x*x+y*y+z*z+w*w)};vec4.len=vec4.length;vec4.squaredLength=function(a){var x=a[0],y=a[1],z=a[2],w=a[3];return x*x+y*y+z*z+w*w};vec4.sqrLen=vec4.squaredLength;vec4.negate=function(out,a){out[0]=-a[0];out[1]=-a[1];out[2]=-a[2];out[3]=-a[3];return out};vec4.normalize=function(out,a){var x=a[0],y=a[1],z=a[2],w=a[3];var len=x*x+y*y+z*z+w*w;if(len>0){len=1/Math.sqrt(len);out[0]=a[0]*len;out[1]=a[1]*len;out[2]=a[2]*len;out[3]=a[3]*len}return out};vec4.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3]*b[3]};vec4.lerp=function(out,a,b,t){var ax=a[0],ay=a[1],az=a[2],aw=a[3];out[0]=ax+t*(b[0]-ax);out[1]=ay+t*(b[1]-ay);out[2]=az+t*(b[2]-az);out[3]=aw+t*(b[3]-aw);return out};vec4.transformMat4=function(out,a,m){var x=a[0],y=a[1],z=a[2],w=a[3];out[0]=m[0]*x+m[4]*y+m[8]*z+m[12]*w;out[1]=m[1]*x+m[5]*y+m[9]*z+m[13]*w;out[2]=m[2]*x+m[6]*y+m[10]*z+m[14]*w;out[3]=m[3]*x+m[7]*y+m[11]*z+m[15]*w;return out};vec4.transformQuat=function(out,a,q){var x=a[0],y=a[1],z=a[2],qx=q[0],qy=q[1],qz=q[2],qw=q[3],ix=qw*x+qy*z-qz*y,iy=qw*y+qz*x-qx*z,iz=qw*z+qx*y-qy*x,iw=-qx*x-qy*y-qz*z;out[0]=ix*qw+iw*-qx+iy*-qz-iz*-qy;out[1]=iy*qw+iw*-qy+iz*-qx-ix*-qz;out[2]=iz*qw+iw*-qz+ix*-qy-iy*-qx;return out};vec4.forEach=function(){var vec=vec4.create();return function(a,stride,offset,count,fn,arg){var i,l;if(!stride){stride=4}if(!offset){offset=0}if(count){l=Math.min(count*stride+offset,a.length)}else{l=a.length}for(i=offset;i<l;i+=stride){vec[0]=a[i];vec[1]=a[i+1];vec[2]=a[i+2];vec[3]=a[i+3];fn(vec,vec,arg);a[i]=vec[0];a[i+1]=vec[1];a[i+2]=vec[2];a[i+3]=vec[3]}return a}}();vec4.str=function(a){return"vec4("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+")"};if(typeof exports!=="undefined"){exports.vec4=vec4}var mat2={};mat2.create=function(){var out=new GLMAT_ARRAY_TYPE(4);out[0]=1;out[1]=0;out[2]=0;out[3]=1;return out};mat2.clone=function(a){var out=new GLMAT_ARRAY_TYPE(4);out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];return out};mat2.copy=function(out,a){out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];return out};mat2.identity=function(out){out[0]=1;out[1]=0;out[2]=0;out[3]=1;return out};mat2.transpose=function(out,a){if(out===a){var a1=a[1];out[1]=a[2];out[2]=a1}else{out[0]=a[0];out[1]=a[2];out[2]=a[1];out[3]=a[3]}return out};mat2.invert=function(out,a){var a0=a[0],a1=a[1],a2=a[2],a3=a[3],det=a0*a3-a2*a1;if(!det){return null}det=1/det;out[0]=a3*det;out[1]=-a1*det;out[2]=-a2*det;out[3]=a0*det;return out};mat2.adjoint=function(out,a){var a0=a[0];out[0]=a[3];out[1]=-a[1];out[2]=-a[2];out[3]=a0;return out};mat2.determinant=function(a){return a[0]*a[3]-a[2]*a[1]};mat2.multiply=function(out,a,b){var a0=a[0],a1=a[1],a2=a[2],a3=a[3];var b0=b[0],b1=b[1],b2=b[2],b3=b[3];out[0]=a0*b0+a1*b2;out[1]=a0*b1+a1*b3;out[2]=a2*b0+a3*b2;out[3]=a2*b1+a3*b3;return out};mat2.mul=mat2.multiply;mat2.rotate=function(out,a,rad){var a0=a[0],a1=a[1],a2=a[2],a3=a[3],s=Math.sin(rad),c=Math.cos(rad);out[0]=a0*c+a1*s;out[1]=a0*-s+a1*c;out[2]=a2*c+a3*s;out[3]=a2*-s+a3*c;return out};mat2.scale=function(out,a,v){var a0=a[0],a1=a[1],a2=a[2],a3=a[3],v0=v[0],v1=v[1];out[0]=a0*v0;out[1]=a1*v1;out[2]=a2*v0;out[3]=a3*v1;return out};mat2.str=function(a){return"mat2("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+")"};if(typeof exports!=="undefined"){exports.mat2=mat2}var mat2d={};mat2d.create=function(){var out=new GLMAT_ARRAY_TYPE(6);out[0]=1;out[1]=0;out[2]=0;out[3]=1;out[4]=0;out[5]=0;return out};mat2d.clone=function(a){var out=new GLMAT_ARRAY_TYPE(6);out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];out[4]=a[4];out[5]=a[5];return out};mat2d.copy=function(out,a){out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];out[4]=a[4];out[5]=a[5];return out};mat2d.identity=function(out){out[0]=1;out[1]=0;out[2]=0;out[3]=1;out[4]=0;out[5]=0;return out};mat2d.invert=function(out,a){var aa=a[0],ab=a[1],ac=a[2],ad=a[3],atx=a[4],aty=a[5];var det=aa*ad-ab*ac;if(!det){return null}det=1/det;out[0]=ad*det;out[1]=-ab*det;out[2]=-ac*det;out[3]=aa*det;out[4]=(ac*aty-ad*atx)*det;out[5]=(ab*atx-aa*aty)*det;return out};mat2d.determinant=function(a){return a[0]*a[3]-a[1]*a[2]};mat2d.multiply=function(out,a,b){var aa=a[0],ab=a[1],ac=a[2],ad=a[3],atx=a[4],aty=a[5],ba=b[0],bb=b[1],bc=b[2],bd=b[3],btx=b[4],bty=b[5];out[0]=aa*ba+ab*bc;out[1]=aa*bb+ab*bd;out[2]=ac*ba+ad*bc;out[3]=ac*bb+ad*bd;out[4]=ba*atx+bc*aty+btx;out[5]=bb*atx+bd*aty+bty;return out};mat2d.mul=mat2d.multiply;mat2d.rotate=function(out,a,rad){var aa=a[0],ab=a[1],ac=a[2],ad=a[3],atx=a[4],aty=a[5],st=Math.sin(rad),ct=Math.cos(rad);out[0]=aa*ct+ab*st;out[1]=-aa*st+ab*ct;out[2]=ac*ct+ad*st;out[3]=-ac*st+ct*ad;out[4]=ct*atx+st*aty;out[5]=ct*aty-st*atx;return out};mat2d.scale=function(out,a,v){var vx=v[0],vy=v[1];out[0]=a[0]*vx;out[1]=a[1]*vy;out[2]=a[2]*vx;out[3]=a[3]*vy;out[4]=a[4]*vx;out[5]=a[5]*vy;return out};mat2d.translate=function(out,a,v){out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];out[4]=a[4]+v[0];out[5]=a[5]+v[1];return out};mat2d.str=function(a){return"mat2d("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+")"};if(typeof exports!=="undefined"){exports.mat2d=mat2d}var mat3={};mat3.create=function(){var out=new GLMAT_ARRAY_TYPE(9);out[0]=1;out[1]=0;out[2]=0;out[3]=0;out[4]=1;out[5]=0;out[6]=0;out[7]=0;out[8]=1;return out};mat3.fromMat4=function(out,a){out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[4];out[4]=a[5];out[5]=a[6];out[6]=a[8];out[7]=a[9];out[8]=a[10];return out};mat3.clone=function(a){var out=new GLMAT_ARRAY_TYPE(9);out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];out[4]=a[4];out[5]=a[5];out[6]=a[6];out[7]=a[7];out[8]=a[8];return out};mat3.copy=function(out,a){out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];out[4]=a[4];out[5]=a[5];out[6]=a[6];out[7]=a[7];out[8]=a[8];return out};mat3.identity=function(out){out[0]=1;out[1]=0;out[2]=0;out[3]=0;out[4]=1;out[5]=0;out[6]=0;out[7]=0;out[8]=1;return out};mat3.transpose=function(out,a){if(out===a){var a01=a[1],a02=a[2],a12=a[5];out[1]=a[3];out[2]=a[6];out[3]=a01;out[5]=a[7];out[6]=a02;out[7]=a12}else{out[0]=a[0];out[1]=a[3];out[2]=a[6];out[3]=a[1];out[4]=a[4];out[5]=a[7];out[6]=a[2];out[7]=a[5];out[8]=a[8]}return out};mat3.invert=function(out,a){var a00=a[0],a01=a[1],a02=a[2],a10=a[3],a11=a[4],a12=a[5],a20=a[6],a21=a[7],a22=a[8],b01=a22*a11-a12*a21,b11=-a22*a10+a12*a20,b21=a21*a10-a11*a20,det=a00*b01+a01*b11+a02*b21;if(!det){return null}det=1/det;out[0]=b01*det;out[1]=(-a22*a01+a02*a21)*det;out[2]=(a12*a01-a02*a11)*det;out[3]=b11*det;out[4]=(a22*a00-a02*a20)*det;out[5]=(-a12*a00+a02*a10)*det;out[6]=b21*det;out[7]=(-a21*a00+a01*a20)*det;out[8]=(a11*a00-a01*a10)*det;return out};mat3.adjoint=function(out,a){var a00=a[0],a01=a[1],a02=a[2],a10=a[3],a11=a[4],a12=a[5],a20=a[6],a21=a[7],a22=a[8];out[0]=a11*a22-a12*a21;out[1]=a02*a21-a01*a22;out[2]=a01*a12-a02*a11;out[3]=a12*a20-a10*a22;out[4]=a00*a22-a02*a20;out[5]=a02*a10-a00*a12;out[6]=a10*a21-a11*a20;out[7]=a01*a20-a00*a21;out[8]=a00*a11-a01*a10;return out};mat3.determinant=function(a){var a00=a[0],a01=a[1],a02=a[2],a10=a[3],a11=a[4],a12=a[5],a20=a[6],a21=a[7],a22=a[8];return a00*(a22*a11-a12*a21)+a01*(-a22*a10+a12*a20)+a02*(a21*a10-a11*a20)};mat3.multiply=function(out,a,b){var a00=a[0],a01=a[1],a02=a[2],a10=a[3],a11=a[4],a12=a[5],a20=a[6],a21=a[7],a22=a[8],b00=b[0],b01=b[1],b02=b[2],b10=b[3],b11=b[4],b12=b[5],b20=b[6],b21=b[7],b22=b[8];out[0]=b00*a00+b01*a10+b02*a20;out[1]=b00*a01+b01*a11+b02*a21;out[2]=b00*a02+b01*a12+b02*a22;out[3]=b10*a00+b11*a10+b12*a20;out[4]=b10*a01+b11*a11+b12*a21;out[5]=b10*a02+b11*a12+b12*a22;out[6]=b20*a00+b21*a10+b22*a20;out[7]=b20*a01+b21*a11+b22*a21;out[8]=b20*a02+b21*a12+b22*a22;return out};mat3.mul=mat3.multiply;mat3.translate=function(out,a,v){var a00=a[0],a01=a[1],a02=a[2],a10=a[3],a11=a[4],a12=a[5],a20=a[6],a21=a[7],a22=a[8],x=v[0],y=v[1];out[0]=a00;out[1]=a01;out[2]=a02;out[3]=a10;out[4]=a11;out[5]=a12;out[6]=x*a00+y*a10+a20;out[7]=x*a01+y*a11+a21;out[8]=x*a02+y*a12+a22;return out};mat3.rotate=function(out,a,rad){var a00=a[0],a01=a[1],a02=a[2],a10=a[3],a11=a[4],a12=a[5],a20=a[6],a21=a[7],a22=a[8],s=Math.sin(rad),c=Math.cos(rad);out[0]=c*a00+s*a10;out[1]=c*a01+s*a11;out[2]=c*a02+s*a12;out[3]=c*a10-s*a00;out[4]=c*a11-s*a01;out[5]=c*a12-s*a02;out[6]=a20;out[7]=a21;out[8]=a22;return out};mat3.scale=function(out,a,v){var x=v[0],y=v[1];out[0]=x*a[0];out[1]=x*a[1];out[2]=x*a[2];out[3]=y*a[3];out[4]=y*a[4];out[5]=y*a[5];out[6]=a[6];out[7]=a[7];out[8]=a[8];return out};mat3.fromMat2d=function(out,a){out[0]=a[0];out[1]=a[1];out[2]=0;out[3]=a[2];out[4]=a[3];out[5]=0;out[6]=a[4];out[7]=a[5];out[8]=1;return out};mat3.fromQuat=function(out,q){var x=q[0],y=q[1],z=q[2],w=q[3],x2=x+x,y2=y+y,z2=z+z,xx=x*x2,yx=y*x2,yy=y*y2,zx=z*x2,zy=z*y2,zz=z*z2,wx=w*x2,wy=w*y2,wz=w*z2;out[0]=1-yy-zz;out[3]=yx-wz;out[6]=zx+wy;out[1]=yx+wz;out[4]=1-xx-zz;out[7]=zy-wx;out[2]=zx-wy;out[5]=zy+wx;out[8]=1-xx-yy;return out};mat3.normalFromMat4=function(out,a){var a00=a[0],a01=a[1],a02=a[2],a03=a[3],a10=a[4],a11=a[5],a12=a[6],a13=a[7],a20=a[8],a21=a[9],a22=a[10],a23=a[11],a30=a[12],a31=a[13],a32=a[14],a33=a[15],b00=a00*a11-a01*a10,b01=a00*a12-a02*a10,b02=a00*a13-a03*a10,b03=a01*a12-a02*a11,b04=a01*a13-a03*a11,b05=a02*a13-a03*a12,b06=a20*a31-a21*a30,b07=a20*a32-a22*a30,b08=a20*a33-a23*a30,b09=a21*a32-a22*a31,b10=a21*a33-a23*a31,b11=a22*a33-a23*a32,det=b00*b11-b01*b10+b02*b09+b03*b08-b04*b07+b05*b06;if(!det){return null}det=1/det;out[0]=(a11*b11-a12*b10+a13*b09)*det;out[1]=(a12*b08-a10*b11-a13*b07)*det;out[2]=(a10*b10-a11*b08+a13*b06)*det;out[3]=(a02*b10-a01*b11-a03*b09)*det;out[4]=(a00*b11-a02*b08+a03*b07)*det;out[5]=(a01*b08-a00*b10-a03*b06)*det;out[6]=(a31*b05-a32*b04+a33*b03)*det;out[7]=(a32*b02-a30*b05-a33*b01)*det;out[8]=(a30*b04-a31*b02+a33*b00)*det;return out};mat3.str=function(a){return"mat3("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+", "+a[6]+", "+a[7]+", "+a[8]+")"};if(typeof exports!=="undefined"){exports.mat3=mat3}var mat4={};mat4.create=function(){var out=new GLMAT_ARRAY_TYPE(16);out[0]=1;out[1]=0;out[2]=0;out[3]=0;out[4]=0;out[5]=1;out[6]=0;out[7]=0;out[8]=0;out[9]=0;out[10]=1;out[11]=0;out[12]=0;out[13]=0;out[14]=0;out[15]=1;return out};mat4.clone=function(a){var out=new GLMAT_ARRAY_TYPE(16);out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];out[4]=a[4];out[5]=a[5];out[6]=a[6];out[7]=a[7];out[8]=a[8];out[9]=a[9];out[10]=a[10];out[11]=a[11];out[12]=a[12];out[13]=a[13];out[14]=a[14];out[15]=a[15];return out};mat4.copy=function(out,a){out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];out[4]=a[4];out[5]=a[5];out[6]=a[6];out[7]=a[7];out[8]=a[8];out[9]=a[9];out[10]=a[10];out[11]=a[11];out[12]=a[12];out[13]=a[13];out[14]=a[14];out[15]=a[15];return out};mat4.identity=function(out){out[0]=1;out[1]=0;out[2]=0;out[3]=0;out[4]=0;out[5]=1;out[6]=0;out[7]=0;out[8]=0;out[9]=0;out[10]=1;out[11]=0;out[12]=0;out[13]=0;out[14]=0;out[15]=1;return out};mat4.transpose=function(out,a){if(out===a){var a01=a[1],a02=a[2],a03=a[3],a12=a[6],a13=a[7],a23=a[11];out[1]=a[4];out[2]=a[8];out[3]=a[12];out[4]=a01;out[6]=a[9];out[7]=a[13];out[8]=a02;out[9]=a12;out[11]=a[14];out[12]=a03;out[13]=a13;out[14]=a23}else{out[0]=a[0];out[1]=a[4];out[2]=a[8];out[3]=a[12];out[4]=a[1];out[5]=a[5];out[6]=a[9];out[7]=a[13];out[8]=a[2];out[9]=a[6];out[10]=a[10];out[11]=a[14];out[12]=a[3];out[13]=a[7];out[14]=a[11];out[15]=a[15]}return out};mat4.invert=function(out,a){var a00=a[0],a01=a[1],a02=a[2],a03=a[3],a10=a[4],a11=a[5],a12=a[6],a13=a[7],a20=a[8],a21=a[9],a22=a[10],a23=a[11],a30=a[12],a31=a[13],a32=a[14],a33=a[15],b00=a00*a11-a01*a10,b01=a00*a12-a02*a10,b02=a00*a13-a03*a10,b03=a01*a12-a02*a11,b04=a01*a13-a03*a11,b05=a02*a13-a03*a12,b06=a20*a31-a21*a30,b07=a20*a32-a22*a30,b08=a20*a33-a23*a30,b09=a21*a32-a22*a31,b10=a21*a33-a23*a31,b11=a22*a33-a23*a32,det=b00*b11-b01*b10+b02*b09+b03*b08-b04*b07+b05*b06;if(!det){return null}det=1/det;out[0]=(a11*b11-a12*b10+a13*b09)*det;out[1]=(a02*b10-a01*b11-a03*b09)*det;out[2]=(a31*b05-a32*b04+a33*b03)*det;out[3]=(a22*b04-a21*b05-a23*b03)*det;out[4]=(a12*b08-a10*b11-a13*b07)*det;out[5]=(a00*b11-a02*b08+a03*b07)*det;out[6]=(a32*b02-a30*b05-a33*b01)*det;out[7]=(a20*b05-a22*b02+a23*b01)*det;out[8]=(a10*b10-a11*b08+a13*b06)*det;out[9]=(a01*b08-a00*b10-a03*b06)*det;out[10]=(a30*b04-a31*b02+a33*b00)*det;out[11]=(a21*b02-a20*b04-a23*b00)*det;out[12]=(a11*b07-a10*b09-a12*b06)*det;out[13]=(a00*b09-a01*b07+a02*b06)*det;out[14]=(a31*b01-a30*b03-a32*b00)*det;out[15]=(a20*b03-a21*b01+a22*b00)*det;return out};mat4.adjoint=function(out,a){var a00=a[0],a01=a[1],a02=a[2],a03=a[3],a10=a[4],a11=a[5],a12=a[6],a13=a[7],a20=a[8],a21=a[9],a22=a[10],a23=a[11],a30=a[12],a31=a[13],a32=a[14],a33=a[15];out[0]=a11*(a22*a33-a23*a32)-a21*(a12*a33-a13*a32)+a31*(a12*a23-a13*a22);out[1]=-(a01*(a22*a33-a23*a32)-a21*(a02*a33-a03*a32)+a31*(a02*a23-a03*a22));out[2]=a01*(a12*a33-a13*a32)-a11*(a02*a33-a03*a32)+a31*(a02*a13-a03*a12);out[3]=-(a01*(a12*a23-a13*a22)-a11*(a02*a23-a03*a22)+a21*(a02*a13-a03*a12));out[4]=-(a10*(a22*a33-a23*a32)-a20*(a12*a33-a13*a32)+a30*(a12*a23-a13*a22));out[5]=a00*(a22*a33-a23*a32)-a20*(a02*a33-a03*a32)+a30*(a02*a23-a03*a22);out[6]=-(a00*(a12*a33-a13*a32)-a10*(a02*a33-a03*a32)+a30*(a02*a13-a03*a12));out[7]=a00*(a12*a23-a13*a22)-a10*(a02*a23-a03*a22)+a20*(a02*a13-a03*a12);out[8]=a10*(a21*a33-a23*a31)-a20*(a11*a33-a13*a31)+a30*(a11*a23-a13*a21);out[9]=-(a00*(a21*a33-a23*a31)-a20*(a01*a33-a03*a31)+a30*(a01*a23-a03*a21));out[10]=a00*(a11*a33-a13*a31)-a10*(a01*a33-a03*a31)+a30*(a01*a13-a03*a11);out[11]=-(a00*(a11*a23-a13*a21)-a10*(a01*a23-a03*a21)+a20*(a01*a13-a03*a11));out[12]=-(a10*(a21*a32-a22*a31)-a20*(a11*a32-a12*a31)+a30*(a11*a22-a12*a21));out[13]=a00*(a21*a32-a22*a31)-a20*(a01*a32-a02*a31)+a30*(a01*a22-a02*a21);out[14]=-(a00*(a11*a32-a12*a31)-a10*(a01*a32-a02*a31)+a30*(a01*a12-a02*a11));out[15]=a00*(a11*a22-a12*a21)-a10*(a01*a22-a02*a21)+a20*(a01*a12-a02*a11);return out};mat4.determinant=function(a){var a00=a[0],a01=a[1],a02=a[2],a03=a[3],a10=a[4],a11=a[5],a12=a[6],a13=a[7],a20=a[8],a21=a[9],a22=a[10],a23=a[11],a30=a[12],a31=a[13],a32=a[14],a33=a[15],b00=a00*a11-a01*a10,b01=a00*a12-a02*a10,b02=a00*a13-a03*a10,b03=a01*a12-a02*a11,b04=a01*a13-a03*a11,b05=a02*a13-a03*a12,b06=a20*a31-a21*a30,b07=a20*a32-a22*a30,b08=a20*a33-a23*a30,b09=a21*a32-a22*a31,b10=a21*a33-a23*a31,b11=a22*a33-a23*a32;return b00*b11-b01*b10+b02*b09+b03*b08-b04*b07+b05*b06};mat4.multiply=function(out,a,b){var a00=a[0],a01=a[1],a02=a[2],a03=a[3],a10=a[4],a11=a[5],a12=a[6],a13=a[7],a20=a[8],a21=a[9],a22=a[10],a23=a[11],a30=a[12],a31=a[13],a32=a[14],a33=a[15];var b0=b[0],b1=b[1],b2=b[2],b3=b[3];out[0]=b0*a00+b1*a10+b2*a20+b3*a30;out[1]=b0*a01+b1*a11+b2*a21+b3*a31;out[2]=b0*a02+b1*a12+b2*a22+b3*a32;out[3]=b0*a03+b1*a13+b2*a23+b3*a33;b0=b[4];b1=b[5];b2=b[6];b3=b[7];out[4]=b0*a00+b1*a10+b2*a20+b3*a30;out[5]=b0*a01+b1*a11+b2*a21+b3*a31;out[6]=b0*a02+b1*a12+b2*a22+b3*a32;out[7]=b0*a03+b1*a13+b2*a23+b3*a33;b0=b[8];b1=b[9];b2=b[10];b3=b[11];out[8]=b0*a00+b1*a10+b2*a20+b3*a30;out[9]=b0*a01+b1*a11+b2*a21+b3*a31;out[10]=b0*a02+b1*a12+b2*a22+b3*a32;out[11]=b0*a03+b1*a13+b2*a23+b3*a33;b0=b[12];b1=b[13];b2=b[14];b3=b[15];out[12]=b0*a00+b1*a10+b2*a20+b3*a30;out[13]=b0*a01+b1*a11+b2*a21+b3*a31;out[14]=b0*a02+b1*a12+b2*a22+b3*a32;out[15]=b0*a03+b1*a13+b2*a23+b3*a33;return out};mat4.mul=mat4.multiply;mat4.translate=function(out,a,v){var x=v[0],y=v[1],z=v[2],a00,a01,a02,a03,a10,a11,a12,a13,a20,a21,a22,a23;if(a===out){out[12]=a[0]*x+a[4]*y+a[8]*z+a[12];out[13]=a[1]*x+a[5]*y+a[9]*z+a[13];out[14]=a[2]*x+a[6]*y+a[10]*z+a[14];out[15]=a[3]*x+a[7]*y+a[11]*z+a[15]}else{a00=a[0];a01=a[1];a02=a[2];a03=a[3];a10=a[4];a11=a[5];a12=a[6];a13=a[7];a20=a[8];a21=a[9];a22=a[10];a23=a[11];out[0]=a00;out[1]=a01;out[2]=a02;out[3]=a03;out[4]=a10;out[5]=a11;out[6]=a12;out[7]=a13;out[8]=a20;out[9]=a21;out[10]=a22;out[11]=a23;out[12]=a00*x+a10*y+a20*z+a[12];out[13]=a01*x+a11*y+a21*z+a[13];out[14]=a02*x+a12*y+a22*z+a[14];out[15]=a03*x+a13*y+a23*z+a[15]}return out};mat4.scale=function(out,a,v){var x=v[0],y=v[1],z=v[2];out[0]=a[0]*x;out[1]=a[1]*x;out[2]=a[2]*x;out[3]=a[3]*x;out[4]=a[4]*y;out[5]=a[5]*y;out[6]=a[6]*y;out[7]=a[7]*y;out[8]=a[8]*z;out[9]=a[9]*z;out[10]=a[10]*z;out[11]=a[11]*z;out[12]=a[12];out[13]=a[13];out[14]=a[14];out[15]=a[15];return out};mat4.rotate=function(out,a,rad,axis){var x=axis[0],y=axis[1],z=axis[2],len=Math.sqrt(x*x+y*y+z*z),s,c,t,a00,a01,a02,a03,a10,a11,a12,a13,a20,a21,a22,a23,b00,b01,b02,b10,b11,b12,b20,b21,b22;if(Math.abs(len)<GLMAT_EPSILON){return null}len=1/len;x*=len;y*=len;z*=len;s=Math.sin(rad);c=Math.cos(rad);t=1-c;a00=a[0];a01=a[1];a02=a[2];a03=a[3];a10=a[4];a11=a[5];a12=a[6];a13=a[7];a20=a[8];a21=a[9];a22=a[10];a23=a[11];b00=x*x*t+c;b01=y*x*t+z*s;b02=z*x*t-y*s;b10=x*y*t-z*s;b11=y*y*t+c;b12=z*y*t+x*s;b20=x*z*t+y*s;b21=y*z*t-x*s;b22=z*z*t+c;out[0]=a00*b00+a10*b01+a20*b02;out[1]=a01*b00+a11*b01+a21*b02;out[2]=a02*b00+a12*b01+a22*b02;out[3]=a03*b00+a13*b01+a23*b02;out[4]=a00*b10+a10*b11+a20*b12;out[5]=a01*b10+a11*b11+a21*b12;out[6]=a02*b10+a12*b11+a22*b12;out[7]=a03*b10+a13*b11+a23*b12;out[8]=a00*b20+a10*b21+a20*b22;out[9]=a01*b20+a11*b21+a21*b22;out[10]=a02*b20+a12*b21+a22*b22;out[11]=a03*b20+a13*b21+a23*b22;if(a!==out){out[12]=a[12];out[13]=a[13];out[14]=a[14];out[15]=a[15]}return out};mat4.rotateX=function(out,a,rad){var s=Math.sin(rad),c=Math.cos(rad),a10=a[4],a11=a[5],a12=a[6],a13=a[7],a20=a[8],a21=a[9],a22=a[10],a23=a[11];if(a!==out){out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];out[12]=a[12];out[13]=a[13];out[14]=a[14];out[15]=a[15]}out[4]=a10*c+a20*s;out[5]=a11*c+a21*s;out[6]=a12*c+a22*s;out[7]=a13*c+a23*s;out[8]=a20*c-a10*s;out[9]=a21*c-a11*s;out[10]=a22*c-a12*s;out[11]=a23*c-a13*s;return out};mat4.rotateY=function(out,a,rad){var s=Math.sin(rad),c=Math.cos(rad),a00=a[0],a01=a[1],a02=a[2],a03=a[3],a20=a[8],a21=a[9],a22=a[10],a23=a[11];if(a!==out){out[4]=a[4];out[5]=a[5];out[6]=a[6];out[7]=a[7];out[12]=a[12];out[13]=a[13];out[14]=a[14];out[15]=a[15]}out[0]=a00*c-a20*s;out[1]=a01*c-a21*s;out[2]=a02*c-a22*s;out[3]=a03*c-a23*s;out[8]=a00*s+a20*c;out[9]=a01*s+a21*c;out[10]=a02*s+a22*c;out[11]=a03*s+a23*c;return out};mat4.rotateZ=function(out,a,rad){var s=Math.sin(rad),c=Math.cos(rad),a00=a[0],a01=a[1],a02=a[2],a03=a[3],a10=a[4],a11=a[5],a12=a[6],a13=a[7];if(a!==out){out[8]=a[8];out[9]=a[9];out[10]=a[10];out[11]=a[11];out[12]=a[12];out[13]=a[13];out[14]=a[14];out[15]=a[15]}out[0]=a00*c+a10*s;out[1]=a01*c+a11*s;out[2]=a02*c+a12*s;out[3]=a03*c+a13*s;out[4]=a10*c-a00*s;out[5]=a11*c-a01*s;out[6]=a12*c-a02*s;out[7]=a13*c-a03*s;return out};mat4.fromRotationTranslation=function(out,q,v){var x=q[0],y=q[1],z=q[2],w=q[3],x2=x+x,y2=y+y,z2=z+z,xx=x*x2,xy=x*y2,xz=x*z2,yy=y*y2,yz=y*z2,zz=z*z2,wx=w*x2,wy=w*y2,wz=w*z2;out[0]=1-(yy+zz);out[1]=xy+wz;out[2]=xz-wy;out[3]=0;out[4]=xy-wz;out[5]=1-(xx+zz);out[6]=yz+wx;out[7]=0;out[8]=xz+wy;out[9]=yz-wx;out[10]=1-(xx+yy);out[11]=0;out[12]=v[0];out[13]=v[1];out[14]=v[2];out[15]=1;return out};mat4.fromQuat=function(out,q){var x=q[0],y=q[1],z=q[2],w=q[3],x2=x+x,y2=y+y,z2=z+z,xx=x*x2,yx=y*x2,yy=y*y2,zx=z*x2,zy=z*y2,zz=z*z2,wx=w*x2,wy=w*y2,wz=w*z2;out[0]=1-yy-zz;out[1]=yx+wz;out[2]=zx-wy;out[3]=0;out[4]=yx-wz;out[5]=1-xx-zz;out[6]=zy+wx;out[7]=0;out[8]=zx+wy;out[9]=zy-wx;out[10]=1-xx-yy;out[11]=0;out[12]=0;out[13]=0;out[14]=0;out[15]=1;return out};mat4.frustum=function(out,left,right,bottom,top,near,far){var rl=1/(right-left),tb=1/(top-bottom),nf=1/(near-far);out[0]=near*2*rl;out[1]=0;out[2]=0;out[3]=0;out[4]=0;out[5]=near*2*tb;out[6]=0;out[7]=0;out[8]=(right+left)*rl;out[9]=(top+bottom)*tb;out[10]=(far+near)*nf;out[11]=-1;out[12]=0;out[13]=0;out[14]=far*near*2*nf;out[15]=0;return out};mat4.perspective=function(out,fovy,aspect,near,far){var f=1/Math.tan(fovy/2),nf=1/(near-far);out[0]=f/aspect;out[1]=0;out[2]=0;out[3]=0;out[4]=0;out[5]=f;out[6]=0;out[7]=0;out[8]=0;out[9]=0;out[10]=(far+near)*nf;out[11]=-1;out[12]=0;out[13]=0;out[14]=2*far*near*nf;out[15]=0;return out};mat4.ortho=function(out,left,right,bottom,top,near,far){var lr=1/(left-right),bt=1/(bottom-top),nf=1/(near-far);out[0]=-2*lr;out[1]=0;out[2]=0;out[3]=0;out[4]=0;out[5]=-2*bt;out[6]=0;out[7]=0;out[8]=0;out[9]=0;out[10]=2*nf;out[11]=0;out[12]=(left+right)*lr;out[13]=(top+bottom)*bt;out[14]=(far+near)*nf;out[15]=1;return out};mat4.lookAt=function(out,eye,center,up){var x0,x1,x2,y0,y1,y2,z0,z1,z2,len,eyex=eye[0],eyey=eye[1],eyez=eye[2],upx=up[0],upy=up[1],upz=up[2],centerx=center[0],centery=center[1],centerz=center[2];if(Math.abs(eyex-centerx)<GLMAT_EPSILON&&Math.abs(eyey-centery)<GLMAT_EPSILON&&Math.abs(eyez-centerz)<GLMAT_EPSILON){return mat4.identity(out)}z0=eyex-centerx;z1=eyey-centery;z2=eyez-centerz;len=1/Math.sqrt(z0*z0+z1*z1+z2*z2);z0*=len;z1*=len;z2*=len;x0=upy*z2-upz*z1;x1=upz*z0-upx*z2;x2=upx*z1-upy*z0;len=Math.sqrt(x0*x0+x1*x1+x2*x2);if(!len){x0=0;x1=0;x2=0}else{len=1/len;x0*=len;x1*=len;x2*=len}y0=z1*x2-z2*x1;y1=z2*x0-z0*x2;y2=z0*x1-z1*x0;len=Math.sqrt(y0*y0+y1*y1+y2*y2);if(!len){y0=0;y1=0;y2=0}else{len=1/len;y0*=len;y1*=len;y2*=len}out[0]=x0;out[1]=y0;out[2]=z0;out[3]=0;out[4]=x1;out[5]=y1;out[6]=z1;out[7]=0;out[8]=x2;out[9]=y2;out[10]=z2;out[11]=0;out[12]=-(x0*eyex+x1*eyey+x2*eyez);out[13]=-(y0*eyex+y1*eyey+y2*eyez);out[14]=-(z0*eyex+z1*eyey+z2*eyez);out[15]=1;return out};mat4.str=function(a){return"mat4("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+", "+a[6]+", "+a[7]+", "+a[8]+", "+a[9]+", "+a[10]+", "+a[11]+", "+a[12]+", "+a[13]+", "+a[14]+", "+a[15]+")"};if(typeof exports!=="undefined"){exports.mat4=mat4}}(shim.exports)}();function ObjVertex(){this.x=0;this.y=0;this.z=0}function ObjNormal(){this.x=0;this.y=0;this.z=0}function ObjTexCoord(){this.u=0;this.v=0}function ObjFace(){this.m_aVertexIndices=[];this.m_aNormalIndices=[];this.m_aTexCoordIndicies=[];this.m_iVertexCount=0}function ObjMesh(){this.m_aVertexArray=null;this.m_aNormalArray=null;this.m_aTexCoordArray=null;this.m_aFaces=null;this.m_iNumberOfVertices=0;this.m_iNumberOfNormals=0;this.m_iNumberOfTexCoords=0;this.m_iNumberOfFaces=0}ObjMesh.LoadOBJ=function(fileData){var lines=fileData.split("\n");var linesLength=lines.length;var pMesh=new ObjMesh;var i,buffer;for(i=0;i<linesLength;++i){buffer=lines[i];if(String.strncmp("vn ",buffer,3)){++pMesh.m_iNumberOfNormals}else if(String.strncmp("vt ",buffer,3)){++pMesh.m_iNumberOfTexCoords}else if(String.strncmp("v ",buffer,2)){++pMesh.m_iNumberOfVertices}else if(String.strncmp("f ",buffer,2)){++pMesh.m_iNumberOfFaces}}CC.ASSERT(pMesh.m_iNumberOfVertices>0);pMesh.m_aVertexArray=new Array(pMesh.m_iNumberOfVertices);for(i=0;i<pMesh.m_aVertexArray.length;++i){pMesh.m_aVertexArray[i]=new ObjVertex}if(pMesh.m_iNumberOfNormals>0){pMesh.m_aNormalArray=new Array(pMesh.m_iNumberOfNormals);for(i=0;i<pMesh.m_aNormalArray.length;++i){pMesh.m_aNormalArray[i]=new ObjNormal}}if(pMesh.m_iNumberOfTexCoords>0){pMesh.m_aTexCoordArray=new Array(pMesh.m_iNumberOfTexCoords);for(i=0;i<pMesh.m_aTexCoordArray.length;++i){pMesh.m_aTexCoordArray[i]=new ObjTexCoord}}pMesh.m_aFaces=new Array(pMesh.m_iNumberOfFaces);for(i=0;i<pMesh.m_aFaces.length;++i){pMesh.m_aFaces[i]=new ObjFace}var vc=0,nc=0,tc=0,fc=0;for(var lineIndex=0;lineIndex<linesLength;++lineIndex){buffer=lines[lineIndex];var values=buffer.split(" ");if(values.length>1){if(values[1]===""){for(i=1;i<values.length-1;++i){values[i]=values[i+1]}values.length--}}if(values[0]==="vn"){CC.ASSERT(nc<pMesh.m_iNumberOfNormals);pMesh.m_aNormalArray[nc].x=parseFloat(values[1]);pMesh.m_aNormalArray[nc].y=parseFloat(values[2]);pMesh.m_aNormalArray[nc].z=parseFloat(values[3]);++nc}else if(values[0]==="vt"){CC.ASSERT(tc<pMesh.m_iNumberOfTexCoords);pMesh.m_aTexCoordArray[tc].u=parseFloat(values[1]);pMesh.m_aTexCoordArray[tc].v=parseFloat(values[2]);++tc}else if(values[0]==="v"){CC.ASSERT(vc<pMesh.m_iNumberOfVertices);var x=parseFloat(values[1]);var y=parseFloat(values[2]);var z=parseFloat(values[3]);pMesh.m_aVertexArray[vc].x=x;pMesh.m_aVertexArray[vc].y=y;pMesh.m_aVertexArray[vc].z=z;++vc}else if(values[0]==="f"){CC.ASSERT(fc<pMesh.m_iNumberOfFaces);var pf=pMesh.m_aFaces[fc];var ii=0;for(i=0;i<buffer.length;++i){if(buffer[i]==="/"){ii++}}if(ii>0){pf.m_aVertexIndices=new Array(ii);
if(pMesh.m_iNumberOfNormals>0){pf.m_aNormalIndices=new Array(ii)}if(pMesh.m_iNumberOfTexCoords>0){pf.m_aTexCoordIndicies=new Array(ii)}}var vertexIndex=0;for(var face=1;face<values.length;++face){var splitValues=values[face].split("/");if(splitValues.length>1){if(tc>0&&nc>0){pf.m_aVertexIndices[vertexIndex]=splitValues[0];pf.m_aTexCoordIndicies[vertexIndex]=splitValues[1].length>0?splitValues[1]:0;pf.m_aNormalIndices[vertexIndex]=splitValues[2];if(pf.m_aTexCoordIndicies[vertexIndex]>0){--pf.m_aTexCoordIndicies[vertexIndex]}if(pf.m_aNormalIndices[vertexIndex]>0){--pf.m_aNormalIndices[vertexIndex]}CC.ASSERT(pf.m_aTexCoordIndicies[vertexIndex]<pMesh.m_iNumberOfTexCoords)}else if(tc>0){pf.m_aVertexIndices[vertexIndex]=splitValues[0];pf.m_aTexCoordIndicies[vertexIndex]=splitValues[1];if(pf.m_aTexCoordIndicies[vertexIndex]>0){--pf.m_aTexCoordIndicies[vertexIndex]}CC.ASSERT(pf.m_aTexCoordIndicies[vertexIndex]<pMesh.m_iNumberOfTexCoords)}else if(nc>0){pf.m_aVertexIndices[vertexIndex]=splitValues[0];pf.m_aNormalIndices[vertexIndex]=splitValues[1];if(pf.m_aNormalIndices[vertexIndex]>0){--pf.m_aNormalIndices[vertexIndex]}}if(pf.m_aVertexIndices[vertexIndex]>0){--pf.m_aVertexIndices[vertexIndex]}vertexIndex++}}CC.ASSERT(ii>=vertexIndex);pf.m_iVertexCount=vertexIndex;++fc}}return pMesh};function utf8_encode(argString){if(argString===null||typeof argString==="undefined"){return""}var string=argString+"";var utftext="",start,end,stringl=0;start=end=0;stringl=string.length;for(var n=0;n<stringl;n++){var c1=string.charCodeAt(n);var enc=null;if(c1<128){end++}else if(c1>127&&c1<2048){enc=String.fromCharCode(c1>>6|192,c1&63|128)}else if(c1&63488!=55296){enc=String.fromCharCode(c1>>12|224,c1>>6&63|128,c1&63|128)}else{if(c1&64512!=55296){throw new RangeError("Unmatched trail surrogate at "+n)}var c2=string.charCodeAt(++n);if(c2&64512!=56320){throw new RangeError("Unmatched lead surrogate at "+(n-1))}c1=((c1&1023)<<10)+(c2&1023)+65536;enc=String.fromCharCode(c1>>18|240,c1>>12&63|128,c1>>6&63|128,c1&63|128)}if(enc!==null){if(end>start){utftext+=string.slice(start,end)}utftext+=enc;start=end=n+1}}if(end>start){utftext+=string.slice(start,stringl)}return utftext}function md5(str){var xl;var rotateLeft=function(lValue,iShiftBits){return lValue<<iShiftBits|lValue>>>32-iShiftBits};var addUnsigned=function(lX,lY){var lX4,lY4,lX8,lY8,lResult;lX8=lX&2147483648;lY8=lY&2147483648;lX4=lX&1073741824;lY4=lY&1073741824;lResult=(lX&1073741823)+(lY&1073741823);if(lX4&lY4){return lResult^2147483648^lX8^lY8}if(lX4|lY4){if(lResult&1073741824){return lResult^3221225472^lX8^lY8}else{return lResult^1073741824^lX8^lY8}}else{return lResult^lX8^lY8}};var _F=function(x,y,z){return x&y|~x&z};var _G=function(x,y,z){return x&z|y&~z};var _H=function(x,y,z){return x^y^z};var _I=function(x,y,z){return y^(x|~z)};var _FF=function(a,b,c,d,x,s,ac){a=addUnsigned(a,addUnsigned(addUnsigned(_F(b,c,d),x),ac));return addUnsigned(rotateLeft(a,s),b)};var _GG=function(a,b,c,d,x,s,ac){a=addUnsigned(a,addUnsigned(addUnsigned(_G(b,c,d),x),ac));return addUnsigned(rotateLeft(a,s),b)};var _HH=function(a,b,c,d,x,s,ac){a=addUnsigned(a,addUnsigned(addUnsigned(_H(b,c,d),x),ac));return addUnsigned(rotateLeft(a,s),b)};var _II=function(a,b,c,d,x,s,ac){a=addUnsigned(a,addUnsigned(addUnsigned(_I(b,c,d),x),ac));return addUnsigned(rotateLeft(a,s),b)};var convertToWordArray=function(str){var lWordCount;var lMessageLength=str.length;var lNumberOfWords_temp1=lMessageLength+8;var lNumberOfWords_temp2=(lNumberOfWords_temp1-lNumberOfWords_temp1%64)/64;var lNumberOfWords=(lNumberOfWords_temp2+1)*16;var lWordArray=new Array(lNumberOfWords-1);var lBytePosition=0;var lByteCount=0;while(lByteCount<lMessageLength){lWordCount=(lByteCount-lByteCount%4)/4;lBytePosition=lByteCount%4*8;lWordArray[lWordCount]=lWordArray[lWordCount]|str.charCodeAt(lByteCount)<<lBytePosition;lByteCount++}lWordCount=(lByteCount-lByteCount%4)/4;lBytePosition=lByteCount%4*8;lWordArray[lWordCount]=lWordArray[lWordCount]|128<<lBytePosition;lWordArray[lNumberOfWords-2]=lMessageLength<<3;lWordArray[lNumberOfWords-1]=lMessageLength>>>29;return lWordArray};var wordToHex=function(lValue){var wordToHexValue="",wordToHexValue_temp="",lByte,lCount;for(lCount=0;lCount<=3;lCount++){lByte=lValue>>>lCount*8&255;wordToHexValue_temp="0"+lByte.toString(16);wordToHexValue=wordToHexValue+wordToHexValue_temp.substr(wordToHexValue_temp.length-2,2)}return wordToHexValue};var x=[],k,AA,BB,CC,DD,a,b,c,d,S11=7,S12=12,S13=17,S14=22,S21=5,S22=9,S23=14,S24=20,S31=4,S32=11,S33=16,S34=23,S41=6,S42=10,S43=15,S44=21;str=this.utf8_encode(str);x=convertToWordArray(str);a=1732584193;b=4023233417;c=2562383102;d=271733878;xl=x.length;for(k=0;k<xl;k+=16){AA=a;BB=b;CC=c;DD=d;a=_FF(a,b,c,d,x[k+0],S11,3614090360);d=_FF(d,a,b,c,x[k+1],S12,3905402710);c=_FF(c,d,a,b,x[k+2],S13,606105819);b=_FF(b,c,d,a,x[k+3],S14,3250441966);a=_FF(a,b,c,d,x[k+4],S11,4118548399);d=_FF(d,a,b,c,x[k+5],S12,1200080426);c=_FF(c,d,a,b,x[k+6],S13,2821735955);b=_FF(b,c,d,a,x[k+7],S14,4249261313);a=_FF(a,b,c,d,x[k+8],S11,1770035416);d=_FF(d,a,b,c,x[k+9],S12,2336552879);c=_FF(c,d,a,b,x[k+10],S13,4294925233);b=_FF(b,c,d,a,x[k+11],S14,2304563134);a=_FF(a,b,c,d,x[k+12],S11,1804603682);d=_FF(d,a,b,c,x[k+13],S12,4254626195);c=_FF(c,d,a,b,x[k+14],S13,2792965006);b=_FF(b,c,d,a,x[k+15],S14,1236535329);a=_GG(a,b,c,d,x[k+1],S21,4129170786);d=_GG(d,a,b,c,x[k+6],S22,3225465664);c=_GG(c,d,a,b,x[k+11],S23,643717713);b=_GG(b,c,d,a,x[k+0],S24,3921069994);a=_GG(a,b,c,d,x[k+5],S21,3593408605);d=_GG(d,a,b,c,x[k+10],S22,38016083);c=_GG(c,d,a,b,x[k+15],S23,3634488961);b=_GG(b,c,d,a,x[k+4],S24,3889429448);a=_GG(a,b,c,d,x[k+9],S21,568446438);d=_GG(d,a,b,c,x[k+14],S22,3275163606);c=_GG(c,d,a,b,x[k+3],S23,4107603335);b=_GG(b,c,d,a,x[k+8],S24,1163531501);a=_GG(a,b,c,d,x[k+13],S21,2850285829);d=_GG(d,a,b,c,x[k+2],S22,4243563512);c=_GG(c,d,a,b,x[k+7],S23,1735328473);b=_GG(b,c,d,a,x[k+12],S24,2368359562);a=_HH(a,b,c,d,x[k+5],S31,4294588738);d=_HH(d,a,b,c,x[k+8],S32,2272392833);c=_HH(c,d,a,b,x[k+11],S33,1839030562);b=_HH(b,c,d,a,x[k+14],S34,4259657740);a=_HH(a,b,c,d,x[k+1],S31,2763975236);d=_HH(d,a,b,c,x[k+4],S32,1272893353);c=_HH(c,d,a,b,x[k+7],S33,4139469664);b=_HH(b,c,d,a,x[k+10],S34,3200236656);a=_HH(a,b,c,d,x[k+13],S31,681279174);d=_HH(d,a,b,c,x[k+0],S32,3936430074);c=_HH(c,d,a,b,x[k+3],S33,3572445317);b=_HH(b,c,d,a,x[k+6],S34,76029189);a=_HH(a,b,c,d,x[k+9],S31,3654602809);d=_HH(d,a,b,c,x[k+12],S32,3873151461);c=_HH(c,d,a,b,x[k+15],S33,530742520);b=_HH(b,c,d,a,x[k+2],S34,3299628645);a=_II(a,b,c,d,x[k+0],S41,4096336452);d=_II(d,a,b,c,x[k+7],S42,1126891415);c=_II(c,d,a,b,x[k+14],S43,2878612391);b=_II(b,c,d,a,x[k+5],S44,4237533241);a=_II(a,b,c,d,x[k+12],S41,1700485571);d=_II(d,a,b,c,x[k+3],S42,2399980690);c=_II(c,d,a,b,x[k+10],S43,4293915773);b=_II(b,c,d,a,x[k+1],S44,2240044497);a=_II(a,b,c,d,x[k+8],S41,1873313359);d=_II(d,a,b,c,x[k+15],S42,4264355552);c=_II(c,d,a,b,x[k+6],S43,2734768916);b=_II(b,c,d,a,x[k+13],S44,1309151649);a=_II(a,b,c,d,x[k+4],S41,4149444226);d=_II(d,a,b,c,x[k+11],S42,3174756917);c=_II(c,d,a,b,x[k+2],S43,718787259);b=_II(b,c,d,a,x[k+9],S44,3951481745);a=addUnsigned(a,AA);b=addUnsigned(b,BB);c=addUnsigned(c,CC);d=addUnsigned(d,DD)}var temp=wordToHex(a)+wordToHex(b)+wordToHex(c)+wordToHex(d);return temp.toLowerCase()}function md5Async(data,callback){if(window.md5AsyncWorking){if(!window.md5AsyncQueue){window.md5AsyncQueue=[]}window.md5AsyncQueue.push({data:data,callback:callback})}else{var windowURL=window.URL||window.webkitURL;if(window.Worker&&windowURL&&windowURL.createObjectURL){if(!window.workerMD5Async){var blob=new Blob(['function utf8_encode(e){if(e===null||typeof e==="undefined"){return""}var t=e+"";var n="",r,i,s=0;r=i=0;s=t.length;for(var o=0;o<s;o++){var u=t.charCodeAt(o);var a=null;if(u<128){i++}else if(u>127&&u<2048){a=String.fromCharCode(u>>6|192,u&63|128)}else if(u&63488!=55296){a=String.fromCharCode(u>>12|224,u>>6&63|128,u&63|128)}else{if(u&64512!=55296){throw new RangeError("Unmatched trail surrogate at "+o)}var f=t.charCodeAt(++o);if(f&64512!=56320){throw new RangeError("Unmatched lead surrogate at "+(o-1))}u=((u&1023)<<10)+(f&1023)+65536;a=String.fromCharCode(u>>18|240,u>>12&63|128,u>>6&63|128,u&63|128)}if(a!==null){if(i>r){n+=t.slice(r,i)}n+=a;r=i=o+1}}if(i>r){n+=t.slice(r,s)}return n}function md5(e){var t;var n=function(e,t){return e<<t|e>>>32-t};var r=function(e,t){var n,r,i,s,o;i=e&2147483648;s=t&2147483648;n=e&1073741824;r=t&1073741824;o=(e&1073741823)+(t&1073741823);if(n&r){return o^2147483648^i^s}if(n|r){if(o&1073741824){return o^3221225472^i^s}else{return o^1073741824^i^s}}else{return o^i^s}};var i=function(e,t,n){return e&t|~e&n};var s=function(e,t,n){return e&n|t&~n};var o=function(e,t,n){return e^t^n};var u=function(e,t,n){return t^(e|~n)};var a=function(e,t,s,o,u,a,f){e=r(e,r(r(i(t,s,o),u),f));return r(n(e,a),t)};var f=function(e,t,i,o,u,a,f){e=r(e,r(r(s(t,i,o),u),f));return r(n(e,a),t)};var l=function(e,t,i,s,u,a,f){e=r(e,r(r(o(t,i,s),u),f));return r(n(e,a),t)};var c=function(e,t,i,s,o,a,f){e=r(e,r(r(u(t,i,s),o),f));return r(n(e,a),t)};var h=function(e){var t;var n=e.length;var r=n+8;var i=(r-r%64)/64;var s=(i+1)*16;var o=new Array(s-1);var u=0;var a=0;while(a<n){t=(a-a%4)/4;u=a%4*8;o[t]=o[t]|e.charCodeAt(a)<<u;a++}t=(a-a%4)/4;u=a%4*8;o[t]=o[t]|128<<u;o[s-2]=n<<3;o[s-1]=n>>>29;return o};var p=function(e){var t="",n="",r,i;for(i=0;i<=3;i++){r=e>>>i*8&255;n="0"+r.toString(16);t=t+n.substr(n.length-2,2)}return t};var d=[],v,m,g,y,b,w,E,S,x,T=7,N=12,C=17,k=22,L=5,A=9,O=14,M=20,_=4,D=11,P=16,H=23,B=6,j=10,F=15,I=21;e=this.utf8_encode(e);d=h(e);w=1732584193;E=4023233417;S=2562383102;x=271733878;t=d.length;for(v=0;v<t;v+=16){m=w;g=E;y=S;b=x;w=a(w,E,S,x,d[v+0],T,3614090360);x=a(x,w,E,S,d[v+1],N,3905402710);S=a(S,x,w,E,d[v+2],C,606105819);E=a(E,S,x,w,d[v+3],k,3250441966);w=a(w,E,S,x,d[v+4],T,4118548399);x=a(x,w,E,S,d[v+5],N,1200080426);S=a(S,x,w,E,d[v+6],C,2821735955);E=a(E,S,x,w,d[v+7],k,4249261313);w=a(w,E,S,x,d[v+8],T,1770035416);x=a(x,w,E,S,d[v+9],N,2336552879);S=a(S,x,w,E,d[v+10],C,4294925233);E=a(E,S,x,w,d[v+11],k,2304563134);w=a(w,E,S,x,d[v+12],T,1804603682);x=a(x,w,E,S,d[v+13],N,4254626195);S=a(S,x,w,E,d[v+14],C,2792965006);E=a(E,S,x,w,d[v+15],k,1236535329);w=f(w,E,S,x,d[v+1],L,4129170786);x=f(x,w,E,S,d[v+6],A,3225465664);S=f(S,x,w,E,d[v+11],O,643717713);E=f(E,S,x,w,d[v+0],M,3921069994);w=f(w,E,S,x,d[v+5],L,3593408605);x=f(x,w,E,S,d[v+10],A,38016083);S=f(S,x,w,E,d[v+15],O,3634488961);E=f(E,S,x,w,d[v+4],M,3889429448);w=f(w,E,S,x,d[v+9],L,568446438);x=f(x,w,E,S,d[v+14],A,3275163606);S=f(S,x,w,E,d[v+3],O,4107603335);E=f(E,S,x,w,d[v+8],M,1163531501);w=f(w,E,S,x,d[v+13],L,2850285829);x=f(x,w,E,S,d[v+2],A,4243563512);S=f(S,x,w,E,d[v+7],O,1735328473);E=f(E,S,x,w,d[v+12],M,2368359562);w=l(w,E,S,x,d[v+5],_,4294588738);x=l(x,w,E,S,d[v+8],D,2272392833);S=l(S,x,w,E,d[v+11],P,1839030562);E=l(E,S,x,w,d[v+14],H,4259657740);w=l(w,E,S,x,d[v+1],_,2763975236);x=l(x,w,E,S,d[v+4],D,1272893353);S=l(S,x,w,E,d[v+7],P,4139469664);E=l(E,S,x,w,d[v+10],H,3200236656);w=l(w,E,S,x,d[v+13],_,681279174);x=l(x,w,E,S,d[v+0],D,3936430074);S=l(S,x,w,E,d[v+3],P,3572445317);E=l(E,S,x,w,d[v+6],H,76029189);w=l(w,E,S,x,d[v+9],_,3654602809);x=l(x,w,E,S,d[v+12],D,3873151461);S=l(S,x,w,E,d[v+15],P,530742520);E=l(E,S,x,w,d[v+2],H,3299628645);w=c(w,E,S,x,d[v+0],B,4096336452);x=c(x,w,E,S,d[v+7],j,1126891415);S=c(S,x,w,E,d[v+14],F,2878612391);E=c(E,S,x,w,d[v+5],I,4237533241);w=c(w,E,S,x,d[v+12],B,1700485571);x=c(x,w,E,S,d[v+3],j,2399980690);S=c(S,x,w,E,d[v+10],F,4293915773);E=c(E,S,x,w,d[v+1],I,2240044497);w=c(w,E,S,x,d[v+8],B,1873313359);x=c(x,w,E,S,d[v+15],j,4264355552);S=c(S,x,w,E,d[v+6],F,2734768916);E=c(E,S,x,w,d[v+13],I,1309151649);w=c(w,E,S,x,d[v+4],B,4149444226);x=c(x,w,E,S,d[v+11],j,3174756917);S=c(S,x,w,E,d[v+2],F,718787259);E=c(E,S,x,w,d[v+9],I,3951481745);w=r(w,m);E=r(E,g);S=r(S,y);x=r(x,b)}var q=p(w)+p(E)+p(S)+p(x);return q.toLowerCase()}self.addEventListener( \'message\', function (e){var data = e.data;if( data ){    var i;    var hashData = data;    if( typeof( hashData ) === "string" )    {        var str = data;        hashData = new Uint16Array( str.length );        for( i=0; i<str.length; ++i )        {            hashData[i] = str.charCodeAt( i );        }    }    if( typeof( hashData ) === "object" )    {        var buffer = new Uint8Array( hashData );        hashData = "";        for( i=0; i<buffer.length; ++i )        {            hashData += buffer[i];        }    }    var result = md5( hashData );    self.postMessage( result );    self.close();}}, false );'],{type:"text/javascript"});var blobURL=windowURL.createObjectURL(blob);window.workerMD5Async=blobURL}window.md5AsyncWorking=true;var worker=new Worker(window.workerMD5Async);worker.addEventListener("message",function(e){delete window.md5AsyncWorking;var result=e.data;callback(result);if(window.md5AsyncQueue){var next=window.md5AsyncQueue.pop();if(window.md5AsyncQueue.length===0){delete window.md5AsyncQueue}md5Async(next.data,next.callback)}},false);worker.postMessage(data)}else{var result=md5(data);callback(result)}}}function DetectBrowser(){var BO={};BO.ie=navigator.appName==="Microsoft Internet Explorer";BO.ie6=BO.ie&&document.implementation&&document.implementation.hasFeature;BO.ie10=BO.ie&&document.all&&window.atob;BO.chrome=navigator.userAgent.toLowerCase().indexOf("chrome")>-1;BO.safari=document.childNodes&&!document.all&&!navigator.taintEnabled&&!navigator.accentColorName&&!BO.chrome;BO.firefox=navigator.userAgent.indexOf("Firefox")>-1;BO.iphone=navigator.userAgent.toLowerCase().indexOf("iphone")>-1;BO.ipad=navigator.userAgent.toLowerCase().indexOf("ipad")>-1;BO.android=navigator.userAgent.toLowerCase().indexOf("android")>-1;BO.mobile=BO.iphone||BO.android||BO.iPad||window.tizen;return BO}var BrowserType=new DetectBrowser;if(!document.getElementsByClassName){document.getElementsByClassName=function(className){var elements=document.getElementsByTagName("*");var matchedElements=[];for(var i=0;i<elements.length;++i){var element=elements[i];if(element.className===className){matchedElements.push(element)}}return matchedElements}}function CC(){}CC.TextArea=document.getElementById("log");CC.DEBUGLOG=function(message,object){{}};function GetStackTrace(){var i;var callstack=[];var lines;var isCallstackPopulated=false;try{i.dont.exist+=0}catch(e){if(e.stack){lines=e.stack.split("\n");for(i=0,len=lines.length;i<len;i++){callstack.push(lines[i])}callstack.shift();isCallstackPopulated=true}else if(window.opera&&e.message){lines=e.message.split("\n");for(i=0,len=lines.length;i<len;i++){if(lines[i].match(/^\s*[A-Za-z0-9\-_\$]+\(/)){var entry=lines[i];if(lines[i+1]){entry+=" at "+lines[i+1];i++}callstack.push(entry)}}callstack.shift();isCallstackPopulated=true}}if(!isCallstackPopulated){var currentFunction=arguments.callee.caller;while(currentFunction){var fn=currentFunction.toString();var fname=fn.substring(fn.indexOf("function")+8,fn.indexOf(""))||"anonymous";callstack.push(fname);currentFunction=currentFunction.caller}}return callstack.join("\n\n")}CC.ASSERT=function(test,message){if(!test){var debug="TEST FAILED\n";debug+=GetStackTrace();alert(debug);if(message){alert(message)}}};CC.LoadScript=function(url,callback){var head=document.getElementsByTagName("head")[0];var script=document.createElement("script");script.type="text/javascript";script.src=url;script.onload=function(){callback(true,script)};script.onerror=function(){callback(false,script)};head.appendChild(script)};CC.SocketIOSocketOnOnly=function(name,fn){var listeners=this.listeners(name);if(listeners.length>0){this.removeAllListeners(name);if(window.console&&console.log){console.log("socket.on re-registering",this.sessionID)}}this.on(name,fn);return this};CC.DeepCopy=function(object){if(typeof object==="object"){var cache=[];var objectJSONString=JSON.stringify(object,function(key,value){if(typeof value==="object"&&value!==null){if(cache.indexOf(value)!==-1){return}cache.push(value)}return value});var newObject=JSON.parse(objectJSONString);return newObject}return null};CC.DeepEquals=function(o1,o2){if(o1===o2&&o2===undefined){return true}if(o1===o2&&o2===null){return true}var k1=Object.keys(o1);var k2=Object.keys(o2);if(k1.length!==k2.length){return false}for(var i=0;i<k1.length;++i){if(k1[i]!==k2[i]){return false}var key=k1[i];var keyType=typeof o1[key];if(typeof o1[key]!==typeof o2[key]){return false}if(keyType==="object"){if(!CC.DeepEquals(o1[key],o2[key])){return false}}else if(o1[key]!==o2[key]){return false}}return true};CC.LoadData=function(key){if(window.localStorage){var data=window.localStorage.getItem(key);if(data){return data}}return undefined};CC.SaveData=function(key,data){if(window.localStorage){CC.ASSERT(key);window.localStorage.setItem(key,data)}};CC.DeleteData=function(key){if(window.localStorage){window.localStorage.removeItem(key)}};function ExtendPrototype(descendant,parent,noPrefixCopy){descendant.super=parent;if(!parent.name){parent.name=parent.toString().match(/^function\s*([^\s(]+)/)[1]}for(var m in parent.prototype){if(!noPrefixCopy){if(m.split("_").length===1){var combined=parent.name+"_"+m;descendant.prototype[combined]=parent.prototype[m]}}descendant.prototype[m]=parent.prototype[m]}}CC.HasFlag=function(source,flag){var result=source&flag;if(result!==0){return true}return false};CC.AddFlag=function(source,flag){if(!CC.HasFlag(source,flag)){source|=flag}return source};CC.RemoveFlag=function(source,flag){if(CC.HasFlag(source,flag)){source^=flag}return source};function CCTools(){this.resize();this.monthNames=new Array(12);this.monthNames[0]="January";this.monthNames[1]="February";this.monthNames[2]="March";this.monthNames[3]="April";this.monthNames[4]="May";this.monthNames[5]="June";this.monthNames[6]="July";this.monthNames[7]="August";this.monthNames[8]="September";this.monthNames[9]="October";this.monthNames[10]="November";this.monthNames[11]="December"}CCTools.prototype.resize=function(){var self=this;CCTools.GetScreenSize(function(width,height){self.screenWidth=width;self.screenHeight=height;self.screenEnd=height+CCTools.GetScreenScroll()})};CCTools.GetScreenWidth=function(){var width=720;if(document.body&&document.body.clientWidth){width=document.body.clientWidth}else if(document.width){width=parseInt(document.width,10)}else if(window.innerWidth){width=window.innerWidth}return width};CCTools.GetScreenHeight=function(){var height=480;if(window&&window.innerHeight){height=window.innerHeight}else if(document.body&&document.body.clientHeight){height=document.body.clientHeight}else if(document.height){height=parseInt(document.height,10)}return height};CCTools.GetScreenSize=function(callback){var width=CCTools.GetScreenWidth();var height=CCTools.GetScreenHeight();if(window.tizen&&window.tizen.systeminfo){function successCallback(display){callback(display.resolutionHeight,display.resolutionWidth,display.resolutionHeight/width)}function errorCallback(error){callback(800,400,1)}window.tizen.systeminfo.getPropertyValue("DISPLAY",successCallback,errorCallback)}else{callback(width,height,1)}};CCTools.GetScreenScroll=function(){return document.body.scrollTop};CCTools.GetX=function(object){var parentObject=object;var returnValue=object.offsetLeft;while(object=object.offsetParent){if(object.tagName!=="HTML"){returnValue+=object.offsetLeft}}parentObject.x=returnValue;return returnValue};CCTools.GetY=function(object){var parentObject=object;var returnValue=object.offsetTop;while(object=object.offsetParent){if(object.tagName!=="HTML"){returnValue+=object.offsetTop}}parentObject.y=returnValue;return returnValue};CC.SetOpacity=function(object,value){object.style.opacity=value};CC.SetGradient=function(style,from,to){if(to===undefined){to=from}if(from===to){style.background=to}else if(BrowserType.firefox){style.background="-moz-linear-gradient( top, "+from+", "+to+" )"}else if(BrowserType.ie10){style.background="-ms-linear-gradient( top, "+from+", "+to+" )"}else if(BrowserType.ie){style.filter="progid:DXImageTransform.Microsoft.Gradient( StartColorStr='"+from+"', EndColorStr='"+to+"', GradientType=0 )"}else{try{style.background="-webkit-gradient( linear, left top, left bottom, from( "+from+" ), to( "+to+" ) )"}catch(e){style.background=to}if(!style.background){style.background=to}}};CCTools.prototype.equalDates=function(date1,date2){if(date1.getDate()===date2.getDate()&&date1.getMonth()===date2.getMonth()&&date1.getFullYear()===date2.getFullYear()){return true}return false};CCTools.prototype.betweenDates=function(date,dateStart,dateEnd){if(this.equalDates(date,dateStart)){return true}if(this.equalDates(date,dateEnd)){return true}if(date>dateStart&&date<dateEnd){return true}return false};CCTools.prototype.daysBetween=function(date1,date2){var ONE_DAY=1e3*60*60*24;var date1_ms=date1.getTime();var date2_ms=date2.getTime();var difference_ms=CC.Distance(date1_ms,date2_ms);return Math.round(difference_ms/ONE_DAY)};CCTools.prototype.dateToString=function(date){return date.getFullYear()+this.monthNames[date.getMonth()]+date.getDate()};CC.LocalTimeFromUTC=function(utcTime){var minutesOffset=-(new Date).getTimezoneOffset();var hoursOffset=minutesOffset/60;minutesOffset=minutesOffset%60;var timeSplit=utcTime.split(":");var hours=parseInt(timeSplit[0],10);var minutes=parseInt(timeSplit[1],10);minutes+=minutesOffset;if(minutes<0){hours--;minutes+=60}else if(minutes>=60){hours++;minutes+=60}hours+=hoursOffset;if(hours<0){hours+=24}else if(hours>=24){hours-=24}if(hours<10){hours="0"+hours}if(minutes<10){minutes="0"+minutes}return""+hours+":"+minutes};CC.GetJSLocationBarData=function(key,defaultValue,url){if(!url){url=window.location.href}var urlSplit=url.split("#");if(urlSplit.length>1){var urlPackets=urlSplit[1].split("&");for(var i=0;i<urlPackets.length;++i){var urlPacket=urlPackets[i].split("=");var urlKey=urlPacket[0];var urlValue=true;if(urlPacket.length>1){urlValue=urlPacket[1]}if(urlKey===key){return urlValue}}}if(defaultValue===undefined){defaultValue=false}return defaultValue};CC.RemoveJSLocationBarData=function(key,setURL){var urlSplit=window.location.href.split("#");var url=urlSplit[0];url+="#";if(urlSplit.length>1){var urlData=urlSplit[1];var tokensArray=urlData.split("&");for(var i=0;i<tokensArray.length;++i){var tokenString=tokensArray[i];var tokenKeyValue=tokenString.split("=");var tokenKey=tokenKeyValue[0];if(tokenKey.length>0&&tokenKey!==key){url+=tokenString;url+="&"}}}if(CCEngine.NativeUpdateCommands===undefined){if(setURL===undefined||setURL){CC.SetWindowURL(url)}}return url};CC.SetJSLocationBarData=function(key,value){var url=CC.RemoveJSLocationBarData(key,false);if(value===undefined){url+=key+"&"}else{url+=key+"="+value+"&"}if(CCEngine.NativeUpdateCommands===undefined){CC.SetWindowURL(url)}};CC.SetPHPLocationBarData=function(key,value){var urlSplit=window.location.href.split("?");var url=urlSplit[0];url+="?"+key+"="+value;if(urlSplit.length>1){var hashSplit=urlSplit[1].split("#");if(hashSplit.length>1){url+="#"+hashSplit[1]}}if(url===window.location.href){window.location.reload()}else{CC.SetWindowURL(url)}};CC.SetWindowURL=function(url,resetStack){if(!CC.WindowURLUpdatesDisabled){if(CC.WindowURL!==url){if(!CC.PendingURLStack){CC.PendingURLStack=[]}if(resetStack){CC.PendingURLStack.length=0}CC.WindowURL=url;if(window.location.href!==url){CC.PendingURLStack.push(url);window.location.href=url}}}};CC.GetURLWithoutLocationBarData=function(){var urlSplit=window.location.href.split("?");if(urlSplit.length>1){return urlSplit[0]}urlSplit=window.location.href.split("#");return urlSplit[0]};CC.WindowPrompt=function(title,message){if(CCEngine.DeviceType==="Web"){return window.prompt(title,message)}return false};CCTools.prototype.isAlphabetic=function(string){return"/^[a-zA-Z]+$/".test(string)};CC.IsAlphaNumeric=function(string){return/^[a-zA-Z0-9]*$/.test(string)};String.StripEquals=function(src){if(src.contains("=")){var split=src.split("=");if(split.length>1){return split[split.length-1]}}return src};String.ReplaceChar=function(source,search,replace){var split=source.split(search);var result="";for(var i=0;i<split.length;++i){if(i>0){result+=replace}result+=split[i]}return result};String.SplitBetween=function(source,from,to){var splitFrom=source.split(from);if(splitFrom.length>1){var splitTo=splitFrom[1].split(to);return splitTo[0]}return false};String.SplitBefore=function(source,before){var split=source.split(before);return split[0]};String.SplitAfter=function(source,after){var split=source.split(after);if(split.length>1){var result=split[1];for(var i=2;i<split.length;++i){result+=after;result+=split[i]}return result}return""};String.LastWord=function(source){var split=source.split(" ");return split[split.length-1]};String.RemoveBetween=function(source,before,after){var i;var result="";var splitBefore=source.split(before);for(i=0;i<splitBefore.length-1;++i){result+=before;result+=splitBefore[i]}var splitAfter=source.split(after);for(i=1;i<splitAfter.length;++i){result+=after;result+=splitAfter[i]}return result};String.RemoveBetweenIncluding=function(source,before,after){var result="";var splitBefore=source.split(before);var i;for(i=0;i<splitBefore.length-1;++i){if(i!==0){result+=before}result+=splitBefore[i]}var splitAfter=source.split(after);for(i=1;i<splitAfter.length;++i){if(i!==1){result+=after}result+=splitAfter[i]}return result};String.prototype.getDomain=function(){var start=String.SplitBefore(this,":");var domain=String.SplitBetween(this,"//","/");return start+"://"+domain};String.prototype.getHostname=function(){return String.SplitBetween(this,"//","/")};String.prototype.getFilename=function(){var filename=this.stripDirectory();if(filename.contains("=")){filename=String.SplitAfter(filename,"=")}return filename};String.prototype.contains=function(token){if(this.indexOf(token)!==-1){return true}return false};String.prototype.containsDirectory=function(){if(this.contains("/")){return true}return false};String.prototype.isHTTP=function(){var httpString="http://";if(this.substring(0,httpString.length)===httpString){return true}return false};String.prototype.isHTTPS=function(){var httpString="https://";if(this.substring(0,httpString.length)===httpString){return true}return false};String.prototype.strip=function(token){return this.replace(token,"")};String.prototype.stripExtension=function(){var results=this.split(".");var newString="";for(var i=0;i<results.length-1;++i){if(i>0){newString+="."}newString+=results[i]}return newString};String.prototype.stripFilename=function(){return this.substring(0,this.lastIndexOf("/"))};String.prototype.stripDirectory=function(){return this.replace(/^.*[\\\/]/,"")};String.prototype.stripStart=function(token){var index=this.indexOf(token);if(index!==-1){return string.substring(index)}return this};String.prototype.formatSpacesAndTabs=function(){var string=String.ReplaceChar(this,"	"," ");while(string.length>0&&string[0]===" "){string=string.substring(1)}while(string.length>0&&string[string.length-1]===" "){string=string.substring(0,string.length-1)}return string};String.prototype.getExtension=function(){var results=this.split(".");if(results.length>1){return results[results.length-1].toLowerCase()}return""};String.prototype.resolveURL=function(){var url=this;if(!url.startsWith("http")){url=window.location.href.stripFilename()+"/"+this}var urlSplit=url.split("/..");if(urlSplit.length>1){url=urlSplit[0].stripFilename()+urlSplit[1]}return url};String.prototype.startsWith=function(needle){return this.indexOf(needle)===0};String.strncmp=function(a,b,n){return a.substring(0,n)===b.substring(0,n)};Array.prototype.safePop=function(){var result=this[0];for(var i=0;i<this.length-1;++i){this[i]=this[i+1]}this.length--;return result};Array.prototype.add=function(object){this.push(object)};Array.prototype.addOnce=function(object){if(this.find(object)===-1){this.push(object);return true}return false};Array.prototype.insert=function(object,index){var currentIndex=this.find(object);if(currentIndex!==-1){if(currentIndex===index){return false}this.remove(object)}this.add(object);var length=this.length;for(var i=length-1;i>index;--i){this[i]=this[i-1]}this[index]=object;return true};Array.prototype.remove=function(object){var length=this.length;for(var i=0;i<length;++i){if(this[i]===object){length--;for(var j=i;j<length;++j){this[j]=this[j+1]}this.length--;return true}}return false};Array.prototype.removeIndex=function(index){var length=this.length;if(index<length){for(var i=index;i<length;++i){this[i]=this[i+1]}this.length--;return true}return false};Array.prototype.find=function(object){var length=this.length;for(var i=0;i<length;++i){if(this[i]===object){return i}}return-1};Array.prototype.last=function(object){if(this.length>0){return this[this.length-1]}return null};Array.prototype.emit=function(){for(var i=0;i<this.length;++i){this[i]()}};Array.prototype.first=function(){if(this.length>0){return this[0]}return null};function DOMDimensions(object){this.object=object;this.x=0;this.y=0;this.width=1;this.height=1;this.totalWidth=1;this.totalHeight=1;this.borderSize=0}DOMDimensions.prototype.setPosition=function(x,y){var object=this.object;if(x!==this.x){object.style.left=x+"px";this.x=x}if(y!==this.y){object.style.top=y+"px";this.y=y}};DOMDimensions.prototype.refreshBorder=function(){this.borderSize=this.object.style.border?parseInt(this.object.style.border,10):0};DOMDimensions.prototype.refreshPosition=function(){var dimensions=this;dimensions.x=CCTools.GetX(this.object);dimensions.y=CCTools.GetY(this.object)};DOMDimensions.prototype.refreshSize=function(){var dimensions=this;var width=this.object.clientWidth;var height=this.object.clientHeight;if(width<1){width=1}if(height<1){height=1}dimensions.width=width;dimensions.height=height;dimensions.totalWidth=width+dimensions.borderSize*2;dimensions.totalHeight=height+dimensions.borderSize*2};DOMDimensions.prototype.refresh=function(){this.refreshBorder();this.refreshPosition();this.refreshSize()};function TableComponent(parent,selectable){this.callbacks=[];var table=this.table=document.createElement("table");table.cellPadding=0;table.cellSpacing=0;var style=this.style=table.style;style.marginLeft=0;style.marginRight=0;style.marginTop=0;style.marginBottom=0;if(!selectable){style.cursor="pointer";table.unselectable=true;style.MozUserSelect="none"}this.dimensions=new DOMDimensions(this.table);style.position="absolute";style.left="0px";style.top="0px";var tBody=this.tBody=document.createElement("tbody");table.appendChild(tBody);this.tr=[];this.addRow();this.addColumn();this.td=this.tr[0].td[0];if(parent){parent.appendChild(this.table)}}TableComponent.prototype.addRow=function(){var index=this.tr?this.tr.length:0;var tr=this.tr[index]=document.createElement("tr");tr.td=[];this.tBody.appendChild(tr);return tr};TableComponent.prototype.addColumnToRow=function(row){if(row>=this.tr.length){alert("TableComponent.prototype.addColumn() - invalid row");return}var index=this.tr[row].td?this.tr[row].td.length:0;var td=this.tr[row].td[index]=document.createElement("td");this.tr[row].appendChild(td);return td};TableComponent.prototype.addColumn=function(){return this.addColumnToRow(this.tr.length-1)};function CCVarPointer(inValue){this.value=inValue}function CCInterpolator(){this.construct()}CCInterpolator.prototype.construct=function(){this.speed=1;this.onInterpolated=[];this.updating=false};CCInterpolator.prototype.setDuration=function(duration){this.speed=1/duration};CCInterpolator.prototype.finish=function(){this.update(CC_MAXFLOAT)};function CCInterpolatorSin2Curve(){this.construct()}ExtendPrototype(CCInterpolatorSin2Curve,CCInterpolator);CCInterpolatorSin2Curve.prototype.construct=function(){this.CCInterpolator_construct();this.interpolationCurveMultiple=1/Math.sin(2);this.current=false;this.target=undefined;this.start=undefined;this.length=undefined;this.amount=1};CCInterpolatorSin2Curve.prototype.setup=function(inCurrent,inTarget){if(this.current!==inCurrent||this.target!==inTarget){this.current=inCurrent;this.target=inTarget;this.ready()}else if(this.current.value===this.target){this.amount=1}this.updating=true
};CCInterpolatorSin2Curve.prototype.ready=function(){this.start=this.current.value;this.length=this.target-this.start;if(this.current.value===this.target){this.amount=1}else{this.amount=0}this.updating=true};CCInterpolatorSin2Curve.prototype.incrementAmount=function(delta){if(this.amount!==1){this.amount=CC.ToTarget(this.amount,1,delta*this.speed);return true}return false};CCInterpolatorSin2Curve.prototype.calculatePercentage=function(){var percentage=Math.sin(this.amount*2)*this.interpolationCurveMultiple;return percentage};CCInterpolatorSin2Curve.prototype.updateInterpolation=function(percentage){var movement=this.length*percentage;this.current.value=movement+this.start};CCInterpolatorSin2Curve.prototype.update=function(delta){this.updating=false;var current=this.current;if(current){if(this.incrementAmount(delta)){var percentage=this.calculatePercentage();this.updateInterpolation(percentage);this.updating=true}else if(current.value!==this.target){current.value=this.target;this.current=false;this.updating=true}else{this.current=false}}else{var onInterpolated=this.onInterpolated;var length=onInterpolated.length;if(length>0){var i;var pendingCallbacks=[];for(i=0;i<length;++i){pendingCallbacks.add(onInterpolated[i])}onInterpolated.length=0;for(i=0;i<length;++i){pendingCallbacks[i].run()}}}return this.updating};CCInterpolatorSin2Curve.prototype.equals=function(inCurrent,inTarget){if(this.current===inCurrent&&this.target===inTarget){return true}return false};function CCInterpolatorX2Curve(){this.construct()}ExtendPrototype(CCInterpolatorX2Curve,CCInterpolatorSin2Curve,true);CCInterpolatorX2Curve.prototype.calculatePercentage=function(){var percentage=this.amount*this.amount;return percentage};function CCInterpolatorX3Curve(){this.construct()}ExtendPrototype(CCInterpolatorX3Curve,CCInterpolatorSin2Curve,true);CCInterpolatorX3Curve.prototype.calculatePercentage=function(){var sudoAmount=this.amount-1;var percentage=1+sudoAmount*sudoAmount*sudoAmount;return percentage};function CCInterpolatorV3(type){this.type=type;this.construct()}ExtendPrototype(CCInterpolatorV3,CCInterpolator);CCInterpolatorV3.prototype.construct=function(){this.CCInterpolator_construct();this.xPointer=new CCVarPointer;this.yPointer=new CCVarPointer;this.zPointer=new CCVarPointer;this.x=new this.type;this.y=new this.type;this.z=new this.type;this.onInterpolated=[]};CCInterpolatorV3.prototype.setup=function(inCurrent,inTarget,inCallback){if(typeof inTarget==="number"){inTarget=vec3.clone([inTarget,inTarget,inTarget])}this.current=inCurrent;this.xPointer.value=inCurrent[0];this.yPointer.value=inCurrent[1];this.zPointer.value=inCurrent[2];inTarget=inTarget?inTarget:inCurrent;this.setTarget(inTarget,inCallback);return this};CCInterpolatorV3.prototype.setTarget=function(inTarget,inCallback){this.x.setup(this.xPointer,inTarget[0]);this.y.setup(this.yPointer,inTarget[1]);this.z.setup(this.zPointer,inTarget[2]);this.onInterpolated.length=0;if(inCallback){this.onInterpolated.push(inCallback)}this.updating=true};CCInterpolatorV3.prototype.ready=function(){this.xPointer.value=this.current[0];this.yPointer.value=this.current[1];this.zPointer.value=this.current[2];this.x.ready();this.y.ready();this.z.ready();this.updating=true};CCInterpolatorV3.prototype.update=function(delta){var deltaSpeed=delta*this.speed;this.updating=this.x.update(deltaSpeed);this.updating|=this.y.update(deltaSpeed);this.updating|=this.z.update(deltaSpeed);if(this.updating){this.current[0]=this.xPointer.value;this.current[1]=this.yPointer.value;this.current[2]=this.zPointer.value}else{var onInterpolated=this.onInterpolated;var length=onInterpolated.length;if(length>0){var i;var pendingCallbacks=[];for(i=0;i<length;++i){pendingCallbacks.push(onInterpolated[i])}onInterpolated.length=0;for(i=0;i<length;++i){pendingCallbacks[i]()}}}return this.updating};CCInterpolatorV3.prototype.equals=function(inCurrent,inTarget){if(this.x.equals(inCurrent[0],inTarget[0])&&this.y.equals(inCurrent[1],inTarget[1])&&this.z.equals(inCurrent[2],inTarget[2])){return true}return false};CCInterpolatorV3.prototype.getAmount=function(delta){return vec3.clone([this.x.amount,this.y.amount,this.z.amount])};CCInterpolatorV3.prototype.getTarget=function(delta){return vec3.clone([this.x.target,this.y.target,this.z.target])};function CCInterpolatorListV3(type){this.type=type?type:CCInterpolatorSin2Curve;this.construct();this.interpolators=[]}ExtendPrototype(CCInterpolatorListV3,CCInterpolator);CCInterpolatorListV3.prototype.clear=function(){this.interpolators.length=0};CCInterpolatorListV3.prototype.pushV3=function(inCurrent,inTarget,replace,inCallback){this.updating=true;var i,interpolator;var interpolators=this.interpolators;if(interpolators.length>0){if(replace){var found=false;for(i=0;i<interpolators.length;++i){interpolator=interpolators[i];if(interpolator.equals(inCurrent,inTarget)){found=true;interpolator.onInterpolated.push(inCallback);if(i!==0){interpolator.ready()}}else{interpolators.splice(i,1)}}if(found){return false}}else{for(i=0;i<interpolators.length;++i){interpolator=interpolators[i];if(interpolator.equals(inCurrent,inTarget)){return false}}}}if(inCurrent!==inTarget){interpolator=new CCInterpolatorV3(this.type).setup(inCurrent,inTarget,inCallback);interpolators.push(interpolator)}return true};CCInterpolatorListV3.prototype.update=function(delta){this.updating=false;var interpolators=this.interpolators;if(interpolators.length>0){var interpolator=interpolators[0];if(!interpolator.update(delta*this.speed)){interpolators.splice(0,1);if(interpolators.length>0){interpolators[0].ready()}else{return false}}this.updating=true}return this.updating};CCInterpolatorListV3.prototype.finished=function(){return this.interpolators.length===0};CCInterpolatorListV3.prototype.getTarget=function(){if(this.interpolators.length>0){return this.interpolators.last().getTarget()}return vec3.create()};function CCInterpolatorColour(type){this.type=type?type:CCInterpolatorX2Curve;this.construct()}ExtendPrototype(CCInterpolatorColour,CCInterpolator);CCInterpolatorColour.prototype.construct=function(){this.CCInterpolator_construct();this.rPointer=new CCVarPointer;this.gPointer=new CCVarPointer;this.bPointer=new CCVarPointer;this.aPointer=new CCVarPointer;this.r=new this.type;this.g=new this.type;this.b=new this.type;this.a=new this.type;this.onInterpolated=[]};CCInterpolatorColour.prototype.equals=function(inCurrent,inTarget){if(this.x.equals(inCurrent.r,inTarget.r)&&this.y.equals(inCurrent.g,inTarget.g)&&this.z.equals(inCurrent.b,inTarget.b)&&this.a.equals(inCurrent.a,inTarget.a)){return true}return false};CCInterpolatorColour.prototype.setup=function(inCurrent,inTarget,inCallback){this.current=inCurrent;this.rPointer.value=inCurrent.r;this.gPointer.value=inCurrent.g;this.bPointer.value=inCurrent.b;this.aPointer.value=inCurrent.a;inTarget=inTarget?inTarget:inCurrent;this.setTarget(inTarget,inCallback);return this};CCInterpolatorColour.prototype.setTarget=function(inTarget,inCallback){this.r.setup(this.rPointer,inTarget.r);this.g.setup(this.gPointer,inTarget.g);this.b.setup(this.bPointer,inTarget.b);this.a.setup(this.aPointer,inTarget.a);this.onInterpolated.length=0;if(inCallback){this.onInterpolated.push(inCallback)}this.updating=true};CCInterpolatorColour.prototype.setTargetAlpha=function(inTargetAlpha,inCallback){this.a.setup(this.aPointer,inTargetAlpha);this.onInterpolated.length=0;if(inCallback){this.onInterpolated.push(inCallback)}this.updating=true};CCInterpolatorColour.prototype.ready=function(){this.rPointer.value=this.current.r;this.gPointer.value=this.current.g;this.bPointer.value=this.current.b;this.aPointer.value=this.current.a;this.r.ready();this.g.ready();this.b.ready();this.a.ready();this.updating=true};CCInterpolatorColour.prototype.update=function(delta){var deltaSpeed=delta*this.speed;this.updating=this.r.update(deltaSpeed);this.updating|=this.g.update(deltaSpeed);this.updating|=this.b.update(deltaSpeed);this.updating|=this.a.update(deltaSpeed);if(this.updating){this.current.r=this.rPointer.value;this.current.g=this.gPointer.value;this.current.b=this.bPointer.value;this.current.a=this.aPointer.value}else{var onInterpolated=this.onInterpolated;var length=onInterpolated.length;if(length>0){var i;var pendingCallbacks=[];for(i=0;i<length;++i){pendingCallbacks.push(onInterpolated[i])}onInterpolated.length=0;for(i=0;i<length;++i){pendingCallbacks[i]()}}}return this.updating};CCInterpolatorColour.prototype.getTarget=function(){var target=new CCColour;target.r=this.r.target;target.g=this.g.target;target.b=this.b.target;target.a=this.a.target;return target};function CCTimer(){this.time=0;this.updating=false;this.interval=0;this.onTime=[]}CCTimer.prototype.update=function(delta){if(this.updating){var real=gEngine.timeReal;this.time-=real;if(this.time<=0){this.updating=false}return true}return false};CCTimer.prototype.finish=function(){this.onTime.emit()};CCTimer.prototype.start=function(timeout){this.interval=timeout;this.restart()};CCTimer.prototype.stop=function(){this.updating=false};CCTimer.prototype.restart=function(){this.time=this.interval;this.updating=true};function CCMovementInterpolator(inObject,updateCollisions){this.object=inObject;this.object.addUpdater(this);this.updating=false;this.movementInterpolator=new CCInterpolatorListV3(CCInterpolatorX3Curve);this.updateCollisions=updateCollisions}CCMovementInterpolator.prototype.update=function(delta){if(this.updating){if(this.movementInterpolator.updating){if(this.movementInterpolator.update(delta)){var object=this.object;if(this.updateCollisions){object.updateCollisions=true;CCOctree.RefreshObject(object)}object.dirtyModelMatrix();return true}else{this.updating=false}}else{this.updating=false}}return false};CCMovementInterpolator.prototype.clear=function(){if(this.updating){this.updating=false;this.movementInterpolator.clear()}};CCMovementInterpolator.prototype.finish=function(){if(this.updating){this.update(CC_MAXFLOAT)}};CCMovementInterpolator.prototype.setMovement=function(target,inCallback){this.updating=true;this.movementInterpolator.pushV3(this.object.position,target,true,inCallback)};CCMovementInterpolator.prototype.setMovementX=function(x){var object=this.object;this.setMovement(vec3.clone([x,object.position[1],object.position[2]]))};CCMovementInterpolator.prototype.translateMovementX=function(x){this.setMovementX(this.object.position[0]+x)};CCMovementInterpolator.prototype.translateMovementY=function(y){this.setMovementY(this.object.position[1]+y)};CCMovementInterpolator.prototype.setMovementY=function(y,inCallback){var object=this.object;this.setMovement(vec3.clone([object.position[0],y,object.position[2]]),inCallback)};CCMovementInterpolator.prototype.setMovementXY=function(x,y,inCallback){var object=this.object;this.setMovement(vec3.clone([x,y,object.position[2]]),inCallback)};CCMovementInterpolator.prototype.setMovementYZ=function(y,z,inCallback){var object=this.object;this.setMovement(vec3.clone([object.position[0],y,z]),inCallback)};CCMovementInterpolator.prototype.getMovementTarget=function(){if(this.updating&&this.movementInterpolator.interpolators.length>0){return this.movementInterpolator.getTarget()}if(!this.positionCache){this.positionCache=vec3.create()}vec3.copy(this.positionCache,this.object.position);return this.positionCache};CCMovementInterpolator.prototype.setDuration=function(duration){this.movementInterpolator.setDuration(duration)};function Path(){this.endDirection=0;this.distance=0;this.directions=[]}function PathConnection(){this.distance=undefined;this.angle=undefined;this.node=undefined}function PathNode(){this.point=vec3.create();this.connections=[]}function CCPathFinderNetwork(){this.nodes=[];this.testNodes=[];this.path=undefined;this.pathingFrom=undefined}CCPathFinderNetwork.prototype.view=function(){var nodes=this.nodes;if(nodes.length>0){var renderer=gRenderer;gEngine.textureManager.setTextureIndex(1);var nodeColour=gColour.setRGBA(1,0,0,.125);renderer.CCSetColour(nodeColour);var i,node;var start=vec3.create();var end=vec3.create();{for(i=0;i<nodes.length;++i){node=nodes[i];CCRenderer.GLPushMatrix();CCRenderer.GLTranslate(node.point);renderer.CCRenderCube(true);CCRenderer.GLPopMatrix()}for(i=0;i<nodes.length;++i){node=nodes[i];var connections=node.connections;for(var j=0;j<connections.length;++j){var connection=connections[j].node.point;vec3.copy(start,[node.point[0],2,node.point[2]]);vec3.copy(end,[connection[0],2,connection[2]]);renderer.CCRenderLine(start,end)}}}if(this.path){var pathColour=gColour.setRGBA(0,1,.25,1);{renderer.CCSetColour(pathColour);var currentNode=this.pathingFrom;var path=this.path;for(i=0;i<path.endDirection;++i){var connectionIndex=path.directions[i];if(connectionIndex<currentNode.connections.length){var toNode=currentNode.connections[connectionIndex].node;start.set([currentNode.point[0],3,currentNode.point[2]]);end.set([toNode.point[0],3,toNode.point[2]]);renderer.CCRenderLine(start,end);currentNode=toNode}}}}}};CCPathFinderNetwork.prototype.addNode=function(point,parent){var node=new PathNode;node.point=point;if(parent){node.parent=parent}this.nodes.add(node);this.testNodes.add(node);return node};CCPathFinderNetwork.prototype.addCollideable=function(collideable,extents){var maxIncrement=150;var minIncrement=50;var startX=collideable.aabbMin[0]-minIncrement;var endX=collideable.aabbMax[0]+minIncrement;var width=endX-startX;var numberOfIncrements=Math.round(width/maxIncrement+.5);var spacingX=width/numberOfIncrements;var startZ=collideable.aabbMin[2]-minIncrement;var endZ=collideable.aabbMax[2]+minIncrement;var depth=endZ-startZ;numberOfIncrements=Math.round(depth/maxIncrement+.5);var spacingZ=depth/numberOfIncrements;var x,z;for(x=startX;x<endX+1;x+=spacingX){if(x>-extents[0]&&x<extents[0]){for(z=startZ;z<endZ+1;z+=depth){if(z>-extents[2]&&z<extents[2]){this.addNode(vec3.clone([x,0,z]),collideable)}}}}for(z=startZ+spacingZ;z<endZ+1-spacingZ;z+=depth-spacingZ){if(z>-extents[2]&&z<extents[2]){for(x=startX;x<endX+1;x+=spacingX){if(x>-extents[0]&&x<extents[0]){this.addNode(vec3.clone([x,0,z]),collideable)}}}}};CCPathFinderNetwork.prototype.removeCollideable=function(collideable){var nodes=this.nodes;var testNodes=this.testNodes;for(var i=0;i<nodes.length;++i){var node=nodes[i];if(node.parent===collideable){nodes.remove(node);testNodes.remove(node);--i}}};CCPathFinderNetwork.prototype.addFillerNodes=function(collideable){CC.UpdateCollisions(collideable);var maxIncrement=100;var minIncrement=maxIncrement;var startX=collideable.aabbMin[0]+minIncrement;var endX=collideable.aabbMax[0]-minIncrement;var width=endX-startX;var numberOfIncrements=Math.round(width/maxIncrement+.5);if(numberOfIncrements<1){numberOfIncrements=1}var spacingX=width/numberOfIncrements;var startZ=collideable.aabbMin[2]+minIncrement;var endZ=collideable.aabbMax[2]-minIncrement;var depth=endZ-startZ;numberOfIncrements=Math.round(depth/maxIncrement+.5);if(numberOfIncrements<1){numberOfIncrements=1}var spacingZ=depth/numberOfIncrements;for(var x=startX;x<endX+1;x+=spacingX){for(var z=startZ;z<endZ+1;z+=spacingZ){this.addNode(vec3.clone([x,0,z]))}}};CCPathFinderNetwork.prototype.linkDistantNodes=function(){var nodes=this.nodes;if(nodes.length>0){var BIG_FLOAT=1e4;var topLeft=this.findClosestNode([-BIG_FLOAT,0,-BIG_FLOAT]);var topRight=this.findClosestNode([BIG_FLOAT,0,-BIG_FLOAT]);var bottomLeft=this.findClosestNode([-BIG_FLOAT,0,BIG_FLOAT]);var bottomRight=this.findClosestNode([BIG_FLOAT,0,BIG_FLOAT]);if(topLeft&&topRight&&bottomLeft&&bottomRight){var startX=topLeft.point[0]<bottomLeft.point[0]?topLeft.point[0]:bottomLeft.point[0];var endX=topRight.point[0]>bottomRight.point[0]?topRight.point[0]:bottomRight.point[0];var startZ=topLeft.point[2]<topRight.point[2]?topLeft.point[2]:topRight.point[2];var endZ=bottomLeft.point[2]>bottomRight.point[2]?bottomLeft.point[2]:bottomRight.point[2];var x=startX;var z=startZ;var increment=150;while(x<endX&&z<endZ){x+=increment;if(x>=endX){x=startX+increment;z+=increment}if(z<endZ){this.addNode(vec3.clone([x,0,z]))}}}}};CCPathFinderNetwork.prototype.removeFillerNodes=function(){var nodes=this.nodes;var testNodes=this.testNodes;for(var i=0;i<nodes.length;++i){var node=nodes[i];if(!node.parent){nodes.remove(node);testNodes.remove(node);--i}}};CCPathFinderNetwork.prototype.clear=function(){this.nodes.length=0;this.pathingFrom=null};CCPathFinderNetwork.prototype.connect=function(){this.removeFillerNodes();this.linkDistantNodes();var nodes=this.nodes;var i,connections,currentNode,connection;for(i=0;i<nodes.length;++i){currentNode=nodes[i];connections=currentNode.connections;connections.length=0}var maxNodeDistance=CC.SQUARE(200);for(i=0;i<nodes.length;++i){currentNode=nodes[i];connections=currentNode.connections;for(var j=0;j<nodes.length;++j){var targetNode=nodes[j];if(currentNode!==targetNode){var distance=CC.Vector3Distance2D(currentNode.point,targetNode.point);if(distance<maxNodeDistance){var angle=CC.AngleTowardsVector(currentNode.point,targetNode.point);{var angleFoundIndex=-1;for(var k=0;k<connections.length;++k){if(angle===connections[k].angle){angleFoundIndex=k;break}}if(angleFoundIndex!==-1){if(distance>=connections[angleFoundIndex].distance){continue}else{connections.remove(connections[angleFoundIndex])}}var newConnection=new PathConnection;newConnection.distance=distance;newConnection.angle=angle;newConnection.node=targetNode;connections.add(newConnection)}}}}}};CCPathFinderNetwork.prototype.findClosestNodes=function(position,radius,vectors,length){var nodes=this.nodes;for(var i=0;i<nodes.length&&vectors.length<length;++i){var node=nodes[i];if(node.connections.length>0){var distance=CC.Vector3Distance2D(position,node.point);if(distance<radius){vectors.add(node.point)}}}return vectors.length};CCPathFinderNetwork.prototype.findClosestNodeToPathTarget=function(objectToPath,position,withConnections){var i;var nodes=this.testNodes;var nodesLength=nodes.length;for(i=0;i<nodesLength;++i){nodes[i].distance=undefined}nodes.sort(function(a,b){var distanceA=a.distance=a.distance!==undefined?a.distance:CC.Vector3Distance2D(a.point,position);var distanceB=b.distance=b.distance!==undefined?b.distance:CC.Vector3Distance2D(b.point,position);return distanceA-distanceB});var closestNode=null;var closestDistance=CC_MAXFLOAT;var MovementCollisionCheckFunction=CC.MovementCollisionCheck;for(i=0;i<nodesLength;++i){var node=nodes[i];if(!withConnections||node.connections.length>0){var distance=node.distance;if(distance<closestDistance){var hitObject=MovementCollisionCheckFunction(objectToPath,position,node.point,CC.collision_static);if(hitObject){continue}if(!hitObject){closestDistance=distance;closestNode=node}}}}if(closestNode){return closestNode}return null};CCPathFinderNetwork.prototype.findClosestNode=function(position){var nodes=this.nodes;var closestNode=null;var closestDistance=CC_MAXFLOAT;for(var i=0;i<nodes.length;++i){var node=nodes[i];var distance=CC.Vector3Distance2D(node.point,position);if(distance<closestDistance){closestDistance=distance;closestNode=node}}return closestNode};CCPathFinderNetwork.compareNode=undefined;CCPathFinderNetwork.targetNode=undefined;function followPathCompare(a,b){var pathA=CCPathFinderNetwork.compareNode.connections[a];var pathB=CCPathFinderNetwork.compareNode.connections[b];var pathADistance=CC.Vector3Distance2D(pathA.node.point,CCPathFinderNetwork.targetNode.point);var pathBDistance=CC.Vector3Distance2D(pathB.node.point,CCPathFinderNetwork.targetNode.point);return pathADistance-pathBDistance}CCPathFinderNetwork.prototype.findPath=function(objectToPath,fromNode,toNode){if(fromNode&&toNode){var previousNodes=[];previousNodes.add(fromNode);CCPathFinderNetwork.targetNode=toNode;this.path=new Path;this.followPath(objectToPath,this.path,0,0,previousNodes,fromNode,toNode);this.pathingFrom=fromNode;return this.path}return null};CCPathFinderNetwork.prototype.followPath=function(objectToPath,path,currentDirection,currentDistance,previousNodes,fromNode,toNode){var i;if(fromNode===toNode){path.endDirection=currentDirection;path.distance=currentDistance;return true}var nextDirection=currentDirection+1;if(nextDirection>=10){return false}CCPathFinderNetwork.compareNode=fromNode;var connections=fromNode.connections;var connectionsLength=connections.length;var values=new Array(connectionsLength);for(i=0;i<connectionsLength;++i){values[i]=i}values.sort(followPathCompare);var MovementCollisionCheckFunction=CC.MovementCollisionCheck;for(i=0;i<connectionsLength;++i){var nextConnection=connections[values[i]];var targetNode=nextConnection.node;if(previousNodes.find(targetNode)>=0){continue}var collidedWith=MovementCollisionCheckFunction(objectToPath,fromNode.point,targetNode.point,CC.collision_static);if(collidedWith){continue}var pathDistance=currentDistance+nextConnection.distance;previousNodes.add(targetNode);if(this.followPath(objectToPath,path,nextDirection,pathDistance,previousNodes,targetNode,toNode)){path.directions[currentDirection]=values[i];return true}}return false};function CCAudioManager(){}CCAudioManager.Enabled=CC.LoadData("AudioDisabled")?false:true;CCAudioManager.Paused=false;CCAudioManager.MP3s=[];CCAudioManager.ToggleAudio=function(){CCAudioManager.Enabled=!CCAudioManager.Enabled;if(!CCAudioManager.Enabled){CC.SaveData("AudioDisabled",true)}else{CC.DeleteData("AudioDisabled")}var MP3s=CCAudioManager.MP3s;for(var i=0;i<MP3s.length;++i){var mp3=MP3s[i];mp3.mute(CCAudioManager.Enabled?false:true)}};CCAudioManager.IsPlaying=function(id){var MP3s=CCAudioManager.MP3s;for(var i=0;i<MP3s.length;++i){var mp3=MP3s[i];if(mp3.id===id){return mp3.isPlaying()}}return false};CCAudioManager.Prepare=function(id,url,callback){var MP3s=CCAudioManager.MP3s;var mp3=CCAudioManager.Get(id);if(mp3){if(mp3.url!==url){CCAudioManager.Stop(id);mp3=null}}if(mp3){if(callback){if(mp3.onLoadedCallbacks){mp3.onLoadedCallbacks.push(callback)}else if(!mp3.error){callback(mp3)}}return}mp3=new CCMP3(id,url);mp3.id=id;mp3.url=url;mp3.onLoadedCallbacks=[];if(callback){mp3.onLoadedCallbacks.push(callback)}CCAudioManager.MP3s.push(mp3);var OnCached=function(mp3){return function(binary){CCAudioManager.Prepared(mp3.id,mp3.url,binary)}};CCAudioManager.Cache(url,new OnCached(mp3))};CCAudioManager.Cache=function(url,callback){var filename=url.getFilename();var downloadURL=MultiplayerManager.GetAssetURL(url);gURLManager.requestURL(downloadURL,null,function(status,responseBinary){if(status>=CCURLRequest.Succeeded){if(responseBinary){if(callback){callback(responseBinary)}}}},0,filename,null,null,true)};CCAudioManager.Get=function(id){var MP3s=CCAudioManager.MP3s;for(var i=0;i<MP3s.length;++i){var mp3=MP3s[i];if(mp3.id===id){return mp3}}return null};CCAudioManager.Stop=function(id){var mp3=CCAudioManager.Get(id);if(mp3){CCAudioManager.MP3s.remove(mp3);mp3.stop();return true}return false};CCAudioManager.StopAll=function(){var MP3s=CCAudioManager.MP3s;while(MP3s.length>0){var mp3=MP3s[0];CCAudioManager.MP3s.remove(mp3);mp3.stop()}};CCAudioManager.Pause=function(){CCAudioManager.Paused=true;var MP3s=CCAudioManager.MP3s;for(var i=0;i<MP3s.length;++i){var mp3=MP3s[i];mp3.pause()}};CCAudioManager.Resume=function(){CCAudioManager.Paused=false;var MP3s=CCAudioManager.MP3s;for(var i=0;i<MP3s.length;++i){var mp3=MP3s[i];mp3.resume()}};CCAudioManager.IsDetectingSpeechState=function(){};CCAudioManager.StartSpeechDetection=function(){};CCAudioManager.StopSpeechDetection=function(){};function CCCameraProjectionResults(){this.vNear=vec3.create();this.vFar=vec3.create();this.vDirection=vec3.create();this.vLookAt=vec3.create()}function CCCameraBase(){this.construct()}CCCameraBase.NextID=0;CCCameraBase.frustum_right=0*4;CCCameraBase.frustum_left=1*4;CCCameraBase.frustum_bottom=2*4;CCCameraBase.frustum_top=3*4;CCCameraBase.frustum_far=4*4;CCCameraBase.frustum_near=5*4;CCCameraBase.frustum_max=6*4;CCCameraBase.prototype.construct=function(){this.cameraID=CCCameraBase.NextID++;this.enabled=true;this.viewMatrix=mat4.create();this.projectionMatrix=mat4.create();this.currentLookAt=vec3.create();this.currentRotatedPosition=vec3.create();this.lookAt=this.currentLookAt;this.rotatedPosition=this.currentRotatedPosition;this.offset=vec3.create();this.position=vec3.create();this.rotation=vec3.create();this.viewport=vec4.create();this.frustum=new CCRenderer.Float32Array(CCCameraBase.frustum_max*4);this.frustumClip=new CCRenderer.Float32Array(16);this.perspective=60;this.cameraTouches=[];this.cameraTouches.push(new CCTouch);this.cameraTouches.push(new CCTouch);this.projectionResults=new CCCameraProjectionResults;this.visibleCollideables=[]};CCCameraBase.prototype.resize=function(){this.recalcViewport()};CCCameraBase.prototype.setupViewport=function(x,y,width,height){if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCCameraBase.setupViewport;"+this.cameraID+";"+x+";"+y+";"+width+";"+height+"\n"}this.viewportX=x;this.viewportY=y;this.viewportX2=x+width;this.viewportY2=y+height;this.viewportWidth=width;this.viewportHeight=height;this.invViewportWidth=1/this.viewportWidth;this.invViewportHeight=1/this.viewportHeight;var viewport=this.viewport;var renderer=gRenderer;{var temp;if(CCEngine.Orientation.target===270){temp=width;width=height;height=temp;temp=x;x=y;y=temp;x=1-width-x}else if(CCEngine.Orientation.target===90){temp=width;width=height;height=temp;temp=x;x=y;y=temp;y=1-height-y}}var invY=1-height-y;var frameBufferWidth=renderer.width;var frameBufferHeight=renderer.height;var definedWidth=width*frameBufferWidth;var definedHeight=height*frameBufferHeight;viewport[0]=x*frameBufferWidth;viewport[1]=invY*frameBufferHeight;viewport[2]=definedWidth;viewport[3]=definedHeight;this.orientedAspectRatio=this.actualAspectRatio=definedWidth/definedHeight;{if(!CCEngine.IsPortrait()){this.orientedAspectRatio=definedHeight/definedWidth}}this.setPerspective()};CCCameraBase.prototype.recalcViewport=function(){this.setupViewport(this.viewportX,this.viewportY,this.viewportWidth,this.viewportHeight)};CCCameraBase.prototype.setViewport=function(){var renderer=gRenderer;var viewport=this.viewport;renderer.GLViewport(viewport[0],viewport[1],viewport[2],viewport[3]);renderer.GLScissor(viewport[0],viewport[1],viewport[2],viewport[3])};CCCameraBase.prototype.setPerspective=function(perspective){if(perspective!==undefined){this.perspective=perspective}this.gluPerspective(this.perspective*this.viewportWidth,this.actualAspectRatio,1,4e4)};CCCameraBase.prototype.update=function(){CCCameraBase.currentCamera=this;var viewMatrix=this.viewMatrix;mat4.identity(this.viewMatrix);var currentRotatedPosition=this.currentRotatedPosition;var currentLookAt=this.currentLookAt;if(CCEngine.Orientation.current!==0){CC.MatrixRotateDegrees(viewMatrix,CCEngine.Orientation.current,0,0,1)}this.gluLookAt(currentRotatedPosition[0],currentRotatedPosition[1],currentRotatedPosition[2],currentLookAt[0],currentLookAt[1],currentLookAt[2],0,1,0);gRenderer.CCSetViewMatrix(this);this.ExtractFrustum();this.updateVisibleCollideables()};CCCameraBase.prototype.interpolateCamera=function(delta,speed){if(this.updating){gRenderer.pendingRender=true;this.updating=false;return true}return false};CCCameraBase.prototype.setLookAt=function(newLookAt){vec3.copy(this.lookAt,newLookAt)};CCCameraBase.prototype.setLookAtX=function(x){this.lookAt[0]=x;this.setLookAt(this.lookAt)};CCCameraBase.prototype.setLookAtY=function(y){this.lookAt[1]=y;this.setLookAt(this.lookAt)};CCCameraBase.prototype.setOffset=function(offsetTarget){this.updateOffset(offsetTarget)};CCCameraBase.prototype.updateOffset=function(offsetTarget){var lookAt=this.lookAt;var position=this.position;var rotatedPosition=this.rotatedPosition;var rotation=this.rotation;vec3.copy(this.offset,offsetTarget);vec3.copy(position,lookAt);vec3.add(position,position,this.offset);vec3.copy(rotatedPosition,position);CC.Vector3RotateAboutX(rotatedPosition,rotation[0],position,lookAt);CC.Vector3RotateAboutY(rotatedPosition,rotation[1],rotatedPosition,lookAt)};CCCameraBase.prototype.updateLookAtDirection=function(position,direction){var lookAt=this.lookAt;var rotatedPosition=this.rotatedPosition;var rotation=this.rotation;vec3.copy(rotatedPosition,position);vec3.copy(lookAt,rotatedPosition);lookAt[0]+=direction[2];CC.Vector3RotateAboutX(lookAt,rotation[0],lookAt,position);CC.Vector3RotateAboutY(lookAt,rotation[1],lookAt,position)};CCCameraBase.prototype.getRelativeTouches=function(screenTouches){var cameraTouches=this.cameraTouches;for(var i=0;i<screenTouches.length;++i){var screenTouch=screenTouches[i];var cameraTouch=cameraTouches[i];cameraTouch.state=screenTouch.state;cameraTouch.x=screenTouch.x;cameraTouch.y=screenTouch.y;cameraTouch.startX=screenTouch.startX;cameraTouch.startY=screenTouch.startY;cameraTouch.deltaX=screenTouch.deltaX;cameraTouch.deltaY=screenTouch.deltaY;cameraTouch.totalDeltaX=screenTouch.totalDeltaX;cameraTouch.totalDeltaY=screenTouch.totalDeltaY;cameraTouch.usingTouch=screenTouch.usingTouch;cameraTouch.timeHeld=screenTouch.timeHeld;cameraTouch.lastTimeReleased=screenTouch.lastTimeReleased;var viewportX=this.viewportX;var invViewportWidth=this.invViewportWidth;var viewportY=this.viewportY;var invViewportHeight=this.invViewportHeight;cameraTouch.startX-=viewportX;cameraTouch.startX*=invViewportWidth;cameraTouch.startY-=viewportY;cameraTouch.startY*=invViewportHeight;cameraTouch.x-=viewportX;cameraTouch.x*=invViewportWidth;cameraTouch.y-=viewportY;cameraTouch.y*=invViewportHeight;cameraTouch.deltaX*=invViewportWidth;cameraTouch.deltaY*=invViewportHeight;cameraTouch.totalDeltaX*=invViewportWidth;cameraTouch.totalDeltaY*=invViewportHeight;var screenLastDeltas=screenTouch.lastDeltas;var cameraLastDeltas=cameraTouch.lastDeltas;for(var deltaIndex=0;deltaIndex<screenLastDeltas.length;++deltaIndex){var screenLastDelta=screenLastDeltas[deltaIndex];var cameraLastDelta=cameraLastDeltas[deltaIndex];cameraLastDelta.time=screenLastDelta.time;cameraLastDelta.delta.x=screenLastDelta.delta.x*invViewportWidth;cameraLastDelta.delta.y=screenLastDelta.delta.y*invViewportHeight}}return cameraTouches};CCCameraBase.prototype.setRotationX=function(inRotation){this.rotation[0]=inRotation;this.updating=true};CCCameraBase.prototype.setRotationY=function(inRotation){this.rotation[1]=inRotation;this.updating=true};CCCameraBase.prototype.setRotationZ=function(inRotation){this.rotation[2]=inRotation;this.updating=true};CCCameraBase.prototype.incrementRotationX=function(increment){this.rotation[0]+=increment;this.setRotationX(this.rotation[0])};CCCameraBase.prototype.incrementRotationY=function(increment){this.rotation[1]+=increment;this.setRotationY(this.rotation[1])};CCCameraBase.prototype.incrementRotationZ=function(increment){this.rotation[2]+=increment;this.setRotationZ(this.rotation[2])};CCCameraBase.SetVisibleSortFunction=function(callback){CCCameraBase.VisibleSortFunction=callback};CCCameraBase.prototype.useSceneCollideables=function(scene){this.collideables=scene.collideables;if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCCameraBase.useSceneCollideables;"+this.cameraID+";"+scene.sceneID+"\n"}};CCCameraBase.prototype.updateVisibleCollideables=function(){if(this.collideables){CC.ScanVisibleCollideables(this.frustum,this.collideables,this.visibleCollideables)}else{CCOctree.ScanVisibleCollideables(this.frustum,this.visibleCollideables)}this.visibleCollideables.sort(CCCameraBase.VisibleSortFunction)};CCCameraBase.prototype.gluPerspective=function(fovy,aspect,zNear,zFar){var top=zNear*Math.tan(fovy*Math.PI/360);var right=top*aspect;var zNearScale=1/zNear;this.frustumWidth=right*2*zNearScale;this.frustumHeight=top*2*zNearScale;mat4.frustum(this.projectionMatrix,-right,right,-top,top,zNear,zFar);if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCCameraBase.gluPerspective;"+this.cameraID+";"+right+";"+top+";"+zNear+";"+zFar+"\n"}};CCCameraBase.prototype.project3D=function(x,y){CCEngine.ProjectOrientation(x,y,function(projectedX,projectedY){x=projectedX;y=projectedY});var viewport=this.viewport;y=1-y;
x*=viewport[2];x+=viewport[0];y*=viewport[3];y+=viewport[1];var projectionResults=this.projectionResults;if(this.gluUnProject(x,y,0,projectionResults.vNear)&&this.gluUnProject(x,y,1,projectionResults.vFar)){vec3.copy(projectionResults.vDirection,projectionResults.vFar);vec3.subtract(projectionResults.vDirection,projectionResults.vDirection,projectionResults.vNear);vec3.unitize(projectionResults.vDirection);vec3.copy(projectionResults.vLookAt,projectionResults.vNear);var projectionOffset=vec3.create();vec3.scale(projectionOffset,projectionResults.vDirection,projectionResults.vNear[2]);vec3.add(projectionResults.vLookAt,projectionResults.vLookAt,projectionOffset);return true}return false};CCCameraBase.prototype.project3DY=function(result,x,y,offset){if(this.project3D(x,y)){var projectionResults=this.projectionResults;if(typeof offset!=="number"){offset=projectionResults.vNear[1]/Math.abs(projectionResults.vDirection[1])}vec3.scale(result,projectionResults.vDirection,offset);vec3.add(result,result,projectionResults.vNear)}};CCCameraBase.prototype.flagUpdate=function(){this.updating=true};CCCameraBase.prototype.gluLookAt=function(eyex,eyey,eyez,centerx,centery,centerz,upx,upy,upz){var x=vec3.create();var y=vec3.create();var z=vec3.create();z[0]=eyex-centerx;z[1]=eyey-centery;z[2]=eyez-centerz;var mag=Math.sqrt(z[0]*z[0]+z[1]*z[1]+z[2]*z[2]);if(mag){z[0]/=mag;z[1]/=mag;z[2]/=mag}y[0]=upx;y[1]=upy;y[2]=upz;x[0]=y[1]*z[2]-y[2]*z[1];x[1]=-y[0]*z[2]+y[2]*z[0];x[2]=y[0]*z[1]-y[1]*z[0];y[0]=z[1]*x[2]-z[2]*x[1];y[1]=-z[0]*x[2]+z[2]*x[0];y[2]=z[0]*x[1]-z[1]*x[0];mag=Math.sqrt(x[0]*x[0]+x[1]*x[1]+x[2]*x[2]);if(mag){x[0]/=mag;x[1]/=mag;x[2]/=mag}mag=Math.sqrt(y[0]*y[0]+y[1]*y[1]+y[2]*y[2]);if(mag){y[0]/=mag;y[1]/=mag;y[2]/=mag}var m=mat4.create();m[4*0+0]=x[0];m[4*1+0]=x[1];m[4*2+0]=x[2];m[4*3+0]=0;m[4*0+1]=y[0];m[4*1+1]=y[1];m[4*2+1]=y[2];m[4*3+1]=0;m[4*0+2]=z[0];m[4*1+2]=z[1];m[4*2+2]=z[2];m[4*3+2]=0;m[4*0+3]=0;m[4*1+3]=0;m[4*2+3]=0;m[4*3+3]=1;var viewMatrix=this.viewMatrix;CC.MatrixMultiply(viewMatrix,m,viewMatrix);var eyeVector=vec3.create();eyeVector[0]=-eyex;eyeVector[1]=-eyey;eyeVector[2]=-eyez;mat4.translate(viewMatrix,viewMatrix,eyeVector)};CCCameraBase.FinalMatrix=mat4.create();CCCameraBase.Input=vec4.create();CCCameraBase.Out=vec4.create();CCCameraBase.prototype.gluUnProject=function(winX,winY,winZ,resultVector){var finalMatrix=CCCameraBase.FinalMatrix;var input=CCCameraBase.Input;var out=CCCameraBase.Out;mat4.multiply(finalMatrix,this.projectionMatrix,this.viewMatrix);if(!mat4.invert(finalMatrix,finalMatrix)){return false}input[0]=winX;input[1]=winY;input[2]=winZ;input[3]=1;var viewport=this.viewport;input[0]=(input[0]-viewport[0])/viewport[2];input[1]=(input[1]-viewport[1])/viewport[3];input[0]=input[0]*2-1;input[1]=input[1]*2-1;input[2]=input[2]*2-1;mat4.multiplyVec4(finalMatrix,input,out);if(out[3]===0){return false}out[0]/=out[3];out[1]/=out[3];out[2]/=out[3];resultVector[0]=out[0];resultVector[1]=out[1];resultVector[2]=out[2];return true};CCCameraBase.prototype.ExtractFrustum=function(){var proj=this.projectionMatrix;var modv=this.viewMatrix;var clip=this.frustumClip;var t;var frustum=this.frustum;var frustum_right=CCCameraBase.frustum_right;var frustum_left=CCCameraBase.frustum_left;var frustum_bottom=CCCameraBase.frustum_bottom;var frustum_top=CCCameraBase.frustum_top;var frustum_far=CCCameraBase.frustum_far;var frustum_near=CCCameraBase.frustum_near;clip[0]=modv[0]*proj[0]+modv[1]*proj[4]+modv[2]*proj[8]+modv[3]*proj[12];clip[1]=modv[0]*proj[1]+modv[1]*proj[5]+modv[2]*proj[9]+modv[3]*proj[13];clip[2]=modv[0]*proj[2]+modv[1]*proj[6]+modv[2]*proj[10]+modv[3]*proj[14];clip[3]=modv[0]*proj[3]+modv[1]*proj[7]+modv[2]*proj[11]+modv[3]*proj[15];clip[4]=modv[4]*proj[0]+modv[5]*proj[4]+modv[6]*proj[8]+modv[7]*proj[12];clip[5]=modv[4]*proj[1]+modv[5]*proj[5]+modv[6]*proj[9]+modv[7]*proj[13];clip[6]=modv[4]*proj[2]+modv[5]*proj[6]+modv[6]*proj[10]+modv[7]*proj[14];clip[7]=modv[4]*proj[3]+modv[5]*proj[7]+modv[6]*proj[11]+modv[7]*proj[15];clip[8]=modv[8]*proj[0]+modv[9]*proj[4]+modv[10]*proj[8]+modv[11]*proj[12];clip[9]=modv[8]*proj[1]+modv[9]*proj[5]+modv[10]*proj[9]+modv[11]*proj[13];clip[10]=modv[8]*proj[2]+modv[9]*proj[6]+modv[10]*proj[10]+modv[11]*proj[14];clip[11]=modv[8]*proj[3]+modv[9]*proj[7]+modv[10]*proj[11]+modv[11]*proj[15];clip[12]=modv[12]*proj[0]+modv[13]*proj[4]+modv[14]*proj[8]+modv[15]*proj[12];clip[13]=modv[12]*proj[1]+modv[13]*proj[5]+modv[14]*proj[9]+modv[15]*proj[13];clip[14]=modv[12]*proj[2]+modv[13]*proj[6]+modv[14]*proj[10]+modv[15]*proj[14];clip[15]=modv[12]*proj[3]+modv[13]*proj[7]+modv[14]*proj[11]+modv[15]*proj[15];frustum[frustum_right+0]=clip[3]-clip[0];frustum[frustum_right+1]=clip[7]-clip[4];frustum[frustum_right+2]=clip[11]-clip[8];frustum[frustum_right+3]=clip[15]-clip[12];t=Math.sqrt(frustum[frustum_right+0]*frustum[frustum_right+0]+frustum[frustum_right+1]*frustum[frustum_right+1]+frustum[frustum_right+2]*frustum[frustum_right+2]);frustum[frustum_right+0]/=t;frustum[frustum_right+1]/=t;frustum[frustum_right+2]/=t;frustum[frustum_right+3]/=t;frustum[frustum_left+0]=clip[3]+clip[0];frustum[frustum_left+1]=clip[7]+clip[4];frustum[frustum_left+2]=clip[11]+clip[8];frustum[frustum_left+3]=clip[15]+clip[12];t=Math.sqrt(frustum[frustum_left+0]*frustum[frustum_left+0]+frustum[frustum_left+1]*frustum[frustum_left+1]+frustum[frustum_left+2]*frustum[frustum_left+2]);frustum[frustum_left+0]/=t;frustum[frustum_left+1]/=t;frustum[frustum_left+2]/=t;frustum[frustum_left+3]/=t;frustum[frustum_bottom+0]=clip[3]+clip[1];frustum[frustum_bottom+1]=clip[7]+clip[5];frustum[frustum_bottom+2]=clip[11]+clip[9];frustum[frustum_bottom+3]=clip[15]+clip[13];t=Math.sqrt(frustum[frustum_bottom+0]*frustum[frustum_bottom+0]+frustum[frustum_bottom+1]*frustum[frustum_bottom+1]+frustum[frustum_bottom+2]*frustum[frustum_bottom+2]);frustum[frustum_bottom+0]/=t;frustum[frustum_bottom+1]/=t;frustum[frustum_bottom+2]/=t;frustum[frustum_bottom+3]/=t;frustum[frustum_top+0]=clip[3]-clip[1];frustum[frustum_top+1]=clip[7]-clip[5];frustum[frustum_top+2]=clip[11]-clip[9];frustum[frustum_top+3]=clip[15]-clip[13];t=Math.sqrt(frustum[frustum_top+0]*frustum[frustum_top+0]+frustum[frustum_top+1]*frustum[frustum_top+1]+frustum[frustum_top+2]*frustum[frustum_top+2]);frustum[frustum_top+0]/=t;frustum[frustum_top+1]/=t;frustum[frustum_top+2]/=t;frustum[frustum_top+3]/=t;frustum[frustum_far+0]=clip[3]-clip[2];frustum[frustum_far+1]=clip[7]-clip[6];frustum[frustum_far+2]=clip[11]-clip[10];frustum[frustum_far+3]=clip[15]-clip[14];t=Math.sqrt(frustum[frustum_far+0]*frustum[frustum_far+0]+frustum[frustum_far+1]*frustum[frustum_far+1]+frustum[frustum_far+2]*frustum[frustum_far+2]);frustum[frustum_far+0]/=t;frustum[frustum_far+1]/=t;frustum[frustum_far+2]/=t;frustum[frustum_far+3]/=t;frustum[frustum_near+0]=clip[3]+clip[2];frustum[frustum_near+1]=clip[7]+clip[6];frustum[frustum_near+2]=clip[11]+clip[10];frustum[frustum_near+3]=clip[15]+clip[14];t=Math.sqrt(frustum[frustum_near+0]*frustum[frustum_near+0]+frustum[frustum_near+1]*frustum[frustum_near+1]+frustum[frustum_near+2]*frustum[frustum_near+2]);frustum[frustum_near+0]/=t;frustum[frustum_near+1]/=t;frustum[frustum_near+2]/=t;frustum[frustum_near+3]/=t};CCCameraBase.prototype.getAspectRatio=function(){return this.orientedAspectRatio};function CCCameraAppUI(){this.construct();this.targetWidth=1;this.targetHeight=1;this.targetOffset=vec3.create();this.targetLookAt=vec3.create();this.currentLookAtTarget=vec3.create();this.currentOffsetTarget=vec3.create();this.lookAtInterpolator=new CCInterpolatorV3(CCInterpolatorX3Curve).setup(this.lookAt);var offsetInterpolator=this.offsetInterpolator=new CCInterpolatorV3(CCInterpolatorSin2Curve).setup(this.offset);this.interpolating=true}ExtendPrototype(CCCameraAppUI,CCCameraBase);CCCameraAppUI.prototype.resize=function(){this.CCCameraBase_resize();if(this.targetWidth){this.setCameraWidth(this.targetWidth)}};CCCameraAppUI.prototype.setLookAt=function(newLookAt,interpolate){if(interpolate===undefined){interpolate=true}this.CCCameraBase_setLookAt(newLookAt);vec3.copy(this.currentLookAtTarget,this.lookAt);vec3.copy(this.targetLookAt,this.lookAt);this.lookAtInterpolator.setup(this.lookAt,this.currentLookAtTarget);if(!interpolate){vec3.copy(this.currentLookAtTarget,this.lookAt)}};CCCameraAppUI.prototype.setOffset=function(newOffset){this.CCCameraBase_setOffset(newOffset);vec3.copy(this.currentOffsetTarget,this.offset);vec3.copy(this.targetOffset,this.offset);this.offsetInterpolator.setup(this.offset,this.currentOffsetTarget)};CCCameraAppUI.prototype.interpolateCamera=function(delta,speed){if(this.updating){gRenderer.pendingRender=true;this.updating=false;if(this.interpolating){var offset=this.offset;{var offsetInterpolator=this.offsetInterpolator;var currentOffsetTarget=this.currentOffsetTarget;var targetOffset=this.targetOffset;if(!vec3.equals(currentOffsetTarget,targetOffset)){vec3.copy(currentOffsetTarget,targetOffset);offsetInterpolator.setup(offset,currentOffsetTarget)}if(offsetInterpolator.update(delta)){this.refreshCameraSize();this.updating=true}}{var lookAtInterpolator=this.lookAtInterpolator;var currentLookAtTarget=this.currentLookAtTarget;var targetLookAt=this.targetLookAt;var lookAt=this.lookAt;if(!vec3.equals(currentLookAtTarget,targetLookAt)){vec3.copy(currentLookAtTarget,targetLookAt);lookAtInterpolator.setup(lookAt,currentLookAtTarget)}if(lookAtInterpolator.update(delta*speed)){this.updating=true}}{this.updateOffset(offset)}}return true}return false};CCCameraAppUI.prototype.setCameraWidth=function(inWidth,interpolate){this.targetWidth=this.cameraWidth=inWidth;this.targetOffset[2]=inWidth;if(CCEngine.IsPortrait()){this.targetOffset[2]/=this.frustumWidth;this.cameraHeight=this.targetOffset[2]*this.frustumHeight}else{this.targetOffset[2]/=this.frustumHeight;this.cameraHeight=this.targetOffset[2]*this.frustumWidth}this.targetHeight=this.cameraHeight;this.cameraHWidth=this.cameraWidth*.5;this.cameraHHeight=this.cameraHeight*.5;this.flagUpdate();if(!interpolate){this.setOffset(this.targetOffset)}};CCCameraAppUI.prototype.setCameraHeight=function(inHeight,interpolate){this.targetHeight=this.cameraHeight=inHeight;this.targetOffset[2]=inHeight;if(CCEngine.IsPortrait()){this.targetOffset[2]/=this.frustumHeight;this.cameraWidth=this.targetOffset[2]*this.frustumWidth}else{this.targetOffset[2]/=this.frustumWidth;this.cameraWidth=this.targetOffset[2]*this.frustumHeight}this.targetWidth=this.cameraWidth;this.cameraHWidth=this.cameraWidth*.5;this.cameraHHeight=this.cameraHeight*.5;this.flagUpdate();if(!interpolate){this.setOffset(this.targetOffset)}};CCCameraAppUI.prototype.refreshCameraSize=function(){var currentOffset=this.offset;if(CCEngine.IsPortrait()){this.cameraWidth=currentOffset[2]*this.frustumWidth;this.cameraHeight=currentOffset[2]*this.frustumHeight}else{this.cameraWidth=currentOffset[2]*this.frustumHeight;this.cameraHeight=currentOffset[2]*this.frustumWidth}this.cameraHWidth=this.cameraWidth*.5;this.cameraHHeight=this.cameraHeight*.5};CCCameraAppUI.prototype.calcCameraOffsetForWidth=function(inWidth){var offsetZ=inWidth;if(CCEngine.IsPortrait()){offsetZ/=this.frustumWidth}else{offsetZ/=this.frustumHeight}return offsetZ};CCCameraAppUI.prototype.calcCameraOffsetForHeight=function(inHeight){var offsetZ=inHeight;if(CCEngine.IsPortrait()){offsetZ/=this.frustumHeight}else{offsetZ/=this.frustumWidth}return offsetZ};CCCameraAppUI.prototype.calcCameraWidthForOffset=function(inOffset){var width=inOffset;if(CCEngine.IsPortrait()){width*=this.frustumWidth}else{width*=this.frustumHeight}return width};CCCameraAppUI.prototype.calcCameraHeightForOffset=function(inOffset){var height=inOffset;if(CCEngine.IsPortrait()){height*=this.frustumHeight}else{height*=this.frustumWidth}return height};function CCCameraFPS(){this.construct();this.targetWidth=1;this.targetHeight=1}ExtendPrototype(CCCameraFPS,CCCameraBase);CCCameraFPS.prototype.update=function(){this.CCCameraBase_update()};function CCAPIFacebook(){}CCAPIFacebook.APP_ID="138263572915502";CCAPIFacebook.API_PERMISSIONS="user_photos,publish_stream,";CCAPIFacebook.API_URL="https://graph.facebook.com/";function CCFBCallback(callback,url,cacheFile){this.callback=callback;this.url=url;this.cacheFile=cacheFile}CCFBCallback.prototype.run=function(status,responseText){function Reply(){}var reply=new Reply;reply.data=responseText;reply.state=status;reply.url=this.url;if(!responseText||responseText.length===0){reply.state=CCURLRequest.Data_Error}else if(responseText.contains("OAuthException")){reply.state=CCURLRequest.Data_Error}else if(responseText==="false"){reply.state=CCURLRequest.Data_Error}if(reply.state===CCURLRequest.Succeeded){CC.SaveData(this.cacheFile,responseText)}else{var data=CC.LoadData(this.cacheFile);if(data!==undefined){reply.state=CCURLRequest.Failed_But_Used_Cache;reply.data=data}}this.callback.reply=reply;this.callback.run()};CCAPIFacebook.SetCacheFile=function(apiCall){apiCall.replace(".","/");return"facebook."+apiCall};CCAPIFacebook.Request=function(inCallback,apiCall,priority,refresh,timeout,limit,offset){if(refresh===undefined){refresh=false}if(timeout===undefined){timeout=0}var url=CCAPIFacebook.API_URL;url+=apiCall;var cacheFile=CCAPIFacebook.SetCacheFile(apiCall);if(!CCAPIFacebook.m_userAccessToken){if(refresh){if(inCallback){inCallback.run()}return}var data=CC.LoadData(cacheFile);if(data===undefined){if(inCallback){inCallback.run()}return}}if(CCAPIFacebook.m_userAccessToken){url+="?access_token="+CCAPIFacebook.m_userAccessToken}if(limit){url+="&limit=";url+=limit}if(offset!==undefined){url+="&offset=";url+=offset}var proxyURL=url;if(MultiplayerManager.UseURLProxy(url)){proxyURL=SERVER_ROOT+"backend/helper.php?url="+url;proxyURL=url}gURLManager.requestURL(proxyURL,null,new CCFBCallback(inCallback,url,cacheFile))};CCAPIFacebook.RequestFBURL=function(inCallback,url,priority,refresh,timeout){if(!CCAPIFacebook.m_userAccessToken){}if(!refresh){refresh=false}if(!timeout){timeout=0}var cacheFile=String.SplitAfter(url,"facebook.com/");{cacheFile=String.RemoveBetweenIncluding(cacheFile,"access_token=","&");cacheFile=String.ReplaceChar(cacheFile,"/",".");cacheFile=String.ReplaceChar(cacheFile,"?",".");cacheFile=String.ReplaceChar(cacheFile,"&",".");cacheFile=String.ReplaceChar(cacheFile,"=",".")}var escapedURL=String.RemoveBetweenIncluding(url,"access_token=","&");escapedURL+="&access_token="+CCAPIFacebook.m_userAccessToken;gURLManager.requestURL(escapedURL,null,new CCFBCallback(inCallback,url).run,0,cacheFile,refresh?0:-1,timeout)};CCAPIFacebook.RequestPhotoID=function(fbInterface,photoID,priority){var url="http://softpoetry.com/backend/facebook.php?profilethumb="+photoID;if(CCAPIFacebook.m_userAccessToken){url+="&token="+CCAPIFacebook.m_userAccessToken}gEngine.textureManager.getTextureHandle(url,function(textureHandle){fbInterface.APIDownloadedPhoto(url,photoID)})};CCAPIFacebook.SetUserAccessToken=function(token){CCAPIFacebook.m_userAccessToken=token};CCAPIFacebook.GetUserAccessToken=function(){return CCAPIFacebook.m_userAccessToken};CCAPIFacebook.ClearCache=function(){delete CCAPIFacebook.m_userAccessToken;CC.DeleteData("facebook.me")};CCAPIFacebook.GetAuthorizationURL=function(){var authorizationURL="https://www.facebook.com/dialog/oauth";authorizationURL+="?client_id=";authorizationURL+=CCAPIFacebook.APP_ID;authorizationURL+="&redirect_uri=http://softpoetry.com/backend/facebook.php?domain="+SERVER_ROOT.getDomain()+"&";authorizationURL+="type=user_agent&";authorizationURL+="display=popup&";authorizationURL+="scope=";authorizationURL+=CCAPIFacebook.API_PERMISSIONS;return authorizationURL};CCAPIFacebook.StartLogin=function(callback){if(!CCAPIFacebook.m_onLoginResult){CCEngine.WebViewOpen(CCAPIFacebook.GetAuthorizationURL(),function(webViewController,opened){if(opened){CCAPIFacebook.m_onLoginResult=callback}},CCAPIFacebook.ProcessLogin,{width:480,height:480})}};CCAPIFacebook.ProcessLogin=function(webViewController,url,open){if(open){if(url.contains("connected.php")){var splitURL=url.split("#access_token");if(splitURL.length>1){var token=String.SplitBetween(url,"#access_token=","&");CCAPIFacebook.SetUserAccessToken(token)}CCAPIFacebook.FinishLogin();return}if(window.tizen){if(!url.contains("facebook.com/recover/initiate/")&&!url.contains("facebook.com/login/identify?")){var allowedURLs=["about:blank","login.php?","dialog/oauth","facebook.php","connected.php"];for(var i=0;i<allowedURLs.length;++i){if(url.contains(allowedURLs[i])){return}}}CCAPIFacebook.FinishLogin();AlertsManager.TimeoutAlert("only login function is available",15)}}else{CCAPIFacebook.FinishLogin()}};CCAPIFacebook.FinishLogin=function(){CCEngine.WebViewClose();if(CCAPIFacebook.m_onLoginResult){if(CCAPIFacebook.m_userAccessToken){gURLManager.setDomainTimeOut("facebook.com",1);CCAPIFacebook.m_onLoginResult();delete CCAPIFacebook.m_onLoginResult}else{delete CCAPIFacebook.m_onLoginResult}}};CCAPIFacebook.IsLoggingIn=function(){return!!CCAPIFacebook.m_onLoginResult};function CCAPIGoogle(){}CCAPIGoogle.User=undefined;CCAPIGoogle.RequestPhotoID=function(photoInterface,photoID,priority){var url="http://playir.com/google+/users/";url+=photoID;url+=".jpg";if(MultiplayerManager.UseURLProxy(url)){url=SERVER_ROOT+"backend/helper.php?url="+url}gEngine.textureManager.getTextureHandle(url,function(textureHandle){photoInterface.APIDownloadedPhoto(url,photoID)})};CCAPIGoogle.ClearCache=function(){delete CCAPIGoogle.User;CC.DeleteData("google.me")};CCAPIGoogle.StartLogin=function(callback){if(!CCAPIGoogle.m_onLoginResult){var url="http://playir.com/apis/google+/?auto";if(url.getDomain()!==SERVER_ROOT.getDomain()){url+="&redirect_uri="+SERVER_ROOT+"apis/google+/"}CCEngine.WebViewOpen(url,function(webViewController,opened){if(opened){CCAPIGoogle.m_onLoginResult=callback}},CCAPIGoogle.ProcessLogin,{width:480,height:480})}};CCAPIGoogle.ProcessLogin=function(webViewController,url,open){if(open){var i;var splitURL=url.split("?");if(splitURL.length>1){var parametersString=splitURL[1];var parametersSplit=parametersString.split("&");var id;var name;for(i=0;i<parametersSplit.length;++i){var parameters=parametersSplit[i];var parameterSplit=parameters.split("=");if(parameterSplit.length>1){var key=parameterSplit[0];var value=parameterSplit[1];if(key==="id"){id=value}else if(key==="name"){name=unescape(value)}}}if(id&&name){var username=splitURL[1].split("&");CCAPIGoogle.User={};CCAPIGoogle.User.id=id;CCAPIGoogle.User.name=name;CC.SaveData("google.me",JSON.stringify(CCAPIGoogle.User));CCAPIGoogle.FinishLogin(true);return}}}else{CCAPIGoogle.FinishLogin(false)}};CCAPIGoogle.FinishLogin=function(connected){CCEngine.WebViewClose();if(CCAPIGoogle.m_onLoginResult){if(connected){CCAPIGoogle.m_onLoginResult();delete CCAPIGoogle.m_onLoginResult}else{delete CCAPIGoogle.m_onLoginResult}}};CCAPIGoogle.IsLoggingIn=function(){return!!CCAPIGoogle.m_onLoginResult};function CCAPITwitter(){}CCAPITwitter.m_user=undefined;CCAPITwitter.RequestPhotoID=function(photoInterface,photoID,priority){var url="http://playir.com/apis/twitter/users/";url+=photoID;url+=".jpg";if(MultiplayerManager.UseURLProxy(url)){url=SERVER_ROOT+"backend/helper.php?url="+url}gEngine.textureManager.getTextureHandle(url,function(textureHandle){photoInterface.APIDownloadedPhoto(url,photoID)})};CCAPITwitter.ClearCache=function(){delete CCAPITwitter.m_user;CC.DeleteData("twitter.me")};CCAPITwitter.StartLogin=function(tweetSkippable,callback){if(!CCAPITwitter.m_onLoginResult){var url="http://playir.com/apis/twitter/?auto";if(tweetSkippable){url+="&tweetSkippable"}if(url.getDomain()!==WINDOW_DOMAIN){url+="&redirect_uri="+SERVER_ROOT+"/twitter/"}CCEngine.WebViewOpen(url,function(webViewController,opened){if(opened){CCAPITwitter.m_onLoginResult=callback}},CCAPITwitter.ProcessLogin,{width:480,height:480})}};CCAPITwitter.ProcessLogin=function(webViewController,url,open){if(open){var splitURL=url.split("/twitter/index.php?connected=");if(splitURL.length>1){var username=splitURL[1].split("&");CCAPITwitter.m_user=username[0];CC.SaveData("twitter.me",username[0]);CCAPITwitter.FinishLogin(true);return}}else{CCAPITwitter.FinishLogin(false)}};CCAPITwitter.FinishLogin=function(connected){CCEngine.WebViewClose();if(CCAPITwitter.m_onLoginResult){if(connected){CCAPITwitter.m_onLoginResult();delete CCAPITwitter.m_onLoginResult}else{delete CCAPITwitter.m_onLoginResult}}};CCAPITwitter.IsLoggingIn=function(){return!!CCAPITwitter.m_onLoginResult};function CCCollisionManager(octreeSize){this.octree=new CCOctree(null,vec3.create(),octreeSize);this.pruneOctreeTimer=0;this.collideables=[];this.pathFinderNetwork=new CCPathFinderNetwork}CCCollisionManager.prototype.addCollideable=function(collideable){this.collideables.add(collideable);CCOctree.AddObject(this.octree,collideable)};CCCollisionManager.prototype.removeCollideable=function(collideable){this.collideables.remove(collideable);CCOctree.RemoveObject(collideable)};CC.collision_none=0;CC.collision_box=1;CC.collision_static=2;CC.collision_moveable=4;CC.collision_character=8;CC.collision_ui=16;CC.UpdateCollisions=function(collideable,dependantOnFlags){if(dependantOnFlags===undefined){dependantOnFlags=true}if(collideable.updateCollisions&&(!dependantOnFlags||collideable.collideableType&CC.collision_box)){var aabbMin=collideable.aabbMin;var aabbMax=collideable.aabbMax;var position=collideable.position;var collisionBounds=collideable.collisionBounds;aabbMin[0]=position[0]-collisionBounds[0];aabbMin[1]=position[1]-collisionBounds[1];aabbMin[2]=position[2]-collisionBounds[2];aabbMax[0]=position[0]+collisionBounds[0];aabbMax[1]=position[1]+collisionBounds[1];aabbMax[2]=position[2]+collisionBounds[2];collideable.updateCollisions=false;if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CC.UpdateCollisions;"+collideable.jsID+";"+position[0]+","+position[1]+","+position[2]+";"+collisionBounds[0]+","+collisionBounds[1]+","+collisionBounds[2]+"\n"}}};CC.CalculateMinMaxVectors=function(min,max){var temp;for(var i=0;i<3;++i){if(min[i]>max[i]){temp=max[i];max[i]=min[i];min[i]=temp}}if(min[1]>max[1]){temp=max[1];max[1]=min[1];min[1]=temp}};CC.BasicBoxCollisionCheck=function(sourceMin,sourceMax,targetMin,targetMax){if(sourceMax[2]>=targetMin[2]&&sourceMin[2]<=targetMax[2]){if(sourceMax[0]>=targetMin[0]&&sourceMin[0]<=targetMax[0]){if(sourceMax[1]>=targetMin[1]&&sourceMin[1]<=targetMax[1]){return true}}}return false};CC.CollideableScan=function(min,max,sourceObject,flags,excludeInvisibles){if(flags===undefined){flags=CC.collision_box}var collideables=gEngine.collisionManager.collideables;var numberOfCollideables=collideables.length;var closestCollision=null;for(var i=0;i<numberOfCollideables;++i){var checkingObject=collideables[i];if(checkingObject!==sourceObject){if(CC.HasFlag(checkingObject.collideableType,CC.collision_ui)){continue}if(!checkingObject.shouldRender&&excludeInvisibles){continue}if(CC.HasFlag(checkingObject.collideableType,CC.collision_box)){if(flags===CC.collision_box||CC.HasFlag(checkingObject.collideableType,flags)){CC.UpdateCollisions(checkingObject);var targetMin=checkingObject.aabbMin;var targetMax=checkingObject.aabbMax;if(CC.BasicBoxCollisionCheck(min,max,targetMin,targetMax)){closestCollision=checkingObject;break}}}}}return closestCollision};CC.SourceMin=vec3.create();CC.SourceMax=vec3.create();CC.CollisionCheck=function(sourceObject,targetLocation,requestCollisions,flags){var collisionBounds=sourceObject.collisionBounds;var sourceMin=CC.SourceMin;vec3.copy(sourceMin,[targetLocation[0]-collisionBounds[0],targetLocation[1]-collisionBounds[1],targetLocation[2]-collisionBounds[2]]);var sourceMax=CC.SourceMax;vec3.copy(sourceMax,[targetLocation[0]+collisionBounds[0],targetLocation[1]+collisionBounds[1],targetLocation[2]+collisionBounds[2]]);var collideables=sourceObject.inScene.collideables;var numberOfCollideables=collideables.length;var closestCollision=null;var UpdateCollisionsFunction=CC.UpdateCollisions;var BasicBoxCollisionCheckFunction=CC.BasicBoxCollisionCheck;for(var i=0;i<numberOfCollideables;++i){var checkingObject=collideables[i];if(checkingObject!==sourceObject){if(checkingObject.collideableType&flags){UpdateCollisionsFunction(checkingObject);var targetMin=checkingObject.aabbMin;var targetMax=checkingObject.aabbMax;if(BasicBoxCollisionCheckFunction(sourceMin,sourceMax,targetMin,targetMax)){if(sourceObject.shouldCollide(checkingObject,true)){closestCollision=checkingObject;if(requestCollisions){closestCollision=sourceObject.requestCollisionWith(closestCollision)}if(closestCollision){return closestCollision}}}}}}return null};CC.LineIntersectionCheck=function(v1x1,v1y1,v1x2,v1y2,v2x1,v2y1,v2x2,v2y2){var d1,d2;var a1,a2,b1,b2,c1,c2;a1=v1y2-v1y1;b1=v1x1-v1x2;c1=v1x2*v1y1-v1x1*v1y2;d1=a1*v2x1+b1*v2y1+c1;d2=a1*v2x2+b1*v2y2+c1;if(d1>0&&d2>0){return false}if(d1<0&&d2<0){return false}a2=v2y2-v2y1;b2=v2x1-v2x2;c2=v2x2*v1y1-v2x1*v2y2;d1=a2*v1x1+b2*v1y1+c2;d2=a2*v1x2+b2*v1y2+c2;if(d1>0&&d2>0){return false}if(d1<0&&d2<0){return false}return true};CC.CollisionSourceX1=new Array(4);CC.CollisionSourceY1=new Array(4);CC.CollisionSourceX2=new Array(4);CC.CollisionSourceY2=new Array(4);CC.CollisionCheckingX=new Array(4);CC.CollisionCheckingY=new Array(4);CC.MovementLinesInsidePolygonCollisionCheck=function(startMin,startMax,targetMin,targetMax,checkingMin,checkingMax){var verts=4;var sourceX1=CC.CollisionSourceX1;var sourceY1=CC.CollisionSourceY1;var sourceX2=CC.CollisionSourceX2;var sourceY2=CC.CollisionSourceY2;sourceX1[0]=startMin[0];sourceY1[0]=startMin[2];sourceX2[0]=targetMin[0];sourceY2[0]=targetMin[2];sourceX1[1]=startMin[0];sourceY1[1]=startMax[2];sourceX2[1]=targetMin[0];sourceY2[1]=targetMax[2];sourceX1[2]=startMax[0];sourceY1[2]=startMax[2];sourceX2[2]=targetMax[0];sourceY2[2]=targetMax[2];sourceX1[3]=startMax[0];sourceY1[3]=startMin[2];sourceX2[3]=targetMax[0];sourceY2[3]=targetMin[2];var checkingX=CC.CollisionCheckingX;var checkingY=CC.CollisionCheckingY;checkingX[0]=checkingMin[0];checkingY[0]=checkingMin[2];checkingX[1]=checkingMin[0];checkingY[1]=checkingMax[2];checkingX[2]=checkingMax[0];checkingY[2]=checkingMax[2];checkingX[3]=checkingMax[0];checkingY[3]=checkingMin[2];var i,j,c;var v1x1,v1y1,v1x2,v1y2;var v2x1,v2y1,v2x2,v2y2;var CollisionCheckFunction=CC.LineIntersectionCheck;for(var sourceIndex=0;sourceIndex<verts;++sourceIndex){v1x1=sourceX1[sourceIndex];v1y1=sourceY1[sourceIndex];v1x2=sourceX2[sourceIndex];v1y2=sourceY2[sourceIndex];for(var checkingIndex=0;checkingIndex<verts;++checkingIndex){if(checkingIndex>0){v2x1=checkingX[checkingIndex-1];v2y1=checkingY[checkingIndex-1]}else{v2x1=checkingX[verts-1];v2y1=checkingY[verts-1]}v2x2=checkingX[checkingIndex];v2y2=checkingY[checkingIndex];if(CollisionCheckFunction(v1x1,v1y1,v1x2,v1y2,v2x1,v2y1,v2x2,v2y2)){return true}}}return false};CC.MovementCollisionsPending=[];CC.MovementCollisionsPendingNextID=0;CC.MovementCollisionCheckAsync=function(sourceObject,startPosition,targetPosition,flags,requestCollisions,callback){if(CCEngine.NativeUpdateCommands!==undefined){var command={};command.id=CC.MovementCollisionsPendingNextID++;command.sourceObject=sourceObject;command.flags=flags;command.requestCollisions=requestCollisions;command.callback=callback;CC.MovementCollisionsPending.push(command);CCEngine.NativeUpdateCommands+="CC.MovementCollisionCheckAsync;"+command.id+";"+sourceObject.jsID+";"+startPosition[0]+","+startPosition[1]+","+startPosition[2]+";"+targetPosition[0]+","+targetPosition[1]+","+targetPosition[2]+"\n"}else{var collidedWith=CC.MovementCollisionCheck(sourceObject,startPosition,targetPosition,flags,requestCollisions);callback(collidedWith)}};CC.MovementCollisionCheckResult=function(id,collisionIDs){var MovementCollisionsPending=CC.MovementCollisionsPending;for(var i=0;i<MovementCollisionsPending.length;++i){var command=MovementCollisionsPending[i];if(command.id==id){MovementCollisionsPending.remove(command);var sourceObject=command.sourceObject;var scene=sourceObject.inScene;if(scene){var flags=command.flags;var requestCollisions=command.requestCollisions;var callback=command.callback;var collideables=scene.collideables;var collideablesLength=collideables.length;var collisionIDsLength=collisionIDs.length;for(var collisionIDsIndex=0;collisionIDsIndex<collisionIDsLength;++collisionIDsIndex){var jsID=collisionIDs[collisionIDsIndex];for(var collideableIndex=0;collideableIndex<collideablesLength;++collideableIndex){var collideable=collideables[collideableIndex];if(collideable.jsID===jsID){if(collideable.collideableType&flags){if(sourceObject.shouldCollide(collideable,true)){var collidedWith=collideable;if(requestCollisions){collidedWith=sourceObject.requestCollisionWith(collidedWith)}if(collidedWith){callback(collidedWith);return}break}}}}}callback(null)}break}}};CC.MovementAreaMin=vec3.create();CC.MovementAreaMax=vec3.create();CC.MovementStartMin=vec3.create();CC.MovementStartMax=vec3.create();CC.MovementTargetMin=vec3.create();CC.MovementTargetMax=vec3.create();CC.MovementAreaCollideables=[];CC.MovementCollisionCheck=function(sourceObject,startPosition,targetPosition,flags,requestCollisions){var areaMin=CC.MovementAreaMin;var areaMax=CC.MovementAreaMax;var startMin=CC.MovementStartMin;var startMax=CC.MovementStartMax;var targetMin=CC.MovementTargetMin;var targetMax=CC.MovementTargetMax;var collisionBounds=sourceObject.collisionBounds;startMin[0]=startPosition[0]-collisionBounds[0];startMax[0]=startPosition[0]+collisionBounds[0];startMin[1]=startPosition[1]-collisionBounds[1];startMax[1]=startPosition[1]+collisionBounds[1];startMin[2]=startPosition[2]-collisionBounds[2];startMax[2]=startPosition[2]+collisionBounds[2];targetMin[0]=targetPosition[0]-collisionBounds[0];targetMax[0]=targetPosition[0]+collisionBounds[0];targetMin[1]=targetPosition[1]-collisionBounds[1];targetMax[1]=targetPosition[1]+collisionBounds[1];targetMin[2]=targetPosition[2]-collisionBounds[2];targetMax[2]=targetPosition[2]+collisionBounds[2];areaMin[0]=startMin[0]<targetMin[0]?startMin[0]:targetMin[0];areaMin[1]=startMin[1];areaMin[2]=startMin[2]<targetMin[2]?startMin[2]:targetMin[2];areaMax[0]=startMax[0]>targetMax[0]?startMax[0]:targetMax[0];areaMax[1]=targetMax[1];areaMax[2]=startMax[2]>targetMax[2]?startMax[2]:targetMax[2];var collideables=sourceObject.inScene.collideables;var numberOfCollideables=collideables.length;var UpdateCollisionsFunction=CC.UpdateCollisions;var BoxCollisionCheckFunction=CC.BasicBoxCollisionCheck;var areaCollideables=CC.MovementAreaCollideables;areaCollideables.length=0;var i,checkingObject,checkingMin,checkingMax;for(i=0;i<numberOfCollideables;++i){checkingObject=collideables[i];if(checkingObject!==sourceObject){if(checkingObject.collideableType&flags){if(checkingObject.owner!=sourceObject&&sourceObject.owner!=checkingObject){UpdateCollisionsFunction(checkingObject);checkingMin=checkingObject.aabbMin;checkingMax=checkingObject.aabbMax;if(BoxCollisionCheckFunction(areaMin,areaMax,checkingMin,checkingMax)){areaCollideables.push(checkingObject)}}}}}numberOfCollideables=areaCollideables.length;if(numberOfCollideables>0){var sourceMin=startMin;var sourceMax=startMax;var collidedWith=null;var velocityX=targetPosition[0]-startPosition[0];var velocityZ=targetPosition[2]-startPosition[2];var inverseBounds=sourceObject.inverseCollisionSize.width+1;var velocityVsBoundingX=velocityX*inverseBounds;var velocityVsBoundingZ=velocityZ*inverseBounds;var absVelocityVsBoundingX=Math.abs(velocityVsBoundingX);var absVelocityVsBoundingZ=Math.abs(velocityVsBoundingZ);if(absVelocityVsBoundingX>1||absVelocityVsBoundingZ>1){var furthestIncrement=absVelocityVsBoundingX>absVelocityVsBoundingZ?absVelocityVsBoundingX:absVelocityVsBoundingZ;var numberOfIncrements=Math.round(furthestIncrement+.5);var inverseNumberOfIncrements=1/numberOfIncrements;var incrementsX=velocityX*inverseNumberOfIncrements;var incrementsZ=velocityZ*inverseNumberOfIncrements;var incrementIndex=0;do{sourceMin[0]+=incrementsX;sourceMin[2]+=incrementsZ;sourceMax[0]+=incrementsX;sourceMax[2]+=incrementsZ;for(i=0;i<numberOfCollideables;++i){checkingObject=areaCollideables[i];
checkingMin=checkingObject.aabbMin;checkingMax=checkingObject.aabbMax;if(BoxCollisionCheckFunction(sourceMin,sourceMax,checkingMin,checkingMax)){if(sourceObject.shouldCollide(checkingObject,true)){collidedWith=checkingObject;if(requestCollisions){collidedWith=sourceObject.requestCollisionWith(collidedWith)}if(collidedWith){return collidedWith}}}}++incrementIndex}while(incrementIndex<numberOfIncrements&&!collidedWith)}else{sourceMin[0]+=velocityX;sourceMin[2]+=velocityZ;sourceMax[0]+=velocityX;sourceMax[2]+=velocityZ;for(i=0;i<numberOfCollideables;++i){checkingObject=areaCollideables[i];checkingMin=checkingObject.aabbMin;checkingMax=checkingObject.aabbMax;if(BoxCollisionCheckFunction(sourceMin,sourceMax,checkingMin,checkingMax)){if(sourceObject.shouldCollide(checkingObject,true)){collidedWith=checkingObject;if(requestCollisions){collidedWith=sourceObject.requestCollisionWith(collidedWith)}if(collidedWith){return collidedWith}}}}}}return null};CC.MovementCollisionReCheckAreaCollideables=function(sourceObject,startPosition,targetPosition,flags,requestCollisions){var areaMin=CC.MovementAreaMin;var areaMax=CC.MovementAreaMax;var startMin=CC.MovementStartMin;var startMax=CC.MovementStartMax;var targetMin=CC.MovementTargetMin;var targetMax=CC.MovementTargetMax;var collisionBounds=sourceObject.collisionBounds;startMin[0]=startPosition[0]-collisionBounds[0];startMax[0]=startPosition[0]+collisionBounds[0];startMin[1]=startPosition[1]-collisionBounds[1];startMax[1]=startPosition[1]+collisionBounds[1];startMin[2]=startPosition[2]-collisionBounds[2];startMax[2]=startPosition[2]+collisionBounds[2];var i,checkingObject,checkingMin,checkingMax;var BoxCollisionCheckFunction=CC.BasicBoxCollisionCheck;var areaCollideables=CC.MovementAreaCollideables;numberOfCollideables=areaCollideables.length;if(numberOfCollideables>0){var sourceMin=startMin;var sourceMax=startMax;var collidedWith=null;var velocityX=targetPosition[0]-startPosition[0];var velocityZ=targetPosition[2]-startPosition[2];var inverseBounds=sourceObject.inverseCollisionSize.width+1;var velocityVsBoundingX=velocityX*inverseBounds;var velocityVsBoundingZ=velocityZ*inverseBounds;var absVelocityVsBoundingX=Math.abs(velocityVsBoundingX);var absVelocityVsBoundingZ=Math.abs(velocityVsBoundingZ);if(absVelocityVsBoundingX>1||absVelocityVsBoundingZ>1){var furthestIncrement=absVelocityVsBoundingX>absVelocityVsBoundingZ?absVelocityVsBoundingX:absVelocityVsBoundingZ;var numberOfIncrements=Math.round(furthestIncrement+.5);var inverseNumberOfIncrements=1/numberOfIncrements;var incrementsX=velocityX*inverseNumberOfIncrements;var incrementsZ=velocityZ*inverseNumberOfIncrements;var incrementIndex=0;do{sourceMin[0]+=incrementsX;sourceMin[2]+=incrementsZ;sourceMax[0]+=incrementsX;sourceMax[2]+=incrementsZ;for(i=0;i<numberOfCollideables;++i){checkingObject=areaCollideables[i];checkingMin=checkingObject.aabbMin;checkingMax=checkingObject.aabbMax;if(BoxCollisionCheckFunction(sourceMin,sourceMax,checkingMin,checkingMax)){if(sourceObject.shouldCollide(checkingObject,true)){collidedWith=checkingObject;if(requestCollisions){collidedWith=sourceObject.requestCollisionWith(collidedWith)}if(collidedWith){return collidedWith}}}}++incrementIndex}while(incrementIndex<numberOfIncrements&&!collidedWith)}else{sourceMin[0]+=velocityX;sourceMin[2]+=velocityZ;sourceMax[0]+=velocityX;sourceMax[2]+=velocityZ;for(i=0;i<numberOfCollideables;++i){checkingObject=areaCollideables[i];checkingMin=checkingObject.aabbMin;checkingMax=checkingObject.aabbMax;if(BoxCollisionCheckFunction(sourceMin,sourceMax,checkingMin,checkingMax)){if(sourceObject.shouldCollide(checkingObject,true)){collidedWith=checkingObject;if(requestCollisions){collidedWith=sourceObject.requestCollisionWith(collidedWith)}if(collidedWith){return collidedWith}}}}}}return null};CC.LineCheckGetIntersection=function(dist1,dist2,vec3Point1,vec3Point2,vec3HitLocation){if(dist1*dist2>=0){return false}if(dist1===dist2){return false}vec3.copy(vec3HitLocation,vec3Point2);vec3.subtract(vec3HitLocation,vec3HitLocation,vec3Point1);vec3.scale(vec3HitLocation,vec3HitLocation,-dist1/(dist2-dist1));vec3.add(vec3HitLocation,vec3HitLocation,vec3Point1);return true};CC.LineCheckInBox=function(hit,boxMin,boxMax,axis){if(axis===1&&hit[2]>=boxMin[2]&&hit[2]<boxMax[2]&&hit[1]>=boxMin[1]&&hit[1]<boxMax[1]){return true}if(axis===2&&hit[2]>=boxMin[2]&&hit[2]<boxMax[2]&&hit[0]>boxMin[0]&&hit[0]<boxMax[0]){return true}if(axis===3&&hit[0]>=boxMin[0]&&hit[0]<boxMax[0]&&hit[1]>=boxMin[1]&&hit[1]<boxMax[1]){return true}return false};CC.LineCheckBox=function(start,end,boxMin,boxMax,hitLocation){if(end[0]<boxMin[0]&&start[0]<boxMin[0]){return false}if(end[0]>boxMax[0]&&start[0]>boxMax[0]){return false}if(end[1]<boxMin[1]&&start[1]<boxMin[1]){return false}if(end[1]>boxMax[1]&&start[1]>boxMax[1]){return false}if(end[2]<boxMin[2]&&start[2]<boxMin[2]){return false}if(end[2]>boxMax[2]&&start[2]>boxMax[2]){return false}if(start[0]>boxMin[0]&&start[0]<boxMax[0]&&start[1]>boxMin[1]&&start[1]<boxMax[1]&&start[2]>boxMin[2]&&start[2]<boxMax[2]){vec3.copy(hitLocation,start);return true}var i;var hits=new Array(6);for(i=0;i<6;++i){hits[i]=vec3.create()}var hitResult=new Array(6);var lineCheckGetIntersection=CC.LineCheckGetIntersection;var lineCheckInBox=CC.LineCheckInBox;hitResult[0]=lineCheckGetIntersection(start[0]-boxMin[0],end[0]-boxMin[0],start,end,hits[0])&&lineCheckInBox(hits[0],boxMin,boxMax,1);hitResult[1]=lineCheckGetIntersection(start[1]-boxMin[1],end[1]-boxMin[1],start,end,hits[1])&&lineCheckInBox(hits[1],boxMin,boxMax,2);hitResult[2]=lineCheckGetIntersection(start[2]-boxMin[2],end[2]-boxMin[2],start,end,hits[2])&&lineCheckInBox(hits[2],boxMin,boxMax,3);hitResult[3]=lineCheckGetIntersection(start[0]-boxMax[0],end[0]-boxMax[0],start,end,hits[3])&&lineCheckInBox(hits[3],boxMin,boxMax,1);hitResult[4]=lineCheckGetIntersection(start[1]-boxMax[1],end[1]-boxMax[1],start,end,hits[4])&&lineCheckInBox(hits[4],boxMin,boxMax,2);hitResult[5]=lineCheckGetIntersection(start[2]-boxMax[2],end[2]-boxMax[2],start,end,hits[5])&&lineCheckInBox(hits[5],boxMin,boxMax,3);var distance=vec3.create();var hitDistance=false;for(i=0;i<6;++i){if(hitResult[i]){vec3.subtract(distance,start,hits[i]);var currentHitDistance=vec3.squaredLength(distance);if(!hitDistance||currentHitDistance<hitDistance){hitDistance=currentHitDistance;vec3.copy(hitLocation,hits[i]);hit=true}}}return hitDistance};CC.BasicLineCollisionCheck=function(list,start,end,hitPosition,collideInsideObjects,flags,ignoreObjects,stopAtAnyCollision,excludeInvisibles){var hitDistance=CC_MAXFLOAT;var hitObject=null;var checkingHitPosition=vec3.create();var length=list.length;for(var i=0;i<length;++i){var checkingObject=list[i];if(ignoreObjects&&ignoreObjects.find(checkingObject)!==-1){continue}if(checkingObject.isActive()&&checkingObject.isCollideable()&&CC.HasFlag(checkingObject.collideableType,flags)){if(!checkingObject.shouldRender&&excludeInvisibles){continue}CC.UpdateCollisions(checkingObject);var targetMin=checkingObject.aabbMin;var targetMax=checkingObject.aabbMax;var checkingHitDistance=CC.LineCheckBox(start,end,targetMin,targetMax,checkingHitPosition);if(checkingHitDistance!==false){if(checkingHitDistance<hitDistance&&(collideInsideObjects||checkingHitDistance>0)){hitDistance=checkingHitDistance;hitObject=checkingObject;if(hitPosition){vec3.copy(hitPosition,checkingHitPosition)}if(stopAtAnyCollision){return hitObject}}}}}return hitObject};CC.CubeInFrustum=function(frustum,min,max){var c;var c2=0;var end=CCCameraBase.frustum_max;for(var i=0;i<end;i+=4){var minX=frustum[i+0]*min[0];var minY=frustum[i+1]*min[1];var minZ=frustum[i+2]*min[2];var maxX=frustum[i+0]*max[0];var maxY=frustum[i+1]*max[1];var maxZ=frustum[i+2]*max[2];c=0;var frustumW=frustum[i+3];if(minX+minY+minZ+frustumW>0){c++}if(maxX+minY+minZ+frustumW>0){c++}if(minX+maxY+minZ+frustumW>0){c++}if(maxX+maxY+minZ+frustumW>0){c++}if(minX+minY+maxZ+frustumW>0){c++}if(maxX+minY+maxZ+frustumW>0){c++}if(minX+maxY+maxZ+frustumW>0){c++}if(maxX+maxY+maxZ+frustumW>0){c++}if(c===0){return 0}else if(c===8){c2++}}return c2===6?2:1};var CC_SMALLFLOAT=.01;var CC_MAXFLOAT=1e9;var CC_PI=Math.PI;var CC_HPI=CC_PI*.5;CC.DEGREES_TO_RADIANS=function(angle){return CC_PI*angle/180};CC.RADIANS_TO_DEGREES=function(angle){return 180*angle/CC_PI};CC.SQUARE=function(value){return value*value};CC.Random=function(amount){if(!amount){amount=1e5}var random=Math.random();var randomInt=Math.round(random*amount);return randomInt};CC.RandomDualInt=function(){return CC.Random(1)*2-1};CC.FloatRandom=function(){var random=Math.random();return random};CC.FloatRandomDualSided=function(){return(CC.FloatRandom()-.5)*2};CC.FloatClamp=function(value,min,max){value=Math.min(max,value);value=Math.max(min,value);return value};CC.FloatLimitPrecision=function(value,precision){if(!precision){precision=2}return value.toFixed?Number(value.toFixed(precision)):value};CC.ToTarget=function(current,target,speed){if(current<target){current+=speed;if(current>target){current=target}}else{current-=speed;if(current<target){current=target}}return current};CC.ToRotation=function(current,target,amount){var incrementRotation=target-current;incrementRotation=CC.ClampRotation(incrementRotation);var decrementRotation=current-target;decrementRotation=CC.ClampRotation(decrementRotation);if(decrementRotation<incrementRotation){if(target>current){target-=360}current-=amount;current=current<target?target:current}else if(decrementRotation>incrementRotation){if(target<current){target+=360}current+=amount;current=current>target?target:current}else{if(target>current){if(target>current){target-=360}current-=amount;current=current<target?target:current}else{if(target<current){target+=360}current+=amount;current=current>target?target:current}}current=CC.ClampRotation(current);return current};CC.Distance=function(first,second){return Math.abs(first-second)};CC.DistanceBetweenAngles=function(first,second){var distance1=first-second;var distance2=second-first;distance1=CC.ClampRotation(distance1);distance2=CC.ClampRotation(distance2);return distance1<distance2?distance1:distance2};CC.ClampRotation=function(rotation){while(rotation>=360){rotation-=360}while(rotation<0){rotation+=360}return rotation};CC.Vector3RotateAboutX=function(rotatedPosition,rotation,from,about){var y=from[1]-about[1];var z=from[2]-about[2];var rotationInRadians=CC.DEGREES_TO_RADIANS(rotation);var cosAngle=Math.cos(rotationInRadians);var sinAngle=Math.sin(rotationInRadians);rotatedPosition[1]=y*cosAngle-z*sinAngle;rotatedPosition[2]=y*sinAngle+z*cosAngle;rotatedPosition[1]+=about[1];rotatedPosition[2]+=about[2]};CC.Vector3RotateY=function(rotatedPosition,rotation){var x=rotatedPosition[0];var z=rotatedPosition[2];var rotationInRadians=CC.DEGREES_TO_RADIANS(rotation);var cosAngle=Math.cos(rotationInRadians);var sinAngle=Math.sin(rotationInRadians);rotatedPosition[0]=x*cosAngle+z*sinAngle;rotatedPosition[2]=-(x*sinAngle)+z*cosAngle};CC.Vector3RotateAboutY=function(rotatedPosition,rotation,from,about){var x=from[0]-about[0];var z=from[2]-about[2];var rotationInRadians=CC.DEGREES_TO_RADIANS(rotation);var cosAngle=Math.cos(rotationInRadians);var sinAngle=Math.sin(rotationInRadians);rotatedPosition[0]=x*cosAngle+z*sinAngle;rotatedPosition[2]=-(x*sinAngle)+z*cosAngle;rotatedPosition[0]+=about[0];rotatedPosition[2]+=about[2]};CC.RotateXAboutY=function(x,z,cosAngle,sinAngle){return x*cosAngle+z*sinAngle};CC.RotateZAboutY=function(x,z,cosAngle,sinAngle){return-(x*sinAngle)+z*cosAngle};CC.RotatePoint=function(point,rotation){var x=point.x;var y=point.y;var rotationInRadians=CC.DEGREES_TO_RADIANS(rotation);var cosAngle=Math.cos(rotationInRadians);var sinAngle=Math.sin(rotationInRadians);point.x=x*cosAngle+y*sinAngle;point.y=-(x*sinAngle)+y*cosAngle};CC.AngleTowards=function(fromX,fromZ,toX,toZ){var y=fromX-toX;var x=fromZ-toZ;var angle=CC.RADIANS_TO_DEGREES(Math.atan2(y,x));angle=CC.ClampRotation(angle);return angle};CC.AngleTowardsVector=function(from,to){return CC.AngleTowards(from[0],from[2],to[0],to[2])};CC.Vector3Magnitude=function(vector,squared){if(squared===undefined){squared=true}if(squared){return vec3.squaredLength(vector)}return vec3.length(vector)};CC.Vector3Distance=function(from,to,squared){if(squared===undefined){squared=true}var difference=vec3.create(to);vec3.subtract(difference,difference,from);vec3.scale(difference,difference,.5);return CC.Vector3Magnitude(difference,squared)};CC.Vector3Distance2D=function(from,to,squared){if(squared===undefined){squared=true}var differenceX=from[0]-to[0];var differenceZ=from[2]-to[2];var result=differenceX*differenceX+differenceZ*differenceZ;return squared?result:Math.sqrt(result)};CC.Vector3Direction=function(start,end){var result=vec3.create();result[0]=end[0]-start[0];result[1]=end[1]-start[1];result[2]=end[2]-start[2];vec3.normalize(result,result);return result};CC.tmpMatrix=mat4.create();CC.MatrixMultiply=function(result,srcA,srcB){var tmp=CC.tmpMatrix;for(var i=0;i<16;i+=4){tmp[i+0]=srcA[i+0]*srcB[0]+srcA[i+1]*srcB[4+0]+srcA[i+2]*srcB[8+0]+srcA[i+3]*srcB[12+0];tmp[i+1]=srcA[i+0]*srcB[1]+srcA[i+1]*srcB[4+1]+srcA[i+2]*srcB[8+1]+srcA[i+3]*srcB[12+1];tmp[i+2]=srcA[i+0]*srcB[2]+srcA[i+1]*srcB[4+2]+srcA[i+2]*srcB[8+2]+srcA[i+3]*srcB[12+2];tmp[i+3]=srcA[i+0]*srcB[3]+srcA[i+1]*srcB[4+3]+srcA[i+2]*srcB[8+3]+srcA[i+3]*srcB[12+3]}mat4.copy(result,tmp)};CC.MatrixRotateDegrees=function(result,angle,x,y,z){angle=-angle;var mag=Math.sqrt(x*x+y*y+z*z);var sinAngle=Math.sin(angle*CC_PI/180);var cosAngle=Math.cos(angle*CC_PI/180);if(mag>0){var xx,yy,zz,xy,yz,zx,xs,ys,zs;var rotMat=mat4.create();x/=mag;y/=mag;z/=mag;xx=x*x;yy=y*y;zz=z*z;xy=x*y;yz=y*z;zx=z*x;xs=x*sinAngle;ys=y*sinAngle;zs=z*sinAngle;var oneMinusCos=1-cosAngle;rotMat[0*4+0]=oneMinusCos*xx+cosAngle;rotMat[0*4+1]=oneMinusCos*xy-zs;rotMat[0*4+2]=oneMinusCos*zx+ys;rotMat[0*4+3]=0;rotMat[1*4+0]=oneMinusCos*xy+zs;rotMat[1*4+1]=oneMinusCos*yy+cosAngle;rotMat[1*4+2]=oneMinusCos*yz-xs;rotMat[1*4+3]=0;rotMat[2*4+0]=oneMinusCos*zx-ys;rotMat[2*4+1]=oneMinusCos*yz+xs;rotMat[2*4+2]=oneMinusCos*zz+cosAngle;rotMat[2*4+3]=0;rotMat[3*4+0]=0;rotMat[3*4+1]=0;rotMat[3*4+2]=0;rotMat[3*4+3]=1;CC.MatrixMultiply(result,rotMat,result)}};CC.CollideablesInFrustum=function(frustum,collideables,visibleCollideables){var CubeInFrustum=CC.CubeInFrustum;var length=collideables.length;for(var i=0;i<length;++i){var object=collideables[i];if(!object.deletingObjectCountdown&&object.shouldRender){if(CubeInFrustum(frustum,object.aabbMin,object.aabbMax)){visibleCollideables.push(object);object.visible=true}}}};CC.ScanVisibleCollideables=function(frustum,collideables,visibleCollideables){visibleCollideables.length=0;CC.CollideablesInFrustum(frustum,collideables,visibleCollideables)};CC.RenderVisibleObjects=function(camera,pass,alpha){var visibleCollideables=camera.visibleCollideables;var length=visibleCollideables.length;for(var i=0;i<length;++i){var object=visibleCollideables[i];if(object&&object.renderPass===pass){var scene=object.inScene;if(scene){scene.renderVisibleObject(object,camera,pass,alpha)}else{}}}};function CCOctree(){}CCOctree.MAX_TREE_OBJECTS=64;CCOctree.leaf_bottom_front_left=0;CCOctree.leaf_bottom_front_right=1;CCOctree.leaf_bottom_back_left=2;CCOctree.leaf_bottom_back_right=3;CCOctree.leaf_top_front_left=4;CCOctree.leaf_top_front_right=5;CCOctree.leaf_top_back_left=6;CCOctree.leaf_top_back_right=7;function CCOctree(inParent,position,size){this.parent=inParent;this.leafs=null;this.objects=[];this.hSize=size*.5;this.min=vec3.clone(position);this.max=vec3.clone(position);vec3.addValue(this.min,-this.hSize);vec3.addValue(this.max,this.hSize)}CCOctree.DeleteLeafs=function(tree){if(tree.leafs){for(var i=0;i<8;++i){if(tree.leafs[i]){var leaf=tree.leafs[i];CCOctree.DeleteLeafs(leaf)}}delete tree.leafs}};CCOctree.SplitTopLeafs=function(tree,index,position){position=vec3.clone(position);position[1]+=tree.hSize;var leaf=new CCOctree(tree,position,tree.hSize);tree.leafs[index+4]=leaf};CCOctree.Split=function(tree){tree.leafs=[];var index=CCOctree.leaf_bottom_front_left;var position=vec3.clone(tree.min);vec3.addValue(position,tree.hSize*.5);var leaf=new CCOctree(tree,position,tree.hSize);tree.leafs[index]=leaf;CCOctree.SplitTopLeafs(tree,index,position);index=CCOctree.leaf_bottom_front_right;position[0]+=tree.hSize;leaf=new CCOctree(tree,position,tree.hSize);tree.leafs[index]=leaf;CCOctree.SplitTopLeafs(tree,index,position);index=CCOctree.leaf_bottom_back_right;position[2]+=tree.hSize;leaf=new CCOctree(tree,position,tree.hSize);tree.leafs[index]=leaf;CCOctree.SplitTopLeafs(tree,index,position);index=CCOctree.leaf_bottom_back_left;position[0]-=tree.hSize;leaf=new CCOctree(tree,position,tree.hSize);tree.leafs[index]=leaf;CCOctree.SplitTopLeafs(tree,index,position);var objects=tree.objects;while(objects.length>0){collideable=tree.objects[0];CCOctree.RemoveObjectsOctree(tree,collideable);CC.UpdateCollisions(collideable);for(var i=0;i<8;++i){leaf=tree.leafs[i];if(CCOctree.IsInLeaf(leaf,collideable.aabbMin,collideable.aabbMax)){CCOctree.AddObject(leaf,collideable)}}}};CCOctree.AddObject=function(tree,collideable){if(!tree.parent){CC.UpdateCollisions(collideable,false);var objectMin=collideable.aabbMin;var objectMax=collideable.aabbMax;if(objectMax[0]<tree.min[0]){tree.objects.push(collideable);collideable.octrees.push(tree);return}if(objectMax[1]<tree.min[1]){tree.objects.push(collideable);collideable.octrees.push(tree);return}if(objectMax[2]<tree.min[2]){tree.objects.push(collideable);collideable.octrees.push(tree);return}if(objectMin[0]>tree.max[0]){tree.objects.push(collideable);collideable.octrees.push(tree);return}if(objectMin[1]>tree.max[1]){tree.objects.push(collideable);collideable.octrees.push(tree);return}if(objectMin[2]>tree.max[2]){tree.objects.push(collideable);collideable.octrees.push(tree);return}}if(tree.leafs){CCOctree.RemoveObjectsOctree(tree,collideable);for(var i=0;i<8;++i){var leaf=tree.leafs[i];if(CCOctree.IsInLeaf(leaf,collideable.aabbMin,collideable.aabbMax)){CCOctree.AddObject(leaf,collideable)}}}else if(tree.objects.length<CCOctree.MAX_TREE_OBJECTS){tree.objects.push(collideable);collideable.octrees.push(tree)}else if(tree.hSize<100){tree.objects.push(collideable);collideable.octrees.push(tree)}else{CCOctree.Split(tree);CCOctree.AddObject(tree,collideable)}};CCOctree.RemoveObjectsOctree=function(tree,collideable){tree.objects.remove(collideable);collideable.octrees.remove(tree)};CCOctree.RemoveObject=function(collideable){var octrees=collideable.octrees;while(octrees.length>0){var tree=octrees[0];CCOctree.RemoveObjectsOctree(tree,collideable);if(tree.objects.length===0){if(gEngine.collisionManager.pruneTreesTimer<=0){gEngine.collisionManager.pruneTreesTimer=.5}}}};CCOctree.RefreshObject=function(object){CCOctree.RemoveObject(object);if(!object.deletingObjectCountdown&&object.shouldRender){CCOctree.AddObject(gEngine.collisionManager.octree,object)}};CCOctree.PruneTree=function(tree){if(tree.leafs){var hasObjects=CCOctree.HasObjects(tree);if(!hasObjects){CCOctree.DeleteLeafs(tree)}else{for(var i=0;i<8;++i){CCOctree.PruneTree(tree.leafs[i])}}}};CCOctree.IsInLeaf=function(leaf,targetMin,targetMax){var sourceMin=leaf.min;var sourceMax=leaf.max;if(sourceMax[1]>=targetMin[1]&&sourceMin[1]<=targetMax[1]){if(sourceMax[0]>=targetMin[0]&&sourceMin[0]<=targetMax[0]){if(sourceMax[2]>=targetMin[2]&&sourceMin[2]<=targetMax[2]){return true}}}return false};CCOctree.HasObjects=function(tree){if(tree.objects.length>0){return true}if(tree.leafs){for(var i=0;i<8;++i){if(CCOctree.HasObjects(tree.leafs[i])){return true}}}return false};CCOctree.Render=function(tree){};CCOctree.ListVisibles=function(leafs,collideables){var leafsLength=leafs.length;for(var leafIndex=0;leafIndex<leafsLength;++leafIndex){var leaf=leafs[leafIndex];var leafObjects=leaf.objects;var leafObjectsLength=leaf.objects.length;for(var i=0;i<leafObjectsLength;++i){var collideable=leafObjects[i];if(!collideable.deletingObjectCountdown&&collideable.shouldRender){if(collideable.shouldRender&&collideable.octreeRender){collideables.addOnce(collideable)}}}}};CCOctree.FillLeafsInFrustum=function(frustum,tree,leafsList){var i;var leafs=tree.leafs;if(leafs){for(i=0;i<8;++i){var leaf=leafs[i];if(!tree.parent||CC.CubeInFrustum(frustum,leaf.min,leaf.max)){CCOctree.FillLeafsInFrustum(frustum,leaf,leafsList)}}}else{leafsList.push(tree)}};CCOctree.VisibleLeafs=[];CCOctree.VisibleCollideables=[];CCOctree.ScanVisibleCollideables=function(frustum,visibleCollideables){var leafs=CCOctree.VisibleLeafs;var octreeCollideables=CCOctree.VisibleCollideables;leafs.length=0;CCOctree.FillLeafsInFrustum(frustum,gEngine.collisionManager.octree,leafs);octreeCollideables.length=0;CCOctree.ListVisibles(leafs,octreeCollideables);visibleCollideables.length=0;CC.CollideablesInFrustum(frustum,octreeCollideables,visibleCollideables);return visibleCollideables};CCOctree.ListCollideables=function(collideables,leafs){var leafsLength=leafs.length;for(var leafIndex=0;leafIndex<leafsLength;++leafIndex){var leaf=leafs[leafIndex];var leafObjects=leaf.objects;var leafObjectsLength=leaf.objects.length;for(var i=0;i<leafObjectsLength;++i){var collideable=leafObjects[i];if(!collideable.deletingObjectCountdown&&collideable.shouldRender){if(!CC.HasFlag(collideable.collideableType,CC.collision_none)){collideables.addOnce(collideable)}}}}};CCOctree.ListLeafs=function(tree,targetMin,targetMax,leafsList){var i;if(tree.leafs){for(i=0;i<8;++i){CCOctree.ListLeafs(tree.leafs[i],targetMin,targetMax,leafsList)}}else if(tree.objects.length>0){var length=leafsList.length;for(i=0;i<length;++i){if(leafsList[i]==tree){return}}if(CCOctree.IsInLeaf(tree,targetMin,targetMax)){leafsList.push(tree)}}};function CCURLRequest(url,postData,callback,priority,cacheFile,cacheFileTimeoutSeconds,timeout,returnBinary){this.url=url;this.postData=postData;this.callback=callback;this.priority=priority;this.cacheFile=cacheFile;this.cacheFileTimeoutSeconds=cacheFileTimeoutSeconds;this.timeout=timeout;this.timeRequestable=window.gEngine?gEngine.lifetime+timeout:0;this.returnBinary=returnBinary}CCURLRequest.Not_Started=1;CCURLRequest.In_Flight=2;CCURLRequest.Failed=3;CCURLRequest.Timed_Out=4;CCURLRequest.Data_Error=5;CCURLRequest.Succeeded=6;CCURLRequest.Used_Cache=7;CCURLRequest.Failed_But_Used_Cache=8;function CCURLManager(){this.requests=[]}window.gURLManager=null;CCURLManager.prototype.findRequest=function(url,cacheFile){var requests=this.requests;for(var i=0;i<requests.length;++i){var request=requests[i];if(!request.checkingCache){if(request.url===url){if(request.cacheFile==cacheFile){if(request.cacheFileTimeoutSeconds===-1&&request.timeout===0){return request}}}}}return null};vec3.isZero=function(a){return a[0]===0&&a[1]===0&&a[2]===0};vec3.equals=function(a,b){return a[0]===b[0]&&a[1]===b[1]&&a[2]===b[2]};vec3.distance=function(from,to,squared){var difference=vec3.clone(to);vec3.subtract(difference,difference,from);vec3.scale(difference,difference,.5);if(squared){return vec3.squaredLength(difference)}return vec3.length(difference)};vec3.unitize=function(vec){var absX=Math.abs(vec[0]);var absY=Math.abs(vec[1]);var absZ=Math.abs(vec[2]);var dividedBy=1;if(absX>absY){if(absX>absZ){dividedBy=1/absX}else{dividedBy=1/absZ}}else if(absY>absZ){dividedBy=1/absY}else{dividedBy=1/absZ}vec[0]*=dividedBy;vec[1]*=dividedBy;vec[2]*=dividedBy;return vec};vec3.fromString=function(string){var vector=vec3.create();var split=string.split(",");if(split.length>0){vector[0]=parseFloat(split[0])}if(split.length>1){vector[1]=parseFloat(split[1])}if(split.length>2){vector[2]=parseFloat(split[2])}return vector};vec3.toString=function(vector){var string="";string+=vector[0];string+=",";string+=vector[1];string+=",";string+=vector[2];return string};vec3.addValue=function(vector,value){vec3.add(vector,vector,[value,value,value])};mat4.multiplyVec4=function(mat,vec,dest){if(!dest){dest=vec}var x=vec[0],y=vec[1],z=vec[2],w=vec[3];dest[0]=mat[0]*x+mat[4]*y+mat[8]*z+mat[12]*w;dest[1]=mat[1]*x+mat[5]*y+mat[9]*z+mat[13]*w;dest[2]=mat[2]*x+mat[6]*y+mat[10]*z+mat[14]*w;dest[3]=mat[3]*x+mat[7]*y+mat[11]*z+mat[15]*w;return dest};function CCSize(width,height){this.width=this.height=0;if(width){this.width=width}if(height){this.height=height}}function CCPoint(x,y){if(!x){x=0}if(!y){y=x}this.x=x;this.y=y}function CCMinMax(){this.reset()}CCMinMax.prototype.reset=function(){this.min=CC_MAXFLOAT;this.max=-CC_MAXFLOAT};CCMinMax.prototype.consider=function(value){this.min=Math.min(this.min,value);this.max=Math.max(this.max,value)};CCMinMax.prototype.size=function(){return this.max-this.min};function CCColour(r,g,b,a){if(r!==undefined){if(g!==undefined&&b!==undefined){this.setRGBA(r,g,b,a)}else{this.set(r,g)}}else{this.white()}}CCColour.prototype.equals=function(colour){return this.r===colour.r&&this.g===colour.g&&this.b===colour.b&this.a===colour.a};CCColour.prototype.white=function(){this.setRGBA(1,1,1,1);return this};CCColour.prototype.set=function(colour,alpha){if(typeof colour==="number"){this.setRGBA(colour,colour,colour,alpha)}else{this.setRGBA(colour.r,colour.g,colour.b,colour.a)}return this};CCColour.prototype.setRGBA=function(r,g,b,a){if(a===undefined){a=1}this.r=r;this.g=g;this.b=b;this.a=a;return this};CCColour.prototype.setInt=function(r,g,b,a){if(b===undefined){a=g;b=r;g=r}if(a===undefined){a=1}var multiple=1/255;this.setRGBA(r*multiple,g*multiple,b*multiple,a);return this};CCColour.prototype.toString=function(){var string="";string+=this.r;string+=",";string+=this.g;string+=",";string+=this.b;string+=",";string+=this.a;return string};CCColour.prototype.fromString=function(string){if(string&&string.length>0){var colourSplit=string.split(",");if(colourSplit.length>0){if(colourSplit[0].length>0){this.r=CC.FloatClamp(parseFloat(colourSplit[0]),0,1)}}if(colourSplit.length>1){if(colourSplit[1].length>0){this.g=CC.FloatClamp(parseFloat(colourSplit[1]),0,1)}}if(colourSplit.length>2){if(colourSplit[2].length>0){this.b=CC.FloatClamp(parseFloat(colourSplit[2]),0,1)}}if(colourSplit.length>3){if(colourSplit[3].length>0){this.a=CC.FloatClamp(parseFloat(colourSplit[3]),0,1)}}}return this};var gColour=new CCColour;function CCVector3Target(){this.current=vec3.create();this.target=vec3.create()}CCVector3Target.prototype.equals=function(){return vec3.equals(this.current,this.target)};function CCControls(){this.touches=[];this.touches.push(new CCTouch);this.touches.push(new CCTouch);this.keys=[];this.onKeyboardCallbacks=[];this.onDragDrop=[];this.onDragDropLoad=[]}CCControls.touch_pressed=1;CCControls.touch_movingHorizontal=2;CCControls.touch_movingVertical=3;CCControls.touch_moving=4;CCControls.touch_released=5;CCControls.touch_lost=6;CCControls.twotouch_unassigned=7;CCControls.twotouch_zooming=8;CCControls.twotouch_rotating=9;CCControls.TouchMovementThreashold=new CCPoint(.00125125);CCControls.DOUBLE_TAP_THRESHOLD=.2;CCControls.max_last_deltas=50;function CCTouch(){this.rawX=0;this.rawY=0;this.x=0;this.y=0;this.startX=0;this.startY=0;this.deltaX=0;this.deltaY=0;this.totalDeltaX=0;this.totalDeltaY=0;this.timeHeld=0;this.lastTimeReleased=0;this.state=CCControls.touch_released;this.usingTouch=false;var lastDeltas=this.lastDeltas=new Array(CCControls.max_last_deltas);for(var i=0;i<lastDeltas.length;++i){var lastDelta={};lastDelta.time=0;lastDelta.delta=new CCPoint;lastDeltas[i]=lastDelta}}CCTouch.prototype.averageLastDeltas=function(){if(!this.averageDeltas){this.averageDeltas=new CCPoint}var averageDeltas=this.averageDeltas;var numberOfDeltas=0;var lifetime=gEngine.lifetime;var lastDeltas=this.lastDeltas;for(var i=0;i<lastDeltas.length;++i){var lastDelta=lastDeltas[i];var difference=lifetime-lastDelta.time;if(difference<.25){averageDeltas.x+=lastDelta.delta.x;averageDeltas.y+=lastDelta.delta.y;numberOfDeltas++}else{break}}if(numberOfDeltas>1){averageDeltas.x/=numberOfDeltas;averageDeltas.y/=numberOfDeltas}return averageDeltas};CCControls.prototype.update=function(delta){var updatedTouchState=false;var touches=this.touches;for(var i=0;i<touches.length;++i){var touch=touches[i];if(touch.touchMovingState){updatedTouchState=true;this.updateTouch(touch,touch.touchMovingState);touch.touchMovingState=false}if(touch.state<CCControls.touch_released){touch.timeHeld+=delta;var lastDeltas=touch.lastDeltas;for(var lastDeltaIndex=lastDeltas.length-1;lastDeltaIndex>0;--lastDeltaIndex){var prev=lastDeltas[lastDeltaIndex-1];var next=lastDeltas[lastDeltaIndex];next.time=prev.time;next.delta.x=prev.delta.x;next.delta.y=prev.delta.y}lastDeltas[0].time=gEngine.lifetime;lastDeltas[0].delta.x=touch.deltaX;lastDeltas[0].delta.y=touch.deltaY}else{touch.lastTimeReleased+=delta}}if(updatedTouchState){gEngine.updateControls()}};CCControls.prototype.updateTouchXY=function(touch,state,x,y){if(touch.state<CCControls.touch_released){var deltaX=touch.deltaX=x-touch.x;var deltaY=touch.deltaY=y-touch.y;touch.x=x;touch.y=y;touch.totalDeltaX+=deltaX;if(deltaY!==0){touch.totalDeltaY+=deltaY}}else{touch.timeHeld=0;touch.x=x;touch.y=y;touch.startX=x;touch.startY=y;touch.deltaX=0;touch.deltaY=0;touch.totalDeltaX=0;touch.totalDeltaY=0;touch.lastTimeReleased=0}touch.state=state;touch.usingTouch=state<CCControls.touch_released};CCControls.TouchActionMoving=function(touchAction){if(touchAction>=CCControls.touch_movingHorizontal&&touchAction<=CCControls.touch_moving){return true}return false};CCControls.TouchSetMovementThreashold=function(x,y){CCControls.TouchMovementThreashold.x=x;CCControls.TouchMovementThreashold.y=y};CCControls.prototype.onPause=function(){for(var i=0;i<this.keys.length;++i){if(this.keys[i]){this.keys[i]=false}}};function CCRenderable(){this.construct()}CCRenderable.NextID=0;CCRenderable.prototype.construct=function(){this.jsID=CCRenderable.NextID++;this.modelMatrix=mat4.create();this.position=vec3.create();this.rotation=vec3.create();this.scale=vec3.clone([1,1,1]);this.colour=null;this.shouldRender=true;this.dirtyModelMatrix()};CCRenderable.prototype.destruct=function(){};CCRenderable.prototype.dirtyModelMatrix=function(){gRenderer.pendingRender=true;this.updateModelMatrix=true};CCRenderable.prototype.refreshModelMatrix=function(){if(this.updateModelMatrix){this.updateModelMatrix=false;CCRenderer.ModelMatrixIdentity(this);CCRenderer.ModelMatrixTranslate(this,this.position);CCRenderer.ModelMatrixScale(this,this.scale);var rotation=this.rotation;CCRenderer.ModelMatrixRotate(this,rotation[0],[1,0,0]);CCRenderer.ModelMatrixRotate(this,rotation[1],[0,1,0]);CCRenderer.ModelMatrixRotate(this,rotation[2],[0,0,1])}};CCRenderable.prototype.setPosition=function(vector){this.setPositionXYZ(vector[0],vector[1],vector[2])};CCRenderable.prototype.setPositionXYZ=function(x,y,z){var position=this.position;position[0]=x;position[1]=y;position[2]=z;this.dirtyModelMatrix();if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCRenderable.setPositionXYZ;"+this.jsID+";"+position[0]+";"+position[1]+";"+position[2]+"\n"}};CCRenderable.prototype.setPositionX=function(x){this.setPositionXYZ(x,this.position[1],this.position[2])};CCRenderable.prototype.setPositionY=function(y){this.setPositionXYZ(this.position[0],y,this.position[2])};CCRenderable.prototype.setPositionZ=function(z){this.setPositionXYZ(this.position[0],this.position[1],z)};CCRenderable.prototype.setPositionXY=function(x,y){this.setPositionXYZ(x,y,this.position[2])};CCRenderable.prototype.setPositionXZ=function(x,z){this.setPositionXYZ(x,this.position[1],z)};CCRenderable.prototype.setPositionYZ=function(y,z){this.setPositionXYZ(this.position[0],y,z)};CCRenderable.prototype.translate=function(x,y,z){if(y===undefined){y=0}if(z===undefined){z=0}var position=this.position;position[0]+=x;position[1]+=y;position[2]+=z;this.dirtyModelMatrix();if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCRenderable.setPositionXYZ;"+this.jsID+";"+position[0]+";"+position[1]+";"+position[2]+"\n"}};CCRenderable.prototype.rotationUpdated=function(){this.dirtyModelMatrix();if(CCEngine.NativeUpdateCommands!==undefined){var rotation=this.rotation;CCEngine.NativeUpdateCommands+="CCRenderable.setRotationXYZ;"+this.jsID+";"+rotation[0]+";"+rotation[1]+";"+rotation[2]+"\n"
}};CCRenderable.prototype.setRotation=function(rotationVector){this.rotation[0]=rotationVector[0];this.rotation[1]=rotationVector[1];this.rotation[2]=rotationVector[2];this.rotationUpdated()};CCRenderable.prototype.setRotationX=function(x){this.rotation[0]=x;this.rotationUpdated()};CCRenderable.prototype.setRotationY=function(y){this.rotation[1]=y;this.rotationUpdated()};CCRenderable.prototype.setRotationZ=function(z){this.rotation[2]=z;this.rotationUpdated()};CCRenderable.prototype.rotateX=function(x){this.rotation[0]+=x;this.rotation[0]=CC.ClampRotation(this.rotation[0]);this.rotationUpdated()};CCRenderable.prototype.rotateY=function(y){this.rotation[1]+=y;this.rotation[1]=CC.ClampRotation(this.rotation[1]);this.rotationUpdated()};CCRenderable.prototype.rotateZ=function(z){this.rotation[2]+=z;this.rotation[2]=CC.ClampRotation(this.rotation[2]);this.rotationUpdated()};CCRenderable.prototype.setScale=function(inScale){var scale=this.scale;if(typeof inScale==="number"){vec3.copy(this.scale,[inScale,inScale,inScale])}else{vec3.copy(this.scale,inScale)}this.dirtyModelMatrix();if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCRenderable.setScale;"+this.jsID+";"+scale[0]+";"+scale[1]+";"+scale[2]+"\n"}};CCRenderable.prototype.getColour=function(){if(this.colour){return this.colour}return null};function CCObject(){this.construct()}ExtendPrototype(CCObject,CCRenderable);CCObject.prototype.construct=function(){this.CCRenderable_construct();this.deletingObjectCountdown=0;this.parent=null;this.model=null;this.renderPass=CCRenderer.render_main;this.readDepth=true;this.writeDepth=true;this.disableCulling=false;this.transparent=false;this.colourInterpolator=null;if(CCEngine.NativeUpdateCommands!==undefined){this.nativeConstruct()}};CCObject.prototype.nativeConstruct=function(){CCEngine.NativeUpdateCommands+="CCObject.construct;"+this.jsID+"\n"};CCObject.prototype.destruct=function(){if(this.inScene){this.removeFromScene()}else if(this.noScene){}else if(!this.parent){alert(false)}else{this.parent.removeChild(this)}var i;var updaters=this.updaters;if(updaters){var updatersLength=updaters.length;for(i=0;i<updatersLength;++i){var updater=updaters[i];if(updater.destruct){updater.destruct()}}updaters.length=0}var children=this.children;if(children){var childrenLength=children.length;for(i=0;i<children.length;++i){var child=children[i];child.destruct();if(childrenLength!==children.length){childrenLength=children.length;--i}}delete this.children}if(this.model){this.model.destruct()}this.CCRenderable_destruct();if(CCEngine.NativeUpdateCommands!==undefined){this.nativeDestruct()}};CCObject.prototype.nativeDestruct=function(){CCEngine.NativeUpdateCommands+="CCObject.destruct;"+this.jsID+"\n"};CCObject.prototype.deleteLater=function(){this.deletingObjectCountdown=2;this.deactivate()};CCObject.prototype.setScene=function(scene){scene.addObject(this)};CCObject.prototype.removeFromScene=function(){this.deactivate();this.inScene.removeObject(this)};CCObject.prototype.isActive=function(){return this.deletingObjectCountdown===0};CCObject.prototype.deactivate=function(){};CCObject.prototype.addChild=function(object,preRender,index){if(!this.children){this.children=[]}this.children.push(object);if(index!==undefined){this.children.insert(object,index)}object.parent=this;if(preRender){object.preRender=true}};CCObject.prototype.removeChild=function(object){if(this.children&&this.children.remove(object)){if(this.children.length===0){delete this.children}return true}return false};CCObject.prototype.addUpdater=function(updater){if(!this.updaters){this.updaters=[]}this.updaters.push(updater)};CCObject.prototype.removeUpdater=function(updater){this.updaters.remove(updater);if(this.updaters.length===0){delete this.updaters}};CCObject.prototype.shouldCollide=function(collideWith,initialCall){if(this===collideWith){return false}if(this.parent){return this.parent.shouldCollide(collideWith,initialCall)}return true};CCObject.prototype.update=function(delta){var updated=false;var i;{var updaters=this.updaters;if(updaters){var updatersLength=updaters.length;for(i=0;i<updatersLength;++i){if(updaters[i].updating){updated|=updaters[i].update(delta)}}}}{var children=this.children;if(children){var childrenLength=children.length;for(i=0;i<childrenLength;++i){updated|=children[i].update(delta)}}}if(this.colourInterpolator){if(this.colourInterpolator.updating){updated|=this.colourInterpolator.update(delta);gRenderer.pendingRender=true}else{delete this.colourInterpolator}}return updated};CCObject.prototype.renderObject=function(camera,alpha){if(this.shouldRender&&!this.loading){var children=this.children;var i;var childrenLength=0;if(children){childrenLength=children.length}if(alpha===this.transparent||childrenLength>0){CCRenderer.GLPushMatrix();{if(this.updateModelMatrix){this.refreshModelMatrix()}CCRenderer.ModelMatrixMultiply(this);for(i=0;i<childrenLength;++i){if(children[i].preRender){children[i].renderObject(camera,alpha)}}if(alpha===this.transparent){if(this.colour){gRenderer.CCSetColour(this.colour)}this.renderModel(alpha)}for(i=0;i<childrenLength;++i){if(!children[i].preRender){children[i].renderObject(camera,alpha)}}}CCRenderer.GLPopMatrix()}}};CCObject.prototype.renderModel=function(alpha){var model=this.model;if(model){var renderer=gRenderer;if(CCEngine.NativeRenderCommands!==undefined){renderer.unbindBuffers();CCEngine.NativeRenderCommands+="CCObject.renderModel;"+this.jsID+";"+alpha+"\n"}else{if(this.disableCulling){renderer.CCSetCulling(false)}if(alpha){if(this.readDepth){renderer.CCSetDepthRead(true);if(this.writeDepth){renderer.CCSetDepthWrite(true);model.render(alpha);renderer.CCSetDepthWrite(false)}else{model.render(alpha)}renderer.CCSetDepthRead(false)}else{model.render(alpha)}}else{if(this.readDepth){if(this.writeDepth){model.render(alpha)}else{renderer.CCSetDepthWrite(false);model.render(alpha);renderer.CCSetDepthWrite(true)}}else{renderer.CCSetDepthRead(false);model.render(alpha);renderer.CCSetDepthRead(true)}}if(this.disableCulling){renderer.CCSetCulling(true)}}}};CCObject.prototype.isTransparent=function(){return this.transparent};CCObject.prototype.setTransparent=function(toggle){if(toggle===undefined){toggle=true}this.transparent=toggle};CCObject.prototype.getColourInterpolator=function(){if(!this.colourInterpolator){this.colourInterpolator=new CCInterpolatorColour;if(this.colour){this.colourInterpolator.setup(this.colour,this.colour)}}return this.colourInterpolator};CCObject.prototype.setColour=function(inColour,interpolate,inCallback){if(typeof inColour==="number"){inColour=gColour.setRGBA(inColour,inColour,inColour,1)}if(!this.colour){this.colour=new CCColour}if(interpolate){this.getColourInterpolator().setup(this.colour,inColour)}else{this.colour.set(inColour);if(this.colourInterpolator){this.colourInterpolator.setup(this.colour)}}};CCObject.prototype.setColourAlpha=function(inAlpha,interpolate,inCallback){if(!this.colour){this.colour=new CCColour}if(interpolate){this.getColourInterpolator().setTargetAlpha(inAlpha,inCallback)}else{this.colour.a=inAlpha;if(this.colourInterpolator){this.colourInterpolator.finish();this.colourInterpolator.setup(this.colour)}}};CCObject.prototype.setModel=function(model){this.model=model;if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCObject.setModel;"+this.jsID+";"+model.jsID+"\n"}return model};CCObject.prototype.setReadDepth=function(toggle){this.readDepth=toggle;if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCObject.setReadDepth;"+this.jsID+";"+toggle+"\n"}};CCObject.prototype.setWriteDepth=function(toggle){this.writeDepth=toggle;if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCObject.setWriteDepth;"+this.jsID+";"+toggle+"\n"}};CCObject.prototype.setCulling=function(toggle){this.disableCulling=!toggle;if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCObject.setCulling;"+this.jsID+";"+toggle+"\n"}};function CCCollideable(objectID){this.construct(objectID)}ExtendPrototype(CCCollideable,CCObject);CCCollideable.prototype.construct=function(objectID){this.CCObject_construct();this.drawOrder=100;this.collisionsEnabled=true;this.octreeRender=true;this.aabbMin=vec3.create();this.aabbMax=vec3.create();this.collideableType=CC.collision_none;this.collisionBounds=vec3.create();this.collisionSize=new CCSize;this.inverseCollisionSize=new CCSize;this.setCollisionBounds(1,1,1);this.octrees=[];this.visible=false;this.owner=null;this.owns=[];if(objectID){this.objectID=objectID}};CCCollideable.prototype.nativeConstruct=function(){CCEngine.NativeSyncCommands+="CCCollideable.construct;"+this.jsID+"\n"};CCCollideable.prototype.nativeDestruct=function(){CCEngine.NativeUpdateCommands+="CCCollideable.destruct;"+this.jsID+"\n"};CCCollideable.prototype.setPositionXYZ=function(x,y,z){this.CCObject_setPositionXYZ(x,y,z);if(this.collideableType!==CC.collision_none){this.updateCollisions=true;CCOctree.RefreshObject(this)}};CCCollideable.prototype.translate=function(x,y,z){this.CCObject_translate(x,y,z);if(this.collideableType!==CC.collision_none){this.updateCollisions=true;CCOctree.RefreshObject(this)}};CCCollideable.prototype.setScene=function(scene){this.CCObject_setScene(scene);this.collideableType=CC.AddFlag(this.collideableType,CC.collision_box);scene.addCollideable(this)};CCCollideable.prototype.removeFromScene=function(){this.inScene.removeCollideable(this);this.CCObject_removeFromScene()};CCCollideable.prototype.deactivate=function(){this.CCObject_deactivate();this.collideableType=CC.collision_none;CCOctree.RemoveObject(this);if(this.owner){this.owner.unOwnObject(this);this.owner=null}for(var i=0;i<this.owns.length;++i){this.owns[i].removeOwner(this)}this.owns.length=0};CCCollideable.prototype.shouldCollide=function(collideWith,initialCall){if(!this.CCObject_shouldCollide(collideWith,initialCall)){return false}if(this.owner&&this.owner!==this.parent){if(!this.owner.shouldCollide(collideWith,initialCall)){return false}}if(initialCall){return collideWith.shouldCollide(this,false)}return true};CCCollideable.prototype.setDrawOrder=function(drawOrder){this.drawOrder=drawOrder;if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCCollideable.setDrawOrder;"+this.jsID+";"+drawOrder+"\n"}};CCCollideable.prototype.renderModel=function(alpha){this.CCObject_renderModel(alpha);var renderer=gRenderer;if(alpha===this.transparent&&renderer.renderFlags&CCRenderer.render_collisionBoxes&&CC.HasFlag(this.collideableType,CC.collision_box)){if(!this.transparent){renderer.CCSetBlend(true)}this.renderCollisionBox();if(!this.transparent){renderer.CCSetBlend(false)}}};CCCollideable.prototype.renderCollisionBox=function(){var renderer=gRenderer;CCRenderer.GLPushMatrix();{var scale=this.scale;var collisionBounds=this.collisionBounds;CCRenderer.GLScale([1/scale[0],1/scale[1],1/scale[2]]);CCRenderer.GLScale([collisionBounds[0]*2,collisionBounds[1]*2,collisionBounds[2]*2]);gEngine.textureManager.setTextureIndex(1);var red=gColour.setRGBA(1,0,0,.5);CCRenderer.GLRotate(-this.rotation[1],[0,1,0]);renderer.CCSetColour(red);renderer.CCRenderCube(true)}CCRenderer.GLPopMatrix()};CCCollideable.prototype.getType=function(){return null};CCCollideable.prototype.getID=function(){return this.objectID};CCCollideable.prototype.setSquareCollisionBounds=function(width,height){if(!height){height=width}this.setCollisionBounds(width,height,width)};CCCollideable.prototype.setCollisionBounds=function(width,height,depth){this.setHCollisionBounds(width*.5,height*.5,depth*.5)};CCCollideable.prototype.setHCollisionBounds=function(hWidth,hHeight,hDepth){vec3.copy(this.collisionBounds,[hWidth,hHeight,hDepth]);var collisionSize=this.collisionSize;collisionSize.width=hWidth>hDepth?hWidth:hDepth;collisionSize.width*=2;collisionSize.height=hHeight*2;this.inverseCollisionSize.width=1/(hWidth>hDepth?hWidth:hDepth);this.inverseCollisionSize.width=1/this.collisionBounds[1];this.updateCollisions=true};CCCollideable.prototype.requestCollisionWith=function(collidedWith){return collidedWith.recieveCollisionFrom(this,0,0,0)};CCCollideable.prototype.recieveCollisionFrom=function(collisionSource,x,y,z){return this};CCCollideable.prototype.reportAttack=function(attackedBy,attackType,force,damage,x,y,z){return false};CCCollideable.prototype.isCollideable=function(){return this.collisionsEnabled};CCCollideable.prototype.setCollideable=function(toggle){this.collisionsEnabled=toggle};CCCollideable.prototype.isMoveable=function(){return false};CCCollideable.prototype.ownObject=function(object){this.owns.add(object);object.setOwner(this)};CCCollideable.prototype.unOwnObject=function(object){var owns=this.owns;if(owns.remove(object)){}};CCCollideable.prototype.setOwner=function(newOwner){this.owner=newOwner};CCCollideable.prototype.removeOwner=function(currentOwner){if(currentOwner===this.owner){this.owner=null}};CCCollideable.prototype.createMovementInterpolator=function(updateCollisions){if(!this.movementInterpolator){this.movementInterpolator=new CCMovementInterpolator(this,updateCollisions)}};CCCollideable.prototype.getMovementInterpolator=function(){return this.movementInterpolator};function CCCollideableStaticMesh(objectID){this.construct(objectID)}ExtendPrototype(CCCollideableStaticMesh,CCCollideable);CCCollideableStaticMesh.prototype.construct=function(objectID){this.CCCollideable_construct(objectID);this.createMovementInterpolator(false);this.getMovementInterpolator().setDuration(2);this.setModel(new CCModelBase);this.collideableType=CC.AddFlag(this.collideableType,CC.collision_static);this.model3d=null;this.setColour(gColour.set(1,0));this.setColourAlpha(.25,true)};CCCollideableStaticMesh.prototype.destruct=function(){this.CCCollideable_destruct()};CCCollideableStaticMesh.prototype.requestCollisionWith=function(collidedWith){return this.CCCollideable_requestCollisionWith(collidedWith)};CCCollideableStaticMesh.prototype.recieveCollisionFrom=function(collisionSource,x,y,z){return this.CCCollideable_recieveCollisionFrom(collisionSource,x,y,z)};CCCollideableStaticMesh.prototype.update=function(delta){this.CCCollideable_update(delta);if(this.model3d){this.model3d.animate(delta)}};CCCollideableStaticMesh.prototype.renderModel=function(alpha){if(this.model3d){this.CCCollideable_renderModel(alpha)}else if(alpha){if(!this.disableCulling){gRenderer.CCSetCulling(false)}if(!this.readDepth){gRenderer.CCSetDepthRead(true)}CCRenderer.GLPushMatrix();gRenderer.CCSetColour(this.colour);gEngine.textureManager.setTextureIndex(1);var size=this.collisionSize.width;CCRenderer.GLScale([size,size,size]);gRenderer.CCRenderCube(false);CCRenderer.GLPopMatrix();if(!this.readDepth){gRenderer.CCSetDepthRead(false)}if(!this.disableCulling){gRenderer.CCSetCulling(true)}}};CCCollideableStaticMesh.prototype.setupModel=function(obj,tex,width,callback){if(width){this.setCollisionBounds(width,width,width);this.setPositionY(this.collisionBounds[1])}this.obj=obj;this.tex=tex;this.loadModel(obj,tex,callback)};CCCollideableStaticMesh.prototype.loadModel=function(obj,tex,callback){if(tex){gEngine.textureManager.getTextureHandle(tex)}var self=this;CCModel3D.CacheModel(obj,true,function(model3d){if(model3d){self.model3d=model3d;self.setColourAlpha(1,true);while(self.model.models.length>0){var model=self.model.models[0];self.model.removeModel(model);model.destruct()}self.model.addModel(model3d);self.resize(self.collisionSize.width);self.setPositionY(0);self.getMovementInterpolator().setMovementY(self.collisionBounds[1]);if(tex){self.setTexture(model3d,tex)}if(callback){callback(self)}}},1)};CCCollideableStaticMesh.prototype.resize=function(size){this.setCollisionBounds(size,size,size);this.setPositionY(this.collisionBounds[1]);CC.UpdateCollisions(this);if(this.model3d){var model3d=this.model3d;var modelWidth=model3d.getWidth()>model3d.getDepth()?model3d.getWidth():model3d.getDepth();var modelHeight=model3d.getHeight();var scaleFactor=size/modelWidth;this.model.setScale(scaleFactor);model3d.setPositionY(-size*.5/scaleFactor);model3d.translate(0,modelHeight*.5,0)}};CCCollideableStaticMesh.prototype.setTexture=function(model3d,tex){if(tex){model3d.setTexture(tex)}};function CCMoveable(){this.construct()}ExtendPrototype(CCMoveable,CCCollideable);CCMoveable.gravityForce=200;CCMoveable.prototype.construct=function(){this.CCCollideable_construct();this.collideableType=CC.AddFlag(this.collideableType,CC.collision_moveable);this.moveable=true;this.movementSpeed=75;this.decelerationSpeed=this.movementSpeed*2;this.movementDirection=vec3.create();this.velocity=vec3.create();this.movementVelocity=vec3.create();this.additionalVelocity=vec3.create();this.gravity=true};CCMoveable.prototype.destruct=function(){this.CCCollideable_destruct()};CCMoveable.prototype.update=function(delta){this.CCCollideable_update(delta);this.updateMovement(delta);return true};CCMoveable.prototype.requestCollisionWith=function(collidedWith){var velocity=this.velocity;return collidedWith.recieveCollisionFrom(this,velocity[0],velocity[1],velocity[2])};CCMoveable.prototype.isMoveable=function(){return true};CCMoveable.prototype.updateMovement=function(delta){if(this.moveable){var movementMagnitude=this.applyMovementDirection(delta);var velocity=this.velocity;var additionalVelocity=this.additionalVelocity;vec3.copy(velocity,this.movementVelocity);var additionalMagnitude=vec3.squaredLength(additionalVelocity);if(additionalMagnitude>0){vec3.add(velocity,velocity,additionalVelocity);var deceleration=this.decelerationSpeed*delta;additionalVelocity[0]=CC.ToTarget(additionalVelocity[0],0,deceleration);additionalVelocity[1]=CC.ToTarget(additionalVelocity[1],0,deceleration);additionalVelocity[2]=CC.ToTarget(additionalVelocity[2],0,deceleration)}var velocityMagnitude=vec3.squaredLength(velocity);if(velocityMagnitude>0){this.applyVelocity(delta,movementMagnitude);this.dirtyModelMatrix();this.updateCollisions=true;CCOctree.RefreshObject(this)}}};CCMoveable.prototype.applyMovementDirection=function(delta){var movementDirection=this.movementDirection;var rotation=this.rotation;var movementVelocity=this.movementVelocity;var movementMagnitude=vec3.squaredLength(movementDirection);if(movementMagnitude>0){var forwardSpeed=this.movementSpeed;var zMovementSpeed=movementDirection[2]*forwardSpeed;var rotationInRadians=CC.DEGREES_TO_RADIANS(rotation[1]);var xAmount=Math.sin(rotationInRadians)*zMovementSpeed;var zAmount=Math.cos(rotationInRadians)*zMovementSpeed;if(movementDirection[0]!==0){var xMovementSpeed=movementDirection[0]*movementSpeed;rotationInRadians=CC.DEGREES_TO_RADIANS(rotation[1]+90);xAmount+=Math.sin(rotationInRadians)*xMovementSpeed;zAmount+=Math.cos(rotationInRadians)*xMovementSpeed}movementVelocity[0]=xAmount;movementVelocity[2]=zAmount}else{movementVelocity[0]=0;movementVelocity[2]=0}return movementMagnitude};CCMoveable.prototype.applyVelocity=function(delta,movementMagnitude){var velocity=this.velocity;var movementVelocity=this.movementVelocity;var velocityX=velocity[0]*delta;var velocityZ=velocity[2]*delta;if(velocityX!==0||velocityZ!==0){this.applyHorizontalVelocity(velocityX,velocityZ);if(movementMagnitude===0){var movementDeceleration=this.decelerationSpeed*delta;movementVelocity[0]=CC.ToTarget(movementVelocity[0],0,movementDeceleration);movementVelocity[2]=CC.ToTarget(movementVelocity[2],0,movementDeceleration)}}if(this.gravity){var collidedWith=null;movementVelocity[1]-=CCMoveable.gravityForce*delta;var velocityY=velocity[1]*delta;if(velocityY>0){collidedWith=this.applyVerticalVelocity(velocityY)}else{collidedWith=this.applyVerticalVelocity(velocityY)}this.reportVerticalCollision(collidedWith);if(!collidedWith&&movementVelocity[1]===0){movementVelocity[1]=CC_SMALLFLOAT}}};CCMoveable.prototype.getCollisionPosition=function(thisObjectPosition,thisObjectBounds,collidedObjectPosition,collidedObjectBounds){var collisionPosition=collidedObjectPosition;if(collisionPosition<thisObjectPosition){collisionPosition+=collidedObjectBounds;collisionPosition+=thisObjectBounds;collisionPosition+=CC_SMALLFLOAT;if(collisionPosition>thisObjectPosition){collisionPosition=thisObjectPosition}}else{collisionPosition-=collidedObjectBounds;collisionPosition-=thisObjectBounds;collisionPosition-=CC_SMALLFLOAT;if(collisionPosition<thisObjectPosition){collisionPosition=thisObjectPosition}}return collisionPosition};CCMoveable.HorizontalVelocityStartPosition=vec3.create();CCMoveable.prototype.applyHorizontalVelocity=function(velocityX,velocityZ){var position=this.position;var startPosition=CCMoveable.HorizontalVelocityStartPosition;vec3.copy(startPosition,position);position[0]+=velocityX;position[2]+=velocityZ;var self=this;var collisionFlags=CC.collision_static|CC.collision_moveable;var collidedWith=CC.MovementCollisionCheck(this,startPosition,position,collisionFlags,true);if(collidedWith){if(CC.HasFlag(self.collideableType,CC.collision_box)){var areaCollideables=CC.MovementAreaCollideables;var collisionBounds=self.collisionBounds;var additionalVelocity=self.additionalVelocity;position[0]-=velocityX;var collidedWithZ=collidedWith;if(velocityZ!==0){collidedWithZ=CC.MovementCollisionReCheckAreaCollideables(self,startPosition,position,collisionFlags,true)}if(collidedWithZ){position[2]-=velocityZ;position[0]+=velocityX;var collidedWithX=collidedWith;if(velocityX!==0){collidedWithX=CC.MovementCollisionReCheckAreaCollideables(self,startPosition,position,collisionFlags,true)}if(collidedWithX){position[0]-=velocityX;additionalVelocity[0]=0;additionalVelocity[2]=0}else{var collisionZ=self.getCollisionPosition(position[2],collisionBounds[2],collidedWith.position[2],collidedWith.collisionBounds[2]);position[2]=collisionZ;additionalVelocity[2]=0}}else{var collisionX=self.getCollisionPosition(position[0],collisionBounds[0],collidedWith.position[0],collidedWith.collisionBounds[0]);position[0]=collisionX;additionalVelocity[0]=0}}}};CCMoveable.prototype.applyVerticalVelocity=function(increment){var position=this.position;position[1]+=increment;var collidedWith=CC.CollisionCheck(this,position,true,CC.collision_box);if(collidedWith){var collisionBounds=this.collisionBounds;position[1]-=increment;var originalPosition=position[1];var currentlyCollidingWith=collidedWith;while(currentlyCollidingWith){position[1]=originalPosition;collidedWith=currentlyCollidingWith;position[1]=this.getCollisionPosition(position[1],collisionBounds[1],collidedWith.position[1],collidedWith.collisionBounds[1]);if(position[1]===originalPosition){currentlyCollidingWith=null}else{currentlyCollidingWith=CC.CollisionCheck(this,position,false,CC.collision_box)}}}return collidedWith};CCMoveable.prototype.reportVerticalCollision=function(collidedWith){if(collidedWith){this.movementVelocity[1]=0}};CCMoveable.prototype.setGravityForce=function(force){CCMoveable.gravityForce=force};CCMoveable.prototype.setVelocity=function(x,y,z){var movementVelocity=this.movementVelocity;movementVelocity[0]=x;movementVelocity[1]=y;movementVelocity[2]=z};CCMoveable.prototype.setAdditionalVelocity=function(x,y,z){var additionalVelocity=this.additionalVelocity;additionalVelocity[0]=x;additionalVelocity[1]=y;additionalVelocity[2]=z};CCMoveable.prototype.incrementAdditionalVelocity=function(x,y,z){var additionalVelocity=this.additionalVelocity;additionalVelocity[0]+=x;additionalVelocity[1]+=y;additionalVelocity[2]+=z};function CCTile3D(){this.construct()}ExtendPrototype(CCTile3D,CCCollideable);CCTile3D.prototype.construct=function(){this.CCCollideable_construct();this.touching=false;this.touchReleased=false;this.onPress=[];this.onRelease=[];this.onMove=[];this.onLoss=[]};CCTile3D.prototype.destruct=function(){this.CCCollideable_destruct()};CCTile3D.prototype.setPositionXYZ=function(x,y,z){this.CCCollideable_setPositionXYZ(x,y,z);CCOctree.RefreshObject(this);if(this.movementInterpolator){this.movementInterpolator.clear()}};CCTile3D.prototype.onTouchPress=function(touch){if(this.onPress){var onPress=this.onPress;var length=onPress.length;for(var i=0;i<length;++i){onPress[i](this,touch)}}};CCTile3D.prototype.onTouchMove=function(touchPosition){if(this.onMove){var onMove=this.onMove;var length=onMove.length;for(var i=0;i<length;++i){onMove[i](this,touchPosition)}}};CCTile3D.prototype.onTouchRelease=function(){if(this.onRelease){var onRelease=this.onRelease;var length=onRelease.length;for(var i=0;i<length;++i){onRelease[i](this)}}};CCTile3D.prototype.onTouchLoss=function(touchLost){if(this.onLoss){var onLoss=this.onLoss;var length=onLoss.length;for(var i=0;i<length;++i){onLoss[i](this,touchLost)}}};CCTile3D.prototype.positionTileBelow=function(fromTile){this.setPosition(fromTile.position);this.translate(0,-(fromTile.collisionBounds[1]+this.collisionBounds[1]),0)};CCTile3D.prototype.positionTileBelowY=function(fromTile){this.setPositionY(fromTile.position[1]);this.translate(0,-(fromTile.collisionBounds[1]+this.collisionBounds[1]),0)};CCTile3D.prototype.positionTileAbove=function(fromTile){this.setPosition(fromTile.position);this.translate(0,fromTile.collisionBounds[1]+this.collisionBounds[1],0)};CCTile3D.prototype.positionTileRight=function(fromTile){this.setPosition(fromTile.position);this.translate(fromTile.collisionBounds[0]+this.collisionBounds[0],0,0)};CCTile3D.prototype.positionTileLeft=function(fromTile){this.setPosition(fromTile.position);this.translate(-(fromTile.collisionBounds[0]+this.collisionBounds[0]),0,0)};CCTile3D.prototype.positionTileLeftX=function(fromTile){this.setPositionX(fromTile.getTileMovementTarget()[0]);this.translate(-(fromTile.collisionBounds[0]+this.collisionBounds[0]),0,0)};CCTile3D.prototype.setTileMovement=function(target){this.movementInterpolator.setMovement(target)};CCTile3D.prototype.setTileMovementX=function(x){this.movementInterpolator.setMovementX(x)};CCTile3D.prototype.setTileMovementY=function(y){this.movementInterpolator.setMovementY(y)};CCTile3D.prototype.setTileMovementXY=function(x,y){this.movementInterpolator.setMovementXY(x,y)};CCTile3D.prototype.setTileMovementYZ=function(y,z){this.movementInterpolator.setMovementYZ(y,z)};CCTile3D.prototype.translateTileMovementX=function(x){this.movementInterpolator.translateMovementX(x)};CCTile3D.prototype.translateTileMovementY=function(y){this.movementInterpolator.translateMovementY(y)};CCTile3D.prototype.getTileMovementTarget=function(){return this.movementInterpolator.getMovementTarget()};function CCTile3DButton(scene,setupTile){this.construct(scene);if(setupTile){this.setupTile(1)}}ExtendPrototype(CCTile3DButton,CCTile3D);CCTile3DButton.prototype.construct=function(scene){this.CCTile3D_construct();this.collideableType=CC.AddFlag(this.collideableType,CC.collision_ui);if(scene){this.setScene(scene)}this.setTransparent(true);this.setReadDepth(false);var model=this.setModel(new CCModelBase);var tileModel=this.tileModel=new CCModelBase;model.addModel(tileModel);this.setColour(gColour.white(),false);this.tileSquares=[];this.allowTouchRotation(false);this.touchRotationMagnitude=0;this.touchRotationSpeed=1;this.tileScaleInterpolator=new CCInterpolatorV3(CCInterpolatorSin2Curve);this.allowTouchMovement(false);this.touchDepressPosition=vec3.create();this.touchDepressInterpolator=new CCInterpolatorListV3;this.touchDepressInterpolator.speed=3;this.setTouchDepressRange(1);this.setTouchDepressDepth(3);CC.UpdateCollisions(this);this.createMovementInterpolator(true)};CCTile3DButton.prototype.destruct=function(){this.CCTile3D_destruct()};CCTile3DButton.prototype.setupTile=function(width,height,text){this.setTileSize(width,height);if(text){this.textObject.setText(text,height)}this.setTileTexture("white.png");return this};CCTile3DButton.prototype.setupTextured=function(textureSrc,callback,mipmap){this.setTileSize();this.setTileTexture(textureSrc,function(self,textureHandle){self.setTileTexturedSize();if(callback){callback(self,textureHandle)}});return this};CCTile3DButton.prototype.setupTexturedWidth=function(width,textureSrc,callback,mipmap){this.setTileSize(width);this.setTileTexture(textureSrc,function(self,textureHandle){self.setTileTexturedWidth(width);if(callback){callback(self,textureHandle)}})};CCTile3DButton.prototype.setupTexturedHeight=function(height,textureSrc,callback,mipmap){this.setTileSize();this.setTileTexture(textureSrc,function(self,textureHandle){self.setTileTexturedHeight(height);if(callback){callback(self,textureHandle)}})};CCTile3DButton.prototype.setupTexturedFit=function(width,height,crop,textureSrc,callback,mipmap){this.setTileSize(width,height);this.setTileTexture(textureSrc,function(self,textureHandle){if(textureHandle){self.setTileTexturedFit(width,height,crop,function(){if(callback){callback(self,textureHandle)}})}})};CCTile3DButton.prototype.setupTexture=function(width,textureSrc,mipmap){this.setTileTexture(textureSrc,function(self,textureHandle){if(textureHandle){var aspectRatio=textureHandle.image.width/textureHandle.image.height;var height=width/aspectRatio;self.setTileSize(width,height)}});return this};CCTile3DButton.prototype.setupText=function(text,height,centered,createBackgroundTile){if(centered===undefined){centered=true}this.setText(text);var textObject=this.textObject;textObject.setHeight(height);var width=textObject.getWidth();this.setCollisionBounds(width,height,CC_SMALLFLOAT);textObject.setCentered(centered);if(!centered){this.textObject.setPositionX(-width*.5)}if(createBackgroundTile){this.setTileSize(width,height);this.setTileTexture("white.png")}return this};CCTile3DButton.prototype.refreshModelMatrix=function(){if(this.updateModelMatrix){this.updateModelMatrix=false;CCRenderer.ModelMatrixIdentity(this);CCRenderer.ModelMatrixTranslate(this,this.position);CCRenderer.ModelMatrixTranslate(this,this.touchDepressPosition);CCRenderer.ModelMatrixScale(this,this.scale);var rotation=this.rotation;CCRenderer.ModelMatrixRotate(this,rotation[0],[1,0,0]);CCRenderer.ModelMatrixRotate(this,rotation[1],[0,1,0]);CCRenderer.ModelMatrixRotate(this,rotation[2],[0,0,1])}};CCTile3DButton.prototype.update=function(delta){if(this.visibleOnlyUpdate&&!this.visible){return false}var updated=this.CCTile3D_update(delta);if(this.scale){if(this.tileScaleInterpolator.updating){if(this.tileScaleInterpolator.update(delta)){this.tileScaleInterpolator.update(delta);this.dirtyModelMatrix();updated=true}}}if(this.touchDepressRange>0){if(this.touchDepressInterpolator.updating){if(this.touchDepressInterpolator.update(delta)){this.dirtyModelMatrix()}}}if(this.tileRotationInterpolator){if(this.tileRotationInterpolator.updating){if(this.tileRotationInterpolator.interpolators.length>0){if(this.tileRotationInterpolator.update(delta)){this.dirtyModelMatrix();updated=true}}}}if(this.touching){this.touchingTime+=delta}else if(this.touchReleased){if(this.touchDepressInterpolator.finished()){this.handleTouchRelease()}}if(this.model3dAnimationSpeed&&this.model3dAnimationSpeed>0&&this.model3dObject){if(this.model3dObject.model){this.model3dObject.model.animate(delta*this.model3dAnimationSpeed)}}return updated};CCTile3DButton.prototype.setTileSize=function(width,height,depth){gRenderer.pendingRender=true;if(!width){width=1}if(!height){height=width}if(this.tileSquares.length===0){this.tileSquares.push(new CCPrimitiveSquare);this.tileModel.addPrimitive(this.tileSquares[0])}if(depth===undefined){this.setCollisionBounds(width,height,CC_SMALLFLOAT)}else{this.setCollisionBounds(width,height,depth)}CC.UpdateCollisions(this);for(var i=0;i<this.tileSquares.length;++i){this.tileSquares[i].setScale(width,height,1)}if(this.textObject){if(!this.textObject.centered){this.textObject.setPositionX(-width*.5)}if(this.textScale!==undefined){this.textObject.setHeight(this.collisionSize.height*this.textScale)}}this.resize3DModel()};CCTile3DButton.prototype.setTileTexture=function(src,callback,mipmap){if(this.tileSquares.length===0){this.setTileSize(1)}if(!src){src=this.getTileTextureFilename()}if(src){this.tileSquares[0].setTexture(src);var self=this;this.loading=true;gEngine.textureManager.getTextureHandle(src,function(textureHandle){delete self.loading;
if(callback){callback(self,textureHandle)}})}};CCTile3DButton.prototype.setTileTextureIndex=function(src,index){while(this.tileSquares.length<index+1){var newIndex=this.tileSquares.length;this.tileSquares.push(new CCPrimitiveSquare);this.tileModel.addPrimitive(this.tileSquares[newIndex])}this.tileSquares[index].setTexture(src);this.setTileSize(this.collisionSize.width,this.collisionSize.height)};CCTile3DButton.prototype.getTileTextureImage=function(){if(this.tileSquares.length>0){return this.tileSquares[0].getTextureImage()}return null};CCTile3DButton.prototype.getTileTextureHandle=function(){if(this.tileSquares.length>0){return this.tileSquares[0].getTextureHandle()}return null};CCTile3DButton.prototype.getTileTextureFilename=function(){var textureHandle=this.getTileTextureHandle();if(textureHandle){return textureHandle.filename}return null};CCTile3DButton.prototype.removeTileTexture=function(){if(this.tileSquares.length>0){this.tileSquares[0].removeTexture();return true}};CCTile3DButton.prototype.setTileTexturedSize=function(){if(this.tileSquares.length>0){var texture=this.tileSquares[0].getTextureImage();if(texture){this.setTileSize(texture.width,texture.height);return true}}};CCTile3DButton.prototype.setTileTexturedWidth=function(width){if(this.tileSquares.length>0){var texture=this.tileSquares[0].getTextureImage();if(texture){var aspectRatio=texture.width/texture.height;var height=width/aspectRatio;this.setTileSize(width,height);return true}}return false};CCTile3DButton.prototype.setTileTexturedHeight=function(height){if(this.tileSquares.length>0){var texture=this.tileSquares[0].getTextureImage();if(texture){var aspectRatio=texture.width/texture.height;var width=height*aspectRatio;this.setTileSize(width,height);return true}}return false};CCTile3DButton.prototype.setTileTexturedFit=function(width,height,crop,callback){if(crop===undefined){crop=false}if(this.tileSquares.length>0){var texture=this.tileSquares[0].getTextureImage();if(texture){var targetAspectRatio=width/height;var textureAspectRatio=texture.width/texture.height;if(crop){if(textureAspectRatio<targetAspectRatio){this.setTileTexturedWidth(width)}else{this.setTileTexturedHeight(height)}}else{if(textureAspectRatio>targetAspectRatio){this.setTileTexturedWidth(width)}else{this.setTileTexturedHeight(height)}}if(callback){callback()}}}};CCTile3DButton.prototype.set3DModelAnimationSpeed=function(speed){this.model3dAnimationSpeed=speed};CCTile3DButton.prototype.set3DModelRotation=function(rotationVector){if(this.model3dObject){if(typeof rotationVector==="string"){rotationVector=vec3.fromString(rotationVector)}this.model3dObject.setRotation(rotationVector)}};CCTile3DButton.prototype.set3DModel=function(obj,tex,priority,onLoad){var self=this;if(!this.model3dObject){this.model3dObject=new CCObject;this.addChild(this.model3dObject);this.model3dObject.setColour(gColour.set(1,1));this.model3dObject.setTransparent()}this.model3dObject.obj=obj;this.model3dObject.tex=tex;if(tex){gEngine.textureManager.getTextureHandle(tex)}if(priority===undefined){priority=0}var LoadedFunction=function(obj,tex){return function(model3d){if(model3d){if(obj===self.model3dObject.obj&&tex===self.model3dObject.tex){self.model3dObject.setModel(model3d);if(self.model3dObject.tex){model3d.setTexture(self.model3dObject.tex)}self.resize3DModel();if(onLoad){onLoad()}}}}};CCModel3D.CacheModel(obj,true,new LoadedFunction(obj,tex),priority)};CCTile3DButton.prototype.resize3DModel=function(){if(this.model3dObject){if(this.model3dObject.model){var model3d=this.model3dObject.model;var primitive=model3d.getPrimitive();if(primitive){{var size=this.collisionSize.width*.75;var scaleFactor;var modelWidth=model3d.getWidth()>model3d.getDepth()?model3d.getWidth():model3d.getDepth();var modelHeight=model3d.getHeight();if(modelWidth>modelHeight){scaleFactor=size/modelWidth}else{scaleFactor=size/modelHeight}model3d.setScale(scaleFactor)}}}}};CCTile3DButton.prototype.get3DModelFilename=function(){if(this.model3dObject){return this.model3dObject.obj}return false};CCTile3DButton.prototype.get3DModelTextureFilename=function(){if(this.model3dObject){return this.model3dObject.tex}return false};CCTile3DButton.prototype.getTileColour=function(){var colour=this.tileModel.getColour();if(colour){return colour}return gColour.set(1,1)};CCTile3DButton.prototype.setTileScale=function(inScale,interpolate,onInterpolated){if(typeof inScale==="number"){inScale=vec3.clone([inScale,inScale,inScale])}if(this.scale&&interpolate){this.tileScaleInterpolator.setup(this.scale,inScale,onInterpolated)}else{this.setScale(inScale);this.tileScaleInterpolator.setup(this.scale);this.dirtyModelMatrix()}};CCTile3DButton.prototype.getTileSquare=function(){if(this.tileSquares.length>0){return this.tileSquares[0]}return null};CCTile3DButton.prototype.setText=function(text,resizeTile,fontHeight){text=""+text;if(!this.textObject){this.textObject=new CCObjectText(this)}if(!fontHeight){if(this.textScale!==undefined){fontHeight=this.collisionSize.height*this.textScale}}var textObject=this.textObject;textObject.setText(text,fontHeight);if(resizeTile){var width=textObject.getWidth();var height=textObject.getHeight();this.setCollisionBounds(width,height,CC_SMALLFLOAT);CC.UpdateCollisions(this);for(var i=0;i<this.tileSquares.length;++i){this.tileSquares[i].setScale(width,height,1)}}};CCTile3DButton.prototype.removeText=function(){if(this.textObject){this.removeChild(this.textObject);this.textObject.destruct();delete this.textObject}};CCTile3DButton.prototype.getText=function(){if(this.textObject){return this.textObject.getText()}else{return null}};CCTile3DButton.prototype.setTextPosition=function(x,y,z){if(x!==undefined){this.textObject.setPositionX(x)}if(y!==undefined){this.textObject.setPositionY(y)}if(z!==undefined){this.textObject.setPositionZ(z)}};CCTile3DButton.prototype.setTextScale=function(scale){this.textScale=scale;if(this.textObject){this.textObject.setHeight(this.collisionSize.height*scale)}};CCTile3DButton.prototype.setTextHeight=function(height,resizeTile){this.textObject.setHeight(height);if(resizeTile){var width=this.textObject.getWidth();this.setCollisionBounds(width,height,CC_SMALLFLOAT);CC.UpdateCollisions(this);for(var i=0;i<this.tileSquares.length;++i){this.tileSquares[i].setScale(width,height,1)}}};CCTile3DButton.prototype.setBlinking=function(toggle){if(toggle){var self=this;var AnimationFunction=function(){var currentAlpha=self.getColourInterpolator().getTarget().a;self.setColourAlpha(currentAlpha===1?.5:1,true,AnimationFunction)};this.setColourAlpha(1,true,AnimationFunction)}else{this.setColourAlpha(1,true)}};CCTile3DButton.prototype.isBlinking=function(){if(this){if(this.colourInterpolator){if(this.colourInterpolator.onInterpolated.length>0){return true}}}return false};CCTile3DButton.prototype.setTextBlinking=function(toggle){if(toggle){var self=this;var AnimationFunction=function(){var currentAlpha=self.textObject.getColourInterpolator().getTarget().a;self.setTextColourAlpha(currentAlpha===1?.5:1,true,AnimationFunction)};this.setTextColourAlpha(1,true,AnimationFunction)}else{this.setTextColourAlpha(1,true)}};CCTile3DButton.prototype.isTextBlinking=function(){if(this.textObject){if(this.textObject.colourInterpolator){if(this.textObject.colourInterpolator.onInterpolated.length>0){return true}}}return false};CCTile3DButton.prototype.setTextColour=function(colour,interpolate){if(this.textObject){if(interpolate){this.textObject.getColourInterpolator().setDuration(.5)}this.textObject.setColour(colour,interpolate)}};CCTile3DButton.prototype.setTextColourAlpha=function(inAlpha,interpolate,inCallback){if(this.textObject){if(interpolate){this.textObject.getColourInterpolator().setDuration(.5)}this.textObject.setColourAlpha(inAlpha,interpolate,inCallback)}};CCTile3DButton.prototype.resetTileUVs=function(){for(var i=0;i<this.tileSquares.length;++i){var tileSquare=this.tileSquares[i];if(tileSquare.customUVs){delete tileSquare.customUVs;tileSquare.adjustTextureUVs()}}};CCTile3DButton.prototype.flipTileX=function(){this.flippedX=!this.flippedX;for(var i=0;i<this.tileSquares.length;++i){var tileSquare=this.tileSquares[i];tileSquare.flipX()}};CCTile3DButton.prototype.flipTileY=function(){this.flippedY=!this.flippedY;for(var i=0;i<this.tileSquares.length;++i){var tileSquare=this.tileSquares[i];tileSquare.flipY()}};CCTile3DButton.prototype.handleProjectedTouch=function(cameraProjectionResults,hitObject,hitPosition,touch,touchAction){if(!this.collisionsEnabled){return false}if(hitObject===this){if(!this.touching){if(touchAction===CCControls.touch_pressed){this.touching=true;if(this.touchMovementAllowed){this.touchPosition=vec3.clone(this.position)}this.touchingTime=0;this.onTouchPress(touch)}}}if(this.touching){var maxTimeHeld=.125;if(touchAction===CCControls.touch_pressed){this.touchActionPressed(touchAction,hitPosition)}else if(this.touchMovementAllowed&&CCControls.TouchActionMoving(touchAction)){this.touchMoved=true;{this.touchActionPressed(touchAction,hitPosition)}return true}else{if(touchAction===CCControls.touch_released){if(!this.touchMovementAllowed){var absDeltaX=Math.abs(touch.totalDeltaX);var absDeltaY=Math.abs(touch.totalDeltaY);if(hitObject!==this||absDeltaX>CCControls.TouchMovementThreashold.x||absDeltaY>CCControls.TouchMovementThreashold.y){return this.handleProjectedTouch(cameraProjectionResults,hitObject,hitPosition,touch,CCControls.touch_lost)}}this.touchActionPressed(CCControls.touch_released,hitPosition)}this.touchActionRelease(touchAction);this.touching=false;if(this.touchMoved){this.touchMoved=false}if(touchAction===CCControls.touch_released){return true}}}return false};CCTile3DButton.RelativeHitPositionVector=vec3.create();CCTile3DButton.prototype.touchActionPressed=function(touchAction,hitPosition){var position=this.position;var collisionBounds=this.collisionBounds;if(this.touchDepressRange>0){this.touchDepressInterpolator.pushV3(this.touchDepressPosition,vec3.clone([0,0,-this.touchDepressDepth]),true)}if(touchAction>CCControls.touch_pressed&&touchAction<CCControls.touch_released){this.onTouchMove(hitPosition)}};CCTile3DButton.prototype.touchActionRelease=function(touchAction){if(touchAction===CCControls.touch_released){this.onTouchLoss(false);if(!this.touchMoved){this.touchReleased=true}else{this.handleTouchRelease()}}else{this.onTouchLoss(true);this.handleTouchRelease()}};CCTile3DButton.prototype.handleTouchRelease=function(){if(this.touchReleased){this.touchReleased=false;this.onTouchRelease()}if(this.touchDepressRange>0){this.touchDepressInterpolator.pushV3(this.touchDepressPosition,vec3.create(),true)}};CCTile3DButton.prototype.allowTouchRotation=function(allow){this.touchRotationAllowed=allow};CCTile3DButton.prototype.allowTouchMovement=function(allow){this.touchMovementAllowed=allow};CCTile3DButton.prototype.setTouchRotationSpeed=function(speed){this.touchRotationSpeed=speed};CCTile3DButton.prototype.setTouchDepressRange=function(range){this.touchDepressRange=range};CCTile3DButton.prototype.setTouchDepressDepth=function(depth){this.touchDepressDepth=depth};CCTile3DButton.prototype.getTileScaleInterpolator=function(){return this.tileScaleInterpolator};CCTile3DButton.prototype.getColourInterpolator=function(){if(!this.colourInterpolator){this.colourInterpolator=new CCInterpolatorColour;this.colourInterpolator.setDuration(.5);if(this.colour){this.colourInterpolator.setup(this.colour,this.colour)}}return this.colourInterpolator};function CCObjectSkybox(scene){this.construct();this.interpolating=false;this.renderPass=CCRenderer.render_background;this.setScene(scene)}ExtendPrototype(CCObjectSkybox,CCObject);CCObjectSkybox.prototype.setup=function(size,north,east,south,west,top,bottom){this.setModel(new CCModelBase);this.setColour(gColour.white());var hSize=size*.5;this.size=size;var squarePrimitive;if(north){squarePrimitive=new CCPrimitiveSquare;squarePrimitive.setupPoints(-hSize,hSize,-hSize,hSize,-hSize,hSize,-hSize,-hSize);this.model.addPrimitive(squarePrimitive);squarePrimitive.setTexture(north,true,true)}if(east){squarePrimitive=new CCPrimitiveSquare;squarePrimitive.setupSideFacing(hSize,size,size);this.model.addPrimitive(squarePrimitive);squarePrimitive.setTexture(east,true,true);squarePrimitive.flipY()}if(south){squarePrimitive=new CCPrimitiveSquare;squarePrimitive.setupPoints(-hSize,hSize,-hSize,hSize,-hSize,hSize,hSize,hSize);this.model.addPrimitive(squarePrimitive);squarePrimitive.setTexture(south,true,true)}if(west){squarePrimitive=new CCPrimitiveSquare;squarePrimitive.setupSideFacing(-hSize,size,size);this.model.addPrimitive(squarePrimitive);squarePrimitive.setTexture(west,true,true);squarePrimitive.flipY()}if(top){squarePrimitive=new CCPrimitiveSquare;squarePrimitive.setupUpFacing(size,size,hSize,true,-1);this.model.addPrimitive(squarePrimitive);squarePrimitive.setTexture(top,true,true)}if(bottom){squarePrimitive=new CCPrimitiveSquare;squarePrimitive.setupUpFacing(size,size,-hSize,true,1);this.model.addPrimitive(squarePrimitive);squarePrimitive.setTexture(bottom,true,true)}};CCObjectSkybox.prototype.update=function(delta){var updated=false;if(this.scaleInterpolator){var speed=delta*.5;if(this.scaleInterpolator.update(speed)){this.dirtyModelMatrix();updated=true}if(!updated){delete this.scaleInterpolator}}return this.CCObject_update(delta)||updated};CCObjectSkybox.prototype.renderModel=function(alpha){if(alpha===this.transparent){var renderer=gRenderer;renderer.CCSetCulling(false);renderer.CCSetDepthRead(false);this.CCObject_renderModel(alpha);renderer.CCSetDepthRead(true);renderer.CCSetCulling(true)}};CCObjectSkybox.prototype.animateToScale=function(startScale){this.interpolating=true;this.setScale(startScale);if(!this.scaleInterpolator){this.scaleInterpolator=new CCInterpolatorV3(CCInterpolatorSin2Curve)}this.scaleInterpolator.setup(this.scale,1)};function CCObjectText(inParent){this.jsID=CCObjectText.NextID++;this.construct();this.height=1;this.setColour(gColour.set(0));this.setTransparent(true);this.setReadDepth(false);this.shader="alphacolour";this.centered=true;if(inParent){inParent.addChild(this)}}ExtendPrototype(CCObjectText,CCObject);CCObjectText.NextID=0;CCObjectText.prototype.renderObject=function(camera,alpha){if(this.shouldRender&&alpha){var renderer=gRenderer;CCRenderer.GLPushMatrix();{if(this.updateModelMatrix){this.refreshModelMatrix()}CCRenderer.GLMultMatrix(this.modelMatrix);if(this.colour){renderer.CCSetColour(this.colour)}if(!alpha||renderer.colour.a>0){var text=this.text;var height=this.height;var fontPage=this.fontPage;fontPage.renderText(text,text.length,height,this.centered);if(this.endMarker){gEngine.textureManager.setTextureIndex(1);var x=(fontPage.getWidth(text,text.length,height)+fontPage.getCharacterWidth(" ",height))*.5;var y=height*.45;var start=vec3.clone([x,-y,0]);var end=vec3.clone([x,y,0]);renderer.CCRenderLine(start,end)}}}CCRenderer.GLPopMatrix()}};CCObjectText.prototype.getText=function(){return this.text};CCObjectText.prototype.setText=function(text,height,font){if(!text){text=""}this.text=text;gRenderer.pendingRender=true;if(height){this.setHeight(height)}if(font){this.setFont(font)}else{this.setFont("HelveticaNeueLight")}};CCObjectText.prototype.getWidth=function(){var text=this.text;return this.fontPage.getWidth(text,text.length,this.height)};CCObjectText.prototype.getHeight=function(){var text=this.text;return this.fontPage.getHeight(text,text.length,this.height)};CCObjectText.prototype.setHeight=function(height){if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCObjectText.setHeight;"+this.jsID+";"+height+"\n"}this.height=height};CCObjectText.prototype.setCentered=function(centered){if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCObjectText.setCentered;"+this.jsID+";"+centered+"\n"}if(centered){this.setPositionX(0)}else if(this.parent){this.setPositionX(-this.parent.collisionBounds[0])}this.centered=centered};CCObjectText.prototype.setFont=function(font){if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCObjectText.setFont;"+this.jsID+";"+font+"\n"}var fontPages=gEngine.textureManager.fontPages;var length=fontPages.length;for(var i=0;i<length;++i){var page=fontPages[i];if(font===page.name){this.fontPage=page;return}}};CCObjectText.prototype.setEndMarker=function(toggle){if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCObjectText.setEndMarker;"+this.jsID+";"+toggle+"\n"}this.endMarker=toggle};CCObjectText.prototype.getEndMarker=function(){return!!this.endMarker};CCObjectText.prototype.nativeConstruct=function(){CCEngine.NativeUpdateCommands+="CCObjectText.construct;"+this.jsID+"\n"};CCObjectText.prototype.nativeDestruct=function(){CCEngine.NativeUpdateCommands+="CCObjectText.destruct;"+this.jsID+"\n"};CCObjectText.prototype.renderObject=function(camera,alpha){if(alpha){var renderer=gRenderer;if(this.colour){renderer.CCSetColour(this.colour)}renderer.unbindBuffers();CCEngine.NativeRenderCommands+="CCObjectText.renderObject;"+this.jsID+"\n"}};CCObjectText.prototype.setText=function(text,height,font){if(!text){text=""}if(CCEngine.NativeUpdateCommands!==undefined){var encodedText=String.ReplaceChar(text,"\n","\\n");CCEngine.NativeUpdateCommands+="CCObjectText.setText;"+this.jsID+";"+encodedText+"\n"}this.text=text;gRenderer.pendingRender=true;if(height){this.setHeight(height)}if(font){this.setFont(font)}else{this.setFont("HelveticaNeueLight")}};function CCTextureFontPageFile(inName){function Letter(){this.start=new CCPoint;this.end=new CCPoint;this.size=new CCSize}var letters=this.letters=[];var i;for(i=0;i<256;++i){letters.push(new Letter)}this.name=inName;var MAX_TEXT_LINES=this.MAX_TEXT_LINES=8;var MAX_TEXT_LENGTH=512;var lineSize=this.lineSize=[];for(i=0;i<MAX_TEXT_LINES;++i){lineSize.push(new CCPoint)}var charSize=this.charSize=[];var startPositions=this.startPositions=[];for(i=0;i<MAX_TEXT_LINES;++i){charSize[i]=[];startPositions[i]=new CCPoint;for(var j=0;j<MAX_TEXT_LENGTH;++j){charSize[i][j]=new CCPoint}}this.currentStart=vec3.create();this.currentEnd=vec3.create();this.cachedMeshes=[];this.loaded=false}CCTextureFontPageFile.prototype.load=function(){var self=this;var textureURL=this.name+".png";this.texturePageIndex=gEngine.textureManager.assignTextureIndex(textureURL,true);var csvFile=this.name+".csv";var dataURL=MultiplayerManager.GetAssetURL(csvFile);gURLManager.requestURL(dataURL,null,function(status,responseText){if(status>=CCURLRequest.Succeeded){var letters=self.letters;var lettersSplit=responseText.split("\n");for(var i=0;i<lettersSplit.length;++i){var rawLetterData=lettersSplit[i];var letterDataSplit=rawLetterData.split(",");var letter=letters[i];letter.start.x=parseFloat(letterDataSplit[0]);letter.start.y=parseFloat(letterDataSplit[1]);letter.end.x=parseFloat(letterDataSplit[2]);letter.end.y=parseFloat(letterDataSplit[3]);letter.size.width=(letter.end.x-letter.start.x)*16;letter.size.height=(letter.end.y-letter.start.y)*16;letter.start.y=letter.start.y;letter.end.y=letter.end.y}self.loaded=true;gEngine.resize()}},1,csvFile);return true};CCTextureFontPageFile.prototype.bindTexturePage=function(){gEngine.textureManager.setTextureIndex(this.texturePageIndex)};CCTextureFontPageFile.prototype.getLetter=function(character){var asciiCharacter=character.charCodeAt(0);if(asciiCharacter>=0){return this.letters[asciiCharacter]}else if(asciiCharacter===-62){return this.letters[128]}return false};CCTextureFontPageFile.prototype.getCharacterWidth=function(character,size){if(character==="\n"){}else{var letter=this.getLetter(character);if(letter){return letter.size.width*size}}return 0};CCTextureFontPageFile.prototype.getWidth=function(text,length,size){var totalWidth=0;for(var i=0;i<length;++i){var character=text[i];if(character==="\n"){break}else{var letter=this.getLetter(character);if(letter){totalWidth+=letter.size.width*size}}}return totalWidth};CCTextureFontPageFile.prototype.getHeight=function(text,length,size){var maxHeight=0;for(var i=0;i<length;++i){var letter=this.getLetter(text[i]);if(letter){maxHeight=Math.max(maxHeight,letter.size.height*size)}}return maxHeight};CCTextureFontPageFile.prototype.renderText=function(text,length,height,centeredX){if(!this.loaded){return}if(length<1){return}var mesh=this.getTextMesh(text,length,height,centeredX);var renderer=gRenderer;CCRenderer.GLPushMatrix();{CCRenderer.GLTranslate([0,mesh.totalLineHeight*.5,0]);this.bindTexturePage();renderer.CCBindVertexTextureBuffer(mesh.vertexTextureBuffer);renderer.CCBindVertexPositionBuffer(mesh.vertexPositionBuffer);renderer.CCSetRenderStates();renderer.GLDrawArrays("TRIANGLES",0,mesh.vertexCount)}CCRenderer.GLPopMatrix()};CCTextureFontPageFile.prototype.getTextMesh=function(text,length,height,centeredX){var cachedMeshes=this.cachedMeshes;var i,mesh;for(i=0;i<cachedMeshes.length;++i){mesh=cachedMeshes[i];if(mesh.textHeight===height){if(mesh.centeredX===centeredX){if(mesh.text.length===length){if(mesh.text===text){mesh.lastDrawTime=gEngine.lifetime;return mesh}}}}}if(cachedMeshes.length>100){var oldestRenderTime=CC_MAXFLOAT;var oldestRender=null;for(i=0;i<cachedMeshes.length;++i){mesh=cachedMeshes[i];if(mesh.lastDrawTime<oldestRenderTime){oldestRenderTime=mesh.lastDrawTime;oldestRender=mesh}}if(oldestRender){cachedMeshes.remove(oldestRender);gRenderer.CCDeleteVertexBuffer(oldestRender.vertexPositionBuffer);gRenderer.CCDeleteVertexBuffer(oldestRender.vertexTextureBuffer)}}mesh=this.buildTextMesh(text,length,height,centeredX);cachedMeshes.add(mesh);mesh.lastDrawTime=gEngine.lifetime;return mesh};CCTextureFontPageFile.prototype.buildTextMesh=function(text,length,height,centeredX){var i,character,letter,size,start;var totalLineHeight=0;var lineSize=this.lineSize;lineSize[0].x=lineSize[0].y=0;var charSize=this.charSize;var lineIndex=0;var characterIndex=0;for(i=0;i<length;++i){character=text[i];{letter=this.getLetter(character);if(letter){size=charSize[lineIndex][characterIndex];size.x=letter.size.width*height;size.y=letter.size.height*height;lineSize[lineIndex].x+=size.x;lineSize[lineIndex].y=Math.max(lineSize[lineIndex].y,size.y);characterIndex++}}if(character==="\n"){totalLineHeight+=lineSize[lineIndex].y;lineIndex++;lineSize[lineIndex].x=lineSize[lineIndex].y=0;characterIndex=0}}totalLineHeight+=lineSize[lineIndex].y;var startPositions=this.startPositions;for(i=0;i<lineIndex+1;++i){start=startPositions[i];start.x=0;start.y=0;if(centeredX){start.x-=lineSize[i].x*.5}for(var j=0;j<i;++j){start.y-=lineSize[j].y}}var currentStart=this.currentStart;var currentEnd=this.currentEnd;currentStart[0]=startPositions[0].x;currentStart[1]=startPositions[0].y;var vertices=new CCRenderer.Float32Array(3*6*length);var uvs=new CCRenderer.Float32Array(2*6*length);var vertexIndex=0;var texCoordIndex=0;lineIndex=0;characterIndex=0;for(i=0;i<length;++i){character=text[i];{letter=this.getLetter(character);if(letter){size=charSize[lineIndex][characterIndex];currentEnd[0]=currentStart[0]+size.x;currentEnd[1]=currentStart[1]-size.y;{vertices[vertexIndex++]=currentStart[0];vertices[vertexIndex++]=currentEnd[1];vertices[vertexIndex++]=0;uvs[texCoordIndex++]=letter.start.x;uvs[texCoordIndex++]=letter.end.y;vertices[vertexIndex++]=currentEnd[0];vertices[vertexIndex++]=currentEnd[1];vertices[vertexIndex++]=0;uvs[texCoordIndex++]=letter.end.x;uvs[texCoordIndex++]=letter.end.y;vertices[vertexIndex++]=currentStart[0];vertices[vertexIndex++]=currentStart[1];vertices[vertexIndex++]=0;uvs[texCoordIndex++]=letter.start.x;uvs[texCoordIndex++]=letter.start.y}{vertices[vertexIndex++]=currentEnd[0];vertices[vertexIndex++]=currentEnd[1];vertices[vertexIndex++]=0;uvs[texCoordIndex++]=letter.end.x;uvs[texCoordIndex++]=letter.end.y;vertices[vertexIndex++]=currentEnd[0];vertices[vertexIndex++]=currentStart[1];vertices[vertexIndex++]=0;uvs[texCoordIndex++]=letter.end.x;uvs[texCoordIndex++]=letter.start.y;vertices[vertexIndex++]=currentStart[0];vertices[vertexIndex++]=currentStart[1];vertices[vertexIndex++]=0;uvs[texCoordIndex++]=letter.start.x;uvs[texCoordIndex++]=letter.start.y}currentStart[0]+=size.x;characterIndex++}}if(character==="\n"){lineIndex++;start=startPositions[lineIndex];currentStart[0]=start.x;currentStart[1]=start.y;characterIndex=0}}var vertexPositionBuffer=gRenderer.CCCreateVertexBuffer(vertices);var vertexTextureBuffer=gRenderer.CCCreateVertexBuffer(uvs,2);var mesh={};mesh.text=text;mesh.textHeight=height;mesh.centeredX=centeredX;mesh.totalLineHeight=totalLineHeight;mesh.vertexPositionBuffer=vertexPositionBuffer;mesh.vertexTextureBuffer=vertexTextureBuffer;mesh.vertexCount=vertexIndex/3;return mesh};function CCPrimitiveBase(){}CCPrimitiveBase.NextID=0;CCPrimitiveBase.prototype.construct=function(){this.primitiveID=CCPrimitiveBase.NextID++;this.textureIndex=-1;this.customUVs=null;this.adjustedUVs=null};CCPrimitiveBase.prototype.destruct=function(){};CCPrimitiveBase.prototype.setTextureIndex=function(index){this.textureIndex=index;if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCPrimitiveBase.setTexture;"+this.primitiveID+";"+this.textureIndex+"\n"}};CCPrimitiveBase.prototype.setTexture=function(src,mipmap,load,alwaysResident,callback){this.tex=src;this.textureIndex=gEngine.textureManager.assignTextureIndex(src);if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCPrimitiveBase.setTexture;"+this.primitiveID+";"+this.textureIndex+"\n"}var self=this;gEngine.textureManager.getTextureHandleIndexAsync(this.textureIndex,function(textureHandle){if(textureHandle&&textureHandle.image){if(self.adjustTextureUVs){self.adjustTextureUVs()}if(callback){callback()}}})};CCPrimitiveBase.prototype.getTextureHandle=function(){if(this.textureIndex>=0){var textureHandle=gEngine.textureManager.getTextureHandleIndex(this.textureIndex);if(textureHandle){return textureHandle}}return null};CCPrimitiveBase.prototype.getTextureImage=function(){var handle=this.getTextureHandle();if(handle&&handle.downloaded&&handle.image){return handle.image}return null};CCPrimitiveBase.prototype.removeTexture=function(){this.textureIndex=-1};CCPrimitiveBase.prototype.render=function(){if(this.textureIndex!==-1){gEngine.textureManager.setTextureIndex(this.textureIndex)}else{gEngine.textureManager.setTextureIndex(1)}this.renderVertices(gRenderer)};CCPrimitiveBase.prototype.renderOutline=function(){};function CCPrimitiveSquare(){this.construct();this.scale=vec3.clone([1,1,1]);if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCPrimitiveSquare.construct;"+this.primitiveID+"\n"}}ExtendPrototype(CCPrimitiveSquare,CCPrimitiveBase);CCPrimitiveSquare.prototype.destruct=function(){if(this.vertexPositionBuffer){gRenderer.CCDeleteVertexBuffer(this.vertexPositionBuffer)}if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCPrimitiveSquare.destruct;"+this.primitiveID+"\n"}this.CCPrimitiveBase_destruct()};CCPrimitiveSquare.prototype.setScale=function(width,height,depth){if(!height){height=width}if(!depth){depth=1}if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCPrimitiveSquare.setScale;"+this.primitiveID+";"+width+";"+height+";"+depth+"\n"}var scale=this.scale;scale[0]=width;scale[1]=height;scale[2]=depth;return this};CCPrimitiveSquare.prototype.render=function(){var renderer=gRenderer;if(this.textureIndex!==-1){gEngine.textureManager.setTextureIndex(this.textureIndex)}else{gEngine.textureManager.setTextureIndex(0)}if(this.adjustedUVs){renderer.CCSetTexCoords(this.adjustedUVs)}else if(this.customUVs){renderer.CCSetTexCoords(this.customUVs)}else{renderer.CCDefaultTexCoords()}this.renderVertices(renderer)};CCPrimitiveSquare.prototype.renderVertices=function(renderer){CCRenderer.GLPushMatrix();CCRenderer.GLScale(this.scale);if(this.vertexPositionBuffer){renderer.CCBindVertexPositionBuffer(this.vertexPositionBuffer)}else{renderer.CCDefaultSquareVertexPointer()}renderer.CCSetRenderStates();renderer.GLDrawArrays("TRIANGLE_STRIP",0,4);CCRenderer.GLPopMatrix()};CCPrimitiveSquare.prototype.renderOutline=function(){CCRenderer.GLPushMatrix();CCRenderer.GLScale(this.scale);gRenderer.CCSetRenderStates();gRenderer.GLDrawElements("LINE_STRIP",4,0);CCRenderer.GLPopMatrix()};CCPrimitiveSquare.prototype.setupPoints=function(tL,tR,bL,bR,bY,tY,bZ,tZ){var vertices=new CCRenderer.Float32Array(3*4);var i=0;vertices[i++]=tR;vertices[i++]=tY;vertices[i++]=tZ;vertices[i++]=tL;vertices[i++]=tY;vertices[i++]=tZ;vertices[i++]=bR;vertices[i++]=bY;vertices[i++]=bZ;vertices[i++]=bL;vertices[i++]=bY;vertices[i++]=bZ;this.vertexPositionBuffer=gRenderer.CCCreateVertexBuffer(vertices);if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCPrimitiveSquare.setVertexBufferID;"+this.primitiveID+";"+this.vertexPositionBuffer+"\n"}};CCPrimitiveSquare.prototype.setupSideFacing=function(x,height,depth){var hHeight=height*.5;var hDepth=depth*.5;var vertices=new CCRenderer.Float32Array(3*4);var i=0;vertices[i++]=x;vertices[i++]=hHeight;vertices[i++]=-hDepth;vertices[i++]=x;vertices[i++]=hHeight;vertices[i++]=hDepth;vertices[i++]=x;vertices[i++]=-hHeight;vertices[i++]=-hDepth;vertices[i++]=x;vertices[i++]=-hHeight;vertices[i++]=hDepth;this.vertexPositionBuffer=gRenderer.CCCreateVertexBuffer(vertices);if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCPrimitiveSquare.setVertexBufferID;"+this.primitiveID+";"+this.vertexPositionBuffer+"\n"}};CCPrimitiveSquare.prototype.setupUpFacing=function(width,depth,yPosition,useNormals,direction){var hWidth=width*.5;var hDepth=depth*.5;var vertices=new CCRenderer.Float32Array(3*4);vertices[0]=hWidth;vertices[1]=yPosition;vertices[2]=-hDepth;vertices[3]=-hWidth;vertices[4]=yPosition;vertices[5]=-hDepth;vertices[6]=hWidth;vertices[7]=yPosition;vertices[8]=hDepth;vertices[9]=-hWidth;vertices[10]=yPosition;vertices[11]=hDepth;this.vertexPositionBuffer=gRenderer.CCCreateVertexBuffer(vertices);if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCPrimitiveSquare.setVertexBufferID;"+this.primitiveID+";"+this.vertexPositionBuffer+"\n"}if(useNormals){}};CCPrimitiveSquare.prototype.adjustTextureUVs=function(){if(this.textureIndex>=0){var textureHandle=gEngine.textureManager.getTextureHandleIndex(this.textureIndex);var textureImage=textureHandle.image;if(textureImage){if(textureImage.allocatedWidth&&textureImage.allocatedHeight){var width=textureImage.width;var height=textureImage.height;var allocatedWidth=textureImage.allocatedWidth;var allocatedHeight=textureImage.allocatedHeight;if(width===allocatedWidth&&height===allocatedHeight){if(this.adjustedUVs){delete this.adjustedUVs}}else{if(this.customUVs){var uvs=this.customUVs;var x2=uvs[0];var y1=uvs[1];var x1=uvs[2];var y2=uvs[5];var widthScale=width/allocatedWidth;var heightScale=height/allocatedHeight;this.setAdjustedUVs(x1*widthScale,y1*heightScale,x2*widthScale,y2*heightScale)}else{this.setAdjustedUVs(0,0,width/allocatedWidth,height/allocatedHeight)}}}else{if(this.adjustedUVs){delete this.adjustedUVs}}}}};CCPrimitiveSquare.prototype.setAdjustedUVs=function(x1,y1,x2,y2){if(!this.adjustedUVs){this.adjustedUVs=new CCRenderer.Float32Array(8)}var uvs=this.adjustedUVs;uvs[0]=x2;uvs[1]=y1;uvs[2]=x1;uvs[3]=y1;uvs[4]=x2;uvs[5]=y2;uvs[6]=x1;uvs[7]=y2};CCPrimitiveSquare.prototype.setTextureUVs=function(x1,y1,x2,y2){if(!this.customUVs){this.customUVs=new CCRenderer.Float32Array(8)}var uvs=this.customUVs;uvs[0]=x2;uvs[1]=y1;uvs[2]=x1;uvs[3]=y1;uvs[4]=x2;uvs[5]=y2;uvs[6]=x1;uvs[7]=y2;this.adjustTextureUVs()};CCPrimitiveSquare.prototype.flipX=function(){if(!this.customUVs){this.setTextureUVs(0,0,1,1)}var uvs=this.customUVs;var y1=uvs[1];var y2=uvs[5];uvs[1]=y2;uvs[3]=y2;uvs[5]=y1;uvs[7]=y1;this.adjustTextureUVs()};CCPrimitiveSquare.prototype.flipY=function(){if(!this.customUVs){this.setTextureUVs(0,0,1,1)}var uvs=this.customUVs;var x1=uvs[0];var x2=uvs[2];uvs[0]=x2;uvs[4]=x2;uvs[2]=x1;uvs[6]=x1;this.adjustTextureUVs()};window.gRenderer=null;function CCRenderer(){}CCRenderer.render_all=1;CCRenderer.render_collisionBoxes=2;
CCRenderer.render_collisionTrees=4;CCRenderer.render_pathFinder=8;CCRenderer.render_background=0;CCRenderer.render_main=1;CCRenderer.render_post=2;CCRenderer.render_finished=3;CCRenderer.NewArrayType=function(array,ArrayType){var newArray=new ArrayType(array.length);for(var i=0;i<array.length;++i){newArray[i]=array[i]}return newArray};CCRenderer.prototype.CCDefaultSquareVertexPointer=function(){this.CCBindVertexPositionBuffer(this.defaultSquareVertexBuffer)};CCRenderer.prototype.CCRenderLine=function(start,end){this.CCSetRenderStates();this.CCDefaultTexCoords();if(!this.linePositionBuffer){this.linePositionBuffer=this.CCCreateVertexBuffer()}var vertices=[start[0],start[1],start[2],end[0],end[1],end[2]];this.CCUpdateVertexBuffer(this.linePositionBuffer,CCRenderer.NewArrayType(vertices,CCRenderer.Float32Array));this.CCBindVertexPositionBuffer(this.linePositionBuffer);this.GLDrawArrays("LINES",0,2)};CCRenderer.prototype.CCRenderCube=function(outline){this.CCSetRenderStates();if(!this.cubeTextureBuffer){var textureCoords=[1,1,0,1,1,0,0,0,1,1,0,1,1,0,0,0];this.cubeTextureBuffer=this.CCCreateVertexBuffer(CCRenderer.NewArrayType(textureCoords,CCRenderer.Float32Array),2)}this.CCBindVertexTextureBuffer(this.cubeTextureBuffer);if(!this.cubePositionBuffer){var vertices=[-.5,-.5,-.5,.5,-.5,-.5,-.5,.5,-.5,.5,.5,-.5,-.5,-.5,.5,.5,-.5,.5,-.5,.5,.5,.5,.5,.5];this.cubePositionBuffer=this.CCCreateVertexBuffer(CCRenderer.NewArrayType(vertices,CCRenderer.Float32Array))}this.CCBindVertexPositionBuffer(this.cubePositionBuffer);var faces;if(outline){faces=[0,1,3,2,0,4,5,1,5,7,3,7,6,2,6,4];if(!this.cubeOutlineIndexBuffer){this.cubeOutlineIndexBuffer=this.CCCreateVertexIndexBuffer(CCRenderer.NewArrayType(faces,CCRenderer.Uint16Array))}this.CCBindVertexIndexBuffer(this.cubeOutlineIndexBuffer);this.GLDrawElements("LINE_STRIP",faces.length,0)}else{faces=[0,1,2,3,7,1,5,4,7,6,2,4,0,1];if(!this.cubeIndexBuffer){this.cubeIndexBuffer=this.CCCreateVertexIndexBuffer(CCRenderer.NewArrayType(faces,CCRenderer.Uint16Array))}this.CCBindVertexIndexBuffer(this.cubeIndexBuffer);this.GLDrawElements("TRIANGLE_STRIP",faces.length,0)}};function CCModelBase(){this.construct()}ExtendPrototype(CCModelBase,CCRenderable);CCModelBase.prototype.construct=function(){this.CCRenderable_construct();this.primitives=[];this.models=[];if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCModelBase.construct;"+this.jsID+"\n"}};CCModelBase.prototype.destruct=function(){var i;{var models=this.models;for(i=0;i<models.length;++i){models[i].destruct()}models.length=0}{var primitives=this.primitives;for(i=0;i<primitives.length;++i){primitives[i].destruct()}primitives.length=0}this.CCRenderable_destruct();if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCModelBase.destruct;"+this.jsID+"\n"}};CCModelBase.prototype.render=function(alpha){if(this.shouldRender){var renderer=gRenderer;if(CCEngine.NativeRenderCommands!==undefined){renderer.unbindBuffers();CCEngine.NativeRenderCommands+="CCModelBase.render;"+this.jsID+";"+alpha+"\n";return}CCRenderer.GLPushMatrix();{if(this.updateModelMatrix){this.refreshModelMatrix()}CCRenderer.GLMultMatrix(this.modelMatrix);var primitives=this.primitives;var primitivesLength=primitives.length;if(this.colour){renderer.CCSetColour(this.colour)}if(!alpha||renderer.colour.a>0){for(var primitiveIndex=0;primitiveIndex<primitivesLength;++primitiveIndex){primitives[primitiveIndex].render()}}var models=this.models;var length=models.length;for(var modelIndex=0;modelIndex<length;++modelIndex){models[modelIndex].render(alpha);if(this.colour){renderer.CCSetColour(this.colour)}}}CCRenderer.GLPopMatrix()}};CCModelBase.prototype.addModel=function(model){this.models.push(model);if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCModelBase.addModel;"+this.jsID+";"+model.jsID+"\n"}};CCModelBase.prototype.removeModel=function(model){this.models.remove(model);if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCModelBase.removeModel;"+this.jsID+";"+model.jsID+"\n"}};CCModelBase.prototype.addPrimitive=function(primitive){this.primitives.push(primitive);if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCModelBase.addPrimitive;"+this.jsID+";"+primitive.primitiveID+"\n"}};function CCModel3D(){this.construct()}ExtendPrototype(CCModel3D,CCModelBase);CCModel3D.prototype.construct=function(){this.CCModelBase_construct();this.primitive=null};CCModel3D.prototype.getPrimitive=function(){return this.primitive};CCModel3D.prototype.getWidth=function(){return this.primitive.getWidth()};CCModel3D.prototype.getHeight=function(){return this.primitive.getHeight()};CCModel3D.prototype.getDepth=function(){return this.primitive.getDepth()};CCModel3D.prototype.getOrigin=function(){return this.primitive.getOrigin()};CCModel3D.prototype.moveVerticesToOrigin=function(callback){this.primitive.moveVerticesToOrigin(callback)};CCModel3D.prototype.setTexture=function(file,mipmap,load){if(file){this.primitive.setTexture(file,mipmap,true,load)}};CCModel3D.prototype.removeTexture=function(){this.primitive.removeTexture()};CCModel3D.prototype.getAnimations=function(){if(this.primitive.animations){return this.primitive.animations}return null};CCModel3D.prototype.getAnimation=function(){if(this.primitive.getAnimation){return this.primitive.getAnimation()}return 0};CCModel3D.prototype.getAnimationFrame=function(){if(this.primitive.getAnimationFrame){return this.primitive.getAnimationFrame()}return-1};CCModel3D.prototype.getAnimationFPSCompression=function(){if(this.primitive.getAnimationFPSCompression){return this.primitive.getAnimationFPSCompression()}return 0};CCModel3D.prototype.setAnimation=function(index){if(this.primitive.setNextAnimation){this.primitive.setNextAnimation(index)}};CCModel3D.prototype.setAnimationFrame=function(index){if(this.primitive.setNextAnimationFrame){this.primitive.setNextAnimationFrame(index)}};CCModel3D.prototype.toggleAnimationFrame=function(index){if(this.primitive.toggleAnimationFrame){this.primitive.toggleAnimationFrame(index)}};CCModel3D.prototype.animate=function(delta,repeat,duration){if(this.primitive.animate){if(repeat===undefined){repeat=true}if(duration!==undefined){this.primitive.animateForDuration(delta,repeat,duration)}else{this.primitive.animate(delta,repeat)}gRenderer.pendingRender=true;return true}return false};function PrimitiveCache(){this.filename=undefined;this.primitive=undefined}CCModel3D.ModelCache=[];function ModelLoaderPacket(){this.callbacks=[]}CCModel3D.LoadingQueue=[];CCModel3D.CurrentLoad=null;CCModel3D.CreatePrimitive=function(filename){var extension=filename.getExtension();if(extension==="obj"){return new CCPrimitiveOBJ}else if(extension==="fbxi"){return new CCPrimitiveFBX}return null};CCModel3D.CacheModel=function(url,moveVerticesToOrigin,callback,priority){url=MultiplayerManager.GetAssetURL(url);var i;var filename=url.stripDirectory();filename=String.StripEquals(filename);var cachedModel=null;var ModelCache=CCModel3D.ModelCache;var length=ModelCache.length;for(i=0;i<length;++i){var cache=ModelCache[i];if(moveVerticesToOrigin===cache.primitive.hasMovedToOrigin()){if(cache.filename===filename){cachedModel=cache;break}}}if(!cachedModel){var loaderPacket;if(CCModel3D.CurrentLoad){loaderPacket=CCModel3D.CurrentLoad;if(loaderPacket.moveVerticesToOrigin===moveVerticesToOrigin){if(loaderPacket.url===url){if(callback){loaderPacket.callbacks.add(callback);if(priority>0){gURLManager.updateRequestPriority(url,filename,priority)}}return}}}var LoadingQueue=CCModel3D.LoadingQueue;for(i=0;i<LoadingQueue.length;++i){loaderPacket=LoadingQueue[i];if(loaderPacket.moveVerticesToOrigin===moveVerticesToOrigin){if(loaderPacket.url===url){if(callback){loaderPacket.callbacks.add(callback)}if(priority>0){CCModel3D.ResortQueue(loaderPacket,priority)}return}}}if(window.DEBUG_IsLocalClient){console.log("CCModel3D.CacheModel queue",filename,priority)}{loaderPacket=new ModelLoaderPacket;loaderPacket.filename=filename;loaderPacket.url=url;loaderPacket.priority=priority?priority:0;loaderPacket.moveVerticesToOrigin=moveVerticesToOrigin;if(callback){loaderPacket.callbacks.add(callback)}var primitive=CCModel3D.CreatePrimitive(filename);if(primitive){loaderPacket.primitive=primitive;LoadingQueue.add(loaderPacket);if(priority>0){CCModel3D.ResortQueue(loaderPacket,priority)}CCModel3D.LoadFromQueue()}}}else if(callback){CCModel3D.CacheModelResultProcess(cachedModel,[callback],false)}};CCModel3D.ResortQueue=function(packet,priority){var LoadingQueue=CCModel3D.LoadingQueue;for(var i=0;i<LoadingQueue.length;++i){var itr=LoadingQueue[i];if(itr===packet){break}else if(itr.priority<priority){LoadingQueue.insert(packet,i);break}}};CCModel3D.LoadFromQueue=function(){if(!CCModel3D.CurrentLoad&&CCModel3D.LoadingQueue.length>0){CCModel3D.CurrentLoad=CCModel3D.LoadingQueue.safePop();var loaderPacket=CCModel3D.CurrentLoad;var filename=loaderPacket.filename;var url=loaderPacket.url;var priority=loaderPacket.priority;var moveVerticesToOrigin=loaderPacket.moveVerticesToOrigin;var primitive=loaderPacket.primitive;primitive.load(filename,url,priority,function(succeeded){if(succeeded){var cachedModel=new PrimitiveCache;cachedModel.filename=filename;cachedModel.primitive=primitive;CCModel3D.ModelCache.add(cachedModel);if(moveVerticesToOrigin){primitive.moveVerticesToOriginAsync(function(){CCModel3D.CurrentLoad=null;CCModel3D.CacheModelResult(cachedModel,loaderPacket.callbacks)})}else{CCModel3D.CurrentLoad=null;CCModel3D.CacheModelResult(cachedModel,loaderPacket.callbacks)}}else{CCModel3D.CurrentLoad=null;primitive.destruct();CCModel3D.CacheModelResult(null,loaderPacket.callbacks)}})}};CCModel3D.CacheModelResult=function(cachedModel,callbacks){if(!CCModel3D.ResultQueue){CCModel3D.ResultQueue=[]}var result={};result.cachedModel=cachedModel;result.callbacks=callbacks;CCModel3D.ResultQueue.push(result);if(CCModel3D.ResultQueue.length===1){CCModel3D.CacheModelResultQueue()}CCModel3D.LoadFromQueue()};CCModel3D.CacheModelResultQueue=function(){CCEngine.RunNextUpdate(function(){if(CCModel3D.ResultQueue.length>0){var result=CCModel3D.ResultQueue.safePop();CCModel3D.CacheModelResultProcess(result.cachedModel,result.callbacks);if(CCModel3D.ResultQueue.length>0){CCModel3D.CacheModelResultQueue()}}})};CCModel3D.CacheModelResultProcess=function(cachedModel,callbacks){cachedModel.lastCacheTime=gEngine.lifetime;var i;var ModelCache=CCModel3D.ModelCache;var length=ModelCache.length;if(length>100){var oldestCacheTime=CC_MAXFLOAT;var oldestModel=null;for(i=0;i<length;++i){var cache=ModelCache[i];if(cache.lastCacheTime<oldestCacheTime){oldestModel=cache}}if(oldestModel){ModelCache.remove(oldestModel);oldestModel.primitive.destruct()}}for(i=0;i<callbacks.length;++i){var model=null;if(cachedModel){model=new CCModel3D;var primitive=CCModel3D.CreatePrimitive(cachedModel.filename);primitive.copy(cachedModel.primitive);model.primitive=primitive;model.addPrimitive(primitive)}callbacks[i](model)}CCModel3D.LoadFromQueue()};function CCPrimitive3D(){this.construct()}ExtendPrototype(CCPrimitive3D,CCPrimitiveBase);CCPrimitive3D.prototype.construct=function(){if(CCPrimitive3D.Objects){CCPrimitive3D.Objects.add(this)}this.CCPrimitiveBase_construct();this.vertexCount=0;this.width=this.height=this.depth=0;this.mmX=new CCMinMax;this.mmY=new CCMinMax;this.mmZ=new CCMinMax;this.cached=false;this.movedToOrigin=false;this.origin=vec3.create()};CCPrimitive3D.prototype.destruct=function(){if(CCPrimitive3D.Objects){CCPrimitive3D.Objects.remove(this)}if(!this.cached){if(this.vertexPositionBuffer){gRenderer.CCDeleteVertexBuffer(this.vertexPositionBuffer)}}if(this.vertexTextureBuffer){gRenderer.CCDeleteVertexBuffer(this.vertexTextureBuffer)}this.CCPrimitiveBase_destruct()};CCPrimitive3D.prototype.load=function(filename,url,priority,callback){this.filename=filename;var self=this;gURLManager.requestURL(url,null,function(status,responseText){if(status>=CCURLRequest.Succeeded){self.loadData(responseText,callback)}else{callback(false)}},priority,filename)};CCPrimitive3D.prototype.loadData=function(fileData,callback){if(callback){callback(false)}};CCPrimitive3D.prototype.getWidth=function(){return this.width};CCPrimitive3D.prototype.getHeight=function(){return this.height};CCPrimitive3D.prototype.getDepth=function(){return this.depth};CCPrimitive3D.prototype.getYMinMax=function(){return this.mmY};CCPrimitive3D.prototype.getYMinMaxAtZ=function(atZ,callback){var mmYAtZ=new CCMinMax;var vertices=this.vertices;var vertexCount=this.vertexCount;for(var i=0;i<vertexCount;++i){var index=i*3;var y=vertices[index+1];var z=vertices[index+2];if(z>=atZ){mmYAtZ.consider(y)}}callback(mmYAtZ)};CCPrimitive3D.prototype.getZMinMax=function(){return this.mmZ};CCPrimitive3D.prototype.getOrigin=function(){if(!this.movedToOrigin){var origin=this.origin;origin[0]=this.mmX.min+this.width*.5;origin[1]=this.mmY.min+this.height*.5;origin[2]=this.mmZ.min+this.depth*.5}return this.origin};CCPrimitive3D.prototype.moveVerticesToOriginAsync=function(callback){var self=this;CCEngine.RunNextUpdate(function(){self.moveVerticesToOrigin();if(callback){callback()}})};CCPrimitive3D.prototype.moveVerticesToOrigin=function(callback){if(!this.movedToOrigin){var origin=this.getOrigin();var mmX=this.mmX;var mmY=this.mmY;var mmZ=this.mmZ;mmX.reset();mmY.reset();mmZ.reset();var vertices=this.vertices;var vertexCount=this.vertexCount;for(var i=0;i<vertexCount;++i){var index=i*3;var x=index+0;var y=index+1;var z=index+2;vertices[x]-=origin[0];vertices[y]-=origin[1];vertices[z]-=origin[2];mmX.consider(vertices[x]);mmY.consider(vertices[y]);mmZ.consider(vertices[z])}gRenderer.CCUpdateVertexBuffer(this.vertexPositionBuffer,vertices);this.movedToOrigin=true}if(callback){callback()}};CCPrimitive3D.prototype.hasMovedToOrigin=function(){return this.movedToOrigin};CCPrimitive3D.Objects=[];CCPrimitive3D.Loaded=function(primitiveID,json){var Objects=CCPrimitive3D.Objects;for(var i=0;i<Objects.length;++i){var primitive=Objects[i];if(primitive.primitiveID===primitiveID){primitive.loaded(json);break}}};CCPrimitive3D.LoadedAnimation=function(primitiveID,name){var Objects=CCPrimitive3D.Objects;for(var i=0;i<Objects.length;++i){var primitive=Objects[i];if(primitive.primitiveID===primitiveID){primitive.loadedAnimation(name);break}}};CCPrimitive3D.LoadedAnimationFrame=function(primitiveID,array){var Objects=CCPrimitive3D.Objects;for(var i=0;i<Objects.length;++i){var primitive=Objects[i];if(primitive.primitiveID===primitiveID){primitive.loadedAnimationFrame(array);break}}};CCPrimitive3D.prototype.adjustTextureUVs=function(){if(CCEngine.NativeUpdateCommands!==undefined){if(this.textureIndex>=0){CCEngine.NativeUpdateCommands+="CCPrimitiveBase.adjustTextureUVs;"+this.primitiveID+";"+this.textureIndex+"\n"}}};CCPrimitive3D.prototype.moveVerticesToOrigin=function(callback){if(!this.movedToOrigin){this.getOrigin();CCEngine.NativeUpdateCommands+="CCPrimitive3D.moveVerticesToOrigin;"+this.primitiveID+"\n";if(callback){this.moveVerticesToOriginCallback=callback}}else{if(callback){callback()}}};CCPrimitive3D.MovedVerticesToOrigin=function(primitiveID,json){var Objects=CCPrimitive3D.Objects;for(var i=0;i<Objects.length;++i){var primitive=Objects[i];if(primitive.primitiveID===primitiveID){primitive.movedVerticesToOrigin(json);break}}};CCPrimitive3D.prototype.movedVerticesToOrigin=function(json){var callback=this.moveVerticesToOriginCallback;if(this.moveVerticesToOriginCallback){delete this.moveVerticesToOriginCallback}if(json){this.mmX.min=json.mmXmin;this.mmX.max=json.mmXmax;this.mmY.min=json.mmYmin;this.mmY.max=json.mmYmax;this.mmZ.min=json.mmZmin;this.mmZ.max=json.mmZmax}this.movedToOrigin=true;if(callback){callback()}};CCPrimitive3D.prototype.getYMinMaxAtZ=function(atZ,callback){if(callback){this.getYMinMaxAtZCallback=callback;CCEngine.NativeUpdateCommands+="CCPrimitive3D.getYMinMaxAtZ;"+this.primitiveID+";";if(this.sourcePrimitiveID!==undefined){CCEngine.NativeUpdateCommands+=this.sourcePrimitiveID}else{CCEngine.NativeUpdateCommands+=this.primitiveID}CCEngine.NativeUpdateCommands+=";"+atZ+"\n"}};CCPrimitive3D.ReturnYMinMaxAtZ=function(primitiveID,json){var Objects=CCPrimitive3D.Objects;for(var i=0;i<Objects.length;++i){var primitive=Objects[i];if(primitive.primitiveID===primitiveID){primitive.returnYMinMaxAtZ(json);break}}};CCPrimitive3D.prototype.returnYMinMaxAtZ=function(json){if(this.getYMinMaxAtZCallback){var callback=this.getYMinMaxAtZCallback;delete this.getYMinMaxAtZCallback;var mmYAtZ=new CCMinMax;mmYAtZ.min=json.min;mmYAtZ.max=json.max;callback(mmYAtZ)}};function CCFBXSubModel(parent){this.parent=parent}CCFBXSubModel.prototype.loadJSON=function(json){var i;this.name=json.name;var submeshes=json.submeshes;this.submeshes=[];for(i=0;i<submeshes.length;++i){this.submeshes.push(submeshes[i])}var vertices=json.vertices;if(vertices.length<3){return 0}var vertexCount=this.vertexCount=vertices.length/3;this.vertices=CCRenderer.NewArrayType(vertices,CCRenderer.Float32Array);this.skinnedVertices=CCRenderer.NewArrayType(vertices,CCRenderer.Float32Array);this.vertexPositionBuffer=gRenderer.CCCreateVertexBuffer(this.skinnedVertices);this.normals=json.normals;var indices=json.indices;this.indices=CCRenderer.NewArrayType(indices,CCRenderer.Uint16Array);this.vertexIndexBuffer=gRenderer.CCCreateVertexIndexBuffer(this.indices);var uvs=json.uvs;if(!uvs){uvs=new Array(vertexCount*2);for(i=0;i<vertexCount*2;++i){uvs[i]=0}}this.modelUVs=CCRenderer.NewArrayType(uvs,CCRenderer.Float32Array);this.vertexTextureBuffer=gRenderer.CCCreateVertexBuffer(this.modelUVs,2);return vertexCount};function CCPrimitiveFBX(){this.construct();this.animationFPS=30;this.animationFPSCompression=5;this.setAnimation(0)}ExtendPrototype(CCPrimitiveFBX,CCPrimitive3D);CCPrimitiveFBX.prototype.construct=function(){this.CCPrimitive3D_construct();if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCPrimitiveFBX.construct;"+this.primitiveID+"\n"}};CCPrimitiveFBX.prototype.destruct=function(){if(!this.cached){if(this.submodels){var submodels=this.submodels;for(var submodelIndex=0;submodelIndex<submodels.length;++submodelIndex){var submodel=submodels[submodelIndex];if(submodel.vertexIndexBuffer){gRenderer.CCDeleteVertexBuffer(submodel.vertexIndexBuffer)}if(submodel.vertexPositionBuffer){gRenderer.CCDeleteVertexBuffer(submodel.vertexPositionBuffer)}if(submodel.vertexTextureBuffer){gRenderer.CCDeleteVertexBuffer(submodel.vertexTextureBuffer)}}}}this.CCPrimitive3D_destruct();if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCPrimitiveFBX.destruct;"+this.primitiveID+"\n"}};CCPrimitiveFBX.prototype.loadData=function(fileData,callback){if(fileData){this.fileSize=fileData.length;var windowURL=window.URL||window.webkitURL;if(window.Worker&&windowURL&&windowURL.createObjectURL){var self=this;if(!CCPrimitiveFBX.workerJSONParse){var blob=new Blob(["self.addEventListener( 'message', function (e) {       var data = e.data;      if( data.loadData )     {           var json = JSON.parse( data.loadData );         self.postMessage( json );       }       else if( data.close )     {           self.close();       }   }, false );"],{type:"text/javascript"});var blobURL=windowURL.createObjectURL(blob);CCPrimitiveFBX.workerJSONParse=new Worker(blobURL)}if(window.DEBUG_IsLocalClient){}var worker=CCPrimitiveFBX.workerJSONParse;worker.onmessage=function(e){if(window.DEBUG_IsLocalClient){}var json=e.data;CCEngine.RunNextUpdate(function(){self.loadJSON(json,callback)})};worker.postMessage({loadData:fileData});return}else{var json=JSON.parse(fileData);this.loadJSON(json,callback)}}else{this.loaded(callback)}};CCPrimitiveFBX.prototype.loadJSON=function(json,callback){if(json){var i;if(json.materials){this.materials=json.materials}if(json.models&&json.models.length>0){this.submodels=[];for(i=0;i<json.models.length;++i){var model=json.models[i];if(model.submeshes&&model.vertices){var submodel=new CCFBXSubModel(this);var vertexCount=submodel.loadJSON(model);if(vertexCount>0){this.vertexCount+=vertexCount;this.submodels.push(submodel)}}}}if(json.animations){this.animations=json.animations;if(json.animationFPS){this.animationFPS=json.animationFPS}if(json.animationFPSCompression){this.animationFPSCompression=json.animationFPSCompression}this.setAnimation(0);this.nextFrame()}var self=this;this.calculateMinMaxAsync(function(){self.width=self.mmX.size();self.height=self.mmY.size();self.depth=self.mmZ.size();self.loaded(callback)});return}this.loaded(callback)};CCPrimitiveFBX.prototype.loaded=function(callback){callback(this.vertexCount>0)};CCPrimitiveFBX.prototype.render=function(){if(CCEngine.NativeUpdateCommands!==undefined){gRenderer.unbindBuffers();CCEngine.NativeRenderCommands+="CCPrimitiveFBX.render;"+this.primitiveID+"\n"}else{if(this.textureIndex!==-1){gEngine.textureManager.setTextureIndex(this.textureIndex)}else{gEngine.textureManager.setTextureIndex(1)}this.renderVertices(gRenderer)}};CCPrimitiveFBX.prototype.renderVertices=function(renderer){renderer.CCSetRenderStates();var submodels=this.submodels;for(var submodelIndex=0;submodelIndex<submodels.length;++submodelIndex){var submodel=submodels[submodelIndex];if(submodel.disabled){continue}if(submodel.vertexTextureBuffer){renderer.CCBindVertexTextureBuffer(submodel.vertexTextureBuffer)}renderer.CCBindVertexPositionBuffer(submodel.vertexPositionBuffer);renderer.CCBindVertexIndexBuffer(submodel.vertexIndexBuffer);var submeshes=submodel.submeshes;for(var i=0;i<submeshes.length;++i){var submesh=submeshes[i];renderer.GLDrawElements("TRIANGLES",submesh.count,submesh.offset)}}};CCPrimitiveFBX.prototype.getYMinMaxAtZ=function(atZ,callback){var mmYAtZ=new CCMinMax;callback(mmYAtZ)};CCPrimitiveFBX.prototype.calculateMinMaxAsync=function(callback){var self=this;CCEngine.RunNextUpdate(function(){self.calculateMinMax();if(callback){callback()}})};CCPrimitiveFBX.prototype.calculateMinMaxWorker=function(callback){var windowURL=window.URL||window.webkitURL;if(window.Worker&&windowURL&&windowURL.createObjectURL){var self=this;if(!CCPrimitiveFBX.workerCalculateMinMax){var blob=new Blob(["function calculateMinMax(mmX, mmY, mmZ, submodels, animations) {      var submodelsLength;     var submodelIndex;     var submodel;      var MathMin = Math.min;     var MathMax = Math.max;     var x, y, z;      if( animations && animations.length > 0 )     {         var animation = animations[0];         var frames = animation.frames;         if( frames && frames.length > 0 )         {             var animationFrameSubmodels = frames[0];             var animationFrameSubmodelsLength = animationFrameSubmodels.length;             if( animationFrameSubmodels && animationFrameSubmodelsLength > 0 )             {                 for( var iSubmodel=0; iSubmodel<animationFrameSubmodelsLength; ++iSubmodel )                 {                     var animationSubmodel = animationFrameSubmodels[iSubmodel];                     var v = animationSubmodel.v;                     if( !v )                     {                         submodelsLength = submodels.length;                         for( submodelIndex=0; submodelIndex<submodelsLength; ++submodelIndex )                         {                             submodel = submodels[submodelIndex];                             if( submodel.name === animationSubmodel.n )                             {                                 v = submodel.vertices;                                 break;                             }                         }                     }                     if( v )                     {                         var vLength = v.length;                         for( var vertexIndex=0; vertexIndex<vLength; vertexIndex+=3 )                         {                             x = v[vertexIndex+0];                             y = v[vertexIndex+1];                             z = v[vertexIndex+2];                              mmX.min = MathMin( mmX.min, x );                             mmX.max = MathMax( mmX.max, x );                              mmY.min = MathMin( mmY.min, y );                             mmY.max = MathMax( mmY.max, y );                              mmZ.min = MathMin( mmZ.min, z );                             mmZ.max = MathMax( mmZ.max, z );                         }                     }                 }                 return;             }         }     }      if( submodels )     {         submodelsLength = submodels.length;         for( submodelIndex=0; submodelIndex<submodelsLength; ++submodelIndex )         {             submodel = submodels[submodelIndex];             var vertices = submodel.vertices;             var vertexCount = submodel.vertexCount;             for( var i=0; i<vertexCount; ++i )             {                 var index = i*3;                  x = vertices[index+0];                 y = vertices[index+1];                 z = vertices[index+2];                  mmX.min = MathMin( mmX.min, x );                 mmX.max = MathMax( mmX.max, x );                  mmY.min = MathMin( mmY.min, y );                 mmY.max = MathMax( mmY.max, y );                  mmZ.min = MathMin( mmZ.min, z );                 mmZ.max = MathMax( mmZ.max, z );             }         }     } };  self.addEventListener( 'message', function (e) {     var data = e.data.data;       var mmX = data.mmX;     var mmY = data.mmY;     var mmZ = data.mmZ;     var submodels = data.submodels;     var animations = data.animations;      calculateMinMax( mmX, mmY, mmZ, submodels, animations );     var result = {};     result.mmX = mmX;     result.mmY = mmY;     result.mmZ = mmZ;     self.postMessage( result ); }, false );"],{type:"text/javascript"});var blobURL=windowURL.createObjectURL(blob);CCPrimitiveFBX.workerCalculateMinMax=new Worker(blobURL)}if(window.DEBUG_IsLocalClient){}var worker=CCPrimitiveFBX.workerCalculateMinMax;var self=this;worker.onmessage=function(e){if(window.DEBUG_IsLocalClient){}var result=e.data;self.mmX.min=result.mmX.min;self.mmX.max=result.mmX.max;self.mmY.min=result.mmY.min;self.mmY.max=result.mmY.max;self.mmZ.min=result.mmZ.min;self.mmZ.max=result.mmZ.max;if(callback){callback()}};this.mmX.reset();this.mmY.reset();this.mmZ.reset();var data={};data.mmX=this.mmX;data.mmY=this.mmY;data.mmZ=this.mmZ;data.submodels=this.animations;data.animations=this.animations;worker.postMessage({data:data});return}else{this.calculateMinMax()}};CCPrimitiveFBX.prototype.calculateMinMax=function(){var mmX=this.mmX;var mmY=this.mmY;var mmZ=this.mmZ;mmX.reset();mmY.reset();mmZ.reset();var submodels=this.submodels;var submodelsLength;var submodelIndex;var submodel;var MathMin=Math.min;var MathMax=Math.max;var x,y,z;var animations=this.animations;if(animations&&animations.length>0){var animation=animations[0];var frames=animation.frames;if(frames&&frames.length>0){var animationFrameSubmodels=frames[0];var animationFrameSubmodelsLength=animationFrameSubmodels.length;if(animationFrameSubmodels&&animationFrameSubmodelsLength>0){for(var iSubmodel=0;iSubmodel<animationFrameSubmodelsLength;++iSubmodel){var animationSubmodel=animationFrameSubmodels[iSubmodel];var v=animationSubmodel.v;if(!v){submodelsLength=submodels.length;for(submodelIndex=0;submodelIndex<submodelsLength;++submodelIndex){submodel=submodels[submodelIndex];if(submodel.name===animationSubmodel.n){v=submodel.vertices;break}}}if(v){var vLength=v.length;for(var vertexIndex=0;vertexIndex<vLength;vertexIndex+=3){x=v[vertexIndex+0];y=v[vertexIndex+1];z=v[vertexIndex+2];mmX.min=MathMin(mmX.min,x);mmX.max=MathMax(mmX.max,x);mmY.min=MathMin(mmY.min,y);mmY.max=MathMax(mmY.max,y);mmZ.min=MathMin(mmZ.min,z);mmZ.max=MathMax(mmZ.max,z)}}}return}}}if(submodels){submodelsLength=submodels.length;for(submodelIndex=0;submodelIndex<submodelsLength;++submodelIndex){submodel=submodels[submodelIndex];var vertices=submodel.vertices;var vertexCount=submodel.vertexCount;for(var i=0;i<vertexCount;++i){var index=i*3;x=vertices[index+0];y=vertices[index+1];z=vertices[index+2];mmX.min=MathMin(mmX.min,x);mmX.max=MathMax(mmX.max,x);mmY.min=MathMin(mmY.min,y);mmY.max=MathMax(mmY.max,y);mmZ.min=MathMin(mmZ.min,z);mmZ.max=MathMax(mmZ.max,z)}}}};CCPrimitiveFBX.prototype.moveVerticesToOrigin=function(callback){if(!this.movedToOrigin){var origin=this.getOrigin();var animations=this.animations;if(animations){var animationsLength=animations.length;for(var animationIndex=0;animationIndex<animationsLength;++animationIndex){var animation=animations[animationIndex];var frames=animation.frames;if(frames){var framesLength=frames.length;for(var frameIndex=0;frameIndex<framesLength;++frameIndex){var animationFrameSubmodels=animation.frames[frameIndex];for(var iSubmodel=0;iSubmodel<animationFrameSubmodels.length;++iSubmodel){var animationSubmodel=animationFrameSubmodels[iSubmodel];var v=animationSubmodel.v;if(v){var vLength=v.length;for(var vertexIndex=0;vertexIndex<vLength;vertexIndex+=3){v[vertexIndex+0]-=origin[0];v[vertexIndex+1]-=origin[1];v[vertexIndex+2]-=origin[2]}}}}}}}var submodels=this.submodels;var submodelsLength;for(var submodelIndex=0;submodelIndex<submodelsLength;++submodelIndex){var submodel=submodels[submodelIndex];var vertices=submodel.vertices;var skinnedVertices=submodel.skinnedVertices;var vertexCount=submodel.vertexCount;for(var i=0;i<vertexCount;++i){var index=i*3;var x=index+0;var y=index+1;var z=index+2;vertices[x]-=origin[0];vertices[y]-=origin[1];vertices[z]-=origin[2];skinnedVertices[x]-=origin[0];skinnedVertices[y]-=origin[1];skinnedVertices[z]-=origin[2]}gRenderer.CCUpdateVertexBuffer(submodel.vertexPositionBuffer,skinnedVertices)}var self=this;this.calculateMinMaxAsync(function(){self.movedToOrigin=true;if(callback){callback()}});return}if(callback){callback()}};CCPrimitiveFBX.prototype.copy=function(sourcePrimitive){this.filename=sourcePrimitive.filename;this.fileSize=sourcePrimitive.fileSize;if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCPrimitiveFBX.copy;"+this.primitiveID+";"+sourcePrimitive.primitiveID+"\n"}else{var submodels=this.submodels=[];var sourceSubmodels=sourcePrimitive.submodels;var sourceSubmodelsLength=sourcePrimitive.submodels.length;for(var submodelIndex=0;submodelIndex<sourceSubmodelsLength;++submodelIndex){var sourceSubmodel=sourcePrimitive.submodels[submodelIndex];var submodel={};submodels.push(submodel);submodel.name=sourceSubmodel.name;submodel.submeshes=[];for(i=0;i<sourceSubmodel.submeshes.length;++i){submodel.submeshes.push(sourceSubmodel.submeshes[i])}submodel.vertexCount=sourceSubmodel.vertexCount;submodel.vertices=sourceSubmodel.vertices;submodel.normals=sourceSubmodel.normals;submodel.skinnedVertices=CCRenderer.NewArrayType(submodel.vertices,CCRenderer.Float32Array);submodel.vertexPositionBuffer=gRenderer.CCCreateVertexBuffer(submodel.skinnedVertices);submodel.indices=sourceSubmodel.indices;submodel.vertexIndexBuffer=sourceSubmodel.vertexIndexBuffer;submodel.modelUVs=sourceSubmodel.modelUVs;submodel.vertexTextureBuffer=sourceSubmodel.vertexTextureBuffer}this.sourcePrimitive=sourcePrimitive}this.sourcePrimitiveID=sourcePrimitive.primitiveID;this.materials=sourcePrimitive.materials;this.animations=sourcePrimitive.animations;this.animationFPS=sourcePrimitive.animationFPS;this.animationFPSCompression=sourcePrimitive.animationFPSCompression;this.setAnimation(0);this.nextFrame();this.vertexCount=sourcePrimitive.vertexCount;this.width=sourcePrimitive.width;this.height=sourcePrimitive.height;this.depth=sourcePrimitive.depth;this.mmX=sourcePrimitive.mmX;this.mmY=sourcePrimitive.mmY;this.mmZ=sourcePrimitive.mmZ;this.cached=true;this.movedToOrigin=sourcePrimitive.movedToOrigin;this.origin=sourcePrimitive.origin};CCPrimitiveFBX.prototype.getAnimation=function(){if(this.nextNextAnimationIndex!==undefined){return this.nextNextAnimationIndex}return this.nextAnimationIndex};CCPrimitiveFBX.prototype.getAnimationFrame=function(){if(this.lockedAnimationFrameIndex!==undefined){return this.lockedAnimationFrameIndex}return-1};CCPrimitiveFBX.prototype.getAnimationNumberOfFrames=function(){return this.numberOfFrames
};CCPrimitiveFBX.prototype.getAnimationFPSCompression=function(){return this.animationFPSCompression};CCPrimitiveFBX.prototype.setAnimation=function(index){this.currentAnimationIndex=index;this.currentFrameIndex=0;this.nextAnimationIndex=index;this.nextFrameIndex=0;this.frameDelta=0;this.frameSpeed=this.animationFPS/this.animationFPSCompression;this.numberOfFrames=0;if(this.animations&&this.animations.length>0&&this.nextAnimationIndex<this.animations.length){var animations=this.animations;var nextAnimation=animations[this.nextAnimationIndex];if(nextAnimation){var frames=nextAnimation.frames;this.numberOfFrames=frames.length}}if(this.lockedAnimationFrameIndex!==undefined){delete this.lockedAnimationFrameIndex}this.setAnimationFrame(0)};CCPrimitiveFBX.prototype.setAnimationFrame=function(index){if(this.animations&&this.animations.length>0){var currentAnimationIndex;if(this.nextNextAnimationIndex!==undefined){currentAnimationIndex=this.nextNextAnimationIndex}else{currentAnimationIndex=this.nextAnimationIndex}if(currentAnimationIndex>=this.animations.length){currentAnimationIndex=0}this.interpolateFrames(currentAnimationIndex,index,currentAnimationIndex,index,0)}};CCPrimitiveFBX.prototype.setNextAnimationFrame=function(index){this.nextFrameIndex=index};CCPrimitiveFBX.prototype.toggleAnimationFrame=function(index){if(index<0){index=0}if(index>this.numberOfFrames-1){index=this.numberOfFrames-1}if(this.lockedAnimationFrameIndex!==undefined){if(this.lockedAnimationFrameIndex===index){this.setAnimationFrame(index);this.setNextAnimationFrame(index);delete this.lockedAnimationFrameIndex;return}}this.lockedAnimationFrameIndex=index;this.setAnimationFrame(index)};CCPrimitiveFBX.prototype.setNextAnimation=function(index){this.nextNextAnimationIndex=index;if(this.lockedAnimationFrameIndex!==undefined){delete this.lockedAnimationFrameIndex}};CCPrimitiveFBX.prototype.nextFrame=function(repeat){if(this.animations&&this.animations.length>0&&this.nextAnimationIndex<this.animations.length){this.currentFrameIndex=this.nextFrameIndex;this.currentAnimationIndex=this.nextAnimationIndex;this.nextFrameIndex++;if(this.nextNextAnimationIndex!==undefined&&this.nextAnimationIndex!=this.nextNextAnimationIndex){this.nextAnimationIndex=this.nextNextAnimationIndex;this.nextFrameIndex=0}var animations=this.animations;var nextAnimation=animations[this.nextAnimationIndex];if(nextAnimation){var frames=nextAnimation.frames;if(frames&&frames.length>0){if(this.nextFrameIndex>=frames.length){if(repeat){this.nextFrameIndex=0}else{this.nextFrameIndex=frames.length-1}}}}}};CCPrimitiveFBX.prototype.animateForDuration=function(delta,repeat,duration){if(this.lockedAnimationFrameIndex!==undefined){return}if(this.animations&&this.animations.length>0&&this.currentAnimationIndex<this.animations.length){this.frameDelta+=delta*this.numberOfFrames*duration;if(this.frameDelta>=1){this.frameDelta=0;this.nextFrame(repeat)}this.interpolateFrames(this.currentAnimationIndex,this.currentFrameIndex,this.nextAnimationIndex,this.nextFrameIndex,this.frameDelta)}};CCPrimitiveFBX.prototype.animate=function(delta,repeat){if(this.lockedAnimationFrameIndex!==undefined){return}if(this.animations&&this.animations.length>0&&this.currentAnimationIndex<this.animations.length){this.frameDelta+=delta*this.frameSpeed;if(this.frameDelta>=1){this.frameDelta=0;this.nextFrame(repeat)}this.interpolateFrames(this.currentAnimationIndex,this.currentFrameIndex,this.nextAnimationIndex,this.nextFrameIndex,this.frameDelta)}};CCPrimitiveFBX.prototype.interpolateFrames=function(currentAnimationIndex,currentFrameIndex,nextAnimationIndex,nextFrameIndex,frameDelta){if(this.submodels){var submodels=this.submodels;var submodelsLength=this.submodels.length;var currentAnimation=this.animations[currentAnimationIndex];var nextAnimation=this.animations[nextAnimationIndex];if(currentAnimation&&nextAnimation){if(currentAnimation.frames&&nextAnimation.frames){var currentFrame=currentAnimation.frames[currentFrameIndex];var nextFrame=nextAnimation.frames[nextFrameIndex];for(var submodelIndex=0;submodelIndex<submodelsLength;++submodelIndex){var submodel=submodels[submodelIndex];var currentFrameVertices=this.getAnimationFrameSubmodelVertices(submodel.name,currentFrame);var nextFrameVertices=this.getAnimationFrameSubmodelVertices(submodel.name,nextFrame);if(currentFrameVertices&&nextFrameVertices){var inverseDelta=1-frameDelta;var skinnedVertices=submodel.skinnedVertices;var skinnedVerticesLength=skinnedVertices.length;for(var vertIndex=0;vertIndex<skinnedVerticesLength;++vertIndex){var interpolatedVert=currentFrameVertices[vertIndex]*inverseDelta+nextFrameVertices[vertIndex]*frameDelta;skinnedVertices[vertIndex]=interpolatedVert}gRenderer.CCUpdateVertexBuffer(submodel.vertexPositionBuffer,skinnedVertices)}}}}}};CCPrimitiveFBX.prototype.getAnimationFrameSubmodelVertices=function(submodelName,frame){if(frame){var frameLength=frame.length;for(var iSubmodel=0;iSubmodel<frameLength;++iSubmodel){if(frame[iSubmodel].n===submodelName){return frame[iSubmodel].v}}}return null};CCPrimitiveFBX.prototype.unlockAnimationsData=function(){if(this.sourcePrimitive&&this.sourcePrimitive.animations===this.animations){this.animations=CC.DeepCopy(this.animations)}};CCPrimitiveFBX.prototype.deleteAnimation=function(animationName){this.unlockAnimationsData();var animations=this.animations;for(var i=0;i<animations.length;++i){if(animations[i].name===animationName){animations.remove(animations[i]);this.setAnimation(0);return true}}return false};CCPrimitiveFBX.prototype.moveAnimationFrame=function(oldIndex,newIndex){this.unlockAnimationsData();if(this.lockedAnimationFrameIndex!==undefined){delete this.lockedAnimationFrameIndex}var currentAnimation=this.animations[this.currentAnimationIndex];var frames=currentAnimation.frames;if(oldIndex>=0&&oldIndex<frames.length&&newIndex>=0&&newIndex<frames.length){var frame=frames[oldIndex];frames.insert(frame,newIndex);return true}return false};CCPrimitiveFBX.prototype.deleteAnimationFrame=function(index){if(this.lockedAnimationFrameIndex!==undefined){delete this.lockedAnimationFrameIndex}var currentAnimation=this.animations[this.currentAnimationIndex];var frames=currentAnimation.frames;if(index>=0&&index<frames.length){frames.remove(frames[index]);return true}return false};CCPrimitiveFBX.prototype.toggleSubmodel=function(submodelName){var submodels=this.submodels;var i,submodel;for(i=0;i<submodels.length;++i){if(submodels[i].name===submodelName){submodel=submodels[i]}}if(submodel){if(submodel.disabled){delete submodel.disabled}else{submodel.disabled=true}}};CCPrimitiveFBX.prototype.deleteSubmodel=function(submodelName){var submodels=this.submodels;var i,submodel;for(i=0;i<submodels.length;++i){if(submodels[i].name===submodelName){submodel=submodels[i]}}if(submodel){submodels.remove(submodel);var animations=this.animations;for(i=0;i<animations.length;++i){var animation=animations[i];var frames=animation.frames;for(var iFrame=0;iFrame<frames.length;++iFrame){var animationFrameSubmodels=frames[iFrame];for(var iSubmodel=0;iSubmodel<animationFrameSubmodels.length;++iSubmodel){var animationSubmodel=animationFrameSubmodels[iSubmodel];var animationSubmodelName=animationSubmodel.n;if(animationSubmodelName===submodelName){animationFrameSubmodels.remove(animationSubmodel);--iSubmodel}}}}return true}return false};CCPrimitiveFBX.prototype.exportJSONString=function(callback){var i;var json={};json.animationFPS=this.animationFPS;json.animationFPSCompression=this.animationFPSCompression;json.materials=this.materials;json.models=[];var submodels=this.submodels;for(i=0;i<submodels.length;++i){var submodel=submodels[i];var model={};model.name=submodel.name;model.submeshes=submodel.submeshes;var iVert;model.vertices=[];for(iVert=0;iVert<submodel.vertices.length;++iVert){model.vertices.push(submodel.vertices[iVert])}model.normals=submodel.normals;model.uvs=[];for(iVert=0;iVert<submodel.modelUVs.length;++iVert){model.uvs.push(submodel.modelUVs[iVert])}model.indices=[];for(iVert=0;iVert<submodel.indices.length;++iVert){model.indices.push(submodel.indices[iVert])}json.models.push(model)}json.animations=this.animations;CCFileManager.Stringify(json,function(string){callback(string)})};function CCPrimitiveOBJ(){this.construct()}ExtendPrototype(CCPrimitiveOBJ,CCPrimitive3D);CCPrimitiveOBJ.prototype.loadData=function(fileData,callback){var objMesh=ObjMesh.LoadOBJ(fileData);if(objMesh){this.fileSize=fileData.length;var mmX=this.mmX;var mmY=this.mmY;var mmZ=this.mmZ;var i,pf,j,index,texCoord,vertex;for(i=0;i<objMesh.m_iNumberOfFaces;++i){pf=objMesh.m_aFaces[i];if(pf.m_iVertexCount>=3){var faceVertexCount=pf.m_iVertexCount;do{this.vertexCount+=3;faceVertexCount--}while(faceVertexCount>=3)}}var modelUVs=this.modelUVs=new CCRenderer.Float32Array(this.vertexCount*2);var modelVertices=this.vertices=new CCRenderer.Float32Array(this.vertexCount*3);var modelNormals=this.normals=new CCRenderer.Float32Array(this.vertexCount*3);var uvIndex=0;var vertexIndex=0;for(i=0;i<objMesh.m_iNumberOfFaces;++i){pf=objMesh.m_aFaces[i];if(pf.m_iVertexCount<3){continue}var vertexStartIterator=1;var vertexEndIterator=2;do{{j=0;if(objMesh.m_aTexCoordArray){index=pf.m_aTexCoordIndicies[j];if(index>=0&&index<objMesh.m_iNumberOfTexCoords){texCoord=objMesh.m_aTexCoordArray[index];modelUVs[uvIndex+0]=texCoord.u;modelUVs[uvIndex+1]=1-texCoord.v}}{index=pf.m_aVertexIndices[j];vertex=objMesh.m_aVertexArray[index];modelVertices[vertexIndex+0]=vertex.x;modelVertices[vertexIndex+1]=vertex.y;modelVertices[vertexIndex+2]=vertex.z;mmX.consider(vertex.x);mmY.consider(vertex.y);mmZ.consider(vertex.z)}if(objMesh.m_aNormalArray){index=pf.m_aNormalIndices[j];if(index>=0&&index<objMesh.m_iNumberOfNormals){var normal=objMesh.m_aNormalArray[index];modelNormals[vertexIndex+0]=normal.x;modelNormals[vertexIndex+1]=normal.y;modelNormals[vertexIndex+2]=normal.z}}uvIndex+=2;vertexIndex+=3}for(j=vertexStartIterator;j<=vertexEndIterator;++j){if(objMesh.m_aTexCoordArray){index=pf.m_aTexCoordIndicies[j];if(index>=0&&index<objMesh.m_iNumberOfTexCoords){texCoord=objMesh.m_aTexCoordArray[index];modelUVs[uvIndex+0]=texCoord.u;modelUVs[uvIndex+1]=1-texCoord.v}}{index=pf.m_aVertexIndices[j];vertex=objMesh.m_aVertexArray[index];modelVertices[vertexIndex+0]=vertex.x;modelVertices[vertexIndex+1]=vertex.y;modelVertices[vertexIndex+2]=vertex.z;mmX.consider(vertex.x);mmY.consider(vertex.y);mmZ.consider(vertex.z)}uvIndex+=2;vertexIndex+=3}vertexStartIterator++;vertexEndIterator++}while(vertexEndIterator<pf.m_iVertexCount)}this.width=mmX.size();this.height=mmY.size();this.depth=mmZ.size();this.vertexPositionBuffer=gRenderer.CCCreateVertexBuffer(modelVertices);this.vertexTextureBuffer=gRenderer.CCCreateVertexBuffer(modelUVs,2)}callback(this.vertexCount>0)};CCPrimitiveOBJ.prototype.render=function(){if(this.textureIndex!==-1){gEngine.textureManager.setTextureIndex(this.textureIndex)}else{gEngine.textureManager.setTextureIndex(1)}this.renderVertices(gRenderer)};CCPrimitiveOBJ.prototype.renderVertices=function(renderer){if(this.vertexCount>0){renderer.CCSetRenderStates();renderer.CCBindVertexTextureBuffer(this.vertexTextureBuffer);renderer.CCBindVertexPositionBuffer(this.vertexPositionBuffer);renderer.GLDrawArrays("TRIANGLES",0,this.vertexCount)}};CCPrimitiveOBJ.prototype.copy=function(sourcePrimitive){this.filename=sourcePrimitive.filename;this.fileSize=sourcePrimitive.fileSize;this.sourcePrimitiveID=sourcePrimitive.primitiveID;this.vertexPositionBuffer=sourcePrimitive.vertexPositionBuffer;this.vertexTextureBuffer=sourcePrimitive.vertexTextureBuffer;this.vertexCount=sourcePrimitive.vertexCount;this.modelUVs=sourcePrimitive.modelUVs;this.vertices=sourcePrimitive.vertices;this.normals=sourcePrimitive.normals;this.width=sourcePrimitive.width;this.height=sourcePrimitive.height;this.depth=sourcePrimitive.depth;this.mmX=sourcePrimitive.mmX;this.mmY=sourcePrimitive.mmY;this.mmZ=sourcePrimitive.mmZ;this.cached=true;this.movedToOrigin=sourcePrimitive.movedToOrigin;this.origin=sourcePrimitive.origin;if(CCEngine.NativeUpdateCommands!==undefined){this.vertexTextureBuffer=gRenderer.CCCreateVertexBuffer();CCEngine.NativeUpdateCommands+="CCPrimitiveOBJ.copy;"+this.primitiveID+";"+sourcePrimitive.primitiveID+";"+this.vertexTextureBuffer+"\n"}};function CCTextureManager(){this.fontPages=[];this.currentTextureIndex=-1;this.textureHandles=[];this.assignTextureIndex("transparent.png");this.assignTextureIndex("white.png");this.setTextureIndex(1)}CCTextureManager.prototype.loadFont=function(font){var fontPage=new CCTextureFontPageFile(font);fontPage.load();this.fontPages.push(fontPage);if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCTextureManager.loadFont;"+font+"\n"}};CCTextureManager.prototype.getTextureHandleIndex=function(index){var textureHandles=this.textureHandles;if(index>=0&&index<textureHandles.length){var texture=textureHandles[index];return texture}return null};CCTextureManager.prototype.getTextureHandleIndexAsync=function(index,onDownloadedCallback){var handle=this.textureHandles[index];if(handle.downloaded){if(onDownloadedCallback){onDownloadedCallback(handle)}}else if(onDownloadedCallback){if(!handle.onDownload){handle.onDownload=[]}handle.onDownload.push(onDownloadedCallback)}};CCTextureManager.prototype.getTextureHandle=function(src,onDownloadedCallback){var textureHandleIndex=this.assignTextureIndex(src);this.getTextureHandleIndexAsync(textureHandleIndex,onDownloadedCallback)};CCTextureManager.ValidateImageResolution=function(base64Data,targetEncoding,maxResolution,callback){AlertsManager.ModalAlert("processing...");var image=new Image;image.onload=function(){var validatedData=base64Data;if(image.width>maxResolution||image.height>maxResolution){var canvas=document.createElement("canvas");if(image.width>maxResolution){canvas.width=maxResolution;canvas.height=image.height/image.width*maxResolution}else if(image.height>maxResolution){canvas.width=image.width/image.height*maxResolution;canvas.height=maxResolution}var ctx=canvas.getContext("2d");ctx.drawImage(image,0,0,canvas.width,canvas.height);validatedData=canvas.toDataURL(targetEncoding)}AlertsManager.Hide("processing...");callback(validatedData)};image.onabort=function(){AlertsManager.Hide("processing...");callback()};image.onerror=function(){AlertsManager.Hide("processing...");callback()};image.src=base64Data};CCTextureManager.ConvertBase64Image=function(base64Data,callback){var image=new Image;image.onload=function(){var canvas=document.createElement("canvas");canvas.width=image.width;canvas.height=image.height;var ctx=canvas.getContext("2d");ctx.drawImage(image,0,0);var dataURL=canvas.toDataURL("image/jpeg");callback(dataURL)};image.onabort=function(){callback()};image.onerror=function(){callback()};image.src=base64Data};CCTextureManager.ConvertImage=function(image,format,tiling,callback){var canvas=document.createElement("canvas");canvas.width=image.width;canvas.height=image.height;if(tiling>0){var newWidth=image.width/tiling;var newHeight=image.height/tiling;var ctx=canvas.getContext("2d");var y=0;while(y<canvas.height){var x=0;while(x<canvas.width){ctx.drawImage(image,x,y,newWidth,newHeight);x+=newWidth}y+=newHeight}}if(format==="jpg"){callback(canvas.toDataURL("image/jpeg"))}else if(format==="png"){callback(canvas.toDataURL("image/png"))}else{callback(false)}};function CCSceneBase(){this.construct()}CCSceneBase.NextSceneID=0;CCSceneBase.prototype.construct=function(){this.sceneID=CCSceneBase.NextSceneID++;CCEngine.NewScene(this);this.enabled=true;this.deletingScene=false;this.objects=[];this.collideables=[];if(!this.parentScene){this.parentScene=null}this.linkedScenes=[];this.lifetime=0};CCSceneBase.prototype.destruct=function(){this.deleteLater();var objects=this.objects;while(objects.length>0){objects[0].destruct()}this.enabled=false};CCSceneBase.prototype.deleteLater=function(){MultiplayerManager.UpdateCallbacks.remove(this);CCEngine.DisableBackButton(this);var collideables=this.collideables;for(var i=0;i<collideables.length;++i){var collideable=collideables[i];collideable.collideableType=CC.collision_none}this.deletingScene=true;this.deleteLinkedScenesLater();if(this.parentScene){this.parentScene.deletingChild(this);this.parentScene=null}};CCSceneBase.prototype.setup=function(){};CCSceneBase.prototype.resize=function(){};CCSceneBase.prototype.resized=function(){};CCSceneBase.prototype.deleteLaterFromParent=function(){this.deleteLater()};CCSceneBase.prototype.deleteLinkedScenesLater=function(){var linkedScenes=this.linkedScenes;while(linkedScenes.length>0){var linkedScene=linkedScenes[0];linkedScene.unlinkScene(this);linkedScenes.remove(linkedScene);linkedScene.deleteLaterFromParent()}};CCSceneBase.prototype.shouldDelete=function(){return this.deletingScene};CCSceneBase.prototype.updateControls=function(controls){return false};CCSceneBase.prototype.update=function(delta){this.lifetime+=delta;if(this.enabled){var updated=this.updateScene(delta);updated|=this.updateCamera(delta);return updated}return false};CCSceneBase.prototype.updateScene=function(delta){var objects=this.objects;for(var i=0;i<objects.length;++i){var object=objects[i];if(object.deletingObjectCountdown===0){object.update(delta)}else if(object.deletingObjectCountdown>0){if(--object.deletingObjectCountdown===0){object.destruct();--i}}}};CCSceneBase.prototype.updateCamera=function(delta){};CCSceneBase.prototype.render=function(camera,pass,alpha){var objects=this.objects;var length=objects.length;for(var i=0;i<length;++i){var object=objects[i];if(object.renderPass===pass){if(!object.octreeRender&&object.deletingObjectCountdown===0){object.renderObject(camera,alpha)}}}};CCSceneBase.prototype.renderVisibleObject=function(object,camera,pass,alpha){if(camera===gEngine.cameras[0]){object.renderObject(camera,alpha)}};CCSceneBase.prototype.addObject=function(object){object.inScene=this;this.objects.push(object)};CCSceneBase.prototype.removeObject=function(object){object.inScene=null;this.objects.remove(object)};CCSceneBase.prototype.addCollideable=function(collideable){this.collideables.add(collideable);gEngine.collisionManager.addCollideable(collideable);if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCSceneBase.addCollideable;"+this.sceneID+";"+collideable.jsID+"\n"}};CCSceneBase.prototype.removeCollideable=function(collideable){this.collideables.remove(collideable);gEngine.collisionManager.removeCollideable(collideable);if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCSceneBase.removeCollideable;"+this.sceneID+";"+collideable.jsID+"\n"}};CCSceneBase.prototype.setParent=function(inParent){this.parentScene=inParent};CCSceneBase.prototype.deletingChild=function(inScene){var keys=Object.keys(this);for(var i=0;i<keys.length;++i){var key=keys[i];if(this[key]===inScene){this[key]=null}}};CCSceneBase.prototype.linkScene=function(inScene){this.linkedScenes.add(inScene)};CCSceneBase.prototype.unlinkScene=function(inScene){this.linkedScenes.remove(inScene);if(inScene===this.parentScene){this.parentScene.deletingChild(this);this.parentScene=null}};function CCSceneAppUI(){this.construct()}ExtendPrototype(CCSceneAppUI,CCSceneBase);CCSceneAppUI.tile_touchNone=0;CCSceneAppUI.tile_touchCollision=1;CCSceneAppUI.tile_touchAction=2;CCSceneAppUI.prototype.construct=function(){this.CCSceneBase_construct();this.tiles=[];this.cameraStickyTiles=[];this.touchDelta=new CCPoint;this.camera=null;this.cameraCentered=false;this.cameraReletivePositions=false;this.cameraScrolling=false;this.controlsEnabled=true;this.controlsFirstTouchedInThisScene=false;this.controlsMoving=false;this.controlsSwipeMomentum=false;this.minZoomOffset=1;this.maxZoomOffset=1e3;this.resizing=false;this.resizeCallbacks=[];this.scrollBar=null;this.timers=[]};CCSceneAppUI.prototype.destruct=function(){this.resizeCallbacks.length=0;if(this.camera){gEngine.removeCamera(this.camera);delete this.camera}this.CCSceneBase_destruct()};CCSceneAppUI.prototype.setup=function(){if(!this.camera){var camera=gEngine.newSceneCamera(this);camera.setupViewport(0,0,1,1)}this.camera.setCameraWidth(640);this.refreshCameraView();this.lockCameraView()};CCSceneAppUI.prototype.requestResize=function(){if(this.camera){this.resize()}};CCSceneAppUI.prototype.resize=function(){var camera=this.camera;CC.ASSERT(camera);var previousCameraHeight=camera.targetHeight;camera.recalcViewport();camera.setCameraWidth(camera.targetWidth);if(this.cameraCentered){if(this.cameraReletivePositions){var objects=this.objects;for(i=0;i<objects.length;++i){var object=objects[i];var y=this.getReletiveY(object,previousCameraHeight);this.setReletiveY(object,y)}}}else{var newCameraHeight=camera.targetHeight;var heightDifference=previousCameraHeight-newCameraHeight;camera.targetLookAt[1]+=heightDifference*.5}var resizeCallbacks=this.resizeCallbacks;resizeCallbacks.emit();this.resizing=true};CCSceneAppUI.prototype.resized=function(){if(!this.cameraCentered){this.refreshCameraView();this.lockCameraView();var camera=this.camera;camera.setLookAt(camera.targetLookAt,false);camera.flagUpdate()}};CCSceneAppUI.prototype.updateControls=function(controls){if(this.resizing){return false}var cameraRelativeTouches=this.camera.getRelativeTouches(controls.touches);var usingControls=this.handleTouches(cameraRelativeTouches[0],cameraRelativeTouches[1]);if(!usingControls){return this.CCSceneBase_updateControls(controls)}return usingControls};CCSceneAppUI.prototype.handleTouches=function(touch1,touch2){var usingControls=false;if(touch1.usingTouch&&touch2.usingTouch){if(this.touchAllowed(touch1)){if(this.controlsTouching===touch1){this.touchReleased(touch1,CCControls.touch_lost)}if(this.controlsTouching!==touch2){this.twoTouchesRegistered(touch1,touch2)}usingControls=this.handleTwoTouches(touch1,touch2)}}else{if(touch2.lastTimeReleased>0&&this.touchAllowed(touch1)){if(this.controlsTouching!==touch1){this.controlsFirstTouchedInThisScene=touch1.state===CCControls.touch_pressed;this.oneTouchRegistered(touch1)}usingControls=this.handleOneTouch(touch1)}else if(this.controlsTouching){if(this.controlsFirstTouchedInThisScene){if(this.controlsTouching===touch1&&touch1.state===CCControls.touch_released){usingControls=this.touchReleased(touch1,CCControls.touch_released)}else{this.touchReleased(touch1,CCControls.touch_lost)}}else{this.touchReleased(touch1,CCControls.touch_lost)}this.lockCameraView();if(this.controlsMoving){this.controlsMoving=false}this.controlsTouching=false}}return usingControls};CCSceneAppUI.prototype.updateScene=function(delta){var updated=this.CCSceneBase_updateScene(delta);{var timers=this.timers;var length=timers.length;for(var i=0;i<length;++i){var timer=timers[i];if(!timer.update(delta)){timers.remove(timer);timer.finish();length=timers.length;--i}}}return updated};CCSceneAppUI.prototype.updateCamera=function(delta){var updated=false;var lookAtSpeed=this.controlsMoving&&!this.cameraScrolling?20:1.5;if(this.camera.interpolateCamera(delta,lookAtSpeed)){if(this.scrollBar){}var cameraStickyTiles=this.cameraStickyTiles;for(var i=0;i<cameraStickyTiles.length;++i){var tile=cameraStickyTiles[i];tile.setPosition(this.camera.currentLookAt)}updated=true}else{if(this.cameraScrolling){this.cameraScrolling=false;this.lockCameraView();updated=true}if(this.resizing){this.resizing=false;this.refreshCameraView();this.lockCameraView();updated=true}}return updated};CCSceneAppUI.prototype.render=function(camera,pass,alpha){if(this.camera===camera){this.CCSceneBase_render(camera,pass,alpha)}};CCSceneAppUI.prototype.renderVisibleObject=function(object,camera,pass,alpha){if(this.camera===camera){object.renderObject(camera,alpha)}};CCSceneAppUI.prototype.refreshCameraView=function(){this.sceneLeft=0;this.sceneRight=0;this.sceneTop=0;this.sceneBottom=0};CCSceneAppUI.prototype.lockCameraView=function(){if(this.cameraScrolling){return}this.camera.flagUpdate();gRenderer.pendingRender=true;this.camera.targetLookAt[0]=0;this.camera.targetLookAt[1]=0};CCSceneAppUI.prototype.scrollCameraToTop=function(){this.camera.targetLookAt[1]=this.sceneTop;this.camera.flagUpdate()};CCSceneAppUI.prototype.addTile=function(inTile,index){this.tiles.push(inTile);if(index!==undefined){this.tiles.insert(inTile,index)}};CCSceneAppUI.prototype.touchAllowed=function(touch){if(this.enabled&&this.controlsEnabled){if(touch.state<CCControls.touch_released){return touch.x>0&&touch.x<1&&touch.y>0&&touch.y<1&&touch.startX>0&&touch.startX<1&&touch.startY>0&&touch.startY<1}}return false};CCSceneAppUI.prototype.handleOneTouch=function(touch1){var usingControls=false;this.touchDelta.x=touch1.deltaX;this.touchDelta.y=touch1.deltaY;if(!this.controlsMoving){if(this.touchMovementAllowed(touch1,this.touchDelta)){}else{usingControls=this.touchPressed(touch1)}}if(this.controlsMoving){usingControls=this.touchMoving(touch1,this.touchDelta)}return usingControls};CCSceneAppUI.prototype.handleTwoTouches=function(touch1,touch2){return false};CCSceneAppUI.prototype.oneTouchRegistered=function(touch){this.controlsTwoTouchAction=CCControls.twotouch_unassigned;this.controlsTouching=touch};CCSceneAppUI.prototype.twoTouchesRegistered=function(touch1,touch2){this.controlsTwoTouchAction=CCControls.twotouch_unassigned;this.controlsTouching=touch2};CCSceneAppUI.prototype.touchPressed=function(touch){return this.handleTilesTouch(touch,CCControls.touch_pressed)>=CCSceneAppUI.tile_touchCollision};CCSceneAppUI.prototype.touchMovementAllowed=function(touch,touchDelta){var absDeltaX=Math.abs(touch.totalDeltaX);var absDeltaY=Math.abs(touch.totalDeltaY);if(absDeltaX>CCControls.TouchMovementThreashold.x||absDeltaY>CCControls.TouchMovementThreashold.y){this.controlsMoving=true;touchDelta.x+=touch.totalDeltaX;touchDelta.y+=touch.totalDeltaY;this.controlsMovingVertical=absDeltaY>absDeltaX;return true}return false};CCSceneAppUI.prototype.touchMoving=function(touch,touchDelta){var result=this.handleTilesTouch(touch,this.controlsMovingVertical?CCControls.touch_movingVertical:CCControls.touch_movingHorizontal);if(result===CCSceneAppUI.tile_touchAction){return true}else{return this.touchCameraMoving(touchDelta.x,touchDelta.y)}};CCSceneAppUI.prototype.touchCameraMoving=function(x,y){var camera=this.camera;var delta;if(this.controlsMovingVertical){if(y!==0){delta=y*camera.cameraHeight;if(camera.targetLookAt[1]>this.sceneTop||camera.targetLookAt[1]<this.sceneBottom){delta*=.5}camera.targetLookAt[1]+=delta;var cameraHeightStretch=camera.targetHeight*.1;camera.targetLookAt[1]=CC.FloatClamp(camera.targetLookAt[1],this.sceneBottom-cameraHeightStretch,this.sceneTop+cameraHeightStretch);camera.flagUpdate();return true}}else{if(x!==0){delta=x*camera.cameraWidth;if(camera.targetLookAt[0]>this.sceneRight||camera.targetLookAt[0]<this.sceneLeft){delta*=.5}camera.targetLookAt[0]-=delta;var cameraWidthStretch=camera.targetWidth*.1;camera.targetLookAt[0]=CC.FloatClamp(camera.targetLookAt[0],this.sceneLeft-cameraWidthStretch,this.sceneRight+cameraWidthStretch);camera.flagUpdate();return true}}return true};CCSceneAppUI.prototype.touchCameraZooming=function(amount){var camera=this.camera;camera.targetOffset[2]-=amount*2*camera.offset[2];camera.targetOffset[2]=CC.FloatClamp(camera.targetOffset[2],this.minZoomOffset,this.maxZoomOffset);camera.flagUpdate();return false};CCSceneAppUI.prototype.touchCameraRotating=function(x,y){var camera=this.camera;var rotation=camera.rotation;rotation[1]+=-x*180;rotation[1]=CC.FloatClamp(rotation[1],-45,45);camera.setRotationY(rotation[1]);rotation[0]+=-y*180;rotation[0]=CC.FloatClamp(rotation[0],-45,45);camera.setRotationX(rotation[0]);camera.flagUpdate();return true};CCSceneAppUI.prototype.touchReleased=function(touch,touchAction){var result=this.handleTilesTouch(touch,touchAction);var usingControls=result===CCSceneAppUI.tile_touchAction;if(!usingControls&&touchAction===CCControls.touch_released){usingControls=this.touchReleaseSwipe(touch)}return usingControls};CCSceneAppUI.prototype.handleTilesTouch=function(touch,touchAction){var camera=this.camera;if(camera.project3D(touch.x,touch.y)){var tiles=this.tiles;var projectionResults=camera.projectionResults;var hitPosition=vec3.create();var hitObject=CC.BasicLineCollisionCheck(tiles,projectionResults.vNear,projectionResults.vFar,hitPosition,true,CC.collision_ui);if(!hitObject){hitPosition=projectionResults.vLookAt}var actioned=false;var length=tiles.length;for(var i=0;i<length;++i){var tile=tiles[i];if(tile.handleProjectedTouch(projectionResults,hitObject,hitPosition,touch,touchAction)){actioned|=true;if(touchAction<CCControls.touch_released){break}}}if(actioned){return CCSceneAppUI.tile_touchAction}if(hitObject){return CCSceneAppUI.tile_touchCollision}}return CCSceneAppUI.tile_touchNone};CCSceneAppUI.prototype.touchReleaseSwipe=function(touch){if(this.controlsSwipeMomentum){var maxTimeHeld=.5;if(touch.timeHeld<maxTimeHeld){var camera=this.camera;var minMovementThreashold=.1;if(this.controlsMovingVertical){if(touch.totalDeltaY<-minMovementThreashold){camera.targetLookAt[1]-=camera.cameraHHeight*.5;camera.flagUpdate();this.lockCameraView();return true}else if(touch.totalDeltaY>minMovementThreashold){camera.targetLookAt[1]+=camera.cameraHHeight*.5;camera.flagUpdate();this.lockCameraView();return true}}else{if(touch.totalDeltaX<-minMovementThreashold){camera.targetLookAt[0]+=camera.cameraHWidth;camera.flagUpdate();this.lockCameraView();return true}else if(touch.totalDeltaX>minMovementThreashold){camera.targetLookAt[0]-=camera.cameraHWidth;camera.flagUpdate();this.lockCameraView();return true}}}}return false};CCSceneAppUI.prototype.getReletiveWidth=function(object){return object.collisionSize.width/this.camera.targetWidth};CCSceneAppUI.prototype.getReletiveHeight=function(object){return object.collisionSize.height/this.camera.targetHeight};CCSceneAppUI.prototype.getReletiveX=function(object){var x=object.position[0];return x/(this.camera.targetWidth*.5)};CCSceneAppUI.prototype.getReletiveY=function(object,screenHeight){if(screenHeight===undefined){screenHeight=this.camera.targetHeight}var y=object.position[1];return y/(screenHeight*.5)};CCSceneAppUI.prototype.setReletiveWidth=function(object,value){value*=this.camera.targetWidth;var aspectRatio=object.collisionSize.height/object.collisionSize.width;if(object.aspectRatioLocked){object.setTileSize(value,value*aspectRatio)}else{object.setTileSize(value,object.collisionSize.height)}};CCSceneAppUI.prototype.setReletiveHeight=function(object,value){value*=this.camera.targetHeight;var aspectRatio=object.collisionSize.height/object.collisionSize.width;if(object.aspectRatioLocked){object.setTileSize(value/aspectRatio,value)}else{object.setTileSize(object.collisionSize.width,value)}};CCSceneAppUI.prototype.setReletiveX=function(object,value){var hCameraWidth=this.camera.targetWidth*.5;value*=hCameraWidth;var hWidth=object.collisionBounds[0];object.setPositionX(value)};CCSceneAppUI.prototype.setReletiveY=function(object,value){var hCameraHeight=this.camera.targetHeight*.5;value*=hCameraHeight;var hHeight=object.collisionBounds[1];object.setPositionY(value)};CCPrimitiveFBX.prototype.destruct=function(){CCEngine.NativeUpdateCommands+="CCPrimitiveFBX.destruct;"+this.primitiveID+"\n";this.CCPrimitive3D_destruct()};CCPrimitiveFBX.prototype.load=function(filename,url,priority,callback){this.filename=filename;this.loadedCallback=callback;CCEngine.NativeUpdateCommands+="CCPrimitiveFBX.load;"+this.primitiveID+";"+url+";"+filename+"\n"};CCPrimitiveFBX.prototype.loaded=function(json){var callback=this.loadedCallback;if(this.loadedCallback){delete this.loadedCallback}if(json){this.fileSize=json.fileSize;this.vertexCount=json.vertexCount;this.mmX.min=json.mmXmin;this.mmX.max=json.mmXmax;this.mmY.min=json.mmYmin;this.mmY.max=json.mmYmax;this.mmZ.min=json.mmZmin;this.mmZ.max=json.mmZmax;this.width=this.mmX.size();this.height=this.mmY.size();this.depth=this.mmZ.size();if(this.animations){if(json.animationFPS){this.animationFPS=json.animationFPS}if(json.animationFPSCompression){this.animationFPSCompression=json.animationFPSCompression
}this.setAnimation(0);this.nextFrame()}}if(callback){callback(this.vertexCount>0)}};CCPrimitiveFBX.prototype.loadedAnimation=function(name){if(!this.animations){this.animations=[]}var animation={};animation.name=name;animation.frames=[];this.animations.push(animation)};CCPrimitiveFBX.prototype.loadedAnimationFrame=function(array){if(this.animations&&this.animations.length>0){var animation=this.animations[this.animations.length-1];animation.frames.push(array)}};CCPrimitiveFBX.prototype.moveVerticesToOrigin=function(callback){if(!this.movedToOrigin){this.getOrigin();CCEngine.NativeUpdateCommands+="CCPrimitive3D.moveVerticesToOrigin;"+this.primitiveID+"\n";if(callback){this.moveVerticesToOriginCallback=callback}}else{if(callback){callback()}}};CCPrimitiveFBX.prototype.interpolateFrames=function(currentAnimationIndex,currentFrameIndex,nextAnimationIndex,nextFrameIndex,frameDelta){CCEngine.NativeUpdateCommands+="CCPrimitiveFBX.interpolateFrames;"+this.primitiveID+";"+currentAnimationIndex+";"+currentFrameIndex+";"+nextAnimationIndex+";"+nextFrameIndex+";"+frameDelta+"\n"};CCPrimitiveOBJ.prototype.destruct=function(){CCEngine.NativeUpdateCommands+="CCPrimitiveOBJ.destruct;"+this.primitiveID+"\n";this.CCPrimitive3D_destruct()};CCPrimitiveOBJ.prototype.load=function(filename,url,priority,callback){this.filename=filename;this.loadedCallback=callback;this.vertexPositionBuffer=gRenderer.CCCreateVertexBuffer();this.vertexTextureBuffer=gRenderer.CCCreateVertexBuffer();CCEngine.NativeUpdateCommands+="CCPrimitiveOBJ.load;"+this.primitiveID+";"+this.vertexPositionBuffer+";"+this.vertexTextureBuffer+";"+url+";"+filename+"\n"};CCPrimitiveOBJ.prototype.reference=function(filename,callback){this.filename=filename;if(callback){this.loadedCallback=callback}this.vertexPositionBuffer=gRenderer.CCCreateVertexBuffer();this.vertexTextureBuffer=gRenderer.CCCreateVertexBuffer();CCEngine.NativeUpdateCommands+="CCPrimitiveOBJ.reference;"+this.primitiveID+";"+this.vertexPositionBuffer+";"+this.vertexTextureBuffer+";"+filename+"\n"};CCPrimitiveOBJ.prototype.loaded=function(json){var callback=this.loadedCallback;if(this.loadedCallback){delete this.loadedCallback}if(json){this.fileSize=json.fileSize;this.vertexCount=json.vertexCount;this.mmX.min=json.mmXmin;this.mmX.max=json.mmXmax;this.mmY.min=json.mmYmin;this.mmY.max=json.mmYmax;this.mmZ.min=json.mmZmin;this.mmZ.max=json.mmZmax;this.width=this.mmX.size();this.height=this.mmY.size();this.depth=this.mmZ.size()}if(callback){callback(this.vertexCount>0)}};CCPrimitiveOBJ.prototype.render=function(){gRenderer.unbindBuffers();CCEngine.NativeRenderCommands+="CCPrimitiveOBJ.render;"+this.primitiveID+"\n"};CCPrimitiveSquare.prototype.removeTexture=function(){this.CCPrimitiveBase_removeTexture();CCEngine.NativeUpdateCommands+="CCPrimitiveSquare.removeTexture;"+this.primitiveID+"\n"};CCPrimitiveSquare.prototype.render=function(){gRenderer.unbindBuffers();CCEngine.NativeRenderCommands+="CCPrimitiveSquare.render;"+this.primitiveID+"\n"};CCPrimitiveSquare.prototype.adjustTextureUVs=function(){if(this.textureIndex>=0){CCEngine.NativeUpdateCommands+="CCPrimitiveBase.adjustTextureUVs;"+this.primitiveID+";"+this.textureIndex+"\n"}};CCPrimitiveSquare.prototype.setTextureUVs=function(x1,y1,x2,y2){CCEngine.NativeUpdateCommands+="CCPrimitiveSquare.setTextureUVs;"+this.primitiveID+";"+x1+";"+y1+";"+x2+";"+y2+"\n"};CCPrimitiveSquare.prototype.flipY=function(){CCEngine.NativeUpdateCommands+="CCPrimitiveSquare.flipY;"+this.primitiveID+"\n"};function CCMP3(){this.stop=function(){this.paused=true;CCEngine.NativeUpdateCommands+="CCAudioManager.Stop;"+this.id+"\n"};this.pause=function(){this.paused=true;CCEngine.NativeUpdateCommands+="CCAudioManager.Pause;"+this.id+"\n"};this.resume=function(){this.paused=false;CCEngine.NativeUpdateCommands+="CCAudioManager.Resume;"+this.id+"\n"};this.mute=function(toggle){this.muted=toggle;CCEngine.NativeUpdateCommands+="CCAudioManager.SetVolume;"+this.id+";"+(toggle?0:1)+"\n"};this.isPlaying=function(){return!this.paused&&!this.ended}}CCAudioManager.Ended=function(id,url){var mp3=CCAudioManager.Get(id);if(mp3){if(mp3.url===url){mp3.ended=true}}};CCAudioManager.Play=function(id,url,restart,loop,callback){CCAudioManager.Prepare(id,url,function(mp3){CCEngine.NativeUpdateCommands+="CCAudioManager.Play;"+id+";"+url+";"+restart+";"+loop+"\n";mp3.mute(CCAudioManager.Enabled?false:true);if(CCAudioManager.Paused){CCAudioManager.Pause()}if(callback){callback()}})};CCAudioManager.Prepared=function(id,url,binary){var mp3=CCAudioManager.Get(id);if(mp3){if(mp3.url===url){mp3.loaded=true;if(mp3.onLoadedCallbacks){for(var i=0;i<mp3.onLoadedCallbacks.length;++i){mp3.onLoadedCallbacks[i](mp3)}delete mp3.onLoadedCallbacks}}}};function CCFileManager(){}CCFileManager.SingletonConstructor=function(){this.LoadQueue=[]};CCFileManager.SingletonConstructor();CCFileManager.Loaded=function(file,data){for(var i=0;i<this.LoadQueue.length;++i){var load=this.LoadQueue[i];if(load.file===file){this.LoadQueue.remove(load);for(var iOnLoad=0;iOnLoad<load.onLoad.length;++iOnLoad){load.onLoad[iOnLoad](data)}return}}};CCFileManager.Load=function(file,onLoad,priority){if(onLoad){for(var i=0;i<this.LoadQueue.length;++i){var load=this.LoadQueue[i];if(load.file===file){load.onLoad.push(onLoad);return}}var packet={};packet.file=file;packet.onLoad=[];packet.onLoad.push(onLoad);this.LoadQueue.push(packet);CCEngine.NativeUpdateCommands+="CCFileManager.Load;"+file+"\n"}};CCFileManager.Save=function(file,data){if(typeof data==="object"){data=JSON.stringify(data)}if(data&&data.length>0){var encodedData=String.ReplaceChar(data,"\n","\\n");CCEngine.NativeUpdateCommands+="CCFileManager.Save;"+file+";"+encodedData+"\n"}};CCURLManager.prototype.create=function(){this.nextRequestID=0;return this};CCURLManager.prototype.requestURL=function(url,postData,callback,priority,cacheFile,cacheFileTimeoutSeconds,timeout,returnBinary){if(priority===undefined){priority=0}if(!cacheFile){cacheFile=null}if(cacheFileTimeoutSeconds===undefined||cacheFileTimeoutSeconds===null){cacheFileTimeoutSeconds=-1}if(timeout===undefined){timeout=0}var request=new CCURLRequest(url,postData,callback,priority,cacheFile,cacheFileTimeoutSeconds,timeout,returnBinary);request.id=this.nextRequestID++;this.requests.push(request);var nativeCommand="CCURLManager.requestURL;"+request.id+";"+url+";";if(postData&&typeof postData==="object"){if(!CCURLManager.TempPostDataIndex){CCURLManager.TempPostDataIndex=1}var tmpFile="_postdata"+CCURLManager.TempPostDataIndex++ +".tmp";CCFileManager.Save(tmpFile,JSON.stringify(postData));nativeCommand+=tmpFile}nativeCommand+=";"+priority+";";if(cacheFile){nativeCommand+=cacheFile}nativeCommand+=";";nativeCommand+=cacheFileTimeoutSeconds+";"+timeout+";";if(returnBinary){nativeCommand+="true"}nativeCommand+="\n";CCEngine.NativeUpdateCommands+=nativeCommand};CCURLManager.prototype.updateRequestPriority=function(url,filename,priority){CCEngine.NativeUpdateCommands+="CCURLManager.updateRequestPriority;"+url+";"+filename+";"+priority+"\n"};CCURLManager.prototype.downloaded=function(id,state,responseText){var requests=this.requests;var request;for(var i=0;i<requests.length;++i){if(requests[i].id===id){request=requests[i];break}}if(request){if(request.returnBinary){if(responseText){if(CCEngine.DeviceType==="WindowsPhone"){responseText=request.cacheFile}else{responseText="file://"+responseText}}}if(request.callback){if(request.callback.run){request.callback.run(state,responseText)}else{request.callback(state,responseText)}}else{if(httpRequestObject.status===200){}else{}}requests.remove(request)}};CCURLManager.prototype.setDomainTimeOut=function(domain,timeout){CCEngine.NativeUpdateCommands+="CCURLManager.setDomainTimeOut;"+domain+";"+timeout+"\n"};CCControls.prototype.create=function(){return this};CCControls.prototype.handleControls=function(touch,state){if(touch.touchMovingState){if(touch.touchMovingState!==state){this.updateTouch(touch,touch.touchMovingState);touch.touchMovingState=false;gEngine.updateControls()}}};CCControls.prototype.updateTouch=function(touch,state){var x=touch.rawX;var y=touch.rawY;this.updateTouchXY(touch,state,x,y)};CCControls.prototype.touchBegin=function(index,x,y){var touch=this.touches[index];touch.rawX=x;touch.rawY=y;this.handleControls(touch,CCControls.touch_pressed);this.updateTouch(touch,CCControls.touch_pressed);gEngine.updateControls()};CCControls.prototype.touchMove=function(index,x,y){var touch=this.touches[index];touch.rawX=x;touch.rawY=y;this.handleControls(touch,CCControls.touch_moving);touch.touchMovingState=CCControls.touch_moving};CCControls.prototype.touchEnd=function(index){var touches=this.touches;for(var i=0;i<touches.length;++i){var touch=touches[i];this.handleControls(touch,CCControls.touch_released);this.updateTouch(touch,CCControls.touch_released)}gEngine.updateControls()};CCControls.prototype.keyboardInput=function(character){var callbacks=this.onKeyboardCallbacks;for(var i=0;i<callbacks.length;++i){callbacks[i]({},character,true)}};CCControls.prototype.requestKeyboard=function(callback,popupKeyboard){this.onKeyboardCallbacks.addOnce(callback);if(popupKeyboard){CCEngine.NativeUpdateCommands+="CCControls.requestKeyboard\n"}};CCControls.prototype.removeKeyboard=function(callback){this.onKeyboardCallbacks.remove(callback);if(this.onKeyboardCallbacks.length===0){CCEngine.NativeUpdateCommands+="CCControls.removeKeyboard\n"}};CCTextureManager.prototype.assignTextureIndex=function(url,mipmap){url=MultiplayerManager.GetAssetURL(url);var textureHandles=this.textureHandles;var length=textureHandles.length;var textureHandle;var filename=url.getFilename();for(var i=0;i<length;++i){textureHandle=textureHandles[i];if(filename===textureHandle.filename){return i}}textureHandle={};textureHandle.filename=filename;textureHandle.src=url;textureHandle.mipmap=mipmap;textureHandle.downloaded=false;textureHandles.push(textureHandle);CCEngine.NativeUpdateCommands+="CCTextureManager.assignTextureIndex;"+length+";"+url+";"+(mipmap?"true":"true")+"\n";return length};CCTextureManager.prototype.referenceTexture=function(filename,mipmap){var textureHandles=this.textureHandles;var length=textureHandles.length;var textureHandle;for(var i=0;i<length;++i){textureHandle=textureHandles[i];if(filename===textureHandle.filename){return i}}textureHandle={};textureHandle.filename=filename;textureHandle.src=filename;textureHandle.mipmap=mipmap;textureHandle.downloaded=false;textureHandles.push(textureHandle);CCEngine.NativeUpdateCommands+="CCTextureManager.referenceTexture;"+length+";"+filename+";"+(mipmap?"true":"true")+"\n";return length};CCTextureManager.DownloadedImage=function(index,width,height,allocatedWidth,allocatedHeight){if(gEngine&&gEngine.textureManager){if(width!==undefined&&height!==undefined){gEngine.textureManager.downloadedImage(index,width,height,allocatedWidth,allocatedHeight)}else{gEngine.textureManager.downloadError(index,width,height,allocatedWidth,allocatedHeight)}}};CCTextureManager.prototype.downloadedImage=function(index,width,height,allocatedWidth,allocatedHeight){var textureHandle=this.getTextureHandleIndex(index);if(textureHandle&&!textureHandle.downloaded){textureHandle.image={};textureHandle.image.width=width;textureHandle.image.height=height;if(allocatedWidth&&allocatedHeight){textureHandle.image.allocatedWidth=allocatedWidth;textureHandle.image.allocatedHeight=allocatedHeight}textureHandle.downloaded=true;if(textureHandle.onDownload){for(i=0;i<textureHandle.onDownload.length;++i){textureHandle.onDownload[i](textureHandle)}delete textureHandle.onDownload}}};CCTextureManager.prototype.downloadError=function(index){var textureHandle=this.getTextureHandleIndex(index);if(textureHandle&&!textureHandle.downloaded){if(!textureHandle.downloadRetries){textureHandle.downloadRetries=0}if(textureHandle.downloadRetries<3){textureHandle.downloadRetries++;this.assignTextureIndex(textureHandle.src,textureHandle.mipmap);return}if(textureHandle.onDownload){for(i=0;i<textureHandle.onDownload.length;++i){textureHandle.onDownload[i](null)}delete textureHandle.onDownload}}};CCTextureManager.prototype.setTextureIndex=function(index){if(index!==this.currentTextureIndex){this.currentTextureIndex=index;CCEngine.NativeRenderCommands+="CCTextureManager.setTextureIndex;"+index+"\n"}};CCRenderer.prototype.create=function(width,height){this.nextVertexBufferID=1;gRenderer=this;this.setSize(width,height);this.renderFlags=CCRenderer.render_all;this.setup()};CCRenderer.Float32Array=Array;CCRenderer.Uint16Array=Array;CCRenderer.gl_FRONT=1;CCRenderer.gl_BACK=2;CCRenderer.prototype.setSize=function(width,height){this.width=width;this.height=height;this.pendingRender=true};CCRenderer.prototype.setup=function(){this.initBuffers();CCEngine.NativeRenderCommands+="gl.clearColor;0,0,0,0\n";this.CCSetColour(gColour.white());this.CCSetDepthRead(true);this.CCSetDepthWrite(true);CCEngine.NativeRenderCommands+="gl.depthFunc;LEQUAL\n";CCEngine.NativeRenderCommands+="gl.blendFunc;SRC_ALPHA;ONE_MINUS_SRC_ALPHA\n";CCEngine.NativeRenderCommands+="gl.lineWidth;2.0\n";this.CCSetCulling(true);this.CCSetBackCulling()};CCRenderer.prototype.initBuffers=function(){{var textureCoords=[1,0,0,0,1,1,0,1];this.defaultTextureCoords=textureCoords;this.CCDefaultTexCoords()}{this.vertexColorData=new CCRenderer.Float32Array(4)}{{var vertices=[.5,.5,0,-.5,.5,0,.5,-.5,0,-.5,-.5,0];this.defaultSquareVertexBuffer=this.CCCreateVertexBuffer(vertices)}this.CCDefaultSquareVertexPointer()}};CCRenderer.prototype.clear=function(colour){if(colour){CCEngine.NativeRenderCommands+="gl.clear;gl.COLOR_BUFFER_BIT;gl.DEPTH_BUFFER_BIT\n"}else{CCEngine.NativeRenderCommands+="gl.clear;gl.DEPTH_BUFFER_BIT\n"}};CCRenderer.prototype.beginRender=function(){if(this.pendingRender){this.pendingRender=false;this.unbindBuffers();this.clear(true);return true}return false};CCRenderer.prototype.unbindBuffers=function(){this.textureCoords=-1;this.vertexTextureBuffer=-1;this.vertexPositionBuffer=-1;this.vertexIndexBuffer=-1;gEngine.textureManager.currentTextureIndex=0};CCRenderer.MatrixToString=function(matrix){return""+matrix[0]+","+matrix[1]+","+matrix[2]+","+matrix[3]+","+matrix[4]+","+matrix[5]+","+matrix[6]+","+matrix[7]+","+matrix[8]+","+matrix[9]+","+matrix[10]+","+matrix[11]+","+matrix[12]+","+matrix[13]+","+matrix[14]+","+matrix[15]};CCRenderer.ArrayToString=function(array){var string="";string+=array[0];var length=array.length;for(var i=1;i<length;++i){string+=",";string+=array[i]}return string};CCRenderer.prototype.CCSetViewMatrix=function(camera){CCEngine.NativeRenderCommands+="gl.uniformMatrix4fv;UNIFORM_PROJECTIONMATRIX;"+CCRenderer.MatrixToString(camera.projectionMatrix)+"\n";CCEngine.NativeRenderCommands+="gl.uniformMatrix4fv;UNIFORM_VIEWMATRIX;"+CCRenderer.MatrixToString(camera.viewMatrix)+"\n"};CCRenderer.prototype.CCSetRenderStates=function(){CCEngine.NativeRenderCommands+="CCRenderer.CCSetRenderStates\n"};CCRenderer.prototype.CCSetColour=function(colour){var r=colour.r;var g=colour.g;var b=colour.b;var a=colour.a;var data=this.vertexColorData;if(data[0]!==r||data[1]!==g||data[2]!==b||data[3]!==a){CCEngine.NativeRenderCommands+="CCRenderer.CCSetColour;"+r+","+g+","+b+","+a+"\n";data[0]=r;data[1]=g;data[2]=b;data[3]=a}this.colour=colour};CCRenderer.prototype.CCSetTexCoords=function(textureCoords){this.vertexTextureBuffer=textureCoords;this.textureCoords=textureCoords;CCEngine.NativeRenderCommands+="CCRenderer.CCSetTexCoords;"+textureCoords+"\n"};CCRenderer.prototype.CCDefaultTexCoords=function(){if(this.textureCoords!==this.defaultTextureCoords){this.CCSetTexCoords(this.defaultTextureCoords)}};CCRenderer.prototype.CCCreateVertexBuffer=function(vertices){var vertexBufferID=this.nextVertexBufferID++;CCEngine.NativeUpdateCommands+="CCRenderer.CCCreateVertexBuffer;"+vertexBufferID+"\n";if(vertices){this.CCUpdateVertexBuffer(vertexBufferID,vertices)}return vertexBufferID};CCRenderer.prototype.CCCreateVertexIndexBuffer=function(indices){var vertexBufferID=this.nextVertexBufferID++;CCEngine.NativeUpdateCommands+="CCRenderer.CCCreateVertexIndexBuffer;"+vertexBufferID+"\n";if(indices){this.CCUpdateVertexBuffer(vertexBufferID,indices)}return vertexBufferID};CCRenderer.prototype.CCUpdateVertexBuffer=function(vertexBufferID,vertices){CCEngine.NativeUpdateCommands+="CCRenderer.CCUpdateVertexBuffer;"+vertexBufferID+";"+vertices+"\n"};CCRenderer.prototype.CCDeleteVertexBuffer=function(vertexBufferID){CCEngine.NativeUpdateCommands+="CCRenderer.CCDeleteVertexBuffer;"+vertexBufferID+"\n"};CCRenderer.prototype.CCBindVertexTextureBuffer=function(vertexBufferID){if(this.vertexTextureBuffer!==vertexBufferID){this.vertexTextureBuffer=vertexBufferID;this.textureCoords=vertexBufferID;CCEngine.NativeRenderCommands+="CCRenderer.CCBindVertexTextureBuffer;"+vertexBufferID+"\n"}};CCRenderer.prototype.CCBindVertexPositionBuffer=function(vertexBufferID){if(this.vertexPositionBuffer!==vertexBufferID){this.vertexPositionBuffer=vertexBufferID;CCEngine.NativeRenderCommands+="CCRenderer.CCBindVertexPositionBuffer;"+vertexBufferID+"\n"}};CCRenderer.prototype.CCBindVertexIndexBuffer=function(vertexBufferID){if(this.vertexIndexBuffer!==vertexBufferID){this.vertexIndexBuffer=vertexBufferID;CCEngine.NativeRenderCommands+="CCRenderer.CCBindVertexIndexBuffer;"+vertexBufferID+"\n"}};CCRenderer.prototype.GLDrawArrays=function(mode,count,offset){CCEngine.NativeRenderCommands+="gl.drawArrays;"+mode+";"+count+";"+offset+"\n"};CCRenderer.prototype.GLDrawElements=function(mode,count,offsetInBytes){CCEngine.NativeRenderCommands+="gl.drawElements;"+mode+";"+count+";"+"offsetInBytes"+"\n"};CCRenderer.prototype.GLVertexPointer=function(vertices){if(this.vertexPositionBuffer!==vertices){this.vertexPositionBuffer=vertices;CCEngine.NativeRenderCommands+="CCRenderer.GLVertexPointer;"+vertices+"\n"}};CCRenderer.prototype.CCRenderSquare=function(start,end){var vertices=[start[0],end[1],end[2],end[0],end[1],end[2],start[0],start[1],start[2],end[0],start[1],start[2]];this.GLVertexPointer(vertices);var gl=this.gl;gl.drawArrays(gl.TRIANGLE_STRIP,0,4)};CCRenderer.prototype.CCSetBlend=function(toggle){if(this.blendEnabled!==toggle){this.blendEnabled=toggle;CCEngine.NativeRenderCommands+="CCRenderer.CCSetBlend;"+toggle+"\n"}};CCRenderer.prototype.CCSetDepthRead=function(toggle){if(this.depthReadEnabled!==toggle){this.depthReadEnabled=toggle;CCEngine.NativeRenderCommands+="CCRenderer.CCSetDepthRead;"+toggle+"\n"}};CCRenderer.prototype.CCSetDepthWrite=function(toggle){if(this.depthWriteEnabled!==toggle){this.depthWriteEnabled=toggle;CCEngine.NativeRenderCommands+="CCRenderer.CCSetDepthWrite;"+toggle+"\n"}};CCRenderer.prototype.CCSetCulling=function(toggle){if(this.cullingEnabled!==toggle){this.cullingEnabled=toggle;CCEngine.NativeRenderCommands+="CCRenderer.CCSetCulling;"+toggle+"\n"}};CCRenderer.prototype.CCSetFrontCulling=function(){if(this.cullingType!==CCRenderer.gl_FRONT){this.cullingType=CCRenderer.gl_FRONT;CCEngine.NativeRenderCommands+="CCRenderer.CCSetFrontCulling\n"}};CCRenderer.prototype.CCSetBackCulling=function(){if(this.cullingType!==CCRenderer.gl_BACK){this.cullingType=CCRenderer.gl_BACK;CCEngine.NativeRenderCommands+="CCRenderer.CCSetBackCulling\n"}};CCRenderer.prototype.GLViewport=function(x,y,width,height){CCEngine.NativeRenderCommands+="gl.viewport;"+x+","+y+","+width+","+height+"\n"};CCRenderer.prototype.GLScissor=function(x,y,width,height){CCEngine.NativeRenderCommands+="gl.scissor;"+x+","+y+","+width+","+height+"\n"};CCRenderer.GLPushMatrix=function(){CCEngine.NativeRenderCommands+="Matrix.GLPushMatrix\n"};CCRenderer.GLPopMatrix=function(){CCEngine.NativeRenderCommands+="Matrix.GLPopMatrix\n"};CCRenderer.GLLoadIdentity=function(){CCEngine.NativeRenderCommands+="Matrix.GLLoadIdentity\n"};CCRenderer.GLMultMatrix=function(matrix){CCEngine.NativeRenderCommands+="Matrix.GLMultMatrix;"+matrix[0]+";"+matrix[1]+";"+matrix[2]+";"+matrix[3]+";"+matrix[4]+";"+matrix[5]+";"+matrix[6]+";"+matrix[7]+";"+matrix[8]+";"+matrix[9]+";"+matrix[10]+";"+matrix[11]+";"+matrix[12]+";"+matrix[13]+";"+matrix[14]+";"+matrix[15]+"\n"};CCRenderer.GLTranslate=function(vector){CCEngine.NativeRenderCommands+="Matrix.GLTranslate;"+vector[0]+";"+vector[1]+";"+vector[2]+"\n"};CCRenderer.GLScale=function(vector){CCEngine.NativeRenderCommands+="Matrix.GLScale;"+vector[0]+";"+vector[1]+";"+vector[2]+"\n"};CCRenderer.GLRotate=function(angle,vector){CCEngine.NativeRenderCommands+="Matrix.GLRotate;"+angle+";"+vector[0]+";"+vector[1]+";"+vector[2]+"\n"};CCRenderer.ModelMatrixMultiply=function(object){CCEngine.NativeRenderCommands+="Matrix.ModelMatrixMultiply;"+object.jsID+"\n"};CCRenderer.ModelMatrixIdentity=function(object){CCEngine.NativeRenderCommands+="Matrix.ModelMatrixIdentity;"+object.jsID+"\n"};CCRenderer.ModelMatrixTranslate=function(object,vector){CCEngine.NativeRenderCommands+="Matrix.ModelMatrixTranslate;"+object.jsID+";"+vector[0]+";"+vector[1]+";"+vector[2]+"\n"};CCRenderer.ModelMatrixScale=function(object,vector){CCEngine.NativeRenderCommands+="Matrix.ModelMatrixScale;"+object.jsID+";"+vector[0]+";"+vector[1]+";"+vector[2]+"\n"};CCRenderer.ModelMatrixRotate=function(object,angle,axis){CCEngine.NativeRenderCommands+="Matrix.ModelMatrixRotate;"+object.jsID+";"+angle+";"+axis[0]+";"+axis[1]+";"+axis[2]+"\n"};function CCEngine(){this.nextUpdateCallbacks=[];this.scenes=[];this.cameras=[];this.timeReal=0;this.lifetime=0;this.lastUpdate=0;this.fpsTimer=0;this.fpsTicks=0;this.collisionManager=new CCCollisionManager(1e4);CCCameraBase.SetVisibleSortFunction(CCEngine.ZCompare);this.setup()}window.gEngine=null;CCEngine.BackButtonStack=[];CCEngine.DeviceType="Web";CCEngine.Orientation={current:0,target:0};CCEngine.IsMobile=function(){return CCEngine.DeviceType==="iOS"||CCEngine.DeviceType==="Android"||CCEngine.DeviceType==="WindowsPhone"||window.tizen};CCEngine.IsPortrait=function(){return CCEngine.Orientation.target===0||CCEngine.Orientation.target===180};CCEngine.SetOrientation=function(current,target){CCEngine.Orientation.current=current;CCEngine.Orientation.target=target};CCEngine.ProjectOrientation=function(x,y,result){var temp;if(CCEngine.Orientation.target===270){temp=x;x=y;y=temp;x=1-x}else if(CCEngine.Orientation.target===90){temp=x;x=y;y=temp;y=1-y}else if(CCEngine.Orientation.target===180){x=1-x}else{}result(x,y)};CCEngine.ZCompare=function(a,b){var objectA=a;var objectB=b;var drawOrderA=objectA.drawOrder;var drawOrderB=objectB.drawOrder;if(drawOrderA===200||drawOrderB===200){if(drawOrderA===200&&drawOrderB===200){var cameraPosition=CCCameraBase.currentCamera.currentRotatedPosition;var positionA=objectA.position;var positionB=objectB.position;var distanceA=vec3.distance(positionA,cameraPosition,true);var distanceB=vec3.distance(positionB,cameraPosition,true);return distanceB-distanceA}return drawOrderA-drawOrderB}return drawOrderA-drawOrderB};CCEngine.prototype.updateTime=function(){var currentTime=Date.now();var delta=(currentTime-this.lastUpdate)*.001;this.timeReal=delta;delta=delta>.05?.05:delta;this.lastUpdate=currentTime;return delta};CCEngine.RunNextUpdate=function(callback){if(gEngine){if(callback){gEngine.nextUpdateCallbacks.push(callback)}}};CCEngine.prototype.update=function(delta){if(this.nextUpdateCallbacks.length>0){var callback=this.nextUpdateCallbacks.safePop();callback()}if(this.collisionManager.pruneOctreeTimer>0){this.collisionManager.pruneOctreeTimer-=delta;if(this.collisionManager.pruneOctreeTimer<=0){CCOctree.PruneTree(this.collisionManager.octree)}}this.lifetime+=delta;var i,scene;var scenes=this.scenes;var scenesLength=scenes.length;for(i=0;i<scenesLength;++i){scene=scenes[i];if(scene.shouldDelete()){this.removeScene(scene);i--;scenesLength=scenes.length;gRenderer.pendingRender=true}}this.controls.update(delta);for(i=0;i<scenesLength;++i){scenes[i].update(delta)}};CCEngine.prototype.updateControls=function(){var controls=this.controls;var cameras=this.cameras;var camerasLength=cameras.length;var scenes=this.scenes;var scenesLength=scenes.length;for(var cameraIndex=camerasLength-1;cameraIndex>=0;--cameraIndex){var camera=cameras[cameraIndex];if(!camera.enabled){continue}var scene;if(camera.scene){scene=camera.scene;if(scene.updateControls(controls)){return true}}else{for(var i=scenesLength-1;i>=0;--i){scene=scenes[i];if(scene.camera===camera){if(scene.updateControls(controls)){return true}}}}}return false};CCEngine.prototype.newSceneCamera=function(scene,index,CameraType,alwaysOnTop){if(!CameraType){CameraType=CCCameraAppUI}var camera=scene.camera=new CameraType;camera.scene=scene;var cameras=this.cameras;if(index===undefined||index===null){index=cameras.length}if(index>cameras.length){index=cameras.length}if(alwaysOnTop){camera.alwaysOnTop=true}else{for(var i=index-1;i>0;--i){if(cameras[i].alwaysOnTop){index=i}}}cameras.insert(camera,index);if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeSyncCommands+="CCEngine.newSceneCamera;"+scene.sceneID+";"+camera.cameraID+"\n"}return camera};CCEngine.prototype.removeCamera=function(camera){var cameras=this.cameras;if(cameras.remove(camera)){return true}return false};CCEngine.prototype.findCameraIndex=function(camera){return this.cameras.find(camera)};CCEngine.NewScene=function(scene){if(CCEngine.NativeSyncCommands!==undefined){CCEngine.NativeSyncCommands+="CCEngine.NewScene;"+scene.sceneID+"\n"}};CCEngine.prototype.addScene=function(scene){this.scenes.push(scene);scene.setup()};CCEngine.prototype.removeScene=function(scene){var scenes=this.scenes;if(scenes.remove(scene)){if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCEngine.removeScene;"+scene.sceneID+"\n"}scene.destruct();return true}alert("CCEngine.prototype.removeScene failed");return false};CCEngine.EnableBackButton=function(scene){if(CCEngine.BackButtonStack.addOnce(scene)){if(CCEngine.BackButtonStack.length===1){if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCEngine.EnableBackButton;true\n"}}}};CCEngine.DisableBackButton=function(scene){if(CCEngine.BackButtonStack.remove(scene)){if(CCEngine.BackButtonStack.length===0){if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCEngine.EnableBackButton;false\n"}}}};CCEngine.prototype.handleBackButton=function(){if(CCAPIFacebook.IsLoggingIn()){CCAPIFacebook.FinishLogin();return true}else if(CCAPITwitter.IsLoggingIn()){CCAPITwitter.FinishLogin();return true}else if(CCAPIGoogle.IsLoggingIn()){CCAPIGoogle.FinishLogin();return true}else{var scenes=this.scenes;for(var i=scenes.length-1;i>=0;--i){var scene=scenes[i];if(scene.handleBackButton){if(scene.handleBackButton()){return true}}}}if(CCEngine.BackButtonStack.find(gEngine)!==-1){if(!this.sceneMultiLauncher){if(SceneMultiUILauncher.Instance){this.sceneMultiLauncher=SceneMultiUILauncher.Instance}else{this.sceneMultiLauncher=new SceneMultiUILauncher}this.sceneMultiLauncher.show();var self=this;this.sceneMultiLauncher.launch(true,function(){delete self.sceneMultiLauncher});return true}}return false};CCEngine.Pause=function(){CCEngine.paused=true;if(window.gEngine){var scenes=gEngine.scenes;for(var i=scenes.length-1;i>=0;--i){var scene=scenes[i];if(scene.onPause){if(scene.onPause()){return true}}}}if(CCEngine.DeviceType!=="Web"){MultiplayerManager.Disconnect()}CCAudioManager.Pause();gEngine.controls.onPause()};CCEngine.Resume=function(){CCEngine.paused=false;MultiplayerManager.Connect();CCAudioManager.Resume();if(gRenderer){gRenderer.pendingRender=true}};CCEngine.LoadAppInfo=function(appInfo){if(appInfo){window.LAUNCH_APP_ID=appInfo.id;if(appInfo.PURCHASE_ID){window.DEFAULT_PURCHASE_ID=appInfo.PURCHASE_ID}DBApps.AddAppInfo(appInfo);if(appInfo.dbInfos){DBAssets.LoadDBInfos(appInfo.dbInfos)}}};CCEngine.NativeSyncCommands="";CCEngine.NativeUpdateCommands="";CCEngine.NativeRenderCommands="";CCEngine.prototype.setup=function(){gEngine=this;gURLManager=(new CCURLManager).create();this.controls=(new CCControls).create()};CCEngine.prototype.setupRenderer=function(width,height){(new CCRenderer).create(width,height);this.textureManager=new CCTextureManager};CCEngine.prototype.resize=function(){var scenes=this.scenes;var length=scenes.length;for(var i=0;i<length;++i){var scene=scenes[i];scene.resize();scene.resized()}};CCEngine.prototype.setSize=function(width,height){if(gRenderer){gRenderer.setSize(width,height)}{var scenes=this.scenes;var length=scenes.length;for(var i=0;i<length;++i){var scene=scenes[i];scene.resize();scene.resized()}}};CCEngine.prototype.updateOrientation=function(current,target){CCEngine.SetOrientation(current,target);var scenes=this.scenes;var length=scenes.length;for(var i=0;i<length;++i){var scene=scenes[i];scene.resize();scene.resized()}};CCEngine.prototype.render=function(){var renderer=gRenderer;if(renderer.beginRender()){var RenderVisibleObjectsFunction=CC.RenderVisibleObjects;var render_background=CCRenderer.render_background;var render_finished=CCRenderer.render_finished;var i,scene;var scenes=this.scenes;var scenesLength=scenes.length;var cameras=this.cameras;var camerasLength=cameras.length;for(var cameraIndex=0;cameraIndex<camerasLength;++cameraIndex){var camera=cameras[cameraIndex];if(!camera.enabled){continue}camera.setViewport();var lookAt=camera.lookAt;var rotatedPosition=camera.rotatedPosition;CCEngine.NativeSyncCommands+="CCCameraBase.update;"+camera.cameraID+";"+vec3.toString(rotatedPosition)+";"+vec3.toString(lookAt)+"\n";CCEngine.NativeRenderCommands+="CCCameraBase.set;"+camera.cameraID+"\n";for(var pass=render_background;pass<render_finished;++pass){renderer.blendEnabled=false;CCEngine.NativeRenderCommands+="CCRenderer.CCSetBlend;false\n";renderer.depthWriteEnabled=true;CCEngine.NativeRenderCommands+="CCRenderer.CCSetDepthWrite;true\n";renderer.depthReadEnabled=true;CCEngine.NativeRenderCommands+="CCRenderer.CCSetDepthRead;true\n";if(camera.scene){camera.scene.render(camera,pass,false)}else{for(i=0;i<scenesLength;++i){scene=scenes[i];scene.render(camera,pass,false)}}RenderVisibleObjectsFunction(camera,pass,false);renderer.blendEnabled=true;CCEngine.NativeRenderCommands+="CCRenderer.CCSetBlend;true\n";renderer.depthWriteEnabled=false;CCEngine.NativeRenderCommands+="CCRenderer.CCSetDepthWrite;false\n";renderer.depthReadEnabled=false;CCEngine.NativeRenderCommands+="CCRenderer.CCSetDepthRead;false\n";if(camera.scene){camera.scene.render(camera,pass,true)}else{for(i=0;i<scenesLength;++i){scene=scenes[i];scene.render(camera,pass,true)}}RenderVisibleObjectsFunction(camera,pass,true);if(camera.scene){if(camera.scene.postRender){camera.scene.postRender(camera,pass,true)}}else{for(i=0;i<scenesLength;++i){scene=scenes[i];if(scene.postRender){scene.postRender(camera,pass,true)}}}}}this.resyncVisibles=true}};CCEngine.prototype.clearVisibles=function(){var collideables=gEngine.collisionManager.collideables;var collideablesLength=collideables.length;var i,collideable;for(i=0;i<collideablesLength;++i){collideable=collideables[i];collideable.visible=false}};CCEngine.prototype.updateCameraResults=function(cameraID,inViewMatrix,visibleIDs){if(this.resyncVisibles){this.clearVisibles();this.resyncVisibles=false}var collideables=gEngine.collisionManager.collideables;var collideablesLength=collideables.length;var i,collideable;var visibleIDsLength=visibleIDs.length;var cameras=this.cameras;var camerasLength=cameras.length;for(var cameraIndex=0;cameraIndex<camerasLength;++cameraIndex){var camera=cameras[cameraIndex];if(camera.cameraID===cameraID){var viewMatrix=camera.viewMatrix;for(i=0;i<16;++i){viewMatrix[i]=inViewMatrix[i]}var visibleCollideables=camera.visibleCollideables;if(visibleCollideables.length!==visibleIDsLength){visibleCollideables.length=visibleIDsLength}for(var visibleIDIndex=0;visibleIDIndex<visibleIDsLength;++visibleIDIndex){var jsID=visibleIDs[visibleIDIndex];var visibleCollideable=visibleCollideables[visibleIDIndex];if(!visibleCollideable||visibleCollideable.jsID!==jsID){for(i=0;i<collideablesLength;++i){collideable=collideables[i];if(collideable.jsID===jsID){visibleCollideables[visibleIDIndex]=collideable;collideable.visible=true;
break}}}else{visibleCollideable.visible=true}}break}}};CCEngine.prototype.processCppCommands=function(cppCommands){var length=cppCommands.length;for(var i=0;i<length;++i){var command=cppCommands[i];if(command.id==="gEngine.updateCameraResults"){this.updateCameraResults(command.cameraID,command.viewMatrix,command.visibles)}else if(command.id==="gEngine.controls.touchBegin"){this.controls.touchBegin(command.index,command.x,command.y)}else if(command.id==="gEngine.controls.touchMove"){this.controls.touchMove(command.index,command.x,command.y)}else if(command.id==="gEngine.controls.touchEnd"){this.controls.touchEnd(command.index)}else if(command.id==="CC.MovementCollisionCheckResult"){CC.MovementCollisionCheckResult(command.collisionRequestID,command.collisions)}else if(command.id==="gEngine.resume"){this.resume()}else if(command.id==="gEngine.handleBackButton"){this.handleBackButton()}else if(command.id==="CCEngine.InAppPurchased"){SceneItemShop.InAppPurchased()}}};CCEngine.WebViewOpen=function(url,onOpenCallback,onUpdateCallback,params){if(onUpdateCallback){CCEngine.WebViewCallback=onUpdateCallback;CCEngine.NativeUpdateCommands+="CCEngine.WebViewOpen;"+url+"\n"}else{CCEngine.NativeUpdateCommands+="CCEngine.WebBrowserOpen;"+url+"\n"}if(onOpenCallback){onOpenCallback(null,true)}};CCEngine.WebViewProcessURL=function(url,open){if(CCEngine.WebViewCallback){CCEngine.WebViewCallback(null,url,open)}};CCEngine.WebViewClose=function(){if(CCEngine.WebViewCallback){delete CCEngine.WebViewCallback}CCEngine.NativeUpdateCommands+="CCEngine.WebViewClose\n"};CCEngine.IsWebViewOpen=function(webViewController){return false};CCEngine.GetWebView=function(title){return null};CCEngine.UpdateNotification=function(){if(gEngine.lifetime<1){SceneMultiManager.RestartClient()}else{AlertsManager.Notification("","Update Available",function(){SceneMultiManager.RestartClient()})}};function CharacterControllerPlayer(pathFinderNetwork){this.construct(pathFinderNetwork)}CharacterControllerPlayer.state_shooting=0;CharacterControllerPlayer.state_stopping=1;CharacterControllerPlayer.state_stopped=2;CharacterControllerPlayer.prototype.construct=function(pathFinderNetwork){this.updating=true;if(!pathFinderNetwork){pathFinderNetwork=gEngine.collisionManager.pathFinderNetwork}this.pathFinderNetwork=pathFinderNetwork;this.player=null;this.setHealth(100,true);this.damageResistance=0;this.moving=false;this.locationTarget=vec3.create();this.distanceToLocationTarget=CC_MAXFLOAT;this.movementMagnitude=1;this.stopOnCollisions=false;this.receivedLastCollisionTime=0;this.shootingState=CharacterControllerPlayer.state_stopped;this.shootingLocation=vec3.create();this.shootingTarget=null;this.shootingAimHelper=true;this.resetPathNodes();this.enabled=true};CharacterControllerPlayer.prototype.destruct=function(){if(this.shootingState!==CharacterControllerPlayer.state_stopped){this.stopShooting()}};CharacterControllerPlayer.prototype.resetPathNodes=function(){this.anchorNode=null;this.path=null;this.pathAnchorNode=null;this.currentPath=-1;if(this.moving){this.goToScan(this.locationTarget,true)}};CharacterControllerPlayer.prototype.update=function(delta){this.movePlayer(delta);if(this.shootingState!==CharacterControllerPlayer.state_stopped){if(this.shootingState===CharacterControllerPlayer.state_shooting){if(this.shootingTarget){if(!this.shootingTarget.isActive()){this.shootingTarget=null}else{vec3.copy(this.shootingLocation,this.shootingTarget.position)}}var shoot=true;if(this.shootingAimHelper){shoot=false;this.player.aimWeapon(this.shootingLocation);var angleToTarget=this.player.getWeaponAimAngleToTarget(this.shootingLocation);if(angleToTarget<10){shoot=true}}if(shoot){if(!this.player.shootWeapon(delta)){this.shootingState=CharacterControllerPlayer.state_stopping;this.shootingTarget=null}}}else{this.stopShooting()}}return true};CharacterControllerPlayer.prototype.isPerformingAction=function(){return this.shootingState!==CharacterControllerPlayer.state_stopped};CharacterControllerPlayer.prototype.enable=function(toggle){this.enabled=toggle};CharacterControllerPlayer.prototype.setPlayer=function(inPlayer){this.player=inPlayer};CharacterControllerPlayer.prototype.isAI=function(){return false};CharacterControllerPlayer.prototype.getHealth=function(){return this.health};CharacterControllerPlayer.prototype.getHealthRatio=function(){return this.health/this.maxHealth};CharacterControllerPlayer.prototype.setHealth=function(inHealth,initialize){this.health=inHealth;if(initialize){this.maxHealth=inHealth}};CharacterControllerPlayer.prototype.resetHealth=function(){this.health=this.maxHealth};CharacterControllerPlayer.prototype.setMovementMagnitude=function(magnitude){this.movementMagnitude=magnitude};CharacterControllerPlayer.prototype.goToScan=function(target,force){if(force||!vec3.equals(this.locationTarget,target)){var hitObject=CC.MovementCollisionCheck(this.player,this.player.position,target,CC.collision_static);if(hitObject){this.goToUsingPath(target)}else{this.path=null;this.goTo(target)}}return this.locationTarget};CharacterControllerPlayer.prototype.goToUsingPath=function(target){var player=this.player;var targetNode=this.pathFinderNetwork.findClosestNodeToPathTarget(player,target,false);if(!targetNode){this.path=null;this.goTo(target);return}this.anchorNode=null;this.validateAnchorNode();this.pathAnchorNode=this.anchorNode;if(this.pathAnchorNode){var path=this.path=this.pathFinderNetwork.findPath(this.player,this.pathAnchorNode,targetNode);var hitObject;if(path.directions.length===0){this.path=null}else{if(path.endDirection===0){hitObject=CC.MovementCollisionCheck(player,player.position,target,CC.collision_static);if(!hitObject){this.path=null}}else{var pathAnchorNode=this.pathAnchorNode;var pathDirection=path.directions[0];if(pathAnchorNode&&pathDirection<pathAnchorNode.connections.length){var usingConnection=pathAnchorNode.connections[pathDirection];var pathTarget=usingConnection.node.point;hitObject=CC.MovementCollisionCheck(player,player.position,pathTarget,CC.collision_static);if(hitObject){this.currentPath=-1}else{this.currentPath=0}}else{this.currentPath=0}}}}else{this.path=null}this.goTo(target)};CharacterControllerPlayer.prototype.goTo=function(target){var player=this.player;this.distanceToLocationTarget=CC_MAXFLOAT;this.setLocationTarget(target);this.player.movementDirection[2]=this.movementMagnitude;this.moveAction()};CharacterControllerPlayer.prototype.setLocationTarget=function(target){var locationTarget=this.locationTarget;vec3.copy(locationTarget,target);locationTarget[1]+=this.player.collisionBounds[1];if(locationTarget[1]!==this.player.collisionBounds[1]){locationTarget[1]=this.player.collisionBounds[1]}};CharacterControllerPlayer.prototype.validateAnchorNode=function(){if(!this.anchorNode){this.anchorNode=this.pathFinderNetwork.findClosestNodeToPathTarget(this.player,this.player.position,true)}};CharacterControllerPlayer.prototype.shootAt=function(enemy){if(enemy){this.shoot(enemy.position,enemy)}};CharacterControllerPlayer.prototype.shoot=function(target,enemy,actionID){if(this.shootingState!==CharacterControllerPlayer.state_shooting){this.shootingState=CharacterControllerPlayer.state_shooting}if(target){vec3.copy(this.shootingLocation,target);this.shootingLocation[1]+=this.player.collisionBounds[1]}if(enemy){this.shootingTarget=enemy}this.player.readyWeapon(actionID)};CharacterControllerPlayer.prototype.scanForEnemy=function(target){var hScanArea=this.player.collisionSize.width*2;var min=vec3.clone(target);min[0]-=hScanArea;min[2]-=hScanArea;var max=vec3.clone(target);max[0]+=hScanArea;max[2]+=hScanArea;return CC.CollideableScan(min,max,this.player,CC.collision_character)};CharacterControllerPlayer.prototype.stopShooting=function(){this.shootingState=CharacterControllerPlayer.state_stopped;this.player.unReadyWeapon();if(this.player.setActionID){this.player.setCurrentActionPriority(0);if(this.moving){this.player.setMovementAnimation()}else{this.player.setIdleAnimation()}}};CharacterControllerPlayer.prototype.recieveCollisionFrom=function(collisionSource){if(this.moving){if(this.stopOnCollisions){this.player.movementDirection[2]=0;this.stopAction()}else if(!this.collidedWhileMoving){this.collidedWhileMoving=true;this.collidedWhileMovingTime=gEngine.lifetime;if(!this.collidedWhileMovingPosition){this.collidedWhileMovingPosition=vec3.clone(this.player.position)}else{vec3.copy(this.collidedWhileMovingPosition,this.player.position)}}}};CharacterControllerPlayer.prototype.reportAttack=function(attackedBy,attackType,force,damage,x,y,z){};CharacterControllerPlayer.prototype.movePlayer=function(delta){if(this.moving){var player=this.player;var path=this.path;var pathAnchorNode=this.pathAnchorNode;var distance,target,hitObject;if(this.collidedWhileMoving){var difference=gEngine.lifetime-this.collidedWhileMovingTime;if(difference>.25){var movementLength=vec3.distance(this.collidedWhileMovingPosition,this.player.position);if(movementLength>.5){this.collidedWhileMoving=false}else{this.player.movementDirection[2]=0;this.stopAction()}}}if(path){if(!pathAnchorNode){this.path=null}else if(this.currentPath===-1){target=pathAnchorNode.point;player.turnPlayer(target,delta);distance=CC.Vector3Distance2D(player.position,target,true);if(distance<1*1){this.currentPath=0}}else{var validPath=false;if(this.currentPath<path.endDirection){var pathDirection=path.directions[this.currentPath];if(pathDirection<pathAnchorNode.connections.length){var usingConnection=pathAnchorNode.connections[pathDirection];target=usingConnection.node.point;if(target){validPath=true;player.turnPlayer(target,delta);distance=CC.Vector3Distance2D(player.position,target,true);if(distance<100*100){var goToNext=distance<.1+player.collisionBounds[1];if(!goToNext){var testTarget=this.locationTarget;{hitObject=CC.MovementCollisionCheck(player,player.position,testTarget,CC.collision_static);goToNext=!hitObject}if(this.currentPath+1<path.endDirection){if(goToNext){goToNext=false;this.path=null}else{var nextConnection=usingConnection.node.connections[path.directions[this.currentPath+1]];testTarget=nextConnection.node.point;if(!testTarget){testTarget=locationTarget}hitObject=CC.MovementCollisionCheck(player,player.position,testTarget,CC.collision_static);goToNext=!hitObject}}}if(goToNext){this.pathAnchorNode=usingConnection.node;this.anchorNode=pathAnchorNode;this.currentPath++;if(this.currentPath>=path.endDirection){this.path=null}}}}}}if(!validPath){this.goTo(this.locationTarget)}}}else{distance=CC.Vector3Distance2D(player.position,this.locationTarget,true);if(distance>5*5){player.turnPlayer(this.locationTarget,delta)}else{this.landPlayerOnTarget(distance,delta)}}this.player.dirtyModelMatrix()}};CharacterControllerPlayer.prototype.landPlayerOnTarget=function(distance,delta){var player=this.player;var locationTarget=this.locationTarget;if(this.distanceToLocationTarget===CC_MAXFLOAT){var angleTowardsTarget=CC.AngleTowardsVector(locationTarget,player.position);var angleDistance=CC.DistanceBetweenAngles(player.rotation[1],angleTowardsTarget);if(angleDistance>15){player.turnPlayer(locationTarget,delta);player.movementDirection[2]=0;return false}else{this.distanceToLocationTarget=distance}}if(distance<=this.distanceToLocationTarget){this.distanceToLocationTarget=distance;player.movementDirection[2]=.5}else{var collidedWith=CC.CollisionCheck(player,locationTarget,true,CC.collision_box);if(!collidedWith){player.setPosition(locationTarget)}player.movementDirection[2]=0;this.stopAction();return true}return false};CharacterControllerPlayer.prototype.moveAction=function(){if(this.player.setMovementAnimation){this.player.setMovementAnimation()}this.moving=true;if(this.collidedWhileMoving){this.collidedWhileMoving=false}};CharacterControllerPlayer.prototype.stopAction=function(){this.setLocationTarget(this.player.position);if(this.player.setIdleAnimation){this.player.setIdleAnimation()}this.moving=false};function CharacterControllerAI(pathFinderNetwork){this.construct(pathFinderNetwork)}ExtendPrototype(CharacterControllerAI,CharacterControllerPlayer);CharacterControllerAI.cycle_off=0;CharacterControllerAI.cycle_inOrder=1;CharacterControllerAI.cycle_randomNodes=2;CharacterControllerAI.cycle_randomConnections=3;CharacterControllerAI.cycle_towardsEnemy=4;CharacterControllerAI.max_waypoints=50;CharacterControllerAI.prototype.construct=function(pathFinderNetwork){this.CharacterControllerPlayer_construct(pathFinderNetwork);this.waypoints=[];this.waypointCurrent=0;this.waypointCycle=CharacterControllerAI.cycle_off;this.targetConnection=null;this.nodesPerMovementCycle=0;this.waitTime=0;this.enemy=null;this.scanForEnemyTimer=0;this.scanForEnemyTime=2;this.shouldFollowEnemy=true;this.followingEnemy=false;this.distanceToEnemy=CC_MAXFLOAT;this.shouldShootAtEnemy=true;this.shootingTimer=0;this.shootingBurstTime=CC_MAXFLOAT;this.lastShotTime=0;this.shootingWaitTime=0};CharacterControllerAI.prototype.destruct=function(){this.CharacterControllerPlayer_destruct()};CharacterControllerAI.prototype.update=function(delta){if(this.enabled){var enemy=this.enemy;if(enemy){if(!enemy.isActive()){this.enemy=null}else{this.scanForEnemyTimer+=delta;if(this.scanForEnemyTimer>this.scanForEnemyTime){this.scanForEnemyTimer-=this.scanForEnemyTime;this.distanceToEnemy=CC.Vector3Distance2D(this.player.position,this.enemy.position,true);if(this.shouldFollowEnemy&&this.distanceToEnemy<CC.SQUARE(150)){this.followEnemy()}else if(!this.moving){if(this.followingEnemy){this.followingEnemy=false}this.nextWaypoint()}}}}if(this.shootingState===CharacterControllerPlayer.state_stopped){this.lastShotTime+=delta;if(this.lastShotTime>this.shootingWaitTime){if(this.followingEnemy){if(!enemy){this.followingEnemy=false}else if(this.shouldShootAtEnemy){if(this.distanceToEnemy<CC.SQUARE(100)){this.shoot(enemy.position,enemy);this.lastShotTime=0}}}}}else{this.shootingTimer+=delta;if(this.shootingTimer>this.shootingBurstTime){this.stopShooting()}}}return this.CharacterControllerPlayer_update(delta)};CharacterControllerAI.prototype.isAI=function(){return true};CharacterControllerAI.prototype.movePlayer=function(delta){var player=this.player;if(this.waitTime>0){player.movementDirection[2]=0;this.waitTime-=delta;if(this.waitTime<=0){this.nextWaypoint()}}else if(this.moving){if(this.path){this.CharacterControllerPlayer_movePlayer(delta)}else{var distance=CC.Vector3Distance2D(player.position,this.locationTarget,true);if(distance>5*5){player.turnPlayer(this.locationTarget,delta)}else{if(this.landPlayerOnTarget(distance,delta)){if(!this.followingEnemy&&this.enabled){if(this.waypointCycle===CharacterControllerAI.cycle_randomConnections||this.waypointCycle===CharacterControllerAI.cycle_towardsEnemy){this.waitTime=CC.Random()%5+1}else{this.nextWaypoint()}}}}}}};CharacterControllerAI.prototype.recieveCollisionFrom=function(collidedWith){if(this.followingEnemy){this.followingEnemy=false;this.validateAnchorNode()}if(this.waypointCycle===CharacterControllerAI.cycle_randomConnections){this.waitTime=0;this.pickRandomConnection()}else{this.nextWaypoint()}};CharacterControllerAI.prototype.reportAttack=function(attackedBy,attackType,force,damage,x,y,z){return this.CharacterControllerPlayer_reportAttack(attackedBy,attackType,force,damage,x,y,z)};CharacterControllerAI.prototype.setEnemy=function(inEnemy){this.enemy=inEnemy};CharacterControllerAI.prototype.followEnemy=function(){this.goToUsingPath(this.enemy.position);this.followingEnemy=true};CharacterControllerAI.prototype.setWaypointCycle=function(inCycleType){this.waypointCycle=inCycleType;if(this.enabled){if(this.waypointCycle===CharacterControllerAI.cycle_randomNodes){this.waypointCurrent=CC.Random()%this.waypoints.length;this.goTo(waypoints[this.waypointCurrent])}else if(this.waypointCycle===CharacterControllerAI.cycle_randomConnections){this.validateAnchorNode();this.pickRandomConnection()}}};CharacterControllerAI.prototype.addWaypoint=function(target){this.waypoints.add(target);if(this.enabled&&!this.moving){this.waypointCurrent=this.waypoints.length-1;this.goToUsingPath(target)}};CharacterControllerAI.prototype.scanWaypoints=function(radius,amount){if(amount===undefined){amount=CharacterControllerAI.max_waypoints}var points=[];var found=this.pathFinderNetwork.findClosestNodes(this.player.position,radius,points,amount);for(var i=0;i<found;++i){this.addWaypoint(points[i])}};CharacterControllerAI.prototype.nextWaypoint=function(){if(this.waypointCycle===CharacterControllerAI.cycle_randomConnections){if(this.targetConnection&&this.targetConnection.node){this.anchorNode=this.targetConnection.node;this.pickClosestAngledConnection()}else{this.pickRandomConnection()}}else if(this.waypointCycle===CharacterControllerAI.cycle_towardsEnemy){if(this.enemy){var player=this.player;var enemy=this.enemy;var distance=CC.Vector3Distance2D(player.position,enemy.position,true);if(distance>CC.SQUARE(player.collisionSize.width*3)){var direction=CC.Vector3Direction(player.position,enemy.position);var target=direction;vec3.scale(target,direction,player.collisionSize.width);vec3.add(direction,player.position,direction);this.goTo(target)}}}else{if(this.waypointCycle===CharacterControllerAI.cycle_off){if(this.waypoints.length>0){for(var i=0;i<this.waypoints.length-1;++i){this.waypoints[i]=this.waypoints[i+1]}this.waypoints.length--;if(this.waypoints.length>0){goToUsingPath(waypoints[0])}}}else if(this.waypointCycle===CharacterControllerAI.cycle_inOrder){this.waypointCurrent++;if(this.waypointCurrent>=this.waypoints.length){this.waypointCurrent=0}}else if(this.waypointCycle===CharacterControllerAI.cycle_randomNodes){this.waypointCurrent=CC.Random()%this.waypoints.length}if(this.waypointCurrent<this.waypoints.length){this.goToUsingPath(this.waypoints[this.waypointCurrent])}}};CharacterControllerAI.prototype.pickClosestAngledConnection=function(){if(this.enabled){if(this.anchorNode&&this.anchorNode.connections.length>0){var player=this.player;var closestConnection=0;var closestAngle=CC_MAXFLOAT;var anchorNode=this.anchorNode;var anchorNodeConnections=anchorNode.connections;for(i=0;i<anchorNodeConnections.length;++i){var angleDistance=CC.DistanceBetweenAngles(player.rotation[1],anchorNodeConnections[i].angle);if(angleDistance<closestAngle){closestConnection=i;closestAngle=angleDistance}}this.targetConnection=anchorNodeConnections[closestConnection];this.goTo(this.targetConnection.node.point)}else{this.anchorNode=null;this.validateAnchorNode();this.pickRandomConnection()}}};CharacterControllerAI.prototype.pickRandomConnection=function(){if(this.enabled){this.validateAnchorNode();if(this.anchorNode&&this.anchorNode.connections.length>0){var randomPath=CC.Random()%this.anchorNode.connections.length;this.targetConnection=this.anchorNode.connections[randomPath];this.goTo(this.targetConnection.node.point)}}};function CharacterPlayer(inMovementSpeed,inCharacterSize){this.construct(inMovementSpeed,inCharacterSize)}ExtendPrototype(CharacterPlayer,CCMoveable);CharacterPlayer.Spawn=function(type,obj,tex,speed,size,onLoadedCallback){var character=new CharacterPlayer(speed,size);character.type=type;character.setupBody(obj,tex,function(){character.finalizeModel();{character.finalizeModel();character.setupWeapon(character.modelBody);if(onLoadedCallback){onLoadedCallback(character)}}});return character};CharacterPlayer.prototype.construct=function(inMovementSpeed,inCharacterSize){this.CCMoveable_construct();this.collisionBoxMultiple=1.25;if(!inMovementSpeed){inMovementSpeed=50}this.movementSpeed=inMovementSpeed;this.turningSpeed=720;this.instantTurns=false;if(!inCharacterSize){inCharacterSize=15}this.characterSize=inCharacterSize;this.collideableType=CC.AddFlag(this.collideableType,CC.collision_character);this.controller=null;this.gravity=false;this.sceneMap=null;this.playerID="";this.userID="";this.type="";this.modelBody=this.modelHead=null;this.setModel(new CCModelBase);this.model3DBase=new CCModelBase;this.model.addModel(this.model3DBase);this.modelWeaponBase=this.model3DBase;this.modelRotationTargetActive=false;this.modelRotationTarget=0;this.modelHeadAnimationActive=false;this.modelHeadAnimationState=0;this.characterIndicator=null;this.shootingIndicator=null;this.shootingScaleInterpolator=new CCInterpolatorV3(CCInterpolatorSin2Curve);this.lastTimeAttacked=0;this.deathFadeOut=false;this.weapons=[];this.shootingBurstTimer=0;this.setTransparent(true);this.setColourAlpha(0,false);this.setColourAlpha(.25,true);this.setupWeapon(this.model3DBase);this.finalizeModel()};CharacterPlayer.prototype.setSize=function(size){this.characterSize=size;this.finalizeModel()};CharacterPlayer.prototype.deleteLater=function(){if(this.sceneMap){this.sceneMap.deletingCharacter(this)}this.CCMoveable_deleteLater()};CharacterPlayer.prototype.dirtyModelMatrix=function(){this.CCMoveable_dirtyModelMatrix();var position=this.position;if(this.characterIndicator){this.characterIndicator.setPositionXZ(position[0],position[2])}if(this.shootingIndicator){this.shootingIndicator.setPositionXZ(position[0],position[2])}};CharacterPlayer.prototype.setupMap=function(sceneMap,playerID,userID){this.setScene(sceneMap);this.sceneMap=sceneMap;this.setPlayerIDs(playerID,userID)};CharacterPlayer.prototype.getMap=function(){return this.sceneMap};CharacterPlayer.prototype.getType=function(){return this.type};CharacterPlayer.prototype.setupAI=function(controller){if(this.controller){this.removeUpdater(this.controller);this.controller.destruct()}this.controller=controller;this.controller.setPlayer(this);this.addUpdater(controller)};CharacterPlayer.prototype.setupBody=function(modelFile,textureFile,callback){var self=this;var LoadedModelFunction=function(modelFile,textureFile){self.loadingBodyModel=modelFile;self.loadingBodyTexture=textureFile;return function(model3d){if(self.loadingBodyModel===modelFile&&self.loadingBodyTexture===textureFile){delete self.loadingBodyModel;delete self.loadingBodyTexture;if(model3d){if(self.modelBody){self.model3DBase.removeModel(self.modelBody);self.modelBody.destruct();self.modelBody=null}self.setColourAlpha(1,true,function(){if(!self.forceTransparent){self.setTransparent(false)}});self.modelBody=model3d}callback(model3d)}else if(model3d){self.model3DBase.removeModel(model3d)}}};this.setupModel(modelFile,textureFile,new LoadedModelFunction(modelFile,textureFile))};CharacterPlayer.prototype.setupHead=function(modelFile,textureFile,callback){var self=this;this.setupModel(modelFile,textureFile,function(model3d){self.modelHead=model3d;callback()})};CharacterPlayer.prototype.finalizeModel=function(){var characterSize=this.characterSize;var modelWidth=characterSize;var modelDepth=characterSize;var bodyHeight=characterSize;var modelBody=this.modelBody;var modelHead=this.modelHead;if(modelBody){modelWidth=modelBody.getWidth();modelDepth=modelBody.getDepth();bodyHeight=modelBody.getHeight()}var modelHeight=bodyHeight;this.finalizeSize(modelWidth,modelDepth,modelHeight)};CharacterPlayer.prototype.finalizeSize=function(modelWidth,modelDepth,modelHeight){var characterSize=this.characterSize;var modelSize=modelHeight>modelWidth?modelHeight:modelWidth;if(modelSize<modelDepth){modelSize=modelDepth}var scaleFactor=characterSize/modelSize;this.model3DBase.setScale(scaleFactor);modelWidth*=scaleFactor;modelDepth*=scaleFactor;modelHeight*=scaleFactor;this.setSquareCollisionBounds(characterSize*this.collisionBoxMultiple,modelHeight)};CharacterPlayer.prototype.setupWeapon=function(modelObj,index){if(modelObj){if(index===undefined){index=0}var weapon;var weapons=this.weapons;if(weapons.length>index){weapon=weapons[index];weapons.remove(weapon);weapon.destruct()}weapon=new WeaponBase(this);weapon.setup(modelObj);weapons.insert(weapon,index)}};CharacterPlayer.prototype.useableWeapon=function(weaponName){return false};CharacterPlayer.prototype.setWeaponSettings=function(timeToReady,bulletDamage,bulletTax,fireChargeRate){var weapons=this.weapons;for(var i=0;i<weapons.length;++i){var weapon=weapons[i];if(timeToReady){weapon.setTimeToReady(timeToReady)}if(bulletDamage){weapon.setBulletDamage(bulletDamage)}if(bulletTax){weapon.setBulletTax(bulletTax)}if(fireChargeRate){weapon.setChargeRate(fireChargeRate)}}};CharacterPlayer.prototype.setWeaponBulletSpeed=function(bulletSpeed){var weapons=this.weapons;for(var i=0;i<weapons.length;++i){var weapon=weapons[i];weapon.setupBullet(null,bulletSpeed)}};CharacterPlayer.prototype.rechargeWeapon=function(){var weapons=this.weapons;for(var i=0;i<weapons.length;++i){weapons[i].addAmmo(1)}};CharacterPlayer.prototype.setupModel=function(modelFile,tex,callback){var self=this;if(tex){gEngine.textureManager.getTextureHandle(tex)}CCModel3D.CacheModel(modelFile,true,function(model3d){if(model3d){if(tex){model3d.setTexture(tex)}self.model3DBase.addModel(model3d);callback(model3d)}else{callback(model3d)}},2)};CharacterPlayer.prototype.setupCharacterIndicator=function(textureFile,colour){this.characterIndicator=new CollideableIndicator(this,textureFile);this.characterIndicator.setDrawOrder(97);this.characterIndicator.setScale(2);this.characterIndicator.setColour(colour)};CharacterPlayer.prototype.setupShootingIndicator=function(textureFile,colour){this.shootingIndicator=new CollideableIndicator(this,textureFile);this.shootingIndicator.setScale(0);this.shootingIndicator.setColour(colour)};CharacterPlayer.prototype.scaleShootingIndicator=function(target){if(this.shootingIndicator){if(this.shootingIndicator.scale){if(target>0){this.shootingScaleInterpolator.setDuration(.5)}else{this.shootingScaleInterpolator.setDuration(2)}this.shootingScaleInterpolator.setup(this.shootingIndicator.scale,target)}}};CharacterPlayer.prototype.update=function(delta){if(this.deathFadeOut){this.deleteLater()}if(this.modelHeadAnimationActive&&this.modelHead){var modelHead=this.modelHead;var angle=5;var speed=delta*30;if(this.modelHeadAnimationState===0){if(modelHead.rotation[2]!==angle){modelHead.rotation[2]=CC.ToRotation(modelHead.rotation[2],angle,speed);modelHead.rotationUpdated()}else{modelHeadAnimationState=1}}else if(modelHeadAnimationState===1){if(modelHead.rotation[2]!==360-angle){modelHead.rotation[2]=CC.ToRotation(modelHead.rotation[2],360-angle,speed);modelHead.rotationUpdated()}else{this.modelHeadAnimationState=0}}}if(this.updateModelMatrix){var position=this.position;if(this.characterIndicator){this.characterIndicator.setPositionXZ(position[0],position[2])}if(this.shootingIndicator){this.shootingIndicator.setPositionXZ(position[0],position[2])}}if(this.characterIndicator){this.characterIndicator.rotateY(delta*-180)}if(this.shootingIndicator){this.shootingScaleInterpolator.update(delta);if(this.shootingIndicator.scale[0]>0){this.shootingIndicator.rotateY(delta*720)}}{var weapons=this.weapons;var updatedAmmo=false;for(var i=0;i<weapons.length;++i){var weapon=weapons[i];if(weapon.updateCharge(delta)){updatedAmmo=true}}if(updatedAmmo){if(this.sceneMap){this.sceneMap.registerAmmoUpdate(this)}}}var updated=this.CCMoveable_update(delta);this.updateWeaponAim(delta);return updated};CharacterPlayer.prototype.renderModel=function(alpha){if(this.modelBody){this.CCMoveable_renderModel(alpha)}else if(alpha){if(!this.disableCulling){gRenderer.CCSetCulling(false)}if(!this.readDepth){gRenderer.CCSetDepthRead(true)}CCRenderer.GLPushMatrix();gRenderer.CCSetColour(this.colour);gEngine.textureManager.setTextureIndex(1);var size=this.collisionSize.width;CCRenderer.GLScale([size,size,size]);gRenderer.CCRenderCube(false);CCRenderer.GLPopMatrix();if(!this.readDepth){gRenderer.CCSetDepthRead(false)}if(!this.disableCulling){gRenderer.CCSetCulling(true)}}};CharacterPlayer.prototype.requestCollisionWith=function(collisionTarget){var collidedWith=this.CCMoveable_requestCollisionWith(collisionTarget);if(collidedWith){if(collidedWith.getType()==="health"){var pickup=collidedWith;if(pickup){if(this.sceneMap){if(this.sceneMap.handlePickup(this,pickup)){collidedWith=null}}}}if(collidedWith){if(this.controller){this.controller.recieveCollisionFrom(collisionTarget)}}return collidedWith}return null};CharacterPlayer.prototype.recieveCollisionFrom=function(collisionSource,x,y,z){if(this.controller){this.controller.recieveCollisionFrom(collisionSource)}return this.CCMoveable_recieveCollisionFrom(collisionSource,x,y,z)};CharacterPlayer.prototype.reportAttack=function(attackedBy,attackType,force,damage,x,y,z){if(this.isActive()&&this.controller){var sinceLastAttack=gEngine.lifetime-this.lastTimeAttacked;if(sinceLastAttack>.25){this.lastTimeAttacked=gEngine.lifetime;{var particle=new CollideableParticle(3);particle.setModel(new CCModelBase);particle.setColour(new CCColour);var primitive=new CCPrimitiveSquare;particle.model.addPrimitive(primitive);particle.model.setScale(30);primitive.setTexture("fx_impact_texture.png",true,true);particle.setScene(this.inScene);this.ownObject(particle);particle.setPosition(this.position);particle.setRotationY(this.sceneMap.camera.rotation[1])}}this.controller.reportAttack(attackedBy,attackType,force,damage,x,y,z);return this.handleAttack(attackedBy,attackType,force,damage,x,y,z)}return false};CharacterPlayer.prototype.handleAttack=function(attackedBy,attackType,force,damage,x,y,z){var killed=false;var map=this.sceneMap;var health=this.controller.getHealth();if(health>0){health-=damage;this.controller.setHealth(health);if(health<=0){this.handleDeath(attackedBy);killed=true}}var attackVelocity=vec3.clone([x,y,z]);vec3.unitize(attackVelocity);vec3.scale(attackVelocity,attackVelocity,force*.1);this.incrementAdditionalVelocity(attackVelocity[0],attackVelocity[1],attackVelocity[2]);map.registerDamage(attackedBy,this,damage);return killed};CharacterPlayer.prototype.handleDeath=function(killer){this.sceneMap.registerDeath(this.playerID,killer,false)};CharacterPlayer.prototype.setPlayerIDs=function(playerID,userID){this.playerID=playerID;this.userID=userID};CharacterPlayer.prototype.getPlayerID=function(){return this.playerID};CharacterPlayer.prototype.getUserID=function(){return this.userID};CharacterPlayer.prototype.activateHeadAnimation=function(){this.modelHeadAnimationActive=true};CharacterPlayer.prototype.readyWeapon=function(actionID){this.shootingBurstTimer=1};CharacterPlayer.prototype.unReadyWeapon=function(){this.unAimWeapon()};CharacterPlayer.prototype.shotFired=function(weapon){if(this.sceneMap){this.sceneMap.registerAttacking(this)}};CharacterPlayer.prototype.shootWeapon=function(delta){var showShootingIndicator=false;var weapons=this.weapons;for(var i=0;i<weapons.length;++i){var previousWeapon=i>0?weapons[i-1]:null;if(previousWeapon){if(previousWeapon.getTimeSinceLastShot()<.05){showShootingIndicator=true;break}}var weapon=weapons[i];if(weapon.hasEnoughAmmo()){showShootingIndicator=true;if(weapon.isReady()){weapon.shootWeapon(this.modelRotationTarget);this.shotFired(weapon)}}}if(showShootingIndicator){this.scaleShootingIndicator(2)}else{this.scaleShootingIndicator(0)}this.shootingBurstTimer-=delta;if(this.shootingBurstTimer<=0){this.shootingBurstTimer=0;return false}return true};CharacterPlayer.prototype.getWeaponAimAngleToTarget=function(target){var baseRotation=0-this.rotation[1];var combinedRotation=baseRotation+this.modelRotationTarget;var targetRotation=combinedRotation;targetRotation=CC.ClampRotation(targetRotation);var distance=CC.DistanceBetweenAngles(this.modelWeaponBase.rotation[1],targetRotation);return distance};CharacterPlayer.prototype.getModelRotation=function(){return this.rotation[1]+this.modelWeaponBase.rotation[1]};CharacterPlayer.prototype.aimWeapon=function(target){this.modelRotationTargetActive=true;this.modelRotationTarget=CC.AngleTowardsVector(target,this.position)};CharacterPlayer.prototype.unAimWeapon=function(){this.scaleShootingIndicator(0);this.modelRotationTargetActive=false;this.modelRotationTarget=0};CharacterPlayer.prototype.updateWeaponAim=function(timeDelta){var i;var weapons=this.weapons;var modelWeaponBase=this.modelWeaponBase;if(this.modelRotationTargetActive){var baseRotation=0-this.rotation[1];var combinedRotation=baseRotation+this.modelRotationTarget;var targetRotation=combinedRotation;
targetRotation=CC.ClampRotation(targetRotation);if(modelWeaponBase.rotation[1]!==targetRotation){if(this.instantTurns){modelWeaponBase.setRotationY(targetRotation)}else{modelWeaponBase.setRotationY(CC.ToRotation(modelWeaponBase.rotation[1],targetRotation,timeDelta*this.turningSpeed))}for(i=0;i<weapons.length;++i){weapons[i].updateParentRotation(modelWeaponBase.rotation[1])}}}else{if(modelWeaponBase.rotation[1]!==0){if(this.instantTurns){modelWeaponBase.setRotationY(0)}else{modelWeaponBase.setRotationY(CC.ToRotation(modelWeaponBase.rotation[1],0,timeDelta*this.turningSpeed*.5))}for(i=0;i<weapons.length;++i){weapons[i].updateParentRotation(modelWeaponBase.rotation[1])}}}};CharacterPlayer.prototype.getWeaponAmmo=function(){var weapons=this.weapons;if(weapons.length===0){return 1}var ammo=0;for(var i=0;i<weapons.length;++i){ammo+=weapons[i].getAmmo()}return ammo};CharacterPlayer.prototype.triggerDeath=function(attackedBy,force,x,y,z){this.collideableType=CC.collision_none;vec3.scale(this.movementDirection,this.movementDirection,0);this.removeUpdater(this.controller);this.controller.destruct();this.deleteLater()};CharacterPlayer.prototype.animatedDeath=function(){this.deathFadeOut=true;if(this.owner){this.owner.unOwnObject(this);this.owner=null}};CharacterPlayer.prototype.turnPlayer=function(target,delta){var angleTowardsTarget=CC.AngleTowardsVector(target,this.position);if(this.instantTurns){this.setRotationY(angleTowardsTarget);return 0}this.setRotationY(CC.ToRotation(this.rotation[1],angleTowardsTarget,delta*this.turningSpeed));return angleTowardsTarget};function CharacterPlayerModel(){this.construct()}ExtendPrototype(CharacterPlayerModel,CharacterPlayer);CharacterPlayerModel.Spawn=function(type,onLoadedCallback){var character=new CharacterPlayerModel;character.type=type;DBAssets.LoadModelID(type,function(modelInfo){var obj=modelInfo.obj;var tex=modelInfo.tex;character.setupBody(obj,tex,function(){character.finalizeModel();if(onLoadedCallback){onLoadedCallback(character)}})});return character};CharacterPlayerModel.prototype.finalizeModel=function(){var characterSize=this.characterSize;var modelWidth=characterSize;var modelDepth=characterSize;var bodyHeight=characterSize;var modelBody=this.modelBody;if(modelBody){modelWidth=modelBody.getWidth();modelDepth=modelBody.getDepth();bodyHeight=modelBody.getHeight()}var modelHeight=bodyHeight;this.finalizeSize(modelWidth,modelDepth,modelHeight)};CharacterPlayerModel.prototype.update=function(delta){this.CharacterPlayer_update(delta);if(this.modelBody){this.modelBody.animate(delta*this.movementDirection[2])}};function CharacterPlayerPrefab(){this.construct()}ExtendPrototype(CharacterPlayerPrefab,CharacterPlayer);CharacterPlayerPrefab.Spawn=function(type,onLoadedCallback){var character=new CharacterPlayerPrefab;character.type=type;character.collisionBoxMultiple=.5;character.finalizeModel();var LoadedCharacterID=function(character){return function(characterInfo){if(characterInfo){var actions=characterInfo.actions;if(actions){for(var i=0;i<actions.length;++i){character.actions[i]=actions[i];character.loadAction(i,i===0?1:0)}}}}};DBAssets.LoadCharacterID(type,new LoadedCharacterID(character),character);return character};CharacterPlayerPrefab.prototype.loadAction=function(i,priority){var actions=this.actions;if(i<actions.length){var self=this;var action=actions[i];var LoadedModelID=function(i){return function(modelInfo){actions[i].modelInfo=modelInfo;if(i===0){if(modelInfo){self.setupBody(modelInfo.obj,modelInfo.tex,function(model3d){self.finalizeModel()})}}if(self.currentActionIndex===i){self.setActionIndex(i)}}};DBAssets.LoadModelID(action.modelID,new LoadedModelID(i),priority,this);if(action.sfxID){DBAssets.LoadAudioID(action.sfxID,function(sfxInfo){if(sfxInfo){action.sfxInfo=sfxInfo}})}}};CharacterPlayerPrefab.prototype.construct=function(){this.CharacterPlayer_construct();this.actions=[];this.setActionIndex(0);this.animationSpeed=1};CharacterPlayerPrefab.prototype.destruct=function(){this.CharacterPlayer_destruct()};CharacterPlayerPrefab.prototype.deleteLater=function(){DBAssets.RemoveUpdateCallbacks(this)};CharacterPlayerPrefab.prototype.finalizeModel=function(){var characterSize=this.characterSize;var modelWidth=characterSize;var modelDepth=characterSize;var bodyHeight=characterSize;var modelBody=this.modelBody;if(modelBody){modelWidth=modelBody.getWidth();modelDepth=modelBody.getDepth();bodyHeight=modelBody.getHeight()}var modelHeight=bodyHeight;this.finalizeSize(modelWidth,modelDepth,modelHeight)};CharacterPlayerPrefab.prototype.update=function(delta){this.CharacterPlayer_update(delta);if(this.modelBody&&!this.animationPaused){this.modelBody.animate(delta*this.animationSpeed,this.currentActionPriority===0)}var sinceLastAttack;if(this.currentActionID==="hit"){sinceLastAttack=gEngine.lifetime-this.lastTimeAttacked;if(sinceLastAttack>.5){this.setCurrentActionPriority(0);this.setIdleAnimation()}}else if(this.currentActionID==="ko"){sinceLastAttack=gEngine.lifetime-this.lastTimeAttacked;if(sinceLastAttack>2){this.setCurrentActionPriority(0);this.setIdleAnimation()}}};CharacterPlayerPrefab.prototype.setCurrentActionPriority=function(priority){this.currentActionPriority=priority};CharacterPlayerPrefab.prototype.setActionID=function(actionID,priority){if(this.currentActionID!==actionID){var actions=this.actions;for(var i=0;i<actions.length;++i){if(actions[i].actionID===actionID){this.setActionIndex(i,priority);return true}}}return false};CharacterPlayerPrefab.prototype.setActionIndex=function(actionIndex,priority){if(priority===undefined){priority=0}if(this.currentActionPriority===undefined){this.currentActionPriority=0}if(priority>=this.currentActionPriority){this.currentActionLoaded=false;this.currentActionPriority=priority;this.currentActionIndex=actionIndex;if(this.modelBody){var action=this.actions[actionIndex];if(action){this.currentActionID=action.actionID;if(actionIndex<this.actions.length){var modelInfo=action.modelInfo;if(modelInfo){this.currentActionLoaded=true;var obj=modelInfo.obj;var tex=modelInfo.tex;if(this.modelBody.primitive.filename!==obj){var self=this;self.setupBody(obj,tex,function(model3d){self.finalizeModel();if(model3d){var modelHeight=model3d.getHeight()*self.model3DBase.scale[1];var modelShouldBeAtY=modelHeight*.5;var characterY=self.collisionBounds[1];model3d.setPositionY(-(characterY-modelShouldBeAtY)*.5)}})}else if(this.modelBody.primitive.tex!==tex){if(tex){this.modelBody.setTexture(tex)}}}if(action.sfxInfo){CCAudioManager.Play("sfx",action.sfxInfo.mp3,true)}}}}}return false};CharacterPlayerPrefab.prototype.setupAI=function(controller){this.CharacterPlayer_setupAI(controller)};CharacterPlayerPrefab.prototype.setupWeapon=function(modelObj,index){if(modelObj){if(index===undefined){index=0}var weapon;var weapons=this.weapons;if(weapons.length>index){weapon=weapons[index];weapons.remove(weapon);weapon.destruct()}weapon=new WeaponBase(this);weapon.setup(modelObj,false,false);weapon.setFireRate(1);weapon.setupBullet(.5,10,false);weapons.insert(weapon,index)}};CharacterPlayerPrefab.prototype.readyWeapon=function(actionID){this.CharacterPlayer_readyWeapon(actionID);this.setActionID(actionID,1);if(this.modelBody){this.modelBody.setAnimationFrame(0)}this.animationPaused=true};CharacterPlayerPrefab.prototype.unReadyWeapon=function(){if(this.animationPaused){this.animationPaused=false}this.CharacterPlayer_unReadyWeapon()};CharacterPlayerPrefab.prototype.shootWeapon=function(delta){if(this.animationPaused){var weapons=this.weapons;for(var i=0;i<weapons.length;++i){var weapon=weapons[i];if(weapon.timeToReady<.25){this.shootingBurstTimer=1;this.animationPaused=false;break}}}return this.CharacterPlayer_shootWeapon(delta)};CharacterPlayerPrefab.prototype.reportAttack=function(attackedBy,attackType,force,damage,x,y,z){if(this.isActive()&&this.controller){var sinceLastAttack=gEngine.lifetime-this.lastTimeAttacked;this.lastTimeAttacked=gEngine.lifetime;this.setActionID("hit",2);if(sinceLastAttack>.5){this.lastTimeAttacked=gEngine.lifetime;{var particle=new CollideableParticle(1,2);particle.setModel(new CCModelBase);particle.setColour(new CCColour);var primitive=new CCPrimitiveSquare;particle.model.addPrimitive(primitive);particle.model.setScale(10);primitive.setTexture("fx_impact_texture.png",true,true);particle.setScene(this.inScene);this.ownObject(particle);particle.setPosition(this.position);particle.translate(0,this.collisionBounds[1],0);particle.setRotationY(this.sceneMap.camera.rotation[1])}}this.controller.reportAttack(attackedBy,attackType,force,damage,x,y,z);return this.handleAttack(attackedBy,attackType,force,damage,x,y,z)}return false};CharacterPlayerPrefab.prototype.handleAttack=function(attackedBy,attackType,force,damage,x,y,z){damge=damage*(1-this.controller.damageResistance);return this.CharacterPlayer_handleAttack(attackedBy,attackType,force,damage,x,y,z)};CharacterPlayerPrefab.prototype.handleDeath=function(killer){this.lastTimeAttacked=gEngine.lifetime;this.setActionID("ko",2);this.CharacterPlayer_handleDeath(killer)};CharacterPlayerPrefab.prototype.setIdleAnimation=function(actionID){if(actionID||!this.idleAnimationID){if(!actionID){actionID="idle"}if(this.idleAnimationID!==actionID){this.idleAnimationID=actionID}}this.setActionID(this.idleAnimationID)};CharacterPlayerPrefab.prototype.setMovementAnimation=function(actionID){if(actionID||!this.moveAnimationID){if(!actionID){actionID="move"}if(this.moveAnimationID!==actionID){this.moveAnimationID=actionID}}this.setActionID(this.moveAnimationID)};function CharacterPlayerAndroid(){this.construct()}ExtendPrototype(CharacterPlayerAndroid,CharacterPlayer);CharacterPlayerAndroid.Spawn=function(type,onLoadedCallback){var character=new CharacterPlayerAndroid;character.type=type;var path=type;path+="_";{var objPath=path;objPath+="body.obj";var texPath=path;texPath+="diffuse.jpg";character.setupBody(objPath,texPath,function(){character.finalizeModel();if(type==="androBot"){objPath=path;objPath+="screen.obj";texPath=path;texPath+="screen_diffuse.jpg";character.setupScreen(objPath,texPath,function(){character.finalizeModel()})}if(type==="androBot"||type==="iBot"){objPath=path;objPath+="head.obj";texPath=path;texPath+="diffuse.jpg";character.setupHead(objPath,texPath,function(){character.finalizeModel();if(onLoadedCallback){onLoadedCallback(character)}})}else{if(onLoadedCallback){onLoadedCallback(character)}}{objPath=path;objPath+="rightarm.obj";texPath=path;texPath+="diffuse.jpg";character.setupRightArm(objPath,texPath,function(){character.finalizeModel();character.setupWeapon(character.modelRightArm,0);if(type==="iBot"){objPath=path;objPath+="leftarm.obj";character.setupLeftArm(objPath,texPath,function(){if(character.modelLeftArm){character.finalizeModel();character.setupWeapon(character.modelLeftArm,1);character.weapons[0].setFireRate(.2);character.weapons[0].setMaxAmmo(.5);character.weapons[1].setFireRate(.2);character.weapons[1].setMaxAmmo(.5)}})}})}})}return character};CharacterPlayerAndroid.prototype.construct=function(){this.CharacterPlayer_construct();this.modelScreen=null;this.modelLeftArm=this.modelRightArm=null};CharacterPlayerAndroid.prototype.destruct=function(){this.CharacterPlayer_destruct()};CharacterPlayerAndroid.prototype.setupScreen=function(modelFile,textureFile,callback){var self=this;this.setupModel(modelFile,textureFile,function(model3d){self.modelScreen=model3d;callback()})};CharacterPlayerAndroid.prototype.setupLeftArm=function(modelFile,textureFile,callback){var self=this;this.setupModel(modelFile,textureFile,function(model3d){self.modelLeftArm=model3d;callback()})};CharacterPlayerAndroid.prototype.setupRightArm=function(modelFile,textureFile,callback){var self=this;this.setupModel(modelFile,textureFile,function(model3d){if(model3d){self.modelRightArm=model3d;callback()}})};CharacterPlayerAndroid.prototype.finalizeModel=function(){var characterSize=this.characterSize;var modelWidth=characterSize;var modelDepth=characterSize;var bodyHeight=characterSize;var modelBody=this.modelBody;var modelHead=this.modelHead;if(modelBody){modelWidth=modelBody.getWidth();modelDepth=modelBody.getDepth();bodyHeight=modelBody.getHeight()}var modelHeight=bodyHeight;if(modelHead){modelHeight+=modelHead.getHeight();if(modelBody){modelBody.setPositionXYZ(0,-modelHead.getHeight()*.5,0);modelHead.setPositionXYZ(0,modelBody.getHeight()*.5,modelBody.getDepth()*.25+modelHead.getDepth()*.25)}}this.finalizeSize(modelWidth,modelDepth,modelHeight);if(this.modelScreen){this.modelScreen.setPositionXYZ(0,modelBody.position[1],modelBody.getDepth()*.5)}var combinedWidth,y;var modelLeftArm=this.modelLeftArm;if(modelLeftArm){combinedWidth=modelBody.getWidth()*.5+modelLeftArm.getWidth()*.5;y=bodyHeight*.25-modelLeftArm.getHeight()*.5;modelLeftArm.setPositionXYZ(-combinedWidth,y,modelLeftArm.getDepth()*.25)}var modelRightArm=this.modelRightArm;if(modelRightArm){combinedWidth=modelBody.getWidth()*.5+modelRightArm.getWidth()*.5;y=bodyHeight*.25-modelRightArm.getHeight()*.5;modelRightArm.setPositionXYZ(combinedWidth,y,modelRightArm.getDepth()*.25)}};function CharacterPlayerWeb(){this.construct()}ExtendPrototype(CharacterPlayerWeb,CharacterPlayer);CharacterPlayerWeb.Spawn=function(type,onLoadedCallback){var character=new CharacterPlayerWeb;character.type=type;var path=type;path+="_";var texPath=path;texPath+="diffuse.jpg";{var objPath=path;objPath+="body.obj";character.setupBody(objPath,texPath,function(){{objPath=path;objPath+="head.obj";character.setupHead(objPath,texPath,function(){character.finalizeModel();if(onLoadedCallback){onLoadedCallback(character)}})}{objPath=path;objPath+="bazooka.obj";character.setupRightArm(objPath,texPath,function(){character.finalizeModel();character.setupWeapon(character.modelRightArm,0)})}})}return character};CharacterPlayerWeb.prototype.construct=function(){this.CharacterPlayer_construct()};CharacterPlayerWeb.prototype.destruct=function(){this.CharacterPlayer_destruct()};CharacterPlayerWeb.prototype.setupLeftArm=function(modelFile,textureFile,callback){var self=this;this.setupModel(modelFile,textureFile,function(model3d){self.modelLeftArm=model3d;callback()})};CharacterPlayerWeb.prototype.setupRightArm=function(modelFile,textureFile,callback){var self=this;this.setupModel(modelFile,textureFile,function(model3d){if(model3d){self.modelRightArm=model3d;callback()}})};CharacterPlayerWeb.prototype.finalizeModel=function(){var characterSize=this.characterSize;var modelWidth=characterSize;var modelDepth=characterSize;var bodyHeight=characterSize;var modelBody=this.modelBody;var modelHead=this.modelHead;if(modelBody){modelWidth=modelBody.getWidth();modelDepth=modelBody.getDepth();bodyHeight=modelBody.getHeight()}var modelHeight=bodyHeight;if(modelHead){modelHeight+=modelHead.getHeight();modelBody.setPositionXYZ(0,-modelHead.getHeight()*.5,0);modelHead.setPositionXYZ(0,modelBody.getHeight()*.5,-modelBody.getDepth()*.5)}this.finalizeSize(modelWidth,modelDepth,modelHeight);var combinedWidth,y;var modelLeftArm=this.modelLeftArm;if(modelLeftArm){combinedWidth=modelBody.getWidth()*.25;y=bodyHeight*.25-modelLeftArm.getHeight()*.5;modelLeftArm.setPositionXYZ(combinedWidth,y,modelLeftArm.getDepth()*.25)}var modelRightArm=this.modelRightArm;if(modelRightArm){combinedWidth=modelBody.getWidth()*.25;y=-(modelRightArm.getHeight()*.75);modelRightArm.setPositionXYZ(-combinedWidth,y,modelRightArm.getDepth()*.3)}};function CharacterPlayerBurger(){this.construct()}ExtendPrototype(CharacterPlayerBurger,CharacterPlayer);CharacterPlayerBurger.Spawn=function(type,onLoadedCallback){var character=new CharacterPlayerBurger;character.type=type;var classPath="";if(type.contains("burger")){classPath+="burger"}else{classPath+="fries"}{var objPath="";if(type==="doublefries"){objPath+="fries"}else{objPath+=type}objPath+=".obj";var texPath=classPath;texPath+="_diffuse.jpg";character.setupBody(objPath,texPath,function(){character.finalizeModel();if(onLoadedCallback){onLoadedCallback(character)}{objPath="bazooka.obj";texPath="bazooka_diffuse.jpg";character.setupRightArm(objPath,texPath,function(){character.finalizeModel();character.setupWeapon(character.modelRightArm,0);if(type.contains("double")){character.setupLeftArm(objPath,texPath,function(){character.finalizeModel();character.setupWeapon(character.modelLeftArm,1);character.weapons[0].setFireRate(.2);character.weapons[0].setMaxAmmo(.5);character.weapons[1].setFireRate(.2);character.weapons[1].setMaxAmmo(.5)})}})}})}return character};CharacterPlayerBurger.prototype.construct=function(){this.CharacterPlayer_construct();this.modelLeftArm=this.modelRightArm=null};CharacterPlayerBurger.prototype.destruct=function(){this.CharacterPlayer_destruct()};CharacterPlayerBurger.prototype.setupLeftArm=function(modelFile,textureFile,callback){var self=this;this.setupModel(modelFile,textureFile,function(model3d){self.modelLeftArm=model3d;callback()})};CharacterPlayerBurger.prototype.setupRightArm=function(modelFile,textureFile,callback){var self=this;this.setupModel(modelFile,textureFile,function(model3d){self.modelRightArm=model3d;callback()})};CharacterPlayerBurger.prototype.finalizeModel=function(){var characterSize=this.characterSize;var modelWidth=characterSize;var modelDepth=characterSize;var bodyHeight=characterSize;var modelBody=this.modelBody;if(modelBody){modelWidth=modelBody.getWidth();modelDepth=modelBody.getDepth();bodyHeight=modelBody.getHeight()}var modelHeight=bodyHeight;this.finalizeSize(modelWidth,modelDepth,modelHeight);var combinedWidth,y;var modelLeftArm=this.modelLeftArm;if(modelLeftArm){combinedWidth=modelBody.getWidth()*.7;y=bodyHeight*.35-modelLeftArm.getHeight()*.5;modelLeftArm.setPositionXYZ(-combinedWidth,y,modelLeftArm.getDepth()*.25)}var modelRightArm=this.modelRightArm;if(modelRightArm){combinedWidth=modelBody.getWidth()*.7;y=bodyHeight*.35-modelRightArm.getHeight()*.5;modelRightArm.setPositionXYZ(combinedWidth,y,modelRightArm.getDepth()*.25)}};function CharacterPlayerTank(){this.construct(undefined,20)}ExtendPrototype(CharacterPlayerTank,CharacterPlayer);CharacterPlayerTank.Spawn=function(type,onLoadedCallback){var character=new CharacterPlayerTank;character.type=type;var path="tank_";var texPath=path;texPath+="diffuse.jpg";{var objPath=path;objPath+="body.obj";character.setupBody(objPath,texPath,function(){character.finalizeModel();{objPath=path;objPath+="head.obj";character.setupHead(objPath,texPath,function(){character.finalizeModel();character.setupWeapon(character.modelHead);if(onLoadedCallback){onLoadedCallback(character)}})}})}return character};CharacterPlayerTank.prototype.construct=function(){this.CharacterPlayer_construct()};CharacterPlayerTank.prototype.destruct=function(){this.CharacterPlayer_destruct()};CharacterPlayerTank.prototype.setupHead=function(modelFile,textureFile,callback){var self=this;this.setupModel(modelFile,textureFile,function(model3d){self.model3DBase.removeModel(model3d);self.modelHead=model3d;var currentWeaponRotation=0;if(self.modelWeaponBase===self.model3DBase){currentWeaponRotation=self.modelWeaponBase.rotation[1];self.modelWeaponBase.rotation[1]=0;self.modelWeaponBase.dirtyModelMatrix()}self.modelWeaponBase=new CCModelBase;self.modelWeaponBase.rotation[1]=currentWeaponRotation;self.modelWeaponBase.addModel(model3d);self.model3DBase.addModel(self.modelWeaponBase);if(callback){callback()}})};CharacterPlayerTank.prototype.finalizeModel=function(){var characterSize=this.characterSize;var modelWidth=characterSize;var modelDepth=characterSize;var bodyHeight=characterSize;var modelBody=this.modelBody;var modelHead=this.modelHead;if(modelBody){modelWidth=modelBody.getWidth();modelDepth=modelBody.getDepth();bodyHeight=modelBody.getHeight()}var modelHeight=bodyHeight;if(modelHead){var headHeight=modelHead.getHeight();{var origin=modelHead.getOrigin();modelHead.setPositionXYZ(origin[0],headHeight*.5,origin[2])}}this.finalizeSize(modelWidth,modelDepth,modelHeight)};function CharacterPlayerSoldier(){this.construct()}ExtendPrototype(CharacterPlayerSoldier,CharacterPlayer);CharacterPlayerSoldier.Spawn=function(type,onLoadedCallback){var character=new CharacterPlayerSoldier;character.type=type;var typePath=type;typePath+="_";var classPath="soldier_";{var objPath=classPath;objPath+="body.obj";var texPath=typePath;texPath+="body_diffuse.jpg";character.setupBody(objPath,texPath,function(){character.finalizeModel();{objPath=typePath;objPath+="head.obj";texPath=typePath;texPath+="head_diffuse.jpg";character.setupHead(objPath,texPath,function(){character.finalizeModel();if(onLoadedCallback){onLoadedCallback(character)}objPath=classPath;objPath+="weapon_bazooka.obj";texPath=classPath;texPath+="weapon_bazooka_diffuse.jpg";character.setupArms(objPath,texPath)})}})}return character};CharacterPlayerSoldier.prototype.construct=function(){this.CharacterPlayer_construct()};CharacterPlayerSoldier.prototype.destruct=function(){this.CharacterPlayer_destruct()};CharacterPlayerSoldier.prototype.setupArms=function(modelFile,textureFile,callback){var self=this;this.setupModel(modelFile,textureFile,function(model3d){self.modelArms=model3d;{var origin=model3d.getOrigin();model3d.translate(origin[0],-origin[1],origin[2])}self.setupWeapon(self.modelArms,0);if(callback){callback()}})};CharacterPlayerSoldier.prototype.finalizeModel=function(){var characterSize=this.characterSize;var modelWidth=characterSize;var modelDepth=characterSize;var bodyHeight=characterSize;var modelBody=this.modelBody;var modelHead=this.modelHead;if(modelBody){modelWidth=modelBody.getWidth();modelDepth=modelBody.getDepth();bodyHeight=modelBody.getHeight()}var modelHeight=bodyHeight;if(modelHead){var headHeight=modelHead.getHeight();modelHeight+=headHeight;modelBody.setPositionXYZ(0,-modelHeight*.5+bodyHeight*.5,0);modelHead.setPositionXYZ(0,modelBody.position[1]+bodyHeight*.5+headHeight*.5,0);if(modelHead.getWidth()>modelWidth){modelWidth=modelHead.getWidth()}}this.finalizeSize(modelWidth,modelDepth,modelHeight)};function CollideableFloor(scene,objectID){this.construct(scene,objectID)}ExtendPrototype(CollideableFloor,CCCollideable);CollideableFloor.prototype.construct=function(scene,objectID){this.CCCollideable_construct(objectID);this.primitive=new CCPrimitiveSquare;this.setModel(new CCModelBase);this.model.addPrimitive(this.primitive);this.setColour(new CCColour);if(scene){this.setScene(scene)}};CollideableFloor.prototype.update=function(delta){return this.CCObject_update(delta)};CollideableFloor.prototype.renderObject=function(camera,alpha){this.CCCollideable_renderObject(camera,alpha)};CollideableFloor.prototype.renderModel=function(alpha){this.CCCollideable_renderModel(alpha)};CollideableFloor.prototype.shouldCollide=function(collideWith,initialCall){return this.CCCollideable_shouldCollide(collideWith,initialCall)};CollideableFloor.prototype.recieveCollisionFrom=function(collisionSource,x,y,z){if(collisionSource.position[1]!==collisionSource.collisionBounds[1]){collisionSource.setPositionY(collisionSource.collisionBounds[1])}return null};CollideableFloor.prototype.setup=function(width,length,y){if(!y){y=0}this.setCollisionBounds(width,CC_SMALLFLOAT,length);var collisionBounds=this.collisionBounds;this.setPositionY(y-collisionBounds[1]);this.primitive.setupUpFacing(width,length,-CC_SMALLFLOAT,true,1);CC.UpdateCollisions(this,false)};function CollideableParticle(life,speed){this.construct(life,speed)}ExtendPrototype(CollideableParticle,CCCollideable);CollideableParticle.prototype.construct=function(life,speed){if(!life){life=1}if(!speed){speed=50}this.CCCollideable_construct();this.life=life;this.speed=speed;this.setTransparent();this.setReadDepth(false);this.setWriteDepth(false);this.setDrawOrder(201)};CollideableParticle.prototype.update=function(delta){if(this.life<=0){this.deleteLater()}else{if(this.life<1){this.setColourAlpha(0,true)}this.life-=delta;this.CCCollideable_update(delta);this.translate(0,delta*this.speed,0)}return true};CollideableParticle.prototype.renderModel=function(alpha){if(alpha){this.CCCollideable_renderModel(alpha)}else{this.CCCollideable_renderModel(alpha)}};function CollideableWall(scene){this.construct(scene);this.collideableType=CC.AddFlag(this.collideableType,CC.collision_static)}ExtendPrototype(CollideableWall,CCCollideable);CollideableWall.prototype.setPositionXYZ=function(x,y,z){this.CCCollideable_setPositionXYZ(x,y,z);this.translate(this.offsetX,0,this.offsetZ)};CollideableWall.prototype.update=function(delta){return false};CollideableWall.prototype.renderObject=function(camera,alpha){this.CCCollideable_renderObject(camera,alpha)};CollideableWall.prototype.shouldCollide=function(collideWith,initialCall){return this.CCCollideable_shouldCollide(collideWith,initialCall)};CollideableWall.prototype.setup=function(scene,x,z,size,height){this.shouldRender=false;this.offsetX=x;this.offsetZ=z;var collisionSize=CC_SMALLFLOAT;if(x!==0){this.setCollisionBounds(collisionSize,height,size)}else{this.setCollisionBounds(size,height,collisionSize)}this.translate(x,this.collisionBounds[1],z);if(scene){this.setScene(scene)}};function MoveableBullet(inLife,inMovementSpeed,inDamage){this.construct(inLife,inMovementSpeed,inDamage)}ExtendPrototype(MoveableBullet,CCMoveable);MoveableBullet.prototype.construct=function(inLife,inMovementSpeed,inDamage){this.CCMoveable_construct();if(!inLife){inLife=1}if(!inMovementSpeed){inMovementSpeed=200}if(!inDamage){inDamage=5}this.gravity=false;this.life=inLife;this.movementSpeed=inMovementSpeed;this.damage=inDamage};MoveableBullet.prototype.destruct=function(){this.CCMoveable_destruct()};MoveableBullet.prototype.update=function(delta){if(this.life<=0){if(this.onEndLife){this.onEndLife()}else{this.deleteLater()}}else{this.life-=delta;this.CCMoveable_update(delta)}return true};MoveableBullet.prototype.applyVelocity=function(delta,movementMagnitude){var velocity=this.velocity;var velocityX=velocity[0]*delta;var velocityZ=velocity[2]*delta;var position=this.position;var startPosition=CCMoveable.HorizontalVelocityStartPosition;vec3.copy(startPosition,position);position[0]+=velocityX;position[2]+=velocityZ;var self=this;var collisionFlags=CC.collision_static|CC.collision_moveable;CC.MovementCollisionCheckAsync(this,startPosition,position,collisionFlags,true,function(collidedWidth){})};MoveableBullet.prototype.renderModel=function(alpha){if(alpha){this.CCMoveable_renderModel(alpha)}else{this.CCMoveable_renderModel(alpha)}};MoveableBullet.prototype.requestCollisionWith=function(collidedWith){if(this.attack(collidedWith)){return this.CCMoveable_requestCollisionWith(collidedWith)}return null};MoveableBullet.prototype.recieveCollisionFrom=function(collisionSource,x,y,z){if(this.life>0){if(this.attack(collisionSource)){return this.CCMoveable_recieveCollisionFrom(collisionSource,x,y,z)}}return null};MoveableBullet.prototype.reportAttack=function(attackedBy,attackType,force,damage,x,y,z){return false};MoveableBullet.prototype.attack=function(victim){if(victim.shouldRender){var velocity=this.velocity;if(victim.reportAttack(this.owner,"default",this.movementSpeed,this.damage,velocity[0],velocity[1],velocity[2])){}this.life=0;this.deactivate();return true}return false};function ObjectIndicator(parentObject,textureFile){this.construct(parentObject,textureFile)}ExtendPrototype(ObjectIndicator,CCObject);ObjectIndicator.prototype.construct=function(parentObject,textureFile){this.CCObject_construct();var model=this.setModel(new CCModelBase);var primitive=this.primitive=new CCPrimitiveSquare;primitive.setupUpFacing(1,1,0,true,1);model.addPrimitive(primitive);parentObject.addChild(this);this.setTransparent();this.setWriteDepth(false);this.setColourAlpha(.5);if(textureFile){primitive.setTexture(textureFile,true,false,false)}this.setWidth(parentObject.collisionSize.width)};ObjectIndicator.prototype.destruct=function(){this.CCObject_destruct()};ObjectIndicator.prototype.renderModel=function(alpha){if(this.colour.a>0){this.CCObject_renderModel(alpha)}};ObjectIndicator.prototype.setWidth=function(width){this.model.setScale(width)};function CollideableIndicator(parent,textureFile){if(parent.inScene){this.construct(parent.inScene,textureFile);parent.ownObject(this);this.setWidth(parent.collisionSize.width)}else{this.construct(parent,textureFile)}}ExtendPrototype(CollideableIndicator,CCCollideable);CollideableIndicator.prototype.construct=function(parentScene,textureFile){this.CCCollideable_construct();var model=this.setModel(new CCModelBase);var primitive=this.primitive=new CCPrimitiveSquare;primitive.setupUpFacing(1,1,0,true,1);model.addPrimitive(primitive);this.setScene(parentScene);this.collideableType=CC.collision_none;this.setReadDepth(false);this.setWriteDepth(false);this.setDrawOrder(98);this.setColourAlpha(.5);if(textureFile){primitive.setTexture(textureFile,true,false,false)}};CollideableIndicator.prototype.destruct=function(){this.CCCollideable_destruct()};CollideableIndicator.prototype.setPositionXYZ=function(x,y,z){this.CCCollideable_setPositionXYZ(x,1,z);this.updateCollisions=true;CC.UpdateCollisions(this,false)};CollideableIndicator.prototype.translate=function(x,y,z){this.CCCollideable_translate(x,y,z);this.updateCollisions=true;CC.UpdateCollisions(this,false)};CollideableIndicator.prototype.renderModel=function(alpha){if(!alpha&&this.colour.a>0){gRenderer.CCSetBlend(true);this.CCCollideable_renderModel(alpha);gRenderer.CCSetBlend(false)}};CollideableIndicator.prototype.removeOwner=function(currentOwner){this.CCCollideable_removeOwner(currentOwner);this.deleteLater()};CollideableIndicator.prototype.setWidth=function(width){this.setSquareCollisionBounds(width);CC.UpdateCollisions(this,false);this.model.setScale(width)};function PickupBase(name,type,pickupID){this.construct(name,type,pickupID)}ExtendPrototype(PickupBase,CCCollideable);PickupBase.prototype.construct=function(name,type,pickupID){this.CCCollideable_construct(pickupID);this.collideableType=CC.AddFlag(this.collideableType,CC.collision_static);this.name=name;this.type=type;this.model3d=null;this.setColour(gColour.white())};PickupBase.prototype.update=function(delta){if(this.model){this.model.rotateY(delta*-90)}return false};PickupBase.prototype.renderModel=function(alpha){this.CCCollideable_renderModel(alpha)};PickupBase.prototype.shouldCollide=function(collideWith,initialCall){return this.CCCollideable_shouldCollide(collideWith,initialCall)};PickupBase.prototype.recieveCollisionFrom=function(collisionSource,x,y,z){return this.CCCollideable_recieveCollisionFrom(collisionSource,x,y,z)};PickupBase.prototype.setup=function(modelFile,textureFile){var self=this;CCModel3D.CacheModel(modelFile,true,function(model3d){if(model3d){var model=self.setModel(new CCModelBase);self.model3d=model3d;model3d.setTexture(textureFile);model.addModel(model3d);var modelWidth=Math.max(model3d.getWidth(),model3d.getDepth());var modelHeight=model3d.getHeight();{var modelSize=modelHeight>modelWidth?modelHeight:modelWidth;var scaleFactor=10/modelSize;model.setScale(scaleFactor);modelWidth*=scaleFactor;modelHeight*=scaleFactor}self.setSquareCollisionBounds(modelWidth,modelHeight);self.setPositionY(self.collisionBounds[1]);self.setRotationY(180)}})};PickupBase.prototype.getName=function(){return this.name};PickupBase.prototype.getType=function(){return this.type};function WeaponBase(character){this.construct(character)}ExtendPrototype(WeaponBase,CCObject);WeaponBase.prototype.construct=function(character){this.CCObject_construct();this.spawnPoint=vec3.create();this.character=character;this.bulletLife=5;this.bulletSpeed=200;this.fireRate=.1;this.shootingTimer=0;this.timeSinceLastShot=0;this.timeToReady=0;this.maxAmmo=1;this.ammo=1;this.bulletTax=.05;this.chargeRate=.1};WeaponBase.prototype.destruct=function(){this.CCObject_destruct()};WeaponBase.prototype.setup=function(weaponObj,recoil,muzzleFlash){if(weaponObj){if(recoil===undefined){recoil=true}if(muzzleFlash===undefined){muzzleFlash=true}this.setupSpawnPoint(weaponObj);if(recoil){this.setModel(new CCModelBase);this.setColour(new CCColour);this.modelWeaponHomePosition=vec3.create();
vec3.copy(this.modelWeaponHomePosition,weaponObj.position);this.modelWeaponMovementInterpolator=new CCInterpolatorV3(CCInterpolatorSin2Curve);this.modelWeaponMovementInterpolator.setup(weaponObj.position,this.modelWeaponHomePosition);this.modelWeaponMovementInterpolator.setDuration(.05125)}if(muzzleFlash){var objFile="fx_weapon_muzzleflash.obj";var texFile="fx_weapon_muzzleflash_texture.png";var objectMuzzleFlash=this.objectMuzzleFlash=new CCObject;objectMuzzleFlash.setModel(new CCModelBase);objectMuzzleFlash.setColour(new CCColour);objectMuzzleFlash.setTransparent();objectMuzzleFlash.setWriteDepth(false);objectMuzzleFlash.setCulling(false);this.addChild(objectMuzzleFlash);var self=this;CCModel3D.CacheModel(objFile,true,function(model3d){if(model3d){self.modelMuzzleFlash=model3d;model3d.setTexture(texFile);model3d.setPosition(self.spawnPoint);model3d.translate(0,0,model3d.getDepth()*.5);objectMuzzleFlash.model.addModel(model3d)}})}}this.character.addChild(this)};WeaponBase.prototype.setupSpawnPoint=function(weaponObj){if(weaponObj&&this.modelWeapon!==weaponObj){this.modelWeapon=weaponObj;if(weaponObj.getDepth){var x=weaponObj.position[0];var y=weaponObj.position[1];var z=weaponObj.position[2];var scale=this.character.model3DBase.scale;var weaponDepth=weaponObj.getDepth();var weaponDepthMinMax=weaponObj.getPrimitive().getZMinMax();var self=this;weaponObj.getPrimitive().getYMinMaxAtZ(weaponDepthMinMax.max*.9,function(weaponHeightMinMaxAtPoint){var centerPointY=weaponHeightMinMaxAtPoint.min+weaponHeightMinMaxAtPoint.size()*.5;y+=centerPointY;if(scale){x*=scale[0];y*=scale[1];z*=scale[2];weaponDepth*=scale[2]}z+=weaponDepth*.5;self.spawnPoint=vec3.copy(self.spawnPoint,[x,y,z]);if(self.modelMuzzleFlash){self.modelMuzzleFlash.setPosition(self.spawnPoint)}})}}};WeaponBase.prototype.setTimeToReady=function(time){this.timeToReady=time};WeaponBase.prototype.isReady=function(){if(this.timeToReady<=0){if(this.timeSinceLastShot>this.fireRate){return true}}return false};WeaponBase.BulletsCache=[];WeaponBase.NewBullet=function(life,speed,damage,visible){var BulletsCache=WeaponBase.BulletsCache;if(visible===undefined){visible=true}var bullet;if(BulletsCache.length>0){bullet=BulletsCache.safePop();bullet.life=life;if(speed){bullet.movementSpeed=speed}if(damage){bullet.damage=damage}bullet.shouldRender=visible}else{bullet=new MoveableBullet(life,speed,damage);bullet.setSquareCollisionBounds(5);bullet.setTransparent();var path="fx_weapon_bullet";var texPath;{var objPath=path;objPath+=".obj";texPath=path;texPath+="_diffuse.jpg";CCModel3D.CacheModel(objPath,true,function(model3d){model3d.setTexture(texPath);bullet.setModel(model3d)});bullet.movementDirection[2]=1}{texPath=path;texPath+="_glow_texture.png";var objectIndicator=new ObjectIndicator(bullet,texPath);objectIndicator.setScale([5,1,5]);objectIndicator.translate(0,1,0)}bullet.onEndLife=function(){BulletsCache.add(bullet);bullet.removeFromScene()};bullet.shouldRender=visible}return bullet};WeaponBase.prototype.shootWeapon=function(characterRotation){if(!this.hasEnoughAmmo()){return false}if(!this.isReady()){return false}this.ammo-=this.bulletTax;var modelWeaponMovementInterpolator=this.modelWeaponMovementInterpolator;if(modelWeaponMovementInterpolator){if(!modelWeaponMovementInterpolator.updating){var modelWeaponHomePosition=this.modelWeaponHomePosition;var modelWeapon=this.modelWeapon;modelWeaponMovementInterpolator.setup(modelWeapon.position,vec3.clone([modelWeaponHomePosition[0],modelWeaponHomePosition[1],modelWeaponHomePosition[2]+1]),function(){modelWeaponMovementInterpolator.setup(modelWeapon.position,modelWeaponHomePosition)})}}var bullet=WeaponBase.NewBullet(this.bulletLife,this.bulletSpeed,this.bulletDamage,this.bulletVisible);bullet.setScene(this.character.inScene);this.character.ownObject(bullet);this.setBulletSpawnPoint(bullet,characterRotation);this.shoot();this.timeSinceLastShot=0;return true};WeaponBase.prototype.setBulletSpawnPoint=function(projectile,characterRotation){var spawnPointXZ=new CCPoint(this.spawnPoint[0],this.spawnPoint[2]);CC.RotatePoint(spawnPointXZ,characterRotation);var spawnPoint=vec3.create();vec3.copy(spawnPoint,this.parent.position);spawnPoint[0]+=spawnPointXZ.x;spawnPoint[1]+=this.spawnPoint[1];spawnPoint[2]+=spawnPointXZ.y;if(spawnPoint[1]<projectile.collisionBounds[1]){spawnPoint[1]=projectile.collisionBounds[1]+.1}projectile.setPosition(spawnPoint);projectile.rotation[1]=characterRotation};WeaponBase.prototype.updateParentRotation=function(rotation){if(this.model){this.model.setRotationY(rotation);if(this.objectMuzzleFlash){this.objectMuzzleFlash.setRotationY(rotation)}}};WeaponBase.prototype.update=function(delta){var updated=this.CCObject_update(delta);var modelWeaponMovementInterpolator=this.modelWeaponMovementInterpolator;if(modelWeaponMovementInterpolator){if(modelWeaponMovementInterpolator.updating){if(modelWeaponMovementInterpolator.update(delta)){this.modelWeapon.dirtyModelMatrix();updated=true}}}var objectMuzzleFlash=this.objectMuzzleFlash;if(objectMuzzleFlash){if(objectMuzzleFlash.shouldRender){if(this.shootingTimer!==0){this.shootingTimer=CC.ToTarget(this.shootingTimer,0,delta);if(objectMuzzleFlash){if(this.modelMuzzleFlash){this.modelMuzzleFlash.rotateZ(delta*360)}}}else{objectMuzzleFlash.shouldRender=false}}}this.timeSinceLastShot+=delta;if(this.timeToReady>0){this.timeToReady-=delta}return updated};WeaponBase.prototype.updateCharge=function(delta){if(this.ammo<this.maxAmmo){this.addAmmo(delta*this.chargeRate);return true}return false};WeaponBase.prototype.renderObject=function(camera,alpha){this.CCObject_renderObject(camera,alpha)};WeaponBase.prototype.renderModel=function(alpha){this.CCObject_renderModel(alpha)};WeaponBase.prototype.shoot=function(){this.shootingTimer=.025;if(this.objectMuzzleFlash){this.objectMuzzleFlash.shouldRender=true}};WeaponBase.prototype.getTimeSinceLastShot=function(){return this.timeSinceLastShot};WeaponBase.prototype.setFireRate=function(rate){this.fireRate=rate};WeaponBase.prototype.setupBullet=function(life,speed,visible){if(life){this.bulletLife=life}if(speed){this.bulletSpeed=speed}if(visible!==undefined){this.bulletVisible=visible}};WeaponBase.prototype.setMaxAmmo=function(amount){this.maxAmmo=amount;this.ammo=amount};WeaponBase.prototype.addAmmo=function(amount){this.ammo+=amount;this.ammo=CC.FloatClamp(this.ammo,0,this.maxAmmo)};WeaponBase.prototype.hasEnoughAmmo=function(){return this.ammo>this.bulletTax};WeaponBase.prototype.getAmmo=function(){return this.ammo};WeaponBase.prototype.getMaxAmmo=function(){return this.maxAmmo};WeaponBase.prototype.setBulletTax=function(tax){this.bulletTax=tax};WeaponBase.prototype.setBulletDamage=function(damage){this.bulletDamage=damage};WeaponBase.prototype.setChargeRate=function(rate){this.chargeRate=rate};function SceneManagerPlay(){this.construct()}ExtendPrototype(SceneManagerPlay,CCSceneAppUI);var sceneManagerPlay;SceneManagerPlay.prototype.construct=function(){sceneManagerPlay=this;MultiplayerManager.UpdateCallbacks.addOnce(this);this.CCSceneAppUI_construct();this.cameraCentered=true;this.map=null;this.tileNotifications=undefined};SceneManagerPlay.prototype.destruct=function(){if(sceneManagerPlay===this){sceneManagerPlay=null}if(this.map){this.map.destruct()}this.CCSceneAppUI_destruct()};SceneManagerPlay.prototype.setup=function(){var self=this;if(!this.camera){var camera=gEngine.newSceneCamera(this);camera.setupViewport(0,0,1,1);camera.useSceneCollideables(this)}this.CCSceneAppUI_setup();if(MultiplayerManager.LoggedIn){this.syncLoggedIn()}};SceneManagerPlay.prototype.touchPressed=function(touch){return this.CCSceneAppUI_touchPressed(touch)};SceneManagerPlay.prototype.touchMoving=function(touch,touchDelta){return false};SceneManagerPlay.prototype.touchReleased=function(touch,touchAction){return this.CCSceneAppUI_touchReleased(touch,touchAction)};SceneManagerPlay.prototype.syncDisconnected=function(){};SceneManagerPlay.prototype.syncLoggedIn=function(){this.setupPushNotifications()};SceneManagerPlay.prototype.syncUpdate=function(jsonData){if(jsonData.js){eval(jsonData.js)}else{var map=this.map;if(map){if(jsonData.addPlayer){if(map.getMapType()==="1vs1"){if(map.getNumberOfPlayers()>=2){if(this.tileNotifications){this.tileNotifications.setText("")}}}else if(map.getMapType()==="BattleRoyale"){players=map.getNumberOfHumanPlayers();text="- ";text+=players;text+=" -";if(this.tileNotifications){this.tileNotifications.setText(text)}}}else if(jsonData.removePlayer){if(map.getMapType()==="BattleRoyale"){var players=map.getNumberOfHumanPlayers();text="- ";text+=players;text+=" -";if(this.tileNotifications){this.tileNotifications.setText(text)}}}}}};SceneManagerPlay.prototype.setupPushNotifications=function(){};SceneManagerPlay.prototype.getPlayerTypeInfo=function(playerType){var playerTypes=this.playerTypes;for(var i=0;i<playerTypes.length;++i){var playerTypeInfo=playerTypes[i];if(playerTypeInfo.type===playerType){return playerTypeInfo}}return this.playerTypes[0]};SceneManagerPlay.prototype.spawnCharacter=function(type,onLoadedCallback){var playerTypes=this.playerTypes;if(playerTypes){for(var i=0;i<playerTypes.length;++i){var playerType=playerTypes[i];if(type===playerType.type){return CharacterPlayer.Spawn(type,playerType.obj,playerType.tex,playerType.speed,playerType.size,onLoadedCallback)}}}return CharacterPlayerAndroid.Spawn("iBot",onLoadedCallback)};SceneManagerPlay.SpawnCharacter=function(type,onLoadedCallback){if(type.startsWith("model.")){return CharacterPlayerModel.Spawn(type,onLoadedCallback)}if(type.startsWith("character.")){return CharacterPlayerPrefab.Spawn(type,onLoadedCallback)}if(type.contains("burger")||type.contains("fries")){return CharacterPlayerBurger.Spawn(type,onLoadedCallback)}else if(type.contains("androBot")||type.contains("iBot")||type.contains("winBot")){return CharacterPlayerAndroid.Spawn(type,onLoadedCallback)}else if(type.contains("webBot")){return CharacterPlayerWeb.Spawn(type,onLoadedCallback)}else if(type.contains("soldier")||type.contains("miniche")){return CharacterPlayerSoldier.Spawn(type,onLoadedCallback)}else if(type.contains("tank")){return CharacterPlayerTank.Spawn(type,onLoadedCallback)}return sceneManagerPlay.spawnCharacter(type,onLoadedCallback)};function SceneManagerGame(){this.construct()}ExtendPrototype(SceneManagerGame,SceneManagerPlay);var sceneManagerGame;SceneManagerGame.DefaultPlayerTypes=[{type:"iBot",icon:"iBot_icon.png",obj:"iBot_body.obj",tex:"iBot_diffuse.jpg"},{type:"winBot",icon:"androBot_icon.png",obj:"winBot_body.obj",tex:"winBot_diffuse.jpg"}];SceneManagerGame.HelpImage="phonewars_helpscreen.jpg";SceneManagerGame.prototype.construct=function(){sceneManagerGame=this;this.SceneManagerPlay_construct();var appInfoString=CC.LoadData("appInfos");if(appInfoString){var appInfos=JSON.parse(appInfoString);if(appInfos){for(var i=0;i<appInfos.length;++i){var appInfo=appInfos[i];if(appInfo.id===APP_ID){this.updateAppInfo(appInfo);break}}}}if(!this.playerTypes||this.playerTypes.length===0){this.playerTypes=SceneManagerGame.DefaultPlayerTypes}if(this.playerTypes.length<2){this.playerTypes.push(SceneManagerGame.DefaultPlayerTypes[1])}if(!this.playerType){this.playerType=this.playerTypes[0].type}SceneManagerPlay.SpawnCharacter(this.playerType,function(player){player.noScene=true;player.destruct()});{this.sceneBackground=new SceneBackground;gEngine.addScene(this.sceneBackground);this.sceneSplashScreen=new SceneSplashScreen;gEngine.addScene(this.sceneSplashScreen);this.scenePlayScreen=new ScenePlayScreen;gEngine.addScene(this.scenePlayScreen);this.sceneLeaderboards=new SceneLeaderboards;gEngine.addScene(this.sceneLeaderboards);this.sceneMultiLauncher=new SceneMultiUILauncher(this)}this.waitingForOpponent=false;this.waitingForOpponentStartedTimer=false;this.registeredPushNotification=false;this.tileFlag=null;gEngine.textureManager.getTextureHandle(SceneManagerGame.HelpImage);gEngine.textureManager.getTextureHandle(SceneGameMap.DefaultMapImage)};SceneManagerGame.GameState_SplashScreen=0;SceneManagerGame.GameState_CharacterSelectScreen=1;SceneManagerGame.GameState_ReadyToPlay1vs1=2;SceneManagerGame.GameState_ReadyToPlayBattleRoyale=3;SceneManagerGame.GameState_Playing1vs1=4;SceneManagerGame.GameState_PlayingBattleRoyale=5;SceneManagerGame.GameState_Leaderboards=6;SceneManagerGame.prototype.destruct=function(){if(sceneManagerGame===this){sceneManagerGame=null}{if(this.sceneLeaderboards){this.sceneLeaderboards.destruct()}if(this.scenePlayScreen){this.scenePlayScreen.destruct()}if(this.sceneSplashScreen){this.sceneSplashScreen.destruct()}if(this.sceneBackground){this.sceneBackground.destruct()}}this.SceneManagerPlay_destruct()};SceneManagerGame.prototype.setup=function(){var self=this;this.SceneManagerPlay_setup();var camera=this.camera;camera.setCameraWidth(SceneBackground.SceneWidth);var tile;{tile=new CCTile3DButton(this);tile.setupText(" ",camera.targetHeight*.0725,true,false);tile.setDrawOrder(205);tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setTextBlinking(true);this.tileNotifications=tile;this.tileNotifications.setText("tap to start")}this.tileTitleMessages=[];{tile=new CCTile3DButton(this);tile.setupText("",camera.targetHeight*.06,true,false);tile.setDrawOrder(205);tile.setTextColour(1);this.tileTitleMessages.add(tile)}{tile=new CCTile3DButton(this);tile.setupText("",camera.targetHeight*.05,true,false);tile.setDrawOrder(205);tile.setTextColour(1);this.tileTitleMessages.add(tile)}{tile=new CCTile3DButton(this);tile.setupText("",camera.targetHeight*.05,true,false);tile.setDrawOrder(205);tile.setTextColour(1);this.tilePlayerStatus=tile}{tile=new CCTile3DButton(this);tile.setupTexturedWidth(camera.targetWidth*.085,"ui_back.png");tile.setColourAlpha(0);tile.setDrawOrder(205);this.tileBack=tile;this.addTile(tile);tile.onRelease.push(function(){self.handleBackButton()});this.resizeCallbacks.push(function(){tile=self.tileBack;tile.setPositionXYZ(camera.targetWidth*.5-tile.collisionBounds[0],camera.targetHeight*.5-tile.collisionBounds[1],0)});this.hideBack()}this.createFlag();this.gotoSplashScreenGameState()};SceneManagerGame.prototype.resize=function(){this.SceneManagerPlay_resize();var camera=this.camera;if(this.tileNotifications){var idealAspectRatio=1.5;var aspectRatioAdjutment=camera.getAspectRatio()<1.25?camera.getAspectRatio()/idealAspectRatio:1;var tile;{this.tileNotifications.setTextHeight(camera.targetHeight*.08*aspectRatioAdjutment,true);{tile=this.tileTitleMessages[0];tile.setTextHeight(camera.targetHeight*.06*aspectRatioAdjutment,true);tile.setPositionXYZ(-(camera.targetWidth*.5)+tile.collisionBounds[0],+(camera.targetHeight*.5)-tile.collisionBounds[1],0)}{tile=this.tileTitleMessages[1];tile.setTextHeight(camera.targetHeight*.06*aspectRatioAdjutment,true);tile.positionTileBelow(this.tileTitleMessages[0]);tile.setPositionX(-(camera.targetWidth*.5)+tile.collisionBounds[0])}{tile=this.tilePlayerStatus;tile.setTextHeight(camera.targetHeight*.05*aspectRatioAdjutment,true);tile.positionTileBelow(this.tileTitleMessages[1]);tile.setPositionX(-(camera.targetWidth*.5)+tile.collisionBounds[0])}}{tile=this.tileNotifications;var gameState=this.gameState;if(gameState===SceneManagerGame.GameState_CharacterSelectScreen||gameState===SceneManagerGame.GameState_ReadyToPlay1vs1||gameState===SceneManagerGame.GameState_ReadyToPlayBattleRoyale){tile.setPositionX(-camera.targetWidth*.2*.5)}else{tile.setPositionX(0)}tile.setPositionY(-camera.cameraHHeight+tile.collisionBounds[1])}if(this.tileFlag){tile=this.tileFlag;if(tile.getTileTextureImage()){tile.setTileTexturedHeight(camera.cameraHeight*.05*aspectRatioAdjutment)}tile.setPositionXYZ(camera.targetWidth*.5-tile.collisionBounds[0],camera.targetHeight*.5-tile.collisionBounds[1],0)}}};SceneManagerGame.prototype.handleBackButton=function(){if(this.gameState===SceneManagerGame.GameState_CharacterSelectScreen||this.gameState===SceneManagerGame.GameState_ReadyToPlay1vs1||this.gameState===SceneManagerGame.GameState_ReadyToPlayBattleRoyale){this.gotoSplashScreenGameState();return true}if(this.gameState===SceneManagerGame.GameState_Leaderboards){this.exitLeaderboardsState();return true}return false};SceneManagerGame.prototype.render=function(camera,pass,alpha){};SceneManagerGame.prototype.touchPressed=function(touch){return this.SceneManagerPlay_touchPressed(touch)};SceneManagerGame.prototype.touchMoving=function(touch,touchDelta){return false};SceneManagerGame.prototype.touchReleased=function(touch,touchAction){return this.SceneManagerPlay_touchReleased(touch,touchAction)};SceneManagerGame.prototype.updateAppInfo=function(appInfo){var facebookID=appInfo.facebookID;if(facebookID){CCAPIFacebook.APP_ID=facebookID}var backgroundImage=appInfo.backgroundImage;if(backgroundImage){SceneBackground.BackgroundImage=backgroundImage;if(this.sceneBackground){this.sceneBackground.refreshBackgroundImage()}}if(appInfo.helpImage){SceneManagerGame.HelpImage=appInfo.helpImage;gEngine.textureManager.getTextureHandle(SceneManagerGame.HelpImage)}if(appInfo.defaultMapImage){SceneGameMap.DefaultMapImage=appInfo.defaultMapImage;gEngine.textureManager.getTextureHandle(SceneGameMap.DefaultMapImage)}var i;var playerTypes=appInfo.playerTypes;if(playerTypes&&playerTypes.length>=2){this.playerTypes=playerTypes;{var playerTypeFound=false;if(this.playerType){for(i=0;i<playerTypes.length;++i){var playerTypeInfo=playerTypes[i];if(playerTypeInfo.type===this.playerType){playerTypeFound=true;break}}}if(!playerTypeFound){this.playerType=this.playerTypes[0].type;if(!this.map){if(this.gameState===SceneManagerGame.GameState_CharacterSelectScreen){this.scenePlayScreen.showPlayerView(this.playerType)}}}}}if(this.gameState===SceneManagerGame.GameState_SplashScreen){this.showSplashScreen()}};SceneManagerGame.prototype.showSplashScreen=function(){this.scenePlayScreen.hide();this.sceneBackground.show();var playerTypes=this.playerTypes;this.sceneSplashScreen.show(playerTypes[0].type,null,playerTypes[1].type,null)};SceneManagerGame.prototype.hideSplashScreen=function(){this.sceneSplashScreen.hide()};SceneManagerGame.prototype.showPlayer1=function(character){var sceneSplashScreen=this.sceneSplashScreen;var sceneLeaderboards=this.sceneLeaderboards;if(sceneSplashScreen.isShowingPlayer2()){this.hideSplashScreen()}if(!sceneSplashScreen.isShowingPlayer1()){var countryCode=sceneLeaderboards.getPlayerCountryCode(character.getUserID());sceneSplashScreen.showPlayer1(character.getType(),countryCode,.5);var tileStripe=sceneSplashScreen.getPlayer1Stripe();tileStripe.setColourAlpha(.25,true);var tileScore=sceneSplashScreen.getPlayer1Score();var userInfo=sceneLeaderboards.getUserIDData(SceneLeaderboards.Leaderboard_AllTime,character.getUserID());if(userInfo){var winRatio="";winRatio+=userInfo.wins;winRatio+=" / ";winRatio+=userInfo.losses;tileScore.setText(winRatio,false);tileScore.setTextColourAlpha(1,true)}}};SceneManagerGame.prototype.showPlayer2=function(character){var sceneSplashScreen=this.sceneSplashScreen;var sceneLeaderboards=this.sceneLeaderboards;if(sceneSplashScreen.isShowingPlayer1()){this.hideSplashScreen()}if(!sceneSplashScreen.isShowingPlayer2()){var countryCode=sceneLeaderboards.getPlayerCountryCode(character.getUserID());sceneSplashScreen.showPlayer2(character.getType(),countryCode,.5);var tileStripe=sceneSplashScreen.getPlayer2Stripe();tileStripe.setColourAlpha(.25,true);var tileScore=sceneSplashScreen.getPlayer2Score();var userInfo=sceneLeaderboards.getUserIDData(SceneLeaderboards.Leaderboard_AllTime,character.getUserID());if(userInfo){var winRatio="";winRatio+=userInfo.wins;winRatio+=" / ";winRatio+=userInfo.losses;tileScore.setText(winRatio,false);tileScore.setTextColourAlpha(1,true)}}};SceneManagerGame.prototype.backgroundTilePressed=function(){if(this.gameState===SceneManagerGame.GameState_SplashScreen){this.gotoCharacterSelectScreenState()}else if(this.gameState===SceneManagerGame.GameState_Leaderboards){this.gameState=SceneManagerGame.GameState_Leaderboards}};SceneManagerGame.prototype.exitLeaderboardsState=function(){if(this.gameState===SceneManagerGame.GameState_Leaderboards){this.hideBack();this.sceneLeaderboards.hide();this.gotoCharacterSelectScreenState()}};SceneManagerGame.prototype.gotoSplashScreenGameState=function(){CCEngine.DisableBackButton(this);this.setGameState(SceneManagerGame.GameState_SplashScreen);if(!this.waitingForOpponent){this.tileNotifications.setText("tap to start")}this.showSplashScreen();this.showFlag();if(this.sceneMultiLauncher){this.sceneMultiLauncher.show()}};SceneManagerGame.prototype.gotoCharacterSelectScreenState=function(){if(this.gameState!==SceneManagerGame.GameState_CharacterSelectScreen){CCEngine.EnableBackButton(this);this.sceneBackground.show();this.timers.length=0;this.showFlag();this.tileNotifications.setText("connecting");this.setGameState(SceneManagerGame.GameState_CharacterSelectScreen);this.updatedGameState();if(MultiplayerManager.LoggedIn){if(this.waitingForOpponent){this.readyToPlay1vs1()}}this.hideSplashScreen();this.scenePlayScreen.show(this.playerType);if(this.sceneMultiLauncher){this.sceneMultiLauncher.show()}}};SceneManagerGame.prototype.start1vs1=function(){if(this.gameState===SceneManagerGame.GameState_ReadyToPlayBattleRoyale){this.toggleWaitingForOpponent(false);this.timers.length=0;this.tileNotifications.setText("connecting");this.setGameState(SceneManagerGame.GameState_CharacterSelectScreen);this.updatedGameState()}if(this.gameState===SceneManagerGame.GameState_CharacterSelectScreen){if(this.isUsablePlayer()){this.tileNotifications.setText("connecting");if(MultiplayerManager.LoggedIn){this.readyToPlay1vs1();return true}}}else if(this.gameState===SceneManagerGame.GameState_ReadyToPlay1vs1||this.gameState===SceneManagerGame.GameState_ReadyToPlayBattleRoyale){this.toggleWaitingForOpponent(false);this.timers.length=0;this.tileNotifications.setText("connecting");this.setGameState(SceneManagerGame.GameState_CharacterSelectScreen);this.updatedGameState()}return false};SceneManagerGame.prototype.startBattleRoyale=function(mapID){if(this.gameState===SceneManagerGame.GameState_ReadyToPlay1vs1){this.toggleWaitingForOpponent(false);this.timers.length=0;this.tileNotifications.setText("connecting");this.setGameState(SceneManagerGame.GameState_CharacterSelectScreen);this.updatedGameState()}if(this.gameState===SceneManagerGame.GameState_CharacterSelectScreen){if(this.isUsablePlayer()){this.tileNotifications.setText("connecting");if(MultiplayerManager.LoggedIn){this.readyToPlayBattleRoyale(mapID);return true}}}else if(this.gameState===SceneManagerGame.GameState_ReadyToPlay1vs1||this.gameState===SceneManagerGame.GameState_ReadyToPlayBattleRoyale){this.toggleWaitingForOpponent(false);this.timers.length=0;this.tileNotifications.setText("connecting");this.setGameState(SceneManagerGame.GameState_CharacterSelectScreen);this.updatedGameState()}return false};SceneManagerGame.prototype.setGameState=function(state){if(this.gameState!==state){this.gameState=state;this.requestResize()}};SceneManagerGame.prototype.toggleWaitingForOpponent=function(toggle){if(this.waitingForOpponent!==toggle){this.waitingForOpponent=toggle;if(!this.waitingForOpponent){if(MultiplayerManager.LoggedIn){BurgersClient.unregisterPlayer()}if(this.gameState===SceneManagerGame.GameState_ReadyToPlay1vs1){this.tileNotifications.setText("connecting");this.setGameState(SceneManagerGame.GameState_CharacterSelectScreen);this.updatedGameState()}}}if(this.waitingForOpponentStartedTimer){this.waitingForOpponentStartedTimer=false}};SceneManagerGame.prototype.syncDisconnected=function(){if(this.gameState>=SceneManagerGame.GameState_CharacterSelectScreen&&this.gameState<=SceneManagerGame.GameState_PlayingBattleRoyale){this.tileNotifications.setText("connecting")}this.SceneManagerPlay_syncDisconnected()};SceneManagerGame.prototype.syncLoggedIn=function(){this.SceneManagerPlay_syncLoggedIn();var guestName="Guest ";guestName+=MultiplayerManager.UserID;guestName=guestName.strip(".");this.scenePlayScreen.setPlayerID(guestName);var leaderboard=this.sceneLeaderboards.leaderboardsData[this.sceneLeaderboards.currentLeaderboardType];if(leaderboard.length===0){this.sceneLeaderboards.requestLeaderboard()}this.updatedGameState()};SceneManagerGame.prototype.updatedGameState=function(){if(MultiplayerManager.LoggedIn){var map=this.map;if(map){if(map.isOnlineGame()){map.deleteLater();this.map=null;this.hideSplashScreen();this.gotoSplashScreenGameState()}else{this.tileNotifications.setText("")}}else{if(this.gameState===SceneManagerGame.GameState_SplashScreen){}else{if(this.gameState===SceneManagerGame.GameState_ReadyToPlay1vs1||this.gameState===SceneManagerGame.GameState_ReadyToPlayBattleRoyale){this.setGameState(SceneManagerGame.GameState_CharacterSelectScreen)}if(this.gameState===SceneManagerGame.GameState_CharacterSelectScreen){this.tileNotifications.setText("select game mode")}}}}};SceneManagerGame.prototype.readyToPlay1vs1=function(){this.toggleWaitingForOpponent(true);if(!this.map){this.setGameState(SceneManagerGame.GameState_ReadyToPlay1vs1)}BurgersClient.registerPlayer(this.playerType,"1vs1")};SceneManagerGame.prototype.readyToPlayBattleRoyale=function(mapID){if(!this.map){this.setGameState(SceneManagerGame.GameState_ReadyToPlayBattleRoyale)}if(mapID){MultiplayerManager.RequestJoinMap(mapID,this.playerType)}else{BurgersClient.registerPlayer(this.playerType,"BattleRoyale")}};SceneManagerGame.prototype.displayGameTileMessages=function(broadcast){var messages=broadcast.messages;for(var i=0;i<messages.length;++i){var tile=this.tileTitleMessages[i];tile.setText(messages[i],true)}this.requestResize();if(this.waitingForOpponent){if(broadcast.queuePosition!==undefined){var broadcastQueuePosition=broadcast.queuePosition;var text="queueing to play ";text+=broadcastQueuePosition;this.tileNotifications.setText(text,true)}else{this.tileNotifications.setText("waiting for opponent",true)}}};SceneManagerGame.prototype.syncUpdate=function(jsonData){var map=this.map;var i,length,jsonPlayer;if(jsonData.appInfo){this.updateAppInfo(jsonData.appInfo)}else if(jsonData.gameTitleMessages){this.displayGameTileMessages(jsonData.gameTitleMessages)}else if(jsonData.status){this.tilePlayerStatus.setText(jsonData.status,true);this.requestResize()}else if(jsonData.loadGame){var mapType=jsonData.type;var newChallenger=this.gameState===SceneManagerGame.GameState_Playing1vs1;if(map){this.matchEnd(false)}var mapID=jsonData.loadGame;this.loadGame(mapID,mapType,jsonData);if(newChallenger){this.tileNotifications.setText("here comes a new challenger")}var jsonPlayers=jsonData.players;if(jsonPlayers){if(Array.isArray(jsonPlayers)){var playerIDs=new Array(2);var playerTypes=new Array(2);length=jsonPlayers.length;for(i=0;i<length;++i){jsonPlayer=jsonPlayers[i];if(jsonPlayer){playerIDs[i]=jsonPlayer.userID;playerTypes[i]=jsonPlayer.playerType;this.sceneLeaderboards.updateLeaderboardData(SceneLeaderboards.Leaderboard_AllTime,jsonPlayer)}}if(playerTypes[0]&&playerTypes[1]){this.sceneSplashScreen.hide();this.sceneSplashScreen.show(playerTypes[0],this.sceneLeaderboards.getPlayerCountryCode(playerIDs[0]),playerTypes[1],this.sceneLeaderboards.getPlayerCountryCode(playerIDs[1]))}}}}else if(jsonData.GameWon!==undefined){var result=jsonData.GameWon;if(result==="abandoned"){if(map){map.setOffline();this.spawnOfflineGame()}else{this.gotoSplashScreenGameState();this.gotoCharacterSelectScreenState()}this.readyToPlay1vs1()}else if(result==="draw"){this.matchResult(false)}else if(result){if(jsonData.disconnected){var playerDisconnectedID=jsonData.disconnected;if(map){var player=map.getPlayerFromID(MultiplayerManager.SessionID);var disconnectedPlayer=map.getPlayerFromID(playerDisconnectedID);if(player&&disconnectedPlayer&&player!==disconnectedPlayer){var aiController=new CharacterControllerAI(map.getPathFinderNetwork());disconnectedPlayer.setupAI(aiController);if(!map.gameStarted()){aiController.enable(false)}aiController.setWaypointCycle(CharacterControllerAI.cycle_randomConnections);aiController.setMovementMagnitude(.75);aiController.setEnemy(player);map.setMapID("");this.readyToPlay1vs1()}else{this.matchResult(true)}}}else{this.matchResult(true)}}else{this.matchResult(false)}}else if(jsonData.leaderboards){var leaderboardType=this.sceneLeaderboards.parseLeaderboardType(jsonData);var leaderboardsData=jsonData.leaderboards;if(Array.isArray(leaderboardsData)){length=leaderboardsData.length;for(i=0;i<length;++i){jsonPlayer=leaderboardsData[i];if(jsonPlayer){this.sceneLeaderboards.updateLeaderboardData(leaderboardType,jsonPlayer)}}if(this.gameState===SceneManagerGame.GameState_Leaderboards){this.sceneLeaderboards.show()}}}else if(jsonData.userInfo){jsonPlayer=jsonData.userInfo;if(jsonPlayer){this.sceneLeaderboards.updateLeaderboardData(SceneLeaderboards.Leaderboard_AllTime,jsonPlayer)}}this.SceneManagerPlay_syncUpdate(jsonData)};SceneManagerGame.prototype.loadGame=function(mapID,mapType,jsonData){var self=this;if(this.sceneMultiLauncher){this.sceneMultiLauncher.hide()}if(mapID){if(this.waitingForOpponent){this.toggleWaitingForOpponent(false)}}if(!this.waitingForOpponent){this.tileNotifications.setText("loading")}var timers=this.timers;timers.length=0;this.showSplashScreen();this.setGameState(SceneManagerGame.GameState_Playing1vs1);this.hideFlag();var timer=new CCTimer;timer.onTime.add(function(){self.hideSplashScreen();self.sceneBackground.hide();if(mapType==="1vs1"){self.loadedGame(new SceneGame1vs1(mapID))}else if(mapType==="BattleRoyale"){self.loadedGame(new SceneGameBattleRoyale(mapID))}if(jsonData){self.map.syncUpdate(jsonData)}});timer.start(2);timers.add(timer)};SceneManagerGame.prototype.loadedGame=function(map){var self=this;map.onBack=function(){self.toggleWaitingForOpponent(false);self.matchEnd(false)};this.map=map;map.setParent(this);if(!map.isOnlineGame()){this.spawnOfflineGame()}};SceneManagerGame.prototype.spawnOfflineGame=function(){var map=this.map;var i;{var sandbagLocations=[];sandbagLocations.add([0,0,0]);sandbagLocations.add([-50,0,-100]);sandbagLocations.add([50,0,-100]);sandbagLocations.add([-50,0,100]);sandbagLocations.add([50,0,100]);var objFile="barbedwire.obj";var texFile="barbedwire_diffuse.png";var sandbagWidth=30;for(i=0;i<sandbagLocations.length;++i){map.spawnStaticObject("sandbag"+i,objFile,texFile,null,sandbagWidth,90,sandbagLocations[i])}}this.spawnOfflinePlayers();var player1=map.getPlayerFromID(MultiplayerManager.SessionID);var player2=map.getPlayerFromID("player2");map.syncPlayerSetLocation(player1.getPlayerID(),vec3.clone([-50,player1.position[1],0]));map.syncPlayerSetLocation(player2.getPlayerID(),vec3.clone([50,player2.position[1],0]));for(i=0;i<4;++i){var pickup=map.spawnPickup("healthpack","health",null);var mapBounds=map.getMapBounds();var location=vec3.create();location[0]=mapBounds.width*.9*CC.FloatRandomDualSided();location[2]=mapBounds.height*.9*CC.FloatRandomDualSided();pickup.setPositionXZ(location[0],location[2]);map.adjustCollisionPlacement(pickup)}{var aiController=new CharacterControllerAI(map.getPathFinderNetwork());player2.setupAI(aiController);aiController.enable(false);aiController.setWaypointCycle(CharacterControllerAI.cycle_randomConnections);aiController.setMovementMagnitude(.5);aiController.setEnemy(player1)}map.syncPlayerHealth(player1.getPlayerID(),100,true);map.syncPlayerHealth(player2.getPlayerID(),100,true);if(map.getNumberOfPlayers()>=2){if(!this.waitingForOpponent){this.tileNotifications.setText("")}map.startIntro()}};SceneManagerGame.prototype.spawnOfflinePlayers=function(){var map=this.map;var player1=map.spawnCharacter(this.playerType,MultiplayerManager.SessionID,MultiplayerManager.UserID);map.assignPlayerCharacter(player1);var player2;if(this.playerType.contains(this.playerTypes[0].type)){player2=map.spawnCharacter(this.playerTypes[1].type,"player2")}else{player2=map.spawnCharacter(this.playerTypes[0].type,"player2")}map.addEnemy(player2)};SceneManagerGame.prototype.matchResult=function(won){if(this.map){if(won){this.map.startWinning()}else{this.map.startLosing()}}else{this.matchEnd(true)}};SceneManagerGame.prototype.matchEnd=function(showLeaderboards){this.hideSplashScreen();
if(this.map){if(this.map.isOnlineGame()){this.sceneLeaderboards.dirtyLeaderboards()}this.map.deleteLater();this.map=null}if(showLeaderboards){this.showLeaderboards();if(this.waitingForOpponent){this.exitLeaderboardsState()}}else{this.gotoCharacterSelectScreenState()}};SceneManagerGame.prototype.startOfflineGame=function(){if(!this.map){this.loadGame(null,"1vs1",500);return true}return false};SceneManagerGame.prototype.isUsablePlayer=function(launchShop){if(launchShop===undefined){launchShop=true}var playerTypeInfo=this.getPlayerTypeInfo(this.playerType);if(playerTypeInfo){var playerItemCode;if(playerTypeInfo.type==="doubleburger"||playerTypeInfo.type==="doublefries"){playerItemCode="burgers_doubleweapons"}else if(playerTypeInfo.type==="miniche"||playerTypeInfo.type==="soldier"){playerItemCode="tanks_switchTeams"}if(playerItemCode){if(!SceneItemShop.HasPurchasedNonConsumable(playerItemCode)){if(launchShop){var self=this;new SceneItemShop("Get coins to unlock\nall game characters",playerItemCode,true,"unlock","unlock","unlock",function(type,itemCode,value){CC.SaveData("shop."+playerItemCode+".item");self.scenePlayScreen.showPlayerView(self.playerType)})}return false}}}return true};SceneManagerGame.prototype.switchTeams=function(direction){var playerTypeIndex=0;var playerTypes=this.playerTypes;for(var i=0;i<playerTypes.length;++i){if(this.playerType===playerTypes[i].type){playerTypeIndex=i;break}}if(direction>0){playerTypeIndex++;if(playerTypeIndex>=playerTypes.length){playerTypeIndex=0}}else if(direction<0){playerTypeIndex--;if(playerTypeIndex<0){playerTypeIndex=playerTypes.length-1}}this.playerType=playerTypes[playerTypeIndex].type;if(!this.map){this.setGameState(SceneManagerGame.GameState_CharacterSelectScreen);if(MultiplayerManager.LoggedIn){if(this.waitingForOpponent){this.toggleWaitingForOpponent(false)}}this.updatedGameState();this.scenePlayScreen.showPlayerView(this.playerType)}};SceneManagerGame.prototype.showLeaderboards=function(){if(MultiplayerManager.LoggedIn){if(this.sceneMultiLauncher){this.sceneMultiLauncher.hide()}this.showBack();this.setGameState(SceneManagerGame.GameState_Leaderboards);this.hideFlag();this.scenePlayScreen.hide();this.sceneBackground.show();this.sceneLeaderboards.show();if(!this.waitingForOpponent){this.tileNotifications.setText("")}return true}return false};SceneManagerGame.prototype.showBack=function(){this.tileBack.setColourAlpha(1,true);this.tileBack.setCollideable(true)};SceneManagerGame.prototype.hideBack=function(){this.tileBack.setColourAlpha(0,true);this.tileBack.setCollideable(false)};SceneManagerGame.prototype.createFlag=function(){if(MultiplayerManager.geoLocationCountryCode){var file="flag_";file+=MultiplayerManager.geoLocationCountryCode;file+=".png";if(!this.tileFlag){var self=this;var camera=this.camera;var tile=new CCTile3DButton(this);tile.setupTextured(file,function(){self.requestResize();self.showFlag()});tile.tileScaleInterpolator.setDuration(.25);this.tileFlag=tile;return}}this.hideFlag()};SceneManagerGame.prototype.showFlag=function(){if(this.gameState!==SceneManagerGame.GameState_Playing1vs1&&this.gameState!==SceneManagerGame.GameState_PlayingBattleRoyale){if(this.tileFlag){this.tileFlag.setTileScale(0,false);this.tileFlag.setTileScale(1,true);this.tileFlag.setColourAlpha(1,true)}}};SceneManagerGame.prototype.hideFlag=function(){if(this.tileFlag){this.tileFlag.setTileScale(0,true);this.tileFlag.setColourAlpha(0,true)}};SceneManagerGame.prototype.syncLoggedIntoSocialNetwork=function(network){if(network==="facebook"){this.scenePlayScreen.loggedIntoFacebook()}else if(network==="twitter"){this.scenePlayScreen.loggedIntoTwitter()}else if(network==="google"){this.scenePlayScreen.loggedIntoGoogle()}};SceneManagerGame.prototype.getConstUserIDData=function(userID){if(this.sceneLeaderboards){return this.sceneLeaderboards.getConstUserIDData(SceneLeaderboards.Leaderboard_AllTime,userID)}};SceneManagerGame.prototype.getStatusPositionY=function(){return this.tilePlayerStatus.aabbMin[1]};function SceneGameMap(mapID,mapType){this.construct(mapID,mapType)}ExtendPrototype(SceneGameMap,CCSceneAppUI);SceneGameMap.DefaultMapImage="level_map_diffuse.jpg";SceneGameMap.prototype.construct=function(mapID,mapType){MultiplayerManager.UpdateCallbacks.insert(this,0);this.CCSceneAppUI_construct();this.cameraCentered=true;this.oneTouchDoubleTapped=this.oneTouchDoubleTappedLastPress=false;this.controlsRotationVelocity=0;this.cameraRotationTargetSpeed=180;this.setMapID(mapID);this.mapType=mapType;this.mapBounds=new CCSize;this.ground=null;this.walls=[];this.players=[];this.enemies=[];this.particles=[];this.staticObjects=[];this.pickups=[];this.createCamera();{this.pathFinderNetwork=new CCPathFinderNetwork;this.ground=new CollideableFloor(this,"ground");this.ground.setWriteDepth(false);this.ground.setDrawOrder(50);this.ground.setTransparent();this.ground.setColourAlpha(0,false);this.setMapSize(500)}if(MultiplayerManager.LoggedIn){this.syncLoggedIn()}gEngine.addScene(this)};SceneGameMap.prototype.createCamera=function(){var camera=gEngine.newSceneCamera(this,0);camera.setupViewport(0,0,1,1);camera.useSceneCollideables(this)};SceneGameMap.prototype.setup=function(){this.setMapTexture(SceneGameMap.DefaultMapImage);this.createParticles();this.lockCameraView();this.refreshCameraView()};SceneGameMap.prototype.setMapTexture=function(filename){if(this.ground){var self=this;this.ground.setTransparent();this.ground.setColourAlpha(0,true);this.ground.primitive.setTexture(filename,undefined,undefined,undefined,function(){self.ground.setColourAlpha(1,true,function(){self.ground.setTransparent(false)})})}};SceneGameMap.prototype.setMapTextureIndex=function(index){if(this.ground){this.ground.primitive.setTextureIndex(index);this.setTransparent();var self=this;this.ground.setColourAlpha(1,true,function(){self.ground.setTransparent(false)})}};SceneGameMap.prototype.setMapSize=function(size){this.mapSize=size;var mapBounds=this.mapBounds;mapBounds.width=this.mapSize*.5*.8;mapBounds.height=this.mapSize*.5*.8;this.ground.setup(this.mapSize,this.mapSize);{var walls=this.walls;if(walls.length>0){for(var i=0;i<walls.length;++i){walls[i].deleteLater()}walls.length=0}{var x=this.mapSize*.5;var z=this.mapSize*.5;var width=this.mapSize;var depth=this.mapSize;var height=20;var wall=new CollideableWall;wall.setup(this,-x,0,depth,height);wall.translate(-wall.collisionBounds[0],0,0);walls.add(wall);wall=new CollideableWall;wall.setup(this,x,0,depth,height);wall.translate(wall.collisionBounds[0],0,0);walls.add(wall);wall=new CollideableWall;wall.setup(this,0,-z,width,height);wall.translate(0,0,-wall.collisionBounds[2]);walls.add(wall);wall=new CollideableWall;wall.setup(this,0,z,width,height);wall.translate(0,0,wall.collisionBounds[2]);walls.add(wall)}}this.refreshCameraView()};SceneGameMap.prototype.updateScene=function(delta){{var particles=this.particles;var positive=1;for(var i=0;i<particles.length;++i){var particle=particles[i];particle.rotateY(delta*positive)}}if(this.controlsRotationVelocity){this.controlsRotationVelocity=CC.ToTarget(this.controlsRotationVelocity,0,delta*.1);this.camera.incrementRotationY(-this.controlsRotationVelocity*20)}if(this.cameraRotationTarget){var camera=this.camera;camera.setRotationX(CC.ToRotation(camera.rotation[0],this.cameraRotationTarget[0],delta*this.cameraRotationTargetSpeed));camera.setRotationY(CC.ToRotation(camera.rotation[1],this.cameraRotationTarget[1],delta*this.cameraRotationTargetSpeed));camera.setRotationZ(CC.ToRotation(camera.rotation[2],this.cameraRotationTarget[2],delta*this.cameraRotationTargetSpeed));if(vec3.equals(camera.rotation,this.cameraRotationTarget)){delete this.cameraRotationTarget}}return this.CCSceneAppUI_updateScene(delta)};SceneGameMap.prototype.render=function(camera,pass,alpha){if(this.camera===camera){this.CCSceneAppUI_render(camera,pass,alpha)}};SceneGameMap.prototype.postRender=function(camera,pass,alpha){if(this.camera===camera){if(pass===CCRenderer.render_main&&alpha){if(CC.HasFlag(gRenderer.renderFlags,CCRenderer.render_pathFinder)){this.pathFinderNetwork.view()}}}};SceneGameMap.prototype.resize=function(){var camera=this.camera;CC.ASSERT(camera);camera.recalcViewport();camera.flagUpdate()};SceneGameMap.prototype.handleOneTouch=function(touch1){var usingControls=false;if(this.oneTouchDoubleTapped){if(touch1.timeHeld>=CCControls.DOUBLE_TAP_THRESHOLD){}}else{this.touchDelta.x=touch1.deltaX;this.touchDelta.y=touch1.deltaY;if(!this.controlsMoving&&this.controlsFirstTouchedInThisScene){if(this.touchMovementAllowed(touch1,this.touchDelta)){}else{usingControls=this.touchPressed(touch1)}}if(this.controlsMoving){usingControls=this.touchMoving(touch1,this.touchDelta)}}return usingControls};SceneGameMap.prototype.touchPressed=function(touch){};SceneGameMap.prototype.touchMovementAllowed=function(touch,touchDelta){var absDeltaX=Math.abs(touch.totalDeltaX);var absDeltaY=Math.abs(touch.totalDeltaY);if(absDeltaX>CCControls.TouchMovementThreashold.x||absDeltaY>CCControls.TouchMovementThreashold.y){this.controlsMoving=true;touchDelta.x+=touch.totalDeltaX;touchDelta.y+=touch.totalDeltaY;this.controlsMovingVertical=absDeltaY>absDeltaX;var camera=this.camera;var plane=vec3.create();camera.project3DY(plane,touch.x,touch.y);vec3.subtract(plane,plane,camera.currentLookAt);this.cameraPanningFrom=plane;return true}return false};SceneGameMap.prototype.touchMoving=function(touch,touchDelta){var result=this.handleTilesTouch(touch,this.controlsMovingVertical?CCControls.touch_movingVertical:CCControls.touch_movingHorizontal);if(result===CCSceneAppUI.tile_touchAction){return true}else{return this.touchCameraMoving(touchDelta.x,touchDelta.y)}};SceneGameMap.prototype.touchReleased=function(touch,touchAction){var result=this.handleTilesTouch(touch,touchAction);var usingControls=result===CCSceneAppUI.tile_touchAction;if(!usingControls&&touchAction===CCControls.touch_released){var camera=this.camera;if(this.oneTouchDoubleTapped){}else if(this.controlsMoving){usingControls=this.touchReleaseSwipe(touch)}}if(this.oneTouchDoubleTappedLastPress){this.oneTouchDoubleTappedLastPress=false}if(this.oneTouchDoubleTapped){this.oneTouchDoubleTappedLastPress=true;this.oneTouchDoubleTapped=false}return usingControls};SceneGameMap.prototype.touchCameraMoving=function(x,y){var camera=this.camera;var updated=false;var delta;if(y!==0){delta=y*camera.cameraHeight;if(camera.targetLookAt[1]>this.sceneTop||camera.targetLookAt[1]<this.sceneBottom){delta*=.5}camera.targetLookAt[2]-=delta;camera.flagUpdate();updated=true}if(x!==0){delta=x*camera.cameraWidth;if(camera.targetLookAt[0]<this.sceneLeft||camera.targetLookAt[0]>this.sceneRight){delta*=.5}camera.targetLookAt[0]-=delta;camera.flagUpdate();updated=true}return updated};SceneGameMap.prototype.touchCameraRotating=function(x,y){var camera=this.camera;camera.incrementRotationY(-x*90);return true};SceneGameMap.prototype.touchReleaseSwipe=function(touch){var camera=this.camera;var timeHeldMultiplyer=(touch.timeHeld-.5)*-1*2*2;if(timeHeldMultiplyer<1){timeHeldMultiplyer=1}{var averageDeltas=touch.averageLastDeltas();if(touch.totalDeltaX<0){if(this.controlsRotationVelocity>0){this.controlsRotationVelocity=0}this.controlsRotationVelocity+=averageDeltas.x*timeHeldMultiplyer;if(this.controlsRotationVelocity<-.1){this.controlsRotationVelocity=-.1}return true}else if(touch.totalDeltaX>0){if(this.controlsRotationVelocity<0){this.controlsRotationVelocity=0}this.controlsRotationVelocity+=averageDeltas.x*timeHeldMultiplyer;if(this.controlsRotationVelocity>.1){this.controlsRotationVelocity=.1}return true}}return false};SceneGameMap.prototype.refreshCameraView=function(){var mapBounds=this.mapBounds;this.sceneLeft=-mapBounds.width;this.sceneRight=mapBounds.width;this.sceneTop=mapBounds.height;this.sceneBottom=-mapBounds.height};SceneGameMap.prototype.lockCameraView=function(){if(this.cameraScrolling){return}var camera=this.camera;if(camera.targetLookAt[0]>this.sceneRight){camera.targetLookAt[0]=this.sceneRight;camera.flagUpdate()}else if(camera.targetLookAt[0]<this.sceneLeft){camera.targetLookAt[0]=this.sceneLeft;camera.flagUpdate()}if(camera.targetLookAt[2]>this.sceneTop){camera.targetLookAt[2]=this.sceneTop;camera.flagUpdate()}else if(camera.targetLookAt[2]<this.sceneBottom){camera.targetLookAt[2]=this.sceneBottom;camera.flagUpdate()}};SceneGameMap.prototype.setMapID=function(mapID){this.mapID=mapID};SceneGameMap.prototype.getMapID=function(){return this.mapID};SceneGameMap.prototype.setOffline=function(){this.setMapID("")};SceneGameMap.prototype.isOnlineGame=function(){if(this.mapID&&this.mapID.length>0){return true}return false};SceneGameMap.prototype.getMapType=function(){return this.mapType};SceneGameMap.prototype.createParticles=function(){var self=this;var commonLevelsPath="level_";var objFile=commonLevelsPath;objFile+="particles.obj";var texFile=commonLevelsPath;texFile+="particles_diffuse.png";var object;{object=new CCObject;object.setScene(this);object.setColour(gColour.set(1,.5));CCModel3D.CacheModel(objFile,false,function(model3d){model3d.setTexture(texFile);var model=new CCModelBase;model.addModel(model3d);object.setModel(model);object.setTransparent();object.setReadDepth(false);var modelWidth=model3d.getWidth();var scaleFactor=self.ground.collisionSize.width/modelWidth;model.setScale(scaleFactor);self.particles.add(object)})}{object=new CCObject;object.setScene(this);object.setColour(gColour.set(1,.5));object.rotateY(90);CCModel3D.CacheModel(objFile,false,function(model3d){model3d.setTexture(texFile);var model=new CCModelBase;model.addModel(model3d);object.setModel(model);object.setTransparent();object.setReadDepth(false);var modelWidth=model3d.getWidth();var scaleFactor=self.ground.collisionSize.width/modelWidth;model.setScale(scaleFactor);self.particles.add(object)})}};SceneGameMap.prototype.updatePathFinder=function(){this.pathFinderNetwork.connect();var i;var players=this.players;for(i=0;i<players.length;++i){this.adjustCollisionPlacement(players[i])}for(i=0;i<players.length;++i){var player=players[i];var controller=player.controller;if(controller){controller.resetPathNodes()}}};SceneGameMap.prototype.adjustCollisionPlacement=function(source){if(source.position[1]<source.collisionBounds[1]){source.setPositionY(source.collisionBounds[1])}var collisionFlags=CC.collision_static|CC.collision_character;var collision=null;do{CC.UpdateCollisions(source,false);collision=CC.CollideableScan(source.aabbMin,source.aabbMax,source,collisionFlags);if(collision){source.translate(0,0,10)}}while(collision)};SceneGameMap.prototype.spawnStaticObject=function(objectID,obj,tex,options,width,rotation,location){var object;for(var i=0;i<this.staticObjects.length;++i){if(objectID===this.staticObjects[i].objectID){object=this.staticObjects[i];this.pathFinderNetwork.removeCollideable(object);break}}if(!object){object=new CCCollideableStaticMesh(objectID);object.setScene(this);object.setTransparent();object.setDrawOrder(99);this.staticObjects.add(object)}object.setPositionXZ(location[0],location[2]);object.setupModel(obj,tex,width);if(options){if(options.modelID){object.modelID=options.modelID}if(options.noCulling!==undefined){object.setCulling(!options.noCulling)}}object.model.rotateY(rotation);this.pathFinderNetwork.addCollideable(object,this.ground.collisionBounds);this.updatePathFinder();return object};SceneGameMap.prototype.getStaticObject=function(objectID){var staticObjects=this.staticObjects;for(var i=0;i<staticObjects.length;++i){var object=staticObjects[i];if(object.getID()===objectID){return object}}return null};SceneGameMap.prototype.spawnPickup=function(name,type,pickupID){var pickup=new PickupBase(name,type,pickupID);var objPath=name;objPath+=".obj";var texPath=name;texPath+="_diffuse.jpg";pickup.setup(objPath,texPath);pickup.setScene(this);this.adjustCollisionPlacement(pickup);this.pickups.add(pickup);return pickup};SceneGameMap.prototype.handlePickup=function(player,pickup){pickup.deleteLater();this.pickups.remove(pickup);return true};SceneGameMap.prototype.spawnCharacter=function(type,playerID,userID){if(playerID===undefined){playerID="0"}if(userID===undefined){userID=playerID}var character=SceneManagerPlay.SpawnCharacter(type);character.setupMap(this,playerID,userID);this.adjustCollisionPlacement(character);character.setupAI(new CharacterControllerPlayer(this.pathFinderNetwork));this.players.add(character);return character};SceneGameMap.prototype.spawnedCharacter=function(character){};SceneGameMap.prototype.deletingCharacter=function(character){this.players.remove(character);this.enemies.remove(character)};SceneGameMap.prototype.assignPlayerCharacter=function(character){this.registerAmmoUpdate(character);this.spawnedCharacter(character)};SceneGameMap.prototype.addEnemy=function(character){character.setupShootingIndicator("fx_character_shooting_texture.png",gColour.setRGBA(1,.5,0,.9));character.setupCharacterIndicator("fx_character_highlight_texture.png",gColour.setRGBA(1,.25,.25,.5));this.enemies.add(character);this.registerAmmoUpdate(character);this.spawnedCharacter(character)};SceneGameMap.prototype.removeEnemy=function(enemy){this.removeEnemyID(enemy.getPlayerID())};SceneGameMap.prototype.removeEnemyID=function(playerID){var enemies=this.enemies;for(var i=0;i<enemies.length;++i){var enemy=enemies[i];if(playerID===enemy.getPlayerID()){enemy.deleteLater();enemies.remove(enemy);break}}};SceneGameMap.prototype.getPlayer=function(object){var players=this.players;var length=players.length;for(var i=0;i<length;++i){var player=players[i];if(player===object){return player}}return null};SceneGameMap.prototype.getPlayerFromID=function(playerID){var players=this.players;var length=players.length;for(var i=0;i<length;++i){var player=players[i];if(player.getPlayerID()===playerID){return player}}return null};SceneGameMap.prototype.getEnemy=function(object){var enemies=this.enemies;var length=enemies.length;for(var i=0;i<length;++i){var enemy=enemies[i];if(enemy===object){return enemy}}return null};SceneGameMap.prototype.getEnemyFromID=function(playerID){var enemies=this.enemies;var length=enemies.length;for(var i=0;i<length;++i){var character=enemies[i];if(character.getPlayerID()===playerID){return character}}return null};SceneGameMap.prototype.registerAttacking=function(attacker){};SceneGameMap.prototype.registerAmmoUpdate=function(player){};SceneGameMap.prototype.handleAttack=function(attackedBy,attackType,force,damage,x,y,z){return false};SceneGameMap.prototype.registerDamage=function(from,to,damage){};SceneGameMap.prototype.registerDeath=function(playerID,killerID,synced){};SceneGameMap.prototype.syncLoggedIn=function(){};SceneGameMap.prototype.syncUpdate=function(jsonData){var i;if(jsonData.mapTexture){var filename=jsonData.mapTexture;this.setMapTexture(filename)}if(jsonData.mapSize){var size=jsonData.mapSize;this.setMapSize(size)}if(jsonData.staticObjects){var staticObjects=jsonData.staticObjects;for(i=0;i<staticObjects.length;++i){this.syncUpdate(staticObjects[i])}}var playerID,mapBounds,players,locationString,location,health,objectID;if(jsonData.addPlayer){playerID=jsonData.addPlayer;locationString=jsonData.location;location=vec3.fromString(locationString);mapBounds=this.getMapBounds();location[0]*=mapBounds.width;location[2]*=mapBounds.height;this.syncAddPlayer(playerID,jsonData.userID,jsonData.playerType,location,jsonData.health,jsonData);var bulletDamage=jsonData.bulletDamage;var bulletTax=jsonData.bulletTax;var fireChargeRate=jsonData.fireChargeRate;var timeToReady=jsonData.timeToReady;if(bulletDamage!==undefined||bulletTax!==undefined||fireChargeRate!==undefined||timeToReady!==undefined){this.syncWeaponSettings(playerID,timeToReady,bulletDamage,bulletTax,fireChargeRate)}}else if(jsonData.removePlayer){playerID=jsonData.removePlayer;var removedPlayer=this.getPlayerFromID(playerID);if(removedPlayer){this.removeEnemyID(playerID)}}else if(jsonData.gotoLocation){playerID=jsonData.gotoLocation;locationString=jsonData.location;location=vec3.fromString(locationString);mapBounds=this.getMapBounds();location[0]*=mapBounds.width;location[2]*=mapBounds.height;this.syncPlayerGotoLocation(playerID,location)}else if(jsonData.shootAt){playerID=jsonData.shootAt;var targetID=jsonData.target;this.syncPlayerShootAt(playerID,targetID)}else if(jsonData.SyncShootAtTarget){playerID=jsonData.SyncShootAtTarget;this.SyncShootAtTarget(playerID,jsonData.targetLocation)}else if(jsonData.syncPlayerAction){playerID=jsonData.syncPlayerAction;var actionID=jsonData.actionID;this.syncPlayerAction(playerID,actionID)}else if(jsonData.setHealth){playerID=jsonData.setHealth;health=jsonData.health;this.syncPlayerHealth(playerID,health,false)}else if(jsonData.registerDeath!==undefined){playerID=jsonData.registerDeath;this.registerDeath(playerID,jsonData.killerID,true)}else if(jsonData.spawnStaticObject){objectID=jsonData.spawnStaticObject;var obj=jsonData.obj;var tex=jsonData.tex;var options=jsonData.options;var width=jsonData.width;locationString=jsonData.location;location=vec3.fromString(locationString);var rotation=jsonData.rotation?jsonData.rotation:0;mapBounds=this.getMapBounds();location[0]*=mapBounds.width;location[2]*=mapBounds.height;this.spawnStaticObject(objectID,obj,tex,options,width,rotation,location)}else if(jsonData.removeStaticObject){objectID=jsonData.removeStaticObject;this.syncRemoveStaticObject(objectID)}if(jsonData.spawnPickup){objectID=jsonData.spawnPickup;var type=jsonData.type;locationString=jsonData.location;location=vec3.fromString(locationString);var pickup=this.spawnPickup("healthpack",type,objectID);if(pickup){mapBounds=this.getMapBounds();location[0]*=mapBounds.width;location[2]*=mapBounds.height;pickup.setPositionXZ(location[0],location[2]);this.adjustCollisionPlacement(pickup)}}if(jsonData.removePickup){objectID=jsonData.removePickup;this.syncRemovePickup(objectID)}};SceneGameMap.prototype.syncAddPlayer=function(playerID,userID,playerType,location,health,jsonData){var player=this.getPlayerFromID(playerID);if(!player){player=this.spawnCharacter(playerType,playerID,userID);if(MultiplayerManager.SessionID===playerID){this.assignPlayerCharacter(player)}else{this.addEnemy(player)}}{this.syncPlayerSetLocation(playerID,location)}{this.syncPlayerHealth(playerID,health,true)}};SceneGameMap.prototype.syncPlayerHealth=function(playerID,health,initialize){var character=this.getPlayerFromID(playerID);if(character){character.controller.setHealth(health,initialize);if(this.updateHealthUI){var healthRatio=character.controller.getHealthRatio();this.updateHealthUI(character,healthRatio)}}};SceneGameMap.prototype.syncWeaponSettings=function(playerID,timeToReady,bulletDamage,bulletTax,fireChargeRate){var character=this.getPlayerFromID(playerID);if(character){character.setWeaponSettings(timeToReady,bulletDamage,bulletTax,fireChargeRate)}};SceneGameMap.prototype.syncPlayerSetLocation=function(playerID,location){var character=this.getPlayerFromID(playerID);if(character){character.setPosition(location);this.adjustCollisionPlacement(character);character.controller.stopAction()}};SceneGameMap.prototype.syncPlayerGotoLocation=function(playerID,location){var character=this.getPlayerFromID(playerID);if(character){character.controller.goToScan(location)}};SceneGameMap.prototype.syncPlayerShootAt=function(playerID,targetID){var player=this.getPlayerFromID(playerID);var target=this.getPlayerFromID(targetID);if(player&&target&&player!==target){player.controller.shootAt(target)}};SceneGameMap.prototype.SyncShootAtTarget=function(playerID,targetLocation){var player=this.getPlayerFromID(playerID);if(player){player.controller.shoot(targetLocation)}};SceneGameMap.prototype.syncPlayerAction=function(playerID,actionID){var player=this.getPlayerFromID(playerID);player.controller.shoot(null,null,actionID)};SceneGameMap.prototype.syncRemoveStaticObject=function(objectID){var staticObjects=this.staticObjects;for(var i=0;i<staticObjects.length;++i){var object=staticObjects[i];if(object.getID()===objectID){object.deleteLater();staticObjects.remove(object);this.pathFinderNetwork.removeCollideable(object)}}this.updatePathFinder()};SceneGameMap.prototype.syncRemovePickup=function(pickupID){var pickups=this.pickups;for(var i=0;i<pickups.length;++i){var pickup=pickups[i];if(pickup.getID()===pickupID){pickup.deleteLater();pickups.remove(pickup);break}}};SceneGameMap.prototype.getNumberOfPlayers=function(){return this.players.length};SceneGameMap.prototype.getNumberOfHumanPlayers=function(){var count=0;var players=this.players;for(var i=0;i<players.length;++i){var player=players[i];if(!player.controller.isAI()){count++}}return count};SceneGameMap.prototype.getPathFinderNetwork=function(){return this.pathFinderNetwork};SceneGameMap.prototype.getMapBounds=function(){return this.mapBounds};function SceneGameSyndicate(mapID,mapType){this.construct(mapID,mapType)}ExtendPrototype(SceneGameSyndicate,SceneGameMap);SceneGameSyndicate.prototype.construct=function(mapID,mapType){this.playerCharacter=null;this.playerDestinationPending=null;this.playerDestinationIndicator=null;this.SceneGameMap_construct(mapID,mapType);var self=this;this.onKeyboardFunction=function(event,key,pressed){return self.onKeyboard(event,key,pressed)};gEngine.controls.requestKeyboard(this.onKeyboardFunction,false);this.keyPressedTimer=0;this.keySyncTimer=0};SceneGameSyndicate.KeySyncTime=.25;SceneGameSyndicate.prototype.destruct=function(){if(this.playerCharacter){this.playerCharacter.deleteLater();this.playerCharacter=null}if(this.onKeyboardFunction){gEngine.controls.removeKeyboard(this.onKeyboardFunction);delete this.onKeyboardFunction}this.SceneGameMap_destruct()};SceneGameSyndicate.prototype.deleteLater=function(){if(this.isOnlineGame()&&!this.exitedGame){if(MultiplayerManager.LoggedIn){BurgersClient.exitedGame();this.exitedGame=true}}this.SceneGameMap_deleteLater()};SceneGameSyndicate.prototype.setup=function(){this.SceneGameMap_setup();var camera=this.camera;camera.targetOffset[2]=75;camera.setRotationX(-30);this.setupPlayerDestinationIndicator("fx_character_highlight_texture.png",gColour.setRGBA(.75,.75,1,1));this.setupUI();if(this.isOnlineGame()){this.setupOnlineGame()}};SceneGameSyndicate.prototype.setupUI=function(){this.sceneUI=new SceneGameUI(this)};SceneGameSyndicate.prototype.setupOnlineGame=function(){MultiplayerManager.SyncLoadedMap()};SceneGameSyndicate.prototype.updateScene=function(delta){if(this.playerDestinationPending){var touch=gEngine.controls.touches[0];if(touch.lastTimeReleased>CCControls.DOUBLE_TAP_THRESHOLD){if(!this.controlsMoving){this.onGotoLocation(this.playerDestinationPending);this.playerDestinationPending=null}}}if(this.playerDestinationIndicator){var alpha=this.playerDestinationIndicator.colour.a;if(alpha>0){this.playerDestinationIndicator.rotateY(delta*720);alpha=CC.ToTarget(alpha,0,delta*.5);this.playerDestinationIndicator.setColourAlpha(alpha)}}if(this.keyPressed){this.keyPressedTimer+=delta;this.keySyncTimer+=delta}return this.SceneGameMap_updateScene(delta)};SceneGameSyndicate.prototype.updateCameraLookAt=function(delta){var camera=this.camera;var playerCharacter=this.playerCharacter;if(this.playerCharacter&&(camera.targetLookAt[0]!==playerCharacter.position[0]||camera.targetLookAt[2]!==playerCharacter.position[2])){camera.targetLookAt[0]=playerCharacter.position[0];camera.targetLookAt[2]=playerCharacter.position[2];camera.flagUpdate()}};SceneGameSyndicate.prototype.updateCamera=function(delta){this.updateCameraLookAt(delta);var updated=false;var camera=this.camera;var lookAtSpeed=1.5;if(camera.interpolateCamera(delta,lookAtSpeed)){updated=true}else{if(this.cameraScrolling){this.cameraScrolling=false;this.lockCameraView();updated=true}if(this.resizing){this.resizing=false;this.refreshCameraView();this.lockCameraView();updated=true}}return updated};SceneGameSyndicate.prototype.handleBackButton=function(){if(this.onBack){this.onBack();return true}return false};SceneGameSyndicate.prototype.updateControls=function(controls){var usingControls=this.CCSceneAppUI_updateControls(controls);var cameraTouches=this.camera.cameraTouches;var touch=cameraTouches[0];if(touch.x>0&&touch.x<1&&touch.y>0&&touch.y<1&&touch.startX>0&&touch.startX<1&&touch.startY>0&&touch.startY<1){if(controls.wheel&&controls.wheel.delta!==0){var delta=controls.wheel.delta;this.touchCameraRotating(delta*.1,0);return true}}return usingControls};SceneGameSyndicate.prototype.handleOneTouch=function(touch1){var usingControls=false;if(this.oneTouchDoubleTapped){if(touch1.timeHeld>=CCControls.DOUBLE_TAP_THRESHOLD){}}else{this.touchDelta.x=touch1.deltaX;this.touchDelta.y=touch1.deltaY;if(!this.controlsMoving){if(this.touchMovementAllowed(touch1,this.touchDelta)){}else{usingControls=this.touchPressed(touch1)}}if(this.controlsMoving){usingControls=this.touchMoving(touch1,this.touchDelta)}}return usingControls};SceneGameSyndicate.prototype.touchPressed=function(touch){};SceneGameSyndicate.prototype.touchMoving=function(touch,touchDelta){var result=this.handleTilesTouch(touch,this.controlsMovingVertical?CCControls.touch_movingVertical:CCControls.touch_movingHorizontal);if(result===CCSceneAppUI.tile_touchAction){return true}else{return this.touchCameraRotating(touchDelta.x,touchDelta.y)}};SceneGameSyndicate.ProjectionLocation=vec3.create();SceneGameSyndicate.HitPosition=vec3.create();SceneGameSyndicate.prototype.touchReleased=function(touch,touchAction){var result=this.handleTilesTouch(touch,touchAction);var usingControls=result===CCSceneAppUI.tile_touchAction;if(!usingControls&&touchAction===CCControls.touch_released){var camera=this.camera;if(this.oneTouchDoubleTapped){}else if(this.controlsMoving){usingControls=this.touchReleaseSwipe(touch)}else if(this.playerCharacter){var playerCharacter=this.playerCharacter;if(camera.project3D(touch.x,touch.y)){var projectionResults=camera.projectionResults;var projectionLocation=SceneGameSyndicate.ProjectionLocation;var offset=projectionResults.vNear[1]/Math.abs(projectionResults.vDirection[1]);vec3.scale(projectionLocation,projectionResults.vDirection,offset);vec3.add(projectionLocation,projectionLocation,projectionResults.vNear);var hitObject=null;var collideables=this.collideables;var hitPosition=SceneGameSyndicate.HitPosition;hitObject=CC.BasicLineCollisionCheck(collideables,projectionResults.vNear,projectionResults.vFar,hitPosition,true,CC.collision_character,[playerCharacter],false);if(hitObject){if(hitObject===playerCharacter){hitObject=null}}else{hitObject=playerCharacter.controller.scanForEnemy(projectionLocation)}if(hitObject){this.onSelectObject(hitObject,projectionLocation)}else{this.onSelectLocation(projectionLocation)}}}}if(this.oneTouchDoubleTappedLastPress){this.oneTouchDoubleTappedLastPress=false}if(this.oneTouchDoubleTapped){this.oneTouchDoubleTappedLastPress=true;this.oneTouchDoubleTapped=false}return usingControls};SceneGameSyndicate.prototype.setupPlayerDestinationIndicator=function(textureFile,colour){if(this.playerDestinationIndicator){this.playerDestinationIndicator.deleteLater()}this.playerDestinationIndicator=new CollideableIndicator(this,textureFile);this.playerDestinationIndicator.setWidth(this.mapBounds.width*.1);this.playerDestinationIndicator.setColour(colour)};SceneGameSyndicate.prototype.handlePickup=function(player,pickup){if(this.isOnlineGame()){if(player===this.playerCharacter){MultiplayerManager.SyncServerRegisterPickup(player.getPlayerID(),pickup.getType(),pickup.getID())}}else{player.controller.resetHealth();var healthRatio=player.controller.getHealthRatio();this.updateHealthUI(player,healthRatio)}return this.SceneGameMap_handlePickup(player,pickup)};SceneGameSyndicate.prototype.assignPlayerCharacter=function(character){character.setupShootingIndicator("fx_character_shooting_texture.png",gColour.setRGBA(1,.5,0,.9));character.setupCharacterIndicator("fx_character_highlight_texture.png",gColour.setRGBA(.5,.75,1,.5));this.playerCharacter=character;this.SceneGameMap_assignPlayerCharacter(character)};SceneGameSyndicate.prototype.registerAttacking=function(attacker){if(this.sceneUI.setFire){if(attacker===this.playerCharacter){this.sceneUI.setFire(0)
}else{var enemy=this.getEnemy(attacker);if(enemy){if(this.sceneUI.getProfilePlayerID){if(this.sceneUI.getProfilePlayerID(1)===enemy.getPlayerID()){this.sceneUI.setFire(1)}}}}}};SceneGameSyndicate.prototype.registerAmmoUpdate=function(player){var ammo;if(this.sceneUI.setAmmo){if(this.sceneUI.getProfilePlayerID(0)===player.getPlayerID()){ammo=player.getWeaponAmmo();this.sceneUI.setAmmo(0,ammo)}else if(this.sceneUI.getProfilePlayerID(1)===player.getPlayerID()){ammo=player.getWeaponAmmo();this.sceneUI.setAmmo(1,ammo)}}};SceneGameSyndicate.prototype.playerShootAt=function(object,sync){this.playerCharacter.controller.shootAt(object);if(sync){if(this.isOnlineGame()){var enemy=this.getEnemy(object);if(enemy){MultiplayerManager.SyncServerPlayerShootAt(this,object.getPlayerID())}}}};SceneGameSyndicate.prototype.playerShootAtTarget=function(target,sync){this.playerCharacter.controller.shoot(target);if(sync){if(this.isOnlineGame()){MultiplayerManager.SyncShootAtTarget(this,target)}}};SceneGameSyndicate.prototype.playerAction=function(actionID,sync){this.playerCharacter.controller.shoot(null,null,actionID);if(sync===undefined){sync=true}if(sync){if(this.isOnlineGame()){MultiplayerManager.SyncPlayerAction(this,actionID)}}};SceneGameSyndicate.prototype.onSelectObject=function(hitObject,hitPosition){this.playerShootAt(hitObject,true)};SceneGameSyndicate.PlayerDestinationPending=vec3.create();SceneGameSyndicate.prototype.onSelectLocation=function(location){if(!this.playerDestinationPending){this.playerDestinationPending=SceneGameSyndicate.PlayerDestinationPending}var playerDestinationPending=this.playerDestinationPending;vec3.copy(playerDestinationPending,location);var mapBounds=this.mapBounds;playerDestinationPending[0]=CC.FloatClamp(playerDestinationPending[0],-mapBounds.width,mapBounds.width);playerDestinationPending[2]=CC.FloatClamp(playerDestinationPending[2],-mapBounds.height,mapBounds.height);if(this.playerDestinationIndicator){this.playerDestinationIndicator.setPositionXZ(playerDestinationPending[0],playerDestinationPending[2]);this.playerDestinationIndicator.setColourAlpha(1)}};SceneGameSyndicate.prototype.onKeyboard=function(event,key,pressed){if(event.metaKey){return false}if(event.ctrlKey){return false}if(!pressed){this.keyPressed=false}else{if(!this.keyPressed){this.keyPressed=true;this.keyPressedTimer=0}if(key==="up"||key==="down"||key===" "){var direction=[0,0,-1];if(key==="up"||key===" "){CC.Vector3RotateY(direction,this.camera.rotation[1])}else if(key==="down"){CC.Vector3RotateY(direction,this.camera.rotation[1]+180)}vec3.scale(direction,direction,this.keyPressedTimer>.25?30:15);var player=this.playerCharacter;vec3.add(direction,player.position,direction);if(key===" "){this.playerShootAtTarget(direction,true)}else{if(this.keySyncTimer>=SceneGameSyndicate.KeySyncTime){this.keySyncTimer-=SceneGameSyndicate.KeySyncTime;this.onGotoLocation(direction,true)}else{this.onGotoLocation(direction,false)}}}else if(key==="left"||key==="right"){if(!this.cameraRotationTarget){this.cameraRotationTarget=vec3.clone(this.camera.rotation)}var rotationAmount=this.keyPressedTimer>.25?14:7;if(key==="left"){this.cameraRotationTarget[1]+=rotationAmount}else if(key==="right"){this.cameraRotationTarget[1]-=rotationAmount}CC.ClampRotation(this.cameraRotationTarget[1])}}};SceneGameSyndicate.prototype.onGotoLocation=function(location,sync){var locationTarget=this.playerCharacter.controller.goToScan(location);if(sync===undefined){sync=true}if(sync){if(this.isOnlineGame()){MultiplayerManager.SyncServerPlayerGotoLocation(this,locationTarget)}}};SceneGameSyndicate.prototype.updateHealthUI=function(player,health){if(player===this.playerCharacter){if(this.sceneUI.setHealth){this.sceneUI.setHealth(0,health)}}else{if(this.sceneUI.setHealth){if(this.sceneUI.getProfilePlayerID){if(this.sceneUI.getProfilePlayerID(1)===player.getPlayerID()){this.sceneUI.setHealth(1,health)}}}}};function SceneManagerAndroids(){this.construct()}ExtendPrototype(SceneManagerAndroids,SceneManagerGame);SceneManagerAndroids.prototype.construct=function(){this.SceneManagerGame_construct();if(CCEngine.DeviceType==="iOS"){this.playerType="iBot"}else if(CCEngine.DeviceType==="Android"){this.playerType="androBot"}else if(CCEngine.DeviceType.contains("Windows")){this.playerType="winBot"}else{this.playerType="webBot"}gEngine.addScene(this)};SceneManagerAndroids.prototype.isUsablePlayer=function(launchShop){if(launchShop===undefined){launchShop=true}var allowedPlayerType="webBot";if(CCEngine.DeviceType==="iOS"){allowedPlayerType="iBot"}else if(CCEngine.DeviceType==="Android"){allowedPlayerType="androBot"}else if(CCEngine.DeviceType.contains("Windows")){allowedPlayerType="winBot"}if(!this.playerType.contains(allowedPlayerType)){var playerItemCode="androids_switchTeams";var self=this;if(!SceneItemShop.HasPurchasedNonConsumable(playerItemCode)){if(launchShop){new SceneItemShop("Get coins to unlock\n all Phone Wars characters",playerItemCode,true,"unlock","unlock","unlock",function(type,itemCode,value){CC.SaveData("shop."+playerItemCode+".item",true);self.scenePlayScreen.showPlayerView(self.playerType)})}return false}}return true};function SceneManagerJoinMap(mapID,playerType,mapClassName,onBack){this.mapID=mapID;if(!playerType){playerType="iBot"}if(!mapClassName){mapClassName="SceneGameBattleRoyale"}this.playerType=playerType;this.mapClassName=mapClassName;this.onBack=onBack;this.autoConnect=true;this.construct();gEngine.addScene(this)}ExtendPrototype(SceneManagerJoinMap,SceneManagerPlay);SceneManagerJoinMap.prototype.construct=function(){this.SceneManagerPlay_construct();this.syncDisconnected()};SceneManagerJoinMap.prototype.syncDisconnected=function(){if(!MultiplayerManager.ForceDisconnected){var self=this;AlertsManager.Alert("connecting...",function(){if(self.onBack){self.onBack()}})}};SceneManagerJoinMap.prototype.syncLoggedIn=function(){this.SceneManagerPlay_syncLoggedIn();if(this.autoConnect){this.requestJoinMap(this.mapID,this.playerType)}else{this.requestJoinMapRequired=true}};SceneManagerJoinMap.prototype.requestJoinMap=function(mapID,playerType){this.requestJoinMapRequired=false;if(this.map){this.map.deleteLater();this.map=null}MultiplayerManager.RequestJoinMap(this.mapID,this.playerType)};SceneManagerJoinMap.prototype.createMap=function(mapID){return new window[this.mapClassName](mapID)};SceneManagerJoinMap.prototype.syncUpdate=function(jsonData){if(jsonData.loadGame){AlertsManager.Hide("connecting...");if(this.map){this.map.setOffline();this.map.deleteLater();this.map=null}var mapType=jsonData.type;var mapID=jsonData.loadGame;this.map=this.createMap(mapID);this.map.setParent(this);if(this.onBack){var self=this;this.map.onBack=function(){self.deleteLater();self.onBack()}}this.map.syncUpdate(jsonData)}else if(jsonData.userInfo){if(this.sceneLeaderboards){this.sceneLeaderboards.updateLeaderboardData(SceneLeaderboards.Leaderboard_AllTime,jsonData.userInfo)}}this.SceneManagerPlay_syncUpdate(jsonData)};SceneManagerJoinMap.prototype.pauseConnection=function(){this.autoConnect=false};SceneManagerJoinMap.prototype.resumeConnection=function(){this.autoConnect=true;if(this.requestJoinMapRequired){this.requestToJoinMap(this.mapID,this.playerType)}};SceneManagerJoinMap.prototype.playerAction=function(actionID){if(this.map){this.map.playerAction(actionID,true)}};function SceneMapsList(parentScene){MultiplayerManager.UpdateCallbacks.addOnce(this);this.construct();this.controlsSwipeMomentum=true;if(parentScene){this.setParent(parentScene);parentScene.linkScene(this)}{var camera=gEngine.newSceneCamera(this);camera.setupViewport(0,0,1,1)}gEngine.addScene(this);if(parentScene){var self=this;this.sceneUIBack=new SceneUIBack(this,function(){self.close()})}this.sceneMultiLauncher=new SceneMultiUILauncher(this);this.sceneMultiLauncher.show();this.open=true}ExtendPrototype(SceneMapsList,CCSceneAppUI);SceneMapsList.prototype.deleteLater=function(){if(this.syncingUpdates){MultiplayerManager.Emit("BSUnregisterMapsListUpdates");this.syncingUpdates=false}this.CCSceneAppUI_deleteLater()};SceneMapsList.prototype.setup=function(){this.maps=[];this.mapTiles=[];var camera=this.camera;camera.setCameraWidth(640,false);camera.useSceneCollideables(this);var tile;{tile=new CCTile3DButton(this);tile.setupTile(camera.targetWidth,camera.targetHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColour(gColour.set(.25,0));tile.setColourAlpha(.95,true);tile.setDrawOrder(203);this.cameraStickyTiles.add(tile);this.tileBackground=tile;this.tileBackground.shouldRender=false}if(MultiplayerManager.Emit("BSRequestMapsList")){this.syncingUpdates=true}{var idealAspectRatio=1.5;var aspectRatioAdjutment=camera.getAspectRatio()<1.25?camera.getAspectRatio()/idealAspectRatio:1;tile=new CCTile3DButton(this);tile.setupText("More Maps",camera.targetHeight*.1*aspectRatioAdjutment,true,false);tile.setTextColour(gColour.set(.75,1));tile.setDrawOrder(204);this.tileMapsList=tile;this.addTile(tile)}this.requestResize()};SceneMapsList.prototype.render=function(camera,pass,alpha){};SceneMapsList.prototype.resize=function(){this.CCSceneAppUI_resize();var camera=this.camera;var tile;{tile=this.tileBackground;tile.setTileSize(camera.targetWidth,camera.targetHeight)}if(this.tileMapsList){tile=this.tileMapsList;var y=tile.getTileMovementTarget()[1]-tile.collisionBounds[1];this.listMapTiles(this.maps,y)}};SceneMapsList.prototype.listMapTiles=function(maps,y){var camera=this.camera;var columns=3;var sideSpacing=camera.targetWidth*.1;var tileSpacing=camera.targetWidth*.025;var tileWidth=(camera.targetWidth-tileSpacing*(columns-1)-sideSpacing*2)/columns;var tileHeight=tileWidth*.5;var hTileWidth=tileWidth*.5;var x=-(camera.targetWidth*.5)+sideSpacing+hTileWidth;y-=(tileHeight+tileSpacing)*.5;var columnIndex=0;for(i=0;i<maps.length;++i){var tile=maps[i].tile;tile.setTileSize(tileWidth,tileHeight);tile.setTextHeight(tileHeight*.25);tile.setPositionXYZ(x,y,0);x+=tileWidth+tileSpacing;columnIndex++;if(columnIndex>=columns){columnIndex=0;x=-(camera.targetWidth*.5)+sideSpacing+hTileWidth;y-=tileHeight+tileSpacing}}};SceneMapsList.prototype.updateControls=function(controls){var usingControls=this.CCSceneAppUI_updateControls(controls);var cameraTouches=this.camera.cameraTouches;var touch=cameraTouches[0];if(touch.x>0&&touch.x<1&&touch.y>0&&touch.y<1&&touch.startX>0&&touch.startX<1&&touch.startY>0&&touch.startY<1){if(controls.wheel&&controls.wheel.delta!==0){var delta=controls.wheel.delta;this.cameraScrolling=true;this.controlsMovingVertical=true;this.touchCameraMoving(0,delta*.1);return true}}return usingControls};SceneMapsList.prototype.touchPressed=function(touch){if(this.CCSceneAppUI_touchPressed(touch)){return true}return true};SceneMapsList.prototype.touchMovementAllowed=function(touch,touchDelta){var absDeltaX=Math.abs(touch.totalDeltaX);var absDeltaY=Math.abs(touch.totalDeltaY);if(absDeltaX>CCControls.TouchMovementThreashold.x||absDeltaY>CCControls.TouchMovementThreashold.y){this.controlsMoving=true;touchDelta.x+=touch.totalDeltaX;touchDelta.y+=touch.totalDeltaY;this.controlsMovingVertical=true;return true}return false};SceneMapsList.prototype.touchMoving=function(touch,touchDelta){return this.CCSceneAppUI_touchMoving(touch,touchDelta)};SceneMapsList.prototype.touchReleased=function(touch,touchAction){return this.CCSceneAppUI_touchReleased(touch,touchAction)};SceneMapsList.prototype.refreshCameraView=function(){this.sceneLeft=0;this.sceneRight=0;this.sceneTop=0;this.sceneBottom=0;var tiles=this.tiles;var tile=tiles.first();if(tile){this.sceneTop=tile.getTileMovementTarget()[1]+tile.collisionBounds[1];if(this.sceneTop<this.sceneBottom){this.sceneTop=this.sceneBottom}this.sceneTop+=tile.collisionSize.height;this.sceneTop-=this.camera.targetHeight*.5}tile=tiles.last();if(tile){this.sceneBottom=tile.getTileMovementTarget()[1]-tile.collisionBounds[1];if(this.sceneBottom>this.sceneTop){this.sceneBottom=this.sceneTop}}};SceneMapsList.prototype.lockCameraView=function(){if(this.cameraScrolling){return}var camera=this.camera;camera.flagUpdate();camera.targetLookAt[0]=0;if(camera.targetLookAt[1]>this.sceneTop){camera.targetLookAt[1]=this.sceneTop}else if(camera.targetLookAt[1]<this.sceneBottom){camera.targetLookAt[1]=this.sceneBottom}};SceneMapsList.prototype.syncUpdate=function(jsonData){var self=this;var maps,i,map,mapID,tileText;if(jsonData.mapListUpdated){map=jsonData.mapListUpdated;mapID=map.mapID;maps=this.maps;for(i=0;i<maps.length;++i){var mapItr=maps[i];if(mapID===mapItr.mapID){map.tile=mapItr.tile;maps[i]=map;break}}if(map.tile){tileText=map.name;tileText+="\n Players:";tileText+=map.players;tileText+=" Objects:";tileText+=map.objects;map.tile.setText(tileText)}}else if(jsonData.mapsList){var LoadMapFunction=function(mapID){return function(){self.close();new SceneManagerJoinMap(mapID,null,null,function(){new SceneMapsList})}};maps=this.maps;while(maps.length>0){map=maps[i];maps.remove(map);map.tile.deleteLater()}for(i=0;i<jsonData.mapsList.length;++i){maps.add(jsonData.mapsList[i])}maps.sort(function(a,b){if(b.players!==a.players){return b.players-a.players}return b.objects-a.objects});var tile;for(i=0;i<maps.length;++i){map=maps[i];mapID=map.mapID;var mapName=map.name;tileText=mapName;tileText+="\n Players:";tileText+=map.players;tileText+=" Objects:";tileText+=map.objects;tile=new CCTile3DButton(this);tile.setupText(tileText,1,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.set(.85,.9),true);tile.setTextColour(gColour.set(.125,1));tile.setDrawOrder(205);tile.onRelease.push(new LoadMapFunction(mapID));this.addTile(tile);map.tile=tile}this.requestResize();this.refreshCameraView()}};SceneMapsList.prototype.close=function(){if(this.open){this.open=false;if(this.sceneUIBack){this.sceneUIBack.close()}var self=this;this.tileBackground.setColourAlpha(0,true,function(){self.deleteLater()});var camera=this.camera;camera.targetLookAt[1]=camera.targetHeight;camera.flagUpdate()}};function PlayerTile(){this.userID=undefined;this.tileFlag=null;this.tileProfile=null;this.tileHealthIcon=null;this.tileHealthBar=null;this.tileFireIcon=null;this.tileFireCharge=[]}function SceneGameUI(sceneMap){this.construct();this.cameraCentered=true;{this.sceneMap=sceneMap;sceneMap.linkScene(this);this.linkScene(sceneMap)}{var parentCameraIndex=gEngine.findCameraIndex(sceneMap.camera);var camera=gEngine.newSceneCamera(this,parentCameraIndex+1);camera.setupViewport(0,0,1,1)}this.playerTiles=new Array(2);for(var i=0;i<this.playerTiles.length;++i){this.playerTiles[i]=new PlayerTile}gEngine.addScene(this)}ExtendPrototype(SceneGameUI,CCSceneAppUI);SceneGameUI.prototype.setup=function(){var self=this;var camera=this.camera;camera.setCameraWidth(640,false);camera.useSceneCollideables(this);var tile;var playerTiles=this.playerTiles;var LoadPlayerTileImages=function(playerTile){return function(){var height=playerTile.tileHealthIcon.collisionSize.height;playerTile.tileHealthBar.setupTexturedHeight(height,null,function(){self.requestResize()});for(i=0;i<playerTile.tileFireCharge.length;++i){playerTile.tileFireCharge[i].setupTexturedHeight(height,"ui_fire_charge.png",function(){self.requestResize()})}}};for(var playerIndex=0;playerIndex<playerTiles.length;++playerIndex){var playerTile=playerTiles[playerIndex];{{tile=new CCTile3DButton(this);tile.getTileScaleInterpolator().setDuration(.25);tile.shouldRender=false;tile.setDrawOrder(202);playerTile.tileHealthIcon=tile;if(playerIndex===1){tile.flipTileY()}}{tile=new TileOverlay(this);if(playerIndex===1){tile.flipTileY()}tile.shouldRender=false;playerTile.tileHealthBar=tile}{}}{{tile=new CCTile3DButton(this);tile.setupTexturedWidth(camera.cameraWidth*.05,"ui_fire_icon.png",function(){self.requestResize()});tile.getTileScaleInterpolator().setDuration(.25);tile.shouldRender=false;tile.setDrawOrder(203);playerTile.tileFireIcon=tile;if(playerIndex===1){tile.flipTileY()}}for(var i=0;i<5;++i){tile=new CCTile3DButton(this);tile.getTileScaleInterpolator().setDuration(.25);tile.shouldRender=false;playerTile.tileFireCharge.add(tile)}}{tile=new CCTile3DButton(this);tile.shouldRender=false;playerTile.tileFlag=tile}{tile=new TileSocialProfile(this,true);tile.setTileSize(camera.cameraWidth*.1);tile.shouldRender=false;playerTile.tileProfile=tile}playerTile.tileHealthIcon.setupTexturedWidth(camera.cameraWidth*.05,"ui_health_icon.png",new LoadPlayerTileImages(playerTile))}{tile=new CCTile3DButton(this);tile.setupTexturedWidth(camera.cameraWidth*.085,"ui_back.png",function(){self.requestResize()});tile.setDrawOrder(204);this.tileBack=tile;tile.onRelease.push(function(){self.backPressed()});this.addTile(tile,0)}{tile=new CCTile3DButton(this);this.tileNotification=tile}{var idealAspectRatio=1.5;var aspectRatioAdjutment=camera.getAspectRatio()<1.25?camera.getAspectRatio()/idealAspectRatio:1;tile=new CCTile3DButton(this);tile.setupText("",camera.targetHeight*.1*aspectRatioAdjutment,true,false);tile.setDrawOrder(204);tile.setTextColour(1);this.tileTimer=tile;this.time=0}this.requestResize()};SceneGameUI.prototype.render=function(camera,pass,alpha){};SceneGameUI.prototype.resize=function(){this.CCSceneAppUI_resize();var camera=this.camera;var tile,i;if(this.tileBack){tile=this.tileBack;tile.setPositionXYZ(camera.cameraHWidth-tile.collisionBounds[0],camera.cameraHHeight-tile.collisionBounds[1],0)}var playerTile,tileProfile,tileFlag,tileHealthIcon,tileHealthBar,tileFireIcon,tileFireCharge;{playerTile=this.playerTiles[0];tileProfile=playerTile.tileProfile;tileFlag=playerTile.tileFlag;tileHealthIcon=playerTile.tileHealthIcon;tileHealthBar=playerTile.tileHealthBar;tileFireIcon=playerTile.tileFireIcon;tileFireCharge=playerTile.tileFireCharge;if(tileProfile&&tileFlag&&tileHealthIcon&&tileHealthBar&&tileFireIcon&&tileFireCharge.length>0){tile=tileProfile;tile.setPositionXYZ(-camera.cameraHWidth+tile.collisionBounds[0],-camera.cameraHHeight+tile.collisionBounds[1],0);tileFlag.positionTileAbove(tile);tileFireIcon.positionTileRight(tile);tileFireIcon.setPositionY(-camera.cameraHHeight+tileFireIcon.collisionBounds[1]);for(i=0;i<tileFireCharge.length;++i){if(i===0){tileFireCharge[i].positionTileRight(tileFireIcon)}else{tileFireCharge[i].positionTileRight(tileFireCharge[i-1])}}tileHealthIcon.positionTileAbove(tileFireIcon);tileHealthBar.positionTileRight(tileHealthIcon)}}{playerTile=this.playerTiles[1];tileProfile=playerTile.tileProfile;tileFlag=playerTile.tileFlag;tileHealthIcon=playerTile.tileHealthIcon;tileHealthBar=playerTile.tileHealthBar;tileFireIcon=playerTile.tileFireIcon;tileFireCharge=playerTile.tileFireCharge;if(tileProfile&&tileFlag&&tileHealthIcon&&tileHealthBar&&tileFireIcon&&tileFireCharge.length>0){tile=tileProfile;tile.setPositionXYZ(camera.cameraHWidth-tile.collisionBounds[0],-camera.cameraHHeight+tile.collisionBounds[1],0);tileFlag.positionTileAbove(tile);tileFireIcon.positionTileLeft(tile);tileFireIcon.setPositionY(-camera.cameraHHeight+tileFireIcon.collisionBounds[1]);for(i=0;i<tileFireCharge.length;++i){if(i===0){tileFireCharge[i].positionTileLeft(tileFireIcon)}else{tileFireCharge[i].positionTileLeft(tileFireCharge[i-1])}}tileHealthIcon.positionTileAbove(tileFireIcon);tileHealthBar.positionTileLeft(tileHealthIcon)}}};SceneGameUI.prototype.touchPressed=function(touch){return this.CCSceneAppUI_touchPressed(touch)};SceneGameUI.prototype.touchMoving=function(touch,touchDelta){return false};SceneGameUI.prototype.touchReleased=function(touch,touchAction){return this.CCSceneAppUI_touchReleased(touch,touchAction)};SceneGameUI.prototype.getProfilePlayerID=function(index){var playerTile=this.playerTiles[index];return playerTile.playerID};SceneGameUI.prototype.setProfile=function(index,playerID,userID){var playerTile=this.playerTiles[index];playerTile.playerID=playerID;playerTile.userID=userID;var tileProfile=playerTile.tileProfile;var tileFlag=playerTile.tileFlag;var tileHealthIcon=playerTile.tileHealthIcon;var tileHealthBar=playerTile.tileHealthBar;tileProfile.shouldRender=true;tileHealthIcon.shouldRender=true;tileHealthBar.shouldRender=true;playerTile.tileFireIcon.shouldRender=true;if(sceneManagerGame){var userInfo=sceneManagerGame.getConstUserIDData(userID);if(userInfo){if(userInfo.facebook&&userInfo.facebook.facebookID.length>0){tileProfile.setFacebookID(userInfo.facebook.facebookID);tileProfile.bufferFBProfilePhoto(2)}else if(userInfo.twitter&&userInfo.twitter.username){tileProfile.setTwitterID(userInfo.twitter.username);tileProfile.bufferTwitterProfilePhoto(2)}else if(userInfo.google&&userInfo.google.id){tileProfile.setGoogleID(userInfo.google.id);tileProfile.bufferGoogleProfilePhoto(2)}var self=this;MultiplayerManager.LoadCountry(tileFlag,userInfo.countryCode,function(tile,textureHandle){var scale=tile.collisionSize.width/tile.collisionSize.height;var camera=self.camera;tileFlag.setTileSize(camera.targetWidth*.1,camera.targetWidth*.1/scale);self.requestResize()})}else if(userID===MultiplayerManager.UserID){tileProfile.setFacebookID();tileProfile.setTwitterID();tileProfile.bufferInfo(2)}}this.requestResize()};SceneGameUI.prototype.removeProfile=function(index){var playerTile=this.playerTiles[index];var tileProfile=playerTile.tileProfile;var tileFlag=playerTile.tileFlag;var tileHealthIcon=playerTile.tileHealthIcon;var tileHealthBar=playerTile.tileHealthBar;tileProfile.shouldRender=false;tileFlag.shouldRender=false;tileHealthIcon.shouldRender=false;tileHealthBar.shouldRender=false;playerTile.tileFireIcon.shouldRender=false;for(var i=0;i<playerTile.tileFireCharge.length;++i){playerTile.tileFireCharge[i].shouldRender=false}};SceneGameUI.prototype.setHealth=function(index,alpha){var playerTile=this.playerTiles[index];var tileHealthIcon=playerTile.tileHealthIcon;var tileHealthBar=playerTile.tileHealthBar;if(alpha>=0){alpha=CC.FloatClamp(alpha,0,1);tileHealthBar.setAmount(alpha)}if(!tileHealthIcon.getTileScaleInterpolator().updating){tileHealthIcon.setTileScale(1.5,true,function(){tileHealthIcon.setTileScale(1,true)})}};SceneGameUI.prototype.setFire=function(index){var playerTile=this.playerTiles[index];var tile=playerTile.tileFireIcon;if(!tile.getTileScaleInterpolator().updating){tile.setTileScale(1.5,true,function(){tile.setTileScale(1,true)})}};SceneGameUI.prototype.setAmmo=function(index,ammo){var playerTile=this.playerTiles[index];if(ammo>=0){var tile,bulletIndex;for(bulletIndex=0;bulletIndex<playerTile.tileFireCharge.length;++bulletIndex){tile=playerTile.tileFireCharge[bulletIndex];tile.shouldRender=false}ammo=CC.FloatClamp(ammo,0,1);ammo*=5;bulletIndex=0;while(ammo>0){tile=playerTile.tileFireCharge[bulletIndex++];tile.shouldRender=true;if(ammo<1){tile.setColourAlpha(ammo)}else{tile.setColourAlpha(1)}ammo-=1}}};SceneGameUI.prototype.fight=function(){var camera=this.camera;var tile=this.tileNotification;tile.setupTexturedWidth(camera.cameraWidth*.2,"ui_fight.png");tile.setColourAlpha(0);tile.setTileScale(0);tile.setTileScale(2,true);tile.getColourInterpolator().setDuration(.25);tile.setColourAlpha(1,true,function(){tile.getColourInterpolator().setDuration(2);tile.setColourAlpha(0,true)})};SceneGameUI.prototype.win=function(){var camera=this.camera;var tile=this.tileNotification;tile.setupTexturedWidth(camera.cameraWidth*.2,"ui_win.png");tile.setColourAlpha(0);tile.setTileScale(0);tile.setTileScale(2,true);tile.getColourInterpolator().setDuration(.25);tile.setColourAlpha(1,true,function(){tile.getColourInterpolator().setDuration(5);tile.setColourAlpha(0,true)})};SceneGameUI.prototype.lose=function(){var camera=this.camera;var tile=this.tileNotification;tile.setupTexturedWidth(camera.cameraWidth*.2,"ui_lose.png");tile.setColourAlpha(0);tile.setTileScale(0);tile.setTileScale(2,true);tile.getColourInterpolator().setDuration(.25);tile.setColourAlpha(1,true,function(){tile.getColourInterpolator().setDuration(5);tile.setColourAlpha(0,true)})};SceneGameUI.prototype.setTime=function(time){var intTime=Math.round(time+.5);if(intTime!==this.time){var tile=this.tileTimer;var value=""+intTime+" ";tile.setText(value,true);if(this.tileBack){tile.positionTileLeft(this.tileBack)}else{var camera=this.camera;tile.setPositionXYZ(camera.cameraHWidth-tile.collisionBounds[0],camera.cameraHHeight-tile.collisionBounds[1],0)}this.time=intTime}};SceneGameUI.prototype.backPressed=function(){if(this.sceneMap){this.sceneMap.handleBackButton()}};function SceneGameBattleRoyale(mapID){this.construct(mapID)}ExtendPrototype(SceneGameBattleRoyale,SceneGameSyndicate);SceneGameBattleRoyale.prototype.construct=function(mapID){this.SceneGameSyndicate_construct(mapID,"BattleRoyale")};SceneGameBattleRoyale.prototype.destruct=function(){this.SceneGameSyndicate_destruct()};SceneGameBattleRoyale.prototype.deleteLater=function(){this.SceneGameSyndicate_deleteLater()};SceneGameBattleRoyale.prototype.setup=function(){this.SceneGameSyndicate_setup();this.camera.targetOffset[2]=200};SceneGameBattleRoyale.prototype.updateScene=function(delta){return this.SceneGameSyndicate_updateScene(delta)};SceneGameBattleRoyale.prototype.updateCameraLookAt=function(delta){var camera=this.camera;var playerCharacter=this.playerCharacter;if(playerCharacter&&(camera.targetLookAt[0]!==playerCharacter.position[0]||camera.targetLookAt[2]!==playerCharacter.position[2])){camera.targetLookAt[0]=playerCharacter.position[0];camera.targetLookAt[2]=playerCharacter.position[2];camera.flagUpdate()}};SceneGameBattleRoyale.prototype.assignPlayerCharacter=function(character){if(this.sceneUI.setProfile){this.sceneUI.setProfile(0,character.getPlayerID(),character.getUserID())}this.SceneGameSyndicate_assignPlayerCharacter(character)};SceneGameBattleRoyale.prototype.registerDamage=function(from,to,damage){var healthRatio;var playerCharacter=this.playerCharacter;if(to===playerCharacter){healthRatio=playerCharacter.controller.getHealthRatio();this.updateHealthUI(to,healthRatio);var attackerCharacter=this.getEnemy(from);if(attackerCharacter){if(this.sceneUI.setProfile){this.sceneUI.setProfile(1,attackerCharacter.getPlayerID(),attackerCharacter.getUserID())}this.registerAmmoUpdate(attackerCharacter);if(!attackerCharacter.controller.isAI()){MultiplayerManager.SyncRegisterDamage(playerCharacter.getPlayerID(),attackerCharacter.getPlayerID(),damage)}}}else if(from===playerCharacter){var attackedCharacter=this.getEnemy(to);if(attackedCharacter){if(this.sceneUI.setProfile){this.sceneUI.setProfile(1,attackedCharacter.getPlayerID(),attackedCharacter.getUserID())}this.registerAmmoUpdate(attackedCharacter);if(!attackedCharacter.controller.isAI()){if(this.sceneUI.setHealth){this.sceneUI.setHealth(1)}}else{MultiplayerManager.SyncRegisterDamage("ai",playerCharacter.getPlayerID(),damage);healthRatio=attackedCharacter.controller.getHealthRatio();this.updateHealthUI(attackedCharacter,healthRatio);if(healthRatio<=0){if(this.sceneUI.removeProfile){this.sceneUI.removeProfile(1)}this.removeEnemy(attackedCharacter)}}}}};function SceneGame1vs1(mapID){this.construct(mapID,"1vs1")}ExtendPrototype(SceneGame1vs1,SceneGameSyndicate);SceneGame1vs1.GameState_Loading=0;SceneGame1vs1.GameState_Intro=1;SceneGame1vs1.GameState_Playing=2;SceneGame1vs1.GameState_Win=3;SceneGame1vs1.GameState_Lose=4;SceneGame1vs1.prototype.construct=function(mapID,mapType){this.SceneGameSyndicate_construct(mapID,mapType);this.setGameState(SceneGame1vs1.GameState_Loading);this.playTime=60};SceneGame1vs1.prototype.destruct=function(){this.SceneGameSyndicate_destruct()};SceneGame1vs1.prototype.deleteLater=function(){this.SceneGameSyndicate_deleteLater()};SceneGame1vs1.prototype.setup=function(){this.SceneGameSyndicate_setup()};SceneGame1vs1.prototype.updateScene=function(delta){this.gameStateTime+=delta;this.updateGameState(delta);return this.SceneGameSyndicate_updateScene(delta)};SceneGame1vs1.prototype.updateCameraLookAt=function(delta){var camera=this.camera;var enemies=this.enemies;var enemy=enemies.first();var playerCharacter=this.playerCharacter;var distance,offset;if(this.gameState===SceneGame1vs1.GameState_Intro){if(this.gameStateTime<1){vec3.copy(camera.targetLookAt,[0,0,0]);distance=CC.Vector3Distance2D(playerCharacter.position,enemy.position,false);offset=camera.calcCameraOffsetForWidth(distance*2);camera.targetOffset[2]=offset;camera.flagUpdate();camera.interpolateCamera(CC_MAXFLOAT,CC_MAXFLOAT)}else if(this.gameStateTime<3){if(enemy){if(sceneManagerGame){sceneManagerGame.showPlayer2(enemy)}vec3.copy(camera.targetLookAt,enemy.position)}camera.flagUpdate();camera.targetOffset[2]=60;camera.interpolateCamera(CC_MAXFLOAT,CC_MAXFLOAT);camera.incrementRotationY(delta*90)}else if(this.gameStateTime<5){if(sceneManagerGame){sceneManagerGame.showPlayer1(playerCharacter)}vec3.copy(camera.targetLookAt,playerCharacter.position);camera.flagUpdate();camera.interpolateCamera(CC_MAXFLOAT,CC_MAXFLOAT);camera.incrementRotationY(delta*90)}else{if(sceneManagerGame){sceneManagerGame.hideSplashScreen()}vec3.copy(camera.targetLookAt,[0,0,0]);distance=CC.Vector3Distance2D(playerCharacter.position,enemy.position,false);offset=camera.calcCameraOffsetForWidth(distance*2);camera.targetOffset[2]=offset;camera.flagUpdate();camera.interpolateCamera(CC_MAXFLOAT,CC_MAXFLOAT);camera.setRotationY(0)}}else if(this.gameState===SceneGame1vs1.GameState_Playing){if(playerCharacter){if(enemies.length>0){distance=CC.Vector3Distance2D(playerCharacter.position,enemy.position,false);var hDistance=distance*.5;var direction=CC.Vector3Direction(playerCharacter.position,enemy.position);vec3.scale(direction,direction,hDistance);vec3.copy(camera.targetLookAt,playerCharacter.position);vec3.add(camera.targetLookAt,camera.targetLookAt,direction);camera.flagUpdate();camera.targetOffset[2]=camera.calcCameraOffsetForWidth(distance*1.75);camera.targetOffset[2]=CC.FloatClamp(camera.targetOffset[2],100,300)}else{if(camera.targetLookAt[0]!==playerCharacter.position[0]||camera.targetLookAt[2]!==playerCharacter.position[2]){camera.targetLookAt[0]=playerCharacter.position[0];camera.targetLookAt[2]=playerCharacter.position[2];camera.flagUpdate()}if(camera.targetOffset[2]!==120){camera.targetOffset[2]=120}}}}};SceneGame1vs1.prototype.touchReleased=function(touch,touchAction){if(this.gameState!==SceneGame1vs1.GameState_Playing){return false}return this.SceneGameSyndicate_touchReleased(touch,touchAction)};SceneGame1vs1.prototype.syncAddPlayer=function(playerID,userID,playerType,location,health,jsonData){this.SceneGameMap_syncAddPlayer(playerID,userID,playerType,location,health);if(this.getNumberOfPlayers()>=2){this.startIntro();var timer=jsonData.timer;this.setTimer(timer)}};SceneGame1vs1.prototype.assignPlayerCharacter=function(character){this.sceneUI.setProfile(0,character.getPlayerID(),character.getUserID());this.SceneGameSyndicate_assignPlayerCharacter(character)};SceneGame1vs1.prototype.addEnemy=function(character){this.sceneUI.setProfile(1,character.getPlayerID(),character.getUserID());this.SceneGameSyndicate_addEnemy(character)};SceneGame1vs1.prototype.registerDamage=function(from,to,damage){if(this.gameState===SceneGame1vs1.GameState_Playing){var playerCharacter=this.playerCharacter;var enemy,healthRatio;if(this.isOnlineGame()){if(to===playerCharacter){healthRatio=playerCharacter.controller.getHealthRatio();this.sceneUI.setHealth(0,healthRatio);var attackerCharacter=this.getEnemy(from);if(attackerCharacter){MultiplayerManager.SyncRegisterDamage(playerCharacter.getPlayerID(),attackerCharacter.getPlayerID(),damage)}}else{enemy=this.getEnemy(to);if(enemy){this.sceneUI.setHealth(1)}}}else{enemy=this.getEnemy(to);if(enemy){MultiplayerManager.SyncRegisterDamage("ai",playerCharacter.getPlayerID(),damage);healthRatio=enemy.controller.getHealthRatio();this.sceneUI.setHealth(1,healthRatio);if(healthRatio<=0){if(sceneManagerGame){sceneManagerGame.matchResult(true)}}}}}};SceneGame1vs1.prototype.gameStarted=function(){return this.gameState===SceneGame1vs1.GameState_Playing};SceneGame1vs1.prototype.startIntro=function(){if(this.gameState!==SceneGame1vs1.GameState_Intro){this.setGameState(SceneGame1vs1.GameState_Intro)}};SceneGame1vs1.prototype.startPlaying=function(){if(this.gameState!==SceneGame1vs1.GameState_Playing){this.setGameState(SceneGame1vs1.GameState_Playing)
}};SceneGame1vs1.prototype.startWinning=function(){if(this.gameState!==SceneGame1vs1.GameState_Win){this.setGameState(SceneGame1vs1.GameState_Win);this.sceneUI.win()}};SceneGame1vs1.prototype.startLosing=function(){if(this.gameState!==SceneGame1vs1.GameState_Lose){this.setGameState(SceneGame1vs1.GameState_Lose);this.sceneUI.lose()}};SceneGame1vs1.prototype.updateGameState=function(timeDelta){if(this.gameState<SceneGame1vs1.GameState_Win){if(this.playTime>0){this.playTime-=timeDelta;this.sceneUI.setTime(this.playTime)}}var camera=this.camera;var enemies=this.enemies;var enemy=enemies.first();var playerCharacter=this.playerCharacter;var location;if(this.gameState===SceneGame1vs1.GameState_Intro){if(this.gameStateTime>5){if(this.gameStateTime<7){if(this.gameStateFlag===0){this.gameStateFlag=1;{location=vec3.clone(playerCharacter.position);if(location[0]<0){location[0]+=CC_SMALLFLOAT}else{location[0]-=CC_SMALLFLOAT}location[2]+=CC_SMALLFLOAT;location[1]=0;playerCharacter.controller.goToScan(location)}if(enemy){location=vec3.clone(enemy.position);if(location[0]<0){location[0]+=CC_SMALLFLOAT}else{location[0]-=CC_SMALLFLOAT}location[2]+=CC_SMALLFLOAT;location[1]=0;enemy.controller.goToScan(location)}}else{{location=vec3.clone(playerCharacter.position);location[2]+=CC_SMALLFLOAT;location[1]=0;playerCharacter.controller.shoot(location);playerCharacter.rechargeWeapon()}if(enemy){location=vec3.clone(enemy.position);location[1]=0;location[2]+=CC_SMALLFLOAT;enemy.controller.shoot(location);enemy.rechargeWeapon()}}}else{this.sceneUI.fight();this.startPlaying();var players=this.players;for(var i=0;i<players.length;++i){var player=players[i];player.controller.enable(true);player.rechargeWeapon()}}}}else if(this.gameState===SceneGame1vs1.GameState_Playing){}else if(this.gameState===SceneGame1vs1.GameState_Win){camera.incrementRotationY(timeDelta*90);camera.flagUpdate();camera.targetOffset[2]=60;this.playerShootAt(enemy,false);if(this.gameStateTime<2){if(playerCharacter){vec3.copy(camera.targetLookAt,playerCharacter.position)}}else if(this.gameStateTime<3.5){if(enemy){vec3.copy(camera.targetLookAt,enemy.position)}}else if(this.gameStateTime<5){if(playerCharacter){vec3.copy(camera.targetLookAt,playerCharacter.position)}}else{if(sceneManagerGame){sceneManagerGame.matchEnd()}}}else if(this.gameState===SceneGame1vs1.GameState_Lose){camera.incrementRotationY(timeDelta*90);camera.flagUpdate();camera.targetOffset[2]=60;if(enemy){enemy.controller.shootAt(playerCharacter)}if(this.gameStateTime<2){if(playerCharacter){vec3.copy(camera.targetLookAt,playerCharacter.position)}}else if(this.gameStateTime<3.5){if(enemy){vec3.copy(camera.targetLookAt,enemy.position)}}else if(this.gameStateTime<5){if(playerCharacter){vec3.copy(camera.targetLookAt,playerCharacter.position)}}else{if(sceneManagerGame){sceneManagerGame.matchEnd()}}}};SceneGame1vs1.prototype.setTimer=function(time){this.playTime=time;this.sceneUI.setTime(this.playTime)};SceneGame1vs1.prototype.setGameState=function(state){this.gameState=state;this.gameStateTime=0;this.gameStateFlag=0};function SceneGameSideScroller(mapID){this.construct(mapID)}ExtendPrototype(SceneGameSideScroller,SceneGameBattleRoyale);SceneGameSideScroller.prototype.setup=function(){this.SceneGameBattleRoyale_setup();this.camera.targetOffset[2]=65;this.camera.setRotationX(-5)};SceneGameSideScroller.prototype.assignPlayerCharacter=function(character){this.sceneUI.setProfile(0,character.getPlayerID(),character.getUserID());this.SceneGameSyndicate_assignPlayerCharacter(character)};function SceneBackground(){this.construct()}ExtendPrototype(SceneBackground,CCSceneAppUI);SceneBackground.SceneWidth=960;SceneBackground.BackgroundImage="phonewars_background.jpg";SceneBackground.prototype.construct=function(){this.CCSceneAppUI_construct()};SceneBackground.prototype.setup=function(){this.CCSceneAppUI_setup();var camera=this.camera;camera.setCameraWidth(SceneBackground.SceneWidth);camera.useSceneCollideables(this);{var tile=new CCTile3DButton(this);tile.setTouchDepressDepth(0);tile.setColourAlpha(0);tile.setTileSize(camera.targetWidth,camera.targetHeight);tile.onRelease.push(function(){sceneManagerGame.backgroundTilePressed()});this.addTile(tile);this.tileBackground=tile;this.refreshBackgroundImage()}this.refreshCameraView();this.lockCameraView()};SceneBackground.prototype.render=function(camera,pass,alpha){};SceneBackground.prototype.resize=function(){this.CCSceneAppUI_resize();var camera=this.camera;if(this.tileBackground.getTileTextureImage()){this.tileBackground.setTileTexturedFit(camera.targetWidth,camera.targetHeight,true)}};SceneBackground.prototype.touchPressed=function(touch){return this.CCSceneAppUI_touchPressed(touch)};SceneBackground.prototype.touchMoving=function(touch,touchDelta){return false};SceneBackground.prototype.touchReleased=function(touch,touchAction){return this.CCSceneAppUI_touchReleased(touch,touchAction)};SceneBackground.prototype.show=function(){this.enabled=true;this.camera.enabled=true;this.showing=true;var tile=this.tileBackground;if(tile.getTileTextureImage()){tile.setColourAlpha(1,true)}tile.setCollideable(true)};SceneBackground.prototype.hide=function(){var self=this;this.showing=false;var tile=this.tileBackground;tile.setColourAlpha(0,true,function(){self.enabled=false;self.camera.enabled=false});tile.setCollideable(false)};SceneBackground.prototype.refreshBackgroundImage=function(){if(this.tileBackground){var self=this;var tile=this.tileBackground;tile.setColourAlpha(0,true);tile.setupTextured(SceneBackground.BackgroundImage,function(tile,textureHandle){if(self.showing){tile.setColourAlpha(1,true)}if(textureHandle){self.requestResize()}})}};function UserData(){this.userID=undefined;this.countryCode=undefined;this.country=undefined;this.facebook=undefined;this.twitter=undefined;this.google=undefined;this.wins=0;this.losses=0;this.won=undefined;this.lost=undefined;this.textRank=undefined;this.imageFlag=undefined;this.tileProfile=undefined;this.textName=undefined;this.imagePlatform=undefined;this.textWinRatio=undefined}function SceneLeaderboards(){this.construct()}ExtendPrototype(SceneLeaderboards,CCSceneAppUI);SceneLeaderboards.Leaderboard_Daily=0;SceneLeaderboards.Leaderboard_Weekly=1;SceneLeaderboards.Leaderboard_AllTime=2;SceneLeaderboards.Leaderboard_MaxTypes=3;SceneLeaderboards.prototype.construct=function(){this.CCSceneAppUI_construct();this.cameraCentered=true;this.controlsSwipeMomentum=true;{var camera=gEngine.newSceneCamera(this);camera.setupViewport(0,.075,1,.85)}this.currentLeaderboardType=SceneLeaderboards.Leaderboard_Daily;this.leaderboardsData=[];for(var i=0;i<SceneLeaderboards.Leaderboard_MaxTypes;++i){this.leaderboardsData.push([])}this.tileLeaderboardDaily=undefined;this.tileLeaderboardWeekly=undefined;this.tileLeaderboardAllTime=undefined;this.uiTiles=[];this.dirtyLeaderboards()};SceneLeaderboards.prototype.destruct=function(){for(var i=0;i<SceneLeaderboards.Leaderboard_MaxTypes;++i){this.leaderboardsData[i].length=0}this.CCSceneAppUI_destruct()};SceneLeaderboards.prototype.setup=function(){var self=this;var camera=this.camera;camera.setCameraWidth(300);camera.useSceneCollideables(this);var uiTiles=this.uiTiles;var tile;var tileWidth=camera.targetWidth*.3;{tile=new CCTile3DButton(this);tile.setupTexturedWidth(tileWidth,"ui_leaderboards_daily.png");tile.onRelease.push(function(){self.switchLeaderboard(SceneLeaderboards.Leaderboard_Daily)});this.addTile(tile,0);this.tileLeaderboardDaily=tile;this.uiTiles.add(tile)}{tile=new CCTile3DButton(this);tile.setupTexturedWidth(tileWidth,"ui_leaderboards_weekly.png");tile.onRelease.push(function(){self.switchLeaderboard(SceneLeaderboards.Leaderboard_Weekly)});this.addTile(tile,0);this.tileLeaderboardWeekly=tile;this.uiTiles.add(tile)}{tile=new CCTile3DButton(this);tile.setupTexturedWidth(tileWidth,"ui_leaderboards_alltime.png");tile.onRelease.push(function(){self.switchLeaderboard(SceneLeaderboards.Leaderboard_AllTime)});this.addTile(tile,0);this.tileLeaderboardAllTime=tile;this.uiTiles.add(tile)}for(var i=0;i<uiTiles.length;++i){tile=uiTiles[i];tile.setDrawOrder(205);tile.setColourAlpha(0);tile.setCollideable(false)}this.lockCameraView();this.refreshCameraView();this.hide()};SceneLeaderboards.prototype.resize=function(){this.CCSceneAppUI_resize();if(this.controlsEnabled){this.hide();this.show()}};SceneLeaderboards.prototype.render=function(camera,pass,alpha){};SceneLeaderboards.prototype.updateControls=function(controls){var usingControls=this.CCSceneAppUI_updateControls(controls);var cameraTouches=this.camera.cameraTouches;var touch=cameraTouches[0];if(touch.x>0&&touch.x<1&&touch.y>0&&touch.y<1&&touch.startX>0&&touch.startX<1&&touch.startY>0&&touch.startY<1){if(controls.wheel&&controls.wheel.delta!==0){var delta=controls.wheel.delta;this.cameraScrolling=true;this.controlsMovingVertical=true;this.touchCameraMoving(0,delta*.1);return true}}return usingControls};SceneLeaderboards.prototype.touchPressed=function(touch){return this.CCSceneAppUI_touchPressed(touch)};SceneLeaderboards.prototype.touchMovementAllowed=function(touch,touchDelta){var absDeltaY=Math.abs(touch.totalDeltaY);if(absDeltaY>CCControls.TouchMovementThreashold.y){this.controlsMoving=true;touchDelta.x+=touch.totalDeltaX;touchDelta.y+=touch.totalDeltaY;this.controlsMovingVertical=true;return true}return false};SceneLeaderboards.prototype.touchMoving=function(touch,touchDelta){return this.CCSceneAppUI_touchMoving(touch,touchDelta)};SceneLeaderboards.prototype.touchReleased=function(touch,touchAction){return this.CCSceneAppUI_touchReleased(touch,touchAction)};SceneLeaderboards.prototype.refreshCameraView=function(){this.sceneLeft=0;this.sceneRight=0;this.sceneTop=0;this.sceneBottom=0;var leaderboard=this.leaderboardsData[this.currentLeaderboardType];if(leaderboard.length>0){var bottomTile=null;for(var i=leaderboard.length-1;i>=0;--i){if(leaderboard[i].tileProfile){bottomTile=leaderboard[i].tileProfile;break}}if(bottomTile){this.sceneBottom=bottomTile.getTileMovementTarget()[1]-bottomTile.collisionBounds[1];if(this.sceneBottom>this.sceneTop){this.sceneBottom=this.sceneTop}}}};SceneLeaderboards.prototype.lockCameraView=function(){if(this.cameraScrolling){return}var camera=this.camera;camera.flagUpdate();camera.targetLookAt[0]=0;if(camera.targetLookAt[1]>this.sceneTop){camera.targetLookAt[1]=this.sceneTop}else if(camera.targetLookAt[1]<this.sceneBottom){camera.targetLookAt[1]=this.sceneBottom}};SceneLeaderboards.prototype.show=function(){this.controlsEnabled=true;var self=this;var camera=this.camera;this.enabled=true;camera.enabled=true;var uiTiles=this.uiTiles;var green=gColour.setRGBA(0,.75,0,1);var red=gColour.setRGBA(.75,0,0,1);var leaderboard=this.leaderboardsData[this.currentLeaderboardType];if(leaderboard.length===0||leaderboard.dirty){this.requestLeaderboard();return}var tile,i,text,x;{var totalWidth=0;for(i=0;i<uiTiles.length;++i){tile=uiTiles[i];tile.setColourAlpha(.5,true);tile.setCollideable(true);totalWidth+=tile.collisionSize.width}var difference=camera.targetWidth-totalWidth;x=difference*.5-camera.targetWidth*.5;for(i=0;i<uiTiles.length;++i){tile=uiTiles[i];x+=tile.collisionBounds[0];tile.setPositionX(x);tile.setTileMovementY(tile.collisionSize.height);x+=tile.collisionBounds[0]}if(this.currentLeaderboardType===SceneLeaderboards.Leaderboard_Daily){this.tileLeaderboardDaily.setColourAlpha(1,true)}else if(this.currentLeaderboardType===SceneLeaderboards.Leaderboard_Weekly){this.tileLeaderboardWeekly.setColourAlpha(1,true)}else if(this.currentLeaderboardType===SceneLeaderboards.Leaderboard_AllTime){this.tileLeaderboardAllTime.setColourAlpha(1,true)}}var userID=MultiplayerManager.UserID;var idealAspectRatio=1.5;var aspectRatioAdjutment=camera.getAspectRatio()<1.25?camera.getAspectRatio()/idealAspectRatio:1;var textHeight=camera.targetHeight*.06*aspectRatioAdjutment;var flagHeight=camera.targetHeight*.075*aspectRatioAdjutment;var platformHeight=camera.targetHeight*.1*aspectRatioAdjutment;var profileHeight=camera.targetHeight*.075*aspectRatioAdjutment;var OnLoadedImage=function(imageModel,url,height){return function(textureHandle){if(textureHandle){var primitiveSquare=imageModel.primitives[0];primitiveSquare.setTexture(url);var aspectRatio=textureHandle.image.width/textureHandle.image.height;var width=height*aspectRatio;primitiveSquare.setScale(width,height,1)}}};x=-camera.cameraHWidth*.4;var y=-camera.cameraHeight;var z=0;var previousEntryIndex=-1;var leaderboardLength=leaderboard.length;for(i=0;i<leaderboardLength;++i){var userData=leaderboard[i];if(!userData.tileProfile){continue}var textRank=userData.textRank;var imageFlag=userData.imageFlag;var tileProfile=userData.tileProfile;var textName=userData.textName;var imagePlatform=userData.imagePlatform;var textWinRatio=userData.textWinRatio;var url;{this.tiles.addOnce(tileProfile);tileProfile.shouldRender=true;tileProfile.setCollideable(true);textRank.setHeight(textHeight);textName.setHeight(textHeight);textWinRatio.setHeight(textHeight);tileProfile.setTileSize(profileHeight);if(userData.deviceType){var allowed=true;if(CCEngine.DeviceType==="iOS"){if(userData.deviceType!==CCEngine.DeviceType){allowed=false}}if(allowed){url="icon_platform_";if(userData.deviceType.contains("Windows")){url+="windows"}else{url+=userData.deviceType}url+=".png";url=url.toLowerCase();gEngine.textureManager.getTextureHandle(url,new OnLoadedImage(imagePlatform,url,platformHeight))}}tileProfile.setPositionXYZ(x,y,z);textRank.setPositionX(-camera.cameraHWidth*.8+-x);imageFlag.setPositionX(-camera.cameraHWidth*.6+-x);textName.setPositionX(camera.cameraHWidth*.1+-x);imagePlatform.setPositionX(camera.cameraHWidth*.55+-x);textWinRatio.setPositionX(camera.cameraHWidth*.75+-x)}var isUser=userID===userData.userID;{if(userData.won){tileProfile.setTextColour(green,true)}else if(userData.lost){tileProfile.setTextColour(red,true)}if(isUser){tileProfile.setTextBlinking(true)}{var rank=i+1;text="";text+=rank;if(rank>10&&rank<20){text+="th"}else{rank=rank%10;if(rank===1){text+="st"}else if(rank===2){text+="nd"}else if(rank===3){text+="rd"}else if(rank<=20){text+="th"}}if(rank>25){text=""}textRank.setText(text)}if(userData.countryCode){var geoLocationCountryCode=userData.countryCode;if(geoLocationCountryCode.length===2){geoLocationCountryCode=geoLocationCountryCode.toLowerCase();url="flag_";url+=geoLocationCountryCode;url+=".png";gEngine.textureManager.getTextureHandle(url,new OnLoadedImage(imageFlag,url,flagHeight))}}{text="";if(userData.facebook&&userData.facebook.name&&userData.facebook.name.length>0){text=userData.facebook.name}else{text="Guest ";userID=userID.strip(".");text+=userID}if(text.length>17){text=text.substring(0,17)}textName.setText(text)}{text="";text+=userData.wins;text+="/";text+=userData.losses;textWinRatio.setText(text)}}{if(previousEntryIndex===-1){tileProfile.setTileMovementYZ(0,0)}else{var previousUserData=leaderboard[previousEntryIndex];var target=previousUserData.tileProfile.getTileMovementTarget();target[1]-=previousUserData.tileProfile.collisionBounds[1];target[1]-=tileProfile.collisionBounds[1]*2;if(target[1]>-camera.cameraHHeight){tileProfile.setTileMovement(target)}else{tileProfile.setPosition(target)}}previousEntryIndex=i}}this.refreshCameraView()};SceneLeaderboards.prototype.hide=function(){var self=this;this.controlsEnabled=false;var i;var uiTiles=this.uiTiles;for(i=0;i<uiTiles.length;++i){var tile=uiTiles[i];tile.setColourAlpha(0,true);tile.setCollideable(false)}var camera=this.camera;camera.targetLookAt[1]=this.sceneTop;uiTiles[0].setColourAlpha(0,true,function(){self.enabled=false;camera.enabled=false});var leaderboard=this.leaderboardsData[this.currentLeaderboardType];var leaderboardLength=leaderboard.length;for(i=0;i<leaderboardLength;++i){var userData=leaderboard[i];if(userData.tileProfile.shouldRender){this.tiles.remove(userData.tileProfile);userData.tileProfile.shouldRender=false;userData.tileProfile.setCollideable(false)}}this.refreshCameraView();this.lockCameraView()};SceneLeaderboards.prototype.switchLeaderboard=function(leaderboardType){if(leaderboardType!==this.currentLeaderboardType){this.hide();this.currentLeaderboardType=leaderboardType;this.show()}};SceneLeaderboards.prototype.dirtyLeaderboards=function(){for(var i=0;i<SceneLeaderboards.Leaderboard_MaxTypes;++i){this.leaderboardsData[i].dirty=true}};SceneLeaderboards.prototype.requestLeaderboard=function(){if(MultiplayerManager.LoggedIn){var leaderboard=this.leaderboardsData[this.currentLeaderboardType];leaderboard.dirty=false;var type="all";if(this.currentLeaderboardType===SceneLeaderboards.Leaderboard_Daily){type="daily"}else if(this.currentLeaderboardType===SceneLeaderboards.Leaderboard_Weekly){type="weekly"}if(BurgersClient){BurgersClient.getLeaderboards(type)}}};SceneLeaderboards.prototype.parseLeaderboardType=function(jsonData){var text=jsonData.type;if(text==="daily"){return SceneLeaderboards.Leaderboard_Daily}else if(text==="weekly"){return SceneLeaderboards.Leaderboard_Weekly}return SceneLeaderboards.Leaderboard_AllTime};SceneLeaderboards.prototype.getUserIDData=function(leaderboardType,userID){var leaderboard=this.leaderboardsData[leaderboardType];for(var i=0;i<leaderboard.length;++i){if(leaderboard[i].userID===userID){return leaderboard[i]}}return null};SceneLeaderboards.prototype.getConstUserIDData=function(leaderboardType,userID){return this.getUserIDData(leaderboardType,userID)};SceneLeaderboards.prototype.getPlayerCountryCode=function(userID){var countryCode;var userData=this.getConstUserIDData(SceneLeaderboards.Leaderboard_AllTime,userID);if(userData){countryCode=userData.countryCode}return countryCode};SceneLeaderboards.prototype.updateLeaderboardData=function(leaderboardType,jsonData){var userID=jsonData.userID;var wins=jsonData.wins;var losses=jsonData.losses;var deviceType=jsonData.deviceType;var countryCode=jsonData.countryCode;var country=jsonData.country;var facebook=jsonData.facebook;var twitter=jsonData.twitter;var google=jsonData.google;this.updateLeaderboard(leaderboardType,userID,countryCode,country,facebook,twitter,google,wins,losses,deviceType)};SceneLeaderboards.prototype.updateLeaderboard=function(leaderboardType,userID,countryCode,country,facebook,twitter,google,wins,losses,deviceType){var userData=this.getUserIDData(leaderboardType,userID);if(!userData){userData=new UserData;userData.userID=userID;userData.deviceType=deviceType;var leaderboard=this.leaderboardsData[leaderboardType];leaderboard.add(userData)}else{userData.won=false;userData.lost=false;if(wins>userData.wins){userData.won=true}else if(losses>userData.losses){userData.lost=true}}if(countryCode){userData.countryCode=countryCode}if(country){userData.country=country}userData.facebook=facebook;userData.twitter=twitter;userData.google=google;userData.wins=wins;userData.losses=losses;if(!userData.tileProfile){var tile,tileProfile,imageModel;{tile=new TileSocialProfile(this,true);tile.setDrawOrder(205);if(facebook&&facebook.facebookID.length>0){tile.setFacebookID(facebook.facebookID);tile.bufferFBProfilePhoto(2)}if(twitter&&twitter.username){tile.setTwitterID(twitter.username);tile.bufferTwitterProfilePhoto(2)}if(google&&google.id){tile.setGoogleID(google.id);tile.bufferGoogleProfilePhoto(2)}var self=this;tile.onRelease.push(function(tile){self.profileSelected(tile)});userData.tileProfile=tile;tile.shouldRender=false;tile.setCollideable(false);tileProfile=tile}{userData.textRank=new CCObjectText(tileProfile);userData.textRank.setColour(gColour.set(1))}{imageModel=new CCModelBase;imageModel.addPrimitive(new CCPrimitiveSquare);tileProfile.tileModel.addModel(imageModel);userData.imageFlag=imageModel}{userData.textName=new CCObjectText(tileProfile);userData.textName.setColour(gColour.set(1))}{imageModel=new CCModelBase;imageModel.addPrimitive(new CCPrimitiveSquare);tileProfile.tileModel.addModel(imageModel);userData.imagePlatform=imageModel}{userData.textWinRatio=new CCObjectText(tileProfile);userData.textWinRatio.setColour(gColour.set(1))}}this.sortLeaderboard(leaderboardType)};SceneLeaderboards.prototype.sortLeaderboard=function(leaderboardType){var leaderboard=this.leaderboardsData[leaderboardType];leaderboard.sort(function(a,b){var playerA=a;var playerB=b;var result;if(playerB.wins===playerA.wins){result=playerA.losses-playerB.losses;return result}result=playerB.wins-playerA.wins;return result})};SceneLeaderboards.prototype.profileSelected=function(profile){var url;var facebookID=profile.getFacebookID();if(facebookID){url="http://facebook.com/";url+=facebookID;CCEngine.WebViewOpen(url)}var twitterID=profile.getTwitterID();if(twitterID){url="http://twitter.com/";url+=twitterID;CCEngine.WebViewOpen(url)}var googleID=profile.getGoogleID();if(googleID){url="http://plus.google.com/";url+=googleID;CCEngine.WebViewOpen(url)}};function ScenePlayScreen(){this.construct()}ExtendPrototype(ScenePlayScreen,CCSceneAppUI);ScenePlayScreen.prototype.construct=function(){this.CCSceneAppUI_construct();this.cameraCentered=true;{var camera=gEngine.newSceneCamera(this);camera.setupViewport(0,0,1,1)}this.scenePlayerView=null;this.sceneProfileLogin=null;this.uiTiles=[];this.sideMenuTiles=[];this.mapMenuTiles=[]};ScenePlayScreen.prototype.destruct=function(){this.deletePlayerView();this.closeProfileLogin();if(this.sceneMultiLauncher){this.sceneMultiLauncher.hide()}this.CCSceneAppUI_destruct()};ScenePlayScreen.prototype.setup=function(){var self=this;var camera=this.camera;camera.setCameraWidth(640);camera.useSceneCollideables(this);this.BORDERWIDTH_RATIO=.2;var borderWidth=camera.targetWidth*this.BORDERWIDTH_RATIO;var uiTiles=this.uiTiles;var sideMenuTiles=this.sideMenuTiles;var tile;{tile=new CCTile3DButton(this);tile.setColourAlpha(0);this.tileSideBackground=tile;tile.setupTexturedWidth(borderWidth,"ui_sidebackground.png",function(){self.imageLoaded()});tile.setDrawOrder(199);tile.setCollideable(false);this.addTile(tile);tile.setTouchDepressDepth(0)}{tile=new TileSocialProfile(this);tile.setTileSize(borderWidth*.75);tile.setPositionX(camera.targetWidth+tile.collisionBounds[0]);tile.setText(" ",false,tile.collisionSize.height*.2);tile.setTextPosition(0,tile.collisionBounds[1]*-.45);tile.setTextColour(gColour.set(.5,0));this.tileProfile=tile;tile.bufferInfo(2,function(tile,success){if(success){self.setPlayerID(tile.getName())}});tile.onRelease.push(function(){self.showProfileLogin()});this.addTile(tile,0);sideMenuTiles.add(tile);uiTiles.add(tile)}{tile=new CCTile3DButton(this);tile.setupTexturedWidth(borderWidth,"ui_practice.png",function(){self.imageLoaded()});tile.onRelease.push(function(){self.startOfflineGame()});this.addTile(tile,0);this.tilePractice=tile;sideMenuTiles.add(tile);uiTiles.add(tile)}{tile=new CCTile3DButton(this);tile.setupTexturedWidth(borderWidth,"ui_leaderboards.png",function(){self.imageLoaded()});tile.onRelease.push(function(){self.showLeaderboards()});this.addTile(tile,0);this.tileLeaderboards=tile;sideMenuTiles.add(tile);uiTiles.add(tile)}{tile=new CCTile3DButton(this);tile.setupTexturedWidth(borderWidth,"ui_help.png",function(){self.imageLoaded()});tile.onRelease.push(function(){self.showHelp()});this.addTile(tile,0);this.tileHelp=tile;sideMenuTiles.add(tile);uiTiles.add(tile)}this.tilePushNotifications=null;{{tile=new CCTile3DButton(this);tile.setupTexturedWidth(borderWidth*.5,"ui_arrow.png",function(){self.imageLoaded()});tile.onRelease.push(function(){self.switchTeams(-1)});this.addTile(tile,0);this.tileSwitchTeamsLeft=tile;uiTiles.add(tile)}var OnImageDownloaded=function(tile){return function(){tile.flipTileY();self.imageLoaded()}};{tile=new CCTile3DButton(this);tile.setupTexturedWidth(borderWidth*.5,"ui_arrow.png",new OnImageDownloaded(tile));tile.onRelease.push(function(){self.switchTeams(1)});this.addTile(tile,0);this.tileSwitchTeamsRight=tile;uiTiles.add(tile)}}{var mapMenuTiles=this.mapMenuTiles;{tile=new CCTile3DButton(this);tile.setupTexturedWidth(borderWidth*1.25,"ui_button_1vs1.png",function(){self.imageLoaded()});tile.onRelease.push(function(){self.start1vs1Game()});this.addTile(tile,0);uiTiles.add(tile);mapMenuTiles.add(tile)}{tile=new CCTile3DButton(this);tile.setupTexturedWidth(borderWidth*1.25,"ui_button_battleroyale.png",function(){self.imageLoaded()});tile.onRelease.push(function(){self.startBattleRoyaleGame()});this.addTile(tile,0);uiTiles.add(tile);mapMenuTiles.add(tile)}}for(var i=0;i<uiTiles.length;++i){tile=uiTiles[i];tile.setDrawOrder(205);tile.setColourAlpha(0);tile.setCollideable(false)}this.lockCameraView();this.refreshCameraView()};ScenePlayScreen.prototype.imageLoaded=function(){if(this.showing){this.showMainView()}else{this.hideMainView()}};ScenePlayScreen.prototype.resize=function(){this.CCSceneAppUI_resize();if(this.showing){this.showMainView()}};ScenePlayScreen.prototype.render=function(camera,pass,alpha){};ScenePlayScreen.prototype.deletingChild=function(inScene){if(inScene===this.sceneProfileLogin){this.sceneProfileLogin=null;this.showMainView();if(this.scenePlayerView){this.scenePlayerView.enabled=true;this.scenePlayerView.camera.enabled=true}if(sceneManagerGame){sceneManagerGame.camera.enabled=true}}this.CCSceneAppUI_deletingChild(inScene)};ScenePlayScreen.prototype.touchPressed=function(touch){return this.CCSceneAppUI_touchPressed(touch)};ScenePlayScreen.prototype.touchMoving=function(touch,touchDelta){return false};ScenePlayScreen.prototype.touchReleased=function(touch,touchAction){return this.CCSceneAppUI_touchReleased(touch,touchAction)};ScenePlayScreen.prototype.show=function(playerType){this.showMainView();this.showPlayerView(playerType)};ScenePlayScreen.prototype.showMainView=function(){this.showing=true;this.controlsEnabled=true;var camera=this.camera;this.enabled=true;camera.enabled=true;var uiTiles=this.uiTiles;var sideMenuTiles=this.sideMenuTiles;var tile;var i;{tile=this.tileSideBackground;tile.setColourAlpha(1,true);tile.setCollideable(true);tile.setPositionYZ(0,0);tile.setTileMovementX(camera.targetWidth*.5+tile.collisionBounds[0]-tile.collisionSize.width)}{var yOffset=0;{var menuHeight=0;for(i=0;i<sideMenuTiles.length;++i){tile=sideMenuTiles[i];menuHeight+=tile.collisionSize.height}yOffset=-menuHeight*.6}var quarterHeight=camera.targetHeight*.075125;if(yOffset>quarterHeight){yOffset=quarterHeight}if(this.tileSideBackground.getTileTextureImage()){tile=this.tileProfile;tile.setPositionY(-tile.collisionBounds[1]-yOffset);tile.setTileMovementX(this.tileSideBackground.getTileMovementTarget()[0]);tile.setTextColourAlpha(.85,true)}}{tile=this.tilePractice;tile.positionTileBelowY(this.tileProfile)}{tile=this.tileLeaderboards;tile.positionTileBelowY(this.tilePractice)}{tile=this.tileHelp;tile.positionTileBelowY(this.tileLeaderboards)}if(this.tilePushNotifications){tile=this.tilePushNotifications;tile.positionTileBelow(this.tileHelp);tile.translateTileMovementX(-tile.collisionSize.width)}{var borderWidth=camera.targetWidth*this.BORDERWIDTH_RATIO;{tile=this.tileSwitchTeamsLeft;tile.setPositionX(-camera.targetWidth*.5+tile.collisionBounds[0]);tile.setPositionY(0)}{tile=this.tileSwitchTeamsRight;tile.setPositionX(camera.targetWidth*.5-tile.collisionBounds[0]-borderWidth);tile.setPositionY(0)}}{var borderOffset=camera.targetWidth*this.BORDERWIDTH_RATIO*.5;var y=camera.targetHeight*.5*.666;var mapMenuTiles=this.mapMenuTiles;var totalWidth=mapMenuTiles[0].collisionSize.width*mapMenuTiles.length;var x=-borderOffset-totalWidth*.5;for(i=0;i<mapMenuTiles.length;++i){tile=mapMenuTiles[i];x+=tile.collisionBounds[0];tile.setPositionX(x);x+=tile.collisionBounds[0];tile.setPositionY(-y)}}for(i=0;i<sideMenuTiles.length;++i){tile=sideMenuTiles[i];if(tile!==this.tileProfile){tile.setTileMovementX(camera.targetWidth*.5+tile.collisionBounds[0]-tile.collisionSize.width)}}for(i=0;i<uiTiles.length;++i){tile=uiTiles[i];tile.setColourAlpha(1,true);tile.setCollideable(true)}};ScenePlayScreen.prototype.hide=function(){this.deletePlayerView();this.hideMainView()};ScenePlayScreen.prototype.hideMainView=function(){var self=this;this.showing=false;this.controlsEnabled=false;var camera=this.camera;var uiTiles=this.uiTiles;var sideMenuTiles=this.sideMenuTiles;var tile;if(this.tileSideBackground){tile=this.tileSideBackground;tile.setColourAlpha(0,true,function(){self.enabled=false;camera.enabled=false});tile.setCollideable(false);tile.setTileMovementX(camera.targetWidth*.5+tile.collisionBounds[0])}if(this.tileProfile){tile=this.tileProfile;tile.setTileMovementX(camera.targetWidth*.5+tile.collisionBounds[0]);tile.setTextColourAlpha(0,true)}var i;for(i=0;i<sideMenuTiles.length;++i){tile=sideMenuTiles[i];if(tile!==this.tileProfile){tile.translateTileMovementX(tile.collisionSize.width)}}for(i=0;i<uiTiles.length;++i){tile=uiTiles[i];tile.setColourAlpha(0,true);tile.setCollideable(false)}this.closeProfileLogin()};ScenePlayScreen.prototype.showPlayerView=function(playerType){this.deletePlayerView();var borderWidth=this.BORDERWIDTH_RATIO;var sceneWidth=1-borderWidth;this.scenePlayerView=new ScenePlayerView(this,sceneWidth,playerType);gEngine.addScene(this.scenePlayerView)};ScenePlayScreen.prototype.deletePlayerView=function(){if(this.scenePlayerView){this.scenePlayerView.deleteLater();this.scenePlayerView=null}};ScenePlayScreen.prototype.showProfileLogin=function(){if(this.controlsEnabled){if(!this.sceneProfileLogin){this.hideMainView();if(this.scenePlayerView){this.scenePlayerView.enabled=false;this.scenePlayerView.camera.enabled=false}if(sceneManagerGame){sceneManagerGame.camera.enabled=false}this.controlsEnabled=false;this.sceneProfileLogin=new SceneProfileLogin(this)}sceneManagerGame.toggleWaitingForOpponent(false)}};ScenePlayScreen.prototype.closeProfileLogin=function(){if(this.sceneProfileLogin){this.sceneProfileLogin.close()}};ScenePlayScreen.prototype.loggedIntoFacebook=function(){var self=this;this.tileProfile.setFacebookID("me");this.tileProfile.bufferFBInfo(2,false,function(tile,success){if(success){self.setPlayerID(tile.getName())}})};ScenePlayScreen.prototype.loggedIntoTwitter=function(){var self=this;this.tileProfile.bufferTwitterInfo(2,function(tile,success){if(success){self.setPlayerID(tile.getName())}})};ScenePlayScreen.prototype.loggedIntoGoogle=function(){var self=this;this.tileProfile.bufferGoogleInfo(2,function(tile,success){if(success){self.setPlayerID(tile.getName())}})};ScenePlayScreen.prototype.setPlayerID=function(playerID){var newPlayerID=playerID;newPlayerID=newPlayerID.replace(" ","\n");var currentPlayerID=this.tileProfile.textObject.getText();if(currentPlayerID!==newPlayerID){if(this.tileProfile.isCollideable()){this.tileProfile.setTextColourAlpha(0);this.tileProfile.setTextColourAlpha(.85,true)}this.tileProfile.setText(newPlayerID)}};ScenePlayScreen.prototype.enablePushNotifications=function(){};ScenePlayScreen.prototype.disablePushNotifications=function(){};ScenePlayScreen.prototype.startOfflineGame=function(){if(sceneManagerGame){if(sceneManagerGame.startOfflineGame()){this.controlsEnabled=false}}};ScenePlayScreen.prototype.start1vs1Game=function(){if(MultiplayerManager.LoggedIn){if(sceneManagerGame){sceneManagerGame.start1vs1()}}};ScenePlayScreen.prototype.startBattleRoyaleGame=function(){if(MultiplayerManager.LoggedIn){if(sceneManagerGame){if(sceneManagerGame.startBattleRoyale()){this.controlsEnabled=false}}}};ScenePlayScreen.prototype.switchTeams=function(direction){sceneManagerGame.switchTeams(direction)};ScenePlayScreen.prototype.showLeaderboards=function(){if(this.controlsEnabled){if(sceneManagerGame.showLeaderboards()){this.controlsEnabled=false}}};ScenePlayScreen.prototype.showHelp=function(){if(this.controlsEnabled){new SceneUIImage(this)}};function ScenePlayerView(parentScene,sceneWidth,playerType){this.construct();this.cameraCentered=true;{parentScene.linkScene(this);this.setParent(parentScene)}{var cameraIndex=gEngine.findCameraIndex(parentScene.camera)-1;if(cameraIndex<0){cameraIndex=0}var camera=gEngine.newSceneCamera(this,cameraIndex);camera.setupViewport(0,0,sceneWidth,1)}this.playerType=playerType}ExtendPrototype(ScenePlayerView,CCSceneAppUI);ScenePlayerView.prototype.construct=function(){this.CCSceneAppUI_construct();
this.cameraCentered=true};ScenePlayerView.prototype.destruct=function(){this.CCSceneAppUI_destruct()};ScenePlayerView.prototype.setup=function(){var self=this;var camera=this.camera;camera.useSceneCollideables(this);camera.setRotationX(-15);camera.setLookAt([0,-30,0]);camera.setOffset([0,0,50]);camera.offsetInterpolator.setDuration(1);if(!sceneManagerGame.isUsablePlayer(false)){var tile=new CCTile3DButton(this,true);tile.setText("LOCKED");tile.setColour(gColour.set(0,.5));tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(210);tile.setRotationX(-10);tile.setTouchDepressDepth(1);tile.onRelease.push(function(){sceneManagerGame.isUsablePlayer()});this.addTile(tile,0);this.text=tile}this.player=SceneManagerPlay.SpawnCharacter(this.playerType,function(player){vec3.copy(camera.targetLookAt,player.position);camera.flagUpdate();self.playerLoaded=true;self.requestResize()});this.player.setScene(this);this.refreshCameraView();this.lockCameraView()};ScenePlayerView.prototype.updateCamera=function(delta){if(!this.resizing&&!this.cameraScrolling){this.player.rotateY(delta*-15)}return this.CCSceneAppUI_updateCamera(delta)};ScenePlayerView.prototype.resize=function(){var camera=this.camera;CC.ASSERT(camera);camera.recalcViewport();camera.flagUpdate();var idealAspectRatio=1.5;var aspectRatioAdjutment=camera.getAspectRatio()<1.25?camera.getAspectRatio()/idealAspectRatio:1;if(this.playerLoaded){camera.setCameraHeight(30/aspectRatioAdjutment,true)}if(this.text){var tile=this.text;tile.setTextHeight(camera.targetHeight*.2*aspectRatioAdjutment,true);tile.setTextScale(.75);tile.setPositionY(-camera.targetHeight*.125)}};ScenePlayerView.prototype.render=function(camera,pass,alpha){this.CCSceneAppUI_render(camera,pass,alpha)};ScenePlayerView.prototype.touchPressed=function(touch){return this.CCSceneAppUI_touchPressed(touch)};ScenePlayerView.prototype.touchMoving=function(touch,touchDelta){var result=this.handleTilesTouch(touch,this.controlsMovingVertical?CCControls.touch_movingVertical:CCControls.touch_movingHorizontal);if(result===CCSceneAppUI.tile_touchAction){return true}else{return this.touchCameraRotating(touchDelta.x,touchDelta.y)}};ScenePlayerView.prototype.touchReleased=function(touch,touchAction){return this.CCSceneAppUI_touchReleased(touch,touchAction)};ScenePlayerView.prototype.touchCameraRotating=function(x,y){this.player.rotateY(x*180);this.player.rotateX(y*180);return true};ScenePlayerView.prototype.refreshCameraView=function(){this.CCSceneAppUI_refreshCameraView()};ScenePlayerView.prototype.lockCameraView=function(){};function SceneProfileLogin(parentScene){this.construct();if(parentScene){this.setParent(parentScene);parentScene.linkScene(this)}var camera=gEngine.newSceneCamera(this);camera.setupViewport(0,0,1,1);this.open=true;gEngine.addScene(this);CCEngine.EnableBackButton(this)}ExtendPrototype(SceneProfileLogin,CCSceneAppUI);SceneProfileLogin.prototype.setup=function(){var self=this;var camera=this.camera;camera.setCameraWidth(200,false);var tile;{tile=new CCTile3DButton(this);tile.setupTile(camera.targetWidth,camera.targetHeight);tile.setColour(gColour.set(0,0));tile.setColourAlpha(.75,true);tile.setDrawOrder(99);this.tileBackground=tile;tile.onRelease.push(function(){self.close()});this.addTile(tile)}{tile=new TileSocialProfile(this);tile.setTileSize(camera.cameraWidth*.25);this.tileProfile=tile;this.addTile(tile)}this.tileSocialLogins=[];{tile=new CCTile3DButton(this);this.tileFacebookLogin=tile;tile.setupTexturedWidth(50,"icon_facebook.png",function(){self.requestResize()});tile.onRelease.push(function(){self.facebookLogin()});this.addTile(tile,0);this.tileSocialLogins.push(tile)}if(!window.tizen){tile=new CCTile3DButton(this);this.tileTwitterLogin=tile;tile.setupTexturedWidth(50,"icon_twitter.png",function(){self.requestResize()});tile.onRelease.push(function(){self.twitterLogin()});this.addTile(tile,0);this.tileSocialLogins.push(tile)}if(!window.tizen){tile=new CCTile3DButton(this);this.tileGoogleLogin=tile;tile.setupTexturedWidth(50,"icon_googleplus.png",function(){self.requestResize()});tile.onRelease.push(function(){self.googleLogin()});this.addTile(tile,0);this.tileSocialLogins.push(tile)}camera.setLookAtY(camera.targetHeight);this.refreshCameraView();camera.targetLookAt[1]=0;this.requestResize()};SceneProfileLogin.prototype.handleBackButton=function(){if(this.open){this.close();return true}};SceneProfileLogin.prototype.resize=function(){this.CCSceneAppUI_resize();var camera=this.camera;this.tileBackground.setTileSize(camera.targetWidth,camera.targetHeight);if(this.tileProfile){this.tileProfile.setPositionY(this.tileProfile.collisionBounds[1]);var tileSocialLoginsWidth=0;var i;for(i=0;i<this.tileSocialLogins.length;++i){tileSocialLoginsWidth+=this.tileSocialLogins[i].collisionSize.width}var x=-tileSocialLoginsWidth*.5;for(i=0;i<this.tileSocialLogins.length;++i){var tile=this.tileSocialLogins[i];x+=tile.collisionBounds[0];tile.positionTileBelow(this.tileProfile);tile.translate(0,-2,0);tile.setPositionX(x);x+=tile.collisionBounds[0]}}};SceneProfileLogin.prototype.updateScene=function(delta){var updated=this.CCSceneAppUI_updateScene(delta);return updated};SceneProfileLogin.prototype.updateCamera=function(delta){var camera=this.camera;var updated=false;var lookAtSpeed=1.5;if(camera.interpolateCamera(delta,lookAtSpeed)){if(this.scrollBar){this.scrollBar.reposition(camera.currentLookAt[1],camera.cameraWidth,camera.cameraHeight)}updated=true}else{if(this.cameraScrolling){this.cameraScrolling=false;this.lockCameraView();updated=true}if(this.resizing){this.resizing=false;this.refreshCameraView();this.lockCameraView();updated=true}}return updated};SceneProfileLogin.prototype.renderVisibleObject=function(object,inCamera,pass,alpha){if(this.camera===inCamera){object.renderObject(inCamera,alpha)}};SceneProfileLogin.prototype.updateControls=function(controls){this.CCSceneAppUI_updateControls(controls);return this.open};SceneProfileLogin.prototype.touchMovementAllowed=function(touch,touchDelta){return false};SceneProfileLogin.prototype.lockCameraView=function(){};SceneProfileLogin.prototype.facebookLogin=function(){var self=this;CCAPIFacebook.ClearCache();CCAPIFacebook.StartLogin(function(){self.facebookLoggedIn()})};SceneProfileLogin.prototype.facebookLoggedIn=function(){if(CCAPIFacebook.GetUserAccessToken()){MultiplayerManager.RegisterFacebook();this.tileProfile.setFacebookID("me");this.tileProfile.bufferFBInfo(2,true);this.close()}};SceneProfileLogin.prototype.twitterLogin=function(){var self=this;CCAPITwitter.ClearCache();CCAPITwitter.StartLogin(true,function(){self.twitterLoggedIn()})};SceneProfileLogin.prototype.twitterLoggedIn=function(){if(CCAPITwitter.m_user){var self=this;if(this.tileProfile.bufferTwitterInfo(2)){MultiplayerManager.RegisterTwitter();self.close()}}};SceneProfileLogin.prototype.googleLogin=function(){var self=this;CCAPIGoogle.ClearCache();CCAPIGoogle.StartLogin(function(){self.googleLoggedIn()})};SceneProfileLogin.prototype.googleLoggedIn=function(){if(CCAPIGoogle.User){var self=this;if(this.tileProfile.bufferGoogleInfo(2)){MultiplayerManager.RegisterGoogle();self.close()}}};SceneProfileLogin.prototype.close=function(){if(this.open){if(this.parentScene){this.parentScene.deletingChild(this)}this.open=false;var self=this;this.tileBackground.setColourAlpha(0,true);this.tileProfile.setColourAlpha(0,true);if(this.tileFacebookLogin){this.tileFacebookLogin.setColourAlpha(0,true)}if(this.tileTwitterLogin){this.tileTwitterLogin.setColourAlpha(0,true)}if(this.tileGoogleLogin){this.tileGoogleLogin.setColourAlpha(0,true)}this.tileProfile.setTileScale(1);this.tileProfile.setTileScale(0,true,function(){self.deleteLater()});var camera=this.camera;camera.flagUpdate();camera.targetLookAt[1]=camera.targetHeight}};function SceneItemShop(title,itemCode,consumable,inAppPurhcaseValue,facebookValue,twitterValue,callback){if(SceneItemShop.scene){return}SceneItemShop.scene=this;this.construct();if(!title){title="Get more coins"}if(!itemCode){itemCode="topup_1"}if(inAppPurhcaseValue===undefined){inAppPurhcaseValue=1e3}if(facebookValue===undefined){facebookValue=10}if(twitterValue===undefined){twitterValue=10}if(!callback){inAppPurhcaseValue=0}if(window.LAUNCH_APP_ID!==window.APP_ID){itemCode=window.DEFAULT_PURCHASE_ID}if(window.tizen){inAppPurhcaseValue=false;twitterValue=false}this.title=title;SceneItemShop.itemCode=itemCode;SceneItemShop.consumable=consumable;SceneItemShop.inAppPurhcaseValue=inAppPurhcaseValue;SceneItemShop.facebookValue=facebookValue;SceneItemShop.twitterValue=twitterValue;SceneItemShop.onPurchasedCallback=callback;var camera=gEngine.newSceneCamera(this);camera.setupViewport(0,0,1,1);this.open=true;gEngine.addScene(this);CCEngine.EnableBackButton(this);if(!inAppPurhcaseValue&&!facebookValue&&!twitterValue){this.close()}}ExtendPrototype(SceneItemShop,CCSceneAppUI);SceneItemShop.prototype.setup=function(){var self=this;var camera=this.camera;camera.setCameraWidth(200,false);var tile;{tile=new CCTile3DButton(this);tile.setupTile(camera.targetWidth,camera.targetHeight);tile.setColour(gColour.set(0,0));tile.setColourAlpha(.75,true);tile.setDrawOrder(99);this.tileBackground=tile;tile.onRelease.push(function(){self.close()});this.addTile(tile)}{tile=new CCTile3DButton(this);this.tileTitle=tile;tile.setupText(this.title,camera.targetHeight*.1);tile.setTextColour(new CCColour);this.addTile(tile)}if(!!SceneItemShop.facebookValue){tile=new CCTile3DButton(this);this.tileFacebookLogin=tile;tile.setupTexturedWidth(25,"icon_facebook.png",function(){self.requestResize()});tile.onRelease.push(function(){self.facebookLogin()});this.addTile(tile,0);{tile=new CCTile3DButton;tile.setupText("Mention us +"+SceneItemShop.facebookValue,camera.targetHeight*.05);tile.setTextColour(new CCColour);this.tileFacebookLogin.addChild(tile);tile.translate(0,-this.tileFacebookLogin.collisionBounds[1]-tile.collisionBounds[1])}}if(!!SceneItemShop.twitterValue){tile=new CCTile3DButton(this);this.tileTwitterLogin=tile;tile.setupTexturedWidth(25,"icon_twitter.png",function(){self.requestResize()});tile.onRelease.push(function(){self.twitterLogin()});this.addTile(tile,0);{tile=new CCTile3DButton;tile.setupText("Tweet us +"+SceneItemShop.twitterValue,camera.targetHeight*.05);tile.setTextColour(new CCColour);this.tileTwitterLogin.addChild(tile);tile.translate(0,-this.tileTwitterLogin.collisionBounds[1]-tile.collisionBounds[1])}}if(!!SceneItemShop.inAppPurhcaseValue){if((CCEngine.DeviceType==="iOS"||CCEngine.DeviceType==="Android"||CCEngine.DeviceType==="WindowsPhone")&&!window.amazon&&!window.samsung){tile=new CCTile3DButton(this);this.tileInAppPurchase=tile;var iconURL="icon_store";if(CCEngine.DeviceType==="Android"){iconURL+="_googleplay"}else if(CCEngine.DeviceType.contains("Windows")){iconURL+="_windows"}iconURL+=".png";tile.setupTexturedWidth(50,iconURL,function(){self.requestResize()});tile.onRelease.push(function(){self.inAppPurchase()});this.addTile(tile,0);{tile=new CCTile3DButton;tile.setupText("In-app purchase +"+SceneItemShop.inAppPurhcaseValue,camera.targetHeight*.05);tile.setTextColour(new CCColour);this.tileInAppPurchase.addChild(tile);tile.translate(0,-this.tileInAppPurchase.collisionBounds[1]-tile.collisionBounds[1])}}}camera.setLookAtY(camera.targetHeight);this.refreshCameraView();camera.targetLookAt[1]=0;this.requestResize()};SceneItemShop.prototype.handleBackButton=function(){if(this.open){this.close();return true}};SceneItemShop.prototype.resize=function(){this.CCSceneAppUI_resize();var camera=this.camera;this.tileBackground.setTileSize(camera.targetWidth,camera.targetHeight);if(this.tileTitle){this.tileTitle.setPositionY(camera.targetHeight*.25);if(this.tileInAppPurchase){this.tileInAppPurchase.positionTileBelow(this.tileTitle);this.tileInAppPurchase.translate(0,-5,0);if(this.tileFacebookLogin){this.tileFacebookLogin.positionTileLeft(this.tileInAppPurchase);this.tileFacebookLogin.translate(-this.tileFacebookLogin.collisionBounds[0])}if(this.tileTwitterLogin){this.tileTwitterLogin.positionTileRight(this.tileInAppPurchase);this.tileTwitterLogin.translate(this.tileTwitterLogin.collisionBounds[0])}}else{if(this.tileFacebookLogin&&this.tileTwitterLogin){this.tileFacebookLogin.setPositionX(-this.tileFacebookLogin.collisionSize.width);this.tileTwitterLogin.setPositionX(this.tileTwitterLogin.collisionSize.width)}}}};SceneItemShop.prototype.updateScene=function(delta){var updated=this.CCSceneAppUI_updateScene(delta);return updated};SceneItemShop.prototype.updateCamera=function(delta){var camera=this.camera;var updated=false;var lookAtSpeed=1.5;if(camera.interpolateCamera(delta,lookAtSpeed)){if(this.scrollBar){this.scrollBar.reposition(camera.currentLookAt[1],camera.cameraWidth,camera.cameraHeight)}updated=true}else{if(this.cameraScrolling){this.cameraScrolling=false;this.lockCameraView();updated=true}if(this.resizing){this.resizing=false;this.refreshCameraView();this.lockCameraView();updated=true}}return updated};SceneItemShop.prototype.renderVisibleObject=function(object,inCamera,pass,alpha){if(this.camera===inCamera){object.renderObject(inCamera,alpha)}};SceneItemShop.prototype.updateControls=function(controls){this.CCSceneAppUI_updateControls(controls);return this.open};SceneItemShop.prototype.touchMovementAllowed=function(touch,touchDelta){return false};SceneItemShop.prototype.lockCameraView=function(){};SceneItemShop.prototype.facebookLogin=function(){var self=this;CCAPIFacebook.ClearCache();CCAPIFacebook.StartLogin(function(){self.facebookLoggedIn()})};SceneItemShop.prototype.facebookLoggedIn=function(){if(CCAPIFacebook.GetUserAccessToken()){MultiplayerManager.RegisterFacebook();var url=SERVER_ROOT+"backend/helper.php?url=http://softpoetry.com/backend/facebook.php?post&client=";url+=APP_ID;url+="&token="+CCAPIFacebook.GetUserAccessToken();gURLManager.requestURL(url);if(SceneItemShop.onPurchasedCallback){if(!SceneItemShop.consumable){CC.SaveData("shop."+SceneItemShop.itemCode+".item",true)}SceneItemShop.onPurchasedCallback("facebook",SceneItemShop.itemCode,SceneItemShop.facebookValue);SceneItemShop.onPurchasedCallback=undefined}this.close()}};SceneItemShop.prototype.twitterLogin=function(){var self=this;CCAPITwitter.ClearCache();CCAPITwitter.StartLogin(false,function(){self.twitterLoggedIn()})};SceneItemShop.prototype.twitterLoggedIn=function(){if(CCAPITwitter.m_user){MultiplayerManager.RegisterTwitter();if(SceneItemShop.onPurchasedCallback){if(!SceneItemShop.consumable){CC.SaveData("shop."+SceneItemShop.itemCode+".item",true)}SceneItemShop.onPurchasedCallback("twitter",SceneItemShop.itemCode,SceneItemShop.twitterValue);SceneItemShop.onPurchasedCallback=undefined}this.close()}};SceneItemShop.prototype.inAppPurchase=function(){if(!MultiplayerManager.LoggedIn){AlertsManager.TimeoutAlert("unable to connect\ncheck your internet connection\nand try again",5);return}if(SceneItemShop.onPurchasedCallback){if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCEngine.InAppPurchase;"+SceneItemShop.itemCode+";"+(SceneItemShop.consumable?"true":"false")+"\n"}}};SceneItemShop.InAppPurchased=function(){if(SceneItemShop.onPurchasedCallback){if(!SceneItemShop.consumable){CC.SaveData("shop."+SceneItemShop.itemCode+".item",true)}SceneItemShop.onPurchasedCallback("in-app",SceneItemShop.itemCode,SceneItemShop.inAppPurhcaseValue);SceneItemShop.onPurchasedCallback=undefined;if(SceneItemShop.scene){SceneItemShop.scene.close()}}};SceneItemShop.HasPurchasedNonConsumable=function(itemCode,callback){if(CC.LoadData(itemCode)){CC.DeleteData(itemCode);CC.SaveData("shop."+itemCode+".item",true)}if(!CC.LoadData("shop."+itemCode+".item")){return false}return true};SceneItemShop.prototype.close=function(){SceneItemShop.scene=undefined;this.open=false;for(var i=0;i<this.tiles.length;++i){this.tiles[i].setColourAlpha(0,true)}var self=this;this.tileBackground.setColourAlpha(0,true,function(){self.deleteLater()});var camera=this.camera;camera.flagUpdate();camera.targetLookAt[1]=camera.targetHeight};function SceneSplashScreen(){this.construct();gEngine.textureManager.getTextureHandle("ui_vs.png");gEngine.textureManager.getTextureHandle("ui_vs_whitestripe.png");gEngine.textureManager.getTextureHandle("ui_vs_bluestripe.png");gEngine.textureManager.getTextureHandle("ui_vs_redstripe.png")}ExtendPrototype(SceneSplashScreen,CCSceneAppUI);SceneSplashScreen.prototype.setup=function(){var self=this;var camera=gEngine.newSceneCamera(this);camera.setupViewport(0,0,1,1);camera.setCameraWidth(SceneBackground.SceneWidth);camera.useSceneCollideables(this);var tile;{tile=new CCTile3DButton(this);this.tileWhiteStripe=tile;tile.shouldRender=false}{{tile=new CCTile3DButton(this);tile.setDrawOrder(201);this.tileBlueStripe=tile;tile.translate(camera.targetWidth,0,0)}}{{tile=new CCTile3DButton(this);tile.setDrawOrder(201);this.tileRedStripe=tile;tile.translate(-camera.targetWidth,0,0)}}{tile=new CCTile3DButton(this);tile.setDrawOrder(204);this.tilePlayer1=tile;tile=new CCTile3DButton(this);tile.setDrawOrder(204);this.tilePlayerCountry1=tile;tile=new CCTile3DButton(this);tile.setupText("",1,true,false);tile.setDrawOrder(205);tile.setTextColour(gColour.set(1,0));this.tilePlayer1Score=tile}{tile=new CCTile3DButton(this);tile.setDrawOrder(204);this.tilePlayer2=tile;tile=new CCTile3DButton(this);tile.setDrawOrder(204);this.tilePlayerCountry2=tile;tile=new CCTile3DButton(this);tile.setupText("",1,true,false);tile.setDrawOrder(205);tile.setTextColour(gColour.set(1,0));this.tilePlayer2Score=tile}{tile=new CCTile3DButton(this);tile.setupTextured("ui_vs.png");tile.setDrawOrder(205);this.tileVS=tile}this.tileWhiteStripe.setupTextured("ui_vs_whitestripe.png",function(){self.tileBlueStripe.setupTextured("ui_vs_bluestripe.png",function(){self.tileRedStripe.setupTextured("ui_vs_redstripe.png",function(){self.tileBlueStripe.positionTileAbove(self.tileWhiteStripe);{tile=new CCTile3DButton(self);tile.setupTextured("ui_vs_whitestripe.png");tile.setColour(gColour.set(0,.5));tile.setDrawOrder(202);tile.translate(0,self.tileBlueStripe.collisionBounds[1]+tile.collisionBounds[1],0);tile.removeFromScene();self.tileBlueStripe.addChild(tile)}{tile=new CCTile3DButton(self);tile.setupTextured("ui_vs_whitestripe.png");tile.setColour(gColour.set(0,.5));tile.setDrawOrder(203);tile.translate(0,-(self.tileBlueStripe.collisionBounds[1]+tile.collisionBounds[1]),0);tile.removeFromScene();self.tileBlueStripe.addChild(tile)}self.tileRedStripe.positionTileBelow(self.tileWhiteStripe);{tile=new CCTile3DButton(self);tile.setupTextured("ui_vs_whitestripe.png");tile.setColour(gColour.set(0,.5));tile.setDrawOrder(203);tile.translate(0,self.tileRedStripe.collisionBounds[1]+tile.collisionBounds[1],0);tile.removeFromScene();self.tileRedStripe.addChild(tile)}{tile=new CCTile3DButton(self);tile.setupTextured("ui_vs_whitestripe.png");tile.setColour(gColour.set(0,.5));tile.setDrawOrder(202);tile.translate(0,-(self.tileRedStripe.collisionBounds[1]+tile.collisionBounds[1]),0);tile.removeFromScene();self.tileRedStripe.addChild(tile)}self.loaded=true;self.hide(true);if(self.onLoaded){self.onLoaded();delete self.onLoaded}})})});{this.hide(true)}this.requestResize()};SceneSplashScreen.prototype.resize=function(){this.CCSceneAppUI_resize();var camera=this.camera;var idealAspectRatio=1.5;var aspectRatioAdjutment=camera.getAspectRatio()<1.25?camera.getAspectRatio()/idealAspectRatio:1;var textHeight=camera.targetHeight*.15*aspectRatioAdjutment;this.tilePlayer1Score.setTextHeight(textHeight,false);this.tilePlayer2Score.setTextHeight(textHeight,false)};SceneSplashScreen.prototype.render=function(camera,pass,alpha){};SceneSplashScreen.prototype.touchPressed=function(touch){return this.CCSceneAppUI_touchPressed(touch)};SceneSplashScreen.prototype.touchMoving=function(touch,touchDelta){return false};SceneSplashScreen.prototype.touchReleased=function(touch,touchAction){return this.CCSceneAppUI_touchReleased(touch,touchAction)};SceneSplashScreen.prototype.show=function(player1,country1,player2,country2){if(this.loaded){this.showPlayer1(player1,country1);this.showPlayer2(player2,country2);this.tileVS.setTileMovement(vec3.create());this.tileVS.setColourAlpha(1,true)}else{var self=this;this.onLoaded=function(){self.show(player1,country1,player2,country2)}}};SceneSplashScreen.prototype.hide=function(instantly){var self=this;if(!instantly){if(this.onLoaded){delete this.onLoaded}}this.timers.length=0;var camera=this.camera;this.tileBlueStripe.setColourAlpha(0,!instantly,function(){self.enabled=false;camera.enabled=false});this.tileBlueStripe.setTextColourAlpha(0,!instantly);this.tileRedStripe.setColourAlpha(0,!instantly);this.tileRedStripe.setTextColourAlpha(0,!instantly);this.tileVS.setColourAlpha(0,!instantly);this.tilePlayer1Score.setTextColourAlpha(0,!instantly);this.tilePlayer2Score.setTextColourAlpha(0,!instantly);if(instantly){this.tileBlueStripe.setPositionX(-camera.targetWidth);this.tilePlayer1.setPositionX(camera.targetWidth);this.tilePlayerCountry1.setPositionX(-camera.targetWidth);this.tileRedStripe.setPositionX(camera.targetWidth);this.tilePlayer2.setPositionX(-camera.targetWidth);this.tilePlayerCountry2.setPositionX(camera.targetWidth);this.tileVS.setPositionZ(camera.targetOffset[2])}else{this.tileBlueStripe.setTileMovementX(-camera.targetWidth);this.tilePlayer1.setTileMovementX(camera.targetWidth);this.tilePlayerCountry1.setTileMovementX(-camera.targetWidth);this.tileRedStripe.setTileMovementX(camera.targetWidth);this.tilePlayer2.setTileMovementX(-camera.targetWidth);this.tilePlayerCountry2.setTileMovementX(camera.targetWidth);this.tileVS.setTileMovement(vec3.clone([0,0,camera.targetOffset[2]*1]))}this.showingPlayer1=this.showingPlayer2=false};SceneSplashScreen.prototype.showPlayer1=function(playerType,countryCode,time){if(!time){time=1}if(this.showingPlayer1!==playerType){this.showingPlayer1=playerType;var self=this;var camera=this.camera;this.enabled=true;camera.enabled=true;var tilePlayer1=this.tilePlayer1;var tilePlayerCountry1=this.tilePlayerCountry1;var tileBlueStripe=this.tileBlueStripe;var timer=new CCTimer;timer.onTime.push(function(){{SceneSplashScreen.LoadPlayerType(tilePlayer1,playerType,function(tile){if(self.showingPlayer1){tile.positionTileAbove(self.tileWhiteStripe);tile.setPositionX(-camera.targetWidth*.75);tile.setTileMovementX(-camera.targetWidth*.5+tile.collisionBounds[0]);self.tilePlayer1Score.setPositionXY(.5,tileBlueStripe.position[1])}})}{MultiplayerManager.LoadCountry(tilePlayerCountry1,countryCode,function(tile,textureHandle){if(self.showingPlayer1){tile.setPosition(tileBlueStripe.position);tile.setPositionX(camera.targetWidth*.75);tile.setTileMovementX(camera.targetWidth*.5-tile.collisionBounds[0])}})}});timer.start(time);this.timers.push(timer);tileBlueStripe.setColourAlpha(.9,true);tileBlueStripe.setTileMovementX(0)}};SceneSplashScreen.prototype.showPlayer2=function(playerType,countryCode,time){if(!time){time=1.25}if(this.showingPlayer2!==playerType){this.showingPlayer2=playerType;var self=this;var camera=this.camera;this.enabled=true;camera.enabled=true;var tilePlayer2=this.tilePlayer2;var tilePlayerCountry2=this.tilePlayerCountry2;var tileRedStripe=this.tileRedStripe;var timer=new CCTimer;timer.onTime.push(function(){{tilePlayer2.resetTileUVs();SceneSplashScreen.LoadPlayerType(tilePlayer2,playerType,function(tile){if(self.showingPlayer2){tile.flipTileY();tile.positionTileAbove(tileRedStripe);tile.translate(0,-tileRedStripe.collisionSize.height,0);tile.setPositionX(camera.targetWidth*.75);tile.setTileMovementX(camera.targetWidth*.5-tile.collisionBounds[0]);self.tilePlayer2Score.setPositionXY(.5,tileRedStripe.position[1])}})}{MultiplayerManager.LoadCountry(tilePlayerCountry2,countryCode,function(tile,textureHandle){if(self.showingPlayer2){tile.setPosition(tileRedStripe.position);tile.setPositionX(-camera.targetWidth*.75);tile.setTileMovementX(-camera.targetWidth*.5+tile.collisionBounds[0])}})}});timer.start(time);this.timers.push(timer);tileRedStripe.setColourAlpha(.9,true);tileRedStripe.setTileMovementX(0)}};SceneSplashScreen.LoadPlayerType=function(tile,playerType,callback){var playerTypeInfo=sceneManagerGame.getPlayerTypeInfo(playerType);if(playerTypeInfo.icon){tile.setupTextured(playerTypeInfo.icon,callback)}else{callback(tile)}};SceneSplashScreen.prototype.isShowingPlayer1=function(){return this.showingPlayer1};SceneSplashScreen.prototype.isShowingPlayer2=function(){return this.showingPlayer2};SceneSplashScreen.prototype.getPlayer1Stripe=function(){return this.tileBlueStripe};SceneSplashScreen.prototype.getPlayer2Stripe=function(){return this.tileRedStripe};SceneSplashScreen.prototype.getPlayer1Score=function(){return this.tilePlayer1Score};SceneSplashScreen.prototype.getPlayer2Score=function(){return this.tilePlayer2Score};function TileOverlay(scene,frameSrc,overlaySrc,margin){this.construct(scene);this.aspectRatioLocked=true;if(!frameSrc){frameSrc="ui_health_bar.png"}if(!overlaySrc){overlaySrc="ui_health_bar_energy.png"}{this.getTileScaleInterpolator().setDuration(.25);this.setDrawOrder(201);this.setTileSize();this.setTileTexture(frameSrc)}{tile=new CCTile3DButton;tile.getTileScaleInterpolator().setDuration(.25);tile.setTileSize();tile.setTileTexture(overlaySrc);this.tileOverlay=tile;this.addChild(tile,true)}this.amount=1;if(margin===undefined){margin=.1}this.margin=margin}ExtendPrototype(TileOverlay,CCTile3DButton);TileOverlay.prototype.setAmount=function(amount){amount=CC.FloatClamp(amount,0,1);this.amount=amount;if(this.tileOverlay){amount*=1-this.margin;amount+=this.margin*.5;this.tileOverlay.setTileSize(this.collisionSize.width*amount,this.collisionSize.height);if(this.flipped){this.tileOverlay.getTileSquare().setTextureUVs(amount,0,0,1);this.tileOverlay.setPositionX(this.collisionBounds[0]-this.tileOverlay.collisionBounds[0])}else{this.tileOverlay.getTileSquare().setTextureUVs(0,0,amount,1);this.tileOverlay.setPositionX(-this.collisionBounds[0]+this.tileOverlay.collisionBounds[0])}this.tileOverlay.setColourAlpha(.5+amount*.5,true)}};TileOverlay.prototype.setTileSize=function(width,height,depth){this.CCTile3DButton_setTileSize(width,height,depth);if(this.tileOverlay){this.tileOverlay.setTileSize(width,height,depth)}};TileOverlay.prototype.flipTileY=function(){this.CCTile3DButton_flipTileY();if(this.tileOverlay){this.tileOverlay.flipTileY()}this.flipped=!this.flipped};function TileProfileBase(scene){this.construct(scene)}ExtendPrototype(TileProfileBase,CCTile3DButton);TileProfileBase.prototype.construct=function(scene){this.CCTile3DButton_construct(scene)};TileProfileBase.prototype.setupTile=function(width,height,text){if(!this.backgroundSquare){this.setDrawOrder(200);this.photoWidth=.9;this.backgroundSquare=new CCPrimitiveSquare;this.backgroundSquare.setTexture("ui_border.png");var model=this.model;model.addPrimitive(this.backgroundSquare);this.setColour(gColour.set(1));var tileRotationInterpolator=this.tileRotationInterpolator=new CCInterpolatorListV3(CCInterpolatorX2Curve);tileRotationInterpolator.setDuration(.5)}return this.CCTile3DButton_setupTile(width,height,text)};TileProfileBase.prototype.setTileSize=function(width,height){if(!height){height=width}if(this.tileSquares.length===0){this.tileSquares.push(new CCPrimitiveSquare);var tileSquare=this.tileSquares[0];this.tileModel.addPrimitive(tileSquare)}var hWidth=width*.5;var hHeight=height*.5;this.setHCollisionBounds(hWidth,hHeight,CC_SMALLFLOAT);this.backgroundSquare.setScale(width,height,1);this.tileSquares[0].setScale(width*this.photoWidth,height*this.photoWidth,1);CC.UpdateCollisions(this)};TileProfileBase.prototype.rotationFadeOut=function(){this.setCollideable(false);if(this.tileRotationInterpolator){var self=this;this.setColourAlpha(0,true);this.tileRotationInterpolator.pushV3(this.rotation,vec3.clone([0,CC.RandomDualInt()*90,0]),true,function(){self.shouldRender=false})}};TileProfileBase.prototype.rotationFadeIn=function(){this.setCollideable(true);if(this.tileRotationInterpolator){this.setColourAlpha(1,true);this.tileRotationInterpolator.pushV3(this.rotation,vec3.create(),true);this.shouldRender=true}};function GetDefaultProfilePhoto(){var photos=["profile_derp.png","profile_f7u12.png","profile_girl.png","profile_grandma.png","profile_happy.png","profile_poker.png","profile_rich.png","profile_troll.png"];var random=CC.Random(7);return photos[random]}function TileSocialProfile(scene,doNotBuffer){this.construct(scene);if(!this.f7u12Photo){this.f7u12Object=new CCObject;this.f7u12Object.setModel(new CCModelBase);this.f7u12Object.setColour(gColour.set(1));this.f7u12Object.getColourInterpolator().setDuration(.25);this.f7u12Photo=new CCPrimitiveSquare;this.f7u12Photo.setTexture(GetDefaultProfilePhoto());this.f7u12Object.model.addPrimitive(this.f7u12Photo);this.f7u12Object.setTransparent();this.f7u12Object.setReadDepth(false);this.f7u12Object.setWriteDepth(false);this.addChild(this.f7u12Object,0)}this.setupTile(1);if(!doNotBuffer){this.bufferInfo(2)}}ExtendPrototype(TileSocialProfile,TileProfileBase);TileSocialProfile.prototype.renderObject=function(camera,alpha){this.TileProfileBase_renderObject(camera,alpha)};TileSocialProfile.prototype.renderModel=function(alpha){if(alpha){this.TileProfileBase_renderModel(alpha)}else{this.TileProfileBase_renderModel(alpha)}};TileSocialProfile.prototype.APIDownloadedPhoto=function(url,photoID){if(photoID===this.facebookID||photoID===this.twitterID||photoID===this.googleID){if(this.f7u12Object){this.f7u12Object.setColourAlpha(0,true)}if(this.tileSquares.length>0){this.tileSquares[0].setTexture(url)}}};TileSocialProfile.prototype.removePhoto=function(){this.f7u12Object.setColourAlpha(1,true);this.profilePhotoRequestedPriority=-1;this.tileSquares[0].removeTexture()};TileSocialProfile.prototype.setTileSize=function(width,height){if(height===undefined){height=width}this.TileProfileBase_setTileSize(width,height);this.f7u12Photo.setScale(width*this.photoWidth,height*this.photoWidth,1)};TileSocialProfile.prototype.setFacebookID=function(inUserID){this.facebookID=inUserID;this.profilePhotoRequestedPriority=-1};TileSocialProfile.prototype.getFacebookID=function(){return this.facebookID};TileSocialProfile.prototype.setTwitterID=function(inUserID){this.twitterID=inUserID;this.profilePhotoRequestedPriority=-1};TileSocialProfile.prototype.getTwitterID=function(){return this.twitterID};TileSocialProfile.prototype.setGoogleID=function(inUserID){this.googleID=inUserID;this.profilePhotoRequestedPriority=-1};TileSocialProfile.prototype.getGoogleID=function(){return this.googleID};TileSocialProfile.prototype.setName=function(inUserName){this.userName=inUserName;this.userSurname=String.LastWord(inUserName)};TileSocialProfile.prototype.getName=function(){return this.userName};TileSocialProfile.prototype.bufferInfo=function(priority,callback){if(!this.facebookID){if(this.bufferTwitterInfo(2,callback)){return}if(this.bufferGoogleInfo(2,callback)){return}}this.bufferFBInfo(priority,false,callback)};TileSocialProfile.prototype.reset=function(){this.userName="";this.userSurname="";this.googleID="";this.twitterID="";this.facebookID="";this.removePhoto()};TileSocialProfile.GetFBInfo=function(priority,callback,noCache){var self=this;function FBInfoCallback(){}FBInfoCallback.prototype.run=function(){var reply=this.reply;if(reply&&reply.state>=CCURLRequest.Succeeded){var root;try{root=JSON.parse(reply.data)}catch(error){if(reply.state===CCURLRequest.Used_Cache){self.GetFBInfo(priority,callback,true)}}if(root){if(callback){callback(root.id,root.name)}}}else{if(callback){callback()}}};CCAPIFacebook.Request(new FBInfoCallback,this.facebookID?this.facebookID:"me",priority,noCache)};TileSocialProfile.prototype.bufferFBInfo=function(priority,noCache,callback){var self=this;TileSocialProfile.GetFBInfo(priority,function(id,name){if(id&&name){self.parseFBInfoJSON(id,name,priority,callback)}},noCache)};TileSocialProfile.prototype.parseFBInfoJSON=function(id,name,priority,callback){var jsonStringID=id;var jsonStringName=name;this.setFacebookID(jsonStringID);this.setName(jsonStringName);this.bufferFBProfilePhoto(priority);
if(callback){callback(this,true)}};TileSocialProfile.GetTwitterInfo=function(callback){return CC.LoadData("twitter.me")};TileSocialProfile.prototype.bufferTwitterInfo=function(priority,callback){var username=TileSocialProfile.GetTwitterInfo();if(username!==undefined){this.setTwitterID(username);this.setName("@"+username);this.bufferTwitterProfilePhoto(priority);if(callback){callback(this,true)}return true}if(callback){callback(this,false)}return false};TileSocialProfile.GetGoogleInfo=function(callback){var user=CC.LoadData("google.me");if(user!==undefined){if(callback){var json=JSON.parse(user);callback(json.id,json.name)}}else if(callback){callback()}return user};TileSocialProfile.prototype.bufferGoogleInfo=function(priority,callback){var self=this;var user=TileSocialProfile.GetGoogleInfo(function(id,name){if(id&&name){self.setGoogleID(id);self.setName(name);self.bufferGoogleProfilePhoto(priority);if(callback){callback(self,true)}}});if(user===undefined){if(callback){callback(this,false)}return false}return true};TileSocialProfile.prototype.bufferFBProfilePhoto=function(priority){if(this.profilePhotoRequestedPriority>=-1){if(this.profilePhotoRequestedPriority!==priority){this.profilePhotoRequestedPriority=priority;CCAPIFacebook.RequestPhotoID(this,this.facebookID,priority)}}};TileSocialProfile.prototype.bufferTwitterProfilePhoto=function(priority){if(this.profilePhotoRequestedPriority>=-1){if(this.profilePhotoRequestedPriority!==priority){this.profilePhotoRequestedPriority=priority;CCAPITwitter.RequestPhotoID(this,this.twitterID,priority)}}};TileSocialProfile.prototype.bufferGoogleProfilePhoto=function(priority){if(this.profilePhotoRequestedPriority>=-1){if(this.profilePhotoRequestedPriority!==priority){this.profilePhotoRequestedPriority=priority;CCAPIGoogle.RequestPhotoID(this,this.googleID,priority)}}};function FBPhotosCallback(scene,priority,refresh,previousPhotoID){this.scene=scene;this.priority=priority;this.refreshing=refresh;this.previousPhotoID=previousPhotoID}FBPhotosCallback.prototype.run=function(){this.scene.parseFBPhotos(this.reply.state,this.reply.url,this.reply.data,this.priority,this.refreshing,this.previousPhotoID)};TileSocialProfile.prototype.bufferTaggedPhotos=function(priority,refresh){if(refresh){this.taggedPhotosRefreshing=true}var fbRequest=this.facebookID;fbRequest+="/photos";var fbCallback=new FBPhotosCallback(this,1,refresh,false);CCAPIFacebook.Request(fbCallback,fbRequest,1,refresh,.5,12)};TileSocialProfile.prototype.parseFBPhotos=function(state,requestURL,response,priority,refreshing,previousPhotoID){var taggedPhotos=this.taggedPhotos;if(this.taggedPhotosRefreshing){if(!refreshing){return}if(previousPhotoID){return}this.taggedPhotosRefreshing=false;taggedPhotos.clear()}if(state<CCURLRequest.Succeeded){if(this.photosDownloadedCallback){this.photosDownloadedCallback.run()}return}function PhotoData(inPhotoID,inThumbnailURL,inPhotoURL){this.photoID=inPhotoID;this.thumbnailURL=String.RemoveBetween(inThumbnailURL,"http","://");this.photoURL=String.RemoveBetween(inPhotoURL,"http","://")}var downloadedPhotoData=[];var root=JSON.parse(response);if(root){var i,jsonObject;{var jsonData=root.data;if(jsonData){var length=jsonData.length;for(i=0;i<length;++i){jsonObject=jsonData[i];var jsonPhotoID=jsonObject.id;var jsonThumbnailURL=jsonObject.picture;var jsonPhotoURL=jsonObject.source;if(!jsonPhotoID||!jsonThumbnailURL||!jsonPhotoURL){continue}downloadedPhotoData.add(new PhotoData(jsonPhotoID,jsonThumbnailURL,jsonPhotoURL))}}}var photoIndex=0;if(previousPhotoID){for(i=0;i<taggedPhotos.length;++i){var taggedPhoto=taggedPhotos.list[i];var photoID=taggedPhoto.photoID;if(photoID===previousPhotoID){photoIndex=i+1;break}}}for(i=0;i<downloadedPhotoData.length;++i){var downloadedData=downloadedPhotoData[i];var found=false;if(photoIndex<taggedPhotos.length){var downloadedPhotoID=downloadedData.photoID;var currentPhotoID=taggedPhotos.list[photoIndex].photoID;if(currentPhotoID===downloadedPhotoID){found=true}}if(!found){var newPhoto=new PhotoData(downloadedData.photoID,downloadedData.thumbnailURL,downloadedData.photoURL);taggedPhotos.insert(newPhoto,photoIndex)}photoIndex++}if(this.photosDownloadedCallback){this.photosDownloadedCallback.run()}{jsonObject=root.paging;if(jsonObject){var url=jsonObject.next;if(url&&url.length>0){var currentURL=String.SplitBetween(requestURL,"until=","&");var nextURL=String.SplitBetween(url,"until=","&");if(currentURL!==nextURL){var fbCallback=new FBPhotosCallback(this,1,refreshing,downloadedPhotoData.last().photoID);CCAPIFacebook.RequestFBURL(fbCallback,url,priority,refreshing,1)}else{}}}}}};function SceneUIBack(parentScene,callback,editorButton){this.construct();this.callback=callback;this.editorButton=editorButton;{this.setParent(parentScene);parentScene.linkScene(this)}{var parentCameraIndex=gEngine.findCameraIndex(parentScene.camera);var camera=gEngine.newSceneCamera(this,parentCameraIndex+1);this.camera.setupViewport(0,0,1,1)}gEngine.addScene(this);CCEngine.EnableBackButton(this)}ExtendPrototype(SceneUIBack,CCSceneAppUI);SceneUIBack.prototype.deleteLater=function(){if(!this.disabledBackButton){this.disabledBackButton=true}this.CCSceneAppUI_deleteLater()};CCSceneBase.prototype.deleteLaterFromParent=function(){this.close()};SceneUIBack.prototype.handleBackButton=function(){if(!this.disabledBackButton){this.close();this.callback();return true}return false};SceneUIBack.prototype.setup=function(){var self=this;var camera=this.camera;camera.setCameraWidth(640,false);camera.useSceneCollideables(this);var tile;{tile=new CCTile3DButton(this);this.tileBack=tile;if(this.editorButton){tile.setupTexturedWidth(camera.cameraWidth*.1,"editor_tile_back.jpg",function(){tile.setPositionX(camera.cameraHWidth+tile.collisionBounds[0]);self.requestResize()})}else{tile.setupTexturedWidth(camera.cameraWidth*.085,"ui_back.png",function(){self.requestResize()})}tile.setColour(gColour.set(1,0));tile.setColourAlpha(1,true);tile.setDrawOrder(204);tile.onRelease.push(function(){self.close();self.callback()});this.addTile(tile,0)}};SceneUIBack.prototype.render=function(camera,pass,alpha){};SceneUIBack.prototype.resize=function(){this.CCSceneAppUI_resize();var camera=this.camera;if(this.tileBack){var tile=this.tileBack;tile.setPositionY(camera.cameraHHeight-tile.collisionBounds[1]);if(this.editorButton){tile.setTileMovementX(camera.targetWidth*.5-tile.collisionBounds[0])}else{tile.setPositionX(camera.cameraHWidth-tile.collisionBounds[0])}}};SceneUIBack.prototype.touchPressed=function(touch){return this.CCSceneAppUI_touchPressed(touch)};SceneUIBack.prototype.touchMoving=function(touch,touchDelta){return false};SceneUIBack.prototype.touchReleased=function(touch,touchAction){return this.CCSceneAppUI_touchReleased(touch,touchAction)};SceneUIBack.prototype.close=function(){var self=this;var tile=this.tileBack;tile.setColourAlpha(0,true,function(){self.deleteLater()});if(this.editorButton){var camera=this.camera;if(camera){tile.setTileMovementX(camera.targetWidth*.5+tile.collisionBounds[0])}}};function SceneUIImage(parentScene){this.construct();{parentScene.linkScene(this)}{var camera=gEngine.newSceneCamera(this);this.camera.setupViewport(0,0,1,1)}gEngine.addScene(this);this.open=true}ExtendPrototype(SceneUIImage,CCSceneAppUI);SceneUIImage.prototype.setup=function(){var self=this;var camera=this.camera;camera.setCameraWidth(640,false);camera.useSceneCollideables(this);var tile;{tile=new CCTile3DButton(self);tile.setupTile(camera.targetWidth,camera.targetHeight);tile.setColour(gColour.set(.25,0));tile.setColourAlpha(.95,true);tile.setDrawOrder(203);this.cameraStickyTiles.add(tile);this.tileBackground=tile}{tile=new CCTile3DButton(this);this.tileHelp=tile;tile.setupTexturedFit(camera.targetWidth,camera.targetHeight,false,SceneManagerGame.HelpImage);tile.setTileScale(0);tile.setTileScale(1,true);tile.setColour(gColour.set(1,0));tile.setColourAlpha(1,true);tile.setDrawOrder(206);tile.onRelease.push(function(){self.close()});this.addTile(tile,0)}};SceneUIImage.prototype.handleBackButton=function(){if(this.open){this.close();return true}return false};SceneUIImage.prototype.render=function(camera,pass,alpha){this.CCSceneAppUI_render(camera,pass,alpha)};SceneUIImage.prototype.resize=function(){this.CCSceneAppUI_resize();var camera=this.camera;this.tileBackground.setTileSize(camera.targetWidth,camera.targetHeight);this.tileHelp.setTileTextureFit(camera.targetWidth,camera.targetHeight)};SceneUIImage.prototype.updateControls=function(controls){this.CCSceneAppUI_updateControls(controls);return true};SceneUIImage.prototype.touchMovementAllowed=function(touch,touchDelta){return false};SceneUIImage.prototype.close=function(){if(this.open){this.open=false;var self=this;var tile=this.tileHelp;tile.setColourAlpha(0,true,function(){self.deleteLater()});tile.setTileScale(4,true);this.tileBackground.setColourAlpha(0,true)}};function AlertsManager(){}AlertsManager.AlertsList=[];AlertsManager.RemovingAlert=function(inScene){var AlertsList=AlertsManager.AlertsList;AlertsList.remove(inScene)};AlertsManager.Hide=function(id){var AlertsList=AlertsManager.AlertsList;var found=false;for(var i=0;i<AlertsList.length;++i){var alert=AlertsList[i];if(alert.title===id||alert.message===id){alert.close();AlertsList.remove(alert);break}}};AlertsManager.ModalAlert=function(message,priority){var AlertsList=AlertsManager.AlertsList;if(!priority){priority=1}var found=false;var i,alert;for(i=0;i<AlertsList.length;++i){alert=AlertsList[i];if(alert.message===message){found=true;break}}if(!found){alert=new SceneUIAlert(message);alert.modal=priority;alert.open();AlertsList.add(alert)}for(i=0;i<AlertsList.length;++i){alert=AlertsList[i];if(!alert.modal||alert.modal<priority){AlertsManager.Hide(alert.message);--i}}};AlertsManager.ConfirmationAlert=function(message,callback){var AlertsList=AlertsManager.AlertsList;var found=false;var i,alert;for(i=0;i<AlertsList.length;++i){alert=AlertsList[i];if(alert.message===message){found=true;break}}if(!found){alert=new SceneUIAlert(message,true);alert.closeCallback=callback;alert.open();AlertsList.add(alert)}};AlertsManager.InputAlert=function(message,callback,inputOptions){var AlertsList=AlertsManager.AlertsList;var found=false;var i,alert;for(i=0;i<AlertsList.length;++i){alert=AlertsList[i];if(alert.message===message){found=true;break}}if(!found){alert=new SceneUIAlert(message,true,true);alert.closeCallback=callback;if(!inputOptions){inputOptions={}}alert.inputOptions=inputOptions;alert.open();AlertsList.add(alert)}};AlertsManager.TimeoutAlert=function(message,timeout){var AlertsList=AlertsManager.AlertsList;var found=false;var i,alert;for(i=0;i<AlertsList.length;++i){alert=AlertsList[i];if(alert.message===message){found=true;break}}if(!found){alert=new SceneUIAlert(message);if(timeout){alert.setTimeout(timeout)}alert.open();AlertsList.add(alert)}};AlertsManager.Alert=function(message,callback,options){var AlertsList=AlertsManager.AlertsList;var found=false;var i,alert;for(i=0;i<AlertsList.length;++i){alert=AlertsList[i];if(alert.message===message){found=true;break}}if(!found){alert=new SceneUIAlert(message,false,false,options);if(callback){alert.closeCallback=callback}alert.open();AlertsList.add(alert)}};AlertsManager.Notification=function(title,message,callback,timeout,colour,scale){var AlertsList=AlertsManager.AlertsList;var i,alert;for(i=0;i<AlertsList.length;++i){alert=AlertsList[i];if(alert.title===title){alert.close();AlertsList.remove(alert);continue}}if(!scale){scale=1}if(CCEngine.IsMobile()){scale*=2}var height=24*scale;var alertY=480*.5*.75-height*.5;for(i=0;i<AlertsList.length;++i){alert=AlertsList[i];if(alert.isNotification){var y=alert.tileAlert.position[1];if(y>=alertY){alertY=y-alert.tileAlert.collisionBounds[1]-height*.5}}}{alert=new SceneUINotification(title,message,height);if(callback){alert.closeCallback=callback}if(timeout){alert.setTimeout(timeout)}alert.setY(alertY);if(scale){alert.scale=scale;alert.requestResize()}if(colour){alert.setColour(colour)}alert.open();AlertsList.add(alert)}};AlertsManager.UserMessage=function(userID,message,callback,timeout,colour){var AlertsList=AlertsManager.AlertsList;var i,alert;for(i=0;i<AlertsList.length;++i){alert=AlertsList[i];if(alert.title===userID){alert.close();AlertsList.remove(alert);continue}}{alert=new SceneUINotification(userID,message,24,userID);if(callback){alert.closeCallback=callback}if(timeout){alert.setTimeout(timeout)}if(colour){alert.setColour(colour)}alert.open();AlertsList.add(alert)}};function SceneUIAlert(message,confirmationRequired,inputRequired,confirmationOptions){this.construct();this.cameraCentered=true;gEngine.addScene(this);this.message=message;var self=this;this.onKeyboardFunction=function(event,key,pressed){return self.onKeyboard(event,key,pressed)};gEngine.controls.requestKeyboard(this.onKeyboardFunction,inputRequired);if(inputRequired){this.inputRequired=true;this.inputBlinkTimer=0}else if(confirmationRequired){this.confirmationRequired=true}if(confirmationOptions){this.confirmationOptions=confirmationOptions;this.confirmationTiles=[]}}ExtendPrototype(SceneUIAlert,CCSceneAppUI);SceneUIAlert.prototype.deleteLater=function(){AlertsManager.RemovingAlert(this);if(this.onKeyboardFunction){gEngine.controls.removeKeyboard(this.onKeyboardFunction);delete this.onKeyboardFunction}this.CCSceneAppUI_deleteLater()};SceneUIAlert.prototype.setup=function(){var self=this;var camera=gEngine.newSceneCamera(this,null,null,true);camera.setupViewport(0,0,1,1);camera.setCameraWidth(640,false);camera.useSceneCollideables(this);var tile;{tile=new CCTile3DButton(this);tile.setupTile(camera.targetWidth,camera.targetHeight);tile.setColour(gColour.set(.1,0));tile.setColourAlpha(.9,true);tile.setDrawOrder(204);this.cameraStickyTiles.add(tile);this.tileBackground=tile}{tile=new CCTile3DButton(this);tile.setupText(" ",1,true,true);tile.setColour(gColour.setRGBA(.05,.05,.05,0));tile.setTextColour(gColour.set(1,0));tile.setDrawOrder(205);this.tileAlert=tile}this.menuTiles=[];this.requestResize()};SceneUIAlert.prototype.updateScene=function(delta){var updated=this.CCSceneAppUI_updateScene(delta);if(this.inputRequired){this.inputBlinkTimer+=delta;var rate=.5;if(this.inputBlinkTimer>rate){this.inputBlinkTimer-=rate;this.tileAlert.textObject.setEndMarker(!this.tileAlert.textObject.getEndMarker())}}return updated};SceneUIAlert.prototype.render=function(camera,pass,alpha){this.CCSceneAppUI_render(camera,pass,alpha)};SceneUIAlert.prototype.resize=function(){this.CCSceneAppUI_resize();var camera=this.camera;var tile,i;{var textHeight;if(this.inputOptions&&this.inputOptions.height!==undefined){textHeight=this.inputOptions.height}else{textHeight=.5}tile=this.tileAlert;tile.setTileSize(camera.targetWidth,camera.targetHeight*.3);tile.setTextHeight(tile.collisionBounds[1]*textHeight)}if(this.tileBackground){this.tileBackground.setTileSize(camera.targetWidth,camera.targetHeight)}if(this.confirmationTiles){var confirmationOptionsWidth=camera.targetWidth*.5;var confirmationOptionsHeight=confirmationOptionsWidth*.1;this.tileAlert.setTextPosition(undefined,confirmationOptionsHeight*.75);var confirmationOptionsTileWidth=confirmationOptionsWidth/this.confirmationOptions.length;for(i=0;i<this.confirmationTiles.length;++i){tile=this.confirmationTiles[i];tile.setTileSize(confirmationOptionsTileWidth,confirmationOptionsHeight);tile.setTextHeight(tile.collisionSize.height*.66)}var x=-confirmationOptionsWidth*.5;for(i=0;i<this.confirmationTiles.length;++i){tile=this.confirmationTiles[i];x+=tile.collisionBounds[0];tile.setPositionX(x);tile.setPositionY(-tile.collisionBounds[1]);x+=tile.collisionBounds[0]}}var menuTiles=this.menuTiles;for(i=0;i<menuTiles.length;++i){tile=menuTiles[i];if(i===0){tile.setPositionXYZ(camera.cameraHWidth-tile.collisionBounds[0],camera.cameraHHeight-tile.collisionBounds[1],0)}else{tile.positionTileBelow(menuTiles[i-1])}}};SceneUIAlert.prototype.updateControls=function(controls){this.CCSceneAppUI_updateControls(controls);return true};SceneUIAlert.prototype.touchMovementAllowed=function(touch,touchDelta){return false};SceneUIAlert.prototype.setTimeout=function(timeout){var self=this;var timer=new CCTimer;timer.onTime.push(function(){self.close()});timer.start(timeout);this.timers.push(timer)};SceneUIAlert.prototype.open=function(){var self=this;var i;var tile=this.tileAlert;tile.setTextColourAlpha(1,true);tile.setColourAlpha(.95,true);tile.setText(this.message);tile.setTextBlinking(true);var camera=this.camera;tile.setPositionX(camera.targetWidth*.5+tile.collisionSize.width);if(CCEngine.DeviceType!=="Web"){if(this.inputRequired){tile.setPositionY(camera.targetHeight*.25)}}tile.setTileMovementX(0);if(this.confirmationOptions){var OptionFunction=function(index){return function(){self.closeCallback(index);self.close()}};var TimerFunction=function(tile,i){return function(){tile.setTextColourAlpha(1,true);tile.setColourAlpha(.95,true)}};for(i=0;i<this.confirmationOptions.length;++i){tile=new CCTile3DButton(this);tile.setTileTexture("editor_tile_background.jpg");tile.setText(this.confirmationOptions[i]);tile.setColour(gColour.set(1,0));tile.setTextColour(gColour.set(0,0));var timer=new CCTimer;timer.onTime.push(new TimerFunction(tile,i));timer.start(.5+i*.5);this.timers.push(timer);tile.setDrawOrder(205);tile.onRelease.push(new OptionFunction(i+1));this.addTile(tile,0);this.confirmationTiles.push(tile)}}var menuTiles=this.menuTiles;for(i=0;i<menuTiles.length;++i){menuTiles[i].deleteLater()}menuTiles.length=0;if(this.modal){}else{CCEngine.EnableBackButton(this);if(this.inputRequired||this.confirmationRequired){{tile=new CCTile3DButton(this);tile.setupTexturedWidth(camera.cameraWidth*.1,"editor_tile_cross.jpg",function(){self.showMenu()});tile.setColour(gColour.setRGBA(1,1,1,0));tile.setDrawOrder(220);tile.onRelease.push(function(){if(self.closeCallback){self.closeCallback(false)}self.close()});this.addTile(tile,0);menuTiles.add(tile)}{tile=new CCTile3DButton(this);tile.setupTexturedWidth(camera.cameraWidth*.1,"editor_tile_tick.jpg",function(){self.showMenu()});tile.setColour(gColour.setRGBA(1,1,1,0));tile.setDrawOrder(220);tile.onRelease.push(function(){if(self.closeCallback){if(self.inputRequired){var text=self.tileAlert.getText();text=text.formatSpacesAndTabs();self.closeCallback(text)}else if(self.confirmationRequired){self.closeCallback(true)}}self.close()});this.addTile(tile,0);menuTiles.add(tile)}}else{tile=new CCTile3DButton(this);tile.setupTexturedWidth(camera.cameraWidth*.1,"editor_tile_back.jpg",function(){self.showMenu()});tile.setColour(gColour.setRGBA(1,1,1,0));tile.setDrawOrder(205);tile.onRelease.push(function(){if(self.closeCallback){self.closeCallback()}self.close()});this.addTile(tile,0);menuTiles.add(tile)}}this.showMenu()};SceneUIAlert.prototype.showMenu=function(){if(this.enabled){var camera=this.camera;var menuTiles=this.menuTiles;this.requestResize();var i;for(i=0;i<menuTiles.length;++i){tile=menuTiles[i];tile.setPositionX(camera.targetWidth*.5+tile.collisionSize.width);tile.translateTileMovementX(-tile.collisionSize.width*1.5);tile.setColourAlpha(1,true);tile.setCollideable(true)}}};SceneUIAlert.prototype.close=function(){var i;var self=this;if(this.tileBackground){this.tileBackground.setColourAlpha(0,true)}var tile=this.tileAlert;tile.setTextColourAlpha(0,true);tile.setColourAlpha(0,true,function(){self.deleteLater()});var camera=this.camera;tile.translateTileMovementX(-(camera.targetWidth*.5)-tile.collisionSize.width);if(this.confirmationTiles){for(i=0;i<this.confirmationTiles.length;++i){tile=this.confirmationTiles[i];tile.setColourAlpha(0,true);tile.setTextColourAlpha(0,true);tile.setCollideable(false);tile.translateTileMovementX(-(camera.targetWidth*.5)-tile.collisionSize.width)}}var menuTiles=this.menuTiles;for(i=0;i<menuTiles.length;++i){tile=menuTiles[i];tile.translateTileMovementX(camera.targetWidth*.5+tile.collisionSize.width);tile.setColour(gColour.setRGBA(1,1,1,0),true);tile.setCollideable(false)}};SceneUIAlert.prototype.handleBackButton=function(){if(!this.modal){if(!this.disabledBackButton){if(this.closeCallback){this.closeCallback(false)}this.close();return true}}return false};SceneUIAlert.prototype.onKeyboard=function(event,key,pressed){if(event.metaKey){return false}if(event.ctrlKey){return false}if(pressed){var text=this.tileAlert.getText();if(key==="return"){if(this.closeCallback){text=text.formatSpacesAndTabs();this.closeCallback(text)}this.close();return true}else if(key==="backspace"){if(text.length>0){text=text.substring(0,text.length-1);this.tileAlert.setText(text)}return true}else if(key.length===1){var allowed=false;if(key>="a"&&key<="z"||key>="A"&&key<="Z"){if(this.inputOptions.letter||this.inputOptions.letter===undefined){allowed=true}}else if(key>="0"&&key<="9"){if(this.inputOptions.number||this.inputOptions.number===undefined){allowed=true}}else if(key===" "){if(this.inputOptions.space){allowed=true}}else if(key==="."){if(this.inputOptions.dot){allowed=true}}else if(key===","){if(this.inputOptions.comma){allowed=true}}else if(key==="-"){if(this.inputOptions.minus){allowed=true}}else if(key==="!"||key==="("||key===")"||key==='"'||key==="'"||key===":"){if(this.inputOptions.functional){allowed=true}}if(allowed){if(this.inputOptions.length!==undefined){if(text.length<this.inputOptions.length){text+=key;this.tileAlert.setText(text)}}else if(text.length<24){text+=key;this.tileAlert.setText(text)}}return true}}return false};function SceneUINotification(title,message,height,userID){this.construct();this.cameraCentered=true;this.title=title;this.message=message;if(!height){height=32}this.height=height;this.userID=userID;this.isNotification=true;gEngine.addScene(this);CCEngine.EnableBackButton(this)}ExtendPrototype(SceneUINotification,SceneUIAlert);SceneUINotification.prototype.setup=function(){var self=this;var camera=gEngine.newSceneCamera(this,null,null,true);camera.setupViewport(0,0,1,1);camera.setCameraHeight(480,false);camera.useSceneCollideables(this);var tile;if(this.userID){tile=new TileSocialProfile(this,true);tile.setTileSize(camera.targetHeight*.25);tile.setColourAlpha(0);tile.setDrawOrder(205);var userInfo=MultiplayerManager.GetUserInfo(this.userID);if(userInfo){if(userInfo.twitter&&userInfo.twitter.username){tile.setTwitterID(userInfo.twitter.username);tile.bufferTwitterProfilePhoto(2);this.nickname="@"+userInfo.twitter.username.split(" ")[0]}else if(userInfo.facebook&&userInfo.facebook.facebookID.length>0){tile.setFacebookID(userInfo.facebook.facebookID);tile.bufferFBProfilePhoto(2);this.nickname=userInfo.facebook.name.split(" ")[0]}else if(userInfo.google&&userInfo.google.id){tile.setGoogleID(userInfo.google.id);tile.bufferGoogleProfilePhoto(2);this.nickname=userInfo.google.name.split(" ")[0]}}else if(this.userID==="iBot"){tile.setTwitterID("iBot");tile.nickname="@iBot";tile.APIDownloadedPhoto("profile_ibot.jpg","iBot")}this.tileProfile=tile}{tile=new CCTile3DButton(this);tile.setupText(" ",1,true,true);tile.setTileTexture("editor_tile_background.jpg",function(){self.requestResize()});tile.setColour(gColour.setRGBA(.25,.25,.25,0));tile.setTextColour(gColour.set(1,0));tile.setDrawOrder(205);tile.onRelease.push(function(){self.close();if(self.closeCallback){self.closeCallback()}});this.addTile(tile,0);this.tileAlert=tile}this.menuTiles=[];this.requestResize()};SceneUINotification.prototype.setY=function(y){this.yPosition=y;this.requestResize()};SceneUINotification.prototype.setColour=function(colour){this.colour=colour;this.tileAlert.setColour(colour);this.tileAlert.setColourAlpha(0)};SceneUINotification.prototype.updateControls=function(controls){return this.CCSceneAppUI_updateControls(controls)};SceneUINotification.prototype.resize=function(){this.CCSceneAppUI_resize();if(this.tileAlert){var camera=this.camera;var tile=this.tileAlert;if(this.nickname){tile.setText(this.nickname+": "+this.message)}else{tile.setText(this.message)}tile.setTextHeight(this.height,true);tile.setTileSize(tile.collisionSize.width*1.1,tile.collisionSize.height*1.5);if(this.opened){this.open()}}};SceneUINotification.prototype.open=function(){this.opened=true;var tile;if(this.tileAlert.getTileTextureImage()){var camera=this.camera;var y=camera.targetHeight*.5;if(this.yPosition){y=this.yPosition}if(this.tileProfile){tile=this.tileProfile;tile.setColourAlpha(1,true);tile.setPositionY(y-tile.collisionBounds[1]);tile.setPositionX(-(camera.targetWidth*.5)-tile.collisionSize.width);tile.setTileMovementX(-camera.targetWidth*.5+tile.collisionBounds[0]);tile=this.tileAlert;tile.positionTileBelowY(this.tileProfile)}else{tile=this.tileAlert;tile.setPositionY(y)}tile.setTextColourAlpha(1,true);if(this.colour){tile.setColour(this.colour,true)}else{tile.setColourAlpha(.85,true)}tile.setTextBlinking(true);tile.setPositionX(-(camera.targetWidth*.5)-tile.collisionSize.width);tile.setTileMovementX(-camera.targetWidth*.5+tile.collisionBounds[0])}};SceneUINotification.prototype.close=function(){this.opened=false;var self=this;var tile=this.tileAlert;tile.setTextColourAlpha(0,true);tile.setColourAlpha(0,true,function(){self.deleteLater()});var camera=this.camera;if(camera){tile.translateTileMovementX(-(camera.targetWidth*.5)-tile.collisionSize.width);if(this.tileProfile){tile=this.tileProfile;tile.setTextColourAlpha(0,true);tile.translateTileMovementX(-(camera.targetWidth*.5)-tile.collisionSize.width)}}};function SceneVisualJSEditor(parentScene){this.construct();{this.setParent(parentScene)}gEngine.addScene(this);var self=this;this.sceneUIBack=new SceneUIBack(this,function(){self.close()},true)}ExtendPrototype(SceneVisualJSEditor,CCSceneAppUI);SceneVisualJSEditor.prototype.setup=function(){var self=this;var camera=gEngine.newSceneCamera(this);camera.setupViewport(0,0,1,1);camera.setCameraWidth(640,false);{var tile=new CCTile3DButton(self);tile.setupTile();tile.setTileTexture("editor_tile_background.jpg");tile.setColour(gColour.set(.5,0));tile.setColourAlpha(.95,true);tile.setDrawOrder(200);this.cameraStickyTiles.add(tile);this.tileBackground=tile}this.jsClasses=[];self.requestResize()};SceneVisualJSEditor.prototype.updateScene=function(delta){var updated=this.CCSceneAppUI_updateScene(delta);return updated};SceneVisualJSEditor.prototype.render=function(camera,pass,alpha){this.CCSceneAppUI_render(camera,pass,alpha)};SceneVisualJSEditor.prototype.resize=function(){this.CCSceneAppUI_resize();var camera=this.camera;var tile;{tile=this.tileBackground;tile.setTileSize(camera.targetWidth,camera.targetHeight)}var y=0;var jsClasses=this.jsClasses;for(var classIndex=0;classIndex<jsClasses.length;++classIndex){var jsClass=jsClasses[classIndex];tile=jsClass.tile;if(classIndex>0){y-=tile.collisionBounds[1]}tile.setPositionY(y);y-=tile.collisionBounds[1];y-=5;var prototypes=jsClass.prototypes;for(var prototypeIndex=0;prototypeIndex<prototypes.length;++prototypeIndex){var jsPrototype=prototypes[prototypeIndex];tile=jsPrototype.tile;y-=tile.collisionBounds[1];tile.setPositionY(y);var x=tile.collisionBounds[0];var parameters=jsPrototype.parameters;for(var parameterIndex=0;parameterIndex<parameters.length;++parameterIndex){x+=5;var jsParameter=parameters[parameterIndex];tile=jsParameter.tile;x+=tile.collisionBounds[0];tile.setPositionXY(x,y);x+=tile.collisionBounds[0]}y-=tile.collisionBounds[1];var lines=jsPrototype.lines;for(var lineIndex=0;lineIndex<lines.length;++lineIndex){var jsLine=lines[lineIndex];x=0;y-=15;var tokens=jsLine.tokens;for(var tokenIndex=0;tokenIndex<tokens.length;++tokenIndex){var jsToken=tokens[tokenIndex];tile=jsToken.tile;x+=tile.collisionBounds[0];tile.setPositionXY(x,y);x+=tile.collisionBounds[0];x+=5}}y-=15}y-=30}};SceneVisualJSEditor.prototype.touchPressed=function(touch){if(this.CCSceneAppUI_touchPressed(touch)){return true}return true};SceneVisualJSEditor.prototype.touchMoving=function(touch,touchDelta){return this.CCSceneAppUI_touchMoving(touch,touchDelta)};SceneVisualJSEditor.prototype.touchReleased=function(touch,touchAction){return this.CCSceneAppUI_touchReleased(touch,touchAction)};SceneVisualJSEditor.prototype.refreshCameraView=function(){var left=CC_MAXFLOAT;var right=-CC_MAXFLOAT;var top=-CC_MAXFLOAT;var bottom=CC_MAXFLOAT;var tiles=this.tiles;for(var i=0;i<tiles.length;++i){var tile=tiles[i];var leftX=tile.getTileMovementTarget()[0]-tile.collisionBounds[0];var rightX=tile.getTileMovementTarget()[0]+tile.collisionBounds[0];var topY=tile.getTileMovementTarget()[1]+tile.collisionBounds[1];var bottomY=tile.getTileMovementTarget()[1]-tile.collisionBounds[1];if(leftX<left){left=leftX}if(rightX>right){right=rightX}if(topY>top){top=topY}if(bottomY<bottom){bottom=bottomY}}var camera=this.camera;this.sceneLeft=left+camera.targetWidth*.4;this.sceneRight=right;this.sceneTop=top-camera.targetHeight*.4;this.sceneBottom=bottom;if(this.sceneBottom>this.sceneTop){this.sceneBottom=this.sceneTop}};SceneVisualJSEditor.prototype.lockCameraView=function(){if(this.cameraScrolling){return}var camera=this.camera;if(camera.targetLookAt[0]<this.sceneLeft){camera.targetLookAt[0]=this.sceneLeft;camera.flagUpdate()}if(camera.targetLookAt[0]>this.sceneRight){camera.targetLookAt[0]=this.sceneRight;camera.flagUpdate()}if(camera.targetLookAt[1]>this.sceneTop){camera.targetLookAt[1]=this.sceneTop;camera.flagUpdate()}if(camera.targetLookAt[1]<this.sceneBottom){camera.targetLookAt[1]=this.sceneBottom;camera.flagUpdate()}};SceneVisualJSEditor.prototype.open=function(filename,onClose){this.onClose=onClose;var self=this;var camera=this.camera;AlertsManager.ModalAlert("loading...");var url=MultiplayerManager.GetAssetURL(filename);gURLManager.requestURL(url,null,function(status,responseText){if(status>=CCURLRequest.Succeeded&&responseText&&responseText.length>0){self.parseJS(responseText)}else{AlertsManager.Hide("loading...");AlertsManager.TimeoutAlert("failed to load :(",2);self.close()}},0,filename,-1,0)};SceneVisualJSEditor.prototype.parseJS=function(jsData){var jsClasses=this.jsClasses;var startIndex,j,character;var jsPrototypes=jsData.split(".prototype.");for(var prototypeIndex=1;prototypeIndex<jsPrototypes.length;++prototypeIndex){var jsClassName=jsPrototypes[prototypeIndex-1];{startIndex=0;for(j=jsClassName.length-1;j>=0;--j){character=jsClassName[j];if(/[^a-zA-Z0-9]/.test(character)){startIndex=j+1;break}}jsClassName=jsClassName.substr(startIndex,jsClassName.length)}var jsClass=this.findJSClass(jsClassName);if(!jsClass){jsClass={};jsClass.name=jsClassName;jsClass.prototypes=[];jsClasses.push(jsClass)}var jsPrototypeName=jsPrototypes[prototypeIndex];jsPrototypeName=String.SplitBefore(jsPrototypeName," ");jsPrototypeName=String.SplitBefore(jsPrototypeName,"=");jsPrototypeName=String.SplitBefore(jsPrototypeName,"\n");jsPrototype={};jsPrototype.name=jsPrototypeName;jsClass.prototypes.add(jsPrototype);jsPrototype.parameters=[];var jsParameters=jsPrototypes[prototypeIndex];jsParameters=String.SplitAfter(jsParameters,"(");jsParameters=String.SplitBefore(jsParameters,")");if(jsParameters.length>0){var parametersSplit=jsParameters.split(",");for(parameterIndex=0;parameterIndex<parametersSplit.length;++parameterIndex){var jsParmaterName=parametersSplit[parameterIndex];jsParmaterName.replace(" ","");if(jsParmaterName.length===0){jsParmaterName=" "}jsParameter={};jsParameter.name=jsParmaterName;jsPrototype.parameters.push(jsParameter)}}jsPrototype.lines=[];var code=jsPrototypes[prototypeIndex];code=String.SplitAfter(code,"{");code=String.SplitBefore(code,"}");var lines=code.split(";");for(var lineIndex=0;lineIndex<lines.length;++lineIndex){var line=lines[lineIndex];startIndex=-1;for(j=0;j<line.length;++j){character=line[j];if(/^[a-zA-Z0-9]/.test(character)){startIndex=j;break}}if(startIndex>=0){line=line.substr(startIndex);var jsLine={};jsLine.line=line;jsLine.tokens=[];jsPrototype.lines.push(jsLine);var parsingToken=false;var tokenType=null;for(j=0;j<line.length;++j){character=line[j];if(/^[a-zA-Z0-9]/.test(character)){if(!parsingToken){parsingToken=true;startIndex=j}}else{if(!parsingToken){if(character==="*"||character==="/"||character==="%"||character==="="){parsingToken=true;
startIndex=j}}else{if(character==="["){tokenType="array"}if(character==="."||character==="_"){}else{parsingToken=false;this.packageToken(jsLine.tokens,line,startIndex,j,tokenType)}}}}if(parsingToken){parsingToken=false;this.packageToken(jsLine.tokens,line,startIndex,line.length,tokenType)}}}}this.createJSTiles();this.requestResize();AlertsManager.Hide("loading...")};SceneVisualJSEditor.prototype.packageToken=function(tokensArray,codeLine,startIndex,endIndex,tokenType){var tokenName=codeLine.substr(startIndex,endIndex-startIndex);var jsToken={};jsToken.name=tokenName;tokensArray.push(jsToken);if(tokenType){jsToken.type=tokenType}};SceneVisualJSEditor.prototype.createJSTiles=function(){var jsClasses=this.jsClasses;var tile;for(var classIndex=0;classIndex<jsClasses.length;++classIndex){var jsClass=jsClasses[classIndex];tile=new CCTile3DButton(this);tile.setupText(jsClass.name,20,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.setColour(gColour.setRGBA(.5,.65,1,1));tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(210);this.addTile(tile);jsClass.tile=tile;var prototypes=jsClass.prototypes;for(var prototypeIndex=0;prototypeIndex<prototypes.length;++prototypeIndex){var jsPrototype=prototypes[prototypeIndex];tile=new CCTile3DButton(this);tile.setupText(jsPrototype.name,15,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.setColour(EditorManager.LightGreen);tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(210);this.addTile(tile);jsPrototype.tile=tile;var parameters=jsPrototype.parameters;for(var parameterIndex=0;parameterIndex<parameters.length;++parameterIndex){var jsParameter=parameters[parameterIndex];tile=new CCTile3DButton(this);tile.setupText(jsParameter.name,15,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.setColour(gColour.setRGBA(.75,.75,.15,1));tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(210);this.addTile(tile);jsParameter.tile=tile}var lines=jsPrototype.lines;for(var lineIndex=0;lineIndex<lines.length;++lineIndex){var jsLine=lines[lineIndex];var tokens=jsLine.tokens;for(var tokenIndex=0;tokenIndex<tokens.length;++tokenIndex){var jsToken=tokens[tokenIndex];tile=new CCTile3DButton(this);tile.setupText(jsToken.name,15,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.setColour(gColour.setRGBA(.65,.75,1,1));tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(210);this.addTile(tile);jsToken.tile=tile}}}}this.requestResize()};SceneVisualJSEditor.prototype.findJSClass=function(className){var jsClasses=this.jsClasses;for(var i=0;i<jsClasses.length;++i){var jsClass=jsClasses[i];if(jsClass.name===className){return jsClass}}return null};SceneVisualJSEditor.prototype.close=function(){var self=this;this.tileBackground.setColourAlpha(0,true);var camera=this.camera;var tile=this.tileBackground;tile.setColourAlpha(0,true,function(){self.deleteLater()});self.sceneUIBack.close();if(this.onClose){this.onClose()}};function SceneJSMapEditor(parentScene){this.construct();this.setParent(parentScene);this.cameraCentered=true;gEngine.addScene(this);var self=this;this.onDragDropLoadFunction=function(file,event){self.onDragDropLoad(file,event)};gEngine.controls.onDragDropLoad.add(this.onDragDropLoadFunction);this.jsData="";this.jsClassPrototypes=[];this.map=new SceneGameBattleRoyale(null)}ExtendPrototype(SceneJSMapEditor,CCSceneAppUI);SceneJSMapEditor.prototype.deleteLater=function(){if(this.onDragDropLoadFunction){gEngine.controls.onDragDropLoad.remove(this.onDragDropLoadFunction);this.onDragDropLoadFunction=null}this.CCSceneAppUI_deleteLater()};SceneJSMapEditor.prototype.setup=function(){var self=this;var camera=gEngine.newSceneCamera(this);camera.setupViewport(0,0,1,1);camera.setCameraWidth(640,false);var tile;{tile=new CCTile3DButton(this);tile.setupTile(camera.targetWidth,camera.targetHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColour(gColour.set(.25,0));tile.setColourAlpha(.5,true);tile.setDrawOrder(204);this.cameraStickyTiles.add(tile);this.tileBackground=tile}{tile=new CCTile3DButton(this);tile.setupText(" ",1,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.setColour(gColour.setRGBA(.5,.65,1,0));tile.setTextColour(gColour.setRGBA(1,1,1,0));tile.setDrawOrder(210);this.tileAlert=tile}{tile=new CCTile3DButton(this);tile.setupTile(1);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setDrawOrder(210);this.tileModel=tile}this.menuTiles=[];this.requestResize()};SceneJSMapEditor.prototype.updateScene=function(delta){var updated=this.CCSceneAppUI_updateScene(delta);return updated};SceneJSMapEditor.prototype.render=function(camera,pass,alpha){this.CCSceneAppUI_render(camera,pass,alpha)};SceneJSMapEditor.prototype.resize=function(){this.CCSceneAppUI_resize();var camera=this.camera;var tile;{tile=this.tileModel;tile.setTileSize(camera.targetHeight*.65,camera.targetHeight*.65);if(!this.supportObj){if(tile.getTileTextureImage()){tile.setTileTexturedHeight(tile.collisionSize.height)}}}{tile=this.tileAlert;tile.setTileSize(camera.targetWidth,camera.targetHeight*.15);tile.setTextHeight(tile.collisionBounds[1]);tile.positionTileAbove(this.tileModel)}{this.tileBackground.setTileSize(camera.targetWidth,camera.targetHeight)}var menuTiles=this.menuTiles;for(var i=0;i<menuTiles.length;++i){tile=menuTiles[i];if(i===0){tile.setPositionXYZ(camera.cameraHWidth-tile.collisionBounds[0],camera.cameraHHeight-tile.collisionBounds[1],0)}else{tile.positionTileBelow(menuTiles[i-1])}}};SceneJSMapEditor.prototype.touchPressed=function(touch){var result=this.CCSceneAppUI_touchPressed(touch);return true};SceneJSMapEditor.prototype.touchMoving=function(touch,touchDelta){var result=this.handleTilesTouch(touch,this.controlsMovingVertical?CCControls.touch_movingVertical:CCControls.touch_movingHorizontal);if(result===CCSceneAppUI.tile_touchAction){return true}return true};SceneJSMapEditor.prototype.touchReleased=function(touch,touchAction){var result=this.CCSceneAppUI_touchReleased(touch,touchAction);return true};SceneJSMapEditor.prototype.open=function(){this.message=".js Map Editor";var self=this;var camera=this.camera;var i;var menuTiles=this.menuTiles;for(i=0;i<menuTiles.length;++i){menuTiles[i].deleteLater()}menuTiles.length=0;{{tile=new CCTile3DButton(this);tile.setupTexturedWidth(camera.cameraWidth*.1,"editor_tile_cross.jpg",function(){self.showMenu()});tile.setColour(gColour.setRGBA(1,1,1,0));tile.setDrawOrder(220);tile.onRelease.push(function(){if(self.closeCallback){self.closeCallback(false)}self.close()});this.addTile(tile,0);menuTiles.add(tile)}{tile=new CCTile3DButton(this);tile.setupTexturedWidth(camera.cameraWidth*.1,"editor_tile_tick.jpg",function(){self.showMenu()});tile.setColour(gColour.setRGBA(1,1,1,0));tile.setDrawOrder(220);tile.onRelease.push(function(){if(self.closeCallback){self.closeCallback(true,self.jsData)}self.close()});this.addTile(tile,0);menuTiles.add(tile)}}this.showMenu()};SceneJSMapEditor.prototype.showMenu=function(){if(this.enabled){var camera=this.camera;var menuTiles=this.menuTiles;this.requestResize();var tile;{tile=this.tileModel;tile.setColourAlpha(0,true);tile.setPositionX(camera.targetWidth*.5+tile.collisionSize.width);tile.setTileMovementX(0)}{tile=this.tileAlert;tile.setTextColourAlpha(1,true);tile.setColourAlpha(.85,true);tile.setText(this.message);tile.setPositionX(camera.targetWidth*.5+tile.collisionSize.width);tile.setTileMovementX(0)}for(var i=0;i<menuTiles.length;++i){tile=menuTiles[i];tile.setPositionX(camera.targetWidth*.5+tile.collisionSize.width);tile.translateTileMovementX(-tile.collisionSize.width*1.5);tile.setColourAlpha(1,true);tile.enabled=true}}};SceneJSMapEditor.prototype.close=function(){var self=this;var i;{var head=document.getElementsByTagName("head")[0];var script=document.getElementById("customjs");if(script){head.removeChild(script)}var jsClassPrototypes=this.jsClassPrototypes;for(i=0;i<jsClassPrototypes.length;++i){var classPrototype=jsClassPrototypes[i];var targetClass=window[classPrototype.name];for(var m in classPrototype.prototypes){targetClass.prototype[m]=classPrototype.prototypes[m]}}}this.tileBackground.setColourAlpha(0,true);var tile;{tile=this.tileModel;tile.setColourAlpha(0,true)}{tile=this.tileAlert;tile.setTextColourAlpha(0,true);tile.setColourAlpha(0,true,function(){self.deleteLater()})}var camera=this.camera;tile.translateTileMovementX(-(camera.targetWidth*.5)-tile.collisionSize.width);var menuTiles=this.menuTiles;for(i=0;i<menuTiles.length;++i){tile=menuTiles[i];tile.translateTileMovementX(camera.targetWidth*.5+tile.collisionSize.width);tile.setColour(gColour.setRGBA(1,1,1,0),true);tile.enabled=false}if(this.map){this.map.deleteLater()}};SceneJSMapEditor.prototype.setCallback=function(callback){this.closeCallback=callback};SceneJSMapEditor.prototype.onDragDropLoad=function(file,event){if(event&&event.target&&event.target.result){if(MultiplayerManager.LoggedIn){if(file.size>1024*1024){AlertsManager.TimeoutAlert("file size too large",2)}else{var filename=file.name;var data=event.target.result;this.prepareUpload(filename,data)}}}};SceneJSMapEditor.prototype.prepareUpload=function(filename,data){var self=this;var fileExtension=filename.getExtension();if(fileExtension==="js"){this.jsData+=data+"\n";var jsClassPrototypes=this.jsClassPrototypes;var prototypes=data.split(".prototype.");for(var i=1;i<prototypes.length;++i){var className=prototypes[i-1];var classNameStartIndex=0;for(var j=className.length-1;j>=0;--j){var character=className[j];if(/[^a-zA-Z0-9]/.test(character)){classNameStartIndex=j+1;break}}className=className.substr(classNameStartIndex,className.length);var found=false;var classPrototype;for(var classIndex=0;i<jsClassPrototypes.length;++i){classPrototype=jsClassPrototypes[classIndex];if(className===classPrototype.name){found=true;break}}if(!found){classPrototype={};classPrototype.name=className;classPrototype.prototypes=[];var sourceClass=window[className];for(var m in sourceClass.prototype){classPrototype.prototypes[m]=sourceClass.prototype[m]}jsClassPrototypes.push(classPrototype)}}var script=document.getElementById("customjs");if(!script){var head=document.getElementsByTagName("head")[0];script=document.createElement("script");script.id="customjs";head.appendChild(script)}script.type="text/javascript";script.text=data}else{AlertsManager.TimeoutAlert("only .js supported",2)}};SceneJSMapEditor.prototype.upload=function(filename,data){var self=this;EditorManager.EditorUploadJS(filename,data,function(fileID,filename){var uploaded=false;if(filename){if(MultiplayerManager.LoggedIn){}}if(!uploaded){AlertsManager.TimeoutAlert("failed to upload "+fileID+" :(",2)}})};function SceneAssetEditor(parentScene,supportObj,showLists,noSelect){MultiplayerManager.UpdateCallbacks.addOnce(this);this.construct();this.supportObj=supportObj;this.noSelect=noSelect;if(parentScene){this.setParent(parentScene);parentScene.linkScene(this)}this.cameraCentered=true;gEngine.addScene(this);var self=this;this.onDragDropLoadFunction=function(file,event){self.onDragDropLoad(file,event)};gEngine.controls.onDragDropLoad.add(this.onDragDropLoadFunction);if(showLists){if(supportObj){this.sceneUIListDBModels=new SceneUIListDBModels(this,function(){if(CCEngine.IsMobile()){AlertsManager.TimeoutAlert("Please visit playir.com to upload assets",10)}else{self.creatingNewModel=true;AlertsManager.Alert("drop in .fbx or .obj model",function(){self.creatingNewModel=false})}});this.sceneUIListDBModels.onSelected=function(info){if(info){self.setModel(info)}}}else{this.sceneUIListDBImages=new SceneUIListDBImages(this);this.sceneUIListDBImages.onSelected=function(imageInfo){if(self.onSelected){self.onSelected(imageInfo)}else{self.setImage(imageInfo)}}}}this.info={};this.sceneSettings=new SceneAssetEditorSettings(this);CCEngine.EnableBackButton(this);SceneAssetEditor.self=this}ExtendPrototype(SceneAssetEditor,CCSceneAppUI);SceneAssetEditor.prototype.deleteLater=function(){SceneAssetEditor.self=null;if(this.onDragDropLoadFunction){gEngine.controls.onDragDropLoad.remove(this.onDragDropLoadFunction);this.onDragDropLoadFunction=null}if(this.sceneUIListDBModels){this.sceneUIListDBModels.close();this.sceneUIListDBModels=null}if(this.sceneUIListDBImages){this.sceneUIListDBImages.close();this.sceneUIListDBImages=null}if(this.sceneSettings){this.sceneSettings.deleteLater();this.sceneSettings=null}this.CCSceneAppUI_deleteLater()};SceneAssetEditor.prototype.setup=function(){var self=this;var camera=gEngine.newSceneCamera(this);camera.setupViewport(0,0,1,1);camera.setCameraWidth(640,false);var tile;{tile=new CCTile3DButton(this);tile.setupTile(camera.targetWidth,camera.targetHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColour(gColour.set(.25,0));tile.setColourAlpha(.95,true);tile.setDrawOrder(204);this.cameraStickyTiles.add(tile);this.tileBackground=tile}{tile=new CCTile3DButton(this);tile.setupText(" ",1,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.setColour(gColour.setRGBA(.5,.65,1,0));tile.setTextColour(gColour.setRGBA(1,1,1,0));tile.setPositionX(camera.targetWidth*.5+tile.collisionSize.width);tile.setDrawOrder(210);this.tileAlert=tile}{tile=new CCTile3DButton(this);tile.setupTile(1);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setPositionY(-(camera.targetHeight*.5)-tile.collisionSize.height);tile.setDrawOrder(210);this.tileModel=tile}this.menuTiles=[];this.bottomTiles=[];this.requestResize()};SceneAssetEditor.prototype.syncUpdate=function(jsonData){if(jsonData.EditorModelCreated){if(this.onClose){var id=jsonData.EditorModelCreated;DBAssets.RemoveDBID(id);this.info.objectID=id;this.onClose(this.info);this.close()}}};SceneAssetEditor.prototype.updateScene=function(delta){var updated=this.CCSceneAppUI_updateScene(delta);var tile=this.tileModel;if(tile.modelObject){tile.modelObject.model.animate(delta)}return updated};SceneAssetEditor.prototype.resize=function(){this.CCSceneAppUI_resize();var camera=this.camera;var i,tile;var idealAspectRatio=1.5;var aspectRatioAdjutment=camera.getAspectRatio()<1.25?camera.getAspectRatio()/idealAspectRatio:1;{tile=this.tileModel;var modelSize=camera.targetHeight*.65*aspectRatioAdjutment;tile.setTileSize(modelSize);if(!this.supportObj){if(tile.getTileTextureImage()){tile.setTileTexturedFit(tile.collisionSize.height,tile.collisionSize.height)}}}{tile=this.tileAlert;tile.setTileSize(camera.targetWidth,camera.targetHeight*.15);tile.setTextHeight(tile.collisionBounds[1]);var targetPosition=tile.getTileMovementTarget();targetPosition[1]=camera.targetHeight*.5-tile.collisionBounds[1];tile.setPosition(targetPosition)}{this.tileBackground.setTileSize(camera.targetWidth,camera.targetHeight)}var y=camera.cameraHHeight;var menuTiles=this.menuTiles;for(i=0;i<menuTiles.length;++i){tile=menuTiles[i];var x=tile.getTileMovementTarget()[0];y-=tile.collisionBounds[1];tile.setPositionY(y);y-=tile.collisionBounds[1];tile.setTileMovementX(x)}var bottomTiles=this.bottomTiles;var tileHeight=camera.targetHeight*.075;for(i=0;i<bottomTiles.length;++i){tile=bottomTiles[i];tile.setTileSize(tileHeight);if(i===0){tile.setPositionX(camera.cameraHWidth-tile.collisionBounds[0])}else{tile.positionTileLeftX(bottomTiles[i-1])}}this.showControls(false)};SceneAssetEditor.prototype.touchPressed=function(touch){var result=this.CCSceneAppUI_touchPressed(touch);return true};SceneAssetEditor.prototype.touchMoving=function(touch,touchDelta){var result=this.handleTilesTouch(touch,this.controlsMovingVertical?CCControls.touch_movingVertical:CCControls.touch_movingHorizontal);if(result===CCSceneAppUI.tile_touchAction){return true}else{var tile=this.tileModel;if(tile.modelObject){var x=touch.deltaX;var y=touch.deltaY;var camera=this.camera;var rotation=tile.modelObject.rotation;rotation[1]+=x*180;tile.modelObject.setRotationY(rotation[1]);rotation[0]+=y*180;tile.modelObject.setRotationX(rotation[0]);return true}}return true};SceneAssetEditor.prototype.touchReleased=function(touch,touchAction){var result=this.CCSceneAppUI_touchReleased(touch,touchAction);return true};SceneAssetEditor.prototype.open=function(message){this.message=message;var self=this;var camera=this.camera;var i,tile;var menuTiles=this.menuTiles;for(i=0;i<menuTiles.length;++i){menuTiles[i].deleteLater()}menuTiles.length=0;{{tile=new CCTile3DButton(this);tile.setupTexturedWidth(camera.cameraWidth*.1,"editor_tile_back.jpg",function(tile){tile.setPositionX(camera.targetWidth*.5+tile.collisionBounds[0]);self.showMenu()});tile.setColour(gColour.setRGBA(1,1,1,0));tile.setDrawOrder(220);tile.onRelease.push(function(){self.handleBackButton()});this.addTile(tile,0);menuTiles.add(tile)}{tile=new CCTile3DButton(this);tile.setupTexturedWidth(camera.cameraWidth*.1,"editor_tile_tick.jpg",function(tile){tile.setPositionX(camera.targetWidth*.5+tile.collisionBounds[0]);self.showMenu()});tile.setColour(gColour.setRGBA(1,1,1,0));tile.setDrawOrder(220);tile.onRelease.push(function(){if(self.reExportFBXModel()){}else{self.onTick()}});this.addTile(tile,0);this.tileTick=tile;menuTiles.add(tile)}}this.showMenu()};SceneAssetEditor.prototype.showMenu=function(){if(this.enabled){this.requestResize();var camera=this.camera;var menuTiles=this.menuTiles;var i,tile;if(this.info.tex||this.info.obj){{tile=this.tileAlert;tile.setTextColourAlpha(1,true);tile.setColourAlpha(.5,true);tile.setText(this.message);tile.setTileMovementX(0)}{tile=this.tileModel;if(tile.modelObject){tile.setColourAlpha(.5,true)}else{tile.setColourAlpha(1,true)}tile.setTileMovementY(0)}}for(i=0;i<menuTiles.length;++i){tile=menuTiles[i];var show=true;if(tile===this.tileTick){if(this.assetDirty){}else if(this.reExportModel){}else if(this.noSelect){show=false}}if(show){tile.setTileMovementX(camera.targetWidth*.5-tile.collisionBounds[0]);tile.setColourAlpha(1,true);tile.enabled=true}else{tile.setTileMovementX(camera.targetWidth*.5+tile.collisionBounds[0]);tile.setColourAlpha(0,true);tile.enabled=false}}this.showControls()}};SceneAssetEditor.prototype.openControls=function(){var i;var bottomTiles=this.bottomTiles;for(i=0;i<bottomTiles.length;++i){bottomTiles[i].deleteLater()}bottomTiles.length=0;if(this.info.objectID){var self=this;var camera=this.camera;var LoadedImageFunction=function(tile){return function(){tile.setPositionY(-camera.cameraHHeight-tile.collisionBounds[1]);self.showControls()}};var tile;if(MultiplayerManager.IsOwner(this.info.owners)){tile=new CCTile3DButton(this);tile.setupTextured("editor_icon_delete.jpg",new LoadedImageFunction(tile));tile.setColour(EditorManager.Red);tile.setDrawOrder(220);tile.onRelease.push(function(){if(MultiplayerManager.LoggedIn){if(self.supportObj){AlertsManager.ConfirmationAlert("Delete model?",function(result){if(result){if(MultiplayerManager.LoggedIn){EditorManager.EditorDeleteModel(self.info)}self.info={};var tile=self.tileModel;tile.deleteLater();{tile=new CCTile3DButton(self);tile.setupTile(1);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setDrawOrder(210);self.tileModel=tile}self.openControls();if(self.sceneSettings){self.sceneSettings.close()}if(self.onDeleted){self.onDeleted()}else{self.close()}}})}else{AlertsManager.ConfirmationAlert("Delete image?",function(result){if(result){if(MultiplayerManager.LoggedIn){EditorManager.EditorDeleteImage(self.info)}self.info={};var tile=self.tileModel;tile.deleteLater();{tile=new CCTile3DButton(self);tile.setupTile(1);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setDrawOrder(210);self.tileModel=tile}self.openControls();if(self.sceneSettings){self.sceneSettings.close()}}})}}});this.addTile(tile,0);bottomTiles.add(tile)}this.showControls()}};SceneAssetEditor.prototype.showControls=function(resizeRequired){if(this.enabled){if(resizeRequired===undefined){resizeRequired=true}if(resizeRequired){this.requestResize()}var camera=this.camera;var bottomTiles=this.bottomTiles;var i,tile;for(i=0;i<bottomTiles.length;++i){tile=bottomTiles[i];var targetY=-camera.targetHeight*.5+tile.collisionBounds[1];if(tile.position[1]>targetY){tile.setPositionY(targetY)}else{tile.setTileMovementY(targetY)}tile.setColourAlpha(1,true);tile.enabled=true}}};SceneAssetEditor.prototype.openModelSettings=function(model){if(this.sceneSettings){this.sceneSettings.openModelSettings(model)}};SceneAssetEditor.prototype.openImageSettings=function(filename){if(this.sceneSettings){this.sceneSettings.openImageSettings(filename)}};SceneAssetEditor.prototype.close=function(){if(this.sceneUIListDBModels){this.sceneUIListDBModels.close();this.sceneUIListDBModels=null}var self=this;var camera=this.camera;this.tileBackground.setColourAlpha(0,true);var tile;{tile=this.tileAlert;tile.setTextColourAlpha(0,true);tile.setColourAlpha(0,true,function(){self.deleteLater()});tile.translateTileMovementX(-(camera.targetWidth*.5)-tile.collisionSize.width)}{tile=this.tileModel;tile.setColourAlpha(0,true);tile.setTileMovementY(-(camera.targetHeight*.5)-tile.collisionSize.height)}var menuTiles=this.menuTiles;for(i=0;i<menuTiles.length;++i){tile=menuTiles[i];tile.translateTileMovementX(camera.targetWidth*.5+tile.collisionSize.width);tile.setColour(gColour.setRGBA(1,1,1,0),true);tile.enabled=false}var bottomTiles=this.bottomTiles;for(i=0;i<bottomTiles.length;++i){tile=bottomTiles[i];tile.translateTileMovementY(-tile.collisionSize.height);tile.setColourAlpha(0,true)}if(this.sceneSettings){this.sceneSettings.close()}};SceneAssetEditor.prototype.setCulling=function(noCulling){var tile=this.tileModel;if(tile.modelObject){tile.modelObject.setCulling(!noCulling)}this.sceneSettings.setCulling(noCulling);if(this.info.noCulling!==noCulling){this.info.noCulling=noCulling;this.updatedInfo()}};SceneAssetEditor.prototype.setAnimationFPSCompression=function(ratio){if(ratio>0&&ratio<10){var tile=this.tileModel;if(tile.modelObject){var model=tile.modelObject.model;if(model){var info=this.info;if(info.sourceObj){var currentRatio=model.getAnimationFPSCompression();if(ratio!==currentRatio){var sourceFBX=info.sourceObj;var filenameSplit=sourceFBX.split("_");var filename=filenameSplit[0];filename+=".";filename+=filenameSplit[filenameSplit.length-1];this.convertFBX(filename,sourceFBX,ratio)}}}}}else{AlertsManager.TimeoutAlert("please select value between 1 - 9",2)}};SceneAssetEditor.prototype.setModelReExport=function(toggle){var tile=this.tileTick;if(toggle){if(!this.reExportModel){this.reExportModel=true;tile.setTileTexture("editor_tile_refresh.jpg");this.showMenu()}}else{if(this.reExportModel){this.reExportModel=false;tile.setTileTexture("editor_tile_tick.jpg");this.showMenu()}}};SceneAssetEditor.prototype.setAnimation=function(index){var tile=this.tileModel;if(tile.modelObject){var model=tile.modelObject.model;if(model){if(model.getAnimation()!==index){model.setAnimation(index);this.openModelSettings(model)}}}};SceneAssetEditor.prototype.deleteAnimation=function(animationName){var tile=this.tileModel;if(tile.modelObject){var model=tile.modelObject.model;if(model){var primitive=model.primitive;if(primitive){if(primitive.deleteAnimation(animationName)){this.setModelReExport(true);AlertsManager.Notification("editor","deleted "+animationName,null,2,EditorManager.LightRed);this.openModelSettings(model)}}}}};SceneAssetEditor.prototype.toggleAnimationFrame=function(index){var tile=this.tileModel;if(tile.modelObject){var model=tile.modelObject.model;if(model){model.toggleAnimationFrame(index);this.openModelSettings(model)}}};SceneAssetEditor.prototype.moveAnimationFrame=function(oldIndex,newIndex){var tile=this.tileModel;if(tile.modelObject){var model=tile.modelObject.model;if(model){var primitive=model.primitive;if(primitive){if(primitive.moveAnimationFrame(oldIndex,newIndex)){this.setModelReExport(true);AlertsManager.Notification("editor","moved frame "+(oldIndex+1),null,2,EditorManager.LightRed);primitive.toggleAnimationFrame(newIndex);this.openModelSettings(model)}}}}};SceneAssetEditor.prototype.deleteAnimationFrame=function(index){var tile=this.tileModel;if(tile.modelObject){var model=tile.modelObject.model;if(model){var primitive=model.primitive;if(primitive){if(primitive.deleteAnimationFrame(index)){this.setModelReExport(true);AlertsManager.Notification("editor","deleted frame "+(index+1),null,2,EditorManager.LightRed);primitive.toggleAnimationFrame(index);this.openModelSettings(model)}}}}};SceneAssetEditor.prototype.toggleSubmodel=function(submodelName){if(this.tileModel){if(this.tileModel.modelObject){var model=this.tileModel.modelObject.model;if(model){var primitive=model.primitive;if(primitive){primitive.toggleSubmodel(submodelName);this.openModelSettings(model)}}}}};SceneAssetEditor.prototype.deleteSubmodel=function(submodelName){if(this.tileModel){if(this.tileModel.modelObject){var model=this.tileModel.modelObject.model;if(model){var primitive=model.primitive;if(primitive){if(primitive.deleteSubmodel(submodelName)){this.setModelReExport(true);this.reExportFBXModel()}}}}}};SceneAssetEditor.prototype.setModel=function(sourceInfo){this.info.objectID=sourceInfo.objectID;this.info.owners=sourceInfo.owners;this.info.obj=sourceInfo.obj;this.info.sourceObj=sourceInfo.sourceObj;this.info.tex=sourceInfo.tex;this.info.noCulling=sourceInfo.noCulling;if(this.info.obj){this.setAsset(this.info.obj,true)}if(this.info.tex){this.setAsset(this.info.tex,true)}if(this.info.noCulling!==undefined){this.setCulling(this.info.noCulling)}if(MultiplayerManager.IsOwner(this.info.owners)){this.updatedInfo(true);this.tileTick.setTileTexture("editor_tile_tick.jpg")}else{this.updatedInfo(false);this.tileTick.setTileTexture("editor_tile_copy.jpg")}this.openControls()};SceneAssetEditor.prototype.setImage=function(sourceInfo){this.info=CC.DeepCopy(sourceInfo);if(this.info.tex){this.setAsset(this.info.tex,true)}this.openControls()};SceneAssetEditor.prototype.removeTexture=function(){var info=this.info;var tile=this.tileModel;info.tex=null;tile.removeTileTexture();if(tile.modelObject){var model3d=tile.modelObject.model;model3d.removeTexture()}if(this.sceneSettings){this.sceneSettings.close()}};SceneAssetEditor.prototype.setAsset=function(filename,calledFromList){if(filename){var self=this;var info=this.info;var tile=this.tileModel;var fileExtension=filename.getExtension();if(fileExtension==="png"||fileExtension==="jpg"){info.tex=filename;this.updatedInfo(calledFromList);if(tile.modelObject){var model3d=tile.modelObject.model;model3d.setTexture(info.tex)}gEngine.textureManager.getTextureHandle(info.tex,function(textureHandle){if(textureHandle&&textureHandle.image){if(!self.supportObj){self.openImageSettings(info.tex);tile.setTileTexture(info.tex)}self.showMenu()}});if(!calledFromList){if(this.sceneUIListDBModels){this.sceneUIListDBModels.findAndSelect(info)}else if(this.sceneUIListDBImages){this.sceneUIListDBImages.findAndSelect(info.tex)}}return true}else if(this.supportObj){if(fileExtension==="fbx"){info.sourceObj=filename}else if(fileExtension==="obj"){if(info.sourceObj){delete info.sourceObj}}if(fileExtension==="obj"||fileExtension==="fbxi"){this.setModelReExport(false);info.obj=filename;this.updatedInfo(calledFromList);if(!calledFromList){if(info.tex&&this.sceneUIListDBModels){this.sceneUIListDBModels.findAndSelect(info)}}AlertsManager.Alert("updating...");CCModel3D.CacheModel(info.obj,true,function(model3d){AlertsManager.Hide("updating...");if(model3d){if(!tile.modelObject){var modelObject=new CCObject;tile.addChild(modelObject);modelObject.setColour(gColour.set(1,1));modelObject.setTransparent();tile.modelObject=modelObject;self.showMenu()}tile.modelObject.setModel(model3d);self.openModelSettings(model3d);tile.modelObject.setRotationX(0);tile.modelObject.setRotationY(0);{var size=tile.collisionSize.width*.75;var scaleFactor;var modelWidth=model3d.getWidth()>model3d.getDepth()?model3d.getWidth():model3d.getDepth();var modelHeight=model3d.getHeight();if(modelWidth>modelHeight){scaleFactor=size/modelWidth}else{scaleFactor=size/modelHeight}model3d.setScale(scaleFactor);if(info.tex){model3d.setTexture(info.tex)}}}},2);return true}}}return false};SceneAssetEditor.prototype.updatedInfo=function(reset){if(reset){if(this.assetDirty){this.assetDirty=false}}else{if(!this.assetDirty){this.assetDirty=true}}this.showMenu()};SceneAssetEditor.prototype.onDragDropLoad=function(file,event){if(event&&event.target&&event.target.result){if(MultiplayerManager.LoggedIn){if(this.creatingNewModel){this.setModel({})}var data=event.target.result;this.prepareUpload(file,data)}}};SceneAssetEditor.prototype.prepareUpload=function(file,data){var self=this;var filename=file.name;filename=filename.toLowerCase();var fileExtension=filename.getExtension();if(fileExtension==="jpeg"){var newFilename=filename.stripExtension();newFilename+=".jpg";self.upload(newFilename,data,true)}else if(fileExtension==="bmp"){AlertsManager.ModalAlert("converting bmp...");CCTextureManager.ConvertBase64Image(data,function(newData){AlertsManager.Hide("converting bmp...");if(newData){var newFilename=filename.stripExtension();newFilename+=".jpg";self.upload(newFilename,newData,true)}else{AlertsManager.TimeoutAlert("failed to convert bmp :(",2)}})}else if(fileExtension==="png"){this.removeTexture();CCTextureManager.ValidateImageResolution(data,"image/png",1024,function(validatedData){self.upload(filename,validatedData,true)})}else if(fileExtension==="jpg"){this.removeTexture();CCTextureManager.ValidateImageResolution(data,"image/jpeg",1024,function(validatedData){self.upload(filename,validatedData,true)})}else if(this.supportObj){if(fileExtension==="obj"){if(file.size>1024*1024*2){AlertsManager.TimeoutAlert("file size too large",2)}else{this.upload(filename,data)}}else if(fileExtension==="fbx"){var dataBuffer=new Uint8Array(data);this.uploadFBX(filename,dataBuffer)}else if(fileExtension==="fbxi"){this.uploadFBXiJSON(filename,data)}else{AlertsManager.TimeoutAlert("only .png .jpg .obj .fbx supported",2)}}else{AlertsManager.TimeoutAlert("only .png .jpg supported",2)}};SceneAssetEditor.prototype.convertImage=function(format,tiling){var filename=this.info.sourceTex?this.info.sourceTex:this.info.tex;var filenameExtension=filename.getExtension();if(!format){format=this.info.tex.getExtension()}if(!tiling){tiling=1}var changedFormat=format!==filenameExtension;var changedTiling=tiling!==1;if(!changedFormat&&!changedTiling){delete this.info.tiling;this.setAsset(filename)}else{var self=this;AlertsManager.ModalAlert("converting...");gEngine.textureManager.getTextureHandle(filename,function(textureHandle){if(textureHandle.image){CCTextureManager.ConvertImage(textureHandle.image,format,tiling,function(newData){AlertsManager.Hide("converting...");if(newData){self.info.tiling=tiling;if(!self.info.sourceTex){self.info.sourceTex=filename}var newFilename=filename.stripExtension()+tiling;newFilename+="."+format;self.upload(newFilename,newData,true)}else{AlertsManager.TimeoutAlert("failed to convert :(",2)}})}else{AlertsManager.TimeoutAlert("failed to convert :(",2)}})}};SceneAssetEditor.prototype.upload=function(filename,data,base64){var self=this;AlertsManager.ModalAlert("uploading...");var url=SERVER_ASSETS_URL+"assets/upload.php";var postData={filename:filename};postData.file=new Blob([data],{type:"text/plain"});if(base64){postData.base64=true}if(MultiplayerManager.UseURLProxy(url)){postData.url=url;url=SERVER_ROOT+"backend/helper.php?uploadfile"}gURLManager.requestURL(url,postData,function(status,responseText){var uploaded=false;if(status>=CCURLRequest.Succeeded){if(responseText){var filename=responseText;if(MultiplayerManager.LoggedIn){uploaded=self.setAsset(filename)}}}AlertsManager.Hide("uploading...");if(!uploaded){AlertsManager.TimeoutAlert("failed to upload :(",2)}},1)};SceneAssetEditor.prototype.uploadFBX=function(filename,data,animationFPSCompression){AlertsManager.ModalAlert("uploading...");var url=SERVER_ASSETS_URL+"assets/upload.php";var postData={filename:filename};postData.file=new Blob([data],{type:"text/plain"});if(MultiplayerManager.UseURLProxy(url)){postData.url=url;
url=SERVER_ROOT+"backend/helper.php?uploadfile"}var self=this;gURLManager.requestURL(url,postData,function(status,responseText){AlertsManager.Hide("uploading...");var uploaded=false;if(status>=CCURLRequest.Succeeded){if(responseText){var sourceFBX=responseText;if(MultiplayerManager.LoggedIn){uploaded=true;self.convertFBX(filename,sourceFBX,animationFPSCompression)}}}if(!uploaded){AlertsManager.TimeoutAlert("failed to upload fbx :(",2)}},1)};SceneAssetEditor.prototype.convertFBX=function(filename,sourceFBX,animationFPSCompression){var self=this;AlertsManager.ModalAlert("processing...");var sourceURL=MultiplayerManager.GetAssetURL(sourceFBX);if(sourceURL.contains("backend/helper.php?url=")){sourceURL=String.SplitAfter(sourceURL,"backend/helper.php?url=")}var postData={};postData.url=SocketManager.httpServerURL+"/fbx2json";postData.sourceURL=sourceURL;if(animationFPSCompression){postData.animationFPSCompression=animationFPSCompression}var url=SERVER_ROOT+"backend/helper.php?post";gURLManager.requestURL(url,postData,function(status,responseText){AlertsManager.Hide("processing...");var uploaded=false;if(status>=CCURLRequest.Succeeded){if(responseText){uploaded=true;self.uploadFBXiJSON(filename+"i",responseText,sourceFBX)}}if(!uploaded){AlertsManager.TimeoutAlert("failed to process fbx :(",2)}},1)};SceneAssetEditor.prototype.uploadFBXiJSON=function(filename,data,sourceFBX){var self=this;AlertsManager.ModalAlert("uploading...");var json=JSON.parse(data);data=JSON.stringify(json,function(key,val){return val.toFixed?Number(val.toFixed(4)):val});var url=SERVER_ASSETS_URL+"assets/upload.php";var postData={filename:filename};postData.file=new Blob([data],{type:"text/plain"});if(MultiplayerManager.UseURLProxy(url)){postData.url=url;url=SERVER_ROOT+"backend/helper.php?uploadfile"}gURLManager.requestURL(url,postData,function(status,responseText){AlertsManager.Hide("uploading...");var uploaded=false;if(status>=CCURLRequest.Succeeded){if(responseText){var filename=responseText;if(MultiplayerManager.LoggedIn){uploaded=self.setAsset(filename);if(sourceFBX){self.setAsset(sourceFBX)}}}}if(!uploaded){AlertsManager.TimeoutAlert("failed to upload processed fbx :(",2)}},1)};SceneAssetEditor.prototype.reExportFBXModel=function(){if(this.reExportModel){var tile=this.tileModel;if(tile.modelObject){var model=tile.modelObject.model;if(model){var primitive=model.primitive;if(primitive){var self=this;AlertsManager.ModalAlert("updating...");primitive.exportJSONString(function(jsonString){AlertsManager.Hide("updating...");var obj=self.info.obj;var filenameSplit=obj.split("_");var filename=filenameSplit[0];filename+=".";filename+=obj.getExtension();self.uploadFBXiJSON(filename,jsonString)});return true}}}}return false};SceneAssetEditor.prototype.handleBackButton=function(){if(!this.disabledBackButton){this.disabledBackButton=true;if(this.onClose){this.onClose(false)}this.close();return true}return false};SceneAssetEditor.prototype.onTick=function(){if(MultiplayerManager.LoggedIn){if(this.assetDirty){if(this.info.obj){if(MultiplayerManager.IsOwner(this.info.owners)&&this.info.objectID){var self=this;AlertsManager.Alert("replace current or create new model?",function(result){if(result){if(result===2){delete self.info.objectID}MultiplayerManager.Emit("EditorModelCreate",self.info)}},["replace","create new"])}else{MultiplayerManager.Emit("EditorModelCreate",this.info)}}else if(this.info.tex){MultiplayerManager.Emit("EditorImageCreate",this.info);if(this.onClose){this.onClose(this.info.tex);this.close()}}}else{if(this.onClose){if(this.supportObj){this.onClose(this.info)}else{this.onClose(this.info.tex)}this.close()}}}};SceneAssetEditor.prototype.addTag=function(){new SceneUIListTags(this)};function SceneAssetEditorSettings(editor){this.construct();gEngine.addScene(this);this.editor=editor;this.controlsSwipeMomentum=true}ExtendPrototype(SceneAssetEditorSettings,CCSceneAppUI);SceneAssetEditorSettings.prototype.setup=function(){var self=this;var camera=gEngine.newSceneCamera(this);camera.setupViewport(.8,.2,.2,.7);camera.setCameraWidth(640*.1,false);this.settingTiles=[];this.requestResize()};SceneAssetEditorSettings.prototype.resize=function(){this.CCSceneAppUI_resize();var camera=this.camera;var i,tile;var tileMovementTarget;var idealAspectRatio=1.5;var aspectRatioAdjutment=camera.getAspectRatio()<1.25?camera.getAspectRatio()/idealAspectRatio:1;var y=camera.cameraHHeight;var settingTiles=this.settingTiles;for(i=0;i<settingTiles.length;++i){tile=settingTiles[i];tileMovementTarget=tile.getTileMovementTarget();y-=tile.collisionBounds[1];tile.setPositionY(y);tile.setTileMovementX(tileMovementTarget[0]);if(tile.tileDelete){var tileDelete=tile.tileDelete;tileMovementTarget=tileDelete.getTileMovementTarget();tileDelete.setPositionY(y);tileDelete.setTileMovementX(tileMovementTarget[0])}y-=tile.collisionBounds[1]}};SceneAssetEditorSettings.prototype.updateControls=function(controls){var usingControls=this.CCSceneAppUI_updateControls(controls);var cameraTouches=this.camera.cameraTouches;var touch=cameraTouches[0];if(touch.x>0&&touch.x<1&&touch.y>0&&touch.y<1&&touch.startX>0&&touch.startX<1&&touch.startY>0&&touch.startY<1){if(controls.wheel&&controls.wheel.delta!==0){var delta=controls.wheel.delta;this.cameraScrolling=true;this.controlsMovingVertical=true;this.touchCameraMoving(0,delta*.1);return true}}return usingControls};SceneAssetEditorSettings.prototype.touchMovementAllowed=function(touch,touchDelta){var absDeltaX=Math.abs(touch.totalDeltaX);var absDeltaY=Math.abs(touch.totalDeltaY);if(absDeltaX>CCControls.TouchMovementThreashold.x||absDeltaY>CCControls.TouchMovementThreashold.y){this.controlsMoving=true;touchDelta.x+=touch.totalDeltaX;touchDelta.y+=touch.totalDeltaY;this.controlsMovingVertical=true;return true}return false};SceneAssetEditorSettings.prototype.refreshCameraView=function(){var tiles=this.tiles;if(tiles.length>0){var top=-CC_MAXFLOAT;var bottom=CC_MAXFLOAT;for(var i=0;i<tiles.length;++i){var tile=tiles[i];var topY=tile.getTileMovementTarget()[1]+tile.collisionBounds[1];var bottomY=tile.getTileMovementTarget()[1]-tile.collisionBounds[1];if(topY>top){top=topY}if(bottomY<bottom){bottom=bottomY}}var camera=this.camera;this.sceneLeft=0;this.sceneRight=0;this.sceneTop=top-camera.targetHeight*.5;this.sceneBottom=bottom+camera.targetHeight*.5;if(this.sceneBottom>this.sceneTop){this.sceneBottom=this.sceneTop}}};SceneAssetEditorSettings.prototype.lockCameraView=function(){if(this.cameraScrolling){return}var camera=this.camera;if(camera.targetLookAt[0]<this.sceneLeft){camera.targetLookAt[0]=this.sceneLeft;camera.flagUpdate()}if(camera.targetLookAt[0]>this.sceneRight){camera.targetLookAt[0]=this.sceneRight;camera.flagUpdate()}if(camera.targetLookAt[1]>this.sceneTop){camera.targetLookAt[1]=this.sceneTop;camera.flagUpdate()}else if(camera.targetLookAt[1]<this.sceneBottom){camera.targetLookAt[1]=this.sceneBottom;camera.flagUpdate()}};SceneAssetEditorSettings.prototype.openModelSettings=function(model){var self=this;var camera=this.camera;var tileWidth=camera.targetWidth;var tileHeight=camera.targetWidth*.125;var textHeight=tileHeight*.9;var optionTileWidth=tileWidth-tileHeight;var i,tile,tileDelete;var settingTiles=this.settingTiles;var animate=settingTiles.length===0;for(i=0;i<settingTiles.length;++i){tile=settingTiles[i];if(tile.tileDelete){tile.tileDelete.deleteLater()}tile.deleteLater()}settingTiles.length=0;{{tile=new CCTile3DButton(this);tile.setupText("Settings",textHeight,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTextColour(gColour.set(1,1),true);tile.setColour(gColour.set(.25,0));tile.setDrawOrder(220);this.addTile(tile,0);settingTiles.add(tile)}{var tags=this.editor.info.tags;var DeleteTag=function(tagIndex){return function(){self.editor.deleteTag(tagIndex)}};if(tags){for(i=0;i<tags.length;++i){var tag=tags[i]}}}if(this.editor.info.tex){tile=new CCTile3DButton(this);tile.setupTexturedWidth(tileWidth,this.editor.info.tex);tile.setColour(gColour.set(1,1),true);tile.setDrawOrder(220);this.addTile(tile,0);settingTiles.add(tile)}if(model){var primitive=model.primitive;if(primitive){if(this.editor.info.obj){tile=new CCTile3DButton(this);tile.setupText("Filesize : ...",textHeight,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTextColour(gColour.set(1,1),true);tile.setColour(gColour.set(.25,0));tile.setDrawOrder(220);settingTiles.add(tile);var url=MultiplayerManager.GetAssetURL(this.editor.info.obj);var filename=url.stripDirectory();filename=String.StripEquals(filename);if(primitive){if(primitive.fileSize&&!this.editor.reExportModel){var fileSize=primitive.fileSize;tile.setText("Filesize: "+(fileSize/1024/1024).toFixed(2)+" mb")}}}if(this.editor.info.obj){tile=new CCTile3DButton(this);tile.setupText(" ",textHeight,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTextColour(gColour.set(0,1),true);tile.setColour(gColour.set(.85,0));tile.setDrawOrder(220);this.tileCulling=tile;tile.onRelease.push(function(){self.editor.setCulling(!self.editor.info.noCulling)});this.addTile(tile,0);this.editor.setCulling(this.editor.info.noCulling);settingTiles.add(tile)}var animations=primitive.animations;if(animations&&animations.length>0){{tile=new CCTile3DButton(this);tile.setupText("Animations",textHeight,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTextColour(gColour.set(1,1),true);tile.setColour(gColour.set(.25,0));tile.setDrawOrder(220);settingTiles.add(tile)}var SetAnimationFPSCompression=function(index){return function(){AlertsManager.InputAlert("",function(result){if(result){var ratio=parseInt(result,10);self.editor.setAnimationFPSCompression(ratio)}},{letter:false})}};{var animationFPSCompression=model.getAnimationFPSCompression();tile=new CCTile3DButton(this);tile.setupText("1/"+animationFPSCompression+" fps compression",textHeight,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setColour(gColour.set(1,0));tile.setDrawOrder(220);tile.onRelease.push(new SetAnimationFPSCompression(animationFPSCompression));this.addTile(tile,0);settingTiles.add(tile)}var SetAnimation=function(index){return function(){self.editor.setAnimation(index)}};var DeleteAnimation=function(animationName){return function(){self.editor.deleteAnimation(animationName)}};var currentAnimationIndex=model.getAnimation();var animation;for(i=0;i<animations.length;++i){animation=animations[i];tile=new CCTile3DButton(this);tile.setupText(animation.name,textHeight,true,true);tile.setTileSize(optionTileWidth,tileHeight);tile.setTextColour(gColour.set(0,1),true);tile.setColour(gColour.set(.85,0));if(currentAnimationIndex===i){tile.setColour(EditorManager.LightGreen)}tile.setDrawOrder(220);tile.onRelease.push(new SetAnimation(i));this.addTile(tile,0);settingTiles.add(tile);{tileDelete=new CCTile3DButton(this);tileDelete.setupTile(tileHeight);tileDelete.setTileTexture("editor_icon_delete.jpg");tileDelete.setColour(EditorManager.Red);tileDelete.setDrawOrder(221);tileDelete.onRelease.push(new DeleteAnimation(animation.name));this.addTile(tileDelete,0);tile.tileDelete=tileDelete}}{tile=new CCTile3DButton(this);tile.setupText("Frames",textHeight,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTextColour(gColour.set(1,1),true);tile.setColour(gColour.set(.25,0));tile.setDrawOrder(220);settingTiles.add(tile)}var ToggleAnimationFrame=function(index){return function(){self.editor.toggleAnimationFrame(index)}};var DeleteAnimationFrame=function(index){return function(){self.editor.deleteAnimationFrame(index)}};var currentAnimationFrameIndex=model.getAnimationFrame();animation=animations[currentAnimationIndex];var frames=animation.frames;this.tileAnimationFrames=[];for(i=0;i<frames.length;++i){tile=new CCTile3DButton(this);tile.setupText("Frame "+(i+1),textHeight,true,true);tile.setTileSize(optionTileWidth,tileHeight);tile.setTextColour(gColour.set(0,1),true);tile.setColour(gColour.set(.85,0));if(i===currentAnimationFrameIndex){tile.setColour(EditorManager.LightBlue)}tile.setDrawOrder(220);tile.onRelease.push(new ToggleAnimationFrame(i));tile.touchMovementAllowed=true;if(i===currentAnimationFrameIndex){tile.onPress.push(function(tile){tile.setDrawOrder(221)});tile.onMove.push(function(tile,touchPosition){self.movingAnimationFrame(tile,touchPosition)});tile.onLoss.push(function(tile,touchLost){var newY=tile.position[1];tile.setPositionY(tile.touchPosition[1]);if(!touchLost&&tile.touchMoved){self.movedAnimationFrame(tile,newY)}tile.setDrawOrder(220)})}this.addTile(tile,0);this.tileAnimationFrames.push(tile);settingTiles.add(tile);{tileDelete=new CCTile3DButton(this);tileDelete.setupTile(tileHeight);tileDelete.setTileTexture("editor_icon_delete.jpg");tileDelete.setColour(EditorManager.Red);tileDelete.setDrawOrder(221);tileDelete.onRelease.push(new DeleteAnimationFrame(i));this.addTile(tileDelete,0);tile.tileDelete=tileDelete}}}var submodels=primitive.submodels;if(submodels){{tile=new CCTile3DButton(this);tile.setupText("Submodels",textHeight,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTextColour(gColour.set(1,1),true);tile.setColour(gColour.set(.25,0));tile.setDrawOrder(220);settingTiles.add(tile)}var ToggleSubmodel=function(submodelName){return function(){self.editor.toggleSubmodel(submodelName)}};var DeleteSubmodel=function(submodelName){return function(){self.editor.deleteSubmodel(submodelName)}};for(i=0;i<submodels.length;++i){var submodel=submodels[i];tile=new CCTile3DButton(this);tile.setupText(submodel.name,textHeight,true,true);tile.setTileSize(optionTileWidth,tileHeight);tile.setTextColour(gColour.set(0,1),true);if(submodel.disabled){tile.setColour(EditorManager.Red)}else{tile.setColour(gColour.set(.85,0))}tile.setDrawOrder(220);tile.onRelease.push(new ToggleSubmodel(submodel.name));this.addTile(tile,0);settingTiles.add(tile);{tileDelete=new CCTile3DButton(this);tileDelete.setupTile(tileHeight);tileDelete.setTileTexture("editor_icon_delete.jpg");tileDelete.setColour(EditorManager.Red);tileDelete.setDrawOrder(221);tileDelete.onRelease.push(new DeleteSubmodel(submodel.name));this.addTile(tileDelete,0);tile.tileDelete=tileDelete}}}}}}for(i=0;i<settingTiles.length;++i){tile=settingTiles[i];if(animate){tile.setPositionX(camera.cameraHWidth+tile.collisionSize.width)}else{tile.setPositionX(camera.cameraHWidth-tile.collisionBounds[0]);tile.setColourAlpha(1,false);tile.setTextColourAlpha(1,false)}if(tile.tileDelete){tileDelete=tile.tileDelete;tileDelete.setPositionX(tile.position[0]-tile.collisionBounds[0]-tileDelete.collisionBounds[0]);if(!animate){tileDelete.setColourAlpha(1,false)}}}this.showSettings(false)};SceneAssetEditorSettings.prototype.openImageSettings=function(filename){var self=this;var camera=this.camera;var tileWidth=camera.targetWidth;var tileHeight=camera.targetWidth*.125;var textHeight=tileHeight*.9;var optionTileWidth=tileWidth-tileHeight;var i,tile,tileDelete;var settingTiles=this.settingTiles;for(i=0;i<settingTiles.length;++i){tile=settingTiles[i];if(tile.tileDelete){tile.tileDelete.deleteLater()}tile.deleteLater()}settingTiles.length=0;{{tile=new CCTile3DButton(this);var friendlyName=filename;if(friendlyName.length>17){friendlyName=friendlyName.substring(0,17);friendlyName+="..."}tile.setupText(friendlyName,textHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setColour(gColour.set(1,0));tile.setDrawOrder(220);tile.onRelease.push(function(){CC.WindowPrompt("Filename",filename)});this.addTile(tile,0);settingTiles.add(tile)}{tile=new CCTile3DButton(this);tile.setupText("Settings",textHeight,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTextColour(gColour.set(1,1),true);tile.setColour(gColour.set(.25,0));tile.setDrawOrder(220);this.addTile(tile,0);settingTiles.add(tile)}{var fileExtension=filename.getExtension();tile=new CCTile3DButton(this);tile.setupText("Format: "+fileExtension,textHeight,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setColour(gColour.set(1,0));tile.setDrawOrder(220);tile.onRelease.push(function(){if(fileExtension==="png"){self.editor.convertImage("jpg")}else if(self.editor.info.sourceTex){var sourceFilenameExtension=self.editor.info.sourceTex.getExtension();if(sourceFilenameExtension==="png"){self.editor.setAsset(self.editor.info.sourceTex)}}});this.addTile(tile,0);settingTiles.add(tile)}{tile=new CCTile3DButton(this);tile.setupText("Tiling: 1.0",textHeight,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setColour(gColour.set(1,0));tile.setDrawOrder(220);tile.onRelease.push(function(){var current="1.0";if(self.editor.info.tiling){current=self.editor.info.tiling}AlertsManager.InputAlert(current,function(result){if(result){if(current!==result){var newFloat=parseFloat(result);self.editor.convertImage(null,newFloat)}}},{dot:true})});this.addTile(tile,0);settingTiles.add(tile)}}for(i=0;i<settingTiles.length;++i){tile=settingTiles[i];tile.setPositionX(camera.cameraHWidth+tile.collisionBounds[0]);if(tile.tileDelete){tileDelete=tile.tileDelete;tileDelete.setPositionX(camera.cameraHWidth+tileDelete.collisionBounds[0])}}this.showSettings(false)};SceneAssetEditorSettings.prototype.show=function(resize){if(resize===undefined){resize=true}this.showSettings(resize)};SceneAssetEditorSettings.prototype.showSettings=function(resize){if(this.enabled){this.requestResize();var camera=this.camera;var settingTiles=this.settingTiles;var i,tile;for(i=0;i<settingTiles.length;++i){tile=settingTiles[i];tile.setTileMovementX(camera.targetWidth*.5-tile.collisionBounds[0]);tile.setColourAlpha(1,true);tile.enabled=true;if(tile.tileDelete){var tileDelete=tile.tileDelete;tileDelete.setTileMovementX(camera.targetWidth*.5-tile.collisionSize.width-tileDelete.collisionBounds[0]);tileDelete.setColourAlpha(1,true);tileDelete.enabled=true}}}};SceneAssetEditorSettings.prototype.setCulling=function(noCulling){if(this.tileCulling){if(noCulling){this.tileCulling.setText("No Culling")}else{this.tileCulling.setText("Backface Culling")}}this.showSettings()};SceneAssetEditorSettings.prototype.close=function(){var self=this;var camera=this.camera;var i,tile;var OnAnimatedFunction=function(tile){tile.enabled=false};var settingTiles=this.settingTiles;for(i=0;i<settingTiles.length;++i){tile=settingTiles[i];tile.setTileMovementX(camera.targetWidth*.5+tile.collisionBounds[0]);tile.setColour(gColour.setRGBA(1,1,1,0),true,new OnAnimatedFunction(tile));if(tile.tileDelete){var tileDelete=tile.tileDelete;tileDelete.setTileMovementX(camera.targetWidth*.5+tileDelete.collisionBounds[0]);tileDelete.setColour(gColour.setRGBA(1,1,1,0),true,new OnAnimatedFunction(tileDelete))}}};SceneAssetEditorSettings.prototype.movingAnimationFrame=function(movingTile,position){var top=-CC_MAXFLOAT;var bottom=CC_MAXFLOAT;for(var i=0;i<this.tileAnimationFrames.length;++i){var tile=this.tileAnimationFrames[i];var tilePosition=tile.position;if(tile===movingTile){tilePosition=tile.touchPosition}var tileTop=tilePosition[1]+tile.collisionBounds[1];if(tileTop>top){top=tileTop}var tileBottom=tilePosition[1]-tile.collisionBounds[1];if(tileBottom<bottom){bottom=tileBottom}}var newY=CC.FloatClamp(position[1],bottom,top);movingTile.setPositionY(newY)};SceneAssetEditorSettings.prototype.movedAnimationFrame=function(tile,newY){var currentIndex=this.tileAnimationFrames.find(tile);if(currentIndex!==-1){var i,tileAnimationFrame;var newIndex=this.tileAnimationFrames.length-1;for(i=0;i<this.tileAnimationFrames.length;++i){tileAnimationFrame=this.tileAnimationFrames[i];if(newY>tileAnimationFrame.position[1]){newIndex=i;break}}if(currentIndex!==newIndex){this.editor.moveAnimationFrame(currentIndex,newIndex)}}};function SceneAudioEditor(parentScene,showLists){MultiplayerManager.UpdateCallbacks.addOnce(this);this.construct();if(parentScene){this.setParent(parentScene)}this.cameraCentered=true;gEngine.addScene(this);var self=this;this.onDragDropLoadFunction=function(file,event){self.onDragDropLoad(file,event)};gEngine.controls.onDragDropLoad.add(this.onDragDropLoadFunction);if(showLists){this.sceneUIListDBImages=new SceneUIListDBImages(this);this.sceneUIListDBImages.onSelected=function(imageInfo){self.setAsset(imageInfo.tex)};this.sceneUIListDBImages.onDeleted=function(imageInfo){EditorManager.EditorDeleteImage(imageInfo)}}this.info={};CCEngine.EnableBackButton(this)}ExtendPrototype(SceneAudioEditor,CCSceneAppUI);SceneAudioEditor.prototype.deleteLater=function(){if(this.onDragDropLoadFunction){gEngine.controls.onDragDropLoad.remove(this.onDragDropLoadFunction);this.onDragDropLoadFunction=null}if(this.sceneUIListDBImages){this.sceneUIListDBImages.close();this.sceneUIListDBImages=null}this.CCSceneAppUI_deleteLater()};SceneAudioEditor.prototype.setup=function(){var self=this;var camera=gEngine.newSceneCamera(this);camera.setupViewport(0,0,1,1);camera.setCameraWidth(640,false);var tile;{tile=new CCTile3DButton(this);tile.setupTile(camera.targetWidth,camera.targetHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColour(gColour.set(.25,0));tile.setColourAlpha(.95,true);tile.setDrawOrder(204);this.cameraStickyTiles.add(tile);this.tileBackground=tile}{tile=new CCTile3DButton(this);tile.setupText(" ",1,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.setColour(gColour.setRGBA(.5,.65,1,0));tile.setTextColour(gColour.setRGBA(1,1,1,0));tile.setPositionX(camera.targetWidth*.5+tile.collisionSize.width);tile.setDrawOrder(210);this.tileAlert=tile}{tile=new CCTile3DButton(this);tile.setupTile(1);tile.setText("");tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setPositionY(-(camera.targetHeight*.5)-tile.collisionSize.height);tile.setDrawOrder(210);tile.onRelease.push(function(tile){self.togglePlay()});this.addTile(tile);this.tileModel=tile}this.menuTiles=[];this.bottomTiles=[];this.requestResize()};SceneAudioEditor.prototype.syncUpdate=function(jsonData){if(jsonData.EditorAudioCreated){if(this.onClose){this.info.id=jsonData.EditorAudioCreated;this.onClose(this.info);this.close()}}};SceneAudioEditor.prototype.updateScene=function(delta){var updated=this.CCSceneAppUI_updateScene(delta);var tile=this.tileModel;if(tile.modelObject){tile.modelObject.rotateY(delta*15);tile.modelObject.model.animate(delta)}return updated};SceneAudioEditor.prototype.resize=function(){this.CCSceneAppUI_resize();var camera=this.camera;var i,tile;var idealAspectRatio=1.5;var aspectRatioAdjutment=camera.getAspectRatio()<1.25?camera.getAspectRatio()/idealAspectRatio:1;{tile=this.tileModel;tile.setTextHeight(camera.targetHeight*.065*aspectRatioAdjutment,true);tile.setTileSize(tile.collisionSize.width*1.1,tile.collisionSize.height*1.5)}{tile=this.tileAlert;tile.setTileSize(camera.targetWidth,camera.targetHeight*.15);tile.setTextHeight(tile.collisionBounds[1]);var targetPosition=tile.getTileMovementTarget();targetPosition[1]=camera.targetHeight*.5-tile.collisionBounds[1];tile.setPosition(targetPosition)}{this.tileBackground.setTileSize(camera.targetWidth,camera.targetHeight)}var y=camera.cameraHHeight;var menuTiles=this.menuTiles;for(i=0;i<menuTiles.length;++i){tile=menuTiles[i];var x=tile.getTileMovementTarget()[0];y-=tile.collisionBounds[1];tile.setPositionY(y);y-=tile.collisionBounds[1];tile.setTileMovementX(x)}var bottomTiles=this.bottomTiles;var tileHeight=camera.targetHeight*.075;for(i=0;i<bottomTiles.length;++i){tile=bottomTiles[i];tile.setTileSize(tileHeight);if(i===0){tile.setPositionX(camera.cameraHWidth-tile.collisionBounds[0])}else{tile.positionTileLeftX(bottomTiles[i-1])}}this.showControls(false)};SceneAudioEditor.prototype.touchPressed=function(touch){var result=this.CCSceneAppUI_touchPressed(touch);return true};SceneAudioEditor.prototype.touchMoving=function(touch,touchDelta){var result=this.handleTilesTouch(touch,this.controlsMovingVertical?CCControls.touch_movingVertical:CCControls.touch_movingHorizontal);if(result===CCSceneAppUI.tile_touchAction){return true}return true};SceneAudioEditor.prototype.touchReleased=function(touch,touchAction){var result=this.CCSceneAppUI_touchReleased(touch,touchAction);return true};SceneAudioEditor.prototype.open=function(message){this.message=message;var self=this;var camera=this.camera;var i,tile;var menuTiles=this.menuTiles;for(i=0;i<menuTiles.length;++i){menuTiles[i].deleteLater()}menuTiles.length=0;{{tile=new CCTile3DButton(this);tile.setupTexturedWidth(camera.cameraWidth*.1,"editor_tile_back.jpg",function(tile){tile.setPositionX(camera.targetWidth*.5+tile.collisionBounds[0]);self.showMenu()});tile.setColour(gColour.setRGBA(1,1,1,0));tile.setDrawOrder(220);tile.onRelease.push(function(){self.handleBackButton()});this.addTile(tile,0);menuTiles.add(tile)}{tile=new CCTile3DButton(this);tile.setupTexturedWidth(camera.cameraWidth*.1,"editor_tile_tick.jpg",function(tile){tile.setPositionX(camera.targetWidth*.5+tile.collisionBounds[0]);self.showMenu()});tile.setColour(gColour.setRGBA(1,1,1,0));tile.setDrawOrder(220);tile.onRelease.push(function(){if(MultiplayerManager.Emit("EditorAudioCreate",self.info.mp3)){if(self.onClose){}else{self.close()}}});this.addTile(tile,0);menuTiles.add(tile)}}this.showMenu()};SceneAudioEditor.prototype.showMenu=function(){if(this.enabled){this.requestResize();var camera=this.camera;var menuTiles=this.menuTiles;var i,tile;{tile=this.tileAlert;tile.setTextColourAlpha(1,true);tile.setColourAlpha(.5,true);tile.setText(this.message);tile.setTileMovementX(0)}{tile=this.tileModel;if(tile.modelObject){tile.setColourAlpha(.5,true)}else{tile.setColourAlpha(1,true)}tile.setTileMovementY(0)}for(i=0;i<menuTiles.length;++i){tile=menuTiles[i];tile.setTileMovementX(camera.targetWidth*.5-tile.collisionBounds[0]);tile.setColourAlpha(1,true);tile.enabled=true}this.showControls()}};SceneAudioEditor.prototype.openControls=function(){if(this.info.id){var self=this;var camera=this.camera;var LoadedImageFunction=function(tile){return function(){tile.setPositionY(-camera.cameraHHeight-tile.collisionBounds[1]);self.showControls()}};var i,tile;var bottomTiles=this.bottomTiles;for(i=0;i<bottomTiles.length;++i){bottomTiles[i].deleteLater()}bottomTiles.length=0;if(MultiplayerManager.IsOwner(this.info.owners)){{tile=new CCTile3DButton(this);tile.setupTextured("editor_icon_delete.jpg",new LoadedImageFunction(tile));tile.setColour(EditorManager.Red);tile.setDrawOrder(220);tile.onRelease.push(function(){if(MultiplayerManager.LoggedIn){AlertsManager.ConfirmationAlert("Delete audio?",function(result){if(result){if(self.onClose){self.onClose(false)}if(MultiplayerManager.LoggedIn){EditorManager.EditorDeleteAudio(self.info)}self.close()}})}});this.addTile(tile,0);bottomTiles.add(tile)}}this.showControls()}};SceneAudioEditor.prototype.showControls=function(resizeRequired){if(this.enabled){if(resizeRequired===undefined){resizeRequired=true}if(resizeRequired){this.requestResize()}var camera=this.camera;var bottomTiles=this.bottomTiles;var i,tile;for(i=0;i<bottomTiles.length;++i){tile=bottomTiles[i];var targetY=-camera.targetHeight*.5+tile.collisionBounds[1];if(tile.position[1]>targetY){tile.setPositionY(targetY)}else{tile.setTileMovementY(targetY)}tile.setColourAlpha(1,true);tile.enabled=true}}};SceneAudioEditor.prototype.close=function(){var self=this;var camera=this.camera;this.stop();this.tileBackground.setColourAlpha(0,true);var tile;{tile=this.tileAlert;tile.setTextColourAlpha(0,true);tile.setColourAlpha(0,true,function(){self.deleteLater()});tile.translateTileMovementX(-(camera.targetWidth*.5)-tile.collisionSize.width)}{tile=this.tileModel;tile.setColourAlpha(0,true);tile.setTileMovementY(-(camera.targetHeight*.5)-tile.collisionSize.height)}var menuTiles=this.menuTiles;for(i=0;i<menuTiles.length;++i){tile=menuTiles[i];tile.translateTileMovementX(camera.targetWidth*.5+tile.collisionSize.width);tile.setColour(gColour.setRGBA(1,1,1,0),true);tile.enabled=false}var bottomTiles=this.bottomTiles;for(i=0;i<bottomTiles.length;++i){tile=bottomTiles[i];tile.translateTileMovementY(-tile.collisionSize.height);tile.setColourAlpha(0,true)}};SceneAudioEditor.prototype.setInfo=function(info){this.info=info;if(info.mp3){this.setAsset(info.mp3)}this.openControls()};SceneAudioEditor.prototype.setAsset=function(filename){if(filename){var self=this;var info=this.info;var tile=this.tileModel;var fileExtension=filename.getExtension();if(fileExtension==="mp3"){info.mp3=filename;var friendlyName=String.SplitBefore(filename,"_");friendlyName+=".mp3";tile.setText(friendlyName,true);this.requestResize();this.play();return true}}return false};SceneAudioEditor.prototype.onDragDropLoad=function(file,event){if(event&&event.target&&event.target.result){if(MultiplayerManager.LoggedIn){var data=event.target.result;this.prepareUpload(file,data)}}};SceneAudioEditor.prototype.prepareUpload=function(file,data){var self=this;var filename=file.name;filename=filename.toLowerCase();var fileExtension=filename.getExtension();if(fileExtension==="mp3"){var dataBuffer=new Uint8Array(data);this.uploadMP3(filename,dataBuffer)}else{AlertsManager.TimeoutAlert("only .mp3 is supported",2)}};SceneAudioEditor.prototype.uploadMP3=function(filename,data){var self=this;AlertsManager.ModalAlert("uploading...");var url=SERVER_ASSETS_URL+"assets/upload.php";var postData={filename:filename};postData.file=new Blob([data],{type:"text/plain"});if(MultiplayerManager.UseURLProxy(url)){postData.url=url;url=SERVER_ROOT+"backend/helper.php?uploadfile"}gURLManager.requestURL(url,postData,function(status,responseText){AlertsManager.Hide("uploading...");var uploaded=false;if(status>=CCURLRequest.Succeeded){if(responseText){var filename=responseText;if(MultiplayerManager.LoggedIn){uploaded=self.setAsset(filename)}}}if(!uploaded){AlertsManager.TimeoutAlert("failed to upload mp3 :(",2)}},1)};SceneAudioEditor.prototype.togglePlay=function(){var id="audioeditor";if(CCAudioManager.IsPlaying(id)){this.stop()}else{this.play()}};SceneAudioEditor.prototype.play=function(){var tile=this.tileModel;var id="audioeditor";if(this.info){if(this.info.mp3){tile.setColour(EditorManager.LightYellow,true);var self=this;CCAudioManager.Play(id,this.info.mp3,true,false,function(){if(self.enabled){tile.setColour(EditorManager.LightGreen,true)}else{CCAudioManager.Stop(id)}})}}};SceneAudioEditor.prototype.stop=function(){var tile=this.tileModel;var id="audioeditor";if(CCAudioManager.IsPlaying(id)){tile.setColour(EditorManager.LightRed,true);CCAudioManager.Stop(id)}};SceneAudioEditor.prototype.handleBackButton=function(){if(!this.disabledBackButton){this.disabledBackButton=true;if(this.onClose){this.onClose(false)}this.close();return true}return false};function SceneCharacterEditor(parentScene){MultiplayerManager.UpdateCallbacks.addOnce(this);this.construct();if(parentScene){this.setParent(parentScene)}this.cameraCentered=true;this.modelTiles=[];this.actions=[];this.info={};gEngine.addScene(this);this.open()}ExtendPrototype(SceneCharacterEditor,CCSceneAppUI);SceneCharacterEditor.prototype.deleteLater=function(){if(this.sceneAssetEditor){this.sceneAssetEditor.close();this.sceneAssetEditor=null}this.CCSceneAppUI_deleteLater()};SceneCharacterEditor.prototype.setup=function(){var self=this;var camera=gEngine.newSceneCamera(this);camera.setupViewport(0,0,1,1);camera.setCameraWidth(640,false);var tile;{tile=new CCTile3DButton(this);tile.setupTile(camera.targetWidth,camera.targetHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColour(gColour.set(.25,0));tile.setColourAlpha(.95,true);tile.setDrawOrder(204);this.cameraStickyTiles.add(tile);this.tileBackground=tile}{tile=new CCTile3DButton(this);tile.setupText(" ",1,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.setColour(gColour.setRGBA(.5,.65,1,0));tile.setTextColour(gColour.setRGBA(1,1,1,0));tile.setPositionX(camera.targetWidth*.5+tile.collisionSize.width);tile.setDrawOrder(210);this.tileAlert=tile}this.menuTiles=[];this.bottomTiles=[];this.requestResize()};SceneCharacterEditor.prototype.syncUpdate=function(jsonData){if(jsonData.EditorCharacterCreated){AlertsManager.Hide("creating...");if(this.onClose){this.info.objectID=jsonData.EditorCharacterCreated;this.onClose(this.info);this.close()}}};SceneCharacterEditor.prototype.updateScene=function(delta){var updated=this.CCSceneAppUI_updateScene(delta);
if(!CCEngine.IsMobile()){if(!this.sceneAssetEditor){var modelTiles=this.modelTiles;for(var i=0;i<modelTiles.length;++i){var tile=modelTiles[i];if(tile.modelObject){tile.modelObject.model.animate(delta)}}}}return updated};SceneCharacterEditor.prototype.resize=function(){this.CCSceneAppUI_resize();var camera=this.camera;var i,tile;this.updatedList();{tile=this.tileAlert;tile.setTileSize(camera.targetWidth,camera.targetHeight*.15);tile.setTextHeight(tile.collisionBounds[1]);var targetPosition=tile.getTileMovementTarget();targetPosition[1]=camera.targetHeight*.5-tile.collisionBounds[1];tile.setPosition(targetPosition)}{this.tileBackground.setTileSize(camera.targetWidth,camera.targetHeight)}var y=camera.cameraHHeight;var menuTiles=this.menuTiles;for(i=0;i<menuTiles.length;++i){tile=menuTiles[i];tile.setPositionX(camera.cameraHWidth-tile.collisionBounds[0]);y-=tile.collisionBounds[1];tile.setPositionY(y);y-=tile.collisionBounds[1]}var bottomTiles=this.bottomTiles;var tileHeight=camera.targetHeight*.075;for(i=0;i<bottomTiles.length;++i){tile=bottomTiles[i];tile.setTileSize(tileHeight);if(i===0){tile.setPositionX(camera.cameraHWidth-tile.collisionBounds[0])}else{tile.positionTileLeftX(bottomTiles[i-1])}}this.showControls(false)};SceneCharacterEditor.prototype.touchPressed=function(touch){var result=this.CCSceneAppUI_touchPressed(touch);return true};SceneCharacterEditor.prototype.touchMoving=function(touch,touchDelta){var result=this.handleTilesTouch(touch,this.controlsMovingVertical?CCControls.touch_movingVertical:CCControls.touch_movingHorizontal);if(result===CCSceneAppUI.tile_touchAction){return true}else{var modelTiles=this.modelTiles;for(var i=0;i<modelTiles.length;++i){var tile=modelTiles[i];if(tile.modelObject){var x=touch.deltaX;var y=touch.deltaY;var camera=this.camera;var rotation=tile.modelObject.rotation;rotation[1]+=x*180;tile.modelObject.setRotationY(rotation[1]);rotation[0]+=y*180;tile.modelObject.setRotationX(rotation[0])}}return true}return true};SceneCharacterEditor.prototype.touchReleased=function(touch,touchAction){var result=this.CCSceneAppUI_touchReleased(touch,touchAction);return true};SceneCharacterEditor.prototype.open=function(message){this.message=message;var self=this;var camera=this.camera;var i,tile;var menuTiles=this.menuTiles;for(i=0;i<menuTiles.length;++i){menuTiles[i].deleteLater()}menuTiles.length=0;{{tile=new CCTile3DButton(this);tile.setupTexturedWidth(camera.cameraWidth*.1,"editor_tile_back.jpg",function(){self.showMenu()});tile.setColour(gColour.setRGBA(1,1,1,0));tile.setDrawOrder(220);tile.onRelease.push(function(){if(self.onClose){self.onClose(false)}self.close()});this.addTile(tile,0);menuTiles.add(tile)}{tile=new CCTile3DButton(this);tile.setupTexturedWidth(camera.cameraWidth*.1,"editor_tile_tick.jpg",function(){self.showMenu()});tile.setColour(gColour.setRGBA(1,1,1,0));tile.setDrawOrder(220);tile.onRelease.push(function(){self.onTick()});this.addTile(tile,0);this.tileTick=tile;menuTiles.add(tile)}{tile=new CCTile3DButton(this);tile.setupTexturedWidth(camera.cameraWidth*.1,"editor_tile_copy.jpg",function(){self.showMenu()});tile.setColour(gColour.setRGBA(1,1,1,0));tile.setDrawOrder(220);tile.onRelease.push(function(){self.onClone()});this.addTile(tile,0);this.tileClone=tile;menuTiles.add(tile)}}this.showMenu()};SceneCharacterEditor.prototype.showMenu=function(){if(this.enabled){this.requestResize();var camera=this.camera;var menuTiles=this.menuTiles;var i,tile;for(i=0;i<menuTiles.length;++i){tile=menuTiles[i];tile.setPositionX(camera.targetWidth*.5+tile.collisionSize.width);tile.translateTileMovementX(-tile.collisionSize.width*1.5);tile.setColourAlpha(1,true);tile.enabled=true}this.showControls()}};SceneCharacterEditor.prototype.openControls=function(){if(this.info&&this.info.objectID){var self=this;var camera=this.camera;var LoadedImageFunction=function(tile){return function(){tile.setPositionY(-camera.cameraHHeight-tile.collisionBounds[1]);self.showControls()}};var i,tile;var bottomTiles=this.bottomTiles;for(i=0;i<bottomTiles.length;++i){bottomTiles[i].deleteLater()}bottomTiles.length=0;if(MultiplayerManager.IsOwner(this.info.owners)){tile=new CCTile3DButton(this);tile.setupTextured("editor_icon_delete.jpg",new LoadedImageFunction(tile));tile.setColour(gColour.setRGBA(.5,0,0,0));tile.setDrawOrder(220);tile.onRelease.push(function(){if(MultiplayerManager.LoggedIn){AlertsManager.ConfirmationAlert("Delete character?",function(result){if(result){if(MultiplayerManager.LoggedIn){EditorManager.EditorDeleteCharacter(self.info)}self.close()}})}});this.addTile(tile,0);bottomTiles.add(tile)}this.showControls()}};SceneCharacterEditor.prototype.showControls=function(resizeRequired){if(this.enabled){if(resizeRequired===undefined){resizeRequired=true}if(resizeRequired){this.requestResize()}var camera=this.camera;var bottomTiles=this.bottomTiles;var i,tile;for(i=0;i<bottomTiles.length;++i){tile=bottomTiles[i];var targetY=-camera.targetHeight*.5+tile.collisionBounds[1];if(tile.position[1]>targetY){tile.setPositionY(targetY)}else{tile.setTileMovementY(-camera.targetHeight*.5+tile.collisionBounds[1])}tile.setColourAlpha(1,true);tile.enabled=true}}};SceneCharacterEditor.prototype.close=function(){var self=this;var camera=this.camera;this.tileBackground.setColourAlpha(0,true);var tile,i;{tile=this.tileAlert;tile.setTextColourAlpha(0,true);tile.setColourAlpha(0,true,function(){self.deleteLater()});tile.translateTileMovementX(-(camera.targetWidth*.5)-tile.collisionSize.width)}var modelTiles=this.modelTiles;for(i=0;i<modelTiles.length;++i){tile=modelTiles[i];tile.setColourAlpha(0,true);tile.setTileMovementY(-(camera.targetHeight*.5)-tile.collisionSize.height)}var menuTiles=this.menuTiles;for(i=0;i<menuTiles.length;++i){tile=menuTiles[i];tile.translateTileMovementX(camera.targetWidth*.5+tile.collisionSize.width);tile.setColour(gColour.setRGBA(1,1,1,0),true);tile.enabled=false}var bottomTiles=this.bottomTiles;for(i=0;i<bottomTiles.length;++i){tile=bottomTiles[i];tile.translateTileMovementY(-tile.collisionSize.height);tile.setColourAlpha(0,true)}};SceneCharacterEditor.prototype.onTick=function(){if(!this.info.owners||MultiplayerManager.IsOwner(this.info.owners)){this.onCreateCharacter();return}this.onClone()};SceneCharacterEditor.prototype.onClone=function(){var self=this;AlertsManager.ConfirmationAlert("Create clone of character?",function(result){if(result){delete self.info.objectID;self.onCreateCharacter()}else{if(self.onClose){self.onClose(false)}self.close()}})};SceneCharacterEditor.prototype.onCreateCharacter=function(){var info=this.info;info.actions=this.actions;var self=this;MultiplayerManager.Emit("EditorCharacterCreate",info);if(this.onClose){AlertsManager.ModalAlert("creating...")}else{this.close()}};SceneCharacterEditor.prototype.setCharacter=function(characterInfo){this.info=characterInfo;if(!MultiplayerManager.IsOwner(this.info.owners)){this.menuTiles.remove(this.tileTick);this.tileTick.shouldRender=false}if(characterInfo.actions){this.actions=characterInfo.actions}this.updatedList();this.openControls()};SceneCharacterEditor.prototype.clear=function(){var tile,i;var modelTiles=this.modelTiles;for(i=0;i<modelTiles.length;++i){tile=modelTiles[i];this.tiles.remove(tile);if(tile.tileAction){this.tiles.remove(tile.tileAction);tile.tileAction.deleteLater()}if(tile.tileSFX){this.tiles.remove(tile.tileSFX);tile.tileSFX.deleteLater()}if(tile.tileDelete){this.tiles.remove(tile.tileDelete);tile.tileDelete.deleteLater()}tile.deleteLater()}modelTiles.length=0};SceneCharacterEditor.prototype.selectModel=function(index,modelInfo){var self=this;this.clear();if(!this.sceneAssetEditor){this.sceneAssetEditor=new SceneAssetEditor(self,true,true)}if(index!==undefined){this.sceneAssetEditor.sceneUIListDBModels.findAndSelectID(this.actions[index].modelID,function(modelInfo){self.sceneAssetEditor.sceneUIListDBModels.onSelected(modelInfo)})}else if(modelInfo){this.sceneAssetEditor.sceneUIListDBModels.findAndSelectID(modelInfo.objectID);self.sceneAssetEditor.sceneUIListDBModels.onSelected(modelInfo)}else{this.sceneAssetEditor.sceneUIListDBModels.unselect()}this.sceneAssetEditor.sceneUIListDBModels.onSelected=function(modelInfo){if(index!==undefined){self.sceneAssetEditor.open("Action for "+self.actions[index].actionID)}else{self.sceneAssetEditor.open("New Action")}self.sceneAssetEditor.onClose=function(newModelInfo){self.sceneAssetEditor=null;if(newModelInfo){if(index!==undefined){self.assignModel(newModelInfo,index)}else{self.addModel(newModelInfo)}}else{self.updatedList()}};self.sceneAssetEditor.setModel(modelInfo)}};SceneCharacterEditor.prototype.addModel=function(modelInfo){var modelID=modelInfo.objectID;var actionID="action."+this.actions.length;var action={};action.modelID=modelID;action.actionID=actionID;this.actions.add(action);var self=this;DBAssets.LoadModelID(modelID,function(){self.updatedList()})};SceneCharacterEditor.prototype.assignModel=function(modelInfo,index){var modelID=modelInfo.objectID;var action=this.actions[index];action.modelID=modelID;var self=this;DBAssets.LoadModelID(modelID,function(){self.updatedList()})};SceneCharacterEditor.prototype.updatedList=function(){var self=this;var camera=this.camera;this.clear();var tile,i;var modelTiles=this.modelTiles;var LoadModelFunction=function(tile,tex){return function(model3d){if(model3d){var modelObject=tile.modelObject;if(!tile.modelObject){modelObject=new CCObject;tile.addChild(modelObject);modelObject.setTransparent();tile.modelObject=modelObject;modelObject.setReadDepth(false);modelObject.setWriteDepth(false)}modelObject.setModel(model3d);{var size=tile.collisionSize.width*.75;var scaleFactor;var modelWidth=model3d.getWidth()>model3d.getDepth()?model3d.getWidth():model3d.getDepth();var modelHeight=model3d.getHeight();if(modelWidth>modelHeight){scaleFactor=size/modelWidth}else{scaleFactor=size/modelHeight}model3d.setScale(scaleFactor)}if(tex){model3d.setTexture(tex)}}}};var actions=this.actions;var tileArea=camera.targetWidth*.8;if(actions.length===0){tileArea*=.25}var modelSize=tileArea/(actions.length+1);if(modelSize>camera.targetWidth*.25){modelSize=camera.targetWidth*.25}var ModelInfoLoaded=function(tile){return function(modelInfo){if(modelInfo&&modelInfo.obj){CCModel3D.CacheModel(modelInfo.obj,true,new LoadModelFunction(tile,modelInfo.tex))}}};var SelectModelFunction=function(index){return function(){self.selectModel(index)}};var RenameActionFunction=function(index){return function(){var actions=self.actions;var actionID=actions[index].actionID;AlertsManager.InputAlert(actionID,function(result){if(result){var found=false;for(var i=0;i<actions.length;++i){if(result===actions[i].actionID){found=true;break}}if(!found){actions[index].actionID=result;self.updatedList()}}})}};var RenameSFXFunction=function(index){return function(){var actions=self.actions;var sfxID=actions[index].sfxID;AlertsManager.InputAlert(sfxID?sfxID:"",function(result){if(result){actions[index].sfxID=result;self.updatedList()}else{if(actions[index].sfxID){delete actions[index].sfxID;self.updatedList()}}})}};var DeleteFunction=function(index){return function(){if(self.sceneUIListDBModels){self.sceneUIListDBModels.close();self.sceneUIListDBModels=null}self.actions.removeIndex(index);self.updatedList()}};var x=-tileArea*.5;for(i=0;i<actions.length;++i){var action=actions[i];x+=modelSize*.5;tile=new CCTile3DButton(this);tile.setupTile(modelSize);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColourAlpha(1,true);tile.setPositionX(x);tile.setDrawOrder(205);modelTiles.add(tile);tile.onRelease.push(new SelectModelFunction(i));this.addTile(tile,0);var modelID=action.modelID;DBAssets.LoadModelID(modelID,new ModelInfoLoaded(tile));var tileSize=tileArea*.05;var actionID=action.actionID;{var tileAction=new CCTile3DButton(this);tileAction.setupText(actionID,tileArea*.025,true,true);tileAction.setTextColour(gColour.set(1,1));tileAction.setTileSize(modelSize,tileSize);tileAction.setTileTexture("editor_tile_background.jpg");tileAction.setColour(EditorManager.LightBlue);tileAction.setColourAlpha(0,false);tileAction.setColourAlpha(1,true);tileAction.setDrawOrder(221);tileAction.positionTileAbove(tile);tileAction.onRelease.push(new RenameActionFunction(i));this.addTile(tileAction,0);tile.tileAction=tileAction}var sfxID=action.sfxID;{var tileSFX=new CCTile3DButton(this);tileSFX.setupText(sfxID?sfxID:"SFX...",tileArea*.025,true,true);tileSFX.setTextColour(gColour.set(1,1));tileSFX.setTileSize(modelSize,tileSize);tileSFX.setTileTexture("editor_tile_background.jpg");tileSFX.setColour(EditorManager.LightBlue);tileSFX.setColourAlpha(0,false);tileSFX.setColourAlpha(1,true);tileSFX.setDrawOrder(221);tileSFX.positionTileBelow(tile);tileSFX.onRelease.push(new RenameSFXFunction(i));this.addTile(tileSFX,0);tile.tileSFX=tileSFX}{var tileDelete=new CCTile3DButton(this);tileDelete.setupText("delete",tileArea*.025,true,true);tileDelete.setTextColour(gColour.set(1,1));tileDelete.setTileSize(modelSize,tileSize);tileDelete.setTileTexture("editor_tile_background.jpg");tileDelete.setColour(EditorManager.Red);tileDelete.setColourAlpha(1,true);tileDelete.setDrawOrder(221);tileDelete.positionTileBelow(tile.tileSFX);tileDelete.onRelease.push(new DeleteFunction(i));this.addTile(tileDelete,0);tile.tileDelete=tileDelete}x+=modelSize*.5}{x+=modelSize*.5;tile=new CCTile3DButton(this);tile.setupText("+",modelSize*.5,true,true);tile.setTextColour(gColour.set(1,1));tile.setTileSize(modelSize);tile.setTileTexture("editor_tile_background.jpg");tile.setColour(gColour.setRGBA(.25,.75,.25,0));tile.setColourAlpha(1,true);tile.setPositionX(x);tile.setDrawOrder(205);modelTiles.add(tile);tile.onRelease.push(function(){self.selectModel()});this.addTile(tile);x+=modelSize*.5}};function SceneUIList(){}ExtendPrototype(SceneUIList,CCSceneAppUI);SceneUIList.prototype.updateControls=function(controls){var usingControls=this.CCSceneAppUI_updateControls(controls);var cameraTouches=this.camera.cameraTouches;var touch=cameraTouches[0];if(touch.x>0&&touch.x<1&&touch.y>0&&touch.y<1&&touch.startX>0&&touch.startX<1&&touch.startY>0&&touch.startY<1){if(controls.wheel&&controls.wheel.delta!==0){var delta=controls.wheel.delta;this.cameraScrolling=true;this.controlsMovingVertical=true;this.touchCameraMoving(0,delta*.1);return true}}return usingControls};SceneUIList.prototype.touchPressed=function(touch){if(this.CCSceneAppUI_touchPressed(touch)){return true}return true};SceneUIList.prototype.touchMovementAllowed=function(touch,touchDelta){var absDeltaX=Math.abs(touch.totalDeltaX);var absDeltaY=Math.abs(touch.totalDeltaY);if(absDeltaX>CCControls.TouchMovementThreashold.x||absDeltaY>CCControls.TouchMovementThreashold.y){this.controlsMoving=true;touchDelta.x+=touch.totalDeltaX;touchDelta.y+=touch.totalDeltaY;this.controlsMovingVertical=true;return true}return false};SceneUIList.prototype.touchMoving=function(touch,touchDelta){return this.CCSceneAppUI_touchMoving(touch,touchDelta)};SceneUIList.prototype.touchReleased=function(touch,touchAction){return this.CCSceneAppUI_touchReleased(touch,touchAction)};SceneUIList.prototype.refreshCameraView=function(){this.sceneLeft=0;this.sceneRight=0;this.sceneTop=0;this.sceneBottom=0;var tiles=this.tiles;for(var i=0;i<tiles.length;++i){var tile=tiles[i];var bottomY=tile.getTileMovementTarget()[1]-tile.collisionBounds[1];if(bottomY<this.sceneBottom){this.sceneBottom=bottomY;if(this.sceneBottom>this.sceneTop){this.sceneBottom=this.sceneTop}}}};SceneUIList.prototype.lockCameraView=function(){if(this.cameraScrolling){return}var camera=this.camera;camera.flagUpdate();camera.targetLookAt[0]=0;if(camera.targetLookAt[1]>this.sceneTop){camera.targetLookAt[1]=this.sceneTop}else if(camera.targetLookAt[1]<this.sceneBottom){camera.targetLookAt[1]=this.sceneBottom}};function SceneUIListTags(parentScene){this.maxColumns=1;this.construct();this.setParent(parentScene);parentScene.linkScene(this);gEngine.addScene(this)}ExtendPrototype(SceneUIListTags,SceneUIList);SceneUIListTags.prototype.deleteLater=function(){this.SceneUIList_deleteLater()};SceneUIListTags.prototype.setup=function(){var parentCamera=this.parentScene.camera;var parentCameraIndex=gEngine.findCameraIndex(parentCamera);var camera=gEngine.newSceneCamera(this);camera.setupViewport(0,0,1,1);camera.setCameraWidth(640*1,false);this.SceneUIList_setup();var tile;{tile=new CCTile3DButton(this);tile.setupTile();tile.setTileTexture("editor_tile_background.jpg");tile.setColour(gColour.set(.5,0));tile.setColourAlpha(.95,true);tile.setDrawOrder(200);this.cameraStickyTiles.add(tile);this.tileBackground=tile}this.list=["Characters","Vehicles"];this.listTiles=[];this.show()};SceneUIListTags.prototype.resize=function(){this.SceneUIList_resize();var camera=this.camera;var tile;{tile=this.tileBackground;tile.setTileSize(camera.targetWidth,camera.targetHeight)}var listTiles=this.listTiles;var y=camera.cameraHHeight;for(var i=0;i<listTiles.length;++i){var tile=listTiles[i].tiles[0];y-=tile.collisionBounds[1];tile.setPositionY(y);y-=tile.collisionBounds[1]}};SceneUIListTags.prototype.show=function(){if(this.closing){return}var db=this.list;if(db){var objects=this.listTiles;var i,tile,j;var object;for(i=0;i<db.length;++i){info=db[i];if(objects.length>i){object=objects[objectIndex];if(info===object.info){continue}objectsList.objects.remove(object);for(j=0;j<object.tiles.length;++j){tile=object.tiles[j];this.tiles.remove(tile);tile.deleteLater()}}object=this.createObject(info);objects.insert(object,i)}while(objects.length>i){object=objects[objectIndex];objects.remove(object);for(j=0;j<object.tiles.length;++j){tile=object.tiles[j];this.tiles.remove(tile);tile.deleteLater()}}}this.requestResize()};SceneUIListTags.prototype.createObject=function(info){var self=this;var objectsList=this.objectsList;var SelectObjectFunction=function(info){return function(){if(self.onSelected){self.onSelected(info)}}};var camera=this.camera;var tileWidth=camera.targetWidth*.25/this.maxColumns;var tileHeight=tileWidth*.2;var object={};object.tiles=[];object.info=info;var tile;{tile=new CCTile3DButton(this);tile.setupText(""+info,tileHeight,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.set(.25,.9));tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(205);tile.onRelease.push(new SelectObjectFunction(info));this.addTile(tile);object.tiles.add(tile)}return object};function SceneUIListObjects(parentScene){this.construct(parentScene)}ExtendPrototype(SceneUIListObjects,SceneUIList);SceneUIListObjects.prototype.construct=function(parentScene){if(!this.maxColumns){this.maxColumns=1}this.SceneUIList_construct();{this.setParent(parentScene)}gEngine.addScene(this)};SceneUIListObjects.prototype.setup=function(){var camera;if(this.camera){camera=this.camera}else{camera=gEngine.newSceneCamera(this);camera.setupViewport(0,0,.125,1);camera.setCameraWidth(640*.125,false)}var tile;{tile=new CCTile3DButton(this);tile.setupTile();tile.setTileTexture("editor_tile_background.jpg");tile.setColour(gColour.set(.5,0));tile.setColourAlpha(.95,true);tile.setDrawOrder(200);this.cameraStickyTiles.add(tile);this.tileBackground=tile}this.selectionIndex=-1;this.currentPage=0;this.maxItemsPerPage=3;this.objectsList=[];var self=this;var tileWidth=camera.targetWidth/this.maxColumns;if(tileWidth>100){tileWidth=100}var tileHeight=tileWidth*.5;if(this.onNew){tile=new CCTile3DButton(this);tile.visibleOnlyUpdate=true;tile.setupText("+",tileHeight,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.setRGBA(.25,.75,.25,0));tile.setTextColour(gColour.setRGBA(1,1,1,0));tile.setColourAlpha(.9,true);tile.setTextColourAlpha(1,true);tile.setDrawOrder(205);tile.onRelease.push(function(){self.onNew()});this.addTile(tile);this.tileNew=tile}this.requestResize();this.show()};SceneUIListObjects.prototype.updateScene=function(delta){var updated=this.SceneUIList_updateScene(delta);if(this.selectionIndex!==-1){var object=this.getSelectedObject;if(object.modelObject){object.modelObject.rotateY(delta*30);object.modelObject.model.animate(delta)}}return updated};SceneUIListObjects.prototype.resize=function(){this.SceneUIList_resize();var camera=this.camera;var tile;{tile=this.tileBackground;tile.setTileSize(camera.targetWidth,camera.targetHeight)}this.resizeLists(camera.cameraHHeight)};SceneUIListObjects.prototype.resizeLists=function(y){var camera=this.camera;var tile;if(this.tileNew){tile=this.tileNew;y-=tile.collisionBounds[1];tile.setPositionXY(-camera.targetWidth*.5+tile.collisionBounds[0],y);y-=tile.collisionBounds[1];y-=camera.cameraHHeight*.05}y=this.resizeList(this.objectsList,y);y-=camera.cameraHHeight*.05};SceneUIListObjects.prototype.resizeList=function(list,currentY){var camera=this.camera;var maxColumns=this.maxColumns;var xIncrement=camera.targetWidth/maxColumns;var xStart=-camera.targetWidth*.5+xIncrement*.5;var i,j,object,tiles,tile;var columnIndex=0;var x=xStart;var y=currentY;var bottomY=y;for(i=0;i<list.length;++i){currentY=y;object=list[i];tiles=object.tiles;for(j=0;j<tiles.length;++j){tile=tiles[j];currentY-=tile.collisionBounds[1];tile.setPositionXYZ(x,currentY,0);if(!tile.positioned){tile.positioned=true;tile.setPositionX(-camera.targetWidth*.5-tile.collisionBounds[0])}currentY-=tile.collisionBounds[1]}if(currentY<bottomY){bottomY=currentY}x+=xIncrement;if(columnIndex===maxColumns-1){columnIndex=0;x=xStart;y=bottomY}else{columnIndex++}}return bottomY};SceneUIListObjects.prototype.refreshedObjectsList=function(){var camera=this.camera;var objectsList=this.objectsList;var tiles,i,tile,j;var duration=1;for(i=0;i<objectsList.length;++i){tiles=objectsList[i].tiles;for(j=0;j<tiles.length;++j){tile=tiles[j];tile.movementInterpolator.setDuration(duration)}}this.requestResize();this.positionObjectsList(this.objectsList);this.highlightSelectedObject()};SceneUIListObjects.prototype.positionObjectsList=function(list){var camera=this.camera;var cameraTop=camera.targetLookAt[1]-camera.targetHeight*.5;var cameraBottom=camera.targetLookAt[1]+camera.targetHeight*.5;var maxColumns=this.maxColumns;var xIncrement=camera.targetWidth/maxColumns;var xStart=-camera.targetWidth*.5+xIncrement*.5;var x=xStart;var columnIndex=0;for(var i=0;i<list.length;++i){var tiles=list[i].tiles;for(var j=0;j<tiles.length;++j){var tile=tiles[j];var visible=false;if(tile.aabbMax[1]>cameraTop){if(tile.aabbMin[1]<cameraBottom){visible=true}}{tile.setPositionX(x)}tile.setCollideable(true)}x+=xIncrement;if(columnIndex===maxColumns-1){columnIndex=0;x=xStart}else{columnIndex++}}};SceneUIListObjects.prototype.show=function(){if(this.closing){return}var list=this.list;if(list){var i,tile,tiles,j;var info;var objectsList=this.objectsList;var object;for(i=0;i<list.length;++i){info=list[i];if(objectsList.length>i){object=objectsList[i];var newInfoString=JSON.stringify(info);var currentInfoString=JSON.stringify(object.info);if(newInfoString===currentInfoString){continue}objectsList.remove(object);for(j=0;j<object.tiles.length;++j){tile=object.tiles[j];this.tiles.remove(tile);tile.deleteLater()}}object=this.createObject(info);objectsList.insert(object,i)}while(objectsList.length>list.length){object=objectsList[list.length];objectsList.remove(object);for(j=0;j<object.tiles.length;++j){tile=object.tiles[j];this.tiles.remove(tile);tile.deleteLater()}}}this.refreshedObjectsList();this.highlightSelectedObject()};SceneUIListObjects.prototype.close=function(){this.closing=true;var self=this;var camera=this.camera;var tile;{tile=this.tileBackground;tile.setColourAlpha(0,true,function(){self.deleteLater()})}if(this.tileNew){tile=this.tileNew;tile.setTileMovementX(-camera.targetWidth*.5-tile.collisionSize.width);tile.setColour(gColour.setRGBA(1,1,1,0),true);tile.setCollideable(false)}var objectsList=this.objectsList;for(var i=0;i<objectsList.length;++i){var tiles=objectsList[i].tiles;for(var j=0;j<tiles.length;++j){tile=tiles[j];{tile.setPositionX(-camera.targetWidth*.5-tile.collisionSize.width)}tile.setColour(gColour.setRGBA(1,1,1,0),tile.visible);tile.setCollideable(false)}}};SceneUIListObjects.prototype.getSelectedObject=function(){var selectedInfo=this.getSelected();if(selectedInfo){var objectsList=this.objectsList;for(var i=0;i<objectsList.length;++i){var object=objectsList[i];if(object.info===selectedInfo){return object}}}return null};SceneUIListObjects.prototype.highlightSelectedObject=function(){var camera=this.camera;var cameraTop=camera.targetLookAt[1]-camera.targetHeight*.5;var cameraBottom=camera.targetLookAt[1]+camera.targetHeight*.5;var selectionIndex=this.selectionIndex;var selectedObject=this.getSelectedObject();var objectsList=this.objectsList;for(var i=0;i<objectsList.length;++i){var object=objectsList[i];var tiles=object.tiles;for(var j=0;j<tiles.length;++j){var tile=tiles[j];var visible=false;if(tile.aabbMax[1]>cameraTop){if(tile.aabbMin[1]<cameraBottom){visible=true}}if(object===selectedObject){if(j===tiles.length-1){camera.targetLookAt[1]=tile.position[1];this.refreshCameraView();this.lockCameraView()}if(j===0){tile.setColour(gColour.setRGBA(.4,.5,.75,0),true)}tile.setColourAlpha(1,visible)}else{if(j===0){tile.setColour(gColour.set(.25,0),true)}tile.setColourAlpha(.75,visible)}}}};SceneUIListObjects.prototype.getInfoIndex=function(info){if(this.list){return this.list.find(info)}return null};SceneUIListObjects.prototype.getInfo=function(index){if(this.list&&index>=0&&index<this.list.length){return this.list[index]}return null};SceneUIListObjects.prototype.getSelected=function(){return this.getInfo(this.selectionIndex)};SceneUIListObjects.prototype.unselect=function(){this.selectionIndex=-1;this.highlightSelectedObject()};SceneUIListObjects.prototype.selectIndex=function(i,callback,findInfo){if(this.selectionIndex!==i){this.selectionIndex=i;this.highlightSelectedObject()}var selectedInfo=this.getSelected();if(this.onSelected){this.onSelected(selectedInfo)}if(callback){callback(selectedInfo)}};SceneUIListObjects.prototype.findAndSelectID=function(id,callback,findInfo){var list=this.list;if(list){for(var i=0;i<list.length;++i){var itr=list[i];var itrID=DBAssets.GetID(itr);if(itrID===id){this.selectIndex(i,callback,findInfo);return}}this.selectionIndex=-1;this.highlightSelectedObject()}if(!this.loaded){var self=this;this.onLoaded=function(){self.findAndSelectID(id,callback,findInfo)}}else{if(callback){callback(false)}}};function SceneUIListObjectsMap(parentScene,mapEditor){this.construct(parentScene);this.mapEditor=mapEditor}ExtendPrototype(SceneUIListObjectsMap,SceneUIListObjects);SceneUIListObjectsMap.prototype.setup=function(){var parentCameraIndex=gEngine.findCameraIndex(this.parentScene.camera);var camera=gEngine.newSceneCamera(this,parentCameraIndex+1);camera.setupViewport(0,0,.25,1);camera.setCameraWidth(640*.25,false);this.SceneUIListObjects_setup()};SceneUIListObjectsMap.prototype.updateScene=function(delta){var updated=this.CCSceneAppUI_updateScene(delta);var objects=this.objectsList;for(var i=0;i<objects.length;++i){var object=objects[i];if(object.modelObject){object.modelObject.rotateY(delta*30);object.modelObject.model.animate(delta)}}return updated};SceneUIListObjectsMap.prototype.render=function(camera,pass,alpha){this.CCSceneAppUI_render(camera,pass,alpha)};SceneUIListObjectsMap.prototype.resizeLists=function(y){this.resizeList(this.objectsList,y)};SceneUIListObjectsMap.prototype.clearObjects=function(){var objectsList=this.objectsList;while(objectsList.length>0){var object=objectsList[0];objectsList.remove(object);for(var j=0;j<object.tiles.length;++j){tile=object.tiles[j];this.tiles.remove(tile);tile.deleteLater()}--i}};SceneUIListObjectsMap.prototype.showObjects=function(objects){var self=this;var i,j,tile,tiles,object,newObject;var objectsList=this.objectsList;for(i=0;i<objectsList.length;++i){object=objectsList[i];if(objects.length>i){newObject=objects[i]}else{newObject=null}if(object.object!==newObject){objectsList.remove(object);for(j=0;j<object.tiles.length;++j){tile=object.tiles[j];this.tiles.remove(tile);tile.deleteLater()}--i}}var FindObjectFunction=function(object){return function(){self.mapEditor.findObject(object)}};var EditImageFunction=function(object){return function(){self.mapEditor.sceneUI.openAssetEditor("Select Map Image",false,true,function(tex){if(tex){self.mapEditor.mapsManager.handleEditMapTexture(tex)}});var currentTexture="";if(object.model&&object.model.primitives.length>0){var primitive=object.model.primitives[0];var textureHandle=primitive.getTextureHandle();if(textureHandle){self.mapEditor.sceneUI.sceneAssetEditor.sceneUIListDBImages.findAndSelect(textureHandle.filename)}}}};var EditModelFunction=function(object){return function(){self.mapEditor.sceneUI.openAssetEditor("Edit Model",true,false,function(modelInfo){if(modelInfo){var modelID=modelInfo.objectID;if(modelID!==object.modelID||modelInfo.obj!==object.obj||modelInfo.tex!==object.tex){object.obj=modelInfo.obj;object.tex=modelInfo.tex;object.modelID=modelID;MultiplayerManager.Emit("EditorObjectModel",object.getID(),modelID);self.clearObjects()}}self.mapEditor.sceneUI.objectEditorOpen(objects)});DBAssets.LoadID(object.modelID,function(modelInfo){if(modelInfo){self.mapEditor.sceneUI.sceneAssetEditor.setModel(modelInfo)}else{self.mapEditor.sceneUI.sceneAssetEditor.setAsset(object.obj);self.mapEditor.sceneUI.sceneAssetEditor.setAsset(object.tex)}})}};var DeleteObjectFunction=function(object){return function(){self.mapEditor.deleteObject(object)}};var LoadModelFunction=function(object,tile,tex){return function(model3d){if(model3d){var modelObject=new CCObject;tile.addChild(modelObject);modelObject.setModel(model3d);modelObject.setTransparent();modelObject.setReadDepth(false);{var size=tile.collisionSize.width*.75;var scaleFactor;var modelWidth=model3d.getWidth()>model3d.getDepth()?model3d.getWidth():model3d.getDepth();var modelHeight=model3d.getHeight();if(modelWidth>modelHeight){scaleFactor=size/modelWidth}else{scaleFactor=size/modelHeight}model3d.setScale(scaleFactor)}if(tex){model3d.setTexture(tex)}object.modelObject=modelObject}}};var camera=this.camera;var tileWidth=camera.targetWidth;var tileHeight=camera.targetWidth*.125;var newObjects=[];for(i=0;i<objects.length;++i){newObject=objects[i];var text;if(objectsList.length>i){object=objectsList[i];if(object.object===newObject){text="size:"+CC.FloatLimitPrecision(newObject.collisionSize.width);text+=" x:"+CC.FloatLimitPrecision(newObject.position[0]);text+=" z:"+CC.FloatLimitPrecision(newObject.position[2]);tile=object.tileDescription;tile.setText(text);continue}}object={};object.object=newObject;object.tiles=[];objectsList.add(object);newObjects.add(object);{tile=new CCTile3DButton(this);tile.setupText(newObject.getID(),tileHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.set(.25,.9));tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(205);tile.onRelease.push(new FindObjectFunction(newObject));this.addTile(tile);object.tiles.add(tile)}if(newObject.obj){tile=new CCTile3DButton(this);tile.setupTile(tileWidth,tileWidth);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setDrawOrder(205);tile.onRelease.push(new FindObjectFunction(newObject));this.addTile(tile);object.tiles.add(tile);CCModel3D.CacheModel(newObject.obj,true,new LoadModelFunction(object,tile,newObject.tex))}{tile=new CCTile3DButton(this);object.tileDescription=tile;text="Size:"+CC.FloatLimitPrecision(newObject.collisionSize.width);text+=" X:"+CC.FloatLimitPrecision(newObject.position[0]);text+=" Z:"+CC.FloatLimitPrecision(newObject.position[2]);tile.setupText(text,tileHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.set(.25,.9));tile.setTextColour(gColour.setRGBA(1,1,1,1));
tile.setDrawOrder(205);this.addTile(tile);object.tiles.add(tile)}if(newObject.objectID==="ground"){{tile=new CCTile3DButton(this);tile.setupText("Edit Image",tileHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.setRGBA(.25,.5,.75,.9),true);tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(205);tile.onRelease.push(new EditImageFunction(newObject));this.addTile(tile);object.tiles.add(tile)}}else{if(newObject.modelID){tile=new CCTile3DButton(this);tile.setupText("Settings",tileHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.setRGBA(.25,.5,.75,.9),true);tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(205);tile.onRelease.push(new EditModelFunction(newObject));this.addTile(tile);object.tiles.add(tile)}{tile=new CCTile3DButton(this);tile.setupText("Delete",tileHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.setRGBA(.75,.25,.25,.9));tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(205);tile.onRelease.push(new DeleteObjectFunction(newObject));this.addTile(tile);object.tiles.add(tile)}}}var duration=1;for(i=0;i<objectsList.length;++i){tiles=objectsList[i].tiles;for(j=0;j>tiles.length;++j){tile=tiles[j];tile.movementInterpolator.setDuration(duration);duration+=.125}}this.requestResize();for(i=0;i<newObjects.length;++i){tiles=newObjects[i].tiles;for(j=0;j<tiles.length;++j){tile=tiles[j];tile.setPositionX(-camera.targetWidth*.5-tile.collisionSize.width);tile.translateTileMovementX(tile.collisionSize.width*1.5);tile.setColourAlpha(1,true);tile.setCollideable(true)}}};function SceneUIListObjectsUI(parentScene,editor){this.construct(parentScene);this.editor=editor}ExtendPrototype(SceneUIListObjectsUI,SceneUIListObjects);SceneUIListObjectsUI.prototype.setup=function(){var parentCameraIndex=gEngine.findCameraIndex(this.parentScene.camera);var camera=gEngine.newSceneCamera(this,parentCameraIndex+1);camera.setupViewport(0,0,.25,1);camera.setCameraWidth(640*.25,false);this.SceneUIListObjects_setup()};SceneUIListObjectsUI.prototype.updateScene=function(delta){var updated=this.CCSceneAppUI_updateScene(delta);var objects=this.objectsList;for(var i=0;i<objects.length;++i){var object=objects[i];if(object.modelObject){object.modelObject.rotateY(delta*30);object.modelObject.model.animate(delta)}}return updated};SceneUIListObjectsUI.prototype.render=function(camera,pass,alpha){this.CCSceneAppUI_render(camera,pass,alpha)};SceneUIListObjectsUI.prototype.resizeLists=function(y){this.resizeList(this.objectsList,y)};SceneUIListObjectsUI.prototype.showObjects=function(objects){var self=this;var i,j,tile,tiles,object,newObject;var objectsList=this.objectsList;for(i=0;i<objectsList.length;++i){object=objectsList[i];if(objects.length>i){newObject=objects[i]}else{newObject=null}if(object.object!==newObject){objectsList.remove(object);for(j=0;j<object.tiles.length;++j){tile=object.tiles[j];this.tiles.remove(tile);tile.deleteLater()}--i}}var FindObjectFunction=function(uiObject){return function(){self.editor.findObject(uiObject)}};var DeleteObjectFunction=function(uiObject){return function(){self.editor.deleteObject(uiObject)}};var EditTypeFunction=function(uiObject){return function(){var current=uiObject.constructor.name;AlertsManager.InputAlert(current,function(result){if(result){if(current!==result){var position=uiObject.position;self.editor.deleteObject(uiObject);self.editor.createObject(position,result)}}})}};var EditNameFunction=function(uiObject){return function(){var current=uiObject.name?uiObject.name:"";AlertsManager.InputAlert(current,function(result){if(result!==false){if(current!==result){uiObject.name=result;self.editor.updatedObject(uiObject)}}})}};var EditColourFunction=function(uiObject){return function(){var colouringObject=uiObject;if(colouringObject){var current=colouringObject.colour.toString();if(uiObject.isBlinking()){var textColourSplit=current.split(",");current=textColourSplit[0]+","+textColourSplit[1]+","+textColourSplit[2]+",1"}AlertsManager.InputAlert(current,function(result){if(result){if(current!==result){gColour.set(colouringObject.colour);colouringObject.setColour(gColour.fromString(result));self.editor.updatedObject(uiObject)}}},{dot:true,comma:true,minus:true})}}};var EditBlinkingFunction=function(uiObject){return function(){var blinking=uiObject.isBlinking();uiObject.setBlinking(!blinking);self.editor.updatedObject(uiObject)}};var EditImageFunction=function(uiObject){return function(){var sceneAssetEditor=new SceneAssetEditor(self,false,true);sceneAssetEditor.open("Select Image");var currentTexture=uiObject.getTileTextureFilename();if(currentTexture){sceneAssetEditor.sceneUIListDBImages.findAndSelect(currentTexture)}sceneAssetEditor.onClose=function(tex){if(tex){if(!uiObject.getTileTextureHandle()){uiObject.aspectRatioLocked=true}uiObject.setTileTexture(tex,function(tile){if(tile.aspectRatioLocked){tile.setTileTexturedWidth(tile.collisionSize.width)}});self.editor.updatedObject(uiObject)}}}};var EditImageAspectRatioFunction=function(uiObject){return function(){uiObject.aspectRatioLocked=!uiObject.aspectRatioLocked;self.editor.updatedObject(uiObject)}};var EditFullScreenFunction=function(uiObject){return function(){uiObject.fullScreen=!uiObject.fullScreen;self.editor.updatedObject(uiObject)}};var EditFlipXFunction=function(uiObject){return function(){uiObject.flipTileX();self.editor.updatedObject(uiObject)}};var EditFlipYFunction=function(uiObject){return function(){uiObject.flipTileY();self.editor.updatedObject(uiObject)}};var EditRotateZFunction=function(uiObject){return function(){var current=""+CC.FloatLimitPrecision(uiObject.rotation[2]);AlertsManager.InputAlert(current,function(result){if(result){if(current!==result){var newFloat=parseFloat(result);uiObject.setRotationZ(newFloat);self.editor.updatedObject(uiObject)}}},{dot:true,minus:true})}};var EditWidthFunction=function(uiObject){return function(){var current=""+CC.FloatLimitPrecision(self.editor.getReletiveWidth(uiObject)*100);AlertsManager.InputAlert(current,function(result){if(result){if(current!==result){var newFloat=parseFloat(result)/100;self.editor.setReletiveWidth(uiObject,newFloat);self.editor.updatedObject(uiObject)}}},{dot:true,minus:true})}};var EditHeightFunction=function(uiObject){return function(){var current=""+CC.FloatLimitPrecision(self.editor.getReletiveHeight(uiObject)*100);AlertsManager.InputAlert(current,function(result){if(result){if(current!==result){var newFloat=parseFloat(result)/100;self.editor.setReletiveHeight(uiObject,newFloat);self.editor.updatedObject(uiObject)}}},{dot:true,minus:true})}};var EditXFunction=function(uiObject){return function(){var current=""+CC.FloatLimitPrecision(self.editor.getReletiveX(uiObject)*100);AlertsManager.InputAlert(current,function(result){if(result){if(current!==result){var newFloat=parseFloat(result)/100;self.editor.setReletiveX(uiObject,newFloat);self.editor.updatedObject(uiObject)}}},{dot:true,minus:true})}};var EditYFunction=function(uiObject){return function(){var current=""+CC.FloatLimitPrecision(self.editor.getReletiveY(uiObject)*100);AlertsManager.InputAlert(current,function(result){if(result){if(current!==result){var newFloat=parseFloat(result)/100;self.editor.setReletiveY(uiObject,newFloat);self.editor.updatedObject(uiObject)}}},{dot:true,minus:true})}};var EditDrawOrderFunction=function(uiObject){return function(){var current=""+uiObject.drawOrder;AlertsManager.InputAlert(current,function(result){if(result){if(current!==result){result=parseInt(result,10);uiObject.setDrawOrder(result);self.editor.updatedObject(uiObject)}}},{letter:false})}};var EditTextFunction=function(uiObject){return function(){var currentText=uiObject.getText();if(!currentText){currentText=""}AlertsManager.InputAlert(currentText,function(result){if(result!==false){if(currentText!==result){if(!uiObject.getText()){uiObject.setTextScale(uiObject.textScale?uiObject.textScale:.75)}uiObject.setText(result);self.editor.updatedObject(uiObject)}}},{space:true,dot:true,comma:true,minus:true,length:32})}};var EditTextColourFunction=function(uiObject){return function(){var colouringObject=uiObject.textObject;if(colouringObject){var current=colouringObject.colour.toString();if(uiObject.isTextBlinking()){var textColourSplit=current.split(",");current=textColourSplit[0]+","+textColourSplit[1]+","+textColourSplit[2]+",1"}AlertsManager.InputAlert(current,function(result){if(result){if(current!==result){gColour.set(colouringObject.colour);colouringObject.setColour(gColour.fromString(result));self.editor.updatedObject(uiObject)}}},{dot:true,comma:true,minus:true})}}};var EditTextScaleFunction=function(uiObject){return function(){var current=""+(uiObject.textScale?CC.FloatLimitPrecision(uiObject.textScale):.75);AlertsManager.InputAlert(current,function(result){if(result){if(current!==result){var newFloat=parseFloat(result);uiObject.setTextScale(newFloat);self.editor.updatedObject(uiObject)}}},{dot:true,minus:true})}};var EditTextBlinkingFunction=function(uiObject){return function(){var blinking=uiObject.isTextBlinking();uiObject.setTextBlinking(!blinking);self.editor.updatedObject(uiObject)}};var Edit3DModelFunction=function(uiObject){return function(){var sceneAssetEditor=new SceneAssetEditor(self,true,true);sceneAssetEditor.open("Select Model");if(uiObject.model3dObject){sceneAssetEditor.sceneUIListDBModels.findAndSelect({obj:uiObject.model3dObject.obj,tex:uiObject.model3dObject.tex})}var currentTexture=uiObject.getTileTextureFilename();sceneAssetEditor.onClose=function(modelInfo){if(modelInfo){uiObject.set3DModel(modelInfo.obj,modelInfo.tex,1);self.editor.updatedObject(uiObject)}}}};var Edit3DModelColourFunction=function(uiObject){return function(){var colouringObject=uiObject.model3dObject;if(colouringObject){var current=colouringObject.colour.toString();AlertsManager.InputAlert(current,function(result){if(result){if(current!==result){gColour.set(colouringObject.colour);colouringObject.setColour(gColour.fromString(result));self.editor.updatedObject(uiObject)}}},{dot:true,comma:true,minus:true})}}};var Edit3DModelRotationFunction=function(uiObject){return function(){if(uiObject.model3dObject){var current=vec3.toString(uiObject.model3dObject.rotation);AlertsManager.InputAlert(current,function(result){if(result){if(current!==result){var newVector=vec3.fromString(result);uiObject.set3DModelRotation(newVector);self.editor.updatedObject(uiObject)}}},{dot:true,comma:true,minus:true})}}};var Edit3DModelAnimationSpeedFunction=function(uiObject){return function(){if(uiObject.model3dObject){var current=""+(uiObject.model3dAnimationSpeed?CC.FloatLimitPrecision(uiObject.model3dAnimationSpeed):0);AlertsManager.InputAlert(current,function(result){if(result){if(current!==result){var newFloat=parseFloat(result);uiObject.set3DModelAnimationSpeed(newFloat);self.editor.updatedObject(uiObject)}}},{dot:true})}}};var EditOnTouchFunction=function(uiObject,onTouch){return function(){var current="";if(onTouch.length>0){current=onTouch[0]}AlertsManager.InputAlert(current,function(result){if(result!==false){if(current!==result){result=result.formatSpacesAndTabs();result=self.editor.validateJS(result);if(result){if(onTouch.length>0){onTouch[0]=result}else{onTouch.push(result)}}else{if(onTouch.length>0){onTouch.pop()}}self.editor.updatedObject(uiObject)}}},{space:true,dot:true,minus:true,functional:true,height:.35,length:64})}};var camera=this.camera;var tileWidth=camera.targetWidth;var tileHeight=camera.targetWidth*.125;var newObjects=[];for(i=0;i<objects.length;++i){newObject=objects[i];if(objectsList.length>i){object=objectsList[i];if(object.object===newObject){this.updateObject(object,newObject);continue}}object={};object.object=newObject;object.tiles=[];objectsList.add(object);newObjects.add(object);{tile=new CCTile3DButton(this);tile.setupText("Delete",tileHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.setRGBA(.75,.25,.25,.9));tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(205);tile.onRelease.push(new DeleteObjectFunction(newObject));this.addTile(tile);object.tiles.add(tile)}{tile=new CCTile3DButton(this);tile.setupText("",tileHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.set(.25,.9));tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(205);tile.onRelease.push(new EditTypeFunction(newObject));this.addTile(tile);object.tiles.add(tile);object.tileType=tile}{tile=new CCTile3DButton(this);tile.setupText("",tileHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.set(.25,.9));tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(205);tile.onRelease.push(new EditNameFunction(newObject));this.addTile(tile);object.tiles.add(tile);object.tileName=tile}{tile=new CCTile3DButton(this);tile.setupText("",tileHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.set(1,.9));tile.setDrawOrder(205);tile.onRelease.push(new EditImageFunction(newObject));this.addTile(tile);object.tiles.add(tile);object.tileImage=tile}{tile=new CCTile3DButton(this);tile.setupText("",tileHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.set(.25,.9));tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(205);tile.onRelease.push(new EditColourFunction(newObject));this.addTile(tile);object.tiles.add(tile);object.tileColour=tile}{tile=new CCTile3DButton(this);tile.setupText("",tileHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.set(.25,.9));tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(205);tile.onRelease.push(new EditBlinkingFunction(newObject,true));this.addTile(tile);object.tiles.add(tile);object.tileBlinking=tile}{tile=new CCTile3DButton(this);tile.setupText("",tileHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.set(.25,.9));tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(205);tile.onRelease.push(new EditImageAspectRatioFunction(newObject));this.addTile(tile);object.tiles.add(tile);object.tileImageAspectRatio=tile}{tile=new CCTile3DButton(this);tile.setupText("",tileHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.set(.25,.9));tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(205);tile.onRelease.push(new EditFullScreenFunction(newObject));this.addTile(tile);object.tiles.add(tile);object.tileFullScreen=tile}{tile=new CCTile3DButton(this);tile.setupText("",tileHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.set(.25,.9));tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(205);tile.onRelease.push(new EditFlipXFunction(newObject));this.addTile(tile);object.tiles.add(tile);object.tileFlippedX=tile}{tile=new CCTile3DButton(this);tile.setupText("",tileHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.set(.25,.9));tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(205);tile.onRelease.push(new EditFlipYFunction(newObject));this.addTile(tile);object.tiles.add(tile);object.tileFlippedY=tile}{tile=new CCTile3DButton(this);tile.setupText("",tileHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.set(.25,.9));tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(205);tile.onRelease.push(new EditRotateZFunction(newObject));this.addTile(tile);object.tiles.add(tile);object.tileRotate=tile}{tile=new CCTile3DButton(this);tile.setupText("",tileHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.set(.25,.9));tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(205);tile.onRelease.push(new EditDrawOrderFunction(newObject));this.addTile(tile);object.tiles.add(tile);object.tileDrawOrder=tile}{tile=new CCTile3DButton(this);tile.setupText("",tileHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.set(.25,.9));tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(205);tile.onRelease.push(new EditWidthFunction(newObject));this.addTile(tile);object.tiles.add(tile);object.tileWidth=tile}{tile=new CCTile3DButton(this);tile.setupText("",tileHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.set(.25,.9));tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(205);tile.onRelease.push(new EditHeightFunction(newObject));this.addTile(tile);object.tiles.add(tile);object.tileHeight=tile}{tile=new CCTile3DButton(this);tile.setupText("",tileHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.set(.25,.9));tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(205);tile.onRelease.push(new EditXFunction(newObject));this.addTile(tile);object.tiles.add(tile);object.tileX=tile}{tile=new CCTile3DButton(this);tile.setupText("",tileHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.set(.25,.9));tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(205);tile.onRelease.push(new EditYFunction(newObject));this.addTile(tile);object.tiles.add(tile);object.tileY=tile}{tile=new CCTile3DButton(this);tile.setupText("",tileHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.set(.25,.9));tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(205);tile.onRelease.push(new EditTextFunction(newObject));this.addTile(tile);object.tiles.add(tile);object.tileText=tile}{tile=new CCTile3DButton(this);tile.setupText("",tileHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.set(.25,.9));tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(205);tile.onRelease.push(new EditTextScaleFunction(newObject));this.addTile(tile);object.tiles.add(tile);object.tileTextScale=tile}{tile=new CCTile3DButton(this);tile.setupText("",tileHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.set(.25,.9));tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(205);tile.onRelease.push(new EditTextColourFunction(newObject,true));this.addTile(tile);object.tiles.add(tile);object.tileTextColour=tile}{tile=new CCTile3DButton(this);tile.setupText("",tileHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.set(.25,.9));tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(205);tile.onRelease.push(new EditTextBlinkingFunction(newObject,true));this.addTile(tile);object.tiles.add(tile);object.tileTextBlinking=tile}{tile=new CCTile3DButton(this);tile.setupText("",tileHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.set(1,.9));tile.setDrawOrder(205);tile.onRelease.push(new Edit3DModelFunction(newObject,true));this.addTile(tile);object.tiles.add(tile);object.tile3DModel=tile}{tile=new CCTile3DButton(this);tile.setupText("",tileHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.set(.25,.9));tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(205);tile.onRelease.push(new Edit3DModelColourFunction(newObject,true));this.addTile(tile);object.tiles.add(tile);object.tile3DModelColour=tile}{tile=new CCTile3DButton(this);tile.setupText("",tileHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.set(1,.9));tile.setDrawOrder(205);tile.onRelease.push(new Edit3DModelRotationFunction(newObject,true));this.addTile(tile);object.tiles.add(tile);object.tile3DModelRotation=tile}{tile=new CCTile3DButton(this);tile.setupText("",tileHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.set(1,.9));tile.setDrawOrder(205);tile.onRelease.push(new Edit3DModelAnimationSpeedFunction(newObject,true));this.addTile(tile);object.tiles.add(tile);object.tile3DModelAnimationSpeed=tile}{tile=new CCTile3DButton(this);tile.setupText("",tileHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColour(EditorManager.LightBlue);tile.setColourAlpha(0,false);tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(205);tile.onRelease.push(new EditOnTouchFunction(newObject,newObject.onPress));this.addTile(tile);object.tiles.add(tile);object.tileOnPress=tile}{tile=new CCTile3DButton(this);tile.setupText("",tileHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColour(EditorManager.LightBlue);tile.setColourAlpha(0,false);tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(205);tile.onRelease.push(new EditOnTouchFunction(newObject,newObject.onLoss));this.addTile(tile);object.tiles.add(tile);object.tileOnLoss=tile}{tile=new CCTile3DButton(this);tile.setupText("",tileHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColour(EditorManager.LightBlue);tile.setColourAlpha(0,false);tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(205);tile.onRelease.push(new EditOnTouchFunction(newObject,newObject.onRelease));this.addTile(tile);object.tiles.add(tile);object.tileOnRelease=tile}this.updateObject(object,newObject)}var duration=1;for(i=0;i<objectsList.length;++i){tiles=objectsList[i].tiles;for(j=0;j>tiles.length;++j){tile=tiles[j];tile.movementInterpolator.setDuration(duration);duration+=.125}}this.requestResize();for(i=0;i<newObjects.length;++i){tiles=newObjects[i].tiles;for(j=0;j<tiles.length;++j){tile=tiles[j];tile.setPositionX(-camera.targetWidth*.5-tile.collisionSize.width);tile.setTileMovementX(0);tile.setColourAlpha(1,true);tile.setCollideable(true)}}};SceneUIListObjectsUI.prototype.updateObject=function(listObject,uiObject){var self=this;listObject.tileType.setText(uiObject.constructor.name);if(uiObject.name){listObject.tileName.setText("Name: "+uiObject.name)}else{listObject.tileName.setText("Name...")}var currentTexture=uiObject.getTileTextureFilename();if(currentTexture){listObject.tileImage.setTileTexture(currentTexture,function(tile,textureHandle){if(self.camera){tile.setupTexturedFit(self.camera.targetWidth,self.camera.targetHeight*.1);self.requestResize()}});listObject.tileImage.setText("")}else{listObject.tileImage.setText("Select Image...")}var colour=uiObject.colour?uiObject.colour.toString():"1,1,1,1";if(uiObject.isBlinking()){var colourSplit=colour.split(",");colour=colourSplit[0]+","+colourSplit[1]+","+colourSplit[2]+",1"}listObject.tileColour.setText("Tile Colour: "+colour);if(uiObject.colour){listObject.tileColour.setColour(gColour.setRGBA(uiObject.colour.r*.5,uiObject.colour.g*.5,uiObject.colour.b*.5,1))}listObject.tileBlinking.setText("Blinking: "+(uiObject.isBlinking()?"true":"false"));listObject.tileImageAspectRatio.setText(uiObject.aspectRatioLocked?"Aspect Ratio Locked":"Aspect Ratio Unlocked");listObject.tileFullScreen.setText("Fullscreen: "+(uiObject.fullScreen?"true":"false"));listObject.tileFlippedX.setText("Flip X");listObject.tileFlippedY.setText("Flip Y");listObject.tileRotate.setText("Rotate: "+uiObject.rotation[2]);listObject.tileDrawOrder.setText("Draw Order: "+uiObject.drawOrder);listObject.tileWidth.setText("Width: "+CC.FloatLimitPrecision(this.editor.getReletiveWidth(uiObject)*100)+"%");listObject.tileHeight.setText("Height: "+CC.FloatLimitPrecision(this.editor.getReletiveHeight(uiObject)*100)+"%");listObject.tileX.setText("X: "+CC.FloatLimitPrecision(this.editor.getReletiveX(uiObject)*100)+"%");listObject.tileY.setText("Y: "+CC.FloatLimitPrecision(this.editor.getReletiveY(uiObject)*100)+"%");var currentText=uiObject.getText();listObject.tileText.setText("Text: "+currentText);var textColour=currentText?uiObject.textObject.colour.toString():"0,0,0,1";if(uiObject.isTextBlinking()){var textColourSplit=textColour.split(",");textColour=textColourSplit[0]+","+textColourSplit[1]+","+textColourSplit[2]+",1"}listObject.tileTextColour.setText("Text Colour: "+textColour);if(currentText){listObject.tileTextColour.setColour(gColour.setRGBA(uiObject.textObject.colour.r*.5,uiObject.textObject.colour.g*.5,uiObject.textObject.colour.b*.5,1))}listObject.tileTextBlinking.setText("Text Blinking: "+(uiObject.isTextBlinking()?"true":"false"));listObject.tileTextScale.setText("Text Scale: "+CC.FloatLimitPrecision(uiObject.textScale?uiObject.textScale:.75));if(uiObject.get3DModelFilename()){listObject.tile3DModel.set3DModel(uiObject.get3DModelFilename(),uiObject.get3DModelTextureFilename(),1);listObject.tile3DModel.setTileSize(listObject.tile3DModel.collisionSize.width);listObject.tile3DModel.setTextColourAlpha(0,true);listObject.tile3DModelColour.setText("Model Colour: "+(uiObject.model3dObject.colour?uiObject.model3dObject.colour.toString():"1,1,1,1"));listObject.tile3DModelColour.setColour(gColour.setRGBA(uiObject.model3dObject.colour.r*.5,uiObject.model3dObject.colour.g*.5,uiObject.model3dObject.colour.b*.5,1));listObject.tile3DModelRotation.setText("Rotation: "+vec3.toString(uiObject.model3dObject.rotation));listObject.tile3DModelAnimationSpeed.setText("Animation Speed: "+(uiObject.model3dAnimationSpeed!==undefined?uiObject.model3dAnimationSpeed:0))}else{listObject.tile3DModel.setText("Select 3D Model...");listObject.tile3DModel.setTextColourAlpha(1,true);listObject.tile3DModelColour.setText("");listObject.tile3DModelColour.setColour(gColour.setRGBA(1,1,1,1));listObject.tile3DModelRotation.setText("");listObject.tile3DModelAnimationSpeed.setText("")}if(uiObject.onPress.length>0){var onPress=uiObject.onPress[0];if(onPress.length>16){onPress="..."+onPress.substring(onPress.length-17)}listObject.tileOnPress.setText("On Press: "+onPress)}else{listObject.tileOnPress.setText("On Press...")}if(uiObject.onRelease.length>0){var onRelease=uiObject.onRelease[0];if(onRelease.length>16){onRelease="..."+onRelease.substring(onRelease.length-17)}listObject.tileOnRelease.setText("On Release: "+onRelease)}else{listObject.tileOnRelease.setText("On Release...")}if(uiObject.onLoss.length>0){var onLoss=uiObject.onLoss[0];if(onLoss.length>16){onLoss="..."+onLoss.substring(onLoss.length-17)}listObject.tileOnLoss.setText("On Loss: "+onLoss)}else{listObject.tileOnLoss.setText("On Loss...")}};function SceneUIListDB(parentScene){this.construct(parentScene)}ExtendPrototype(SceneUIListDB,SceneUIList);SceneUIListDB.prototype.construct=function(parentScene){if(!this.maxColumns){this.maxColumns=1}if(!this.maxRowsPerPage){this.maxRowsPerPage=4}this.SceneUIList_construct();{this.setParent(parentScene)}gEngine.addScene(this)};SceneUIListDB.prototype.setup=function(openSource){var camera;if(this.camera){camera=this.camera}else{camera=gEngine.newSceneCamera(this);camera.setupViewport(0,0,.125,1);camera.setCameraWidth(640*.125,false)}var tile;{tile=new CCTile3DButton(this);tile.setupTile();tile.setTileTexture("editor_tile_background.jpg");tile.setColour(gColour.set(.5,0));tile.setColourAlpha(.95,true);tile.setDrawOrder(200);this.cameraStickyTiles.add(tile);this.tileBackground=tile}this.selectionIndex=-1;var self=this;var tileWidth=camera.targetWidth/this.maxColumns;if(tileWidth>100){tileWidth=100}var tileHeight=tileWidth*.5;if(this.onNew){tile=new CCTile3DButton(this);tile.visibleOnlyUpdate=true;tile.setupText("+",tileHeight,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.setRGBA(.25,.75,.25,0));tile.setTextColour(gColour.setRGBA(1,1,1,0));tile.setColourAlpha(.9,true);tile.setTextColourAlpha(1,true);tile.setDrawOrder(205);tile.onRelease.push(function(){self.onNew()});this.addTile(tile);this.tileNew=tile}function ObjectsList(category,scene,createHeadingTile){this.category=category;this.db=[];this.objects=[];this.currentPage=0;this.tiles=[];var tile;this.open=true;var self=this;if(createHeadingTile){this.open=false;tile=new CCTile3DButton(scene);tile.visibleOnlyUpdate=true;tile.setupText(category,tileHeight*.5,true,true);tile.setTileSize(camera.targetWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.setRGBA(.25,.75,.25,0));tile.setTextColour(gColour.setRGBA(1,1,1,0));tile.setColourAlpha(.9,true);tile.setTextColourAlpha(1,true);tile.setDrawOrder(205);tile.onRelease.push(function(){self.open=!self.open;scene.show()});scene.addTile(tile);this.tileHeading=tile;this.tiles.push(tile)}{tile=new CCTile3DButton(scene);tile.visibleOnlyUpdate=true;tile.setupText("<",tileHeight*.5,true,true);tile.setTileSize(camera.targetWidth*.5,tileHeight*.75);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.setRGBA(.25,.75,.25,0));tile.setTextColour(gColour.setRGBA(1,1,1,0));tile.setColourAlpha(.9,true);tile.setTextColourAlpha(1,true);tile.setDrawOrder(205);tile.onRelease.push(function(){self.currentPage--;scene.show()});scene.addTile(tile);this.tilePrevious=tile;this.tiles.push(tile)}{tile=new CCTile3DButton(scene);tile.visibleOnlyUpdate=true;tile.setupText(">",tileHeight*.5,true,true);tile.setTileSize(camera.targetWidth*.5,tileHeight*.75);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.setRGBA(.25,.75,.25,0));tile.setTextColour(gColour.setRGBA(1,1,1,0));tile.setColourAlpha(.9,true);tile.setTextColourAlpha(1,true);tile.setDrawOrder(205);tile.onRelease.push(function(){self.currentPage++;scene.show()});scene.addTile(tile);this.tileNext=tile;this.tiles.push(tile)}}this.objectsLists=[];this.objectsLists.push(new ObjectsList("All",this,true));this.objectsLists[0].open=true;if(openSource||openSource===undefined){this.objectsLists.push(new ObjectsList("Open Source",this,true))}this.requestResize();this.show();this.loadList()};SceneUIListDB.prototype.updateScene=function(delta){var updated=this.SceneUIList_updateScene(delta);var selectedID=this.getSelectedID();
if(selectedID!==-1){var objectsLists=this.objectsLists;for(var listIndex=0;listIndex<objectsLists.length;++listIndex){var objectsList=objectsLists[listIndex];var objects=objectsList.objects;for(i=0;i<objects.length;++i){var object=objects[i];var objectID=DBAssets.GetID(object.info);if(objectID===selectedID){if(object.modelObject){object.modelObject.rotateY(delta*30);object.modelObject.model.animate(delta)}}}}}return updated};SceneUIListDB.prototype.resize=function(){this.SceneUIList_resize();var camera=this.camera;var tile;{tile=this.tileBackground;tile.setTileSize(camera.targetWidth,camera.targetHeight)}this.resizeLists(camera.cameraHHeight)};SceneUIListDB.prototype.resizeLists=function(y){var camera=this.camera;var tile;if(this.tileNew){tile=this.tileNew;y-=tile.collisionBounds[1];tile.setPositionXY(-camera.targetWidth*.5+tile.collisionBounds[0],y);y-=tile.collisionBounds[1];y-=camera.cameraHHeight*.05}var objectsLists=this.objectsLists;for(var listIndex=0;listIndex<objectsLists.length;++listIndex){var objectsList=objectsLists[listIndex];tile=objectsList.tileHeading;if(tile){if(objectsList.db.length>0){tile.setColourAlpha(1,false);tile.setTextColourAlpha(1,false);y-=tile.collisionBounds[1];tile.setPositionY(y);y-=tile.collisionBounds[1]}else{tile.setColourAlpha(0,false);tile.setTextColourAlpha(0,false)}}y=this.resizeList(objectsList.objects,y);tile=objectsList.tilePrevious;if(objectsList.open){y-=tile.collisionBounds[1];tile.setPositionXY(-tile.collisionBounds[0],y)}var currentPage=objectsList.currentPage;if(objectsList.open&&currentPage>0){tile.setColourAlpha(1,false);tile.setTextColourAlpha(1,false);tile.setCollideable(true)}else{tile.setColourAlpha(0,false);tile.setTextColourAlpha(0,false);tile.setCollideable(false)}tile=objectsList.tileNext;if(objectsList.open){tile.setPositionXY(tile.collisionBounds[0],y);y-=tile.collisionBounds[1]}var maxItems=this.maxColumns*this.maxRowsPerPage;var startIndex=currentPage*maxItems;var endIndex=startIndex+maxItems;if(objectsList.open&&endIndex<objectsList.db.length){tile.setColourAlpha(1,false);tile.setTextColourAlpha(1,false);tile.setCollideable(true)}else{tile.setColourAlpha(0,false);tile.setTextColourAlpha(0,false);tile.setCollideable(false)}if(objectsList.open){y-=camera.cameraHHeight*.05}}};SceneUIListDB.prototype.resizeList=function(list,currentY){var camera=this.camera;var maxColumns=this.maxColumns;var xIncrement=camera.targetWidth/maxColumns;var xStart=-camera.targetWidth*.5+xIncrement*.5;var i,j,object,tiles,tile;var columnIndex=0;var x=xStart;var y=currentY;var bottomY=y;for(i=0;i<list.length;++i){currentY=y;object=list[i];tiles=object.tiles;for(j=0;j<tiles.length;++j){tile=tiles[j];currentY-=tile.collisionBounds[1];tile.setPositionXYZ(x,currentY,0);if(!tile.positioned){tile.positioned=true;tile.setPositionX(-camera.targetWidth*.5-tile.collisionBounds[0])}currentY-=tile.collisionBounds[1]}if(currentY<bottomY){bottomY=currentY}x+=xIncrement;if(columnIndex===maxColumns-1){columnIndex=0;x=xStart;y=bottomY}else{columnIndex++}}return bottomY};SceneUIListDB.prototype.positionObjectsList=function(list){var camera=this.camera;var cameraTop=camera.targetLookAt[1]-camera.targetHeight*.5;var cameraBottom=camera.targetLookAt[1]+camera.targetHeight*.5;var maxColumns=this.maxColumns;var xIncrement=camera.targetWidth/maxColumns;var xStart=-camera.targetWidth*.5+xIncrement*.5;var x=xStart;var columnIndex=0;for(var i=0;i<list.length;++i){var tiles=list[i].tiles;for(var j=0;j<tiles.length;++j){var tile=tiles[j];var visible=false;if(tile.aabbMax[1]>cameraTop){if(tile.aabbMin[1]<cameraBottom){visible=true}}{tile.setPositionX(x)}tile.setCollideable(true)}x+=xIncrement;if(columnIndex===maxColumns-1){columnIndex=0;x=xStart}else{columnIndex++}}};SceneUIListDB.prototype.show=function(){if(this.closing){return}var db=this.list;if(db){db.sort(function(a,b){return b.timestamp-a.timestamp});var objectsLists=this.objectsLists;var listIndex,objectsList;for(listIndex=0;listIndex<objectsLists.length;++listIndex){objectsList=objectsLists[listIndex];objectsList.db.length=0}var info;for(i=0;i<db.length;++i){info=db[i];if(MultiplayerManager.IsOwner(info.owners)){objectsLists[0].db.push(info)}else{objectsLists[1].db.push(info)}}var i,tile,tiles,j;var object;for(listIndex=0;listIndex<objectsLists.length;++listIndex){objectsList=objectsLists[listIndex];db=objectsList.db;var objects=objectsList.objects;var maxItems=this.maxColumns*this.maxRowsPerPage;if(objectsList.currentPage<0){objectsList.currentPage=0}if(objectsList.currentPage*maxItems>db.length){objectsList.currentPage=parseInt(db.length/maxItems,10)}var currentPage=objectsList.currentPage;var startIndex=currentPage*maxItems;var endIndex=startIndex+maxItems;var objectIndex=0;if(objectsList.open){for(i=startIndex;i<endIndex&&i<db.length;++i,++objectIndex){info=db[i];if(objects.length>i){object=objects[objectIndex];var newInfoString=JSON.stringify(info);var currentInfoString=JSON.stringify(object.info);if(newInfoString===currentInfoString){continue}objectsList.objects.remove(object);for(j=0;j<object.tiles.length;++j){tile=object.tiles[j];this.tiles.remove(tile);tile.deleteLater()}}object=this.createObject(info);objects.insert(object,objectIndex)}}while(objects.length>objectIndex){object=objects[objectIndex];objects.remove(object);for(j=0;j<object.tiles.length;++j){tile=object.tiles[j];this.tiles.remove(tile);tile.deleteLater()}}}}this.refreshedObjectsList();this.highlightSelectedObject()};SceneUIListDB.prototype.refreshedObjectsList=function(){var camera=this.camera;var tiles,i,tile,j;this.requestResize();var objectsLists=this.objectsLists;for(var listIndex=0;listIndex<objectsLists.length;++listIndex){var objectsList=objectsLists[listIndex];this.positionObjectsList(objectsList.objects);var duration=1;for(i=0;i<objectsList.objects.length;++i){tiles=objectsList.objects[i].tiles;for(j=0;j<tiles.length;++j){tile=tiles[j];tile.movementInterpolator.setDuration(duration)}}}this.highlightSelectedObject()};SceneUIListDB.prototype.close=function(){this.closing=true;var self=this;var camera=this.camera;var tile,tiles;{tile=this.tileBackground;tile.setColourAlpha(0,true,function(){self.deleteLater()})}if(this.tileNew){tile=this.tileNew;tile.setTileMovementX(-camera.targetWidth*.5-tile.collisionSize.width);tile.setColour(gColour.setRGBA(1,1,1,0),true);tile.setCollideable(false)}var objectsLists=this.objectsLists;for(var listIndex=0;listIndex<objectsLists.length;++listIndex){var objectsList=objectsLists[listIndex];tiles=objectsList.tiles;for(i=0;i<tiles.length;++i){tile=tiles[i];tile.setTileMovementX(-camera.targetWidth*.5-tile.collisionSize.width);tile.setColour(gColour.setRGBA(1,1,1,0),true);tile.setCollideable(false)}var objects=objectsList.objects;for(i=0;i<objects.length;++i){object=objects[i];tiles=object.tiles;for(var j=0;j<tiles.length;++j){tile=tiles[j];{tile.setPositionX(-camera.targetWidth*.5-tile.collisionSize.width)}tile.setColour(gColour.setRGBA(1,1,1,0),tile.visible);tile.setCollideable(false)}}}};SceneUIListDB.prototype.highlightSelectedObject=function(){var camera=this.camera;var cameraTop=camera.targetLookAt[1]-camera.targetHeight*.5;var cameraBottom=camera.targetLookAt[1]+camera.targetHeight*.5;var selectedID=this.getSelectedID();var objectsLists=this.objectsLists;for(var listIndex=0;listIndex<objectsLists.length;++listIndex){var objectsList=objectsLists[listIndex];var objects=objectsList.objects;for(i=0;i<objects.length;++i){var object=objects[i];var objectID=DBAssets.GetID(object.info);var tiles=object.tiles;for(var j=0;j<tiles.length;++j){var tile=tiles[j];var visible=false;if(tile.aabbMax[1]>cameraTop){if(tile.aabbMin[1]<cameraBottom){visible=true}}if(objectID===selectedID){if(j===tiles.length-1){camera.targetLookAt[1]=tile.position[1];this.refreshCameraView();this.lockCameraView()}if(j===0){tile.setColour(gColour.setRGBA(.4,.5,.75,0),false)}tile.setColourAlpha(1,false)}else{if(j===0){tile.setColour(gColour.set(.25,0),false)}tile.setColourAlpha(.75,false)}}}}};SceneUIListDB.prototype.getInfoIndex=function(info){if(this.list){var id=DBAssets.GetID(info);var list=this.list;for(var i=0;i<list.length;++i){var itrID=DBAssets.GetID(list[i]);if(itrID===id){return i}}}return-1};SceneUIListDB.prototype.getInfo=function(index){if(this.list&&index>=0&&index<this.list.length){return this.list[index]}return null};SceneUIListDB.prototype.getSelected=function(){return this.getInfo(this.selectionIndex)};SceneUIListDB.prototype.getSelectedID=function(){var selectedInfo=this.getSelected();if(selectedInfo){return DBAssets.GetID(selectedInfo)}return-1};SceneUIListDB.prototype.unselect=function(){this.selectionIndex=-1;this.highlightSelectedObject()};SceneUIListDB.prototype.loadList=function(){var self=this;CCFileManager.Load(this.constructor.name+".db",function(data){if(data){if(!self.list){var list=JSON.parse(data);if(!self.loaded){self.list=list;self.show()}if(this.onUpdate){this.onUpdate(list)}}}})};SceneUIListDB.prototype.saveList=function(){CCFileManager.Save(this.constructor.name+".db",this.list)};SceneUIListDB.prototype.syncList=function(list){this.list=list;this.show();this.saveList();if(!this.loaded){this.loaded=true;if(this.onLoaded){this.onLoaded()}}if(this.onUpdate){this.onUpdate(list)}};SceneUIListDB.prototype.syncEdit=function(info){var camera=this.camera;var i,itr,itrID;var id=DBAssets.GetID(info);if(this.list){var found=false;for(i=0;i<this.list.length;++i){itr=this.list[i];itrID=DBAssets.GetID(itr);if(itrID===id){this.list[i]=info;found=true;break}}if(!found){this.list.push(info)}this.saveList()}var object;var objectsLists=this.objectsLists;for(var listIndex=0;listIndex<objectsLists.length;++listIndex){var objectsList=objectsLists[listIndex];var objects=objectsList.objects;for(i=0;i<objects.length;++i){object=objects[i];var objectID=DBAssets.GetID(object.info);if(objectID===id){if(this.updateObject){this.updateObject(object,info)}}}}if(!object){this.show()}};SceneUIListDB.prototype.syncDelete=function(id){var self=this;var i,itr,itrID;var selectedID=this.getSelectedID();if(selectedID===id){this.unselect()}if(this.list){for(i=0;i<this.list.length;++i){itr=this.list[i];itrID=DBAssets.GetID(itr);if(itrID===id){this.list.remove(itr);this.saveList();break}}}var objectsLists=this.objectsLists;for(var listIndex=0;listIndex<objectsLists.length;++listIndex){var objectsList=objectsLists[listIndex];var objects=objectsList.objects;for(i=0;i<objects.length;++i){object=objects[i];var objectID=DBAssets.GetID(object.info);if(objectID===id){objects.remove(object);for(j=0;j<object.tiles.length;++j){tile=object.tiles[j];this.tiles.remove(tile);tile.deleteLater()}}}}this.show()};SceneUIListDB.prototype.selectIndex=function(selectionIndex,callback,findInfo){if(this.selectionIndex!==selectionIndex){this.selectionIndex=selectionIndex;this.highlightSelectedObject()}var selectedID=this.getSelectedID();var objectsLists=this.objectsLists;for(var listIndex=0;listIndex<objectsLists.length;++listIndex){var objectsList=objectsLists[listIndex];var db=objectsList.db;var maxItems=this.maxColumns*this.maxRowsPerPage;for(var i=0;i<db.length;++i){var info=db[i];var id=DBAssets.GetID(info);if(id===selectedID){if(!objectsList.open){objectsList.open=true}var currentPage=parseInt(i/maxItems,10);if(objectsList.currentPage!==currentPage){objectsList.currentPage=currentPage;break}}}}this.show();var selectedInfo=this.getSelected();if(this.onSelected){this.onSelected(selectedInfo)}if(callback){callback(selectedInfo)}};SceneUIListDB.prototype.findAndSelectID=function(id,callback,findInfo){var list=this.list;if(list){for(var i=0;i<list.length;++i){var itr=list[i];var itrID=DBAssets.GetID(itr);if(itrID===id){this.selectIndex(i,callback,findInfo);return}}this.selectionIndex=-1;this.highlightSelectedObject()}if(!this.loaded){var self=this;this.onLoaded=function(){self.findAndSelectID(id,callback,findInfo)}}else{if(callback){callback(false)}}};function SceneUIListDBAudio(parentScene,onNew){MultiplayerManager.UpdateCallbacks.addOnce(this);this.maxColumns=4;this.onNew=onNew;var self=this;this.onDragDropFunction=function(files,event){self.onDragDrop(files,event)};gEngine.controls.onDragDrop.add(this.onDragDropFunction);this.construct(parentScene)}ExtendPrototype(SceneUIListDBAudio,SceneUIListDB);SceneUIListDBAudio.prototype.deleteLater=function(){if(this.onDragDropFunction){gEngine.controls.onDragDrop.remove(this.onDragDropFunction);this.onDragDropFunction=null}if(this.syncingUpdates){MultiplayerManager.Emit("EditorAudioUnregisterListUpdates");this.syncingUpdates=false}this.SceneUIListDB_deleteLater()};SceneUIListDBAudio.prototype.setup=function(){var parentCameraIndex=gEngine.findCameraIndex(this.parentScene.camera);var camera=gEngine.newSceneCamera(this,parentCameraIndex+1);camera.setupViewport(0,0,1,1);camera.setCameraWidth(640*1,false);this.SceneUIListDB_setup();if(MultiplayerManager.Emit("EditorAudioRequestList")){this.syncingUpdates=true}this.requestResize()};SceneUIListDBAudio.prototype.syncUpdate=function(jsonData){if(jsonData.EditorAudio){this.syncList(jsonData.EditorAudio)}else if(jsonData.EditorAudioDeleted!==undefined){var id=jsonData.EditorAudioDeleted;this.syncDelete(id)}else if(jsonData.EditorAudioUpdated){var info=jsonData.EditorAudioUpdated;this.syncEdit(info);if(!this.loaded){this.loaded=true;if(this.onLoaded){this.onLoaded()}}}};SceneUIListDBAudio.prototype.createObject=function(info){var self=this;var objectsList=this.objectsList;var SelectObjectFunction=function(info){return function(){var infoIndex=self.getInfoIndex(info);if(self.selectionIndex!==infoIndex){self.selectionIndex=infoIndex;self.highlightSelectedObject()}if(self.onSelected){self.onSelected(info)}}};var EditFunction=function(object){return function(){self.onEdit(object.info)}};var camera=this.camera;var tileWidth=camera.targetWidth/this.maxColumns;var tileHeight=tileWidth*.2;var object={};object.tiles=[];object.info=info;var tile;{tile=new CCTile3DButton(this);tile.setupText(""+info.id,tileHeight,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.set(.25,.9));tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(205);tile.onRelease.push(new SelectObjectFunction(info));this.addTile(tile);object.tiles.add(tile)}{tile=new CCTile3DButton(this);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.set(1,.9));tile.setDrawOrder(205);tile.onRelease.push(new SelectObjectFunction(info));this.addTile(tile);object.tiles.add(tile);object.tileMP3=tile}this.updateObject(object,info);if(this.onEdit){tile=new CCTile3DButton(this);tile.setupText("edit",tileHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.setRGBA(.25,.5,.75,.9));tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(205);tile.onRelease.push(new EditFunction(object));this.addTile(tile);object.tiles.add(tile)}return object};SceneUIListDBAudio.prototype.updateObject=function(object,info){var tile=object.tileMP3;var camera=this.camera;var tileWidth=camera.targetWidth/this.maxColumns;var tileHeight=tileWidth*.175;var friendlyName=String.SplitBefore(info.mp3,"_");friendlyName+=".mp3";tile.setupText(friendlyName,tileHeight*.4,true,true);tile.setTileSize(tileWidth,tileHeight)};SceneUIListDBAudio.prototype.onDragDrop=function(files,event){if(event&&event.target){if(MultiplayerManager.LoggedIn){if(!this.sceneEditor){this.sceneEditor=new SceneAudioEditor(this);this.sceneEditor.open("Upload Audio")}}}};function SceneUIListDBCharacters(parentScene,onNew,onUpdate){MultiplayerManager.UpdateCallbacks.addOnce(this);this.maxColumns=5;this.maxRowsPerPage=1;this.onNew=onNew;this.onUpdate=onUpdate;this.construct(parentScene)}ExtendPrototype(SceneUIListDBCharacters,SceneUIListDB);SceneUIListDBCharacters.prototype.deleteLater=function(){if(this.syncingUpdates){MultiplayerManager.Emit("EditorCharactersUnregisterListUpdates");this.syncingUpdates=false}this.SceneUIListDB_deleteLater()};SceneUIListDBCharacters.prototype.setup=function(){var parentCameraIndex=gEngine.findCameraIndex(this.parentScene.camera);var camera=gEngine.newSceneCamera(this,parentCameraIndex+1);camera.setupViewport(0,0,1,1);camera.setCameraWidth(640*1,false);this.SceneUIListDB_setup();if(MultiplayerManager.Emit("EditorCharactersRequestList")){this.syncingUpdates=true}this.requestResize()};SceneUIListDBCharacters.prototype.syncUpdate=function(jsonData){if(jsonData.EditorCharacters){this.syncList(jsonData.EditorCharacters);DBAssets.LoadCharacters(jsonData.EditorCharacters)}else if(jsonData.EditorCharacterDeleted){var objectID=jsonData.EditorCharacterDeleted;this.syncDelete(objectID)}};SceneUIListDBCharacters.prototype.createObject=function(info){var self=this;var objectsList=this.objectsList;var SelectObjectFunction=function(info){return function(){var infoIndex=self.getInfoIndex(info);if(self.selectionIndex!==infoIndex){self.selectionIndex=infoIndex;self.highlightSelectedObject()}if(self.onSelected){self.onSelected(info)}}};var EditFunction=function(object){return function(){self.onEdit(object.info)}};var camera=this.camera;var tileWidth=camera.targetWidth/this.maxColumns;var tileHeight=tileWidth*.2;var object={};object.tiles=[];object.info=info;var tile;{tile=new CCTile3DButton(this);tile.setupText(""+info.objectID,tileHeight,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.set(.25,.9));tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(205);tile.onRelease.push(new SelectObjectFunction(info));this.addTile(tile);object.tiles.add(tile)}{tile=new CCTile3DButton(this);tile.setupTile(tileWidth,tileWidth);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setDrawOrder(205);tile.onRelease.push(new SelectObjectFunction(info));this.addTile(tile);object.tileModel=tile;object.tiles.add(tile);this.updateObject(object,info)}if(this.onEdit){tile=new CCTile3DButton(this);tile.setupText("edit",tileHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.setRGBA(.25,.5,.75,.9));tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(205);tile.onRelease.push(new EditFunction(object));this.addTile(tile);object.tiles.add(tile)}return object};SceneUIListDBCharacters.prototype.updateObject=function(object,info){var tile=object.tileModel;if(tile.character){tile.removeChild(tile.character);tile.character.deleteLater()}var size=tile.collisionSize.width*.75;var character=tile.character=CharacterPlayerPrefab.Spawn(info.objectID);character.setSize(size);character.forceTransparent=true;character.animationPaused=true;tile.addChild(character)};function SceneUIListDBImages(parentScene,maxColumns,cameraWidth,onNew){MultiplayerManager.UpdateCallbacks.addOnce(this);if(!maxColumns){maxColumns=2}this.maxRowsPerPage=5;if(!cameraWidth){cameraWidth=.2}this.maxColumns=maxColumns;this.cameraWidth=cameraWidth;this.onNew=onNew;this.construct(parentScene)}ExtendPrototype(SceneUIListDBImages,SceneUIListDB);SceneUIListDBImages.prototype.deleteLater=function(){if(this.syncingUpdates){MultiplayerManager.Emit("EditorImagesUnregisterListUpdates");this.syncingUpdates=false}this.SceneUIListDB_deleteLater()};SceneUIListDBImages.prototype.setup=function(){var camera=gEngine.newSceneCamera(this);camera.setupViewport(0,0,this.cameraWidth,1);camera.setCameraWidth(640*this.cameraWidth,false);this.SceneUIListDB_setup();if(MultiplayerManager.Emit("EditorImagesRequestList")){this.syncingUpdates=true}};SceneUIListDBImages.prototype.syncUpdate=function(jsonData){if(jsonData.EditorImages){this.syncList(jsonData.EditorImages)}else if(jsonData.EditorImageDeleted){var objectID=jsonData.EditorImageDeleted;this.syncDelete(objectID)}else if(jsonData.EditorImageUpdated){var imageInfo=jsonData.EditorImageUpdated;this.syncEdit(imageInfo)}};SceneUIListDBImages.prototype.render=function(camera,pass,alpha){this.SceneUIListDB_render(camera,pass,alpha)};SceneUIListDBImages.prototype.createObject=function(imageInfo){var self=this;var objectsList=this.objectsList;var SelectObjectFunction=function(info){return function(){var infoIndex=self.getInfoIndex(info);if(self.selectionIndex!==infoIndex){self.selectionIndex=infoIndex;self.highlightSelectedObject()}if(self.onSelected){self.onSelected(info)}}};var camera=this.camera;var tileWidth=camera.targetWidth/this.maxColumns;var tileHeight=tileWidth*.125;var object={};object.tiles=[];object.info=imageInfo;var tile;{tile=new CCTile3DButton(this);tile.visibleOnlyUpdate=true;tile.setupText(""+imageInfo.objectID,tileHeight*.75,true,true);tile.setTileSize(tileWidth,tileHeight);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setColour(gColour.set(.25,.9));tile.setTextColour(gColour.setRGBA(1,1,1,1));tile.setDrawOrder(205);tile.onRelease.push(new SelectObjectFunction(imageInfo));this.addTile(tile);object.tiles.add(tile)}if(imageInfo.tex){tile=new CCTile3DButton(this);tile.visibleOnlyUpdate=true;tile.setupTexturedFit(tileWidth,tileWidth,false,imageInfo.tex);tile.setColourAlpha(0,false);tile.setDrawOrder(205);tile.onRelease.push(new SelectObjectFunction(imageInfo));this.addTile(tile);object.tiles.add(tile)}return object};SceneUIListDBImages.prototype.findAndSelect=function(tex,callback){var list=this.list;if(list){for(var i=0;i<list.length;++i){var itr=list[i];if(itr.tex===tex){this.selectIndex(i,callback);return}}this.selectionIndex=-1;this.highlightSelectedObject()}if(!this.loaded){var self=this;this.onLoaded=function(){self.findAndSelect(tex,callback)}}else{if(callback){callback(false)}}};function SceneEditorUI(mapEditor,mapsManager){this.construct();var camera=gEngine.newSceneCamera(this);camera.setupViewport(0,0,1,1)}ExtendPrototype(SceneEditorUI,CCSceneAppUI);SceneEditorUI.prototype.deleteLater=function(){this.hideMenu();this.CCSceneAppUI_deleteLater()};SceneEditorUI.prototype.setup=function(){this.camera.setCameraWidth(640,false);var tile;var bottomMenuTiles=this.bottomMenuTiles=[];var sideMenuTiles=this.sideMenuTiles=[];if(this.setupUI){this.setupUI()}var i;for(i=0;i<bottomMenuTiles.length;++i){tile=bottomMenuTiles[i];tile.setCollideable(false)}var duration=1;for(i=0;i<sideMenuTiles.length;++i){tile=sideMenuTiles[i];tile.setCollideable(false);tile.movementInterpolator.setDuration(duration);duration+=.1}this.requestResize()};SceneEditorUI.prototype.updateScene=function(delta){this.CCSceneAppUI_updateScene(delta)};SceneEditorUI.prototype.render=function(camera,pass,alpha){this.CCSceneAppUI_render(camera,pass,alpha)};SceneEditorUI.prototype.resize=function(){this.CCSceneAppUI_resize();var camera=this.camera;var tile,i;var bottomMenuTiles=this.bottomMenuTiles;var tileHeight=camera.targetHeight*.075;for(i=0;i<bottomMenuTiles.length;++i){tile=bottomMenuTiles[i];if(tile.textObject){tile.setTextHeight(tileHeight*.9,true);tile.setTileSize(tile.collisionSize.width*1.2,tileHeight)}else{tile.setTileSize(tileHeight)}if(i===0){tile.setPositionXY(camera.cameraHWidth-tile.collisionBounds[0],-camera.cameraHHeight+tile.collisionBounds[1])}else{tile.positionTileLeft(bottomMenuTiles[i-1])}}var sideMenuTiles=this.sideMenuTiles;for(i=0;i<sideMenuTiles.length;++i){tile=sideMenuTiles[i];if(i===0){tile.setPositionXYZ(camera.cameraHWidth+tile.collisionBounds[0],camera.cameraHHeight-tile.collisionBounds[1],0)}else{tile.positionTileBelow(sideMenuTiles[i-1])}}this.showMenu()};SceneEditorUI.prototype.touchPressed=function(touch){return this.CCSceneAppUI_touchPressed(touch)};SceneEditorUI.prototype.touchMoving=function(touch,touchDelta){return false};SceneEditorUI.prototype.touchReleased=function(touch,touchAction){return this.CCSceneAppUI_touchReleased(touch,touchAction)};SceneEditorUI.prototype.showMenu=function(){var camera=this.camera;var bottomMenuTiles=this.bottomMenuTiles;var sideMenuTiles=this.sideMenuTiles;var tile,i;for(i=0;i<bottomMenuTiles.length;++i){tile=bottomMenuTiles[i];tile.setPositionY(-camera.targetHeight*.5-tile.collisionBounds[1]);tile.translateTileMovementY(tile.collisionSize.height)}for(i=0;i<sideMenuTiles.length;++i){tile=sideMenuTiles[i];if(!tile.disabled){tile.setCollideable(true);tile.setTileMovementX(camera.targetWidth*.5-tile.collisionBounds[0]);tile.setColourAlpha(1,true)}else{tile.setCollideable(false);tile.setColour(gColour.setRGBA(1,1,1,0),true);tile.setTileMovementX(camera.targetWidth*.5+tile.collisionBounds[0])}}};SceneEditorUI.prototype.hideMenu=function(shouldDelete){var camera=this.camera;if(!camera){return}var bottomMenuTiles=this.bottomMenuTiles;var sideMenuTiles=this.sideMenuTiles;var tile,i;for(i=0;i<bottomMenuTiles.length;++i){tile=bottomMenuTiles[i];tile.setCollideable(false);tile.setColourAlpha(0,true);if(tile.textObject){tile.setTextColourAlpha(0,true)}tile.translateTileMovementY(-tile.collisionSize.height)}for(i=0;i<sideMenuTiles.length;++i){tile=sideMenuTiles[i];tile.setCollideable(false);tile.setColour(gColour.setRGBA(1,1,1,0),true);tile.setTileMovementX(camera.targetWidth*.5+tile.collisionBounds[0])}if(shouldDelete){var self=this;if(sideMenuTiles.length>0){sideMenuTiles[0].setColourAlpha(0,true,function(){self.deleteLater()})}else if(bottomMenuTiles.length>0){bottomMenuTiles[0].setColourAlpha(0,true,function(){self.deleteLater()})}else{this.deletLater()}}};function SceneMapEditorUI(mapEditor,mapsManager){this.construct();this.mapsManager=mapsManager;{this.mapEditor=mapEditor;mapEditor.linkScene(this)}{var parentCameraIndex=gEngine.findCameraIndex(mapEditor.camera);var camera=gEngine.newSceneCamera(this,parentCameraIndex+1);camera.setupViewport(0,0,1,1)}this.sceneJSMapEditor=null;this.sceneUIListObjects=null;this.sceneUIListDBModels=null;this.sceneAssetEditor=null;this.selectionBoxActive=false}ExtendPrototype(SceneMapEditorUI,SceneEditorUI);SceneMapEditorUI.prototype.setupUI=function(){var self=this;var camera=this.camera;var tile;var bottomMenuTiles=this.bottomMenuTiles;var sideMenuTiles=this.sideMenuTiles;{{tile=new CCTile3DButton(this);tile.setupTextured("editor_icon_delete.jpg",function(){self.requestResize()});tile.setColour(gColour.setRGBA(.5,0,0,0));tile.setDrawOrder(204);tile.onRelease.push(function(){self.mapsManager.handleDeleteMap()});this.addTile(tile,0);bottomMenuTiles.add(tile);this.tileDelete=tile}{tile=new CCTile3DButton(this);tile.setupText(" ",1,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.setColour(gColour.setRGBA(.5,.65,1,0));tile.setTextColour(gColour.setRGBA(1,1,1,0));tile.setColour(gColour.set(.55,0));tile.setDrawOrder(204);tile.onRelease.push(function(){self.mapsManager.handleEditName()});this.addTile(tile,0);bottomMenuTiles.add(tile);this.tileMapName=tile}{tile=new CCTile3DButton(this);tile.setupTile(1);tile.setColour(gColour.set(1,0));tile.setDrawOrder(204);tile.onRelease.push(function(){self.mapsManager.handleEditPrivacy()});this.addTile(tile,0);bottomMenuTiles.add(tile);this.tileMapPrivacy=tile}{tile=new CCTile3DButton(this);tile.setupText(" ",1,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.setColour(gColour.setRGBA(.5,.65,1,0));tile.setTextColour(gColour.setRGBA(1,1,1,0));tile.setColour(gColour.set(.55,0));tile.setDrawOrder(204);this.addTile(tile,0);bottomMenuTiles.add(tile);this.tileMapID=tile}}{{tile=new CCTile3DButton(this);tile.setupTexturedWidth(camera.cameraWidth*.1,"editor_tile_back.jpg",function(){self.requestResize()});tile.setColour(gColour.setRGBA(1,1,1,0));tile.setDrawOrder(204);tile.onRelease.push(function(){self.mapsManager.handleBackButton()});this.addTile(tile,0);this.tileBack=tile;sideMenuTiles.add(tile)}{tile=new CCTile3DButton(this);tile.setupTexturedWidth(camera.cameraWidth*.1,"editor_tile_selection.jpg",function(){self.requestResize()});tile.setColour(gColour.setRGBA(1,1,1,0));tile.setDrawOrder(204);tile.onRelease.push(function(){self.handleSelectionButton()});this.addTile(tile,0);this.tileSelection=tile;sideMenuTiles.add(tile)}{tile=new CCTile3DButton(this);tile.setupTexturedWidth(camera.cameraWidth*.1,"editor_tile_hammer.jpg",function(){self.requestResize()});tile.setColour(gColour.setRGBA(1,1,1,0));tile.setDrawOrder(204);tile.onRelease.push(function(){self.handleCreateButton()});this.addTile(tile,0);this.tileCreate=tile;sideMenuTiles.add(tile)}}};SceneMapEditorUI.prototype.setupMenu=function(mapID,mapName,mapOpen){var self=this;var camera=this.camera;var bottomMenuTiles=this.bottomMenuTiles;var sideMenuTiles=this.sideMenuTiles;var tile,i;for(i=0;i<bottomMenuTiles.length;++i){tile=bottomMenuTiles[i];tile.setCollideable(true);if(tile===this.tileMapID){tile.setText(mapID,true);tile.setTextColourAlpha(1,true)}else if(tile===this.tileMapName){tile.setText(mapName,true);tile.setTextColourAlpha(1,true)}else if(tile===this.tileMapPrivacy){if(mapOpen){tile.setTileTexture("editor_icon_public.jpg")}else{tile.setTileTexture("editor_icon_private.jpg")}}tile.setColourAlpha(1,true)}this.requestResize();this.showMenu()};SceneMapEditorUI.prototype.hideMenu=function(shouldDelete){this.objectEditorClose();this.closeModelsList();this.closeAssetEditor();this.SceneEditorUI_hideMenu(shouldDelete)};SceneMapEditorUI.prototype.handleSelectionButton=function(){this.selectionBoxActive=!this.selectionBoxActive;if(this.selectionBoxActive){if(this.creatingObjects){this.handleCreateButton()}this.selectionBoxActive=true;this.tileSelection.setColour(gColour.setRGBA(.25,.5,1,1),true)}else{this.tileSelection.setColour(gColour.setRGBA(1,1,1,1),true)}};SceneMapEditorUI.prototype.handleCreateButton=function(){this.creatingObjects=!this.creatingObjects;if(this.creatingObjects){if(this.selectionBoxActive){this.handleSelectionButton()}this.openModelsList();this.tileCreate.setColour(gColour.setRGBA(.25,.5,1,1),true)}else{this.closeModelsList();this.tileCreate.setColour(gColour.setRGBA(1,1,1,1),true)}this.mapEditor.selectedObjectsUpdated()};SceneMapEditorUI.prototype.objectEditorOpen=function(objects){if(!this.sceneUIListObjects){this.sceneUIListObjects=new SceneUIListObjectsMap(this,this.mapEditor)}this.sceneUIListObjects.showObjects(objects)};SceneMapEditorUI.prototype.objectEditorClose=function(){if(this.sceneUIListObjects){this.sceneUIListObjects.close();this.sceneUIListObjects=null}};SceneMapEditorUI.prototype.openModelsList=function(){this.objectEditorClose();if(!this.sceneUIListDBModels){var self=this;this.sceneUIListDBModels=new SceneUIListDBModels(this);this.sceneUIListDBModels.onSelected=function(modelInfo){self.mapsManager.modelSelected(modelInfo)};this.sceneUIListDBModels.onEdit=function(modelInfo){self.openAssetEditor("Edit Model",true,false,function(modelInfo){self.mapsManager.modelSelected(modelInfo)});self.sceneAssetEditor.setModel(modelInfo)};var selectedObjects=this.mapEditor.selectedObjects;if(selectedObjects&&selectedObjects.length>0){var object=selectedObjects[0];if(object.modelID){this.findAndSelectModelID(object.modelID)}else{var info={};info.obj=object.obj;info.tex=object.tex;if(this.sceneUIListDBModels){this.sceneUIListDBModels.findAndSelect(info)}}}}};SceneMapEditorUI.prototype.getSelectedModel=function(){if(this.sceneUIListDBModels){return this.sceneUIListDBModels.getSelected()}return null};SceneMapEditorUI.prototype.closeModelsList=function(){if(this.sceneUIListDBModels){this.sceneUIListDBModels.close();this.sceneUIListDBModels=null}};SceneMapEditorUI.prototype.flagPendingModelUpdate=function(){if(this.sceneUIListDBModels){this.sceneUIListDBModels.loaded=false}};SceneMapEditorUI.prototype.findAndSelectModelID=function(modelID,callback){if(this.sceneUIListDBModels){this.sceneUIListDBModels.findAndSelectID(modelID,callback)}};SceneMapEditorUI.prototype.openJSMapEditor=function(callback){if(this.sceneAssetEditor){this.closeAssetEditor()}if(this.sceneJSMapEditor){this.closeJSMapEditor()}this.hideMenu();this.sceneJSMapEditor=new SceneJSMapEditor(this);this.sceneJSMapEditor.open();
if(callback){this.sceneJSMapEditor.onClose=callback}};SceneMapEditorUI.prototype.closeJSMapEditor=function(){if(this.sceneJSMapEditor){this.sceneJSMapEditor.close();this.sceneJSMapEditor=null}};SceneMapEditorUI.prototype.openAssetEditor=function(title,supportObj,showLists,callback){if(this.sceneAssetEditor){this.closeAssetEditor()}if(this.sceneJSMapEditor){this.closeJSMapEditor()}this.sceneAssetEditor=new SceneAssetEditor(this,supportObj,showLists);this.sceneAssetEditor.open(title);if(callback){this.sceneAssetEditor.onClose=callback}};SceneMapEditorUI.prototype.closeAssetEditor=function(){if(this.sceneAssetEditor){this.sceneAssetEditor.close();this.sceneAssetEditor=null}};function SceneMapEditor(mapID,mapsManager,mapData){this.mapsManager=mapsManager;this.name=mapData.name;this.open=mapData.open;this.construct(mapID,"MapEditor");this.syncUpdate(mapData)}ExtendPrototype(SceneMapEditor,SceneGameMap);SceneMapEditor.prototype.construct=function(mapID,mapType){var self=this;this.SceneGameMap_construct(mapID,mapType);this.camera.setPerspective(15);this.camera.offsetInterpolator.setDuration(.3);this.onDragDropFunction=function(files,event){self.mapsManager.onDragDrop(files,event)};gEngine.controls.onDragDrop.add(this.onDragDropFunction);this.selectedObjects=[]};SceneMapEditor.prototype.destruct=function(){if(this.onDragDropFunction){gEngine.controls.onDragDrop.remove(this.onDragDropFunction);this.onDragDropFunction=null}this.SceneGameMap_destruct()};SceneMapEditor.prototype.deleteLater=function(){if(this.sceneUI){this.sceneUI.hideMenu(true);this.sceneUI=null}this.SceneGameMap_deleteLater()};SceneMapEditor.prototype.setup=function(){var self=this;this.SceneGameMap_setup();var camera=this.camera;camera.setRotationX(-80);{var tile=new CCTile3DButton(this);tile.setTileSize(1);tile.tileModel.setRotationX(270);tile.setTileTexture("editor_icon_resize.png");tile.setDrawOrder(204);tile.renderPass=CCRenderer.render_post;tile.onPress.push(function(tile,touch){self.objectResizingBegin(touch)});tile.onRelease.push(function(){self.objectResizingEnd()});this.addTile(tile);tile.setText("");tile.textObject.setRotationX(270);tile.setTextColour(gColour.set(1,1));this.tileObjectResize=tile}this.sceneUI=new SceneMapEditorUI(this,this.mapsManager);gEngine.addScene(this.sceneUI);this.sceneUI.setupMenu(this.mapID,this.name,this.open)};SceneMapEditor.prototype.setMapSize=function(size,zoom){if(zoom===undefined){zoom=true}this.SceneGameMap_setMapSize(size);var camera=this.camera;var mapSizeOffset;if(camera.targetWidth<=camera.targetHeight){mapSizeOffset=camera.calcCameraOffsetForWidth(this.mapSize);this.minZoomOffset=camera.calcCameraOffsetForWidth(300)}else{mapSizeOffset=camera.calcCameraOffsetForHeight(this.mapSize);this.minZoomOffset=camera.calcCameraOffsetForHeight(300)}this.maxZoomOffset=mapSizeOffset*2;if(this.maxZoomOffset>3e4){this.maxZoomOffset=3e4}if(zoom){camera.targetOffset[2]=mapSizeOffset*1.25;camera.targetOffset[2]=CC.FloatClamp(camera.targetOffset[2],this.minZoomOffset,this.maxZoomOffset);camera.targetWidth=camera.calcCameraWidthForOffset(camera.targetOffset[2]);camera.flagUpdate()}};SceneMapEditor.prototype.updateScene=function(delta){return this.SceneGameMap_updateScene(delta)};SceneMapEditor.prototype.updateCamera=function(delta){var updated=false;var camera=this.camera;var lookAtSpeed=this.controlsMoving&&!this.cameraScrolling?20:1.5;if(this.camera.interpolateCamera(delta,lookAtSpeed)){if(this.scrollBar){}var tile;var cameraStickyTiles=this.cameraStickyTiles;for(var i=0;i<cameraStickyTiles.length;++i){tile=cameraStickyTiles[i];tile.setPosition(this.camera.currentLookAt)}{var cameraHeight=camera.calcCameraHeightForOffset(camera.offset[2]);tile=this.tileObjectResize;var size=cameraHeight*.05;tile.setTileSize(size,size,size);tile.setTextScale(.5);var textHeight=size*.5;tile.setTextPosition(0,0,-(size*.5+textHeight*.25));this.objectResized()}updated=true}else{if(this.cameraScrolling){this.cameraScrolling=false;this.lockCameraView();updated=true}if(this.resizing){this.resizing=false;this.refreshCameraView();this.lockCameraView();updated=true}}return updated};SceneMapEditor.prototype.postRender=function(camera,pass,alpha){if(this.camera===camera){this.SceneGameMap_postRender(camera,pass,alpha);if(pass===CCRenderer.render_main&&alpha){var renderer=gRenderer;var object;var selectedObjects=this.selectedObjects;if(selectedObjects.length>0){gEngine.textureManager.setTextureIndex(1);renderer.CCDefaultTexCoords();renderer.CCSetColour(gColour.setRGBA(1,0,0,.5));for(var i=0;i<selectedObjects.length;++i){object=selectedObjects[i];CCRenderer.GLPushMatrix();CCRenderer.GLTranslate(object.position);CCRenderer.GLScale([object.collisionSize.width,1,object.collisionSize.width]);renderer.CCRenderCube(true);CCRenderer.GLPopMatrix()}}if(this.selectionBoxStart&&this.selectionBoxEnd){var selectionBoxStart=this.selectionBoxStart;var selectionBoxEnd=this.selectionBoxEnd;var size=vec3.clone(selectionBoxEnd);vec3.subtract(size,selectionBoxEnd,selectionBoxStart);var position=vec3.clone(selectionBoxStart);position[0]+=size[0]*.5;position[1]+=size[1]*.5;position[2]+=size[2]*.5;gEngine.textureManager.setTextureIndex(1);renderer.CCSetColour(gColour.setRGBA(1,0,0,.5));CCRenderer.GLPushMatrix();CCRenderer.GLTranslate(position);CCRenderer.GLScale([size[0],1,size[2]]);renderer.CCRenderCube(true);CCRenderer.GLPopMatrix()}}}};SceneMapEditor.prototype.updateControls=function(controls){var usingControls=this.SceneGameMap_updateControls(controls);var cameraTouches=this.camera.cameraTouches;var touch=cameraTouches[0];if(touch.x>0&&touch.x<1&&touch.y>0&&touch.y<1&&touch.startX>0&&touch.startX<1&&touch.startY>0&&touch.startY<1){if(controls.wheel&&controls.wheel.delta!==0){var delta=controls.wheel.delta;var camera=this.camera;camera.targetOffset[2]+=camera.targetOffset[2]*delta*.1;camera.targetOffset[2]=CC.FloatClamp(camera.targetOffset[2],this.minZoomOffset,this.maxZoomOffset);camera.targetWidth=camera.calcCameraWidthForOffset(camera.targetOffset[2]);camera.flagUpdate();return true}}return usingControls};SceneMapEditor.prototype.handleTwoTouches=function(touch1,touch2){var topTouch=touch1;var bottomTouch=touch2;if(touch1.y<touch2.y){topTouch=touch2;bottomTouch=touch1}var rightTouch=touch1;var leftTouch=touch2;if(touch1.x<touch2.x){rightTouch=touch2;leftTouch=touch1}var combinedDelta=topTouch.deltaY+rightTouch.deltaX+-bottomTouch.deltaY+-leftTouch.deltaX;return this.touchCameraZooming(combinedDelta)};SceneMapEditor.prototype.touchPressed=function(touch){var camera=this.camera;var hitLocation,projectionResults,offset,i;if(this.sceneUI.selectionBoxActive){if(camera.project3D(touch.x,touch.y)){hitLocation=vec3.create();projectionResults=camera.projectionResults;offset=projectionResults.vNear[1]/Math.abs(projectionResults.vDirection[1]);vec3.scale(hitLocation,projectionResults.vDirection,offset);vec3.add(hitLocation,hitLocation,projectionResults.vNear);this.selectionBoxStart=hitLocation}}else{var result=this.handleTilesTouch(touch,CCControls.touch_pressed);if(result===CCSceneAppUI.tile_touchAction){return true}else{var selectedObjects=this.selectedObjects;if(selectedObjects.length>0){var containsStaticObjectsOnly=true;for(i=0;i<selectedObjects.length;++i){if(selectedObjects[i]===this.ground||selectedObjects[i].playerID){containsStaticObjectsOnly=false;break}}if(containsStaticObjectsOnly){if(camera.project3D(touch.x,touch.y)){hitLocation=vec3.create();projectionResults=camera.projectionResults;offset=projectionResults.vNear[1]/Math.abs(projectionResults.vDirection[1]);vec3.scale(hitLocation,projectionResults.vDirection,offset);vec3.add(hitLocation,hitLocation,projectionResults.vNear);for(i=0;i<selectedObjects.length;++i){var object=selectedObjects[i];CC.UpdateCollisions(object);if(CC.BasicBoxCollisionCheck(object.aabbMin,object.aabbMax,hitLocation,hitLocation)){this.touchPressedStartLocation=hitLocation;return true}}}}}}}return false};SceneMapEditor.prototype.touchMoving=function(touch,touchDelta){var camera=this.camera;var hitLocation,projectionResults,offset;var allowCameraMovement=true;if(this.sceneUI.selectionBoxActive){allowCameraMovement=false;if(camera.project3D(touch.x,touch.y)){hitLocation=this.selectionBoxEnd?this.selectionBoxEnd:vec3.create();projectionResults=camera.projectionResults;offset=projectionResults.vNear[1]/Math.abs(projectionResults.vDirection[1]);vec3.scale(hitLocation,projectionResults.vDirection,offset);vec3.add(hitLocation,hitLocation,projectionResults.vNear);this.selectionBoxEnd=hitLocation}}else if(this.touchPressedStartLocation){allowCameraMovement=false;if(camera.project3D(touch.x,touch.y)){hitLocation=vec3.create();projectionResults=camera.projectionResults;offset=projectionResults.vNear[1]/Math.abs(projectionResults.vDirection[1]);vec3.scale(hitLocation,projectionResults.vDirection,offset);vec3.add(hitLocation,hitLocation,projectionResults.vNear);var movement=vec3.clone(hitLocation);vec3.subtract(movement,movement,this.touchPressedStartLocation);var i,object;if(this.touchPressedResizing){this.objectResizingMove(hitLocation,movement)}else{this.movingObjects=true;var selectedObjects=this.selectedObjects;for(i=0;i<selectedObjects.length;++i){object=selectedObjects[i];if(!object.playerID&&object!==this.ground){object.translate(movement[0],movement[1],movement[2])}}this.objectResized()}this.touchPressedStartLocation=hitLocation;return true}}else{var result=this.handleTilesTouch(touch,this.controlsMovingVertical?CCControls.touch_movingVertical:CCControls.touch_movingHorizontal);if(result===CCSceneAppUI.tile_touchAction){return true}}if(allowCameraMovement){return this.touchCameraMoving(touchDelta.x,touchDelta.y)}return false};SceneMapEditor.prototype.touchReleased=function(touch,touchAction){var usingControls=false;if(this.touchPressedStartLocation){delete this.touchPressedStartLocation}if(this.sceneUI.selectionBoxActive){usingControls=this.handleSelectionBox(touch)}else if(this.movingObjects){usingControls=true;this.mapsManager.objectsMoved();delete this.movingObjects}else{var result=this.handleTilesTouch(touch,touchAction);usingControls=result===CCSceneAppUI.tile_touchAction;if(!usingControls&&touchAction>=CCControls.touch_released){if(this.oneTouchDoubleTapped){}else if(this.controlsMoving){if(this.touchPressedResizing){this.objectResizingEnd();usingControls=true}else{usingControls=this.touchReleaseSwipe(touch)}}else if(touchAction===CCControls.touch_released){if(this.sceneUI.creatingObjects){usingControls=this.handleCreatingObjects(touch)}if(!usingControls){usingControls=this.handleObjectSelection(touch)}}}}if(this.oneTouchDoubleTappedLastPress){this.oneTouchDoubleTappedLastPress=false}if(this.oneTouchDoubleTapped){this.oneTouchDoubleTappedLastPress=true;this.oneTouchDoubleTapped=false}return usingControls};SceneMapEditor.prototype.touchReleaseSwipe=function(touch){return this.CCSceneAppUI_touchReleaseSwipe(touch)};SceneMapEditor.prototype.refreshCameraView=function(){var collisionBounds=this.ground.collisionBounds;this.sceneLeft=-collisionBounds[0];this.sceneRight=collisionBounds[0];this.sceneTop=collisionBounds[2];this.sceneBottom=-collisionBounds[2]};SceneMapEditor.prototype.updatePathFinder=function(){var pathFinderNetwork=this.pathFinderNetwork;var selectedObjects=this.selectedObjects;for(var i=0;i<selectedObjects.length;++i){var object=selectedObjects[i];if(!object.playerID&&object!==this.ground){pathFinderNetwork.removeCollideable(object);pathFinderNetwork.addCollideable(object,this.ground.collisionBounds)}}this.SceneGameMap_updatePathFinder()};SceneMapEditor.prototype.removeEnemyID=function(playerID){var selectedObjects=this.selectedObjects;for(var i=0;i<selectedObjects.length;++i){var object=selectedObjects[i];if(object.playerID===playerID){this.selectedObjectsRemove(object);break}}this.SceneGameMap_removeEnemyID(playerID)};SceneMapEditor.prototype.syncRemoveStaticObject=function(objectID){var selectedObjects=this.selectedObjects;for(var i=0;i<selectedObjects.length;++i){var object=selectedObjects[i];if(object.getID()===objectID){this.selectedObjectsRemove(object);break}}this.SceneGameMap_syncRemoveStaticObject(objectID)};SceneMapEditor.prototype.selectedObjectsAdd=function(object){if(object){if(object.getMovementInterpolator()){object.getMovementInterpolator().finish()}if(this.selectedObjects.find(object)===-1){this.selectedObjects.add(object);this.selectedObjectsUpdated()}}};SceneMapEditor.prototype.selectedObjectsRemove=function(object){this.selectedObjects.remove(object);this.selectedObjectsUpdated()};SceneMapEditor.prototype.selectedObjectsClear=function(){this.selectedObjects.length=0;this.selectedObjectsUpdated()};SceneMapEditor.prototype.selectedObjectsUpdated=function(){if(this.sceneUI){if(this.sceneUI.selectionBoxActive){this.sceneUI.handleSelectionButton()}var selectedObjects=this.selectedObjects;if(selectedObjects&&selectedObjects.length>0){if(!this.sceneUI.sceneUIListDBModels){this.sceneUI.objectEditorOpen(selectedObjects)}}else{this.sceneUI.objectEditorClose()}}this.objectResized()};SceneMapEditor.prototype.handleSelectionBox=function(touch){var camera=this.camera;if(this.selectionBoxStart&&camera.project3D(touch.x,touch.y)){var hitLocation=vec3.create();var projectionResults=camera.projectionResults;var offset=projectionResults.vNear[1]/Math.abs(projectionResults.vDirection[1]);vec3.scale(hitLocation,projectionResults.vDirection,offset);vec3.add(hitLocation,hitLocation,projectionResults.vNear);var selectionBoxMin=this.selectionBoxStart;var selectionBoxMax=hitLocation;CC.CalculateMinMaxVectors(selectionBoxMin,selectionBoxMax);var selectedObjects=this.selectedObjects;selectedObjects.length=0;var objects=this.players;var i,object;for(i=0;i<objects.length;++i){object=objects[i];CC.UpdateCollisions(object);if(CC.BasicBoxCollisionCheck(object.aabbMin,object.aabbMax,selectionBoxMin,selectionBoxMax)){selectedObjects.add(object)}}objects=this.staticObjects;for(i=0;i<objects.length;++i){object=objects[i];CC.UpdateCollisions(object);if(CC.BasicBoxCollisionCheck(object.aabbMin,object.aabbMax,selectionBoxMin,selectionBoxMax)){selectedObjects.add(object)}}this.selectedObjectsUpdated();delete this.selectionBoxStart;if(this.selectionBoxEnd){delete this.selectionBoxEnd}}return true};SceneMapEditor.prototype.handleObjectSelection=function(touch){if(this.sceneUI.creatingObjects){this.sceneUI.handleCreateButton()}var camera=this.camera;var hitObject=null;var hitLocation=vec3.create();if(camera.project3D(touch.x,touch.y)){var projectionResults=camera.projectionResults;var collideables=this.collideables;hitObject=CC.BasicLineCollisionCheck(collideables,projectionResults.vNear,projectionResults.vFar,hitLocation,true,CC.collision_box,null,false,true);if(!hitObject){var offset=projectionResults.vNear[1]/Math.abs(projectionResults.vDirection[1]);vec3.scale(hitLocation,projectionResults.vDirection,offset);vec3.add(hitLocation,hitLocation,projectionResults.vNear);var hScanArea=camera.targetWidth*.01;var min=vec3.clone(hitLocation);min[0]-=hScanArea;min[2]-=hScanArea;var max=vec3.clone(hitLocation);max[0]+=hScanArea;max[2]+=hScanArea;hitObject=CC.CollideableScan(min,max,null,CC.collision_box,true)}}this.mapsManager.objectSelected(hitObject,hitLocation);return!!hitObject};SceneMapEditor.prototype.handleCreatingObjects=function(touch){var camera=this.camera;var hitObject=null;var hitLocation=vec3.create();if(camera.project3D(touch.x,touch.y)){var projectionResults=camera.projectionResults;var collideables=this.collideables;hitObject=CC.BasicLineCollisionCheck(collideables,projectionResults.vNear,projectionResults.vFar,hitLocation,true,CC.collision_box,[this.ground],false);if(!hitObject){var offset=projectionResults.vNear[1]/Math.abs(projectionResults.vDirection[1]);vec3.scale(hitLocation,projectionResults.vDirection,offset);vec3.add(hitLocation,hitLocation,projectionResults.vNear);this.selectedObjectsClear();this.mapsManager.createObject(hitLocation)}}return!hitObject};SceneMapEditor.prototype.findObject=function(object){var camera=this.camera;camera.targetOffset[2]=camera.calcCameraOffsetForWidth(object.collisionSize.width*4);camera.targetOffset[2]=CC.FloatClamp(camera.targetOffset[2],this.minZoomOffset,this.maxZoomOffset);camera.targetLookAt[0]=object.position[0];camera.targetLookAt[2]=object.position[2];camera.flagUpdate()};SceneMapEditor.prototype.deleteObject=function(object){this.mapsManager.deleteObject(object)};SceneMapEditor.prototype.objectResizingBegin=function(touch){var camera=this.camera;if(camera.project3D(touch.x,touch.y)){var hitLocation=vec3.create();var projectionResults=camera.projectionResults;var offset=projectionResults.vNear[1]/Math.abs(projectionResults.vDirection[1]);vec3.scale(hitLocation,projectionResults.vDirection,offset);vec3.add(hitLocation,hitLocation,projectionResults.vNear);this.touchPressedStartLocation=hitLocation;this.touchPressedResizing=true}};SceneMapEditor.prototype.objectResizingMove=function(hitLocation,movement){this.tileObjectResize.setPositionXZ(hitLocation[0],hitLocation[2]);var selectedObjects=this.selectedObjects;var size;for(i=0;i<selectedObjects.length;++i){object=selectedObjects[i];if(object===this.ground){size=object.collisionBounds[0]*2+movement[0]*2;if(size<200){size=200}if(size>5e3){size=5e3}this.setMapSize(size,false)}else if(!object.playerID){size=object.collisionBounds[0]*2+movement[0]*2;if(size<10){size=10}if(size>this.mapSize*.5){size=this.mapSize*.5}object.resize(size)}}this.objectResized()};SceneMapEditor.prototype.objectResized=function(){var tile=this.tileObjectResize;tile.setPositionXY(this.camera.targetWidth,this.camera.targetHeight);var selectedObjects=this.selectedObjects;for(var i=0;i<selectedObjects.length;++i){var object=selectedObjects[i];if(!object.playerID){tile.setPositionXZ(object.aabbMax[0],object.aabbMin[2]);tile.translate(tile.collisionBounds[0],0,-tile.collisionBounds[2]);tile.setText(""+CC.FloatLimitPrecision(object.collisionSize.width));break}}};SceneMapEditor.prototype.objectResizingEnd=function(){delete this.touchPressedResizing;delete this.touchPressedStartLocation;this.refreshCameraView();var selectedObjects=this.selectedObjects;if(selectedObjects.length>0){this.mapsManager.objectsResized()}};function SceneUIEditorUI(editor,manager){this.construct();this.manager=manager;{this.editor=editor;manager.linkScene(this)}{var parentCameraIndex=gEngine.findCameraIndex(editor.camera);var camera=gEngine.newSceneCamera(this,parentCameraIndex-1);camera.setupViewport(0,0,1,1)}this.sceneUIListObjects=null;this.sceneAssetEditor=null;this.enableSelectionBox=false;this.enableObjectResizing=true;gEngine.addScene(this)}ExtendPrototype(SceneUIEditorUI,SceneEditorUI);SceneUIEditorUI.prototype.resize=function(){this.SceneEditorUI_resize();var camera=this.camera;var tile;{tile=this.tileBackground;var width=camera.targetWidth*.55;var height=720/1080*width;tile.setTileSize(width,height)}};SceneUIEditorUI.prototype.handleOneTouch=function(touch){return this.CCSceneAppUI_handleOneTouch(touch)};SceneUIEditorUI.prototype.touchReleased=function(touch,touchAction){if(!this.SceneEditorUI_touchReleased(touch,touchAction)){this.editor.selectedObjectsClear()}};SceneUIEditorUI.prototype.setupUI=function(){var self=this;var camera=this.camera;var tile;{tile=new CCTile3DButton(this);tile.setupTile();tile.setTileTexture("editor_tabletscreen.png");tile.setColour(gColour.set(1,0));tile.setColourAlpha(1,true);tile.setDrawOrder(200);this.cameraStickyTiles.add(tile);this.tileBackground=tile}var bottomMenuTiles=this.bottomMenuTiles;var sideMenuTiles=this.sideMenuTiles;{{tile=new CCTile3DButton(this);tile.setupTextured("editor_icon_delete.jpg",function(){self.requestResize()});tile.setColour(gColour.setRGBA(.5,0,0,0));tile.setDrawOrder(204);tile.onRelease.push(function(){self.manager.handleDelete()});this.addTile(tile,0);bottomMenuTiles.add(tile);this.tileDelete=tile}{tile=new CCTile3DButton(this);tile.setupTile(1);tile.setColour(gColour.set(1,0));tile.setDrawOrder(204);tile.onRelease.push(function(){self.manager.handleEditPrivacy()});this.addTile(tile,0);bottomMenuTiles.add(tile);this.tilePrivacy=tile}{tile=new CCTile3DButton(this);tile.setupText(" ",1,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.setColour(gColour.setRGBA(.5,.65,1,0));tile.setTextColour(gColour.setRGBA(1,1,1,0));tile.setColour(gColour.set(.55,0));tile.setDrawOrder(204);tile.onRelease.push(function(){self.manager.handleEditJS()});this.addTile(tile,0);bottomMenuTiles.add(tile);this.tileID=tile}{tile=new CCTile3DButton(this);tile.setupText(" ",1,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.setColour(gColour.setRGBA(.5,.65,1,0));tile.setTextColour(gColour.setRGBA(1,1,1,0));tile.setColour(gColour.set(.55,0));tile.setDrawOrder(204);tile.onRelease.push(function(){self.manager.handleEditName()});this.addTile(tile,0);bottomMenuTiles.add(tile);this.tileName=tile}}{{tile=new CCTile3DButton(this);tile.setupTexturedWidth(camera.cameraWidth*.1,"editor_tile_back.jpg",function(){self.requestResize()});tile.setColour(gColour.setRGBA(1,1,1,0));tile.setDrawOrder(204);tile.onRelease.push(function(){self.manager.handleBackButton()});this.addTile(tile,0);this.tileBack=tile;sideMenuTiles.add(tile)}{tile=new CCTile3DButton(this);tile.setupTexturedWidth(camera.cameraWidth*.1,"editor_tile_selection.jpg",function(){self.requestResize()});tile.setColour(gColour.setRGBA(1,1,1,0));tile.setDrawOrder(204);tile.onRelease.push(function(){self.handleSelectionButton()});this.addTile(tile,0);this.tileSelection=tile;sideMenuTiles.add(tile)}{tile=new CCTile3DButton(this);tile.setupTexturedWidth(camera.cameraWidth*.1,"editor_tile_hammer.jpg",function(){self.requestResize()});tile.setColour(gColour.setRGBA(1,1,1,0));tile.setDrawOrder(204);tile.onRelease.push(function(){self.handleCreateButton()});this.addTile(tile,0);this.tileCreate=tile;sideMenuTiles.add(tile)}var objectMenuTiles=this.objectMenuTiles=[];if(CCEngine.IsMobile()){tile=new CCTile3DButton(this);tile.setupTexturedWidth(camera.cameraWidth*.1,"editor_tile_resize.jpg",function(){self.requestResize()});tile.setColour(gColour.setRGBA(1,1,1,0));tile.setDrawOrder(204);tile.onRelease.push(function(){self.handleResizeButton()});this.addTile(tile,0);sideMenuTiles.add(tile);objectMenuTiles.add(tile);tile.disabled=true;this.tileResize=tile}{tile=new CCTile3DButton(this);tile.setupTexturedWidth(camera.cameraWidth*.1,"editor_tile_copy.jpg",function(){self.requestResize()});tile.setColour(gColour.setRGBA(1,1,1,0));tile.setDrawOrder(204);tile.onRelease.push(function(){self.handleCopyButton()});this.addTile(tile,0);sideMenuTiles.add(tile);objectMenuTiles.add(tile);tile.disabled=true}}};SceneUIEditorUI.prototype.setupMenu=function(info){var id=info.id;var name=info.name;var open=info.open;var self=this;var camera=this.camera;var bottomMenuTiles=this.bottomMenuTiles;var tile,i;for(i=0;i<bottomMenuTiles.length;++i){tile=bottomMenuTiles[i];tile.setCollideable(true);if(tile===this.tileID){tile.setText(id,true);tile.setTextColourAlpha(1,true)}else if(tile===this.tileName){tile.setText(name,true);tile.setTextColourAlpha(1,true)}else if(tile===this.tilePrivacy){if(open){tile.setTileTexture("editor_icon_public.jpg")}else{tile.setTileTexture("editor_icon_private.jpg")}}tile.setColourAlpha(1,true)}this.requestResize();this.showMenu()};SceneUIEditorUI.prototype.hideMenu=function(shouldDelete){this.tileBackground.getColourInterpolator().setDuration(.1);this.tileBackground.setColourAlpha(0,true);this.objectEditorClose();this.closeAssetEditor();this.SceneEditorUI_hideMenu(shouldDelete)};SceneUIEditorUI.prototype.handleSelectionButton=function(){this.enableSelectionBox=!this.enableSelectionBox;if(this.enableSelectionBox){if(this.creatingObjects){this.handleCreateButton()}this.enableSelectionBox=true;this.tileSelection.setColour(gColour.setRGBA(.25,.5,1,1),true)}else{this.tileSelection.setColour(gColour.setRGBA(1,1,1,1),true)}};SceneUIEditorUI.prototype.handleCreateButton=function(){this.creatingObjects=!this.creatingObjects;if(this.creatingObjects){if(this.enableSelectionBox){this.handleSelectionButton()}this.objectEditorClose();this.tileCreate.setColour(gColour.setRGBA(.25,.5,1,1),true)}else{this.tileCreate.setColour(gColour.setRGBA(1,1,1,1),true)}this.editor.selectedObjectsUpdated()};SceneUIEditorUI.prototype.handleResizeButton=function(){this.enableObjectResizing=!this.enableObjectResizing;this.editor.objectResized();if(this.enableObjectResizing){this.tileResize.setColour(gColour.setRGBA(.25,.5,1,1),true)}else{this.tileResize.setColour(gColour.setRGBA(1,1,1,1),true)}};SceneUIEditorUI.prototype.handleCopyButton=function(){this.editor.selectedObjectsCopy()};SceneUIEditorUI.prototype.objectEditorOpen=function(objects){if(!this.sceneUIListObjects){this.sceneUIListObjects=new SceneUIListObjectsUI(this,this.editor);if(CCEngine.IsMobile()){this.enableObjectResizing=false}else{this.enableObjectResizing=true}}this.sceneUIListObjects.showObjects(objects);var showMenu=false;for(var i=0;i<this.objectMenuTiles.length;++i){var tile=this.objectMenuTiles[i];if(tile.disabled){tile.disabled=false;showMenu=true}}if(showMenu){this.showMenu()}};SceneUIEditorUI.prototype.objectEditorClose=function(){if(this.sceneUIListObjects){this.sceneUIListObjects.close();this.sceneUIListObjects=null;var showMenu=false;for(var i=0;i<this.objectMenuTiles.length;++i){var tile=this.objectMenuTiles[i];if(!tile.disabled){tile.disabled=true;showMenu=true}}if(showMenu){this.showMenu()}}};SceneUIEditorUI.prototype.openAssetEditor=function(title,supportObj,callback){if(this.sceneAssetEditor){this.closeAssetEditor()}this.sceneAssetEditor=new SceneAssetEditor(this,supportObj);var self=this;this.sceneAssetEditor.onClose=function(tex){if(tex){if(self.sceneAssetEditor&&self.sceneAssetEditor.sceneUIListDBImages){self.sceneAssetEditor.sceneUIListDBImages.findAndSelect(tex)}}if(callback){callback(tex)}};if(callback){this.sceneAssetEditor.onClose=callback}this.sceneAssetEditor.open(title)};SceneUIEditorUI.prototype.closeAssetEditor=function(){if(this.sceneAssetEditor){this.sceneAssetEditor.close();this.sceneAssetEditor=null}};function SceneUIEditor(info,manager){this.info=info;this.manager=manager;this.construct();this.cameraCentered=true;this.cameraReletivePositions=true;this.customJSMarker="// custom functions below this point will remain unmodified by the UI Editor (please don't delete this marker)";gEngine.addScene(this)}ExtendPrototype(SceneUIEditor,CCSceneAppUI);SceneUIEditor.prototype.construct=function(){var self=this;this.CCSceneAppUI_construct();this.onKeyboardFunction=function(event,key,pressed){return self.onKeyboard(event,key,pressed)};gEngine.controls.requestKeyboard(this.onKeyboardFunction,false);this.selectedObjects=[];this.uiObjects=[]};SceneUIEditor.prototype.destruct=function(){if(this.onKeyboardFunction){gEngine.controls.removeKeyboard(this.onKeyboardFunction);delete this.onKeyboardFunction}this.selectedObjectsClear();this.CCSceneAppUI_destruct()};SceneUIEditor.prototype.deleteLater=function(){if(this.sceneUI){this.sceneUI.hideMenu(true);this.sceneUI=null}this.CCSceneAppUI_deleteLater()};SceneUIEditor.prototype.setup=function(){var self=this;var camera=gEngine.newSceneCamera(this);this.setupViewport();camera.offsetInterpolator.setDuration(.3);this.CCSceneAppUI_setup();this.tileObjectResizer=[];function createResizer(){var tile;tile=new CCTile3DButton(self,true);tile.setDrawOrder(300);tile.renderPass=CCRenderer.render_post;tile.onPress.push(function(tile,touch){self.objectResizingBegin(tile,touch)});tile.onRelease.push(function(){self.objectResizingEnd()});self.addTile(tile);tile.setColour(gColour.setRGBA(1,0,0,.75));return tile}this.tileObjectResizer.push(createResizer());this.tileObjectResizer.push(createResizer());this.tileObjectResizer.push(createResizer());this.tileObjectResizer.push(createResizer());this.tileObjectResizer.push(createResizer());this.tileObjectResizer.push(createResizer());this.tileObjectResizer.push(createResizer());this.tileObjectResizer.push(createResizer());this.sceneUI=new SceneUIEditorUI(this,this.manager);this.sceneUI.setupMenu(this.info)};SceneUIEditor.prototype.setupViewport=function(){var frameBufferWidth,frameBufferHeight;if(CCEngine.IsPortrait()){frameBufferWidth=gRenderer.width;frameBufferHeight=gRenderer.height}else{frameBufferWidth=gRenderer.height;frameBufferHeight=gRenderer.width}var targetAspectRatio=720/1080;var targetFrameHeight=targetAspectRatio*frameBufferWidth*.5;var viewportHeight=targetFrameHeight/frameBufferHeight;var viewportY=(1-viewportHeight)*.5;this.camera.setupViewport(.25,viewportY,.5,viewportHeight)};SceneUIEditor.prototype.resize=function(){this.setupViewport();this.CCSceneAppUI_resize();this.selectedObjectsUpdated()};SceneUIEditor.prototype.updateScene=function(delta){return this.CCSceneAppUI_updateScene(delta)};SceneUIEditor.prototype.updateCamera=function(delta){var updated=false;var camera=this.camera;var lookAtSpeed=this.controlsMoving&&!this.cameraScrolling?20:1.5;if(this.camera.interpolateCamera(delta,lookAtSpeed)){if(this.scrollBar){}var tile,i;var cameraStickyTiles=this.cameraStickyTiles;for(i=0;i<cameraStickyTiles.length;++i){tile=cameraStickyTiles[i];tile.setPosition(this.camera.currentLookAt)}{var cameraHeight=camera.calcCameraHeightForOffset(camera.offset[2]);var size=cameraHeight*.03;if(CCEngine.IsMobile()){size*=3}for(i=0;i<this.tileObjectResizer.length;++i){this.tileObjectResizer[i].setTileSize(size,size,size)}this.objectResized()}updated=true}else{if(this.cameraScrolling){this.cameraScrolling=false;this.lockCameraView();updated=true}if(this.resizing){this.resizing=false;this.refreshCameraView();this.lockCameraView();updated=true}}return updated};SceneUIEditor.prototype.postRender=function(camera,pass,alpha){if(this.camera===camera){if(pass===CCRenderer.render_main&&alpha){var renderer=gRenderer;var object;var selectedObjects=this.selectedObjects;if(selectedObjects.length>0){gEngine.textureManager.setTextureIndex(1);renderer.CCDefaultTexCoords();renderer.CCSetColour(gColour.setRGBA(1,0,0,.5));for(var i=0;i<selectedObjects.length;++i){object=selectedObjects[i];CCRenderer.GLPushMatrix();CCRenderer.GLTranslate(object.position);CCRenderer.GLScale([object.collisionSize.width,object.collisionSize.height,1]);renderer.CCRenderCube(true);CCRenderer.GLPopMatrix()}}if(this.selectionBoxStart&&this.selectionBoxEnd){var selectionBoxStart=this.selectionBoxStart;var selectionBoxEnd=this.selectionBoxEnd;var size=vec3.clone(selectionBoxEnd);vec3.subtract(size,selectionBoxEnd,selectionBoxStart);var position=vec3.clone(selectionBoxStart);position[0]+=size[0]*.5;position[1]+=size[1]*.5;position[2]+=size[2]*.5;gEngine.textureManager.setTextureIndex(1);renderer.CCSetColour(gColour.setRGBA(1,0,0,.5));CCRenderer.GLPushMatrix();CCRenderer.GLTranslate(position);CCRenderer.GLScale([size[0],size[1],1]);renderer.CCRenderCube(true);CCRenderer.GLPopMatrix()}}}};SceneUIEditor.prototype.updateControls=function(controls){var usingControls=this.CCSceneAppUI_updateControls(controls);return usingControls};SceneUIEditor.prototype.handleTwoTouches=function(touch1,touch2){return false};SceneUIEditor.prototype.touchPressed=function(touch){var camera=this.camera;var hitLocation,projectionResults,offset,i;if(this.sceneUI.enableSelectionBox){if(camera.project3D(touch.x,touch.y)){hitLocation=vec3.create();projectionResults=camera.projectionResults;offset=projectionResults.vNear[2]/Math.abs(projectionResults.vDirection[2]);vec3.scale(hitLocation,projectionResults.vDirection,offset);vec3.add(hitLocation,hitLocation,projectionResults.vNear);this.selectionBoxStart=hitLocation}}else{var result=this.handleTilesTouch(touch,CCControls.touch_pressed);if(result===CCSceneAppUI.tile_touchAction){return true}else{var selectedObjects=this.selectedObjects;if(selectedObjects.length>0){if(camera.project3D(touch.x,touch.y)){hitLocation=vec3.create();projectionResults=camera.projectionResults;offset=projectionResults.vNear[2]/Math.abs(projectionResults.vDirection[2]);vec3.scale(hitLocation,projectionResults.vDirection,offset);
vec3.add(hitLocation,hitLocation,projectionResults.vNear);for(i=0;i<selectedObjects.length;++i){var object=selectedObjects[i];CC.UpdateCollisions(object);if(CC.BasicBoxCollisionCheck(object.aabbMin,object.aabbMax,hitLocation,hitLocation)){this.touchPressedStartLocation=hitLocation;return true}}}}}}return true};SceneUIEditor.prototype.touchMoving=function(touch,touchDelta){var camera=this.camera;var hitLocation,projectionResults,offset;var allowCameraMovement=true;if(this.sceneUI.enableSelectionBox){allowCameraMovement=false;if(camera.project3D(touch.x,touch.y)){hitLocation=this.selectionBoxEnd?this.selectionBoxEnd:vec3.create();projectionResults=camera.projectionResults;offset=projectionResults.vNear[2]/Math.abs(projectionResults.vDirection[2]);vec3.scale(hitLocation,projectionResults.vDirection,offset);vec3.add(hitLocation,hitLocation,projectionResults.vNear);this.selectionBoxEnd=hitLocation;gRenderer.pendingRender=true;return true}}else if(this.touchPressedStartLocation){allowCameraMovement=false;if(camera.project3D(touch.x,touch.y)){hitLocation=vec3.create();projectionResults=camera.projectionResults;offset=projectionResults.vNear[2]/Math.abs(projectionResults.vDirection[2]);vec3.scale(hitLocation,projectionResults.vDirection,offset);vec3.add(hitLocation,hitLocation,projectionResults.vNear);var movement=vec3.clone(hitLocation);vec3.subtract(movement,movement,this.touchPressedStartLocation);var i,object;if(this.touchPressedResizing){this.objectResizingMove(hitLocation,movement)}else{this.movingObjects=true;var selectedObjects=this.selectedObjects;for(i=0;i<selectedObjects.length;++i){object=selectedObjects[i];object.translate(movement[0],movement[1],movement[2])}this.objectResized()}this.touchPressedStartLocation=hitLocation;return true}}else{var result=this.handleTilesTouch(touch,this.controlsMovingVertical?CCControls.touch_movingVertical:CCControls.touch_movingHorizontal);if(result===CCSceneAppUI.tile_touchAction){return true}}if(allowCameraMovement){return this.touchCameraMoving(touchDelta.x,touchDelta.y)}return false};SceneUIEditor.prototype.touchReleased=function(touch,touchAction){var usingControls=false;if(this.touchPressedStartLocation){delete this.touchPressedStartLocation}if(this.sceneUI.enableSelectionBox){usingControls=this.handleSelectionBox(touch)}else if(this.movingObjects){usingControls=true;delete this.movingObjects;this.manager.objectsMoved();this.selectedObjectsUpdated()}else if(this.sceneUI.creatingObjects){usingControls=this.handleCreatingObjects(touch);this.sceneUI.handleCreateButton()}else{var result=this.handleTilesTouch(touch,touchAction);usingControls=result===CCSceneAppUI.tile_touchAction;if(!usingControls&&touchAction>=CCControls.touch_released){if(this.oneTouchDoubleTapped){}else if(this.controlsMoving){if(this.touchPressedResizing){this.objectResizingEnd();usingControls=true}else{usingControls=this.touchReleaseSwipe(touch)}}else if(touchAction===CCControls.touch_released){if(!usingControls){usingControls=this.handleObjectSelection(touch)}}}}if(this.oneTouchDoubleTappedLastPress){this.oneTouchDoubleTappedLastPress=false}if(this.oneTouchDoubleTapped){this.oneTouchDoubleTappedLastPress=true;this.oneTouchDoubleTapped=false}return usingControls};SceneUIEditor.prototype.touchCameraMoving=function(x,y){return false};SceneUIEditor.prototype.touchReleaseSwipe=function(touch){return false};SceneUIEditor.prototype.selectedObjectsAdd=function(object){if(object){if(object.getMovementInterpolator()){object.getMovementInterpolator().finish()}if(this.selectedObjects.find(object)===-1){this.selectedObjects.add(object);this.selectedObjectsUpdated()}}};SceneUIEditor.prototype.selectedObjectsRemove=function(object){this.selectedObjects.remove(object);this.selectedObjectsUpdated()};SceneUIEditor.prototype.selectedObjectsClear=function(){this.selectedObjects.length=0;this.selectedObjectsUpdated()};SceneUIEditor.prototype.selectedObjectsCopy=function(){for(var i=0;i<this.selectedObjects.length;++i){var object=this.selectedObjects[i];var objectCopy=this.createObject(object.position,object.constructor.name);objectCopy.translate(this.camera.targetWidth*.05);objectCopy.setTileSize(object.collisionSize.width,object.collisionSize.height);var image=object.getTileTextureFilename();if(object.constructor.name==="TileSocialProfile"){}else if(object.constructor.name==="TileOverlay"){}else if(image){objectCopy.setTileTexture(image)}}};SceneUIEditor.prototype.selectedObjectsUpdated=function(){if(this.sceneUI){if(this.sceneUI.enableSelectionBox){this.sceneUI.handleSelectionButton()}var selectedObjects=this.selectedObjects;if(selectedObjects&&selectedObjects.length>0){this.sceneUI.objectEditorOpen(selectedObjects)}else{this.sceneUI.objectEditorClose()}this.objectResized()}};SceneUIEditor.prototype.handleSelectionBox=function(touch){var camera=this.camera;if(this.selectionBoxStart&&camera.project3D(touch.x,touch.y)){var hitLocation=vec3.create();var projectionResults=camera.projectionResults;var offset=projectionResults.vNear[2]/Math.abs(projectionResults.vDirection[2]);vec3.scale(hitLocation,projectionResults.vDirection,offset);vec3.add(hitLocation,hitLocation,projectionResults.vNear);var selectionBoxMin=this.selectionBoxStart;var selectionBoxMax=hitLocation;CC.CalculateMinMaxVectors(selectionBoxMin,selectionBoxMax);var selectedObjects=this.selectedObjects;selectedObjects.length=0;var objects=this.uiObjects;for(i=0;i<objects.length;++i){var object=objects[i];CC.UpdateCollisions(object);if(CC.BasicBoxCollisionCheck(object.aabbMin,object.aabbMax,selectionBoxMin,selectionBoxMax)){selectedObjects.add(object)}}this.selectedObjectsUpdated();delete this.selectionBoxStart;if(this.selectionBoxEnd){delete this.selectionBoxEnd}}return true};SceneUIEditor.prototype.handleObjectSelection=function(touch){if(this.sceneUI.creatingObjects){this.sceneUI.handleCreateButton()}if(!this.lastHitObjects){this.lastHitObjects=[]}else{if(CC.Distance(touch.x,this.lastHitX)>.05||CC.Distance(touch.y,this.lastHitY)>.05){if(this.lastHitObjects.length>0){this.lastHitObjects.length=0}}}this.lastHitX=touch.x;this.lastHitY=touch.y;var camera=this.camera;var hitObject=null;var hitLocation=vec3.create();if(camera.project3D(touch.x,touch.y)){var projectionResults=camera.projectionResults;var collideables=this.collideables;hitObject=CC.BasicLineCollisionCheck(collideables,projectionResults.vNear,projectionResults.vFar,hitLocation,true,CC.collision_box,this.lastHitObjects,false,true);if(hitObject){this.lastHitObjects.push(hitObject)}else if(this.lastHitObjects.length>0){this.lastHitObjects.length=0}}this.manager.objectSelected(hitObject,hitLocation);return!!hitObject};SceneUIEditor.prototype.handleCreatingObjects=function(touch){var camera=this.camera;var hitObject=null;var hitLocation=vec3.create();if(camera.project3D(touch.x,touch.y)){var projectionResults=camera.projectionResults;var offset=projectionResults.vNear[2]/Math.abs(projectionResults.vDirection[2]);vec3.scale(hitLocation,projectionResults.vDirection,offset);vec3.add(hitLocation,hitLocation,projectionResults.vNear);this.selectedObjectsClear();var object=this.createObject(hitLocation);this.selectedObjects.add(object);this.selectedObjectsUpdated()}return!hitObject};SceneUIEditor.prototype.createObject=function(position,type){if(!type||!window[type]){type="CCTile3DButton"}var tile=new window[type](this);if(type==="CCTile3DButton"){tile.setupTile(30)}else if(type==="TileOverlay"){tile.setupTexturedHeight(30);tile.aspectRatioLocked=true}else if(type==="TileSocialProfile"){tile.setTileSize(this.camera.targetHeight*.1);tile.aspectRatioLocked=true}this.uiObjects.add(tile);tile.setPositionXY(position[0],position[1]);this.updatedObject(tile);this.manager.objectCreated();return tile};SceneUIEditor.prototype.findObject=function(object){var camera=this.camera;camera.targetOffset[2]=camera.calcCameraOffsetForWidth(object.collisionSize.width*4);camera.targetOffset[2]=CC.FloatClamp(camera.targetOffset[2],this.minZoomOffset,this.maxZoomOffset);camera.targetLookAt[0]=object.position[0];camera.targetLookAt[2]=object.position[2];camera.flagUpdate()};SceneUIEditor.prototype.updatedObject=function(object){this.manager.objectUpdated();this.collideables.sort(function(a,b){return b.drawOrder-a.drawOrder});this.uiObjects.sort(function(a,b){return b.drawOrder-a.drawOrder});var camera=this.camera;var tile=object;if(tile.fullScreen){var image=tile.getTileTextureFilename();if(image){tile.setupTexturedFit(camera.targetWidth,camera.targetHeight,true,image)}else{tile.setTileSize(camera.targetWidth,camera.targetHeight)}}this.selectedObjectsUpdated()};SceneUIEditor.prototype.deleteObject=function(object){var uiObjects=this.uiObjects;for(var i=0;i<uiObjects.length;++i){if(uiObjects[i]===object){uiObjects.remove(object);this.tiles.remove(object);this.selectedObjectsRemove(object);object.deleteLater();this.manager.objectDeleted();break}}};SceneUIEditor.prototype.objectResizingBegin=function(tile,touch){var camera=this.camera;if(camera.project3D(touch.x,touch.y)){var hitLocation=vec3.create();var projectionResults=camera.projectionResults;var offset=projectionResults.vNear[2]/Math.abs(projectionResults.vDirection[2]);vec3.scale(hitLocation,projectionResults.vDirection,offset);vec3.add(hitLocation,hitLocation,projectionResults.vNear);this.touchPressedStartLocation=hitLocation;this.touchPressedResizing=tile}};SceneUIEditor.prototype.objectResizingMove=function(hitLocation,movement){this.touchPressedResizing.setPositionXY(hitLocation[0],hitLocation[1]);var selectedObjects=this.selectedObjects;var size;if(selectedObjects.length>0){for(i=0;i<selectedObjects.length;++i){object=selectedObjects[i];if(this.touchPressedResizing===this.tileObjectResizer[0]){size=object.collisionBounds[1]*2+movement[1]*2}else if(this.touchPressedResizing===this.tileObjectResizer[4]){size=object.collisionBounds[1]*2+-movement[1]*2}else if(this.touchPressedResizing===this.tileObjectResizer[2]){size=object.collisionBounds[0]*2+movement[0]*2}else if(this.touchPressedResizing===this.tileObjectResizer[6]){size=object.collisionBounds[0]*2+-movement[0]*2}else if(this.touchPressedResizing===this.tileObjectResizer[1]||this.touchPressedResizing===this.tileObjectResizer[3]){size=object.collisionBounds[0]*2+movement[0]*2}else{size=object.collisionBounds[0]*2+-movement[0]*2}if(size<10){size=10}if(size>this.camera.targetWidth*1.5){size=this.camera.targetWidth*1.5}var aspectRatio=object.collisionSize.height/object.collisionSize.width;if(this.touchPressedResizing===this.tileObjectResizer[0]||this.touchPressedResizing===this.tileObjectResizer[4]){object.setTileSize(object.aspectRatioLocked?size/aspectRatio:object.collisionSize.width,size)}else if(this.touchPressedResizing===this.tileObjectResizer[2]||this.touchPressedResizing===this.tileObjectResizer[6]){object.setTileSize(size,object.aspectRatioLocked?size*aspectRatio:object.collisionSize.height)}else{object.setTileSize(size,size*aspectRatio)}}}this.objectResized()};SceneUIEditor.prototype.objectResized=function(){var i;for(i=0;i<this.tileObjectResizer.length;++i){this.tileObjectResizer[i].setPositionXY(this.camera.targetWidth,this.camera.targetHeight)}if(this.sceneUI&&this.sceneUI.enableObjectResizing){var selectedObjects=this.selectedObjects;for(i=0;i<selectedObjects.length;++i){var object=selectedObjects[i];if(!object.fullScreen){var tile;tile=this.tileObjectResizer[0];tile.setPositionXY(object.position[0],object.aabbMax[1]);tile=this.tileObjectResizer[1];tile.setPositionXY(object.aabbMax[0],object.aabbMax[1]);tile=this.tileObjectResizer[2];tile.setPositionXY(object.aabbMax[0],object.position[1]);tile=this.tileObjectResizer[3];tile.setPositionXY(object.aabbMax[0],object.aabbMin[1]);tile=this.tileObjectResizer[4];tile.setPositionXY(object.position[0],object.aabbMin[1]);tile=this.tileObjectResizer[5];tile.setPositionXY(object.aabbMin[0],object.aabbMin[1]);tile=this.tileObjectResizer[6];tile.setPositionXY(object.aabbMin[0],object.position[1]);tile=this.tileObjectResizer[7];tile.setPositionXY(object.aabbMin[0],object.aabbMax[1]);break}}}};SceneUIEditor.prototype.objectResizingEnd=function(){delete this.touchPressedResizing;delete this.touchPressedStartLocation;this.refreshCameraView();this.manager.objectsResized();this.selectedObjectsUpdated()};SceneUIEditor.prototype.startJS=function(){this.js="";this.jsIndent=0};SceneUIEditor.prototype.endJS=function(){var js=this.js;delete this.js;delete this.jsIndent;return js};SceneUIEditor.prototype.addJS=function(js){if(!js){js=""}else{if(js==="}"||js==="};"){this.jsIndent--}for(var i=0;i<this.jsIndent;++i){this.js+="	"}if(js==="{"){this.jsIndent++}}this.js+=js+"\n"};SceneUIEditor.prototype.validateJS=function(js){var validatedJS="";var openSplit=js.split("(");if(openSplit.length>1){validatedJS=openSplit[0];var closeSplit=openSplit[1].split(")");if(closeSplit.length>0){var parameters=closeSplit[0];parameters=parameters.formatSpacesAndTabs();if(parameters.length>0){var openDoubleQuote=-1;var openSingleQuote=-1;for(var i=0;i<parameters.length;++i){var character=parameters[i];if(character==='"'){if(openDoubleQuote!==-1){if(openDoubleQuote<openSingleQuote){openSingleQuote=-1}openDoubleQuote=-1}else{openDoubleQuote=i}}else if(character==="'"){if(openSingleQuote!==-1){if(openSingleQuote<openDoubleQuote){openDoubleQuote=-1}openSingleQuote=-1}else{openSingleQuote=i}}}if(openDoubleQuote!==-1&&openSingleQuote!==-1){if(openDoubleQuote>openSingleQuote){openDoubleQuote=false}else{openSingleQuote=false}}if(openDoubleQuote!==-1){parameters+='"'}else if(openSingleQuote!==-1){parameters+="'"}}validatedJS+="( ";validatedJS+=parameters;validatedJS+=" )"}else{validatedJS+="()"}}return validatedJS};SceneUIEditor.prototype.exportJS=function(){var i;this.startJS();this.addJS("// This function will be overritten if modified by the UI Editor");this.addJS("function "+this.info.name+"(parentScene)");this.addJS("{");this.addJS("this.jsSyncReCreate = true;    // Tell our engine that it's ok to reset this class if it's JS code is updated");this.addJS("this.construct();");this.addJS("this.cameraCentered = true;");this.addJS("this.cameraReletivePositions = true;");this.addJS("gEngine.addScene( this );");this.addJS("");this.addJS("if( parentScene )");this.addJS("{");this.addJS("this.setParent( parentScene );         // Tell our parent when this class is deleted");this.addJS("this.parentScene.linkScene( this );    // Tell our parent to delete this class when it is deleted");this.addJS("}");this.addJS("}");this.addJS("ExtendPrototype( "+this.info.name+", CCSceneAppUI );");this.addJS();this.addJS();this.addJS("// This function can be tweaked, however aggressive changes will be overriten if modified by the UI Editor.");this.addJS(this.info.name+".prototype.setup = function()");this.addJS("{");this.addJS("var self = this;");this.addJS();this.addJS("this.CCSceneAppUI_setup();");this.addJS();this.addJS("var tile;");this.addJS();var uiObjects=this.uiObjects;var tile,image;var cachedImages=[];for(i=uiObjects.length-1;i>=0;--i){tile=uiObjects[i];if(tile.constructor.name==="TileSocialProfile"){continue}var textureHandle=tile.getTileTextureHandle();if(textureHandle&&textureHandle.image){if(!textureHandle.src.contains("/resources/")){if(cachedImages.length===0){this.addJS("// Load images in back to front order")}if(cachedImages.find(textureHandle.filename)===-1){cachedImages.push(textureHandle.filename);this.addJS('gEngine.textureManager.getTextureHandle( "'+textureHandle.filename+'" );')}}}}if(cachedImages.length>0){this.addJS()}this.addJS("this.uiObjects = [];");for(i=0;i<uiObjects.length;++i){tile=uiObjects[i];this.addJS("{");this.addJS("tile = new "+tile.constructor.name+"( this );");if(tile.name){this.addJS("this."+tile.name+" = tile;")}this.addJS("this.uiObjects.push( tile );");if(tile.drawOrder!==100){this.addJS("tile.setDrawOrder( "+tile.drawOrder+" );")}this.addJS("tile.setTileSize( "+tile.collisionSize.width+", "+tile.collisionSize.height+" );");this.addJS("this.setReletiveX( tile, "+this.getReletiveX(tile)+" );");this.addJS("this.setReletiveY( tile, "+this.getReletiveY(tile)+" );");image=tile.getTileTextureFilename();if(tile.constructor.name==="TileSocialProfile"){}else if(tile.constructor.name==="TileOverlay"){}else if(image){this.addJS();this.addJS('tile.setTileTexture( "'+image+'" );')}this.addJS();this.addJS('tile.setColour( gColour.fromString( "'+tile.colour.toString()+'" ) );');if(tile.isBlinking()){this.addJS("tile.setBlinking( true );")}if(tile.aspectRatioLocked){this.addJS();this.addJS("tile.aspectRatioLocked = true;")}if(tile.fullScreen){this.addJS("tile.fullScreen = true;")}if(tile.flippedX){this.addJS();this.addJS("tile.flipTileX();")}if(tile.flippedY){this.addJS();this.addJS("tile.flipTileY();")}if(tile.rotation[2]!==0){this.addJS();this.addJS("tile.setRotationZ( "+tile.rotation[2]+" );")}var text=tile.getText();if(text){this.addJS();var textScale=tile.textScale;if(textScale!==undefined){this.addJS("tile.setTextScale( "+textScale+" );")}this.addJS('tile.setText( "'+text+'" );');this.addJS('tile.setTextColour( gColour.fromString( "'+tile.textObject.colour.toString()+'" ) );');if(tile.isTextBlinking()){this.addJS("tile.setTextBlinking( true );")}}if(tile.get3DModelFilename()){this.addJS();this.addJS('tile.set3DModel( "'+tile.get3DModelFilename()+'", "'+tile.get3DModelTextureFilename()+'" );');if(tile.model3dObject.colour){if(!gColour.white().equals(tile.model3dObject.colour)){this.addJS('tile.model3dObject.setColour( gColour.fromString( "'+tile.model3dObject.colour.toString()+'" ) );')}}if(tile.model3dAnimationSpeed){this.addJS("tile.set3DModelAnimationSpeed( "+tile.model3dAnimationSpeed+" );")}if(!vec3.isZero(tile.model3dObject.rotation)){this.addJS('tile.set3DModelRotation( "'+vec3.toString(tile.model3dObject.rotation)+'" );')}}if(tile.onPress.length>0||tile.onRelease.length>0||tile.onLoss.length>0){this.addJS();if(tile.onPress.length>0){this.addJS("tile.onPress.push( function() { "+tile.onPress[0]+"; } );")}if(tile.onRelease.length>0){this.addJS("tile.onRelease.push( function() { "+tile.onRelease[0]+"; } );")}if(tile.onLoss.length>0){this.addJS("tile.onLoss.push( function() { "+tile.onLoss[0]+"; } );")}this.addJS("this.addTile( tile );")}this.addJS("}");this.addJS()}this.addJS("if( this.setupFinish )");this.addJS("{");this.addJS("// Custom setup should be written into a setupFinish function");this.addJS("this.setupFinish();");this.addJS("}");this.addJS();this.addJS("this.requestResize();");this.addJS("};");this.addJS();this.addJS();this.addJS("// This function will be overritten if modified by the UI Editor");this.addJS(this.info.name+".prototype.resize = function()");this.addJS("{");this.addJS("var self = this;");this.addJS("this.CCSceneAppUI_resize();");this.addJS("var camera = this.camera;");this.addJS();this.addJS("var tile;");for(i=0;i<uiObjects.length;++i){tile=uiObjects[i];if(tile.fullScreen){this.addJS("{");this.addJS("tile = this.uiObjects["+i+"];");image=tile.getTileTextureFilename();if(image){this.addJS('tile.setupTexturedFit( camera.targetWidth, camera.targetHeight, true, "'+image+'" );')}else{this.addJS("tile.setTileSize( camera.targetWidth, camera.targetHeight );")}this.addJS("}")}}this.addJS("};");this.addJS();this.addJS();this.addJS("// This function will be overritten if modified by the UI Editor");this.addJS(this.info.name+".prototype.touchCameraMoving = function()");this.addJS("{");this.addJS("return false;");this.addJS("};");this.addJS("");this.addJS("");this.addJS("// While it is recommended to write new functions for this class in a new file,");this.js+=this.customJSMarker;if(this.customJS){this.js+=this.customJS}if(window.console&&console.log){console.log(this.js)}return this.endJS()};SceneUIEditor.prototype.loadJS=function(js){var jsLines=js.split("\n");var line,formattedLine;var tile,parameters,i;for(i=0;i<jsLines.length;++i){line=jsLines[i];line=line.formatSpacesAndTabs();if(line.startsWith("if( this.setupFinish )")){tile=null;break}if(line.startsWith("tile")){if(line.startsWith("tile = new TileOverlay")){tile=new TileOverlay(this);tile.setupTile(30);this.uiObjects.add(tile)}else if(line.startsWith("tile = new TileSocialProfile")){tile=new TileSocialProfile(this);this.uiObjects.add(tile)}else if(line.startsWith("tile = new CCTile3DButton")){tile=new CCTile3DButton(this);tile.setupTile(30);this.uiObjects.add(tile)}else if(line.startsWith("tile.setTileSize")||line.startsWith("tile.setPositionXY")||line.startsWith("tile.setTextScale")||line.startsWith("tile.setColour")||line.startsWith("tile.setBlinking")||line.startsWith("tile.setText")||line.startsWith("tile.setTextColour")||line.startsWith("tile.setTextBlinking")||line.startsWith("tile.setTileTexture")||line.startsWith("tile.aspectRatioLocked")||line.startsWith("tile.flipTileX")||line.startsWith("tile.flipTileY")||line.startsWith("tile.setRotationZ")||line.startsWith("tile.setDrawOrder")||line.startsWith("tile.set3DModel")||line.startsWith("tile.model3dObject.setColour")){try{eval(line)}catch(e){if(window.console&&console.log){console.log(e)}}}else if(line.startsWith("tile.fullScreen")){tile.fullScreen=true;var image=tile.getTileTextureFilename();if(image){tile.setupTexturedFit(this.camera.targetWidth,this.camera.targetHeight,true,image)}else{tile.setTileSize(this.camera.targetWidth,this.camera.targetHeight)}}else if(line.startsWith("tile.onPress")||line.startsWith("tile.onRelease")||line.startsWith("tile.onLoss")){if(tile){formattedLine=String.SplitBetween(line,"{","}");formattedLine=formattedLine.formatSpacesAndTabs();if(formattedLine.length>0){if(formattedLine[formattedLine.length-1]===";"){formattedLine=formattedLine.substring(0,formattedLine.length-1)}}if(line.startsWith("tile.onPress")){tile.onPress.push(formattedLine)}else if(line.startsWith("tile.onRelease")){tile.onRelease.push(formattedLine)}else if(line.startsWith("tile.onLoss")){tile.onLoss.push(formattedLine)}}}}else if(line.startsWith("this.")){if(line.startsWith("this.setReletive")){if(tile){try{eval(line)}catch(e){if(window.console&&console.log){console.log(e)}}}}else if(line.contains("= tile;")){if(tile){formattedLine=String.SplitBetween(line,"this.","=");formattedLine=formattedLine.formatSpacesAndTabs();tile.name=formattedLine}}}}var customJSSplit=js.split(this.customJSMarker);if(customJSSplit.length>1){this.customJS=customJSSplit[1];for(i=2;i<customJSSplit.length;++i){this.customJS+=this.customJSMarker;this.customJS+=customJSSplit[i]}}return true};SceneUIEditor.prototype.onKeyboard=function(event,key,pressed){if(event.metaKey){return false}if(event.ctrlKey){return false}if(pressed){var selectedObjects=this.selectedObjects;if(selectedObjects.length>0){{var x=0;var y=0;if(key==="up"){y=1}else if(key==="down"){y=-1}else if(key==="left"){x=-1}else if(key==="right"){x=1}if(x!==0||y!==0){var i;var object;if(event.shiftKey){var size;for(i=0;i<selectedObjects.length;++i){object=selectedObjects[i];var aspectRatio=object.collisionSize.height/object.collisionSize.width;if(y!==0){size=object.collisionBounds[1]*2+y*2;object.setTileSize(object.aspectRatioLocked?size/aspectRatio:object.collisionSize.width,size)}else{size=object.collisionBounds[0]*2+x*2;object.setTileSize(size,object.aspectRatioLocked?size*aspectRatio:object.collisionSize.height)}this.objectResized()}}else{for(i=0;i<selectedObjects.length;++i){object=selectedObjects[i];this.setReletiveX(object,Math.round(this.getReletiveX(object)*100+x)/100);this.setReletiveY(object,Math.round(this.getReletiveY(object)*100+y)/100)}this.manager.objectsMoved();this.selectedObjectsUpdated()}}}}}return false};function SceneManagerList(parentScene){this.construct();parentScene.linkScene(this);this.setParent(parentScene)}ExtendPrototype(SceneManagerList,CCSceneAppUI);SceneManagerList.prototype.construct=function(){MultiplayerManager.UpdateCallbacks.addOnce(this);this.CCSceneAppUI_construct();{var parentCameraIndex=gEngine.findCameraIndex(this.parentScene.camera);var camera=gEngine.newSceneCamera(this,parentCameraIndex+1);camera.setupViewport(0,0,1,1)}var self=this;this.sceneUIBack=new SceneUIBack(this,function(){self.parentScene.close()},true)};SceneManagerList.prototype.deleteLater=function(){if(this.sceneUIBack){this.sceneUIBack.close();this.sceneUIBack=null}this.CCSceneAppUI_deleteLater()};SceneManagerList.prototype.setup=function(){var self=this;var camera=this.camera;camera.setCameraWidth(640,false);var tile;{tile=new CCTile3DButton(this);tile.setupTile(camera.targetWidth,camera.targetHeight);tile.setColour(gColour.set(.25,0));tile.setColourAlpha(.9,true);tile.setDrawOrder(203);this.cameraStickyTiles.add(tile);this.tileBackground=tile}this.tileLists=[]};SceneManagerList.prototype.syncUpdate=function(jsonData){};SceneManagerList.prototype.updateCamera=function(delta){return this.CCSceneAppUI_updateCamera(delta)};SceneManagerList.prototype.render=function(camera,pass,alpha){this.CCSceneAppUI_render(camera,pass,alpha)};SceneManagerList.prototype.resize=function(){this.CCSceneAppUI_resize();var camera=this.camera;var tile;{tile=this.tileBackground;tile.setTileSize(camera.targetWidth,camera.targetHeight)}var y;var tileLists=this.tileLists;for(var i=0;i<tileLists.length;++i){var tileList=tileLists[i];var title=tileList.title;var list=tileList.list;if(i===0){tile=title;tile.setTextHeight(camera.targetHeight*.055,true);y=tile.getTileMovementTarget()[1]-tile.collisionBounds[1];this.listTiles(list,y)}else{tile=this.tileLists[i-1].list.last();if(!tile){tile=title}y=tile.getTileMovementTarget()[1]-tile.collisionBounds[1];tile=title;tile.setTextHeight(camera.targetHeight*.055,true);y-=tile.collisionBounds[1];y-=tile.collisionSize.height;tile.setPositionY(y);y=tile.getTileMovementTarget()[1]-tile.collisionBounds[1];this.listTiles(list,y)}}};SceneManagerList.prototype.listTiles=function(tiles,y){var camera=this.camera;var columns=3;var sideSpacing=camera.targetWidth*.1;var tileSpacing=camera.targetWidth*.025;var tileWidth=(camera.targetWidth-tileSpacing*(columns-1)-sideSpacing*2)/columns;var tileHeight=tileWidth*.5;var hTileWidth=tileWidth*.5;var hTileHeight=tileHeight*.5;var x=-(camera.targetWidth*.5)+sideSpacing+hTileWidth;y-=(tileHeight+tileSpacing)*.5;var columnIndex=0;for(i=0;i<tiles.length;++i){var tile=tiles[i];tile.setTileSize(tileWidth,tileHeight);tile.setTextHeight(tileHeight*.25);tile.setPositionXYZ(x,y,0);x+=tileWidth+tileSpacing;columnIndex++;if(columnIndex>=columns){columnIndex=0;x=-(camera.targetWidth*.5)+sideSpacing+hTileWidth;y-=tileHeight+tileSpacing}}};SceneManagerList.prototype.updateControls=function(controls){var usingControls=this.CCSceneAppUI_updateControls(controls);var cameraTouches=this.camera.cameraTouches;var touch=cameraTouches[0];if(touch.x>0&&touch.x<1&&touch.y>0&&touch.y<1&&touch.startX>0&&touch.startX<1&&touch.startY>0&&touch.startY<1){if(controls.wheel&&controls.wheel.delta!==0){var delta=controls.wheel.delta;this.cameraScrolling=true;this.controlsMovingVertical=true;this.touchCameraMoving(0,delta*.1);return true}}return usingControls};SceneManagerList.prototype.touchPressed=function(touch){if(this.CCSceneAppUI_touchPressed(touch)){return true}return false};SceneManagerList.prototype.touchMovementAllowed=function(touch,touchDelta){var absDeltaX=Math.abs(touch.totalDeltaX);var absDeltaY=Math.abs(touch.totalDeltaY);if(absDeltaX>CCControls.TouchMovementThreashold.x||absDeltaY>CCControls.TouchMovementThreashold.y){this.controlsMoving=true;touchDelta.x+=touch.totalDeltaX;touchDelta.y+=touch.totalDeltaY;this.controlsMovingVertical=true;return true}return false};SceneManagerList.prototype.touchMoving=function(touch,touchDelta){return this.CCSceneAppUI_touchMoving(touch,touchDelta)};SceneManagerList.prototype.touchReleased=function(touch,touchAction){return this.CCSceneAppUI_touchReleased(touch,touchAction)};SceneManagerList.prototype.refreshCameraView=function(){this.sceneLeft=0;this.sceneRight=0;this.sceneTop=0;this.sceneBottom=0;var tiles=this.tiles;var tile=tiles.first();if(tile){this.sceneTop=tile.getTileMovementTarget()[1]+tile.collisionBounds[1];if(this.sceneTop<this.sceneBottom){this.sceneTop=this.sceneBottom}this.sceneTop+=tile.collisionSize.height;this.sceneTop-=this.camera.cameraHeight*.5}var bottomTile;for(var i=0;i<tiles.length;++i){tile=tiles[i];if(!bottomTile||tile.getTileMovementTarget()[1]<bottomTile.getTileMovementTarget()[1]){bottomTile=tile}}if(bottomTile){this.sceneBottom=bottomTile.getTileMovementTarget()[1]-bottomTile.collisionBounds[1];if(this.sceneBottom>this.sceneTop){this.sceneBottom=this.sceneTop}}};SceneManagerList.prototype.lockCameraView=function(){if(this.cameraScrolling){return}var camera=this.camera;camera.flagUpdate();camera.targetLookAt[0]=0;if(camera.targetLookAt[1]>this.sceneTop){camera.targetLookAt[1]=this.sceneTop}else if(camera.targetLookAt[1]<this.sceneBottom){camera.targetLookAt[1]=this.sceneBottom}};SceneManagerList.prototype.addList=function(name,colour){var tileList={};var tile=new CCTile3DButton(this);tile.setupText(name,1,true,false);tile.setTextColour(colour);tile.setDrawOrder(204);this.tilePublic=tile;this.addTile(tile);tile.setTouchDepressDepth(0);tileList.title=tile;tileList.list=[];this.tileLists.push(tileList)};function SceneMapsManagerList(parentScene){parentScene.linkScene(this);this.setParent(parentScene);this.construct();gEngine.addScene(this)}ExtendPrototype(SceneMapsManagerList,SceneManagerList);SceneMapsManagerList.prototype.deleteLater=function(){if(this.syncingUpdates){MultiplayerManager.Emit("EditorMapsUnregisterListUpdates");this.syncingUpdates=false}this.SceneManagerList_deleteLater()};SceneMapsManagerList.prototype.setup=function(){this.SceneManagerList_setup();this.maps=[];this.addList("Your Public Levels",EditorManager.LightGreen);this.addList("Your Private Levels",EditorManager.LightRed);var self=this;CCFileManager.Load("SceneMapsManagerList.db",function(data){if(data){if(!self.loaded){var list=JSON.parse(data);self.show(list)}}});if(MultiplayerManager.Emit("EditorMapsRequestList")){this.syncingUpdates=true}};SceneMapsManagerList.prototype.syncUpdate=function(jsonData){var publicTiles=this.tileLists[0].list;var privateTiles=this.tileLists[1].list;var map,i,tile,tileText;if(jsonData.EditorMaps){var list=jsonData.EditorMaps;this.show(list);CCFileManager.Save("SceneMapsManagerList.db",list);if(!this.loaded){this.loaded=true}}else if(jsonData.EditorMapsListUpdated){map=jsonData.EditorMapsListUpdated;mapID=map.mapID;var mapTile;for(i=0;i<privateTiles.length;++i){tile=privateTiles[i];if(mapID===tile.mapID){mapTile=tile;break}}if(!mapTile){for(i=0;i<publicTiles.length;++i){tile=publicTiles[i];if(mapID===tile.mapID){mapTile=tile;break}}}if(mapTile){tileText=map.name;tileText+="\nid:"+map.mapID;tileText+="\n Players:";tileText+=map.players;tileText+=" Objects:";tileText+=map.objects;mapTile.setText(tileText)}}};SceneMapsManagerList.prototype.show=function(list){var self=this;var publicTiles=this.tileLists[0].list;var privateTiles=this.tileLists[1].list;var map,i,tile,tileText;var EnterMapFunction=function(mapID){return function(){self.parentScene.enterMap(mapID)}};var tiles=this.tiles;{for(i=0;i<privateTiles.length;++i){tile=privateTiles[i];tiles.remove(tile);tile.deleteLater()}privateTiles.length=0}{for(i=0;i<publicTiles.length;++i){tile=publicTiles[i];tiles.remove(tile);tile.deleteLater()}publicTiles.length=0}for(i=0;i<list.length;++i){map=list[i];tileText=map.name;tileText+="\nid:"+map.mapID;tileText+="\n Players:";tileText+=map.players;tileText+=" Objects:";tileText+=map.objects;tile=new CCTile3DButton(this);tile.setupText(tileText,1,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setTextColour(gColour.set(0,1));if(map.open){tile.setColour(EditorManager.LightGreen)}else{tile.setColour(EditorManager.LightRed)}tile.setDrawOrder(205);tile.onRelease.push(new EnterMapFunction(map.mapID));this.addTile(tile);if(map.open){publicTiles.add(tile)}else{privateTiles.add(tile)}tile.mapID=map.mapID}{tile=new CCTile3DButton(this);tile.setupText("+",1,true,true);tile.setTileTexture("editor_tile_background.jpg");
tile.setColourAlpha(0,false);tile.setTextColour(gColour.set(.125,1));tile.setColour(gColour.set(.5,.9));tile.setDrawOrder(205);tile.onRelease.push(function(){self.parentScene.newMap(true)});this.addTile(tile);publicTiles.add(tile)}{tile=new CCTile3DButton(this);tile.setupText("+",1,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setTextColour(gColour.set(0,1));tile.setColour(gColour.set(.5,.9));tile.setDrawOrder(205);tile.onRelease.push(function(){self.parentScene.newMap(false)});this.addTile(tile);privateTiles.add(tile)}this.requestResize()};function SceneMapsManager(){this.construct()}ExtendPrototype(SceneMapsManager,SceneManagerPlay);SceneMapsManager.prototype.construct=function(){this.SceneManagerPlay_construct();this.syncDisconnected()};SceneMapsManager.prototype.destruct=function(){this.SceneManagerPlay_destruct()};SceneMapsManager.prototype.deleteLater=function(){CC.RemoveJSLocationBarData("SceneMapsManager");this.SceneManagerPlay_deleteLater()};SceneMapsManager.prototype.setup=function(){this.SceneManagerPlay_setup()};SceneMapsManager.prototype.updateScene=function(delta){return this.SceneManagerPlay_updateScene(delta)};SceneMapsManager.prototype.syncDisconnected=function(){AlertsManager.ModalAlert("connecting...")};SceneMapsManager.prototype.syncLoggedIn=function(){this.SceneManagerPlay_syncLoggedIn();AlertsManager.Hide("connecting...",2);if(this.map){this.map.deleteLater();this.map=null}var mapsManagerSettings=CC.GetJSLocationBarData("SceneMapsManager");if(mapsManagerSettings&&mapsManagerSettings!=="menu"){this.enterMap(mapsManagerSettings)}else{this.openMapsList()}};SceneMapsManager.prototype.syncUpdate=function(jsonData){this.SceneManagerPlay_syncUpdate(jsonData);var map,mapID;if(jsonData.EditorEnteredMap){map=jsonData.EditorEnteredMap;this.enteredMap(map)}else if(jsonData.EditorCopiedMap){mapID=jsonData.EditorCopiedMap;AlertsManager.Hide("creating copy...");if(this.map){this.map.deleteLater();this.map=null}this.enterMap(mapID)}else if(jsonData.EditorDeletedMap){mapID=jsonData.EditorDeletedMap;AlertsManager.Hide("deleting...");this.handleBackButton()}else if(jsonData.EditorSelectObject){var objectID=jsonData.EditorSelectObject;if(this.map){var object=this.map.getStaticObject(objectID);if(object){this.map.selectedObjectsAdd(object)}}}};SceneMapsManager.prototype.openMapsList=function(){CC.SetJSLocationBarData("SceneMapsManager","menu");if(this.sceneMapsList){this.closeMapsList()}if(MultiplayerManager.LoggedIn){this.sceneMapsList=new SceneMapsManagerList(this)}};SceneMapsManager.prototype.closeMapsList=function(){if(this.sceneMapsList){this.sceneMapsList.deleteLater();this.sceneMapsList=null}};SceneMapsManager.prototype.newMap=function(open){if(MultiplayerManager.Emit("EditorMapNew",open)){AlertsManager.ModalAlert("loading...")}};SceneMapsManager.prototype.enterMap=function(mapID){if(MultiplayerManager.Emit("EditorMapEnter",mapID)){AlertsManager.ModalAlert("loading...")}};SceneMapsManager.prototype.enteredMap=function(mapData){CC.SetJSLocationBarData("SceneMapsManager",mapData.loadGame);AlertsManager.Hide("loading...");if(this.map){this.map.deleteLater();this.map=null}this.map=new SceneMapEditor(mapData.loadGame,this,mapData);this.closeMapsList()};SceneMapsManager.prototype.onDragDrop=function(files,event){if(event&&event.target){if(MultiplayerManager.LoggedIn){if(this.map){var self=this;var i,filename,fileExtension;var isJS=true;for(i=0;i<files.length;++i){filename=files[i].name;fileExtension=filename.getExtension();if(fileExtension!=="js"){isJS=false;break}}if(isJS){this.map.sceneUI.openJSMapEditor(function(result,js){if(result){MultiplayerManager.Emit("EditorJS",js)}if(self.map){self.map.sceneUI.showMenu()}});return}if(!this.map.sceneUI.sceneAssetEditor){var openModelCreator=false;if(this.map.selectedObjects.length>0){for(i=0;i<this.map.selectedObjects.length;++i){if(this.map.selectedObjects[i]!==this.map.ground){openModelCreator=true}}}else if(this.map.sceneUI.creatingObjects){openModelCreator=true}else{for(i=0;i<files.length;++i){filename=files[i].name;fileExtension=filename.getExtension();if(fileExtension==="obj"||fileExtension==="fbx"||fileExtension==="fbxi"){openModelCreator=true;break}}}if(openModelCreator){if(!this.map.sceneUI.creatingObjects){this.map.sceneUI.handleCreateButton()}var OnCreatedFunction=function(modelInfo){if(modelInfo){self.modelCreated(modelInfo)}};if(this.map.selectedObjects.length>0){var object=this.map.selectedObjects[0];var modelID=object.modelID;this.map.sceneUI.findAndSelectModelID(modelID,function(result){if(result){var modelInfo=self.map.sceneUI.getSelectedModel();self.map.sceneUI.openAssetEditor("Edit Model",true,false,OnCreatedFunction);self.map.sceneUI.sceneAssetEditor.setModel(modelInfo)}else{self.map.sceneUI.openAssetEditor("Create Model",true,false,OnCreatedFunction);self.map.sceneUI.sceneAssetEditor.setAsset(object.obj);self.map.sceneUI.sceneAssetEditor.setAsset(object.tex)}})}else{this.map.sceneUI.openAssetEditor("Create Model",true,false,OnCreatedFunction)}}else{this.map.sceneUI.openAssetEditor("Upload Map Texture",false,false,function(tex){if(tex){self.handleEditMapTexture(tex)}})}}}}}};SceneMapsManager.prototype.handleBackButton=function(){if(this.map){this.map.deleteLater();this.map=null;this.openMapsList();MultiplayerManager.Emit("EditorMapExit")}return true};SceneMapsManager.prototype.handleDeleteMap=function(){if(this.map){if(MultiplayerManager.LoggedIn){var self=this;AlertsManager.ConfirmationAlert("Delete map?",function(result){if(result){if(MultiplayerManager.Emit("EditorMapDelete")){AlertsManager.Hide("deleting...")}}})}}};SceneMapsManager.prototype.handleEditName=function(){if(this.map){if(MultiplayerManager.LoggedIn){var self=this;var map=this.map;AlertsManager.InputAlert(map.sceneUI.tileMapName.getText(),function(result){if(result){if(self.map.name!==result){if(MultiplayerManager.Emit("EditorMapEditName",result)){map.name=result;map.sceneUI.setupMenu(self.map.mapID,self.map.name,open)}}}},{space:true})}}};SceneMapsManager.prototype.handleEditPrivacy=function(){if(this.map){if(MultiplayerManager.LoggedIn){var self=this;var map=this.map;var open=map.open;AlertsManager.ConfirmationAlert(open?"Make private?":"Make public?",function(result){if(result){if(MultiplayerManager.Emit("EditorMapEditPrivacy",!open)){open=!open;map.sceneUI.setupMenu(self.map.mapID,self.map.name,open)}}})}}};SceneMapsManager.prototype.handleCopyButton=function(){if(this.map){if(MultiplayerManager.Emit("EditorMapCopy")){AlertsManager.ModalAlert("creating copy...")}}return true};SceneMapsManager.prototype.handleEditMapTexture=function(filename){if(filename){var fileExtension=filename.getExtension();if(fileExtension==="png"||fileExtension==="jpg"){MultiplayerManager.Emit("EditorMapTexture",filename)}}};SceneMapsManager.prototype.objectSelected=function(hitObject,location){var map=this.map;var selectedObjects=map.selectedObjects;var i;var reselectedObject=false;for(i=0;i<selectedObjects.length;++i){if(hitObject===selectedObjects[i]){reselectedObject=true;break}}if(reselectedObject){if(selectedObjects.length===1){if(map.sceneUI.creatingObjects){map.sceneUI.handleCreateButton()}else{map.selectedObjectsClear()}}else{map.selectedObjectsClear();map.selectedObjectsAdd(hitObject)}}else{var containsPlayers=selectedObjects.length>0;for(i=0;i<selectedObjects.length;++i){if(!selectedObjects[i].playerID){containsPlayers=false;break}}if(!containsPlayers){map.selectedObjectsClear();if(hitObject){if(hitObject.playerID){if(map.sceneUI.creatingObjects){map.sceneUI.handleCreateButton()}}map.selectedObjectsAdd(hitObject)}}else{var player;if(hitObject){if(hitObject.playerID){for(i=0;i<selectedObjects.length;++i){player=selectedObjects[i];if(player.playerID){MultiplayerManager.Emit("EditorShootAt",player.playerID,hitObject.playerID)}}}else{map.selectedObjectsClear();map.selectedObjectsAdd(hitObject)}}else{var mapBounds=map.getMapBounds();location[0]/=mapBounds.width;location[2]/=mapBounds.height;var tLocation=vec3.toString(location);for(i=0;i<selectedObjects.length;++i){player=selectedObjects[i];if(player.playerID){MultiplayerManager.Emit("EditorGotoLocation",player.playerID,tLocation)}}}}}};SceneMapsManager.prototype.objectsMoved=function(objects){var map=this.map;if(map){var selectedObjects=map.selectedObjects;if(selectedObjects.length>0){var mapBounds=map.getMapBounds();var i;for(i=0;i<selectedObjects.length;++i){var object=selectedObjects[i];if(!object.playerID&&object!==map.ground){var objectID=object.getID();var location=vec3.clone(object.position);location[0]/=mapBounds.width;location[2]/=mapBounds.height;var tLocation=vec3.toString(location);MultiplayerManager.Emit("EditorObjectMove",objectID,tLocation)}}map.updatePathFinder()}map.selectedObjectsUpdated()}};SceneMapsManager.prototype.objectsResized=function(){var map=this.map;if(map){var selectedObjects=map.selectedObjects;if(selectedObjects.length>0){for(i=0;i<selectedObjects.length;++i){var object=selectedObjects[i];if(!object.playerID){var size=object.collisionSize.width;if(object===map.ground){MultiplayerManager.Emit("EditorMapSize",size)}else{var objectID=object.getID();MultiplayerManager.Emit("EditorObjectSize",objectID,size)}}}map.updatePathFinder()}map.selectedObjectsUpdated()}};SceneMapsManager.prototype.createObject=function(location){var map=this.map;if(map){var mapBounds=map.getMapBounds();location[0]/=mapBounds.width;location[2]/=mapBounds.height;var tLocation=vec3.toString(location);var obj,tex;var modelInfo=map.sceneUI.getSelectedModel();if(modelInfo){MultiplayerManager.Emit("EditorObjectCreate",tLocation,modelInfo.objectID)}else{MultiplayerManager.Emit("EditorObjectCreate",tLocation)}}};SceneMapsManager.prototype.deleteObject=function(object){var map=this.map;if(map){var id=object.objectID;if(MultiplayerManager.Emit("EditorObjectDelete",id)){map.syncRemoveStaticObject(id)}}};SceneMapsManager.prototype.modelCreated=function(modelInfo){if(MultiplayerManager.LoggedIn){var map=this.map;if(map){var objects=map.selectedObjects;var i,object;if(modelInfo){for(i=0;i<objects.length;++i){object=objects[i];MultiplayerManager.Emit("EditorObjectModel",object.getID(),modelInfo.objectID)}}map.sceneUI.flagPendingModelUpdate();map.sceneUI.findAndSelectModelID(modelInfo.objectID)}}};SceneMapsManager.prototype.modelSelected=function(modelInfo){if(MultiplayerManager.LoggedIn){var map=this.map;if(map){var objects=map.selectedObjects;var i,object;if(modelInfo){var modelID=modelInfo.objectID;for(i=0;i<objects.length;++i){object=objects[i];var id=object.objectID;MultiplayerManager.Emit("EditorObjectModel",id,modelID);object.setupModel(modelInfo.obj,modelInfo.tex)}if(!this.map.sceneUI.creatingObjects){this.map.sceneUI.handleCreateButton()}}}}};SceneMapsManager.prototype.close=function(){this.deleteLater();new SceneProjectManager};function SceneTemplateUIManagerList(manager){this.manager=manager;manager.linkScene(this);this.setParent(manager);this.construct()}ExtendPrototype(SceneTemplateUIManagerList,SceneManagerList);SceneTemplateUIManagerList.prototype.deleteLater=function(){this.SceneManagerList_deleteLater()};SceneTemplateUIManagerList.prototype.setup=function(){this.SceneManagerList_setup();this.ui=[];this.addList("Your Private Screens",EditorManager.LightRed);this.addList("Open Source Screens",EditorManager.LightGreen);var self=this;CCFileManager.Load("SceneTemplateUIManagerList.db",function(data){if(data){if(!self.loaded){var list=JSON.parse(data);self.show(list)}}});if(MultiplayerManager.Emit("EditorUIRequestList")){this.syncingUpdates=true}};SceneTemplateUIManagerList.prototype.syncUpdate=function(jsonData){var privateTiles=this.tileLists[0].list;var publicTiles=this.tileLists[1].list;var tiles=this.tiles;var info,i,tile;if(jsonData.EditorUI){var list=jsonData.EditorUI;this.show(list);CCFileManager.Save("SceneTemplateUIManagerList.db",list);if(!this.loaded){this.loaded=true}}else if(jsonData.EditorUIUpdated){info=jsonData.EditorUIUpdated;id=info.id;var uiTile;for(i=0;i<privateTiles.length;++i){tile=privateTiles[i];if(id===tile.id){uiTile=tile;break}}if(!uiTile){for(i=0;i<publicTiles.length;++i){tile=publicTiles[i];if(id===tile.id){uiTile=tile;break}}}if(uiTile){uiTile.setText(info.id+"\n"+info.name)}}};SceneTemplateUIManagerList.prototype.show=function(list){var self=this;var privateTiles=this.tileLists[0].list;var publicTiles=this.tileLists[1].list;var tiles=this.tiles;var info,i,tile;var OpenUIFunction=function(info){return function(){self.manager.openUI(info)}};{for(i=0;i<privateTiles.length;++i){tile=privateTiles[i];tiles.remove(tile);tile.deleteLater()}privateTiles.length=0}{for(i=0;i<publicTiles.length;++i){tile=publicTiles[i];tiles.remove(tile);tile.deleteLater()}publicTiles.length=0}var ignoreUIs=this.manager.ignoreUIs;for(i=0;i<list.length;++i){info=list[i];var skip=false;for(var j=0;j<ignoreUIs.length;++j){var ignoreUI=ignoreUIs[j];if(info.id===ignoreUI.id){skip=true;break}}if(skip){continue}tile=new CCTile3DButton(this);tile.setupText(info.id+"\n"+info.name,1,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setTextColour(gColour.set(0,1));if(info.open){tile.setColour(EditorManager.LightGreen)}else{tile.setColour(EditorManager.Red)}tile.setDrawOrder(205);tile.onRelease.push(new OpenUIFunction(info));this.addTile(tile);if(info.open){publicTiles.add(tile)}else{privateTiles.add(tile)}tile.id=info.id}{{tile=new CCTile3DButton(this);tile.setupText("+",1,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setTextColour(gColour.set(.125,1));tile.setColour(gColour.set(.5,.9));tile.setDrawOrder(205);tile.onRelease.push(function(){self.manager.createUI(true)});this.addTile(tile);publicTiles.add(tile)}{tile=new CCTile3DButton(this);tile.setupText("+",1,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.setColourAlpha(0,false);tile.setTextColour(gColour.set(0,1));tile.setColour(gColour.set(.5,.9));tile.setDrawOrder(205);tile.onRelease.push(function(){self.manager.createUI(false)});this.addTile(tile);privateTiles.add(tile)}}this.requestResize()};function SceneTemplateUIManager(uiID,onSelect,onClose,ignoreUIs){this.construct();if(uiID){this.loadingUI=uiID}else{var managerSettings=CC.GetJSLocationBarData("SceneTemplateUIManager");if(managerSettings&&managerSettings!=="menu"){this.loadingUI=managerSettings}}if(onSelect){this.onSelect=onSelect}if(onClose){this.onClose=onClose}if(ignoreUIs){this.ignoreUIs=ignoreUIs}else{this.ignoreUIs=[]}gEngine.addScene(this)}ExtendPrototype(SceneTemplateUIManager,SceneManagerPlay);SceneTemplateUIManager.prototype.construct=function(){this.SceneManagerPlay_construct();this.syncDisconnected()};SceneTemplateUIManager.prototype.destruct=function(){this.SceneManagerPlay_destruct()};SceneTemplateUIManager.prototype.deleteLater=function(){if(window.socket){if(!this.unregistered){MultiplayerManager.Emit("EditorUIUnregisterUpdates");this.unregistered=false}}CC.RemoveJSLocationBarData("SceneTemplateUIManager");this.SceneManagerPlay_deleteLater()};SceneTemplateUIManager.prototype.setup=function(){this.SceneManagerPlay_setup()};SceneTemplateUIManager.prototype.onPause=function(){if(this.syncJSTime!==undefined){this.syncJS()}};SceneTemplateUIManager.prototype.updateScene=function(delta){var updated=this.SceneManagerPlay_updateScene(delta);if(this.syncJSTime!==undefined){this.syncJSTime-=delta;if(this.syncJSTime<=0){this.syncJS()}}return updated};SceneTemplateUIManager.prototype.syncDisconnected=function(){AlertsManager.ModalAlert("connecting...",2);if(this.ui){if(!this.loadingUI){if(this.ui.info){this.loadingUI=this.ui.info.id}}this.ui.deleteLater();this.ui=null}};SceneTemplateUIManager.prototype.syncLoggedIn=function(){this.SceneManagerPlay_syncLoggedIn();MultiplayerManager.Emit("EditorUIRegisterUpdates");AlertsManager.Hide("connecting...");if(this.webViewController){CCEngine.WebViewClose(this.webViewController);delete this.webViewController}if(this.loadingUI){this.requestUI(this.loadingUI);delete this.loadingUI}else{this.openList()}};SceneTemplateUIManager.prototype.syncUpdate=function(jsonData){this.SceneManagerPlay_syncUpdate(jsonData);var info,id;if(jsonData.EditorUIUpdated){if(this.ui){info=this.ui.info;var newInfo=jsonData.EditorUIUpdated;if(info.id===newInfo.id){if(info.filename!==newInfo.filename){this.openUI(newInfo)}}}}else if(jsonData.EditorUICreated){AlertsManager.Hide("loading...");info=jsonData.EditorUICreated;this.openUI(info)}else if(jsonData.EditorUICopied!==undefined){AlertsManager.Hide("copying...");if(this.ui){this.handleBackButton()}info=jsonData.EditorUICopied;if(info){this.openUI(info);AlertsManager.TimeoutAlert("UI Copied",2)}else{AlertsManager.TimeoutAlert("failed to copy UI",2)}}else if(jsonData.EditorUIDeleted!==undefined){AlertsManager.Hide("deleting...");id=jsonData.EditorUIDeleted;if(id===-1){AlertsManager.TimeoutAlert("failed to delete UI",2)}this.handleBackButton()}else if(jsonData.uiInfo!==undefined){AlertsManager.Hide("loading...");info=jsonData.uiInfo;if(info){this.openUI(info)}else{AlertsManager.TimeoutAlert("failed to load UI",2);this.openList()}}};SceneTemplateUIManager.prototype.openList=function(){CC.SetJSLocationBarData("SceneTemplateUIManager","menu");if(this.sceneList){this.closeList()}this.sceneList=new SceneTemplateUIManagerList(this);gEngine.addScene(this.sceneList)};SceneTemplateUIManager.prototype.closeList=function(){if(this.sceneList){this.sceneList.deleteLater();this.sceneList=null}};SceneTemplateUIManager.prototype.createUI=function(open){AlertsManager.ModalAlert("loading...");MultiplayerManager.Emit("EditorUICreate",open)};SceneTemplateUIManager.prototype.requestUI=function(id){AlertsManager.ModalAlert("loading...");MultiplayerManager.Emit("UIRequest",id)};SceneTemplateUIManager.prototype.openUI=function(info){if(this.onSelect){if(this.onSelect(this,info)){this.close();return}}CC.SetJSLocationBarData("SceneTemplateUIManager",info.id);this.closeList();if(info.filename){var filename=info.filename;var url=MultiplayerManager.GetAssetURL(info.filename);AlertsManager.Notification("editor","loading...");var self=this;gURLManager.requestURL(url,null,function(status,responseText){if(self.ui){self.handleBackButton(true)}self.ui=new SceneUIEditor(info,self);AlertsManager.Hide("loading...");var loaded=false;if(status>=CCURLRequest.Succeeded){loaded=self.ui.loadJS(responseText)}if(!loaded){AlertsManager.TimeoutAlert("failed to load js :(",2)}},1,filename)}else{if(this.ui){this.handleBackButton(true)}this.ui=new SceneUIEditor(info,this)}};SceneTemplateUIManager.prototype.handleBackButton=function(restarting){if(this.ui){if(!restarting){if(this.syncJSTime!==undefined){this.syncJS()}}if(this.webViewController){CCEngine.WebViewClose(this.webViewController);delete this.webViewController}this.ui.deleteLater();this.ui=null;if(!restarting){this.openList();if(this.onClose){this.close()}}}return true};SceneTemplateUIManager.prototype.handleDelete=function(){if(this.ui){if(MultiplayerManager.LoggedIn){var self=this;AlertsManager.ConfirmationAlert("Delete UI?",function(result){if(result){MultiplayerManager.Emit("EditorUIDelete",self.ui.info.id);AlertsManager.Hide("deleting...")}})}}};SceneTemplateUIManager.prototype.handleEditName=function(){if(this.ui){if(MultiplayerManager.LoggedIn){var self=this;var ui=this.ui;var name=ui.info.name;AlertsManager.InputAlert(name,function(result){if(result){if(name!==result){if(MultiplayerManager.LoggedIn){ui.info.name=result;ui.sceneUI.setupMenu(ui.info);MultiplayerManager.Emit("EditorUIEditName",ui.info.id,ui.info.name);self.syncJS()}}}},{space:true})}}};SceneTemplateUIManager.prototype.handleEditPrivacy=function(){if(this.ui){if(MultiplayerManager.LoggedIn){var self=this;var ui=this.ui;var open=ui.info.open;AlertsManager.ConfirmationAlert(open?"Make private?":"Make public?",function(result){if(result){ui.info.open=!open;if(MultiplayerManager.Emit("EditorUIEditPrivacy",ui.info.id,ui.info.open)){ui.sceneUI.setupMenu(ui.info)}}})}}};SceneTemplateUIManager.prototype.handleEditJS=function(){if(MultiplayerManager.LoggedIn){if(this.ui){if(MultiplayerManager.LoggedIn){var self=this;var ui=this.ui;var info=ui.info;var fileID=info.id;var OpenCodeEditor=function(filename){var url=SERVER_ROOT+"jseditor/#file="+filename;if(SERVER_ASSETS_URL.getDomain()!==WINDOW_DOMAIN){url+="&proxy="+SERVER_ASSETS_URL}CCEngine.WebViewOpen(url,function(webViewController,opened){if(webViewController&&opened){self.webViewController=webViewController;webViewController.webView.fileID=fileID}},function(webViewController,url,open){if(open){var splitURL=url.split("#save");if(splitURL.length>1){if(MultiplayerManager.LoggedIn){if(self.webViewController){var webView=self.webViewController.webView;var data=webView.GetData();webView.SavedData(data);self.uploadJS(fileID,data,true);self.ui.deleteLater();self.ui=new SceneUIEditor(info,self);self.ui.loadJS(data)}}}}},"jseditor","_newtab")};if(this.syncJSTime!==undefined){this.syncJS(OpenCodeEditor)}else{OpenCodeEditor(info.filename)}}}}};SceneTemplateUIManager.prototype.close=function(){this.deleteLater();if(this.onClose){this.onClose()}else{new SceneProjectManager}};SceneTemplateUIManager.prototype.objectSelected=function(hitObject,location){var ui=this.ui;var selectedObjects=ui.selectedObjects;var i;if(ui.sceneUI.creatingObjects){ui.sceneUI.handleCreateButton()}var reselectedObject=false;for(i=0;i<selectedObjects.length;++i){if(hitObject===selectedObjects[i]){reselectedObject=true;break}}if(reselectedObject){if(!gEngine.controls.keys[91]&&!gEngine.controls.keys[17]){ui.selectedObjectsClear()}else{ui.selectedObjectsRemove(hitObject)}}else{if(!gEngine.controls.keys[91]&&!gEngine.controls.keys[17]){ui.selectedObjectsClear()}if(hitObject){ui.selectedObjectsAdd(hitObject)}}};SceneTemplateUIManager.prototype.objectCreated=function(){this.requestSyncJS()};SceneTemplateUIManager.prototype.objectsMoved=function(){this.requestSyncJS()};SceneTemplateUIManager.prototype.objectsResized=function(){this.requestSyncJS()};SceneTemplateUIManager.prototype.objectUpdated=function(){this.requestSyncJS()};SceneTemplateUIManager.prototype.objectDeleted=function(){this.requestSyncJS()};SceneTemplateUIManager.prototype.requestSyncJS=function(){this.syncJSTime=.5;if(this.webViewController){CCEngine.WebViewClose(this.webViewController);delete this.webViewController}};SceneTemplateUIManager.prototype.syncJS=function(callback){if(MultiplayerManager.LoggedIn){delete this.syncJSTime;if(this.ui){var id=this.ui.info.id;if(MultiplayerManager.IsOwner(this.ui.info.owners)){var fileID=id;var data=this.ui.exportJS();this.uploadJS(fileID,data,false,callback)}else{AlertsManager.ConfirmationAlert("In order to make changes to this UI,\nyou must first create a copy",function(result){if(result){if(MultiplayerManager.Emit("EditorUICopy",id)){AlertsManager.ModalAlert("copying...")}}})}}}};SceneTemplateUIManager.prototype.uploadJS=function(fileID,data,alert,callback){var self=this;EditorManager.EditorUploadJS(fileID,data,function(fileID,filename){var uploaded=false;if(filename){if(MultiplayerManager.LoggedIn){uploaded=true;self.uploadedJS(filename);if(callback){callback(filename)}}}if(!uploaded){AlertsManager.TimeoutAlert("failed to upload "+fileID+" :(",2)}},alert)};SceneTemplateUIManager.prototype.uploadedJS=function(filename){if(this.ui){var info=this.ui.info;info.filename=filename;MultiplayerManager.Emit("EditorUIUpdateJS",info.id,filename)}};function SceneProjectUIManager(appID,uiInfo,onClose){this.construct();this.appID=appID;this.onClose=onClose;gEngine.addScene(this);this.uiInfo=uiInfo;this.openUI(uiInfo);if(!uiInfo.filename){this.syncJS()}}ExtendPrototype(SceneProjectUIManager,SceneManagerPlay);SceneProjectUIManager.prototype.construct=function(){this.SceneManagerPlay_construct();this.syncDisconnected()};SceneProjectUIManager.prototype.destruct=function(){this.SceneManagerPlay_destruct()};SceneProjectUIManager.prototype.deleteLater=function(){CC.RemoveJSLocationBarData("SceneProjectUIManager");this.SceneManagerPlay_deleteLater()};SceneProjectUIManager.prototype.setup=function(){this.SceneManagerPlay_setup()};SceneProjectUIManager.prototype.updateAppInfo=function(appInfo){if(appInfo.id===this.appID){var uiScenes=appInfo.uiScenes;for(var i=0;i<uiScenes.length;++i){var ui=uiScenes[i];if(ui.id===this.uiInfo.id){if(!CC.DeepEquals(ui,this.uiInfo)){this.uiInfo=ui;this.openUI(ui)}break}}}};SceneProjectUIManager.prototype.onPause=function(){if(this.syncJSTime!==undefined){this.syncJS()}};SceneProjectUIManager.prototype.updateScene=function(delta){var updated=this.SceneManagerPlay_updateScene(delta);if(this.syncJSTime!==undefined){this.syncJSTime-=delta;if(this.syncJSTime<=0){this.syncJS()}}return updated};SceneProjectUIManager.prototype.syncDisconnected=function(){};SceneProjectUIManager.prototype.syncLoggedIn=function(){this.SceneManagerPlay_syncLoggedIn();if(this.webViewController){CCEngine.WebViewClose(this.webViewController);delete this.webViewController}};SceneProjectUIManager.prototype.syncUpdate=function(jsonData){this.SceneManagerPlay_syncUpdate(jsonData);var info,id;if(jsonData.EditorUIUpdated){if(this.ui){info=this.ui.info;var newInfo=jsonData.EditorUIUpdated;if(info.id===newInfo.id){if(info.filename!==newInfo.filename){this.openUI(newInfo)}}}}else if(jsonData.EditorUIDeleted!==undefined){AlertsManager.Hide("deleting...");id=jsonData.EditorUIDeleted;if(id===-1){AlertsManager.TimeoutAlert("failed to delete UI",2)}this.handleBackButton()}};SceneProjectUIManager.prototype.openUI=function(info){if(this.onSelect){if(this.onSelect(this,info)){this.close();return}}CC.SetJSLocationBarData("SceneProjectUIManager",info.id);if(info.filename){var filename=info.filename;var url=MultiplayerManager.GetAssetURL(info.filename);AlertsManager.Notification("editor","loading...");var self=this;gURLManager.requestURL(url,null,function(status,responseText){if(self.ui){self.handleBackButton(true)}self.ui=new SceneUIEditor(info,self);AlertsManager.Hide("loading...");var loaded=false;if(status>=CCURLRequest.Succeeded){loaded=self.ui.loadJS(responseText)}if(!loaded){AlertsManager.TimeoutAlert("failed to load js :(",2)}},1,filename)}else{this.ui=new SceneUIEditor(info,this)}};SceneProjectUIManager.prototype.handleBackButton=function(restarting){if(this.ui){if(!restarting){if(this.syncJSTime!==undefined){this.syncJS()}}if(this.webViewController){CCEngine.WebViewClose(this.webViewController);delete this.webViewController}this.ui.deleteLater();this.ui=null;if(!restarting){if(this.onClose){this.close()}}}return true};SceneProjectUIManager.prototype.handleDelete=function(){if(this.ui){if(MultiplayerManager.LoggedIn){var self=this;AlertsManager.ConfirmationAlert("Delete UI?",function(result){if(result){MultiplayerManager.Emit("EditorUIDelete",self.ui.info.id);AlertsManager.Hide("deleting...")}})}}};SceneProjectUIManager.prototype.handleEditName=function(){if(this.ui){if(MultiplayerManager.LoggedIn){var self=this;var ui=this.ui;var name=ui.info.name;AlertsManager.InputAlert(name,function(result){if(result){if(name!==result){if(MultiplayerManager.LoggedIn){ui.info.name=result;ui.sceneUI.setupMenu(ui.info);MultiplayerManager.Emit("EditorProjectEditUIName",self.appID,ui.info.id,ui.info.name);self.syncJS()}}}},{space:true})}}};SceneProjectUIManager.prototype.handleEditPrivacy=function(){if(this.ui){if(MultiplayerManager.LoggedIn){var self=this;var ui=this.ui;var open=ui.info.open;AlertsManager.ConfirmationAlert(open?"Make private?":"Make public?",function(result){if(result){ui.info.open=!open;if(MultiplayerManager.Emit("EditorUIEditPrivacy",ui.info.id,ui.info.open)){ui.sceneUI.setupMenu(ui.info)}}})}}};SceneProjectUIManager.prototype.handleEditJS=function(){if(CCEngine.IsMobile()){AlertsManager.TimeoutAlert("Please visit playir.com to edit source code",10);return}if(MultiplayerManager.LoggedIn){if(this.ui){if(MultiplayerManager.LoggedIn){var self=this;var ui=this.ui;var info=ui.info;var fileID=info.id;var OpenCodeEditor=function(filename){var url=SERVER_ROOT+"jseditor/#file="+filename;if(SERVER_ASSETS_URL.getDomain()!==WINDOW_DOMAIN){url+="&proxy="+SERVER_ASSETS_URL}CCEngine.WebViewOpen(url,function(webViewController,opened){if(webViewController&&opened){self.webViewController=webViewController;webViewController.webView.fileID=fileID}},function(webViewController,url,open){if(open){var splitURL=url.split("#save");if(splitURL.length>1){if(MultiplayerManager.LoggedIn){if(self.webViewController){var webView=self.webViewController.webView;var data=webView.GetData();webView.SavedData(data);self.uploadJS(fileID,data,true);self.ui.deleteLater();self.ui=new SceneUIEditor(info,self);self.ui.loadJS(data)}}}}},"jseditor","_newtab")};if(this.syncJSTime!==undefined){this.syncJS(OpenCodeEditor)}else{OpenCodeEditor(info.filename)}}}}};SceneProjectUIManager.prototype.close=function(){this.deleteLater();if(this.onClose){this.onClose()}else{new SceneProjectManager}};SceneProjectUIManager.prototype.objectSelected=function(hitObject,location){var ui=this.ui;var selectedObjects=ui.selectedObjects;var i;if(ui.sceneUI.creatingObjects){ui.sceneUI.handleCreateButton()}var reselectedObject=false;for(i=0;i<selectedObjects.length;++i){if(hitObject===selectedObjects[i]){reselectedObject=true;break}}if(reselectedObject){if(!gEngine.controls.keys[91]&&!gEngine.controls.keys[17]){ui.selectedObjectsClear()}else{ui.selectedObjectsRemove(hitObject)}}else{if(!gEngine.controls.keys[91]&&!gEngine.controls.keys[17]){ui.selectedObjectsClear()}if(hitObject){ui.selectedObjectsAdd(hitObject)}}};SceneProjectUIManager.prototype.objectCreated=function(){this.requestSyncJS()};SceneProjectUIManager.prototype.objectsMoved=function(){this.requestSyncJS()};SceneProjectUIManager.prototype.objectsResized=function(){this.requestSyncJS()};SceneProjectUIManager.prototype.objectUpdated=function(){this.requestSyncJS()};SceneProjectUIManager.prototype.objectDeleted=function(){this.requestSyncJS()};SceneProjectUIManager.prototype.requestSyncJS=function(){this.syncJSTime=.5;if(this.webViewController){CCEngine.WebViewClose(this.webViewController);delete this.webViewController}};SceneProjectUIManager.prototype.syncJS=function(callback){if(MultiplayerManager.LoggedIn){if(this.syncJSTime){delete this.syncJSTime}if(this.ui){var uiID=this.ui.info.id;var fileID=uiID;var data=this.ui.exportJS();this.uploadJS(fileID,data,false,callback)}}};SceneProjectUIManager.prototype.uploadJS=function(fileID,data,alert,callback){var self=this;EditorManager.EditorUploadJS(fileID,data,function(fileID,filename){var uploaded=false;if(filename){if(MultiplayerManager.LoggedIn){uploaded=true;self.uploadedJS(filename);if(callback){callback(filename)}}}if(!uploaded){AlertsManager.TimeoutAlert("failed to upload "+fileID+" :(",2)}},alert)};SceneProjectUIManager.prototype.uploadedJS=function(filename){if(this.ui){var info=this.ui.info;info.filename=filename;MultiplayerManager.Emit("EditorProjectEditUI",this.appID,info.id,filename)}};function SceneImagesManager(){this.construct()}ExtendPrototype(SceneImagesManager,SceneManagerPlay);SceneImagesManager.prototype.construct=function(){this.SceneManagerPlay_construct();this.openList();this.syncDisconnected();CC.SetJSLocationBarData("SceneImagesManager");var camera=gEngine.newSceneCamera(this);camera.setupViewport(0,0,1,1)};SceneImagesManager.prototype.deleteLater=function(){CC.RemoveJSLocationBarData("SceneImagesManager");this.SceneManagerPlay_deleteLater()};SceneImagesManager.prototype.syncDisconnected=function(){AlertsManager.ModalAlert("connecting...",2)};SceneImagesManager.prototype.syncLoggedIn=function(){this.SceneManagerPlay_syncLoggedIn();AlertsManager.Hide("connecting...")};SceneImagesManager.prototype.syncUpdate=function(jsonData){this.SceneManagerPlay_syncUpdate(jsonData);if(jsonData.EditorImageDeleted){this.openList()}};SceneImagesManager.prototype.close=function(){this.deleteLater();new SceneProjectManager};SceneImagesManager.prototype.openList=function(){if(!this.sceneAssetEditor){var self=this;
this.sceneAssetEditor=new SceneAssetEditor(this,false,true,true);this.sceneAssetEditor.open("Edit Images");this.sceneAssetEditor.onClose=function(tex){if(tex){self.sceneAssetEditor=null;self.openList();self.sceneAssetEditor.sceneUIListDBImages.findAndSelect(tex)}else{self.close()}};var currentImageInfo;this.sceneAssetEditor.onSelected=function(imageInfo){if(imageInfo!==currentImageInfo){currentImageInfo=imageInfo;self.sceneAssetEditor.setImage(imageInfo)}}}};SceneImagesManager.prototype.closeList=function(){if(this.sceneAssetEditor){this.sceneAssetEditor.close()}};function SceneModelsManager(){this.construct()}ExtendPrototype(SceneModelsManager,SceneManagerPlay);SceneModelsManager.prototype.construct=function(){this.SceneManagerPlay_construct();this.openList();this.syncDisconnected();CC.SetJSLocationBarData("SceneModelsManager");var camera=gEngine.newSceneCamera(this);camera.setupViewport(0,0,1,1)};SceneModelsManager.prototype.deleteLater=function(){CC.RemoveJSLocationBarData("SceneModelsManager");this.SceneManagerPlay_deleteLater()};SceneModelsManager.prototype.syncDisconnected=function(){AlertsManager.ModalAlert("connecting...",2)};SceneModelsManager.prototype.syncLoggedIn=function(){this.SceneManagerPlay_syncLoggedIn();AlertsManager.Hide("connecting...")};SceneModelsManager.prototype.syncUpdate=function(jsonData){this.SceneManagerPlay_syncUpdate(jsonData);if(jsonData.EditorCharacterDeleted){this.openList()}};SceneModelsManager.prototype.close=function(){this.deleteLater();new SceneProjectManager};SceneModelsManager.prototype.openList=function(){if(!this.sceneAssetEditor){var self=this;this.sceneAssetEditor=new SceneAssetEditor(this,true,true,true);this.sceneAssetEditor.onClose=function(info){if(info){self.sceneAssetEditor=null;self.openList();if(info){self.sceneAssetEditor.sceneUIListDBModels.findAndSelect(info)}}else{self.close()}};this.sceneAssetEditor.onDeleted=function(){};var currentImageInfo;this.sceneAssetEditor.onSelected=function(imageInfo){if(imageInfo!==currentImageInfo){currentImageInfo=imageInfo;self.sceneAssetEditor.setImage(imageInfo)}};this.sceneAssetEditor.open("Edit Models")}};SceneModelsManager.prototype.closeList=function(){if(this.sceneAssetEditor){this.sceneAssetEditor.close()}};function SceneCharactersManager(){this.construct()}ExtendPrototype(SceneCharactersManager,SceneManagerPlay);SceneCharactersManager.prototype.construct=function(){this.SceneManagerPlay_construct();var managerSettings=CC.GetJSLocationBarData("SceneCharactersManager");if(managerSettings&&managerSettings!=="menu"){this.loadingCharacterID=managerSettings}this.openList();this.syncDisconnected();var camera=gEngine.newSceneCamera(this);camera.setupViewport(0,0,1,1);var self=this;this.sceneUIBack=new SceneUIBack(this,function(){self.closeList();self.close()},true)};SceneCharactersManager.prototype.deleteLater=function(){if(this.sceneUIBack){this.sceneUIBack.close();this.sceneUIBack=null}CC.RemoveJSLocationBarData("SceneCharactersManager");this.SceneManagerPlay_deleteLater()};SceneCharactersManager.prototype.syncDisconnected=function(){AlertsManager.ModalAlert("connecting...",2)};SceneCharactersManager.prototype.syncLoggedIn=function(){this.SceneManagerPlay_syncLoggedIn();AlertsManager.Hide("connecting...")};SceneCharactersManager.prototype.syncUpdate=function(jsonData){this.SceneManagerPlay_syncUpdate(jsonData);if(jsonData.EditorCharacterDeleted){this.openList()}};SceneCharactersManager.prototype.close=function(){this.deleteLater();new SceneProjectManager};SceneCharactersManager.prototype.newCharacter=function(){var self=this;if(this.loadingCharacterID){delete this.loadingCharacterID}this.closeList();if(!this.sceneCharacterEditor){this.sceneCharacterEditor=new SceneCharacterEditor(this.sceneUI);this.sceneCharacterEditor.selectModel();this.sceneCharacterEditor.onClose=function(characterInfo){self.sceneCharacterEditor=null;self.openList()}}};SceneCharactersManager.prototype.editCharacter=function(characterInfo){var self=this;if(this.loadingCharacterID){delete this.loadingCharacterID}this.closeList();if(!this.sceneCharacterEditor){this.sceneCharacterEditor=new SceneCharacterEditor(this);this.sceneCharacterEditor.onClose=function(characterInfo){self.sceneCharacterEditor=null;self.openList()}}this.sceneCharacterEditor.setCharacter(characterInfo);CC.SetJSLocationBarData("SceneCharactersManager",characterInfo.objectID)};SceneCharactersManager.prototype.openList=function(){if(!this.sceneUIListDB){CC.SetJSLocationBarData("SceneCharactersManager","menu");var self=this;this.sceneUIListDB=new SceneUIListDBCharacters(this,function(){self.newCharacter()},function(list){var characterID;if(self.sceneCharacterEditor){characterID=self.sceneCharacterEditor.info.objectID}else if(self.loadingCharacterID){characterID=self.loadingCharacterID}for(var i=0;i<list.length;++i){var info=list[i];if(info.objectID===characterID){self.editCharacter(info);break}}});this.sceneUIListDB.onSelected=function(characterInfo){self.editCharacter(characterInfo)}}};SceneCharactersManager.prototype.closeList=function(){if(this.sceneUIListDB){this.sceneUIListDB.close();this.sceneUIListDB=null}};function SceneAudioManager(){this.construct()}ExtendPrototype(SceneAudioManager,SceneManagerPlay);SceneAudioManager.prototype.construct=function(){this.SceneManagerPlay_construct();this.openList();this.syncDisconnected();CC.SetJSLocationBarData("SceneAudioManager");var camera=gEngine.newSceneCamera(this);camera.setupViewport(0,0,1,1)};SceneAudioManager.prototype.deleteLater=function(){if(this.sceneUIBack){this.sceneUIBack.close();this.sceneUIBack=null}CC.RemoveJSLocationBarData("SceneAudioManager");this.SceneManagerPlay_deleteLater()};SceneAudioManager.prototype.syncDisconnected=function(){AlertsManager.ModalAlert("connecting...",2)};SceneAudioManager.prototype.syncLoggedIn=function(){this.SceneManagerPlay_syncLoggedIn();AlertsManager.Hide("connecting...")};SceneAudioManager.prototype.syncUpdate=function(jsonData){this.SceneManagerPlay_syncUpdate(jsonData);if(jsonData.EditorCharacterDeleted){this.openList()}};SceneAudioManager.prototype.close=function(){this.deleteLater();new SceneProjectManager};SceneAudioManager.prototype.edit=function(info){var self=this;this.closeList();this.sceneEditor=new SceneAudioEditor(this.sceneUI);this.sceneEditor.setInfo(info);this.sceneEditor.open("Play "+info.id);this.sceneEditor.onClose=function(info){self.openList()}};SceneAudioManager.prototype.openList=function(){var self=this;if(!this.sceneUIListDB){this.sceneUIListDB=new SceneUIListDBAudio(this,function(){if(CCEngine.IsMobile()){AlertsManager.TimeoutAlert("Please visit playir.com to upload assets",10)}else{AlertsManager.TimeoutAlert("Drop in .mp3",3)}});this.sceneUIListDB.onSelected=function(info){self.edit(info)}}if(!this.sceneUIBack){this.sceneUIBack=new SceneUIBack(this.sceneUIListDB,function(){self.closeList();self.close()},true)}};SceneAudioManager.prototype.closeList=function(){if(this.sceneUIListDB){this.sceneUIListDB.close();this.sceneUIListDB=null}if(this.sceneUIBack){this.sceneUIBack.close();this.sceneUIBack=null}};function ColumnOfTiles(){this.tiles=[]}function RowOfTiles(){this.columns=[new ColumnOfTiles];this.columnIndex=0}RowOfTiles.prototype.addTile=function(tile){this.columns[this.columnIndex].tiles.add(tile)};RowOfTiles.prototype.addColumn=function(tile){this.columns.add(new ColumnOfTiles);this.columnIndex++;this.addTile(tile)};function SceneProjectEditor(parentScene,projectManager,appInfo){this.construct();this.controlsSwipeMomentum=true;this.projectManager=projectManager;this.appInfo=appInfo;this.appInfoRows=[];{this.setParent(parentScene)}{var camera=gEngine.newSceneCamera(this);camera.setupViewport(0,0,1,1)}this.show();this.open=true;MultiplayerManager.UpdateCallbacks.addOnce(this);gEngine.addScene(this)}ExtendPrototype(SceneProjectEditor,CCSceneAppUI);SceneProjectEditor.prototype.deleteLater=function(){if(this.webViewControllers){for(var i=0;i<this.webViewControllers.length;++i){var webViewController=this.webViewControllers[i];CCEngine.WebViewClose(webViewController)}delete this.webViewControllers}this.CCSceneAppUI_deleteLater()};SceneProjectEditor.prototype.setup=function(){this.camera.setCameraWidth(640,false);this.setupAppInfo(this.appInfo);if(CC.GetJSLocationBarData("SceneProjectUIManager")){var uiID=CC.GetJSLocationBarData("SceneProjectUIManager");this.editUI(uiID)}};SceneProjectEditor.prototype.syncUpdate=function(jsonData){if(jsonData.EditorProjectEdited!==undefined){AlertsManager.Hide("updating...");if(jsonData.appInfo){this.setupAppInfo(jsonData.appInfo,false)}if(jsonData.EditorProjectNewUI){if(!this.appInfo.uiScenes){this.appInfo.uiScenes=[]}var found=false;var ui=jsonData.EditorProjectNewUI;for(var i=0;i<this.appInfo.uiScenes.length;++i){if(ui.id===this.appInfo.uiScenes[i].id){found=true;break}}if(!found){this.appInfo.uiScenes.addOnce(jsonData.EditorProjectNewUI);this.setupAppInfo(this.appInfo,false)}this.editUI(jsonData.EditorProjectNewUI.id)}}else if(jsonData.EditorProjectImport!==undefined){AlertsManager.Hide("importing...");AlertsManager.Hide("forking...");if(jsonData.EditorProjectImport){if(typeof jsonData.EditorProjectImport==="object"){this.setupAppInfo(jsonData.EditorProjectImport)}else{this.setupAppInfo(this.appInfo)}}else{AlertsManager.TimeoutAlert("import failed :(",5)}}else if(jsonData.EditorProjectDeleted!==undefined){AlertsManager.Hide("deleting...");var deletedID=jsonData.EditorProjectDeleted;var appInfo=this.appInfo;if(deletedID&&deletedID===appInfo.id){this.close(true)}else{AlertsManager.TimeoutAlert("delete failed :(",5)}}else if(jsonData.AppsRequestInfo!==undefined){this.setupAppInfo(jsonData.AppsRequestInfo)}};SceneProjectEditor.prototype.setupAppInfo=function(appInfo,animate){if(animate===undefined){animate=true}CC.SetJSLocationBarData("SceneProjectEditor",appInfo.id);this.appInfo=appInfo;if(this.hidden){if(this.sceneProjectUIManager){this.sceneProjectUIManager.updateAppInfo(appInfo)}return}var self=this;var camera=this.camera;var i,js;var cameraX=camera.targetLookAt[0];var cameraY=camera.targetLookAt[1];var jsFiles=appInfo.jsFiles;if(this.webViewControllers){for(i=0;i<this.webViewControllers.length;++i){var webViewController=this.webViewControllers[i];if(!CCEngine.IsWebViewOpen(webViewController)){this.webViewControllers.remove(webViewController);--i;continue}if(jsFiles){var webView=webViewController.webView;for(var iJS=0;iJS<jsFiles.length;++iJS){js=jsFiles[iJS];webView.UpdatedFilename(js.fileID,js.filename)}}}}var objects=this.objects;for(i=0;i<this.objects.length;++i){objects[i].deleteLater()}this.objects.length=0;this.collideables.length=0;this.tiles.length=0;this.appInfoRows.length=0;var tile;{tile=new CCTile3DButton(this);tile.setupTile(camera.targetWidth);tile.setColour(gColour.set(.25,0));tile.setColourAlpha(.975,true);tile.setDrawOrder(99);this.tileBackground=tile;this.cameraStickyTiles.add(tile)}var LoadImageFunction=function(tile,textureSrc){return function(textureHandle){if(textureHandle){tile.setTileTexture(textureSrc);self.requestResize()}}};var textureSrc;var appInfoRows=this.appInfoRows;var row;{row=new RowOfTiles;appInfoRows.add(row);{tile=new CCTile3DButton(self);tile.setupText("Project ID:",1,false,true);this.addTile(tile);row.addTile(tile)}{tile=new CCTile3DButton(self);tile.setupText(appInfo.id,1,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.onRelease.push(function(){var url;if(window.DEBUG_IsLocalClient){url=SERVER_ROOT+"x/debug.html#id="+appInfo.id+"&online"}else{url=SERVER_ROOT+"x/#id="+appInfo.id+"&online"}CCEngine.WebViewOpen(url,null,null,{title:"game"})});this.addTile(tile);row.addColumn(tile)}}if(appInfo.name){row=new RowOfTiles;appInfoRows.add(row);{tile=new CCTile3DButton(self);tile.setupText("Name:",1,false,true);this.addTile(tile);row.addTile(tile)}{tile=new CCTile3DButton(self);tile.setupText(appInfo.name,1,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.onRelease.push(function(){AlertsManager.InputAlert(appInfo.name,function(result){if(result){if(appInfo.name!==result){if(MultiplayerManager.Emit("EditorProjectEditName",appInfo.id,result)){AlertsManager.ModalAlert("updating...");appInfo.name=result;self.setupAppInfo(appInfo,false)}}}},{space:true})});this.addTile(tile);row.addColumn(tile)}}var titleImage=appInfo.titleImage?appInfo.titleImage:SceneMultiManager.DefaultTitleImage;{row=new RowOfTiles;appInfoRows.add(row);{tile=new CCTile3DButton(self);tile.setupText("Title Image:",1,false,true);this.addTile(tile);row.addTile(tile)}{tile=new CCTile3DButton(self);tile.setupTile(1);gEngine.textureManager.getTextureHandle(titleImage,new LoadImageFunction(tile,titleImage));tile.onRelease.push(function(){self.editTitleImage()});this.addTile(tile);row.addColumn(tile)}}{row=new RowOfTiles;appInfoRows.add(row);{tile=new CCTile3DButton(self);tile.setupText("",1,false,true);row.addTile(tile)}}{row=new RowOfTiles;appInfoRows.add(row);{tile=new CCTile3DButton(self);tile.setupText(".js Start:",1,false,true);this.addTile(tile);row.addTile(tile)}{tile=new CCTile3DButton(self);if(appInfo.jsStart){tile.setupText(appInfo.jsStart,1,true,true)}else{tile.setupText("OverheadShooterTemplate",1,true,true)}tile.setTileTexture("editor_tile_background.jpg");tile.onRelease.push(function(){self.projectManager.onGameEditJSStart(appInfo)});this.addTile(tile);row.addColumn(tile)}}{row=new RowOfTiles;appInfoRows.add(row);{tile=new CCTile3DButton(self);tile.setupText(".js Sync:",1,false,true);this.addTile(tile);row.addTile(tile)}{var jsSyncName="On next start";if(appInfo.jsSync){jsSyncName="Runtime patching"}tile=new CCTile3DButton(self);tile.setupText(jsSyncName,1,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.onRelease.push(function(){if(MultiplayerManager.Emit("EditorProjectEditJSSync",appInfo.id,!appInfo.jsSync)){appInfo.jsSync=!appInfo.jsSync;AlertsManager.ModalAlert("updating...");self.setupAppInfo(appInfo,false)}});this.addTile(tile);row.addColumn(tile)}}{row=new RowOfTiles;appInfoRows.add(row);{tile=new CCTile3DButton(self);tile.setupText("Restart:",1,false,true);this.addTile(tile);row.addTile(tile)}{tile=new CCTile3DButton(self);tile.setupText("Soft",1,true,true);tile.setColour(EditorManager.Red);tile.setTileTexture("editor_tile_background.jpg");tile.onRelease.push(function(){self.projectManager.onGameRestart(appInfo,true)});this.addTile(tile);row.addColumn(tile)}{tile=new CCTile3DButton(self);tile.setupText("Hard",1,true,true);tile.setColour(EditorManager.Red);tile.setTileTexture("editor_tile_background.jpg");tile.onRelease.push(function(){self.projectManager.onGameRestart(appInfo,false)});this.addTile(tile);row.addColumn(tile)}}{row=new RowOfTiles;appInfoRows.add(row);{tile=new CCTile3DButton(self);tile.setupText("",1,false,true);row.addTile(tile)}}var uiScenes=appInfo.uiScenes;var uiInfo;var TextJSEditFunction=function(fileID){return function(){if(CCEngine.IsMobile()){AlertsManager.TimeoutAlert("Please visit playir.com to edit source code",10);return}var webViewController,i;if(self.webViewControllers){for(i=0;i<self.webViewControllers.length;++i){webViewController=self.webViewControllers[i];if(!CCEngine.IsWebViewOpen(webViewController)){self.webViewControllers.remove(webViewController);--i;continue}}}var controlKeyPressed=gEngine.controls.keys[91]||gEngine.controls.keys[17];var webViewControllerTarget=controlKeyPressed?1:0;var title="jseditor"+webViewControllerTarget;if(!self.webViewControllers){self.webViewControllers=[]}webViewController=CCEngine.GetWebView(title);if(webViewController){self.webViewControllers.addOnce(webViewController)}else{var url=SERVER_ROOT+"jseditor/tabs.php";webViewController=CCEngine.WebViewOpen(url,null,function(webViewController,url,open){if(open){var splitURL=url.split("#save");if(splitURL.length>1){if(MultiplayerManager.LoggedIn){if(webViewController){var webView=webViewController.webView;var fileID=webView.GetFileID();var data=webView.GetData();self.uploadJS(fileID,data);webView.SavedData(data)}}}}},{title:title});if(webViewController){self.webViewControllers.push(webViewController)}}var OnOpenFunction=function(webViewController,fileID,filename){return function(){if(self.webViewControllers.find(webViewController)!==-1){if(CCEngine.IsWebViewOpen(webViewController)){var webView=webViewController.webView;if(webView.editFile){webView.editFile(fileID,filename,SERVER_ASSETS_URL)}else{setTimeout(new OnOpenFunction(webViewController,fileID,filename),500)}}else{}}else{}}};for(i=0;i<jsFiles.length;++i){var js=jsFiles[i];if(fileID===js.fileID){var filename=js.filename;setTimeout(new OnOpenFunction(webViewController,fileID,filename),500);break}}}};var VisualJSEditFunction=function(fileID){return function(){for(var i=0;i<jsFiles.length;++i){var js=jsFiles[i];if(fileID===js.fileID){var filename=js.filename;self.projectManager.onVisualJSEditor(appInfo,filename);break}}}};{row=new RowOfTiles;appInfoRows.add(row);{tile=new CCTile3DButton(self);tile.setupText(".js Files:",1,false,true);this.addTile(tile);row.addTile(tile)}{tile=new CCTile3DButton(self);tile.setupText("New .js",1,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.onRelease.push(function(){AlertsManager.InputAlert("",function(result){if(result){result+=".js";if(MultiplayerManager.LoggedIn){self.uploadedJS(result,result,"")}}})});this.addTile(tile);row.addColumn(tile)}{tile=new CCTile3DButton(self);tile.setupText("Import .js",1,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.onRelease.push(function(){if(CCEngine.IsMobile()){AlertsManager.TimeoutAlert("Please visit playir.com to import",10);return}self.uploadingJS=true;AlertsManager.Alert("drop in .js file",function(){self.uploadingJS=false})});this.addTile(tile);row.addColumn(tile)}if(appInfo.jsFiles){var DeleteJSFunction=function(fileID){return function(){AlertsManager.ConfirmationAlert("Delete "+fileID+"?",function(result){if(result){self.deleteJSFile(appInfo,fileID)}})}};row=new RowOfTiles;appInfoRows.add(row);{tile=new CCTile3DButton(self);tile.setupText("",1,true,true);this.addTile(tile);row.addTile(tile)}var isUI,iUI;var fileID;for(i=0;i<jsFiles.length;++i){fileID=jsFiles[i].fileID;isUI=false;if(uiScenes){for(iUI=0;iUI<uiScenes.length;++iUI){if(uiScenes[iUI].id===fileID){isUI=true;break}}}if(isUI){continue}{tile=new CCTile3DButton(self);tile.setupText(" "+fileID,1,false,true);tile.setTileTexture("editor_tile_background.jpg");tile.onRelease.push(new TextJSEditFunction(fileID));this.addTile(tile);if(row.columnIndex<1){row.addColumn(tile)}else{row.addTile(tile)}}}for(i=0;i<jsFiles.length;++i){fileID=jsFiles[i].fileID;isUI=false;if(uiScenes){for(iUI=0;iUI<uiScenes.length;++iUI){if(uiScenes[iUI].id===fileID){isUI=true;break}}}if(isUI){continue}{tile=new CCTile3DButton(this);tile.textIcon=true;tile.setupTextured("editor_icon_js.jpg",function(){self.requestResize()});tile.onRelease.push(new VisualJSEditFunction(fileID));this.addTile(tile,0);if(row.columnIndex<2){row.addColumn(tile)}else{row.addTile(tile)}}}for(i=0;i<jsFiles.length;++i){fileID=jsFiles[i].fileID;isUI=false;if(uiScenes){for(iUI=0;iUI<uiScenes.length;++iUI){if(uiScenes[iUI].id===fileID){isUI=true;break}}}if(isUI){continue}tile=new CCTile3DButton(self);tile.setColour(EditorManager.Red);tile.textIcon=true;tile.setupTextured("editor_icon_delete.jpg",function(){self.requestResize()});tile.onRelease.push(new DeleteJSFunction(fileID));this.addTile(tile);if(row.columnIndex<3){row.addColumn(tile)}else{row.addTile(tile)}}}}{row=new RowOfTiles;appInfoRows.add(row);{tile=new CCTile3DButton(self);tile.setupText("",1,false,true);row.addTile(tile)}}{row=new RowOfTiles;appInfoRows.add(row);{tile=new CCTile3DButton(self);tile.setupText("UI Scenes:",1,false,true);this.addTile(tile);row.addTile(tile)}{tile=new CCTile3DButton(self);tile.setupText("New UI",1,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.onRelease.push(function(){self.newUI()});this.addTile(tile);row.addColumn(tile)}{tile=new CCTile3DButton(self);tile.setupText("Import UI",1,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.onRelease.push(function(){self.selectUI()});this.addTile(tile);row.addColumn(tile)}if(uiScenes){var EditUIFunction=function(id){return function(){self.editUI(id)}};var CloneUIFunction=function(uiID){return function(){self.cloneUI(uiID)}};var DeleteUIFunction=function(uiName,uiID){return function(){AlertsManager.ConfirmationAlert("Delete "+uiName+"?",function(result){if(result){self.deleteUI(appInfo,uiID)}})}};row=new RowOfTiles;appInfoRows.add(row);{tile=new CCTile3DButton(self);tile.setupText("",1,true,true);this.addTile(tile);row.addTile(tile)}for(i=0;i<uiScenes.length;++i){uiInfo=uiScenes[i];tile=new CCTile3DButton(self);tile.setupText(" "+uiInfo.name+" ("+uiInfo.id+")",1,false,true);tile.setTileTexture("editor_tile_background.jpg");tile.onRelease.push(new TextJSEditFunction(uiInfo.id));this.addTile(tile);if(i===0){row.addColumn(tile)}else{row.addTile(tile)}}for(i=0;i<uiScenes.length;++i){uiInfo=uiScenes[i];{tile=new CCTile3DButton(this);tile.textIcon=true;tile.setupTextured("editor_icon_hammer.jpg",function(){self.requestResize()});tile.onRelease.push(new EditUIFunction(uiInfo.id));this.addTile(tile,0);if(i===0){row.addColumn(tile)}else{row.addTile(tile)}}}for(i=0;i<uiScenes.length;++i){uiInfo=uiScenes[i];{tile=new CCTile3DButton(this);tile.textIcon=true;tile.setupTextured("editor_icon_js.jpg",function(){self.requestResize()});tile.onRelease.push(new VisualJSEditFunction(uiInfo.id));this.addTile(tile,0);if(i===0){row.addColumn(tile)}else{row.addTile(tile)}}}for(i=0;i<uiScenes.length;++i){uiInfo=uiScenes[i];{tile=new CCTile3DButton(this);tile.setupText("Clone",1,true,true);tile.setColour(EditorManager.LightGreen);tile.onRelease.push(new CloneUIFunction(uiInfo.id));this.addTile(tile,0);if(i===0){row.addColumn(tile)}else{row.addTile(tile)}}}for(i=0;i<uiScenes.length;++i){uiInfo=uiScenes[i];{tile=new CCTile3DButton(self);tile.setColour(EditorManager.Red);tile.textIcon=true;tile.setupTextured("editor_icon_delete.jpg",function(){self.requestResize()});tile.onRelease.push(new DeleteUIFunction(uiInfo.name,uiInfo.id));this.addTile(tile);if(i===0){row.addColumn(tile)}else{row.addTile(tile)}}}}}if(!appInfo.jsStart){{row=new RowOfTiles;appInfoRows.add(row);{tile=new CCTile3DButton(self);tile.setupText("Background:",1,false,true);this.addTile(tile);row.addTile(tile)}{tile=new CCTile3DButton(self);tile.setupTile(1);var backgroundImage=appInfo.backgroundImage?appInfo.backgroundImage:SceneBackground.BackgroundImage;if(backgroundImage){gEngine.textureManager.getTextureHandle(backgroundImage,new LoadImageFunction(tile,backgroundImage))}tile.onRelease.push(function(){self.editBackgroundImage()});this.addTile(tile);row.addColumn(tile)}}{row=new RowOfTiles;appInfoRows.add(row);{tile=new CCTile3DButton(self);tile.setupText("Players:",1,false,true);this.addTile(tile);row.addTile(tile)}var LoadModelFunction=function(tile,tex){return function(model3d){if(model3d){var modelObject=tile.modelObject;modelObject.setModel(model3d);modelObject.setColourAlpha(0);modelObject.setColourAlpha(1,true);if(tex){model3d.setTexture(tex)}tile.model3d=model3d;self.requestResize()}}};var EditPlayerModelFunction=function(playerTypeInfo){return function(){self.projectManager.onGameEditPlayerType(appInfo,playerTypeInfo)}};var EditPlayerIconFunction=function(playerTypeInfo){return function(){self.projectManager.onGameEditPlayerIcon(appInfo,playerTypeInfo)}};var DeletePlayerFunction=function(playerTypeID){return function(){if(MultiplayerManager.Emit("EditorProjectDeletePlayer",appInfo.id,playerTypeID)){AlertsManager.ModalAlert("updating...")}}};var playerTypes=appInfo.playerTypes?appInfo.playerTypes:SceneManagerGame.DefaultPlayerTypes;for(i=0;playerTypes&&i<playerTypes.length;++i){var playerTypeInfo=playerTypes[i];{tile=new CCTile3DButton(self);tile.setupText("Player: "+(i+1),1,true,true);tile.setTileTexture("editor_tile_background.jpg");row.addColumn(tile)}{tile=new CCTile3DButton(self);tile.setupTile(1);tile.setTileTexture("editor_tile_background.jpg");if(playerTypeInfo.icon){gEngine.textureManager.getTextureHandle(playerTypeInfo.icon,new LoadImageFunction(tile,playerTypeInfo.icon))}tile.onRelease.push(new EditPlayerIconFunction(playerTypeInfo));this.addTile(tile);row.addTile(tile)}{tile=new CCTile3DButton(self);tile.setupTile(1);{var modelObject=new CCObject;tile.addChild(modelObject);modelObject.setTransparent();tile.modelObject=modelObject}tile.onRelease.push(new EditPlayerModelFunction(playerTypeInfo));this.addTile(tile);row.addTile(tile);var obj=playerTypeInfo.obj;var tex=playerTypeInfo.tex;if(obj){CCModel3D.CacheModel(obj,true,new LoadModelFunction(tile,tex))}}if(playerTypes.length>2){tile=new CCTile3DButton(self);tile.setupText("Delete",1,true,true);tile.setColour(EditorManager.Red);tile.setTileTexture("editor_tile_background.jpg");tile.onRelease.push(new DeletePlayerFunction(playerTypeInfo.type));this.addTile(tile);row.addTile(tile)}}{tile=new CCTile3DButton(self);tile.setupText("Add Player",1,true,true);tile.setColour(EditorManager.LightGreen);tile.setTileTexture("editor_tile_background.jpg");tile.onRelease.push(function(){if(MultiplayerManager.Emit("EditorProjectAddPlayer",appInfo.id)){AlertsManager.ModalAlert("updating...")}});this.addTile(tile);row.addColumn(tile)}}}{row=new RowOfTiles;appInfoRows.add(row);{tile=new CCTile3DButton(self);tile.setupText("",1,false,true);row.addTile(tile)}}{row=new RowOfTiles;appInfoRows.add(row);{tile=new CCTile3DButton(self);tile.setupText("Publish:",1,false,true);this.addTile(tile);row.addTile(tile)}{tile=new CCTile3DButton(self);if(appInfo.open){tile.setupText("Published",1,true,true);tile.setColour(EditorManager.LightGreen)}else{tile.setupText("Unpublished",1,true,true);tile.setColour(EditorManager.Red)}tile.setTileTexture("editor_tile_background.jpg");tile.onRelease.push(function(){AlertsManager.ConfirmationAlert(!appInfo.open?"Publish?":"Unpublish?",function(result){if(result){if(MultiplayerManager.Emit("EditorProjectPublish",appInfo.id,!appInfo.open)){appInfo.open=!appInfo.open;AlertsManager.ModalAlert("updating...");self.setupAppInfo(appInfo,false)}}})});this.addTile(tile);row.addColumn(tile)}}if(window.JSZip){row=new RowOfTiles;appInfoRows.add(row);{tile=new CCTile3DButton(self);tile.setupText("",1,true,true);this.addTile(tile);row.addTile(tile)}if(window.JSZip){tile=new CCTile3DButton(self);tile.setupText("Export .zip",1,true,true);tile.setColour(EditorManager.LightGreen);tile.setTileTexture("editor_tile_background.jpg");tile.onRelease.push(function(){if(CCEngine.IsMobile()){AlertsManager.TimeoutAlert("Please visit playir.com to export",10);return}self.exportProject(appInfo)});this.addTile(tile);row.addColumn(tile)}if(window.JSZip){tile=new CCTile3DButton(self);tile.setupText("Import .zip",1,true,true);tile.setColour(EditorManager.Red);tile.setTileTexture("editor_tile_background.jpg");tile.onRelease.push(function(){if(CCEngine.IsMobile()){AlertsManager.TimeoutAlert("Please visit playir.com to import",10);return}self.uploadingImport=true;AlertsManager.Alert("drop in appInfo.json or .zip package\n\nwarning: this will overwrite your current project",function(){self.uploadingImport=false})});this.addTile(tile);row.addColumn(tile)}}{row=new RowOfTiles;appInfoRows.add(row);{tile=new CCTile3DButton(self);tile.setupText("",1,true,true);this.addTile(tile);row.addTile(tile)}{tile=new CCTile3DButton(self);tile.setupText("Clone project",1,true,true);tile.setColour(EditorManager.LightGreen);tile.setTileTexture("editor_tile_background.jpg");tile.onRelease.push(function(){self.forkProject(appInfo)});this.addTile(tile);row.addColumn(tile)}{tile=new CCTile3DButton(self);tile.setupText("Import project",1,true,true);tile.setColour(EditorManager.Red);tile.setTileTexture("editor_tile_background.jpg");tile.onRelease.push(function(){self.importProject(appInfo)});this.addTile(tile);row.addColumn(tile)}}{row=new RowOfTiles;appInfoRows.add(row);var iOSID=appInfo.IOS_APP_ID?appInfo.IOS_APP_ID:"";{tile=new CCTile3DButton(self);tile.setupText("iOS App ID:",1,false,true);this.addTile(tile);row.addTile(tile)}{tile=new CCTile3DButton(self);tile.setupText(iOSID,1,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.onRelease.push(function(){var result=CC.WindowPrompt("iOS App ID",iOSID);if(result!==null&&result!==iOSID){if(result.length<1024){if(MultiplayerManager.Emit("EditorProjectiOSAppID",appInfo.id,result)){appInfo.IOS_APP_ID=result;AlertsManager.ModalAlert("updating...");self.setupAppInfo(appInfo,false)}}}});this.addTile(tile);row.addColumn(tile)}}{row=new RowOfTiles;appInfoRows.add(row);var androidID=appInfo.ANDROID_APP_ID?appInfo.ANDROID_APP_ID:"";{tile=new CCTile3DButton(self);tile.setupText("Android App ID:",1,false,true);this.addTile(tile);row.addTile(tile)}{tile=new CCTile3DButton(self);tile.setupText(androidID,1,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.onRelease.push(function(){var result=CC.WindowPrompt("Android ID",androidID);if(result!==null&&result!==androidID){if(result.length<1024){if(MultiplayerManager.Emit("EditorProjectAndroidAppID",appInfo.id,result)){appInfo.ANDROID_APP_ID=result;AlertsManager.ModalAlert("updating...");self.setupAppInfo(appInfo,false)}}}});this.addTile(tile);row.addColumn(tile)}}{row=new RowOfTiles;appInfoRows.add(row);var purchaseID=appInfo.PURCHASE_ID?appInfo.PURCHASE_ID:"";{tile=new CCTile3DButton(self);tile.setupText("In-App Purchase ID:",1,false,true);this.addTile(tile);row.addTile(tile)}{tile=new CCTile3DButton(self);tile.setupText(purchaseID,1,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.onRelease.push(function(){var result=CC.WindowPrompt("Default In-App Purchase ID",purchaseID);if(result!==null&&result!==purchaseID){if(result.length<1024){if(MultiplayerManager.Emit("EditorProjectInAppPurchaseID",appInfo.id,result)){appInfo.PURCHASE_ID=result;AlertsManager.ModalAlert("updating...");self.setupAppInfo(appInfo,false)}}}});this.addTile(tile);row.addColumn(tile)}}{row=new RowOfTiles;appInfoRows.add(row);{tile=new CCTile3DButton(self);tile.setupText("Owners:",1,false,true);this.addTile(tile);row.addTile(tile)}{tile=new CCTile3DButton(self);tile.setupText("Add Owner",1,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.onRelease.push(function(){AlertsManager.InputAlert(MultiplayerManager.UserID,function(result){if(result){if(MultiplayerManager.Emit("EditorProjectAddOwner",appID,result)){AlertsManager.ModalAlert("updating...")}}},{dot:true})});this.addTile(tile);row.addColumn(tile)}var ownerID;if(appInfo.owners){for(i=0;i<appInfo.owners.length;++i){ownerID=appInfo.owners[i];tile=new CCTile3DButton(self);tile.setupText(ownerID,1,true,true);tile.setTileTexture("editor_tile_background.jpg");this.addTile(tile);row.addTile(tile)}}{tile=new CCTile3DButton(self);tile.textIcon=true;tile.setupTextured("editor_icon_delete.jpg",function(){self.requestResize()});tile.shouldRender=false;this.addTile(tile);row.addColumn(tile)}if(appInfo.owners){var DeleteOwnerFunction=function(ownerID){return function(){self.deleteOwner(appInfo,ownerID)}};for(i=0;i<appInfo.owners.length;++i){ownerID=appInfo.owners[i];{tile=new CCTile3DButton(self);tile.setColour(EditorManager.Red);tile.textIcon=true;tile.setupTextured("editor_icon_delete.jpg",function(){self.requestResize()});tile.onRelease.push(new DeleteOwnerFunction(ownerID));this.addTile(tile);row.addTile(tile);if(MultiplayerManager.IsOwner([ownerID])){tile.shouldRender=false}}}}}{row=new RowOfTiles;appInfoRows.add(row);{tile=new CCTile3DButton(self);tile.setupText("",1,false,true);row.addTile(tile)}}{row=new RowOfTiles;appInfoRows.add(row);{tile=new CCTile3DButton(self);tile.setupText("",1,false,true);row.addTile(tile)}{tile=new CCTile3DButton(self);tile.setupText("Delete project",1,true,true);tile.setColour(EditorManager.Red);tile.onRelease.push(function(){AlertsManager.ConfirmationAlert("Delete?",function(result){if(result){if(MultiplayerManager.Emit("EditorProjectDelete",self.appInfo.id)){self.deletingProject=true;
AlertsManager.ModalAlert("deleting...")}}})});this.addTile(tile);row.addColumn(tile)}}for(var rowIndex=0;rowIndex<appInfoRows.length;++rowIndex){row=appInfoRows[rowIndex];for(var columnIndex=0;columnIndex<row.columns.length;++columnIndex){var column=row.columns[columnIndex];for(var tileIndex=0;tileIndex<column.tiles.length;++tileIndex){tile=column.tiles[tileIndex];tile.setColourAlpha(0);if(columnIndex>0){if(tile.modelObject){}else{tile.setColourAlpha(1,animate)}}if(tile.textObject){if(columnIndex>0){tile.setColourAlpha(.5,animate)}tile.setTextColour(gColour.set(1,0));tile.setTextColourAlpha(1,animate)}tile.setDrawOrder(205)}}}this.requestResize();this.refreshCameraView();this.lockCameraView();camera.setLookAt([camera.targetLookAt[0],camera.targetHeight,0],false);this.lockCameraView();if(!animate){camera.targetLookAt[0]=cameraX;camera.targetLookAt[1]=cameraY;camera.setLookAt(camera.targetLookAt);this.tileBackground.setColourAlpha(1)}};SceneProjectEditor.prototype.resize=function(){if(!this.enabled||this.deletingScene){return}this.CCSceneAppUI_resize();var camera=this.camera;{this.tileBackground.setTileSize(camera.targetWidth,camera.targetHeight)}var resize3DModel=function(tile){var model3d=tile.model3d;{var size=tile.collisionSize.height<tile.collisionSize.width?tile.collisionSize.height:tile.collisionSize.width;size*=.75;var scaleFactor;var modelWidth=model3d.getWidth()>model3d.getDepth()?model3d.getWidth():model3d.getDepth();var modelHeight=model3d.getHeight();if(modelWidth>modelHeight){scaleFactor=size/modelWidth}else{scaleFactor=size/modelHeight}model3d.setScale(scaleFactor)}};var textHeight=camera.targetHeight*.05;var valueFieldSize=textHeight*1.2;var imageHeight=camera.targetHeight*.3;var modelSize=imageHeight;var minTextWidth=camera.targetWidth*.1;var tile;var row,column,rowIndex,columnIndex,tileIndex;var appInfoRows=this.appInfoRows;var firstColumnWidth=0;for(rowIndex=0;rowIndex<appInfoRows.length;++rowIndex){row=appInfoRows[rowIndex];for(columnIndex=0;columnIndex<row.columns.length;++columnIndex){column=row.columns[columnIndex];var columnMaxWidth=100;for(tileIndex=0;tileIndex<column.tiles.length;++tileIndex){tile=column.tiles[tileIndex];if(tile.textObject){tile.setTextHeight(textHeight,true);tile.setTileSize(tile.collisionSize.width*1.1,valueFieldSize);if(tile.collisionSize.width>columnMaxWidth){columnMaxWidth=tile.collisionSize.width}}else if(tile.textIcon){tile.setTileSize(valueFieldSize)}else if(tile.modelObject){tile.setTileSize(modelSize)}else if(tile.getTileTextureImage()){tile.setTileTexturedHeight(imageHeight)}if(columnIndex===0){if(tile.collisionBounds[0]>firstColumnWidth){firstColumnWidth=tile.collisionBounds[0]}}else if(tile.textIcon){}else{if(tile.collisionSize.width<minTextWidth){tile.setTileSize(minTextWidth,tile.collisionSize.height)}if(tile.model3d){resize3DModel(tile)}}}for(tileIndex=0;tileIndex<column.tiles.length;++tileIndex){tile=column.tiles[tileIndex];if(tile.textObject){tile.setTileSize(columnMaxWidth,valueFieldSize)}}}}var y=0;for(rowIndex=0;rowIndex<appInfoRows.length;++rowIndex){var maxRowWidths=[0];var maxRowHeights=[0];row=appInfoRows[rowIndex];for(columnIndex=0;columnIndex<row.columns.length;++columnIndex){column=row.columns[columnIndex];for(tileIndex=0;tileIndex<column.tiles.length;++tileIndex){tile=column.tiles[tileIndex];if(columnIndex>=maxRowWidths.length){maxRowWidths.add(0)}if(tile.collisionBounds[0]>maxRowWidths[columnIndex]){maxRowWidths[columnIndex]=tile.collisionBounds[0]}if(tileIndex>=maxRowHeights.length){maxRowHeights.add(0)}if(tile.collisionBounds[1]>maxRowHeights[tileIndex]){maxRowHeights[tileIndex]=tile.collisionBounds[1]}}}var x=firstColumnWidth;for(columnIndex=1;columnIndex<row.columns.length;++columnIndex){x+=maxRowWidths[columnIndex];column=row.columns[columnIndex];for(tileIndex=0;tileIndex<column.tiles.length;++tileIndex){tile=column.tiles[tileIndex];tile.setPositionX(x)}x+=maxRowWidths[columnIndex]}for(var subRowIndex=0;subRowIndex<maxRowHeights.length;++subRowIndex){y-=maxRowHeights[subRowIndex];for(columnIndex=0;columnIndex<row.columns.length;++columnIndex){column=row.columns[columnIndex];tileIndex=subRowIndex;if(tileIndex<column.tiles.length){tile=column.tiles[tileIndex];if(tileIndex===0){tile.setPositionY(y)}else{tile.positionTileBelow(column.tiles[tileIndex-1])}}}}for(var i=0;i<maxRowHeights.length;++i){y-=maxRowHeights[i]}}};SceneProjectEditor.prototype.updateControls=function(controls){var usingControls=this.CCSceneAppUI_updateControls(controls);var cameraTouches=this.camera.cameraTouches;var touch=cameraTouches[0];if(touch.x>0&&touch.x<1&&touch.y>0&&touch.y<1&&touch.startX>0&&touch.startX<1&&touch.startY>0&&touch.startY<1){if(controls.wheel&&controls.wheel.delta!==0){var delta=controls.wheel.delta;this.cameraScrolling=true;this.controlsMovingVertical=true;this.touchCameraMoving(0,delta*.1);return true}}return usingControls};SceneProjectEditor.prototype.touchPressed=function(touch){this.CCSceneAppUI_touchPressed(touch);return this.open};SceneProjectEditor.prototype.refreshCameraView=function(){var left=CC_MAXFLOAT;var right=-CC_MAXFLOAT;var top=-CC_MAXFLOAT;var bottom=CC_MAXFLOAT;var tiles=this.tiles;for(var i=0;i<tiles.length;++i){var tile=tiles[i];var leftX=tile.getTileMovementTarget()[0]-tile.collisionBounds[0];var rightX=tile.getTileMovementTarget()[0]+tile.collisionBounds[0];var topY=tile.getTileMovementTarget()[1]+tile.collisionBounds[1];var bottomY=tile.getTileMovementTarget()[1]-tile.collisionBounds[1];if(leftX<left){left=leftX}if(rightX>right){right=rightX}if(topY>top){top=topY}if(bottomY<bottom){bottom=bottomY}}var camera=this.camera;this.sceneLeft=left+camera.targetWidth*.4;this.sceneRight=right;this.sceneTop=top-camera.targetHeight*.4;this.sceneBottom=bottom;if(this.sceneBottom>this.sceneTop){this.sceneBottom=this.sceneTop}};SceneProjectEditor.prototype.lockCameraView=function(){if(this.cameraScrolling){return}var camera=this.camera;if(camera.targetLookAt[0]<this.sceneLeft){camera.targetLookAt[0]=this.sceneLeft;camera.flagUpdate()}if(camera.targetLookAt[0]>this.sceneRight){camera.targetLookAt[0]=this.sceneRight;camera.flagUpdate()}if(camera.targetLookAt[1]>this.sceneTop){camera.targetLookAt[1]=this.sceneTop;camera.flagUpdate()}if(camera.targetLookAt[1]<this.sceneBottom){camera.targetLookAt[1]=this.sceneBottom;camera.flagUpdate()}};SceneProjectEditor.prototype.hide=function(){this.hidden=true;var tiles=this.tiles;for(var i=0;i<tiles.length;++i){var tile=tiles[i];tile.setColourAlpha(0,true);tile.setTextColourAlpha(0,true)}var self=this;this.tileBackground.setColourAlpha(0,true,function(){self.enabled=false;self.camera.enabled=false});if(this.sceneUIBack){this.sceneUIBack.close()}if(this.onDragDropFunction){gEngine.controls.onDragDrop.remove(this.onDragDropFunction);delete this.onDragDropFunction}if(this.onDragDropLoadFunction){gEngine.controls.onDragDropLoad.remove(this.onDragDropLoadFunction);delete this.onDragDropLoadFunction}};SceneProjectEditor.prototype.show=function(){this.hidden=false;var self=this;if(!this.sceneUIBack){this.sceneUIBack=new SceneUIBack(this,function(){self.close()},true)}if(!this.onDragDropFunction){this.onDragDropFunction=function(files,event){self.onDragDrop(files,event)};gEngine.controls.onDragDrop.add(this.onDragDropFunction)}if(!this.onDragDropLoadFunction){this.onDragDropLoadFunction=function(file,event){self.onDragDropLoad(file,event)};gEngine.controls.onDragDropLoad.add(this.onDragDropLoadFunction)}this.enabled=true;this.camera.enabled=true;if(this.open){var cameraX=this.camera.targetLookAt[0];var cameraY=this.camera.targetLookAt[1];this.setupAppInfo(this.appInfo);this.camera.targetLookAt[0]=cameraX;this.camera.targetLookAt[1]=cameraY;this.camera.setLookAt(this.camera.targetLookAt)}};SceneProjectEditor.prototype.close=function(openProjectsList){if(this.deletingProject){AlertsManager.Hide("deleting...")}CC.RemoveJSLocationBarData("SceneProjectEditor");if(openProjectsList===undefined){openProjectsList=true}this.open=false;this.hide();var camera=this.camera;camera.flagUpdate();camera.targetLookAt[1]=camera.targetHeight;if(this.parentScene){this.parentScene.deletingChild(this)}var self=this;this.tileBackground.setColourAlpha(0,true,function(){self.deleteLater()});if(openProjectsList){this.projectManager.openProjectsList()}};SceneProjectEditor.prototype.onDragDrop=function(files,event){AlertsManager.ModalAlert("loading...")};SceneProjectEditor.prototype.onDragDropLoad=function(file,event){AlertsManager.Hide("loading...");if(event&&event.target&&event.target.result){if(MultiplayerManager.LoggedIn){var data=event.target.result;this.prepareUpload(file,data)}}};SceneProjectEditor.prototype.prepareUpload=function(file,data){var filename=file.name;filename=filename.toLowerCase();var fileExtension=filename.getExtension();if(this.projectManager.sceneUI.sceneAssetEditor){}else if(this.uploadingImport){this.uploadingImport=false;AlertsManager.Hide("drop in appInfo.json or .zip package\n\nwarning: this will overwrite your current project");if(fileExtension==="zip"){this.importZip(data)}else if(filename==="appinfo.json"||filename==="gameinfo.json"){this.importAppInfoJSON(data)}else{AlertsManager.TimeoutAlert("only .json or .zip files supported",2)}}else if(fileExtension==="zip"){this.importZip(data)}else if(filename==="appinfo.json"||filename==="gameinfo.json"){this.importAppInfoJSON(data)}else if(fileExtension==="js"||this.uploadingJS){if(this.uploadingJS){this.uploadingJS=false;AlertsManager.Hide("drop in .js file");if(fileExtension!=="js"){AlertsManager.TimeoutAlert("only .js supported",2);return}}if(file.size>1024*1024){AlertsManager.TimeoutAlert("file size too large",2)}else{this.uploadJS(filename,data)}}else if(fileExtension==="bmp"||fileExtension==="jpeg"||fileExtension==="jpg"||fileExtension==="png"){this.editTitleImage()}};SceneProjectEditor.prototype.uploadJS=function(fileID,data){var self=this;EditorManager.EditorUploadJS(fileID,data,function(fileID,filename){var uploaded=false;if(filename){if(MultiplayerManager.LoggedIn){uploaded=self.uploadedJS(fileID,filename,data)}}if(!uploaded){AlertsManager.TimeoutAlert("failed to upload "+fileID+" :(",2)}})};SceneProjectEditor.prototype.uploadedJS=function(fileID,filename,data){var fileExtension=filename.getExtension();if(fileExtension==="js"){var i;var jsFiles=this.appInfo.jsFiles;if(jsFiles){for(i=0;i<jsFiles.length;++i){var js=jsFiles[i];if(js.fileID===fileID){if(js.filename===filename){return true}}}}if(this.webViewControllers){for(i=0;i<this.webViewControllers.length;++i){var webViewController=this.webViewControllers[i];if(!CCEngine.IsWebViewOpen(webViewController)){this.webViewControllers.remove(webViewController);--i;continue}var webView=webViewController.webView;webView.UpdatedFilenameForData(fileID,filename,data)}}var uiScenes=this.appInfo.uiScenes;if(uiScenes){for(i=0;i<uiScenes.length;++i){var uiInfo=uiScenes[i];if(uiInfo.id===fileID){this.editUIFile(fileID,filename);return true}}}this.addJSFile(this.appInfo,fileID,filename);return true}else{AlertsManager.TimeoutAlert("failed to upload "+fileID+" :(",2)}return false};SceneProjectEditor.prototype.editTitleImage=function(){this.hide();var self=this;var appInfo=this.appInfo;var sceneAssetEditor=null;if(SceneAssetEditor.self){sceneAssetEditor=SceneAssetEditor.self}else{sceneAssetEditor=new SceneAssetEditor(this,false,true);sceneAssetEditor.open("Edit Title Image");sceneAssetEditor.setAsset(appInfo.titleImage)}sceneAssetEditor.onClose=function(tex){self.show();if(tex){if(appInfo.titleImage!==tex){if(MultiplayerManager.Emit("EditorProjectEditTitleImage",appInfo.id,tex)){appInfo.titleImage=tex;AlertsManager.ModalAlert("updating...");self.setupAppInfo(appInfo,false)}}}}};SceneProjectEditor.prototype.editBackgroundImage=function(){this.hide();var self=this;var appInfo=this.appInfo;var sceneAssetEditor=null;if(SceneAssetEditor.self){sceneAssetEditor=SceneAssetEditor.self}else{sceneAssetEditor=new SceneAssetEditor(this,false,true);sceneAssetEditor.open("Edit Background Image");sceneAssetEditor.setAsset(appInfo.titleImage)}sceneAssetEditor.onClose=function(tex){self.show();if(tex){if(appInfo.backgroundImage!==tex){if(MultiplayerManager.Emit("EditorProjectEditBackgroundImage",appInfo.id,tex)){appInfo.backgroundImage=tex;AlertsManager.ModalAlert("updating...");self.setupAppInfo(appInfo,false)}}}}};SceneProjectEditor.prototype.addJSFile=function(appInfo,fileID,filename){if(MultiplayerManager.LoggedIn){if(!appInfo.jsFiles){appInfo.jsFiles=[]}var found=false;var jsFiles=appInfo.jsFiles;for(var i=0;i<jsFiles.length;++i){var itr=jsFiles[i];if(itr.fileID===fileID){if(itr.filename===filename){found=true}else{itr.filename=filename}break}}if(!found){if(MultiplayerManager.Emit("EditorProjectAddJSFile",appInfo.id,fileID,filename)){AlertsManager.ModalAlert("updating...");this.setupAppInfo(appInfo,false)}}}};SceneProjectEditor.prototype.deleteJSFile=function(appInfo,fileID){if(MultiplayerManager.LoggedIn){if(appInfo.jsFiles){var jsFiles=appInfo.jsFiles;for(var i=0;i<jsFiles.length;++i){var js=jsFiles[i];if(js.fileID===fileID){if(MultiplayerManager.Emit("EditorProjectRemoveJSFile",appInfo.id,fileID)){AlertsManager.ModalAlert("updating...");jsFiles.remove(js);if(jsFiles.length===0){delete appInfo.jsFiles}this.setupAppInfo(appInfo,false)}break}}}}};SceneProjectEditor.prototype.newUI=function(){AlertsManager.ModalAlert("updating...");MultiplayerManager.Emit("EditorProjectNewUI",this.appInfo.id)};SceneProjectEditor.prototype.editUI=function(uiID){this.currentLookAt=this.camera.targetLookAt[0];this.camera.targetLookAt[0]+=this.camera.targetWidth;this.camera.flagUpdate();this.hide();var self=this;var uiScenes=this.appInfo.uiScenes;if(uiScenes){for(var i=0;i<uiScenes.length;++i){var ui=uiScenes[i];if(ui.id===uiID){this.sceneProjectUIManager=new SceneProjectUIManager(this.appInfo.id,ui,function(){delete self.sceneProjectUIManager;self.show();self.camera.targetLookAt[0]=self.currentLookAt;self.camera.flagUpdate();delete self.currentLookAt});break}}}};SceneProjectEditor.prototype.editUIFile=function(uiID,filename){if(MultiplayerManager.LoggedIn){var uiScenes=this.appInfo.uiScenes;for(var i=0;i<uiScenes.length;++i){var ui=uiScenes[i];if(ui.id===uiID){MultiplayerManager.Emit("EditorProjectEditUI",this.appInfo.id,uiID,filename);break}}}};SceneProjectEditor.prototype.selectUI=function(){this.hide();var self=this;new SceneTemplateUIManager(null,function(uiManager,info){self.importUI(info.id);return true},function(){self.show()},this.appInfo.uiScenes)};SceneProjectEditor.prototype.importUI=function(uiID){var i;var appInfo=this.appInfo;var uiScenes=appInfo.uiScenes;if(uiScenes){for(i=0;i<uiScenes.length;++i){var ui=uiScenes[i];if(ui.parentID===uiID){return true}}}if(!appInfo.uiScenes){uiScenes=appInfo.uiScenes=[]}if(MultiplayerManager.Emit("EditorProjectImportUI",appInfo.id,uiID)){AlertsManager.ModalAlert("updating...")}};SceneProjectEditor.prototype.cloneUI=function(uiID){var i;var appInfo=this.appInfo;var uiScenes=appInfo.uiScenes;if(uiScenes){for(i=0;i<uiScenes.length;++i){var ui=uiScenes[i];if(ui.id===uiID){if(MultiplayerManager.Emit("EditorProjectCloneUI",appInfo.id,uiID)){AlertsManager.ModalAlert("updating...")}break}}}};SceneProjectEditor.prototype.deleteUI=function(appInfo,uiID){if(MultiplayerManager.LoggedIn){if(appInfo.uiScenes){var uiScenes=appInfo.uiScenes;for(var i=0;i<uiScenes.length;++i){var itr=uiScenes[i];if(itr.id===uiID){uiScenes.remove(itr);if(uiScenes.length===0){delete appInfo.uiScenes}if(MultiplayerManager.Emit("EditorProjectDeleteUI",appInfo.id,uiID)){AlertsManager.ModalAlert("updating...")}break}}}this.setupAppInfo(appInfo,false)}};SceneProjectEditor.prototype.deleteOwner=function(appInfo,ownerID){if(MultiplayerManager.LoggedIn){if(appInfo.owners&&appInfo.owners.length>1){var owners=appInfo.owners;for(var i=0;i<owners.length;++i){var owner=owners[i];if(owner!==MultiplayerManager.UserID){if(MultiplayerManager.Emit("EditorProjectRemoveOwner",appInfo.id,ownerID)){owners.remove(owner);AlertsManager.ModalAlert("updating...");this.setupAppInfo(appInfo,false)}break}}}}};SceneProjectEditor.prototype.importAppInfoJSON=function(jsonString){if(jsonString){var json=JSON.parse(jsonString);if(json){if(MultiplayerManager.Emit("EditorProjectImportZip",this.appInfo.id,json,SERVER_ASSETS_URL)){AlertsManager.ModalAlert("importing...")}}}};SceneProjectEditor.prototype.importZip=function(zipBuffer){if(window.JSZip){AlertsManager.ModalAlert("importing...",2);var appInfoString;var file,i;var assetFiles=[];var jsFiles=[];try{var zip=new JSZip(new Uint8Array(zipBuffer));if(zip&&zip.files){var fileNames=Object.keys(zip.files);for(i=0;i<fileNames.length;++i){var zipFile=zip.files[fileNames[i]];if(zipFile.name==="appinfo.json"||zipFile.name==="gameinfo.json"){appInfoString=zipFile.asText();continue}file={};file.name=zipFile.name;var extension=zipFile.name.getExtension();if(extension==="js"){file.data=zipFile.asText();jsFiles.push(file)}else{file.data=zipFile.asArrayBuffer();assetFiles.push(file)}}}}catch(e){}if(!appInfoString){AlertsManager.Hide("importing...");AlertsManager.TimeoutAlert("error importing appinfo.json",5);return}if(assetFiles.length>0){var self=this;var filesUploaded=[];var UploadedFunction=function(uploadFilename,newFilename){if(newFilename){AlertsManager.Notification("editor"+filesUploaded.length,"importing "+uploadFilename,null,2);filesUploaded.push(newFilename);if(uploadFilename!==newFilename){appInfoString=self.patchAppInfoFile(appInfoString,uploadFilename,newFilename);self.patchJSFiles(jsFiles,uploadFilename,newFilename)}if(filesUploaded.length===assetFiles.length){self.importJSFiles(appInfoString,jsFiles)}}else{AlertsManager.Hide("importing...");AlertsManager.TimeoutAlert("error importing "+uploadFilename,5)}};for(i=0;i<assetFiles.length;++i){file=assetFiles[i];EditorManager.EditorUploadFile(file.name,file.data,UploadedFunction,false)}}else{this.importJSFiles(appInfoString,jsFiles)}}};SceneProjectEditor.prototype.importJSFiles=function(appInfoString,jsFiles){if(jsFiles.length>0){var self=this;var filesUploaded=[];var UploadedFunction=function(uploadFilename,newFilename){if(newFilename){filesUploaded.push(newFilename);if(uploadFilename!==newFilename){appInfoString=self.patchAppInfoFile(appInfoString,uploadFilename,newFilename)}if(filesUploaded.length===jsFiles.length){AlertsManager.Hide("importing...");self.importAppInfoJSON(appInfoString)}}else{AlertsManager.Hide("importing...");AlertsManager.TimeoutAlert("error importing "+uploadFilename,5)}};for(i=0;i<jsFiles.length;++i){file=jsFiles[i];EditorManager.EditorUploadFile(file.name,file.data,UploadedFunction,false)}}else{AlertsManager.Hide("importing...");this.importAppInfoJSON(appInfoString)}};SceneProjectEditor.prototype.patchAppInfoFile=function(appInfoString,oldFilename,newFilename){appInfoString=String.ReplaceChar(appInfoString,'"'+oldFilename+'"','"'+newFilename+'"');appInfoString=String.ReplaceChar(appInfoString,"'"+oldFilename+"'","'"+newFilename+"'");return appInfoString};SceneProjectEditor.prototype.patchJSFiles=function(jsFiles,oldFilename,newFilename){for(var i=0;i<jsFiles.length;++i){var file=jsFiles[i];file.data=String.ReplaceChar(file.data,'"'+oldFilename+'"','"'+newFilename+'"');file.data=String.ReplaceChar(file.data,"'"+oldFilename+"'","'"+newFilename+"'")}};SceneProjectEditor.prototype.forkProject=function(appInfo){if(MultiplayerManager.Emit("EditorProjectFork",this.appInfo.id)){AlertsManager.ModalAlert("forking...")}};SceneProjectEditor.prototype.importProject=function(){if(!this.sceneProjectsList){this.hide();var self=this;this.sceneProjectsList=new SceneProjectsList(this,function(appInfo){self.sceneProjectsList=null;self.show();if(self.appInfo.id!==appInfo.id){AlertsManager.ConfirmationAlert("warning: this will overwrite your current project",function(result){if(result){if(MultiplayerManager.Emit("EditorProjectImportProject",self.appInfo.id,appInfo.id)){AlertsManager.ModalAlert("importing...")}}})}},null,function(){self.sceneProjectsList=null;self.show()})}};SceneProjectEditor.prototype.exportProject=function(appInfo){AlertsManager.ModalAlert("exporting...");var numberOfFileRequests=0;var files=[];var self=this;var finishedRequests=false;var DownloadedFunction=function(filename){return function(status,data){if(status>=CCURLRequest.Succeeded&&data&&data.length>0){var file={};file.name=filename;file.data=data;files.push(file);if(finishedRequests&&files.length===numberOfFileRequests){self.BuildExportAssets(appInfo,files)}}else{AlertsManager.Hide("exporting...");AlertsManager.TimeoutAlert("error exporting "+filename,5)}}};if(appInfo.titleImage){if(!appInfo.jsFiles||appInfo.jsFiles.length===0){finishedRequests=true}numberOfFileRequests++;gURLManager.requestURL(MultiplayerManager.GetAssetURL(appInfo.titleImage),null,new DownloadedFunction(appInfo.titleImage),0,null,-1,0,true)}if(appInfo.jsFiles){var jsFiles=appInfo.jsFiles;for(var i=0;i<jsFiles.length;++i){if(i===jsFiles.length-1){finishedRequests=true}var js=jsFiles[i];if(js.filename){numberOfFileRequests++;gURLManager.requestURL(MultiplayerManager.GetAssetURL(js.filename),null,new DownloadedFunction(js.filename),0,js.filename,-1,0)}}}};SceneProjectEditor.prototype.BuildExportAssets=function(appInfo,files){var i;var assetFiles=[];var assetIDs=[];for(i=0;i<files.length;++i){var file=files[i];var extension=file.name.getExtension();if(extension==="js"){JSManager.ParseJSForAssets(file.data,assetFiles,assetIDs)}}appInfo.assetIDs=assetIDs;if(assetIDs.length>0){var self=this;appInfo.dbInfos=[];var requestingDownloads=true;var numberOfDownloads=0;var DownloadedFunction=function(id){return function(info){if(info){var i;numberOfDownloads++;if(window.DEBUG_IsLocalClient){console.log(numberOfDownloads,id)}AlertsManager.Notification("editor"+numberOfDownloads,"exporting "+id,null,1);appInfo.dbInfos.addOnce(info);if(info.mp3){assetFiles.addOnce(info.mp3)}if(info.actions){for(i=0;i<info.actions.length;++i){var action=info.actions[i];if(action.modelID){if(assetIDs.addOnce(action.modelID)){DBAssets.LoadID(action.modelID,new DownloadedFunction(action.modelID))}}}}if(info.obj){assetFiles.addOnce(info.obj)}if(info.tex){assetFiles.addOnce(info.tex)}if(info.mapTexture){assetFiles.addOnce(info.mapTexture)}if(info.staticObjects){for(i=0;i<info.staticObjects.length;++i){var object=info.staticObjects[i];if(object.obj){assetFiles.addOnce(object.obj)}if(object.tex){assetFiles.addOnce(object.tex)}}}}if(!requestingDownloads){if(assetIDs.length===numberOfDownloads){self.DownloadExportAssets(appInfo,files,assetFiles)}else{if(DBAssets.requests.length===0){console.log("BuildExportAssets::Missing Assets",assetIDs,assetFiles);self.DownloadExportAssets(appInfo,files,assetFiles)}}}}};for(i=0;i<assetIDs.length;++i){if(i===assetIDs.length-1){requestingDownloads=false}var assetID=assetIDs[i];DBAssets.LoadID(assetID,new DownloadedFunction(assetID))}}else{this.DownloadExportAssets(appInfo,files,assetFiles)}};SceneProjectEditor.prototype.DownloadExportAssets=function(appInfo,files,assetFiles){if(assetFiles.length>0){var self=this;var numberOfDownloads=0;var DownloadedFunction=function(filename){return function(status,data){numberOfDownloads++;if(status>=CCURLRequest.Succeeded&&data&&data.length>0){AlertsManager.Notification("editor"+numberOfDownloads,"exporting "+filename,null,1);var file={};file.name=filename;file.data=data;files.push(file)}else{AlertsManager.Notification("error"+numberOfDownloads,"error exporting "+filename,null,10)}if(assetFiles.length===numberOfDownloads){self.ExportZip(appInfo,files)}}};for(i=0;i<assetFiles.length;++i){var filename=assetFiles[i];gURLManager.requestURL(MultiplayerManager.GetAssetURL(filename),null,new DownloadedFunction(filename),0,null,null,null,true)}}else{this.ExportZip(appInfo,files)}};SceneProjectEditor.prototype.ExportZip=function(appInfo,files){var filename="GameData."+appInfo.id+".zip";var zip=new JSZip;zip.file("appinfo.json",JSON.stringify(appInfo));for(var i=0;i<files.length;++i){var file=files[i];zip.file(file.name,file.data)}var a=document.createElement("a");a.href=window.URL.createObjectURL(zip.generate({type:"blob"}));a.download=filename;a.style.display="none";document.body.appendChild(a);a.click();document.body.removeChild(a);AlertsManager.Hide("exporting...");AlertsManager.TimeoutAlert("exported "+filename,5)};function SceneProjectNew(parentScene,projectManager){this.construct();CC.SetJSLocationBarData("SceneProjectNew");this.controlsSwipeMomentum=true;this.projectManager=projectManager;{parentScene.linkScene(this);this.setParent(parentScene)}{var camera=gEngine.newSceneCamera(this,0);camera.setupViewport(0,0,1,1)}this.open=true;this.controlsEnabled=false;gEngine.addScene(this);var self=this;this.sceneUIBack=new SceneUIBack(this,function(){self.projectManager.openProjectsList();self.close()},true)}ExtendPrototype(SceneProjectNew,CCSceneAppUI);SceneProjectNew.prototype.setup=function(){var self=this;var camera=this.camera;camera.setCameraWidth(640,false);var tile;{tile=new CCTile3DButton(self);tile.setColour(gColour.set(1,0));tile.setDrawOrder(201);this.tileBackground=tile}this.appsList=[];this.addAppInfo({type:"overheadshooter",titleImage:"template_overheadshooter.jpg",name:"Overhead Shooter Template"});this.addAppInfo({id:"205",titleImage:"template_fighting.jpg",name:"Fighting Game Template"});this.addAppInfo({id:"126",titleImage:"template_helloworldjs.jpg",name:"Hello World.js"});this.addAppInfo({id:"375",titleImage:"template_helloworldui.jpg",name:"Hello World UI"});this.addAppInfo({titleImage:"template_actionrpg.jpg",name:"Action RPG Template",www:"http://igg.me/at/playir/x/3276321"});this.addAppInfo({titleImage:"template_rts.jpg",name:"RTS Template",www:"http://igg.me/at/playir/x/3276321"});this.addAppInfo({titleImage:"template_flightsim.jpg",name:"Flight Sim Template",www:"http://igg.me/at/playir/x/3276321"});this.addAppInfo({titleImage:"template_camelracer.png",name:"Camel Racer Template",www:"http://igg.me/at/playir/x/3276321"});this.addAppInfo({titleImage:"template_carracer.jpg",name:"Car Racer Template",www:"http://igg.me/at/playir/x/3276321"});this.requestResize()};SceneProjectNew.prototype.updateCamera=function(delta){var updated=this.CCSceneAppUI_updateCamera(delta);if(updated){var camera=this.camera;var tile,i;{tile=this.tileBackground;if(this.appsList.length>1){var unseenTileSize=camera.targetWidth-tile.collisionSize.width;tile.setPositionX(camera.currentLookAt[0]-camera.targetWidth*.5+tile.collisionBounds[0]);var sceneDistance=this.sceneRight-this.sceneLeft;sceneDistance=sceneDistance===0?1:sceneDistance;var scenePositionPercentage=(camera.currentLookAt[0]-this.sceneLeft)/sceneDistance;scenePositionPercentage=CC.FloatClamp(scenePositionPercentage,0,1);tile.translate(unseenTileSize*scenePositionPercentage,0,0)}else{tile.setPositionXY(camera.currentLookAt[0],camera.currentLookAt[1])}}}};SceneProjectNew.prototype.resize=function(){if(this.open){this.CCSceneAppUI_resize();var camera=this.camera;var tile,i;this.tileBackground.setupTexturedFit(camera.targetWidth,camera.targetHeight,true,"multi_background.jpg",function(tile){tile.setColourAlpha(.25,true);camera.flagUpdate()});var idealAspectRatio=1.5;var aspectRatioAdjutment=camera.getAspectRatio()<1.25?camera.getAspectRatio()/idealAspectRatio:1;var tileHeight=camera.targetHeight*.33*aspectRatioAdjutment;var appsList=this.appsList;for(i=0;i<appsList.length;++i){var app=appsList[i];var appTiles=app.tiles;if(appTiles.length>0){tile=appTiles[0];if(tile.getTileTextureImage()){tile.setTileTexturedHeight(tileHeight)}else{tile.setTileSize(tileHeight*1.5,tileHeight)}for(var j=1;j<appTiles.length;++j){tile=appTiles[j];tile.setTextHeight(tileHeight*.125,true);tile.positionTileBelow(appTiles[j-1])}}}this.show()}};SceneProjectNew.prototype.updateControls=function(controls){var usingControls=this.CCSceneAppUI_updateControls(controls);var cameraTouches=this.camera.cameraTouches;var touch=cameraTouches[0];if(touch.x>0&&touch.x<1&&touch.y>0&&touch.y<1&&touch.startX>0&&touch.startX<1&&touch.startY>0&&touch.startY<1){if(controls.wheel&&controls.wheel.delta!==0){this.cameraScrolling=true;var delta=controls.wheel.delta;this.touchCameraMoving(delta*.1,0);return true}}return usingControls};SceneProjectNew.prototype.touchMovementAllowed=function(touch,touchDelta){var absDeltaX=Math.abs(touch.totalDeltaX);var absDeltaY=Math.abs(touch.totalDeltaY);if(absDeltaX>CCControls.TouchMovementThreashold.x||absDeltaY>CCControls.TouchMovementThreashold.y){this.controlsMoving=true;touchDelta.x+=touch.totalDeltaX;touchDelta.y+=touch.totalDeltaY;this.controlsMovingVertical=false;return true}return false};SceneProjectNew.prototype.refreshCameraView=function(){this.sceneLeft=0;this.sceneRight=0;this.sceneTop=0;this.sceneBottom=0;var camera=this.camera;var appsList=this.appsList;var app,tile;if(appsList.length>1){app=appsList.last();tile=app.tiles[0];this.sceneRight=tile.getTileMovementTarget()[0]+tile.collisionBounds[0];this.sceneRight-=tile.collisionBounds[0]}};SceneProjectNew.prototype.lockCameraView=function(){if(this.cameraScrolling){return}var camera=this.camera;if(camera.targetLookAt[0]<this.sceneLeft){camera.targetLookAt[0]=this.sceneLeft;camera.flagUpdate()}else if(camera.targetLookAt[0]>this.sceneRight){camera.targetLookAt[0]=this.sceneRight;camera.flagUpdate()}var closestTile;var closestDistance=CC_MAXFLOAT;var appsList=this.appsList;for(var i=0;i<appsList.length;++i){var app=appsList[i];var tile=app.tiles[0];var distance=CC.Vector3Distance2D(tile.position,camera.targetLookAt,false);if(distance<closestDistance){closestDistance=distance;closestTile=tile}}if(closestTile){vec3.copy(camera.targetLookAt,closestTile.getTileMovementTarget());camera.flagUpdate()}};SceneProjectNew.prototype.show=function(){if(this.open){this.controlsEnabled=true;if(this.tileBackground.getTileTextureImage()){this.tileBackground.setColourAlpha(.25,true)}var camera=this.camera;var tile,i;var appsList=this.appsList;var padding=camera.targetWidth*.0125;var x=0;for(i=0;i<appsList.length;++i){var app=appsList[i];var appTiles=app.tiles;if(appTiles.length>0){var mainTile=appTiles[0];if(i>0){x+=mainTile.collisionBounds[0]}mainTile.setColourAlpha(1,true);mainTile.setCollideable(true);for(var j=0;j<appTiles.length;++j){tile=appTiles[j];if(x<camera.targetWidth){tile.setTileMovementX(x)}else{tile.setPositionX(x)}}x+=mainTile.collisionBounds[0];x+=padding}}this.refreshCameraView();this.lockCameraView()}};SceneProjectNew.prototype.close=function(){CC.RemoveJSLocationBarData("SceneProjectNew");this.open=false;for(var i=0;i<this.tiles.length;++i){var tile=this.tiles[i];tile.setColourAlpha(0,true);tile.setTextColourAlpha(0,true);tile.setCollideable(false)}var self=this;this.tileBackground.setColourAlpha(0,true,function(){self.deleteLater()})};SceneProjectNew.prototype.select=function(app){if(app.info.www){CCEngine.WebViewOpen(app.info.www);return}this.open=false;var tile;for(var i=0;i<this.tiles.length;++i){tile=this.tiles[i];tile.setColourAlpha(0,true);tile.setTextColourAlpha(0,true);tile.setCollideable(false)}var camera=this.camera;{tile=app.tiles[0];tile.setDrawOrder(300);vec3.copy(camera.targetLookAt,tile.getTileMovementTarget());camera.flagUpdate()}this.tileBackground.setColourAlpha(0,true);if(app.info.type==="overheadshooter"){AlertsManager.ModalAlert("creating...");MultiplayerManager.Emit("EditorProjectNew")}else if(app.info.id){if(MultiplayerManager.Emit("EditorProjectFork",app.info.id)){AlertsManager.ModalAlert("forking...")}}};SceneProjectNew.prototype.addAppInfo=function(info){var self=this;var camera=this.camera;var tiles=this.tiles;var appsList=this.appsList;var tile;var SelectFunction=function(info){return function(){self.select(app)}};var LoadImageFunction=function(tile,textureSrc){return function(textureHandle){if(textureHandle){tile.setTileTexture(textureSrc);self.requestResize()}}};var x=camera.currentLookAt[0]+camera.targetWidth;var app={};app.info=info;app.tiles=[];appsList.add(app);{tile=new CCTile3DButton(this);app.tiles.add(tile);tile.setupTile(1);var titleImage=info.titleImage?info.titleImage:SceneMultiManager.DefaultTitleImage;
tile.setTileTexture(info.titleImage,function(tile,textureHandle){if(textureHandle){if(self.open){tile.setColourAlpha(1,true)}}});tile.setColour(gColour.set(1,0));tile.setCollideable(false);tile.setPositionX(x);tile.onRelease.push(new SelectFunction(app));this.addTile(tile)}{tile=new CCTile3DButton(this);app.tiles.add(tile);tile.setupText(info.name,1,true,false);tile.setTextColour(gColour.set(1,1));tile.setCollideable(false);tile.setPositionX(x);this.addTile(tile)}{tile=new CCTile3DButton(this);app.tiles.add(tile);if(!info.price){tile.setupText("",1,true,false)}else{tile.setupText("£"+info.price,1,true,false)}tile.setTextColour(gColour.set(1,1));tile.setCollideable(false);tile.setPositionX(x);this.addTile(tile)}var drawOrder=300;var duration=1;for(var i=0;i<appsList.length;++i){var appTiles=appsList[i].tiles;for(var j=0;j<appTiles.length;++j){tile=appTiles[j];tile.movementInterpolator.setDuration(duration);if(duration<2){duration+=.125}tile.setDrawOrder(drawOrder);if(drawOrder>205){drawOrder--}}}this.requestResize();return app};function SceneProjectsList(parentScene,onSelected,onNew,onBack){this.construct();this.cameraCentered=true;this.controlsSwipeMomentum=true;{parentScene.linkScene(this);this.setParent(parentScene)}{var camera=gEngine.newSceneCamera(this,0);camera.setupViewport(0,0,1,1)}this.onSelected=onSelected;this.onNew=onNew;this.open=true;this.controlsEnabled=false;gEngine.addScene(this);var self=this;this.dbApps=new DBApps;this.dbApps.load(function(appInfos){self.loadAppInfos(appInfos)},function(appInfo,removed){self.updatedAppInfo(appInfo,removed)});if(onBack){this.sceneUIBack=new SceneUIBack(this,function(){onBack();self.close()},true)}}ExtendPrototype(SceneProjectsList,CCSceneAppUI);SceneProjectsList.prototype.deleteLater=function(){if(this.dbApps){this.dbApps.destruct();this.dbApps=null}this.CCSceneAppUI_deleteLater()};SceneProjectsList.prototype.setup=function(){var self=this;var camera=this.camera;camera.setCameraWidth(640,false);var tile;{tile=new CCTile3DButton(self);tile.setColour(gColour.set(1,0));tile.setDrawOrder(201);this.tileBackground=tile}{tile=new CCTile3DButton(this,true);tile.setColour(gColour.set(.05,0));tile.setDrawOrder(204);this.tileAlert=tile;this.cameraStickyTiles.add(tile)}if(this.onNew){tile=new CCTile3DButton(self);tile.setupText("New\nProject",1,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.setColour(EditorManager.LightGreen);tile.setColourAlpha(0);tile.setTextColour(gColour.set(1,0));tile.setCollideable(false);tile.setDrawOrder(205);tile.onRelease.push(function(){self.onNew()});this.addTile(tile);this.tileNewProject=tile;tile=new CCTile3DButton(self);tile.setupText("User Guide",1,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.setColour(EditorManager.LightBlue);tile.setColourAlpha(0);tile.setTextColour(gColour.set(1,0));tile.setCollideable(false);tile.setDrawOrder(205);tile.onRelease.push(function(){CCEngine.WebViewOpen("http://playir.com/userguide")});this.addTile(tile);this.tileUserGuide=tile}this.gamesList=[];this.refreshCameraView();this.lockCameraView()};SceneProjectsList.prototype.updateCamera=function(delta){var updated=this.CCSceneAppUI_updateCamera(delta);if(updated){var camera=this.camera;var tile,i;{tile=this.tileBackground;if(this.gamesList.length>1){var unseenTileSize=camera.targetWidth-tile.collisionSize.width;tile.setPositionX(camera.currentLookAt[0]-camera.targetWidth*.5+tile.collisionBounds[0]);var sceneDistance=this.sceneRight-this.sceneLeft;sceneDistance=sceneDistance===0?1:sceneDistance;var scenePositionPercentage=(camera.currentLookAt[0]-this.sceneLeft)/sceneDistance;scenePositionPercentage=CC.FloatClamp(scenePositionPercentage,0,1);tile.translate(unseenTileSize*scenePositionPercentage,0,0)}else{tile.setPositionXY(camera.currentLookAt[0],camera.currentLookAt[1])}}if(this.tileUserGuide){var padding=camera.targetWidth*.0125;tile=this.tileUserGuide;tile.setPositionXY(camera.currentLookAt[0]+-(camera.targetWidth*.5)+(tile.collisionBounds[0]+padding),camera.currentLookAt[1]+camera.targetHeight*.5-(tile.collisionBounds[1]+padding))}}};SceneProjectsList.prototype.resize=function(){if(this.open){this.CCSceneAppUI_resize();var camera=this.camera;var tile,i;this.tileBackground.setupTexturedFit(camera.targetWidth,camera.targetHeight,true,"multi_background.jpg",function(tile){tile.setColourAlpha(.25,true);camera.flagUpdate()});{tile=this.tileAlert;tile.setTileSize(camera.targetWidth,camera.targetHeight*.3)}var idealAspectRatio=1.5;var aspectRatioAdjutment=camera.getAspectRatio()<1.25?camera.getAspectRatio()/idealAspectRatio:1;var tileHeight;tileHeight=camera.targetHeight*.25*aspectRatioAdjutment;if(this.tileNewProject){this.tileNewProject.setTileSize(tileHeight,tileHeight);this.tileNewProject.setTextHeight(tileHeight*.25)}if(this.tileUserGuide){this.tileUserGuide.setTileSize(tileHeight,tileHeight*.5);this.tileUserGuide.setTextHeight(tileHeight*.25)}var gamesList=this.gamesList;for(i=0;i<gamesList.length;++i){var game=gamesList[i];var gameTiles=game.tiles;if(gameTiles.length>0){tile=gameTiles[0];if(tile.getTileTextureImage()){tile.setTileTexturedHeight(tileHeight)}else{tile.setTileSize(tileHeight*1.5,tileHeight)}for(var j=1;j<gameTiles.length;++j){tile=gameTiles[j];tile.setTextHeight(tileHeight*.125,true);tile.positionTileBelow(gameTiles[j-1])}}}this.show()}};SceneProjectsList.prototype.updateControls=function(controls){var usingControls=this.CCSceneAppUI_updateControls(controls);var cameraTouches=this.camera.cameraTouches;var touch=cameraTouches[0];if(touch.x>0&&touch.x<1&&touch.y>0&&touch.y<1&&touch.startX>0&&touch.startX<1&&touch.startY>0&&touch.startY<1){if(controls.wheel&&controls.wheel.delta!==0){this.cameraScrolling=true;var delta=controls.wheel.delta;this.touchCameraMoving(delta*.1,0);return true}}return usingControls};SceneProjectsList.prototype.touchMovementAllowed=function(touch,touchDelta){var absDeltaX=Math.abs(touch.totalDeltaX);var absDeltaY=Math.abs(touch.totalDeltaY);if(absDeltaX>CCControls.TouchMovementThreashold.x||absDeltaY>CCControls.TouchMovementThreashold.y){this.controlsMoving=true;touchDelta.x+=touch.totalDeltaX;touchDelta.y+=touch.totalDeltaY;this.controlsMovingVertical=false;return true}return false};SceneProjectsList.prototype.refreshCameraView=function(){this.sceneLeft=0;this.sceneRight=0;this.sceneTop=0;this.sceneBottom=0;var camera=this.camera;var gamesList=this.gamesList;var game,tile;if(gamesList.length>1){game=gamesList.last();tile=game.tiles[0];this.sceneRight=tile.getTileMovementTarget()[0]+tile.collisionBounds[0];this.sceneRight-=tile.collisionBounds[0]}};SceneProjectsList.prototype.lockCameraView=function(){if(this.cameraScrolling){return}var camera=this.camera;if(camera.targetLookAt[0]<this.sceneLeft){camera.targetLookAt[0]=this.sceneLeft;camera.flagUpdate()}else if(camera.targetLookAt[0]>this.sceneRight){camera.targetLookAt[0]=this.sceneRight;camera.flagUpdate()}var closestTile;var closestDistance=CC_MAXFLOAT;var gamesList=this.gamesList;for(var i=0;i<gamesList.length;++i){var game=gamesList[i];var tile=game.tiles[0];var distance=CC.Vector3Distance2D(tile.position,camera.targetLookAt,false);if(distance<closestDistance){closestDistance=distance;closestTile=tile}}if(closestTile){vec3.copy(camera.targetLookAt,closestTile.getTileMovementTarget());camera.flagUpdate()}};SceneProjectsList.prototype.show=function(){if(this.open){this.controlsEnabled=true;if(this.tileBackground.getTileTextureImage()){this.tileBackground.setColourAlpha(.25,true)}this.tileAlert.setColourAlpha(.5,true);var camera=this.camera;var tile,i;if(this.tileNewProject){this.tileNewProject.setColourAlpha(1,true);this.tileNewProject.setTextColourAlpha(1,true);this.tileNewProject.setCollideable(true)}if(this.tileUserGuide){this.tileUserGuide.setColourAlpha(1,true);this.tileUserGuide.setTextColourAlpha(1,true);this.tileUserGuide.setCollideable(true)}var gamesList=this.gamesList;var padding=camera.targetWidth*.0125;var x=0;for(i=0;i<gamesList.length;++i){var game=gamesList[i];var gameTiles=game.tiles;if(gameTiles.length>0){var mainTile=gameTiles[0];if(i>0){x+=mainTile.collisionBounds[0]}mainTile.setColourAlpha(1,true);mainTile.setCollideable(true);for(var j=0;j<gameTiles.length;++j){tile=gameTiles[j];if(x<camera.targetWidth){tile.setTileMovementX(x)}else{tile.setPositionX(x)}}x+=mainTile.collisionBounds[0];x+=padding}}if(this.tileNewProject){if(gamesList.length>0){this.tileNewProject.positionTileLeftX(gamesList[0].tiles[0]);this.tileNewProject.translate(-padding)}}this.refreshCameraView();this.lockCameraView()}};SceneProjectsList.prototype.close=function(shouldDelete){if(shouldDelete===undefined){shouldDelete=true}this.open=false;for(var i=0;i<this.tiles.length;++i){var tile=this.tiles[i];tile.setColourAlpha(0,true);tile.setTextColourAlpha(0,true);tile.setCollideable(false)}this.tileAlert.setColourAlpha(0,true);if(shouldDelete){var self=this;this.tileBackground.setColourAlpha(0,true,function(){self.deleteLater()})}};SceneProjectsList.prototype.selectGame=function(game){this.close(false);var camera=this.camera;{tile=game.tiles[0];tile.setDrawOrder(300);vec3.copy(camera.targetLookAt,tile.getTileMovementTarget());camera.flagUpdate()}var self=this;this.tileBackground.setColourAlpha(0,true,function(){self.onSelected(game.appInfo);self.deleteLater()})};SceneProjectsList.prototype.addAppInfo=function(appInfo){var self=this;var camera=this.camera;var tiles=this.tiles;var gamesList=this.gamesList;var tile;var SelectGameFunction=function(game){return function(){self.selectGame(game)}};var LoadImageFunction=function(tile,textureSrc){return function(textureHandle){if(textureHandle){tile.setTileTexture(textureSrc);self.requestResize()}}};var x=camera.currentLookAt[0]+camera.targetWidth;var game={};game.appInfo=appInfo;game.tiles=[];gamesList.add(game);{tile=new CCTile3DButton(this);game.tiles.add(tile);tile.setupTile(1);var titleImage=appInfo.titleImage?appInfo.titleImage:SceneMultiManager.DefaultTitleImage;tile.setTileTexture(appInfo.titleImage,function(tile,textureHandle){if(textureHandle){if(self.open){tile.setColourAlpha(1,true)}}});tile.setColour(gColour.set(1,0));tile.setCollideable(false);tile.setPositionX(x);tile.onRelease.push(new SelectGameFunction(game));this.addTile(tile)}{tile=new CCTile3DButton(this);game.tiles.add(tile);tile.setupText(appInfo.name,1,true,false);tile.setTextColour(gColour.set(1,1));tile.setCollideable(false);tile.setPositionX(x);this.addTile(tile)}{tile=new CCTile3DButton(this);game.tiles.add(tile);if(appInfo.open){tile.setupText("Published",1,true,false)}else{tile.setupText("Unpublished",1,true,false)}tile.setTextColour(gColour.set(1,1));tile.setCollideable(false);tile.setPositionX(x);this.addTile(tile)}var drawOrder=300;var duration=1;for(var i=0;i<gamesList.length;++i){var gameTiles=gamesList[i].tiles;for(var j=0;j<gameTiles.length;++j){tile=gameTiles[j];tile.movementInterpolator.setDuration(duration);if(duration<2){duration+=.125}tile.setDrawOrder(drawOrder);if(drawOrder>205){drawOrder--}}}this.requestResize();return game};SceneProjectsList.prototype.loadAppInfos=function(appInfos){var self=this;var camera=this.camera;var tiles=this.tiles;var gamesList=this.gamesList;var GameCompare=function(appInfo){if(appInfo.id==="androids"){return 101}else if(appInfo.id==="tanks"){return 102}else if(appInfo.id==="burgers"){return 103}else if(appInfo.id==="space"){return 104}else if(MultiplayerManager.IsOwner(appInfo.owners)){if(appInfo.jsFiles){return 100-appInfo.jsFiles.length}return 100}else if(appInfo.jsFiles){return 105}return 1e3};appInfos.sort(function(a,b){var scoreA=GameCompare(a);var scoreB=GameCompare(b);if(scoreA===scoreB){return a.id-b.id}return scoreA-scoreB});var game,tile;var i,j;for(i=0;i<appInfos.length;++i){var appInfo=appInfos[i];game=null;if(gamesList.length>i){game=gamesList[i]}if(game){if(game.appInfo.id===appInfo.id){tile=game.tiles[0];tile.setTileTexture(appInfo.titleImage);continue}else{for(j=0;j<game.tiles.length;++j){tile=game.tiles[j];tiles.remove(tile);tile.deleteLater()}gamesList.remove(game)}}if(MultiplayerManager.IsOwner(appInfo.owners)){game=this.addAppInfo(appInfo);gamesList.insert(game,i)}}while(gamesList.length>appInfos.length){game=gamesList[appInfos.length];for(j=0;j<game.tiles.length;++j){tile=game.tiles[j];tiles.remove(tile);tile.deleteLater()}gamesList.remove(game)}this.requestResize()};SceneProjectsList.prototype.updatedAppInfo=function(appInfo,removed){var self=this;var camera=this.camera;var gamesList=this.gamesList;var i,game,tile;var LoadImageFunction=function(tile,textureSrc){return function(textureHandle){if(textureHandle){tile.setTileTexture(textureSrc);self.requestResize()}}};for(i=0;i<gamesList.length;++i){game=gamesList[i];if(game.appInfo.id===appInfo.id){if(removed){for(var j=0;j<game.tiles.length;++j){tile=game.tiles[j];this.tiles.remove(tile);tile.deleteLater()}gamesList.remove(game);this.requestResize()}else{tile=game.tiles[0];if(appInfo.titleImage){gEngine.textureManager.getTextureHandle(appInfo.titleImage,new LoadImageFunction(tile,appInfo.titleImage))}game.tiles[1].setText(appInfo.name);if(appInfo.open){game.tiles[2].setText("Published")}else{game.tiles[2].setText("Unpublished")}}return}}if(!removed){this.addAppInfo(appInfo)}};function SceneProjectManagerList(parentScene,projectManager){this.construct();this.projectManager=projectManager;{parentScene.linkScene(this);this.setParent(parentScene)}{var camera=gEngine.newSceneCamera(this,0);camera.setupViewport(0,0,1,1)}this.open=true;this.controlsEnabled=false;gEngine.addScene(this);var self=this;this.projectsList=new SceneProjectsList(parentScene,function(appInfo){self.hide();projectManager.onEditGame(appInfo)},function(){self.hide();projectManager.onNewProject()});this.resize()}ExtendPrototype(SceneProjectManagerList,CCSceneAppUI);SceneProjectManagerList.prototype.deleteLater=function(){this.CCSceneAppUI_deleteLater()};SceneProjectManagerList.prototype.setup=function(){var self=this;var camera=this.camera;camera.setCameraWidth(640,false);var tile;var buttons=this.buttons=[];{tile=new CCTile3DButton(self);tile.setupText("Levels",1,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.setColour(gColour.set(.5,0));tile.setColourAlpha(0);tile.setTextColour(gColour.set(1,0));tile.setCollideable(false);tile.setDrawOrder(205);tile.onRelease.push(function(){self.projectManager.onEditMaps()});this.addTile(tile);buttons.push(tile)}{tile=new CCTile3DButton(self);tile.setupText("Images",1,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.setColour(gColour.set(.5,0));tile.setColourAlpha(0);tile.setTextColour(gColour.set(1,0));tile.setCollideable(false);tile.setDrawOrder(205);tile.onRelease.push(function(){self.projectManager.onEditImages()});this.addTile(tile);buttons.push(tile)}{tile=new CCTile3DButton(self);tile.setupText("Models",1,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.setColour(gColour.set(.5,0));tile.setColourAlpha(0);tile.setTextColour(gColour.set(1,0));tile.setCollideable(false);tile.setDrawOrder(205);tile.onRelease.push(function(){self.projectManager.onEditModels()});this.addTile(tile);buttons.push(tile)}{tile=new CCTile3DButton(self);tile.setupText("Characters",1,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.setColour(gColour.set(.5,0));tile.setColourAlpha(0);tile.setTextColour(gColour.set(1,0));tile.setCollideable(false);tile.setDrawOrder(205);tile.onRelease.push(function(){self.projectManager.onEditCharacters()});this.addTile(tile);buttons.push(tile)}{tile=new CCTile3DButton(self);tile.setupText("Audio",1,true,true);tile.setTileTexture("editor_tile_background.jpg");tile.setColour(gColour.set(.5,0));tile.setColourAlpha(0);tile.setTextColour(gColour.set(1,0));tile.setCollideable(false);tile.setDrawOrder(205);tile.onRelease.push(function(){self.projectManager.onEditAudio()});this.addTile(tile);buttons.push(tile)}this.refreshCameraView();this.lockCameraView()};SceneProjectManagerList.prototype.updateCamera=function(delta){var updated=this.CCSceneAppUI_updateCamera(delta);if(updated){var camera=this.camera;var tile,i;var buttons=this.buttons;var totalWidth=0;for(i=0;i<buttons.length;++i){tile=buttons[i];totalWidth+=tile.collisionSize.width}var x=camera.currentLookAt[0]-totalWidth*.5;for(i=0;i<buttons.length;++i){tile=buttons[i];x+=tile.collisionBounds[0];tile.setPositionXY(x,camera.currentLookAt[1]-camera.targetHeight*.4);x+=tile.collisionBounds[0]}}};SceneProjectManagerList.prototype.resize=function(){if(this.open){this.CCSceneAppUI_resize();var camera=this.camera;var tile,i;var idealAspectRatio=1.5;var aspectRatioAdjutment=camera.getAspectRatio()<1.25?camera.getAspectRatio()/idealAspectRatio:1;var tileHeight;tileHeight=camera.targetHeight*.05*aspectRatioAdjutment;var buttons=this.buttons;for(i=0;i<buttons.length;++i){tile=buttons[i];tile.setTextHeight(tileHeight,true);var width=tile.collisionSize.width*1.5;if(width<25){width=25}tile.setTileSize(width,tile.collisionSize.height*1.2)}this.show()}};SceneProjectManagerList.prototype.updateControls=function(controls){var usingControls=this.CCSceneAppUI_updateControls(controls);return usingControls};SceneProjectManagerList.prototype.touchMovementAllowed=function(touch,touchDelta){return false};SceneProjectManagerList.prototype.refreshCameraView=function(){this.sceneLeft=0;this.sceneRight=0;this.sceneTop=0;this.sceneBottom=0};SceneProjectManagerList.prototype.lockCameraView=function(){if(this.cameraScrolling){return}var camera=this.camera;if(camera.targetLookAt[0]<this.sceneLeft){camera.targetLookAt[0]=this.sceneLeft;camera.flagUpdate()}else if(camera.targetLookAt[0]>this.sceneRight){camera.targetLookAt[0]=this.sceneRight;camera.flagUpdate()}};SceneProjectManagerList.prototype.show=function(){if(this.open){this.controlsEnabled=true;this.projectsList.show();var camera=this.camera;var tile,i;var buttons=this.buttons;for(i=0;i<buttons.length;++i){tile=buttons[i];tile.setColourAlpha(1,true);tile.setTextColourAlpha(1,true);tile.setCollideable(true)}this.refreshCameraView();this.lockCameraView()}};SceneProjectManagerList.prototype.close=function(){this.open=false;this.hide();this.projectsList.close()};SceneProjectManagerList.prototype.hide=function(){for(var i=0;i<this.tiles.length;++i){var tile=this.tiles[i];tile.setColourAlpha(0,true);tile.setTextColourAlpha(0,true);tile.setCollideable(false);tile.setTileMovementY(-this.camera.targetHeight)}};function SceneProjectManagerUI(projectManager){this.construct();{this.projectManager=projectManager;projectManager.linkScene(this);this.linkScene(projectManager)}{var parentCameraIndex=gEngine.findCameraIndex(projectManager.camera);var camera=gEngine.newSceneCamera(this,parentCameraIndex+1);camera.setupViewport(0,0,1,1)}this.sceneMultiLauncher=new SceneMultiUILauncher(this);this.sceneLogin=null;this.sceneProjectsList=null}ExtendPrototype(SceneProjectManagerUI,CCSceneAppUI);SceneProjectManagerUI.prototype.deleteLater=function(){this.close();this.CCSceneAppUI_deleteLater();if(this.sceneMultiLauncher){this.sceneMultiLauncher.hide(true);this.sceneMultiLauncher=null}};SceneProjectManagerUI.prototype.setup=function(){var self=this;var camera=this.camera;camera.setCameraWidth(640,false);this.requestResize()};SceneProjectManagerUI.prototype.deletingChild=function(inScene){if(inScene===this.sceneMultiLauncher){this.hideLogin()}this.CCSceneAppUI_deletingChild(inScene)};SceneProjectManagerUI.prototype.touchMoving=function(touch,touchDelta){return false};SceneProjectManagerUI.prototype.close=function(){this.closeProjectsList();this.closeProjectEditor();this.closeAssetEditor()};SceneProjectManagerUI.prototype.showLogin=function(){if(!this.sceneLogin){this.sceneLogin=new SceneMultiUILogin(this,this.multiManager)}};SceneProjectManagerUI.prototype.hideLogin=function(){if(this.sceneLogin){this.sceneLogin.close();this.sceneLogin=null}};SceneProjectManagerUI.prototype.openProjectsList=function(){if(this.projectEditor){this.closeProjectEditor()}if(this.sceneProjectsList){this.closeProjectsList()}this.sceneProjectsList=new SceneProjectManagerList(this,this.projectManager);this.sceneMultiLauncher.show();this.showLogin();if(MultiplayerManager.LoggedIn&&!MultiplayerManager.IsUserLoggedIn()){var ownedApps=DBApps.GetOwnedApps();if(ownedApps.length>0){var self=this;AlertsManager.Notification("","Login to save projects",function(){new SceneProfileLogin},10,EditorManager.LightRed)}}};SceneProjectManagerUI.prototype.closeProjectsList=function(){this.hideLogin();if(this.sceneProjectsList){this.sceneProjectsList.close();this.sceneProjectsList=null}if(this.sceneMultiLauncher){this.sceneMultiLauncher.hide()}};SceneProjectManagerUI.prototype.openNewProject=function(){if(!this.projectNew){this.projectNew=new SceneProjectNew(this,this.projectManager)}};SceneProjectManagerUI.prototype.openProjectEditor=function(appInfo,checkForChangesBeforeReOpen){if(this.projectNew){this.projectNew.close()}if(this.projectEditor){if(checkForChangesBeforeReOpen){var currentAppInfo=this.projectEditor.appInfo;if(appInfo.id===currentAppInfo.id){if(CC.DeepEquals(currentAppInfo,appInfo)){return}}}this.projectEditor.setupAppInfo(appInfo,false);return}this.projectEditor=new SceneProjectEditor(this,this.projectManager,appInfo)};SceneProjectManagerUI.prototype.closeProjectEditor=function(){if(this.projectEditor){this.projectEditor.close(false);this.projectEditor=null}};SceneProjectManagerUI.prototype.openAssetEditor=function(title,supportObj,callback){if(this.sceneAssetEditor){this.closeAssetEditor()}this.sceneAssetEditor=new SceneAssetEditor(this,supportObj,true);this.sceneAssetEditor.open(title);if(callback){this.sceneAssetEditor.onClose=callback}};SceneProjectManagerUI.prototype.closeAssetEditor=function(){if(this.sceneAssetEditor){this.sceneAssetEditor.close();this.sceneAssetEditor=null}};SceneProjectManagerUI.prototype.editAsset=function(src){if(src){this.sceneAssetEditor.setAsset(src)}};SceneProjectManagerUI.prototype.openVisualJSEditor=function(filename,onClose){this.closeVisualJSEditor();this.sceneVisualJSEditor=new SceneVisualJSEditor(this);this.sceneVisualJSEditor.open(filename,onClose);return true};SceneProjectManagerUI.prototype.closeVisualJSEditor=function(){if(this.sceneVisualJSEditor){this.sceneVisualJSEditor.close(false);this.sceneVisualJSEditor=null}};function SceneProjectManager(){CCAudioManager.Enabled=true;this.construct()}ExtendPrototype(SceneProjectManager,SceneManagerPlay);SceneProjectManager.prototype.construct=function(){this.SceneManagerPlay_construct();this.sceneUI=new SceneProjectManagerUI(this);gEngine.addScene(this.sceneUI);var self=this;this.dbApps=new DBApps;this.dbApps.load(function(appInfos){AlertsManager.Hide("connecting...");if(self.sceneUI.projectEditor){var currentAppInfo=self.sceneUI.projectEditor.appInfo;for(var i=0;i<appInfos.length;++i){var appInfo=appInfos[i];if(appInfo.id===currentAppInfo.id){self.sceneUI.openProjectEditor(appInfo,true);return}}}},function(appInfo,removed){self.updatedAppInfo(appInfo,removed)});if(!MultiplayerManager.LoggedIn){this.syncDisconnected()}gEngine.addScene(this);this.openProjectsList()};SceneProjectManager.prototype.deleteLater=function(){if(this.dbApps){this.dbApps.destruct();this.dbApps=null}this.SceneManagerPlay_deleteLater();if(this.sceneUI){this.sceneUI.close();this.sceneUI=null}};SceneProjectManager.prototype.setup=function(){this.SceneManagerPlay_setup();this.camera.enabled=false};SceneProjectManager.prototype.syncDisconnected=function(){if(!MultiplayerManager.ForceDisconnected){if(this.dbApps){AlertsManager.ModalAlert("connecting...",2)}}};SceneProjectManager.prototype.syncLoggedIn=function(){this.SceneManagerPlay_syncLoggedIn();if(CC.GetJSLocationBarData("SceneProjectEditor")){var gameID=CC.GetJSLocationBarData("SceneProjectEditor");this.onEditGameID(gameID)}else if(CC.GetJSLocationBarData("SceneProjectNew")){this.onNewProject()}else if(CC.GetJSLocationBarData("SceneMapsManager")){this.onEditMaps()}else if(CC.GetJSLocationBarData("SceneTemplateUIManager")){this.onEditUI()}else if(CC.GetJSLocationBarData("SceneModelsManager")){this.onEditModels()}else if(CC.GetJSLocationBarData("SceneImagesManager")){this.onEditImages()}else if(CC.GetJSLocationBarData("SceneCharactersManager")){this.onEditCharacters()}else if(CC.GetJSLocationBarData("SceneAudioManager")){this.onEditAudio()}};SceneProjectManager.prototype.syncLoggedIntoSocialNetwork=function(network){this.sceneUI.hideLogin();this.sceneUI.showLogin()};SceneProjectManager.prototype.updatedAppInfo=function(appInfo,removed){if(this.sceneUI.projectEditor){var currentAppInfo=this.sceneUI.projectEditor.appInfo;if(appInfo.id===currentAppInfo.id){if(removed){this.sceneUI.closeProjectEditor();this.openProjectsList()}else{this.sceneUI.openProjectEditor(appInfo,true)}return}}};SceneProjectManager.prototype.syncUpdate=function(jsonData){if(jsonData.EditorProjectNew){if(!this.sceneUI.projectEditor){AlertsManager.Hide("creating...");this.sceneUI.openProjectEditor(jsonData.EditorProjectNew)}}else if(jsonData.EditorProjectImport){if(!this.sceneUI.projectEditor){AlertsManager.Hide("forking...");AlertsManager.Hide("importing...");this.sceneUI.openProjectEditor(jsonData.EditorProjectImport)}}else if(jsonData.EditorProjectEdited!==undefined){AlertsManager.Hide("updating...");if(jsonData.appInfo){this.sceneUI.openProjectEditor(jsonData.appInfo)}}else if(jsonData.AppsRequestInfo!==undefined){this.onEditGame(jsonData.AppsRequestInfo)}};SceneProjectManager.prototype.onNewProject=function(){this.sceneUI.closeProjectsList();this.sceneUI.openNewProject()};SceneProjectManager.prototype.onEditMaps=function(){this.deleteLater();gEngine.addScene(new SceneMapsManager)};SceneProjectManager.prototype.onEditUI=function(uiID,onSelect,onClose){this.deleteLater();new SceneTemplateUIManager(uiID,onSelect,onClose)};SceneProjectManager.prototype.onEditCharacters=function(){this.deleteLater();gEngine.addScene(new SceneCharactersManager)};SceneProjectManager.prototype.onEditImages=function(){this.deleteLater();gEngine.addScene(new SceneImagesManager)};SceneProjectManager.prototype.onEditModels=function(){this.deleteLater();gEngine.addScene(new SceneModelsManager)};SceneProjectManager.prototype.onEditAudio=function(){this.deleteLater();gEngine.addScene(new SceneAudioManager)};SceneProjectManager.prototype.onEditGameID=function(gameID){CC.SetJSLocationBarData("SceneProjectEditor",gameID);MultiplayerManager.Emit("AppsRequestInfo",gameID)};SceneProjectManager.prototype.onEditGame=function(appInfo){AlertsManager.Hide("loading...");if(appInfo){this.sceneUI.closeProjectsList();this.sceneUI.openProjectEditor(appInfo)}else{AlertsManager.TimeoutAlert("unable to load game info :(",2)}};SceneProjectManager.prototype.openProjectsList=function(){this.sceneUI.openProjectsList()};SceneProjectManager.prototype.onGameEditJSStart=function(appInfo){var self=this;AlertsManager.InputAlert(appInfo.jsStart?appInfo.jsStart:"",function(result){if(result){if(appInfo.jsStart!==result){appInfo.jsStart=result;if(MultiplayerManager.Emit("EditorProjectEditJSStart",appInfo.id,appInfo.jsStart)){AlertsManager.ModalAlert("updating...");self.sceneUI.openProjectEditor(appInfo)}}}})};SceneProjectManager.prototype.onVisualJSEditor=function(appInfo,filename){if(MultiplayerManager.LoggedIn){var self=this;this.sceneUI.closeProjectEditor();this.sceneUI.openVisualJSEditor(filename,function(){self.sceneUI.openProjectEditor(appInfo)})}};SceneProjectManager.prototype.onGameRestart=function(appInfo,softRestart){if(MultiplayerManager.LoggedIn){softRestart=!!softRestart;MultiplayerManager.Emit("EditorProjectRestart",appInfo.id,softRestart)}};SceneProjectManager.prototype.onGameEditPlayerType=function(appInfo,playerTypeInfo){var self=this;var cameraX=this.sceneUI.projectEditor.camera.targetLookAt[0];var cameraY=this.sceneUI.projectEditor.camera.targetLookAt[1];this.sceneUI.closeProjectEditor();function OnResultFunction(modelInfo){if(MultiplayerManager.LoggedIn){if(modelInfo){if(modelInfo.obj&&modelInfo.tex){if(!playerTypeInfo||playerTypeInfo.obj!==modelInfo.obj||playerTypeInfo.tex!==modelInfo.tex){if(playerTypeInfo){playerTypeInfo.obj=modelInfo.obj;playerTypeInfo.tex=modelInfo.tex}if(MultiplayerManager.Emit("EditorProjectEditPlayerType",appInfo.id,playerTypeInfo?playerTypeInfo.type:null,modelInfo.obj,modelInfo.tex)){AlertsManager.ModalAlert("updating...")}}}else{AlertsManager.TimeoutAlert("a 3d model and texture is required",2);self.onGameEditPlayerType(appInfo,null);return}}self.sceneUI.openProjectEditor(appInfo);self.sceneUI.projectEditor.camera.targetLookAt[0]=cameraX;self.sceneUI.projectEditor.camera.targetLookAt[1]=cameraY}}this.sceneUI.openAssetEditor(playerTypeInfo?"Edit Player Model":"New Player Model",true,function(modelInfo){OnResultFunction(modelInfo)});this.sceneUI.editAsset(playerTypeInfo.obj);this.sceneUI.editAsset(playerTypeInfo.tex)};SceneProjectManager.prototype.onGameEditPlayerIcon=function(appInfo,playerTypeInfo){var self=this;if(playerTypeInfo){var cameraX=this.sceneUI.projectEditor.camera.targetLookAt[0];var cameraY=this.sceneUI.projectEditor.camera.targetLookAt[1];this.sceneUI.closeProjectEditor();this.sceneUI.openAssetEditor("Edit Player Icon",false,function(tex){if(MultiplayerManager.LoggedIn){if(tex){if(playerTypeInfo.icon!==tex){playerTypeInfo.icon=tex;if(MultiplayerManager.Emit("EditorProjectEditPlayerIcon",appInfo.id,playerTypeInfo.type,tex)){AlertsManager.ModalAlert("updating...")}}}self.sceneUI.openProjectEditor(appInfo);self.sceneUI.projectEditor.camera.targetLookAt[0]=cameraX;self.sceneUI.projectEditor.camera.targetLookAt[1]=cameraY}});this.sceneUI.editAsset(playerTypeInfo.icon)}};function EditorManager(){}EditorManager.Red=(new CCColour).setRGBA(.5,0,0,1);EditorManager.LightRed=(new CCColour).setRGBA(.75,.25,.25,1);EditorManager.LightGreen=(new CCColour).setRGBA(.25,.75,.25,1);EditorManager.LightBlue=(new CCColour).setRGBA(.25,.5,.75,1);EditorManager.LightYellow=(new CCColour).setRGBA(.75,.75,.25,1);EditorManager.Green=(new CCColour).setRGBA(.125,.75,0,.9);EditorManager.Red=(new CCColour).setRGBA(.75,.125,0,1);EditorManager.syncUpdate=function(jsonData){if(jsonData.EditorAudioDeleted){AlertsManager.Hide("deleting...")}else if(jsonData.EditorModelDeleted){AlertsManager.Hide("deleting...")}else if(jsonData.EditorImageDeleted){AlertsManager.Hide("deleting...")}else if(jsonData.EditorCharacterDeleted){AlertsManager.Hide("deleting...")}};EditorManager.EditorDeleteAudio=function(info){if(MultiplayerManager.Emit("EditorAudioDelete",info.id)){MultiplayerManager.UpdateCallbacks.addOnce(this);AlertsManager.ModalAlert("deleting...")}};EditorManager.EditorDeleteModel=function(info){if(MultiplayerManager.Emit("EditorModelDelete",info.objectID)){MultiplayerManager.UpdateCallbacks.addOnce(this);AlertsManager.ModalAlert("deleting...")}};EditorManager.EditorDeleteImage=function(info){if(MultiplayerManager.Emit("EditorImageDelete",info.objectID)){MultiplayerManager.UpdateCallbacks.addOnce(this);AlertsManager.ModalAlert("deleting...")}};EditorManager.EditorDeleteCharacter=function(info){if(MultiplayerManager.Emit("EditorCharacterDelete",info.objectID)){MultiplayerManager.UpdateCallbacks.addOnce(this);AlertsManager.ModalAlert("deleting...")}};EditorManager.EditorUploadJS=function(filename,data,callback,showAlert){if(showAlert===undefined){showAlert=true}if(showAlert){AlertsManager.Notification("editor","uploading...")}var url=SERVER_ASSETS_URL+"assets/upload.php";var postData={filename:filename};if(CCEngine.NativeUpdateCommands===undefined){postData.file=new Blob([data],{type:"text/plain"})}else{postData.file=data}if(MultiplayerManager.UseURLProxy(url)){postData.url=url;url=SERVER_ROOT+"backend/helper.php?uploadfile"}var fileID=filename;gURLManager.requestURL(url,postData,function(status,responseText){if(showAlert){AlertsManager.Hide("uploading...")}if(status>=CCURLRequest.Succeeded){if(responseText){var filename=responseText;if(callback){callback(fileID,filename)}}}},1)};EditorManager.EditorUploadFile=function(filename,data,callback,showAlert){if(showAlert===undefined){showAlert=true
}if(showAlert){AlertsManager.ModalAlert("uploading...")}md5Async(data,function(hash){var url=SERVER_ASSETS_URL+"assets/upload.php?hash="+hash;var postData={filename:filename};if(MultiplayerManager.UseURLProxy(url)){postData.url=url;url=SERVER_ROOT+"backend/helper.php?post"}var uploadFilename=filename;gURLManager.requestURL(url,postData,function(status,newFilename){if(showAlert){AlertsManager.Hide("uploading...")}if(status>=CCURLRequest.Succeeded){if(newFilename&&newFilename.length>4){callback(uploadFilename,newFilename);return}}EditorManager.EditorUploadFileData(filename,data,callback,showAlert)},1)})};EditorManager.EditorUploadFileData=function(filename,data,callback,showAlert){if(showAlert===undefined){showAlert=true}if(showAlert){AlertsManager.ModalAlert("uploading...")}var url=SERVER_ASSETS_URL+"assets/upload.php";var postData={filename:filename};postData.file=new Blob([data]);if(MultiplayerManager.UseURLProxy(url)){postData.url=url;url=SERVER_ROOT+"backend/helper.php?uploadfile"}var uploadFilename=filename;gURLManager.requestURL(url,postData,function(status,newFilename){if(showAlert){AlertsManager.Hide("uploading...")}if(status>=CCURLRequest.Succeeded){if(newFilename&&newFilename.length>0){if(window.DEBUG_IsLocalClient){console.log("Uploaded",uploadFilename,"as",newFilename)}callback(uploadFilename,newFilename);return}}callback(uploadFilename,false)},1)};function SceneMultiUIGamesList(parentScene){this.construct();this.cameraCentered=true;this.controlsSwipeMomentum=true;{parentScene.linkScene(this);this.setParent(parentScene)}{var camera=gEngine.newSceneCamera(this,0);camera.setupViewport(0,0,1,1)}this.open=true;this.controlsEnabled=false;this.cameraCentered=true;gEngine.textureManager.getTextureHandle("multi_background.jpg");gEngine.addScene(this)}ExtendPrototype(SceneMultiUIGamesList,CCSceneAppUI);SceneMultiUIGamesList.prototype.setup=function(){var self=this;var camera=this.camera;camera.setCameraWidth(200,false);var tile;{tile=new CCTile3DButton(self);tile.setColour(gColour.set(1,0));tile.setDrawOrder(98);this.tileBackground=tile}this.tileAlerts=[];for(var i=0;i<2;++i){tile=new CCTile3DButton(this,true);tile.setColour(gColour.set(.05,0));tile.setDrawOrder(99);this.tileAlerts.push(tile)}this.gamesList=[]};SceneMultiUIGamesList.prototype.updateCamera=function(delta){var updated=this.CCSceneAppUI_updateCamera(delta);if(updated){var camera=this.camera;var tile=this.tileBackground;if(this.gamesList.length>1){var unseenTileSize=camera.targetWidth-tile.collisionSize.width;tile.setPositionXY(camera.currentLookAt[0]-camera.targetWidth*.5+tile.collisionBounds[0],camera.currentLookAt[1]);var sceneDistance=this.sceneRight-this.sceneLeft;sceneDistance=sceneDistance===0?1:sceneDistance;var scenePositionPercentage=(camera.currentLookAt[0]-this.sceneLeft)/sceneDistance;scenePositionPercentage=CC.FloatClamp(scenePositionPercentage,0,1);tile.translate(unseenTileSize*scenePositionPercentage,0,0)}else{tile.setPositionXY(camera.currentLookAt[0],camera.currentLookAt[1])}for(var i=0;i<this.tileAlerts.length;++i){tile=this.tileAlerts[i];tile.setPositionX(camera.currentLookAt[0])}}};SceneMultiUIGamesList.prototype.resize=function(){if(this.open){var self=this;this.CCSceneAppUI_resize();var camera=this.camera;var tile,i;this.tileBackground.setupTexturedFit(camera.targetWidth,camera.targetHeight,true,"multi_background.jpg",function(tile){if(self.showing){tile.setColourAlpha(.5,true)}camera.flagUpdate()});var idealAspectRatio=1.5;var aspectRatioAdjutment=camera.getAspectRatio()<1.25?camera.getAspectRatio()/idealAspectRatio:1;var tileHeight=camera.targetHeight*.3*aspectRatioAdjutment;var altRow=false;for(i=0;i<this.tileAlerts.length;++i){tile=this.tileAlerts[i];tile.setTileSize(camera.targetWidth,camera.targetHeight*.375);tile.setPositionY(altRow?-tileHeight*.66:tileHeight*.66);altRow=!altRow}var gamesList=this.gamesList;for(i=0;i<gamesList.length;++i){var game=gamesList[i];var gameTiles=game.tiles;if(gameTiles.length>0){gameTiles[0].setPositionY(altRow?-tileHeight*.66:tileHeight*.66);gameTiles[0].setTileSize(tileHeight*1.5,tileHeight);for(var j=1;j<gameTiles.length;++j){tile=gameTiles[j];tile.setTextHeight(tileHeight*.125,true);tile.positionTileBelow(gameTiles[j-1])}}altRow=!altRow}if(this.showing){this.show()}}};SceneMultiUIGamesList.prototype.updateControls=function(controls){var usingControls=this.CCSceneAppUI_updateControls(controls);var cameraTouches=this.camera.cameraTouches;var touch=cameraTouches[0];if(touch.x>0&&touch.x<1&&touch.y>0&&touch.y<1&&touch.startX>0&&touch.startX<1&&touch.startY>0&&touch.startY<1){if(controls.wheel&&controls.wheel.delta!==0){this.cameraScrolling=true;var delta=controls.wheel.delta;this.touchCameraMoving(delta*.1,0);return true}}return usingControls};SceneMultiUIGamesList.prototype.touchMovementAllowed=function(touch,touchDelta){var absDeltaX=Math.abs(touch.totalDeltaX);var absDeltaY=Math.abs(touch.totalDeltaY);if(absDeltaX>CCControls.TouchMovementThreashold.x||absDeltaY>CCControls.TouchMovementThreashold.y){this.controlsMoving=true;touchDelta.x+=touch.totalDeltaX;touchDelta.y+=touch.totalDeltaY;this.controlsMovingVertical=false;return true}return false};SceneMultiUIGamesList.prototype.refreshCameraView=function(){this.sceneLeft=0;this.sceneRight=0;this.sceneTop=0;this.sceneBottom=0;var camera=this.camera;var gamesList=this.gamesList;var game,tile;if(gamesList.length>1){game=gamesList.last();tile=game.tiles[0];this.sceneRight=tile.getTileMovementTarget()[0]+tile.collisionBounds[0];this.sceneRight-=tile.collisionBounds[0]}};SceneMultiUIGamesList.prototype.lockCameraView=function(){if(this.cameraScrolling){return}var camera=this.camera;if(camera.targetLookAt[0]<this.sceneLeft){camera.targetLookAt[0]=this.sceneLeft;camera.flagUpdate()}else if(camera.targetLookAt[0]>this.sceneRight){camera.targetLookAt[0]=this.sceneRight;camera.flagUpdate()}if(this.showing){var closestTile;var closestDistance=CC_MAXFLOAT;var gamesList=this.gamesList;for(var i=0;i<gamesList.length;++i){var game=gamesList[i];var tile=game.tiles[0];var tilePosition=tile.getTileMovementTarget();var distance=CC.Vector3Distance2D(tilePosition,camera.targetLookAt,false);if(distance<closestDistance){closestDistance=distance;closestTile=tile}}if(closestTile){var closestTileVector=closestTile.getTileMovementTarget();camera.targetLookAt[0]=closestTileVector[0];camera.flagUpdate()}}};SceneMultiUIGamesList.prototype.show=function(){if(this.open){this.showing=true;this.controlsEnabled=true;if(this.tileBackground.getTileTextureImage()){this.tileBackground.setColourAlpha(.5,true)}var i;for(i=0;i<this.tileAlerts.length;++i){this.tileAlerts[i].setColourAlpha(.25,true)}var camera=this.camera;var gamesList=this.gamesList;var x=0;var altRow=false;for(i=0;i<gamesList.length;++i){var game=gamesList[i];var gameTiles=game.tiles;if(gameTiles.length>0){var mainTile=gameTiles[0];if(i>0){x+=mainTile.collisionBounds[0]}if(mainTile.getTileTextureImage()){mainTile.setColourAlpha(1,true)}else{mainTile.setColourAlpha(.125,true)}mainTile.setCollideable(true);for(var j=0;j<gameTiles.length;++j){tile=gameTiles[j];if(x<camera.targetWidth){tile.setTileMovementX(x)}else{tile.setPositionX(x)}}if(altRow){x+=camera.targetWidth*.0125}altRow=!altRow}}this.refreshCameraView();this.lockCameraView()}};SceneMultiUIGamesList.prototype.selectGame=function(game){this.open=false;this.showing=false;this.controlsEnabled=false;var i,tile;var gamesList=this.gamesList;for(i=0;i<gamesList.length;++i){var gameItr=gamesList[i];for(var j=0;j<gameItr.tiles.length;++j){tile=gameItr.tiles[j];tile.setColourAlpha(0,true);tile.setTextColourAlpha(0,true);tile.setCollideable(false)}}var camera=this.camera;tile=game.tiles[0];tile.setDrawOrder(300);vec3.copy(camera.targetLookAt,tile.getTileMovementTarget());camera.targetOffset[2]=camera.calcCameraOffsetForWidth(tile.collisionSize.width);camera.flagUpdate();this.parentScene.hide();for(i=0;i<this.tileAlerts.length;++i){this.tileAlerts[i].setColourAlpha(.5,true)}var self=this;this.tileBackground.setColourAlpha(0,true,function(){self.parentScene.loadGame(game.appInfo.id)})};SceneMultiUIGamesList.prototype.addAppInfo=function(appInfo){var self=this;var camera=this.camera;var tiles=this.tiles;var gamesList=this.gamesList;var tile;var SelectGameFunction=function(game){return function(){self.selectGame(game)}};var x=camera.currentLookAt[0]+camera.targetWidth;var game={};game.appInfo=appInfo;game.tiles=[];gamesList.add(game);{tile=new CCTile3DButton(this);game.tiles.add(tile);tile.setupTile(1);var titleImage=appInfo.titleImage?appInfo.titleImage:SceneMultiManager.DefaultTitleImage;tile.setTileTexture(appInfo.titleImage,function(tile,textureHandle){if(textureHandle){if(self.showing){tile.setColourAlpha(1,true)}}});tile.setColour(gColour.set(1,0));tile.setCollideable(false);tile.setPositionX(x);tile.onRelease.push(new SelectGameFunction(game));this.addTile(tile)}{tile=new CCTile3DButton(this);game.tiles.add(tile);var name=appInfo.name;if(!appInfo.open){name+=" (Unpublished)"}tile.setupText(name,1,true,true);tile.setColour(gColour.set(.05,.5));tile.setTextColour(gColour.set(1,1));tile.setCollideable(false);tile.setPositionX(x);this.addTile(tile)}var drawOrder=300;var duration=1;for(var i=0;i<gamesList.length;++i){var gameTiles=gamesList[i].tiles;for(var j=0;j<gameTiles.length;++j){tile=gameTiles[j];tile.movementInterpolator.setDuration(duration);duration+=.125;tile.setDrawOrder(drawOrder);if(drawOrder>205){drawOrder--}}}this.requestResize();return game};SceneMultiUIGamesList.prototype.loadAppInfos=function(appInfos){var self=this;var camera=this.camera;var tiles=this.tiles;var gamesList=this.gamesList;var GameCompare=function(appInfo){if(appInfo.id==="androids"){return 101}else if(appInfo.id==="tanks"){return 102}else if(appInfo.id==="burgers"){return 103}else if(appInfo.id==="space"){return 104}else if(MultiplayerManager.IsOwner(appInfo.owners)){if(appInfo.jsFiles){return 100-appInfo.jsFiles.length}return 100}else if(appInfo.jsFiles){return 105}return 1e3};appInfos.sort(function(a,b){var scoreA=GameCompare(a);var scoreB=GameCompare(b);if(scoreA===scoreB){return a.id-b.id}return scoreA-scoreB});var game,tile;var i,j;for(i=0;i<appInfos.length;++i){var appInfo=appInfos[i];game=null;if(gamesList.length>i){game=gamesList[i]}if(game){if(game.appInfo.id===appInfo.id){tile=game.tiles[0];if(appInfo.titleImage){tile.setTileTexture(appInfo.titleImage)}continue}else{for(j=0;j<game.tiles.length;++j){tile=game.tiles[j];tiles.remove(tile);tile.deleteLater()}gamesList.remove(game)}}game=this.addAppInfo(appInfo);gamesList.insert(game,i)}while(gamesList.length>appInfos.length){game=gamesList[appInfos.length];for(j=0;j<game.tiles.length;++j){tile=game.tiles[j];tiles.remove(tile);tile.deleteLater()}gamesList.remove(game)}this.requestResize()};SceneMultiUIGamesList.prototype.updatedAppInfo=function(appInfo,removed){var self=this;var camera=this.camera;var gamesList=this.gamesList;var i,game,tile;for(i=0;i<gamesList.length;++i){game=gamesList[i];if(game.appInfo.id===appInfo.id){if(removed){for(var j=0;j<game.tiles.length;++j){tile=game.tiles[j];this.tiles.remove(tile);tile.deleteLater()}gamesList.remove(game);this.requestResize()}else{tile=game.tiles[0];if(appInfo.titleImage){tile.setTileTexture(appInfo.titleImage)}var name=appInfo.name;if(!appInfo.open){name+=" (Unpublished)"}game.tiles[1].setText(name)}return}}this.addAppInfo(appInfo)};function SceneMultiUIIntro(parentScene){this.construct();this.cameraCentered=true;if(parentScene){parentScene.linkScene(this);this.setParent(parentScene)}gEngine.addScene(this);this.started=false}ExtendPrototype(SceneMultiUIIntro,CCSceneAppUI);SceneMultiUIIntro.prototype.setup=function(){var self=this;var camera=gEngine.newSceneCamera(this);camera.setupViewport(0,0,1,1);camera.setCameraWidth(640,false);var tile;{tile=new CCTile3DButton(this);tile.setColour(gColour.set(1,0));tile.setDrawOrder(205);tile.tileRotationInterpolator=new CCInterpolatorListV3(CCInterpolatorX3Curve);tile.disableCulling=true;tile.setColourAlpha(0);tile.setTileScale(0,false);tile.setCollideable(false);tile.setTileSize(camera.targetWidth*.35);tile.setTileTexture("playir_icon.png");this.tileIcon=tile;tile.onRelease.push(function(){self.parentScene.launchEditor()});this.addTile(tile)}var timer=new CCTimer;timer.onTime.push(function(){self.started=true;self.start()});timer.start(1);this.timers.push(timer)};SceneMultiUIIntro.prototype.resize=function(){this.CCSceneAppUI_resize();if(this.started){this.start()}};SceneMultiUIIntro.prototype.touchMoving=function(touch,touchDelta){return false};SceneMultiUIIntro.prototype.start=function(){var self=this;var camera=this.camera;var tile;{tile=this.tileIcon;self.showIcon()}};SceneMultiUIIntro.prototype.showIcon=function(){var self=this;var tile=this.tileIcon;if(!this.hidingIcon){tile.setTileScale(1,true);tile.setColourAlpha(1,true,function(){tile.tileRotationInterpolator.pushV3(tile.rotation,vec3.clone([0,20,0]),false,function(){self.showingIcon=true;if(self.dockingIcon){self.dockIcon()}})})}};SceneMultiUIIntro.prototype.showLoadingBar=function(){var tile=new TileOverlay(this,"white.png","white.png",0);tile.setColourAlpha(.25);tile.setTileSize(this.camera.targetWidth*.25,this.camera.targetHeight*.005125);tile.setPositionY(-this.camera.targetHeight*.35);tile.setAmount(0);this.tileLoadingBar=tile};SceneMultiUIIntro.prototype.updateLoadingBar=function(amount){if(this.tileLoadingBar){this.tileLoadingBar.setAmount(amount)}};SceneMultiUIIntro.prototype.dockIcon=function(callback){if(!this.hidingIcon){this.dockingIcon=true;var self=this;if(callback){this.dockedCallback=callback}if(this.showingIcon){delete this.showingIcon;this.dockedIcon=true;var camera=this.camera;var newSize=camera.targetWidth*.125;var tile=this.tileIcon;var scale=newSize/tile.collisionSize.width;tile.setTileMovementXY(-camera.targetWidth*.5+newSize,-camera.targetHeight*.5+newSize);tile.movementInterpolator.setDuration(.5);tile.tileRotationInterpolator.setDuration(.5);tile.setTileScale(scale*2,true);tile.tileRotationInterpolator.pushV3(tile.rotation,vec3.clone([0,0,0]),false,function(){tile.setTileScale(scale,true,function(){tile.setTileSize(newSize);tile.setTileScale(1,false)});tile.rotation[1]=0;tile.setCollideable(true);if(self.dockedIcon){if(self.dockedCallback){self.dockedCallback();delete self.dockedCallback}}})}}};SceneMultiUIIntro.prototype.hide=function(callback){this.hidingIcon=true;if(this.tileLoadingBar){this.tileLoadingBar.setColourAlpha(0,true);this.tileLoadingBar.tileOverlay.setColourAlpha(0,true);this.tileLoadingBar=null}var tile=this.tileIcon;if(this.dockingIcon){tile.setColourAlpha(0,true);tile.setTileScale(1.5,true);tile.tileRotationInterpolator.setDuration(1);tile.tileRotationInterpolator.pushV3(tile.rotation,vec3.clone([0,-720,0]),false,function(){if(callback){callback()}})}else{this.start();tile.setTileScale(1,true);tile.setColourAlpha(1,true,function(){tile.tileRotationInterpolator.pushV3(tile.rotation,vec3.clone([0,0,0]),true,function(){tile.setColourAlpha(0,true,function(){if(callback){callback()}})})})}};function SceneMultiUILogin(parentScene){this.construct();this.cameraCentered=true;if(parentScene){parentScene.linkScene(this);this.setParent(parentScene)}gEngine.addScene(this)}ExtendPrototype(SceneMultiUILogin,CCSceneAppUI);SceneMultiUILogin.prototype.setup=function(){var self=this;var camera=gEngine.newSceneCamera(this);camera.setupViewport(0,0,1,1);camera.setCameraWidth(640,false);{tile=new TileSocialProfile(this);tile.setTileSize(camera.targetHeight*.1);tile.setPositionX(camera.targetWidth*.5-tile.collisionBounds[0]*1.5);tile.setPositionY(camera.targetHeight*.5+tile.collisionBounds[1]);this.tileProfile=tile;tile.onRelease.push(function(){self.showProfileLogin()});this.addTile(tile,0)}var timer=new CCTimer;timer.onTime.push(function(){self.open=true;self.requestResize()});timer.start(1);this.timers.push(timer)};SceneMultiUILogin.prototype.resize=function(){this.CCSceneAppUI_resize();var camera=this.camera;var tile=this.tileProfile;tile.setTileSize(camera.targetHeight*.1);if(this.open){tile.setTileMovementY(camera.targetHeight*.5-tile.collisionBounds[1]*1.5)}};SceneMultiUILogin.prototype.touchMoving=function(touch,touchDelta){return false};SceneMultiUILogin.prototype.close=function(){this.open=false;if(this.sceneProfileLogin){this.sceneProfileLogin.close()}var camera=this.camera;var tile=this.tileProfile;tile.setTileMovementY(camera.targetHeight);var self=this;tile.setColourAlpha(0,true,function(){self.deleteLater()})};SceneMultiUILogin.prototype.showProfileLogin=function(){if(MultiplayerManager.LoggedIn){if(!this.sceneProfileLogin){this.sceneProfileLogin=new SceneProfileLogin(this)}}};function SceneMultiUILauncher(parentScene,handleBackButton){this.construct();this.cameraCentered=true;if(parentScene){parentScene.linkScene(this);this.setParent(parentScene)}gEngine.addScene(this);if(handleBackButton===true){this.shouldHandleBackButton=true;CCEngine.EnableBackButton(this)}SceneMultiUILauncher.Instance=this}ExtendPrototype(SceneMultiUILauncher,CCSceneAppUI);SceneMultiUILauncher.Instance=null;SceneMultiUILauncher.prototype.handleBackButton=function(){if(this.shouldHandleBackButton){this.shouldHandleBackButton=false;this.launch();return true}return false};SceneMultiUILauncher.prototype.deleteLater=function(){if(SceneMultiUILauncher.Instance===this){SceneMultiUILauncher.Instance=null}this.CCSceneAppUI_deleteLater()};SceneMultiUILauncher.prototype.setup=function(){var self=this;var camera=gEngine.newSceneCamera(this);camera.setupViewport(0,0,1,1);camera.setCameraWidth(640,false);camera.useSceneCollideables(this);var tile;{tile=new CCTile3DButton(this);tile.setupTile(camera.targetWidth,camera.targetHeight);tile.setColour(gColour.set(0,0));tile.getColourInterpolator().setDuration(1);tile.setDrawOrder(204);this.cameraStickyTiles.add(tile);this.tileBackground=tile}{tile=new CCTile3DButton(this);tile.setColour(gColour.set(1,0));tile.getColourInterpolator().setDuration(.5);tile.setDrawOrder(205);tile.setCollideable(false);tile.tileRotationInterpolator=new CCInterpolatorListV3(CCInterpolatorX3Curve);tile.setCulling(false);this.tileIcon=tile;tile.onRelease.push(function(){self.launch()});this.addTile(tile);this.iconSrc="playir_icon.png";gEngine.textureManager.getTextureHandle(this.iconSrc)}};SceneMultiUILauncher.prototype.resize=function(){this.CCSceneAppUI_resize();if(this.showing){this.show()}};SceneMultiUILauncher.prototype.render=function(camera,pass,alpha){};SceneMultiUILauncher.prototype.touchMoving=function(touch,touchDelta){return false};SceneMultiUILauncher.prototype.show=function(){this.showing=true;var self=this;var camera=this.camera;var tile=this.tileIcon;this.enabled=true;camera.enabled=true;gEngine.textureManager.getTextureHandle(self.iconSrc,function(textureHandle){tile.setCollideable(true);var size=camera.targetHeight*.2;tile.setTileSize(size);var padding=size*.6;tile.setPositionXY(camera.targetWidth*.5-padding,-camera.targetHeight*.5+padding);tile.setTileTexture(self.iconSrc);tile.setTileScale(0,false);tile.setTileScale(1.5,true);tile.setColourAlpha(1,true,function(){tile.tileRotationInterpolator.pushV3(tile.rotation,vec3.clone([0,-5,0]),true,function(){tile.setTileScale(1,true);tile.tileRotationInterpolator.setDuration(.5);tile.tileRotationInterpolator.pushV3(tile.rotation,vec3.clone([0,0,0]),false,function(){tile.rotation[1]=0})})})})};SceneMultiUILauncher.prototype.hide=function(close){this.showing=false;var self=this;var tile=this.tileIcon;tile.setColourAlpha(0,true,function(){if(!self.showing){self.enabled=false;self.camera.enabled=false;if(close){self.deleteLater()}}});tile.tileRotationInterpolator.pushV3(tile.rotation,vec3.clone([0,-5,0]),true);tile.setTileScale(1.5,true);tile.setCollideable(false)};SceneMultiUILauncher.prototype.launch=function(fast,callback){if(!this.launching){this.launching=true;if(fast){this.tileBackground.getColourInterpolator().setDuration(.25);this.tileIcon.getColourInterpolator().setDuration(.2);this.tileIcon.tileRotationInterpolator.setDuration(.25)}var self=this;if(this.parentScene){this.unlinkScene(this.parentScene)}var camera=this.camera;this.enabled=true;camera.enabled=true;var tile;{tile=this.tileBackground;tile.setTileSize(camera.targetWidth,camera.targetHeight);tile.setColourAlpha(1,true)}{tile=this.tileIcon;tile.setColourAlpha(1,true,function(){tile.setColourAlpha(0,true);tile.setTileScale(4,true);tile.tileRotationInterpolator.pushV3(tile.rotation,vec3.clone([0,-5,0]),true,function(){if(callback){callback()}self.deleteLater();SceneMultiManager.Launch()})})}}};function SceneMultiManager(){this.construct()}ExtendPrototype(SceneMultiManager,SceneManagerPlay);SceneMultiManager.Instance=null;SceneMultiManager.DefaultTitleImage="phonewars_title.jpg";SceneMultiManager.prototype.construct=function(){SceneMultiManager.Instance=this;this.SceneManagerPlay_construct();if(gEngine.restarting){delete gEngine.restarting}else{this.showIcon()}SceneMultiManager.LoadingGame=window.APP_ID==="multi"?false:window.APP_ID;var self=this;this.dbApps=new DBApps;this.dbApps.load(function(appInfos){if(!self.startingGame){if(SceneMultiManager.LoadingGame){self.findGameToLoad()}else{self.loadGamesList(appInfos);self.dockIcon(function(){self.showGamesList()})}}},function(appInfo,removed){if(!self.startingGame){if(SceneMultiManager.LoadingGame){self.findGameToLoad()}else{self.updateGamesList(appInfo,removed)}}});this.syncDisconnected();gEngine.addScene(this)};SceneMultiManager.prototype.deleteLater=function(){if(SceneMultiManager.Instance===this){SceneMultiManager.Instance=null}if(this.dbApps){this.dbApps.destruct();this.dbApps=null}this.SceneManagerPlay_deleteLater()};SceneMultiManager.prototype.updateControls=function(controls){return false};SceneMultiManager.prototype.syncDisconnected=function(){this.SceneManagerPlay_syncDisconnected();this.hideLogin()};SceneMultiManager.prototype.syncLoggedIn=function(){this.SceneManagerPlay_syncLoggedIn();if(!this.startingGame){this.showLogin()}};SceneMultiManager.prototype.syncLoggedIntoSocialNetwork=function(network){if(!this.startingGame){this.hideLogin();this.showLogin()}};SceneMultiManager.prototype.findGameToLoad=function(){var AppInfos=DBApps.AppInfos;for(var i=0;i<AppInfos.length;++i){var appInfo=AppInfos[i];if(window.APP_ID===appInfo.id){this.loadGame(appInfo.id);return}}this.dbApps.requestGameID(window.APP_ID)};SceneMultiManager.prototype.loadGame=function(appID){if(APP_ID!==LAUNCH_APP_ID){CCEngine.EnableBackButton(gEngine)}this.startingGame=true;this.hideLogin();var appInfo=null;if(this.dbApps){appInfo=this.dbApps.getAppInfo(appID)}if(!appInfo){SceneMultiManager.Launch()}else if(!appInfo.jsFiles||appInfo.jsFiles.length===0){this.startGame(appInfo)}else{this.showIcon();this.sceneIntro.showLoadingBar();var self=this;var jsFiles=appInfo.jsFiles;JSManager.SyncJSFiles(jsFiles,function(updatedJS){if(SceneMultiManager.Instance===self){self.loadedJS(appInfo)}},function(progress){if(SceneMultiManager.Instance===self&&self.sceneIntro){self.sceneIntro.updateLoadingBar(progress)}})}};SceneMultiManager.prototype.loadedJS=function(appInfo){var jsFiles=appInfo.jsFiles;for(var i=0;i<jsFiles.length;++i){var js=jsFiles[i];if(js.filename){var script=JSManager.GetScript(js.filename);if(!script){this.loadGame(appInfo.id);return}}}if(SceneMultiManager.LoadingAppInfoUpdated){SceneMultiManager.LoadingAppInfoUpdated=false;this.loadGame(SceneMultiManager.LoadingGame)}this.startGame(appInfo)};SceneMultiManager.prototype.startGame=function(appInfo){MultiplayerManager.Emit("SetApp",APP_ID);SceneMultiManager.LoadingGame=false;var self=this;this.hideIcon(function(){self.deleteLater();if(appInfo.jsStart&&window[appInfo.jsStart]){new window[appInfo.jsStart]}else{gEngine.addScene(new SceneManagerGame)}})};SceneMultiManager.prototype.hide=function(){this.hideIcon()};SceneMultiManager.prototype.launchEditor=function(){if(SceneMultiManager.EditorAllowed){this.deleteLater();SceneMultiManager.EditorEnabled=!SceneMultiManager.EditorEnabled;if(SceneMultiManager.EditorEnabled){new SceneProjectManager}}else{CCEngine.WebViewOpen("http://playir.com/")}};SceneMultiManager.Launch=function(){SceneMultiManager.LoadingGame=false;{for(var i=0;i<gEngine.scenes.length;++i){gEngine.scenes[i].deleteLater()}CCEngine.DisableBackButton(gEngine);if(APP_ID!=="multi"){APP_ID="multi"}else{APP_ID=LAUNCH_APP_ID}if(APP_ID!==LAUNCH_APP_ID){CCEngine.EnableBackButton(gEngine)}gEngine.restarting=true;gEngine.start();return}if(sceneManagerPlay){sceneManagerPlay.deleteLater()}MultiplayerManager.Disconnect();if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCEngine.Restart\n"}else{var url=CC.GetURLWithoutLocationBarData();if(window.location!==url){window.location=url}else{window.location.reload()}}};SceneMultiManager.RestartClient=function(){MultiplayerManager.Disconnect();if(CCEngine.NativeUpdateCommands!==undefined){CCEngine.NativeUpdateCommands+="CCEngine.RestartClient;"+APP_ID+"\n"}else{while(gEngine.scenes.length>0){gEngine.removeScene(gEngine.scenes.last())}CC.SetJSLocationBarData("id",APP_ID);window.location.reload()}};SceneMultiManager.prototype.showIcon=function(){if(!this.sceneIntro){this.sceneIntro=new SceneMultiUIIntro(this)}};SceneMultiManager.prototype.hideIcon=function(callback){if(this.sceneIntro){this.sceneIntro.hide(callback)}else if(callback){callback()}};SceneMultiManager.prototype.dockIcon=function(callback){if(this.sceneIntro){this.sceneIntro.dockIcon(callback)}else if(callback){callback()}};SceneMultiManager.prototype.showLogin=function(){if(!this.sceneLogin){this.sceneLogin=new SceneMultiUILogin(this)}};SceneMultiManager.prototype.hideLogin=function(){if(this.sceneLogin){this.sceneLogin.close();this.sceneLogin=null}};SceneMultiManager.prototype.preloadGamesList=function(callback){if(!this.sceneGamesList){this.sceneGamesList.preloadGamesList(callback)}};SceneMultiManager.prototype.reconnect=function(){if(this.sceneGamesList){this.sceneGamesList.reconnect()}};SceneMultiManager.prototype.loadGamesList=function(appInfos){if(!this.sceneGamesList){this.sceneGamesList=new SceneMultiUIGamesList(this)}this.sceneGamesList.loadAppInfos(appInfos)};SceneMultiManager.prototype.showGamesList=function(){if(this.sceneGamesList){this.sceneGamesList.show()}};SceneMultiManager.prototype.updateGamesList=function(appInfo,removed){if(this.sceneGamesList){this.sceneGamesList.updatedAppInfo(appInfo,removed)}};SceneMultiManager.prototype.hideGamesList=function(){if(this.sceneGamesList){this.sceneGamesList.deleteLater();this.sceneGamesList=null}};function DBApps(){MultiplayerManager.UpdateCallbacks.addOnce(DBApps);DBApps.Instances.add(this);if(MultiplayerManager.LoggedIn){DBApps.syncLoggedIn()}}DBApps.Instances=[];DBApps.SyncingUpdates=false;DBApps.AppInfos=[];DBApps.prototype.load=function(loadedCallback,updatedCallback){this.loadedCallback=loadedCallback;this.updatedCallback=updatedCallback;if(!window.FORCE_ONLINE){if(DBApps.AppInfos.length===0){var appInfosString=CC.LoadData("appInfos");var appInfos=appInfosString?JSON.parse(appInfosString):null;if(appInfos){DBApps.LoadAppInfos(appInfos)}else{appInfos=[{id:"androids",name:"Phone Wars",open:true,titleImage:"phonewars_title.jpg",jsStart:"SceneManagerAndroids"}];DBApps.LoadAppInfos(appInfos)}}else{this.loadedCallback(DBApps.AppInfos)}}};DBApps.prototype.destruct=function(){MultiplayerManager.UpdateCallbacks.remove(this);if(DBApps.Instances.remove(this)){if(DBApps.Instances.length===0){if(DBApps.SyncingUpdates){DBApps.SyncingUpdates=false;MultiplayerManager.Emit("AppsUnregisterListUpdates")}}}};DBApps.syncDisconnected=function(){if(DBApps.SyncingUpdates){DBApps.SyncingUpdates=false}};DBApps.syncLoggedIn=function(){if(!DBApps.SyncingUpdates){if(MultiplayerManager.Emit("AppsRequestList")){DBApps.SyncingUpdates=true}}};DBApps.syncUpdate=function(jsonData){if(jsonData.multiGamesList){this.AppInfos.length=0;this.LoadAppInfos(jsonData.multiGamesList)}else if(jsonData.multiGamesListUpdated){this.UpdatedAppInfo(jsonData.multiGamesListUpdated)}else if(jsonData.AppsRequestInfo){this.UpdatedAppInfo(jsonData.AppsRequestInfo)}else if(jsonData.multiGamesListRemoved){this.RemovedAppInfo(jsonData.multiGamesListRemoved)}};DBApps.prototype.requestGameID=function(gameID){MultiplayerManager.Emit("AppsRequestInfo",gameID)};DBApps.LoadAppInfos=function(appInfos){var i;for(i=0;i<appInfos.length;++i){DBApps.AddAppInfo(appInfos[i])}CC.SaveData("appInfos",JSON.stringify(this.AppInfos));for(i=0;i<DBApps.Instances.length;++i){if(DBApps.Instances[i].loadedCallback){DBApps.Instances[i].loadedCallback(appInfos)}}};DBApps.AddAppInfo=function(appInfo){var AppInfos=this.AppInfos;for(var i=0;i<AppInfos.length;++i){if(AppInfos[i].id===appInfo.id){AppInfos[i]=appInfo;return}}AppInfos.add(appInfo)};DBApps.UpdatedAppInfo=function(appInfo){var i,j;var AppInfos=this.AppInfos;for(i=0;i<AppInfos.length;++i){if(AppInfos[i].id===appInfo.id){AppInfos[i]=appInfo;for(j=0;j<DBApps.Instances.length;++j){if(DBApps.Instances[j].updatedCallback){DBApps.Instances[j].updatedCallback(appInfo)}}return}}AppInfos.push(appInfo);CC.SaveData("appInfos",JSON.stringify(AppInfos));for(j=0;j<DBApps.Instances.length;++j){if(DBApps.Instances[j].updatedCallback){DBApps.Instances[j].updatedCallback(appInfo)}}};DBApps.RemovedAppInfo=function(appInfo){var i,j;var AppInfos=this.AppInfos;for(i=0;i<AppInfos.length;++i){if(AppInfos[i].id===appInfo.id){AppInfos.remove(AppInfos[i]);CC.SaveData("appInfos",JSON.stringify(AppInfos));for(j=0;j<DBApps.Instances.length;++j){if(DBApps.Instances[j].updatedCallback){DBApps.Instances[j].updatedCallback(appInfo,true)}}return}}};DBApps.prototype.getAppInfo=function(appID){var appInfos=DBApps.AppInfos;for(var i=0;i<appInfos.length;++i){var appInfo=appInfos[i];if(appInfo.id===appID){return appInfo}}return null};DBApps.GetOwnedApps=function(){var ownedApps=[];for(var i=0;i<DBApps.AppInfos.length;++i){var appInfo=DBApps.AppInfos[i];if(MultiplayerManager.IsOwner(appInfo.owners)){ownedApps.push(appInfo)}}return ownedApps};function DBAssets(){this.initialized=false}DBAssets.Initialize=function(){MultiplayerManager.UpdateCallbacks.addOnce(this);if(!this.dbInfos){this.dbInfos=[]}this.requests=[];this.currentRequest=null;this.updateCallbacks=[];this.initialized=true};DBAssets.AddUpdateCallback=function(id,callback,pointer){if(pointer){var packet={};packet.id=id;packet.callback=callback;packet.pointer=pointer;this.updateCallbacks.push(packet);if(window.DEBUG_IsLocalClient){}}};DBAssets.RemoveUpdateCallbacks=function(pointer){for(var i=0;i<this.updateCallbacks.length;++i){var packet=this.updateCallbacks[i];if(packet.pointer===pointer){this.updateCallbacks.remove(packet);--i}}};DBAssets.RunUpdateCallbacks=function(id,info){for(var i=0;i<this.updateCallbacks.length;++i){var packet=this.updateCallbacks[i];if(packet.id===id){packet.callback(info)}}};DBAssets.UpdateDBInfo=function(id,info){if(!this.initialized){this.Initialize()}for(var i=0;i<this.dbInfos.length;++i){var dbInfo=this.dbInfos[i];var dbID=dbInfo.id;if(dbID===id){this.dbInfos[i].info=info;DBAssets.RunUpdateCallbacks(id,info);return}}var packet={id:id,info:info};this.dbInfos.push(packet);DBAssets.RunUpdateCallbacks(id,info)};DBAssets.LoadDBInfos=function(dbInfos){if(!this.initialized){this.Initialize()}for(var i=0;i<dbInfos.length;++i){var dbInfo=dbInfos[i];var id=DBAssets.GetID(dbInfo);dbInfo.localCachedVersion=true;DBAssets.UpdateDBInfo(id,dbInfo)}};DBAssets.RemoveDBID=function(id){var dbInfos=this.dbInfos;if(dbInfos){for(var i=0;i<dbInfos.length;++i){var dbInfo=dbInfos[i];var dbID=dbInfo.id;if(dbID===id){dbInfos.remove(dbInfo);break}}}};DBAssets.LoadCharacters=function(characterInfos){for(var i=0;i<characterInfos.length;++i){var characterInfo=characterInfos[i];DBAssets.UpdateDBInfo(characterInfo.objectID,characterInfo)}};DBAssets.syncLoggedIn=function(){{var SyncAssetIDs=[];for(var i=0;i<this.dbInfos.length;++i){var id=this.dbInfos[i].id;SyncAssetIDs.push(id)}MultiplayerManager.Emit("SyncAssetIDs",SyncAssetIDs)}if(this.currentRequest){this.Request()
}};DBAssets.syncUpdate=function(jsonData){if(jsonData.mapInfo!==undefined){this.Result(jsonData.id,jsonData.mapInfo)}if(jsonData.modelInfo!==undefined){this.Result(jsonData.id,jsonData.modelInfo)}if(jsonData.characterInfo!==undefined){this.Result(jsonData.id,jsonData.characterInfo)}if(jsonData.audioInfo!==undefined){this.Result(jsonData.id,jsonData.audioInfo)}};DBAssets.LoadID=function(id,callback){if(id.startsWith("audio")){this.LoadAudioID(id,function(info){if(callback){callback(info)}})}else if(id.startsWith("map")){this.LoadMapID(id,function(info){if(callback){callback(info)}})}else if(id.startsWith("model")){this.LoadModelID(id,function(info){if(callback){callback(info)}})}else if(id.startsWith("character")){this.LoadCharacterID(id,function(info){if(callback){callback(info)}})}};DBAssets.LoadMapID=function(id,callback){if(!this.initialized){this.Initialize()}var info=this.GetCachedID(id);if(info){if(callback){callback(info)}return}var OnFinish=function(callback){return function(info){if(callback){callback(info)}}};var request={};request.type="MapInfoRequest";request.id=id;request.callback=new OnFinish(callback);if(!this.currentRequest){this.currentRequest=request;this.Request()}else{this.requests.push(request)}};DBAssets.LoadAudioID=function(id,callback){if(!this.initialized){this.Initialize()}var info=this.GetCachedID(id);if(info){if(callback){callback(info)}return}var OnFinish=function(callback){return function(info){if(info&&info.mp3){CCAudioManager.Cache(info.mp3)}if(callback){callback(info)}}};var request={};request.type="AudioInfoRequest";request.id=id;request.callback=new OnFinish(callback);if(!this.currentRequest){this.currentRequest=request;this.Request()}else{this.requests.push(request)}};DBAssets.LoadModelID=function(id,callback,priority,updatePointer){if(!this.initialized){this.Initialize()}this.AddUpdateCallback(id,callback,updatePointer);var info=this.GetCachedID(id);if(info){if(callback){callback(info)}return}if(updatePointer){callback=null}var OnFinish=function(callback){return function(modelInfo){if(callback){callback(modelInfo)}if(modelInfo){if(modelInfo.tex){gEngine.textureManager.getTextureHandle(modelInfo.tex)}if(modelInfo.obj){CCModel3D.CacheModel(modelInfo.obj,true)}}}};var request={};request.type="ModelInfoRequest";request.id=id;request.callback=new OnFinish(callback);if(!this.currentRequest){this.currentRequest=request;this.Request()}else{this.requests.push(request);if(priority>0){request.priority=priority;for(var i=0;i<this.requests.length;++i){var currentRequest=this.requests[i];if(!currentRequest.priority||currentRequest.priority<priority){this.requests.insert(request,i);break}}}}};DBAssets.LoadCharacterID=function(id,callback,updatePointer){if(!this.initialized){this.Initialize()}this.AddUpdateCallback(id,callback,updatePointer);var info=this.GetCachedID(id);if(info){if(callback){callback(info)}return}if(updatePointer){callback=null}var OnFinish=function(callback){return function(characterInfo){if(callback){callback(characterInfo)}if(characterInfo){var actions=characterInfo.actions;for(var i=0;i<actions.length;++i){var action=actions[i];if(action.modelID){DBAssets.LoadModelID(action.modelID)}if(action.sfxID){DBAssets.LoadAudioID(action.sfxID)}}}if(callback){callback(characterInfo)}}};var request={};request.type="CharacterInfoRequest";request.id=id;request.callback=callback;if(!this.currentRequest){this.currentRequest=request;this.Request()}else{this.requests.push(request)}};DBAssets.GetID=function(info){if(info.objectID){return info.objectID}else if(info.mapID){return info.mapID}return info.id};DBAssets.GetCachedID=function(id){var dbInfos=this.dbInfos;for(var i=0;i<dbInfos.length;++i){var dbInfo=dbInfos[i];var dbID=dbInfo.id;if(dbID===id){return dbInfo.info}}return null};DBAssets.Request=function(){var requestID=this.currentRequest.id;var info=DBAssets.GetCachedID(requestID);if(info){this.Result(requestID,info);return}var requestType=this.currentRequest.type;if(window.DEBUG_IsLocalClient){console.log(requestType,requestID)}MultiplayerManager.Emit(requestType,requestID)};DBAssets.Result=function(resultID,info){if(window.DEBUG_IsLocalClient){}if(this.currentRequest){var requestID=this.currentRequest.id;if(requestID===resultID){var callback=this.currentRequest.callback;this.UpdateDBInfo(resultID,info);this.currentRequest=null;if(callback){callback(info)}}}if(!this.currentRequest){if(this.requests.length>0){this.currentRequest=this.requests.safePop();this.Request()}}};DBAssets.PrepareAudioID=function(channel,audioID){DBAssets.LoadAudioID(audioID,function(info){if(info&&info.mp3){CCAudioManager.Prepare(channel,info.mp3)}})};DBAssets.PlayAudioID=function(channel,audioID,restart,loop){DBAssets.LoadAudioID(audioID,function(info){if(info&&info.mp3){CCAudioManager.Play(channel,info.mp3,restart,loop)}})};DBAssets.ResourceFiles=["editor_back.png","editor_icon_delete.jpg","editor_icon_hammer.jpg","editor_icon_js.jpg","editor_icon_private.jpg","editor_icon_public.jpg","editor_icon_resize.png","editor_tabletscreen.png","editor_tile_back.jpg","editor_tile_background.jpg","editor_tile_copy.jpg","editor_tile_cross.jpg","editor_tile_hammer.jpg","editor_tile_refresh.jpg","editor_tile_resize.jpg","editor_tile_selection.jpg","editor_tile_tick.jpg","bazooka.obj","bazooka_diffuse.jpg","burger.obj","burger_diffuse.jpg","burger_icon.png","doubleburger.obj","foodfighters_background.jpg","foodfighters_helpscreen.jpg","foodfighters_title.jpg","fries.obj","fries_diffuse.jpg","fries_icon.png","androBot_body.obj","androBot_diffuse.jpg","androBot_head.obj","androBot_icon.png","androBot_rightarm.obj","androBot_screen.obj","androBot_screen_diffuse.jpg","iBot_body.obj","iBot_diffuse.jpg","iBot_head.obj","iBot_icon.png","iBot_leftarm.obj","iBot_rightarm.obj","phonewars_background.jpg","phonewars_helpscreen.jpg","phonewars_title.jpg","webBot_bazooka.obj","webBot_body.obj","webBot_diffuse.jpg","webBot_head.obj","winBot_body.obj","winBot_diffuse.jpg","winBot_rightarm.obj","multi_background.jpg","playir_icon.png","miniche_body_diffuse.jpg","miniche_head.obj","miniche_head_diffuse.jpg","soldier_body.obj","soldier_body_diffuse.jpg","soldier_head.obj","soldier_head_diffuse.jpg","soldier_icon.png","soldier_weapon_bazooka.obj","soldier_weapon_bazooka_diffuse.jpg","tank_body.obj","tank_diffuse.jpg","tank_head.obj","tank_icon.png","tanklegends_background.jpg","tanklegends_helpscreen.jpg","tanklegends_title.jpg","PressStartK.data","PressStartK.png","fx_character_highlight_texture.png","fx_character_shooting_texture.png","fx_impact_texture.png","fx_weapon_bullet.obj","fx_weapon_bullet_diffuse.jpg","fx_weapon_bullet_glow_texture.png","fx_weapon_muzzleflash.obj","fx_weapon_muzzleflash_texture.png","barbedwire.obj","barbedwire_diffuse.png","level_map_diffuse.jpg","level_particles.obj","level_particles_diffuse.png","sandbags.obj","sandbags_diffuse.png","healthpack.obj","healthpack_diffuse.jpg","icon_facebook.png","icon_googleplus.png","icon_twitter.png","profile_derp.png","profile_f7u12.png","profile_girl.png","profile_grandma.png","profile_happy.png","profile_ibot.jpg","profile_poker.png","profile_rich.png","profile_troll.png","ui_fight.png","ui_fire_charge.png","ui_fire_icon.png","ui_health_bar.png","ui_health_bar_energy.png","ui_health_icon.png","ui_lose.png","ui_win.png","icon_platform_android.png","icon_platform_ios.png","icon_platform_linux.png","icon_platform_mac.png","icon_platform_web.png","icon_platform_windows.png","icon_store.png","icon_store_googleplay.png","icon_store_windows.png","ui_arrow.png","ui_back.png","ui_border.png","ui_button_1vs1.png","ui_button_battleroyale.png","ui_button_moremaps.png","ui_exit.png","ui_help.png","ui_info.png","ui_leaderboards.png","ui_leaderboards_alltime.png","ui_leaderboards_daily.png","ui_leaderboards_weekly.png","ui_practice.png","ui_pushnotifications_off.png","ui_pushnotifications_on.png","ui_sidebackground.png","ui_vs.png","ui_vs_bluestripe.png","ui_vs_redstripe.png","ui_vs_whitestripe.png","HelveticaNeueBold.csv","HelveticaNeueBold.png","HelveticaNeueLight.csv","HelveticaNeueLight.png","alphacolour.fx","basic.fx","basic_vc.fx","phong.fx","phongenv.fx","transparent.png","white.png"];function JSManager(){}JSManager.DownloadJS=function(js,callback){var DownloadedJSFunction=function(js){return function(status,responseText){if(status>=CCURLRequest.Succeeded&&responseText&&responseText.length>0){head=document.getElementsByTagName("head")[0];var scriptID="customjs."+js.fileID;var LoadScript=function(url,callback){if(window.DEBUG_IsLocalClient&&CCEngine.DeviceType==="Web"){script=document.getElementById(scriptID);var newScript=false;if(!script){script=document.createElement("script");script.type="text/javascript";newScript=true}if(!newScript){console.log("JSManager.DownloadJS",url)}script.onload=function(){console.log("JSManager.Downloaded::onload",url);callback(this,true)};script.onerror=function(){console.log("JSManager.DownloadJS::onerror",url);callback(null,false)};script.src=url;if(newScript){head.appendChild(script)}}else{callback(null,false)}};LoadScript(url,function(script,loaded){if(!script){script=document.createElement("script");script.type="text/javascript";head.appendChild(script)}script.id=scriptID;script.fileID=js.fileID;script.filename=js.filename;script.jsData=responseText;if(loaded){if(callback){callback(true)}}else{try{script.text=responseText}catch(error){if(window.console&&console.log){console.log(error)}}if(callback){callback(true)}}})}else{if(callback){callback(false)}}}};if(js.filename){if(JSManager.GetScript(js.filename)){callback(true);return}var url=MultiplayerManager.GetAssetURL(js.filename);gURLManager.requestURL(url,null,new DownloadedJSFunction(js),0,js.filename,-1,0)}else{callback(true)}};JSManager.GetClassNames=function(jsData){var classNames=[];jsData=jsData.formatSpacesAndTabs();var functionSearch=jsData;var functionIndex;while((functionIndex=functionSearch.search("function"))!==-1){var foundFunction=true;if(functionIndex>2){if(functionSearch[functionIndex-2]==="="){foundFunction=false}else if(functionSearch[functionIndex-2]==="/"){foundFunction=false}else if(functionSearch[functionIndex-2]==="("){foundFunction=false}else{functionSearch=functionSearch.substring(functionIndex+8)}}if(foundFunction){var functionName=String.SplitBefore(functionSearch,"(");functionName=functionName.formatSpacesAndTabs();var spaces=functionName.split(" ");if(functionName&&spaces.length===1){if(classNames.find(functionName)===-1){classNames.addOnce(functionName)}}}functionSearch=functionSearch.substring(functionIndex+1)}var prototypes=jsData.split(".prototype.");for(var iPrototype=1;iPrototype<prototypes.length;++iPrototype){var className=prototypes[iPrototype-1];var classNameStartIndex=0;for(var j=className.length-1;j>=0;--j){var character=className[j];if(/[^a-zA-Z0-9]/.test(character)){classNameStartIndex=j+1;break}}className=className.substr(classNameStartIndex,className.length);if(className){if(classNames.find(className)===-1){classNames.addOnce(className)}}}return classNames};JSManager.GetScript=function(filename){var head=document.getElementsByTagName("head")[0];var scripts=head.getElementsByTagName("script");var js,scriptID,script;for(var i=0;i<scripts.length;++i){script=scripts[i];if(script.id){if(script.id.contains("customjs.")){if(script.filename===filename){return script}}}}return null};JSManager.RemoveJSScript=function(script){var jsData=script.jsData;var prototypes=jsData.split(".prototype.");for(var iPrototype=1;iPrototype<prototypes.length;++iPrototype){var className=prototypes[iPrototype-1];var classNameStartIndex=0;for(var j=className.length-1;j>=0;--j){var character=className[j];if(/[^a-zA-Z0-9]/.test(character)){classNameStartIndex=j+1;break}}className=className.substr(classNameStartIndex,className.length);var prototypeName=prototypes[iPrototype];prototypeName=String.SplitBefore(prototypeName," ");prototypeName=String.SplitBefore(prototypeName,"=");prototypeName=String.SplitBefore(prototypeName,"\n");var sourceClass=window[className];if(sourceClass){if(sourceClass.super){var parentClass=sourceClass.super;if(sourceClass.prototype[prototypeName]){if(parentClass.prototype[prototypeName]){sourceClass.prototype[prototypeName]=parentClass.prototype[prototypeName]}}}}}script.parentNode.removeChild(script)};JSManager.RemoveJSFiles=function(){var head=document.head;var scripts=head.children;var js,scriptID,script;for(var i=0;i<scripts.length;++i){script=scripts[i];if(script.id){if(script.id.contains("customjs.")){this.RemoveJSScript(script);--i}}}};JSManager.SyncJSFiles=function(jsFiles,onSynced,onUpdate){var head=document.getElementsByTagName("head")[0];var scripts=head.getElementsByTagName("script");var js,scriptID,script;for(var i=0;i<scripts.length;++i){script=scripts[i];if(script.id){if(script.id.contains("customjs.")){found=false;if(jsFiles){for(var jsIndex=0;jsIndex<jsFiles.length;++jsIndex){js=jsFiles[jsIndex];if(script.filename===js.filename){found=true;break}}}if(!found){this.RemoveJSScript(script)}}}}var updatedJS=[];function DownloadJS(jsFiles,index){if(onUpdate){onUpdate(index/jsFiles.length)}if(jsFiles&&index<jsFiles.length){var js=jsFiles[index];var script=JSManager.GetScript(js.filename);if(!script){JSManager.DownloadJS(js,function(result){if(result){updatedJS.add(js.filename)}else if(window.console&&console.log){console.log("JSManager.DownloadJS Failed "+js.filename)}DownloadJS(jsFiles,index+1)})}else{DownloadJS(jsFiles,index+1)}}else{onSynced(updatedJS)}}DownloadJS(jsFiles,0)};JSManager.ReplaceClassInternalPointers=function(classPointer,oldPointer,newPointer){var keys=Object.keys(classPointer);for(var i=0;i<keys.length;++i){var key=keys[i];if(classPointer[key]===oldPointer){classPointer[key]=newPointer}}};JSManager.RuntimePatch=function(jsFiles){JSManager.SyncJSFiles(jsFiles,function(updatedJS){for(var i=0;i<updatedJS.length;++i){var script=JSManager.GetScript(updatedJS[i]);if(script){var classNames=JSManager.GetClassNames(script.jsData);if(classNames.length>0){for(var iClassName=0;iClassName<classNames.length;++iClassName){var className=classNames[iClassName];for(var iScene=0;iScene<gEngine.scenes.length;++iScene){var scene=gEngine.scenes[iScene];var sceneName=String.SplitBetween(scene.constructor.toString()," ","(");if(window[sceneName]){var Class=window[sceneName];for(var m in Class.prototype){scene[m]=Class.prototype[m]}if(window[sceneName].jsSyncRestartFunction){window[sceneName].jsSyncRestartFunction(scene)}else if(scene.jsSyncReCreate){if(sceneName===className){var parent=scene.parentScene;var newScene=new window[sceneName](parent);if(parent){JSManager.ReplaceClassInternalPointers(parent,scene,newScene)}gEngine.removeScene(scene);break}}}}}}}}})};JSManager.SoftRestart=function(jsonData){while(gEngine.scenes.length>0){gEngine.removeScene(gEngine.scenes.last())}JSManager.SyncJSFiles(jsonData.jsFiles,function(){if(jsonData.jsStart&&window[jsonData.jsStart]){new window[jsonData.jsStart]}else{gEngine.addScene(new SceneManagerGame)}})};JSManager.ParseJSForFileType=function(jsData,db,format){var FindOpeningQuote=function(string){for(var i=string.length-2;i>=0;--i){if(string[i]==='"'||string[i]==="'"){return string.substring(i+1)}}return string};var files,file,i;files=jsData.split(format+'"');if(files.length>1){for(i=0;i<files.length-1;++i){file=files[i];file=FindOpeningQuote(file);if(file){if(!file.isHTTP()){file+=format;if(DBAssets.ResourceFiles.find(file)===-1){db.addOnce(file)}}}}}files=jsData.split(format+"'");if(files.length>1){for(i=0;i<files.length-1;++i){file=files[i];file=FindOpeningQuote(file);if(file){if(!file.isHTTP()){file+=format;if(DBAssets.ResourceFiles.find(file)===-1){db.addOnce(file)}}}}}};JSManager.ParseJSForInfoType=function(jsData,db,token){var FindClosingQuote=function(string){for(var i=0;i<string.length;++i){if(string[i]==='"'||string[i]==="'"){return string.substring(0,i)}}return null};var infos,info,i;infos=jsData.split('"'+token+".");if(infos.length>1){for(i=1;i<infos.length;++i){info=infos[i];info=FindClosingQuote(info);if(info){info=token+"."+info;db.addOnce(info)}}}infos=jsData.split("'"+token+".");if(infos.length>1){for(i=1;i<infos.length;++i){info=infos[i];info=FindClosingQuote(info);if(info){info=token+"."+info;db.addOnce(info)}}}};JSManager.ParseJSForAssets=function(jsData,files,infos){var deadCode=jsData.split("//");jsData=deadCode[0];for(var i=1;i<deadCode.length;++i){var code=String.SplitAfter(deadCode[i],"\n");jsData+="\n";jsData+=code}JSManager.ParseJSForFileType(jsData,files,".jpg");JSManager.ParseJSForFileType(jsData,files,".png");JSManager.ParseJSForFileType(jsData,files,".fbxi");JSManager.ParseJSForFileType(jsData,files,".obj");JSManager.ParseJSForInfoType(jsData,infos,"audio");JSManager.ParseJSForInfoType(jsData,infos,"character");JSManager.ParseJSForInfoType(jsData,infos,"map");JSManager.ParseJSForInfoType(jsData,infos,"model")};function MultiplayerManager(){}MultiplayerManager.LoggedIn=false;MultiplayerManager.SessionID="undefined";MultiplayerManager.UserID=CC.LoadData("userID");if(!MultiplayerManager.UserID){MultiplayerManager.UserID="undefined"}MultiplayerManager.LinkedUsers=CC.LoadData("MultiplayerManager.LinkedUsers");if(MultiplayerManager.LinkedUsers){MultiplayerManager.LinkedUsers=MultiplayerManager.LinkedUsers.split(",")}else{MultiplayerManager.LinkedUsers=[]}MultiplayerManager.Password=undefined;MultiplayerManager.UpdateCallbacks=[];MultiplayerManager.UserInfos=[];MultiplayerManager.Disconnect=function(){this.ForceDisconnected=true;if(window.SocketManager){SocketManager.ForceDisconnect()}};MultiplayerManager.Emit=function(id){if(MultiplayerManager.LoggedIn&&window.socket){if(arguments.length===1){window.socket.emit(id)}else if(arguments.length===2){window.socket.emit(id,arguments[1])}else if(arguments.length===3){window.socket.emit(id,arguments[1],arguments[2])}else if(arguments.length===4){window.socket.emit(id,arguments[1],arguments[2],arguments[3])}else if(arguments.length===5){window.socket.emit(id,arguments[1],arguments[2],arguments[3],arguments[4])}else{alert("MultiplayerManager.Emit: Too many arguments")}return true}return false};MultiplayerManager.Connect=function(){if(MultiplayerManager.ForceDisconnected){delete this.ForceDisconnected}if(window.socket){return}if(window.SocketManager){SocketManager.Restart();return}var serverURL,httpServerURL;var httpPorts=[80,4e3];var currentPortIndex=0;var SocketIOConnectionFunction=function(result){if(!window.SocketManager){setTimeout(function(){currentPortIndex++;if(currentPortIndex>=httpPorts.length){currentPortIndex=0}httpServerURL="http://"+serverURL+":"+httpPorts[currentPortIndex]+"/";CC.LoadScript(httpServerURL+"socketmanager.js",SocketIOConnectionFunction)},5e3)}else{var LoadClientServices=function(result){CC.LoadScript(httpServerURL+"clientservices.js",function(result){if(result&&window.services){SocketManager.Start(serverURL,httpPorts[currentPortIndex])}else{setTimeout(LoadClientServices,5e3)}})};LoadClientServices()}};if(DEBUG_UseLocalServer){currentPortIndex=1;serverURL="192.168.1.89";if(window.location.href.split("/localhost/").length>1){serverURL="localhost"}httpServerURL="http://"+serverURL+":4000/";CC.LoadScript(httpServerURL+"socketmanager.js",SocketIOConnectionFunction)}else{var ServerConnectionFunction=function(){var url="http://playir.com/backend/lobby.php?list&client="+window.APP_ID;if(MultiplayerManager.UseURLProxy(url)){url=SERVER_ROOT+"backend/helper.php?url="+url+"&noCache="+(new Date).getTime()}gURLManager.requestURL(url,null,function(status,responseText){if(status>=CCURLRequest.Succeeded&&responseText&&responseText.length>0){serverURL=responseText.split(":")[0];httpServerURL="http://"+responseText+"/";CC.LoadScript(httpServerURL+"socketmanager.js",SocketIOConnectionFunction)}else{setTimeout(ServerConnectionFunction,1e4)}},1,"socketURL",0)};ServerConnectionFunction()}};MultiplayerManager.DetectGeoLocation=function(){var url="http://playir.com/backend/mapper.php?ip";if(MultiplayerManager.UseURLProxy(url)){url=SERVER_ROOT+"backend/helper.php?url="+url}gURLManager.requestURL(url,null,function(status,responseText){if(status>=CCURLRequest.Succeeded){MultiplayerManager.DetectedGeoLocation(responseText)}})};MultiplayerManager.DetectedGeoLocation=function(geoLocationData){if(geoLocationData&&geoLocationData.length>0){try{var root=JSON.parse(geoLocationData);if(root){if(root.statusCode==="OK"){var geoLocationCountryCode=root.countryCode;if(geoLocationCountryCode&&geoLocationCountryCode.length===2){MultiplayerManager.geoLocationCountryCode=geoLocationCountryCode.toLowerCase();if(window.sceneManagerGame){sceneManagerGame.createFlag()}}}}}catch(error){}}};MultiplayerManager.RequestJoinMap=function(mapID,playerType){MultiplayerManager.Emit("BSJoinMap",playerType,mapID)};MultiplayerManager.SyncLoadedMap=function(location){if(MultiplayerManager.LoggedIn){BurgersClient.enteredGame(location)}};MultiplayerManager.LocationVector=vec3.create();MultiplayerManager.SyncServerPlayerGotoLocation=function(map,location){if(map.isOnlineGame()){if(MultiplayerManager.LoggedIn){var mapBounds=map.getMapBounds();var LocationVector=MultiplayerManager.LocationVector;LocationVector[0]=location[0]/mapBounds.width;LocationVector[1]=location[1];LocationVector[2]=location[2]/mapBounds.width;var tLocation=vec3.toString(LocationVector);BurgersClient.gotoLocation(tLocation)}}};MultiplayerManager.SyncServerPlayerShootAt=function(map,targetID){if(map.isOnlineGame()){if(MultiplayerManager.LoggedIn){BurgersClient.shootAt(targetID)}}};MultiplayerManager.SyncShootAtTarget=function(map,targetLocation){if(map.isOnlineGame()){var mapBounds=map.getMapBounds();var LocationVector=MultiplayerManager.LocationVector;LocationVector[0]=location[0]/mapBounds.width;LocationVector[1]=location[1];LocationVector[2]=location[2]/mapBounds.width;var tLocation=vec3.toString(LocationVector);MultiplayerManager.Emit("SyncShootAtTarget",targetLocation)}};MultiplayerManager.SyncHealth=function(map,health){if(map.isOnlineGame()){MultiplayerManager.Emit("SyncHealth",health)}};MultiplayerManager.SyncPlayerAction=function(map,actionID){if(map.isOnlineGame()){MultiplayerManager.Emit("SyncPlayerAction",actionID)}};MultiplayerManager.SyncRegisterDamage=function(victimID,attackerID,damage){MultiplayerManager.Emit("SyncRegisterDamage",victimID,attackerID,damage)};MultiplayerManager.SyncServerRegisterPickup=function(playerID,pickupType,pickupID){MultiplayerManager.Emit("BSRegisterPickup",playerID,pickupType,pickupID?pickupID:"0")};MultiplayerManager.SyncMessage=function(message,toID){MultiplayerManager.Emit("SyncMessage",message,toID)};MultiplayerManager.IsOwner=function(owners){if(MultiplayerManager.admin){return true}if(owners){var i;var LinkedUsers=MultiplayerManager.LinkedUsers;for(i=0;i<owners.length;++i){var ownerID=owners[i];if(ownerID===MultiplayerManager.UserID){return true}for(var j=0;j<LinkedUsers.length;++j){var linkedID=LinkedUsers[j];if(ownerID===linkedID){return true}}}}return false};MultiplayerManager.UseURLProxy=function(url){if(window.tizen){return false}if(url.getDomain()!==WINDOW_DOMAIN){return true}return false};MultiplayerManager.GetAssetURL=function(path){if(path.isHTTP()){return path}if(path.containsDirectory()){return SERVER_ROOT+path}if(window.tizen){var PackagedFiles=CCEngine.PackagedFiles;if(PackagedFiles){for(var i=0;i<PackagedFiles.length;++i){var packagedFile=PackagedFiles[i];if(packagedFile===path){return"packaged/"+packagedFile}}}}var filename=path.stripDirectory();var url=SERVER_ASSETS_URL+"assets/?file="+filename;if(MultiplayerManager.UseURLProxy(url)){url=SERVER_ROOT+"backend/helper.php?url="+url}return url};MultiplayerManager.LoadCountry=function(tile,countryCode,callback){tile.shouldRender=false;if(countryCode&&countryCode.length===2){var geoLocationCountryCode=countryCode.toLowerCase();var src="flag_";src+=geoLocationCountryCode;src+=".png";if(tile.tileSquares.length===0){tile.setupTextured(src,callback)}else{tile.setupTexturedHeight(tile.collisionSize.height,src,callback)}tile.shouldRender=true}};MultiplayerManager.LoadLocalUserInfo=function(callback){CCFileManager.Load(APP_ID+".db",function(data){callback(data)});CCFileManager.Save(APP_ID+".db",JSON.stringify(this.db))};MultiplayerManager.SaveLocalUserInfo=function(data){CCFileManager.Save(APP_ID+".db",data)};MultiplayerManager.IsUserLoggedIn=function(){var userInfo=MultiplayerManager.GetUserInfo(MultiplayerManager.UserID);if(userInfo){return userInfo.facebook||userInfo.twitter||userInfo.google}return false};MultiplayerManager.RegisterFacebook=function(){if(MultiplayerManager.LoggedIn){var self=this;TileSocialProfile.GetFBInfo(2,function(id,name){if(id&&name){if(MultiplayerManager.Emit("BSRegisterFacebook",id,name)){var userInfo=MultiplayerManager.GetUserInfo(MultiplayerManager.UserID);if(userInfo){userInfo.facebook=true}var UpdateCallbacks=MultiplayerManager.UpdateCallbacks;for(i=0;i<UpdateCallbacks.length;++i){if(UpdateCallbacks[i].syncLoggedIntoSocialNetwork){UpdateCallbacks[i].syncLoggedIntoSocialNetwork("facebook",id,name)}}}}})}};MultiplayerManager.RegisterTwitter=function(){if(MultiplayerManager.LoggedIn){var self=this;var username=TileSocialProfile.GetTwitterInfo();if(username){if(MultiplayerManager.Emit("BSRegisterTwitter",username)){var userInfo=MultiplayerManager.GetUserInfo(MultiplayerManager.UserID);if(userInfo){userInfo.twitter=true}var UpdateCallbacks=MultiplayerManager.UpdateCallbacks;for(i=0;i<UpdateCallbacks.length;++i){if(UpdateCallbacks[i].syncLoggedIntoSocialNetwork){UpdateCallbacks[i].syncLoggedIntoSocialNetwork("twitter",username,"@"+username)}}}}}};MultiplayerManager.RegisterGoogle=function(){if(MultiplayerManager.LoggedIn){var self=this;TileSocialProfile.GetGoogleInfo(function(id,name){if(id&&name){if(MultiplayerManager.Emit("BSRegisterGoogle",id,name)){var userInfo=MultiplayerManager.GetUserInfo(MultiplayerManager.UserID);if(userInfo){userInfo.google=true}var UpdateCallbacks=MultiplayerManager.UpdateCallbacks;for(i=0;i<UpdateCallbacks.length;++i){if(UpdateCallbacks[i].syncLoggedIntoSocialNetwork){UpdateCallbacks[i].syncLoggedIntoSocialNetwork("google",id)}}}}})}};MultiplayerManager.UpdateUserInfo=function(userInfo){for(var i=0;i<this.UserInfos.length;++i){var itr=this.UserInfos[i];if(itr.userID===userInfo.userID){this.UserInfos[i]=userInfo;return}}this.UserInfos.add(userInfo)};MultiplayerManager.GetUserInfo=function(userID){for(var i=0;i<this.UserInfos.length;++i){var itr=this.UserInfos[i];if(itr.userID===userID){return itr}}return null};function onServerUpdate(service,id,jsonData){var UpdateCallbacks=MultiplayerManager.UpdateCallbacks;var HandleUpdateFunction=function(){var i;if(id==="BurgersLoggedIn"){if(!MultiplayerManager.ForceDisconnected&&window.socket){var serviceID=service.serviceID;MultiplayerManager.LoggedIn=true;if(jsonData){MultiplayerManager.LinkedUsers=jsonData;CC.SaveData("MultiplayerManager.LinkedUsers",MultiplayerManager.LinkedUsers)}BurgersClient.registerDevice(CCEngine.DeviceType,APP_ID,CLIENT_VERSION);for(i=0;i<UpdateCallbacks.length;++i){if(UpdateCallbacks[i].syncLoggedIn){UpdateCallbacks[i].syncLoggedIn()}}socket.onOnly("SyncMessage",function(message,fromPlayerID,fromUserID){for(i=0;i<UpdateCallbacks.length;++i){if(UpdateCallbacks[i].syncMessage){UpdateCallbacks[i].syncMessage(message,fromPlayerID,fromUserID)}}})}}else if(id==="UpdateLinkedUsers"){if(jsonData){MultiplayerManager.LinkedUsers=jsonData;CC.SaveData("MultiplayerManager.LinkedUsers",MultiplayerManager.LinkedUsers)}}else if(id==="BurgersGameUpdate"){var pendingCallbacks=UpdateCallbacks.slice(0);for(i=0;i<pendingCallbacks.length;++i){if(pendingCallbacks[i].syncUpdate){pendingCallbacks[i].syncUpdate(jsonData)}}if(jsonData.Restart){SceneMultiManager.RestartClient()}else if(jsonData.SoftRestart){JSManager.SoftRestart(jsonData)}else if(jsonData.userInfo){var userInfo=jsonData.userInfo;if(userInfo.userID===MultiplayerManager.UserID){if(!userInfo.facebook){MultiplayerManager.RegisterFacebook()}if(!userInfo.twitter){MultiplayerManager.RegisterTwitter()}if(!userInfo.google){MultiplayerManager.RegisterGoogle()}}MultiplayerManager.UpdateUserInfo(userInfo)}else if(jsonData.appInfo){var appInfo=jsonData.appInfo;var appInfos;var appInfoString=CC.LoadData("appInfos");if(appInfoString){appInfos=JSON.parse(appInfoString);if(!appInfos){appInfos=[]}}else{appInfos=[]}var found=false;for(i=0;i<appInfos.length;++i){if(appInfos[i].id===appInfo.id){found=true;appInfos[i]=appInfo;break}}if(!found){appInfos.push(appInfo)}CC.SaveData("appInfos",JSON.stringify(appInfos));if(appInfo.jsSync){if(SceneMultiManager.LoadingGame){SceneMultiManager.LoadingAppInfoUpdated=true;return}JSManager.RuntimePatch(appInfo.jsFiles)}}}};HandleUpdateFunction()}function onConnect(sessionID,sessionPassword){if(MultiplayerManager.ForceDisconnected){if(window.SocketManager){SocketManager.ForceDisconnect()}}if(MultiplayerManager.LoggedIn){MultiplayerManager.LoggedIn=false}MultiplayerManager.SessionID=sessionID;var userID=getUserID(sessionID);var password=getPassword(sessionPassword);MultiplayerManager.UserID=userID;MultiplayerManager.Password=password;login(userID,password);registerSocketServices(socket)}function onDisconnect(){if(MultiplayerManager.LoggedIn){MultiplayerManager.LoggedIn=false}var UpdateCallbacks=MultiplayerManager.UpdateCallbacks;for(i=0;i<UpdateCallbacks.length;++i){if(UpdateCallbacks[i].syncDisconnected){UpdateCallbacks[i].syncDisconnected()}}disconnectServices()}function updateServices(){}var DEBUG_UseLocalServer=0;var DEBUG_SlowNetwork=0;if(!window.WINDOW_DOMAIN){window.WINDOW_DOMAIN=window.location.href}WINDOW_DOMAIN=WINDOW_DOMAIN.getDomain();if(window.location.href.startsWith("http://localhost")||window.location.href.startsWith("http://192.168.")){window.DEBUG_IsLocalClient=true}if(!window.SERVER_ROOT){window.SERVER_ROOT=""}SERVER_ROOT=SERVER_ROOT.resolveURL();if(DEBUG_UseLocalServer){window.SERVER_ASSETS_URL=SERVER_ROOT}else{window.SERVER_ASSETS_URL="http://playir.com/"}var CLIENT_VERSION=17;var FORCE_ONLINE=CC.GetJSLocationBarData("online");window.APP_ID=CC.GetJSLocationBarData("id",window.APP_ID);if(!window.APP_ID){window.APP_ID="multi"}window.LAUNCH_APP_ID=window.APP_ID;window.DEFAULT_PURCHASE_ID="topup_1";CCEngine.prototype.start=function(){JSManager.RemoveJSFiles();CCAudioManager.StopAll();this.textureManager.loadFont("HelveticaNeueLight");if(window.APP_ID==="testgame"){TestGame()}else if(window.APP_ID==="testshop"){setTimeout(function(){new SceneItemShop("Get more coins","topup_1",true,1e3,10,10,function(type,itemCode,value){alert(type+" "+value)})},50)}else if(window.APP_ID==="testperceptual"){TestPerceptual()}else if(window.APP_ID==="editor"){new SceneProjectManager;SceneMultiManager.EditorEnabled=true;SceneMultiManager.EditorAllowed=true}else{var joinMapID=CC.GetJSLocationBarData("map");var joinPlayerType=CC.GetJSLocationBarData("player");if(joinMapID){new SceneManagerJoinMap(joinMapID,joinPlayerType)}else{setTimeout(function(){},1);new SceneMultiManager}}MultiplayerManager.DetectGeoLocation();MultiplayerManager.Connect()};function TestGame(){var map=new SceneGame1vs1(null);var objFile="androBot_head.obj";var texFile="_boxxy.jpg";var object=new CCCollideableStaticMesh("boxxy");object.setScene(map);object.setCollideable(false);object.setTransparent();object.setDrawOrder(99);object.setupModel(objFile,texFile,50,function(object){});var player;{player=map.spawnCharacter("iBot");map.assignPlayerCharacter(player);player.setPositionX(-50)}{player=map.spawnCharacter("androBot");map.addEnemy(player);player.setPositionX(50)}map.startPlaying()}function TestPerceptual(){var map=new SceneGame1vs1(null);var objFile="androBot_head.obj";var texFile="_boxxy.jpg";var object=new CCCollideableStaticMesh("boxxy");object.setScene(map);object.setCollideable(false);var referencedTextureIndex=0;if(gEngine.textureManager.referenceTexture){referencedTextureIndex=gEngine.textureManager.referenceTexture("camera")}var primitive=new CCPrimitiveOBJ;if(primitive.reference){primitive.reference("camera");primitive.setTextureIndex(referencedTextureIndex);
object.setCulling(false)}object.model.addPrimitive(primitive);object.setTransparent();CCModel3D.CacheModel(objFile,true,function(model3d){if(model3d){object.model3d=model3d;object.setColourAlpha(1,true);object.model.addModel(model3d)}},1);var player;{player=map.spawnCharacter("iBot");map.assignPlayerCharacter(player);player.setPositionX(-50)}{player=map.spawnCharacter("androBot");map.addEnemy(player);player.setPositionX(50)}map.startPlaying()}
		</script>

        <script>

            function nativeSetup(deviceType, width, height)
            {
                CCEngine.DeviceType = deviceType;

                new CCEngine();
                gEngine.setupRenderer( width, height );
            }

            function nativeStart()
            {
                gEngine.start();

                var result = CCEngine.NativeSyncCommands + '\r\n' + CCEngine.NativeUpdateCommands + '\r\n' + CCEngine.NativeRenderCommands;
                CCEngine.NativeSyncCommands = "";
                CCEngine.NativeUpdateCommands = "";
                CCEngine.NativeRenderCommands = "";
                return result;
            }

            function nativeProcessCommands(cppCommands)
            {
                if( cppCommands )
                {
                    gEngine.processCppCommands( cppCommands );
                }
            }

            function nativeUpdate(delta, cppCommands)
            {
                var engine = gEngine;
                if( cppCommands )
                {
                    engine.processCppCommands( cppCommands );
                }

                engine.timeReal = delta;
                delta = delta > 0.05 ? 0.05 : delta;  // 20 fps
                engine.update( delta );
                engine.render();

                var result = CCEngine.NativeSyncCommands + '\r\n' + CCEngine.NativeUpdateCommands + '\r\n' + CCEngine.NativeRenderCommands;
                CCEngine.NativeSyncCommands = "";
                CCEngine.NativeUpdateCommands = "";
                CCEngine.NativeRenderCommands = "";
                return result;
            }

        </script>
    </head>
</html>